<!-- Master Workflow Setup Screen -->
<!-- File: app/static/templates/screens/workflow/SCR_024_master_workflow.html -->
{% extends "base.html" %}

{% block title %}Master Workflow Setup{% endblock %}

{% block head %}
<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .workflow-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 2rem;
    }

    .page-header {
        background: white;
        border-radius: 12px;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-title i {
        color: var(--primary-color);
        font-size: 28px;
    }

    .page-description {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .workflow-card {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        margin-bottom: 2rem;
    }

    .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--background-light);
        border-radius: 12px 12px 0 0;
    }

    .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-title i {
        color: var(--secondary-color);
    }

    .card-body {
        padding: 2rem;
    }

    .workflow-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .workflow-table th {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
    }

    .workflow-table th:first-child {
        border-radius: 8px 0 0 0;
    }

    .workflow-table th:last-child {
        border-radius: 0 8px 0 0;
    }

    .workflow-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }

    .workflow-table tbody tr:hover {
        background: var(--background-light);
    }

    .step-number {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .form-select {
        width: 100%;
        padding: 0.625rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        color: var(--text-color);
        background: white;
        cursor: pointer;
        transition: var(--transition);
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 20px;
        padding-right: 2.5rem;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(39, 98, 203, 0.1);
    }

    .form-input {
        padding: 0.625rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        color: var(--text-color);
        background: white;
        transition: var(--transition);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(39, 98, 203, 0.1);
    }

    /* User Selection */
    .user-selection-wrapper {
        position: relative;
    }

    .user-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .user-search {
        flex: 1;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .btn-icon {
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        background: white;
        color: var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
    }

    .btn-icon:hover {
        background: var(--primary-color);
        color: white;
    }

    .user-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 0.25rem;
    }

    .dropdown-header {
        position: sticky;
        top: 0;
        z-index: 1;
        background: var(--background-light);
    }

    .dropdown-item {
        padding: 0.625rem 1rem;
        cursor: pointer;
        transition: var(--transition);
        border-bottom: 1px solid var(--background-light);
    }

    .dropdown-item:last-child {
        border-bottom: none;
    }

    .dropdown-item:hover {
        background: var(--background-light);
    }

    .user-info {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }

    .user-name {
        font-weight: 500;
        color: var(--text-color);
        font-size: 0.875rem;
    }

    .user-email {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .selected-users {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: 32px;
    }

    .selected-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.625rem;
        background: var(--info-bg);
        color: var(--info-color);
        border-radius: 6px;
        font-size: 0.8125rem;
    }

    .selected-tag i:first-child {
        font-size: 14px;
    }

    .selected-tag .tag-email {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-style: italic;
    }

    .selected-tag i:last-child {
        cursor: pointer;
        font-size: 14px;
        margin-left: 0.25rem;
    }

    .selected-tag i:last-child:hover {
        color: var(--danger-color);
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        padding: 1.5rem 2rem;
        background: var(--background-light);
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 12px 12px;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: #1e4fb3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.25);
    }

    .btn-secondary {
        background: white;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--background-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
        margin-left: auto;
    }

    .btn-success:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
    }

    /* Add Step Button */
    .add-step-btn {
        width: 100%;
        padding: 1rem;
        border: 2px dashed var(--border-color);
        background: transparent;
        color: var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 500;
    }

    .add-step-btn:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    /* Settings Grid (from keethan) */
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
    }

    .setting-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .setting-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .setting-description {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Toggle Switch (from keethan) */
    .toggle-switch {
        position: relative;
        width: 48px;
        height: 24px;
        margin-top: 0.25rem;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--border-color);
        transition: var(--transition);
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: var(--transition);
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: var(--primary-color);
    }

    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    .alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 2rem;
    }

    .alert-info {
        background: var(--info-bg);
        color: var(--info-color);
        border: 1px solid rgba(12, 84, 96, 0.2);
    }

    .alert i {
        font-size: 20px;
    }

    .remove-step {
        color: var(--danger-color);
        cursor: pointer;
        font-size: 20px;
        transition: var(--transition);
    }

    .remove-step:hover {
        color: #c82333;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="workflow-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="ti ti-settings-automation"></i>
            Master Workflow Setup
        </h1>
        <p class="page-description">
            Define the default approval workflow for your organization. This master workflow will be applied to all contracts unless overridden.
        </p>
    </div>

    <div class="alert alert-info">
        <i class="ti ti-info-circle"></i>
        <div>
            <strong>Important:</strong> The Master Workflow will be the default for all new contracts. Individual contracts can override this workflow if needed.
        </div>
    </div>

    <div class="workflow-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="ti ti-git-branch"></i>
                Workflow Steps Configuration
            </h2>
        </div>
        <div class="card-body">
            <table class="workflow-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Step</th>
                        <th>Role</th>
                        <th>User(s)</th>
                        <th>Department</th>
                        <th style="width: 80px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="workflowSteps">
                    <!-- Steps will be rendered here by JavaScript -->
                </tbody>
            </table>

            <button class="add-step-btn" onclick="addWorkflowStep()">
                <i class="ti ti-plus"></i>
                Add Workflow Step
            </button>
        </div>
    </div>

    <div class="workflow-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="ti ti-settings"></i>
                Workflow Settings
            </h2>
        </div>
        <div class="card-body">
            <div class="settings-grid">
                <div class="setting-item">
                    <label class="setting-label">Auto-Escalation Time</label>
                    <p class="setting-description">Automatically escalate if no action taken within specified hours</p>
                    <input type="number" class="form-input" id="autoEscalation" value="48" min="1" max="168">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Contract Value Threshold</label>
                    <p class="setting-description">Apply this workflow for contracts above (QAR)</p>
                    <input type="number" class="form-input" id="contractThreshold" value="50000" min="0">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Parallel Approval</label>
                    <p class="setting-description">Allow multiple approvers to review simultaneously</p>
                    <label class="toggle-switch">
                        <input type="checkbox" id="parallelApproval" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Skip Empty Steps</label>
                    <p class="setting-description">Automatically skip steps with no assigned users</p>
                    <label class="toggle-switch">
                        <input type="checkbox" id="skipEmptySteps">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Require Comments</label>
                    <p class="setting-description">Require comments for rejections and conditional approvals</p>
                    <label class="toggle-switch">
                        <input type="checkbox" id="requireComments" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Qatar Compliance Check</label>
                    <p class="setting-description">Enforce Qatar regulatory compliance at each step</p>
                    <label class="toggle-switch">
                        <input type="checkbox" id="qatarCompliance" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="workflow-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="ti ti-file-off"></i>
                Excluded Contract Types
            </h2>
        </div>
        <div class="card-body">
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                Select contract types that should bypass this master workflow
            </p>
            <div class="settings-grid" id="excludedTypes">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" value="Non-Disclosure Agreement (NDA)"> Non-Disclosure Agreement (NDA)
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" value="Service Agreement"> Service Agreement
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" value="Purchase Order"> Purchase Order
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" value="Internal Memo"> Internal Memo
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" value="Master Service Agreement"> Master Service Agreement
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" value="Employment Contract"> Employment Contract
                </label>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="workflow-card">
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="goBack()">
                <i class="ti ti-arrow-left"></i>
                Back
            </button>
            <button class="btn btn-primary" onclick="saveWorkflow()">
                <i class="ti ti-device-floppy"></i>
                Save & Exit
            </button>
            <button class="btn btn-success" onclick="submitWorkflow()">
                <i class="ti ti-check"></i>
                Submit Workflow
            </button>
        </div>
    </div>
</div>

<script>
let workflowSteps = [];
let stepCount = 0;
let availableRoles = ['Reviewer', 'Approver', 'Legal Reviewer', 'Finance Approver', 'Director', 'E-Sign Authority', 'Counter-Party'];
let availableDepartments = ['Legal', 'Finance', 'Operations', 'Sales', 'HR', 'IT', 'Procurement'];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Master Workflow page loaded');
    loadWorkflowData();
});

// Load workflow data from API
async function loadWorkflowData() {
    try {
        const response = await fetch('/api/workflows/master');
        if (response.ok) {
            const workflow = await response.json();
            if (workflow && workflow.steps && workflow.steps.length > 0) {
                console.log('ðŸ“¥ Loaded workflow from database:', workflow);
                populateWorkflowFromDatabase(workflow);
            } else {
                console.log('â„¹ï¸ No existing workflow, rendering empty table');
                renderWorkflowSteps();
            }
        } else {
            console.log('â„¹ï¸ No workflow found, starting fresh');
            renderWorkflowSteps();
        }
    } catch (error) {
        console.error('âŒ Error loading workflow:', error);
        renderWorkflowSteps();
    }
}

// Populate workflow from database with proper grouping
function populateWorkflowFromDatabase(workflow) {
    const stepsMap = new Map();
    
    console.log('ðŸ“¦ Raw steps from database:', workflow.steps);
    
    // Group by step_number and collect all users
    workflow.steps.forEach(step => {
        const key = step.step_number;
        
        if (!stepsMap.has(key)) {
            stepsMap.set(key, {
                step_number: step.step_number,
                role: step.assignee_role || '',
                department: step.department || '',
                users: []
            });
            console.log(`ðŸ“ Created step ${key} with role: ${step.assignee_role}, dept: ${step.department}`);
        }
        
        // Add user if exists
        if (step.assignee_user_id && step.user_name && step.user_email) {
            const stepData = stepsMap.get(key);
            const userExists = stepData.users.some(u => u.id === step.assignee_user_id);
            
            if (!userExists) {
                stepData.users.push({
                    id: step.assignee_user_id,
                    name: step.user_name,
                    email: step.user_email
                });
                console.log(`ðŸ‘¤ Added user to step ${key}: ${step.user_name} (${step.user_email})`);
            }
        }
    });
    
    // Convert to array and sort
    workflowSteps = Array.from(stepsMap.values()).sort((a, b) => a.step_number - b.step_number);
    stepCount = workflowSteps.length;
    
    console.log('âœ… Final workflow steps:', workflowSteps);
    console.log('ðŸ“Š Total steps:', stepCount);
    
    renderWorkflowSteps();
}

// Render all workflow steps
function renderWorkflowSteps() {
    const tbody = document.getElementById('workflowSteps');
    tbody.innerHTML = '';
    
    if (workflowSteps.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    No workflow steps defined. Click "Add Workflow Step" to get started.
                </td>
            </tr>
        `;
        return;
    }
    
    workflowSteps.forEach((step, index) => {
        tbody.appendChild(createStepRow(step, index + 1));
    });
    
    console.log('âœ… Rendered', workflowSteps.length, 'workflow steps');
}

// Create step row HTML
function createStepRow(step, stepNum) {
    const tr = document.createElement('tr');
    tr.className = 'workflow-step';
    
    // Role options
    const roleOptions = availableRoles.map(role => 
        `<option value="${role}" ${step.role === role ? 'selected' : ''}>${role}</option>`
    ).join('');
    
    // Department options
    const deptOptions = availableDepartments.map(dept => 
        `<option value="${dept}" ${step.department === dept ? 'selected' : ''}>${dept}</option>`
    ).join('');
    
    // Selected users HTML
    const selectedUsersHtml = step.users.map(user => `
        <div class="selected-tag" data-user-id="${user.id}">
            <i class="ti ti-user"></i>
            ${user.name}
            <span class="tag-email">${user.email}</span>
            <i class="ti ti-x" onclick="removeUser(${stepNum - 1}, ${user.id})"></i>
        </div>
    `).join('');
    
    tr.innerHTML = `
        <td>
            <div class="step-number">${stepNum}</div>
        </td>
        <td>
            <select class="form-select" name="role_${stepNum}" onchange="updateStepRole(${stepNum - 1}, this.value)">
                <option value="">Select Role</option>
                ${roleOptions}
            </select>
        </td>
        <td>
            <div class="user-selection-wrapper">
                <div class="user-input-group">
                    <input type="text" class="form-input user-search" placeholder="Search by name or email..." 
                           onkeyup="searchUsers(this, ${stepNum})" onfocus="showUserDropdown(this, ${stepNum})">
                    <button type="button" class="btn-icon" title="Search users">
                        <i class="ti ti-search"></i>
                    </button>
                </div>
                <div class="user-dropdown" id="userDropdown_${stepNum}" style="display: none;"></div>
                <div class="selected-users" id="selectedUsers_${stepNum}">
                    ${selectedUsersHtml || '<span style="color: var(--text-muted); font-size: 0.875rem;">No users selected</span>'}
                </div>
            </div>
        </td>
        <td>
            <select class="form-select" name="department_${stepNum}" onchange="updateStepDepartment(${stepNum - 1}, this.value)">
                <option value="">Select Department</option>
                ${deptOptions}
            </select>
        </td>
        <td style="text-align: center;">
            <i class="ti ti-trash remove-step" onclick="removeStep(${stepNum - 1})"></i>
        </td>
    `;
    
    return tr;
}

// Add new workflow step
function addWorkflowStep() {
    workflowSteps.push({
        step_number: workflowSteps.length + 1,
        role: '',
        department: '',
        users: []
    });
    stepCount = workflowSteps.length;
    console.log('âž• Added new step. Total:', stepCount);
    renderWorkflowSteps();
}

// Remove step
function removeStep(index) {
    if (workflowSteps.length <= 1) {
        showNotification('At least one workflow step is required', 'warning');

        return;
    }
    
    if (confirm('Are you sure you want to remove this workflow step?')) {
        workflowSteps.splice(index, 1);
        // Renumber steps
        workflowSteps.forEach((step, i) => {
            step.step_number = i + 1;
        });
        stepCount = workflowSteps.length;
        console.log('ðŸ—‘ï¸ Removed step. Remaining:', stepCount);
        renderWorkflowSteps();
    }
}

// Update step data
function updateStepRole(index, value) {
    if (workflowSteps[index]) {
        workflowSteps[index].role = value;
        console.log('ðŸ“ Updated step', index + 1, 'role:', value);
    }
}

function updateStepDepartment(index, value) {
    if (workflowSteps[index]) {
        workflowSteps[index].department = value;
        console.log('ðŸ“ Updated step', index + 1, 'department:', value);
    }
}

// Search users
let searchTimeout = null;

async function searchUsers(input, stepNum) {
    clearTimeout(searchTimeout);
    const searchTerm = input.value.toLowerCase();
    const dropdown = document.getElementById(`userDropdown_${stepNum}`);
    
    if (!dropdown) return;
    
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/workflows/users/search?query=${encodeURIComponent(searchTerm)}`);
            if (response.ok) {
                const data = await response.json();
                displayUserDropdown(stepNum, data.users || []);
            }
        } catch (error) {
            console.error('Error searching users:', error);
        }
    }, 300);
}

function showUserDropdown(input, stepNum) {
    // Load all users on focus
    searchUsers(input, stepNum);
}

function displayUserDropdown(stepNum, users) {
    const dropdown = document.getElementById(`userDropdown_${stepNum}`);
    if (!dropdown) return;
    
    if (users.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item" style="cursor: default;">No users found</div>';
    } else {
        dropdown.innerHTML = users.map(user => `
            <div class="dropdown-item" onclick="selectUser(${stepNum}, ${user.id}, '${user.name.replace(/'/g, "\\'")}', '${user.email}')">
                <div class="user-info">
                    <span class="user-name">${user.name}</span>
                    <span class="user-email">${user.email}</span>
                </div>
            </div>
        `).join('');
    }
    
    dropdown.style.display = 'block';
}

function selectUser(stepNum, userId, userName, userEmail) {
    const stepIndex = stepNum - 1;
    if (!workflowSteps[stepIndex]) return;
    
    // Check if already selected
    const exists = workflowSteps[stepIndex].users.find(u => u.id === userId);
    if (exists) {
        alert('User already added to this step');
        return;
    }
    
    // Add user
    workflowSteps[stepIndex].users.push({
        id: userId,
        name: userName,
        email: userEmail
    });
    
    console.log('ðŸ‘¤ Added user to step', stepNum, ':', userName);
    
    // Clear search and hide dropdown
    const searchInput = document.querySelector(`#workflowSteps tr:nth-child(${stepNum}) .user-search`);
    if (searchInput) searchInput.value = '';
    
    const dropdown = document.getElementById(`userDropdown_${stepNum}`);
    if (dropdown) dropdown.style.display = 'none';
    
    renderWorkflowSteps();
}

function removeUser(stepIndex, userId) {
    if (!workflowSteps[stepIndex]) return;
    
    workflowSteps[stepIndex].users = workflowSteps[stepIndex].users.filter(u => u.id !== userId);
    console.log('ðŸ—‘ï¸ Removed user from step', stepIndex + 1);
    renderWorkflowSteps();
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.user-selection-wrapper')) {
        document.querySelectorAll('.user-dropdown').forEach(dropdown => {
            dropdown.style.display = 'none';
        });
    }
});

// Save and submit functions
function goBack() {
    window.location.href = '/';
}

async function saveWorkflow() {
    if (!validateWorkflow()) return;
    
    const workflowData = collectWorkflowData();
    console.log('ðŸ’¾ Saving workflow:', workflowData);
    
    try {
        const response = await fetch('/api/workflows/master', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(workflowData)
        });
        
        if (response.ok) {
            alert('Master workflow saved successfully!');
            window.location.href = '/dashboard';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to save workflow'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving workflow. Please try again.');
    }
}

async function submitWorkflow() {
    if (!validateWorkflow()) return;
    
    if (confirm('Are you sure you want to submit this master workflow? It will be applied to all new contracts.')) {
        await saveWorkflow();
    }
}

function validateWorkflow() {
    if (workflowSteps.length === 0) {
        alert('Please add at least one workflow step');
        return false;
    }
    
    for (let i = 0; i < workflowSteps.length; i++) {
        const step = workflowSteps[i];
        
        if (!step.role) {
            alert(`Please select a role for step ${i + 1}`);
            return false;
        }
        
        if (step.users.length === 0) {
            alert(`Please add at least one user for step ${i + 1}`);
            return false;
        }
    }
    
    return true;
}

function collectWorkflowData() {
    return {
        workflow_name: "Master Workflow",
        description: "Company-wide default workflow",
        steps: workflowSteps.map(step => ({
            step_number: step.step_number,
            step_name: step.role || `Step ${step.step_number}`,
            step_type: step.role || 'Reviewer',
            role: step.role,
            department: step.department,
            users: step.users,
            sla_hours: 24,
            is_mandatory: true
        })),
        auto_escalation: false,
        escalation_hours: 48
    };
}
</script>
{% endblock %}