{% extends "base.html" %}
{% block title %}Obligations Dashboard - CALIM 360{% endblock %}

{% block head %}
<style>
    :root {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --success: #10b981;
        --success-dark: #059669;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;
        --purple: #8b5cf6;
        --text-dark: #1f2937;
        --text-muted: #6b7280;
        --border: #e5e7eb;
        --bg-light: #f9fafb;
        --bg-card: #ffffff;
    }

    .page-content {
        padding: 1.5rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Page Header */
    .page-header {
        margin-bottom: 1.5rem;
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .page-title i {
        color: var(--purple);
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-icon.total {
        background: rgba(59, 130, 246, 0.1);
        color: var(--primary);
    }

    .stat-icon.pending {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .stat-icon.overdue {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    .stat-icon.completed {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .stat-content h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
    }

    .stat-content p {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin: 0;
    }

    /* Filters Section */
    .filters-section {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .filter-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-muted);
        text-transform: uppercase;
    }

    .filter-control {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.875rem;
        min-width: 150px;
        background: white;
    }

    .filter-control:focus {
        outline: none;
        border-color: var(--primary);
    }

    .search-box {
        flex: 1;
        min-width: 200px;
        position: relative;
    }

    .search-box input {
        width: 100%;
        padding: 0.5rem 0.75rem 0.5rem 2.25rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.875rem;
    }

    .search-box i {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }

    .filter-actions {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-success:hover {
        background: var(--success-dark);
    }

    .btn-secondary {
        background: var(--bg-light);
        color: var(--text-dark);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--border);
    }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Obligations Table */
    .obligations-card {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .obligation-count {
        background: var(--primary);
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    .table-container {
        overflow-x: auto;
    }

    .obligations-table {
        width: 100%;
        border-collapse: collapse;
    }

    .obligations-table th,
    .obligations-table td {
        padding: 0.875rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .obligations-table th {
        background: var(--bg-light);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
    }

    .obligations-table tbody tr:hover {
        background: var(--bg-light);
    }

    .obligations-table tbody tr.selected {
        background: rgba(59, 130, 246, 0.05);
    }

    .obligation-title {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.25rem;
    }

    .obligation-desc {
        font-size: 0.8rem;
        color: var(--text-muted);
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .contract-link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.85rem;
    }

    .contract-link:hover {
        text-decoration: underline;
    }

    .contract-number {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Status Badge */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.625rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-initiated {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .status-in-progress {
        background: #fef3c7;
        color: #b45309;
    }

    .status-pending {
        background: #fed7aa;
        color: #c2410c;
    }

    .status-awaiting {
        background: #e0e7ff;
        color: #4338ca;
    }

    .status-approved {
        background: #d1fae5;
        color: #047857;
    }

    .status-rejected {
        background: #fee2e2;
        color: #b91c1c;
    }

    .status-completed {
        background: #d1fae5;
        color: #047857;
    }

    .status-overdue {
        background: #fee2e2;
        color: #b91c1c;
    }

    /* Type Badge */
    .type-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .type-payment {
        background: #dcfce7;
        color: #166534;
    }

    .type-deliverable {
        background: #dbeafe;
        color: #1e40af;
    }

    .type-compliance {
        background: #fef3c7;
        color: #92400e;
    }

    .type-reporting {
        background: #e0e7ff;
        color: #4338ca;
    }

    .type-insurance {
        background: #fce7f3;
        color: #be185d;
    }

    .type-performance {
        background: #cffafe;
        color: #0e7490;
    }

    .type-coordination {
        background: #f3e8ff;
        color: #7c3aed;
    }

    .type-indemnification {
        background: #fef9c3;
        color: #a16207;
    }

    .type-timely_completion {
        background: #ecfccb;
        color: #4d7c0f;
    }

    .type-other {
        background: #f3f4f6;
        color: #4b5563;
    }

    /* User Display */
    .user-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .user-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .user-name {
        font-size: 0.85rem;
        color: var(--text-dark);
    }

    /* Action Buttons in Table */
    .table-actions {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .action-btn:hover {
        background: var(--bg-light);
    }

    .action-btn.view:hover {
        color: var(--info);
        border-color: var(--info);
    }

    .action-btn.edit:hover {
        color: var(--primary);
        border-color: var(--primary);
    }

    .action-btn.delete:hover {
        color: var(--danger);
        border-color: var(--danger);
    }

    /* Checkbox styling */
    .row-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    /* Pagination */
    .table-footer {
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pagination-info {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .pagination {
        display: flex;
        gap: 0.25rem;
    }

    .page-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .page-btn:hover:not(.active):not(:disabled) {
        background: var(--bg-light);
    }

    .page-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h3 {
        margin: 0 0 0.5rem;
        color: var(--text-dark);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        color: inherit;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .modal-close:hover {
        opacity: 1;
    }

    .modal-body {
        padding: 1.25rem;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-dark);
        margin-bottom: 0.375rem;
    }

    .form-label .required {
        color: var(--danger);
    }

    .form-control {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    textarea.form-control {
        min-height: 80px;
        resize: vertical;
    }

    /* User Search */
    .user-search-container {
        position: relative;
    }

    .user-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 10;
        display: none;
    }

    .user-suggestions.active {
        display: block;
    }

    .user-suggestion-item {
        padding: 0.625rem 0.875rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 0.2s;
    }

    .user-suggestion-item:hover {
        background: var(--bg-light);
    }

    .selected-user {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--bg-light);
        border-radius: 8px;
        margin-top: 0.5rem;
    }

    .selected-user .remove-user {
        margin-left: auto;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-muted);
    }

    .selected-user .remove-user:hover {
        color: var(--danger);
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-content {
        text-align: center;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Toast Notification */
    .toast-container {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 3000;
    }

    .toast {
        padding: 0.875rem 1.25rem;
        border-radius: 8px;
        background: var(--text-dark);
        color: white;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease;
        margin-top: 0.5rem;
    }

    .toast.success {
        background: var(--success);
    }

    .toast.error {
        background: var(--danger);
    }

    .toast.warning {
        background: var(--warning);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Date Display */
    .date-display {
        font-size: 0.85rem;
        color: var(--text-dark);
    }

    .date-display.overdue {
        color: var(--danger);
        font-weight: 500;
    }

    .date-display.warning {
        color: var(--warning);
        font-weight: 500;
    }

    /* Bulk Actions */
    .bulk-actions {
        display: none;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1.25rem;
        background: rgba(59, 130, 246, 0.05);
        border-bottom: 1px solid var(--border);
    }

    .bulk-actions.active {
        display: flex;
    }

    .bulk-count {
        font-weight: 600;
        color: var(--primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .filters-section {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-actions {
            margin-left: 0;
            justify-content: flex-end;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .header-top {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
</style>

<style>
    /* Contract search suggestions */
    .user-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        margin-top: 4px;
    }

    .suggestion-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-light);
        transition: background-color 0.2s;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover {
        background-color: var(--bg-light);
    }

    .suggestion-item.no-results {
        color: var(--text-muted);
        text-align: center;
        cursor: default;
    }

    .suggestion-item.no-results:hover {
        background-color: transparent;
    }

    .suggestion-main {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .suggestion-name {
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .suggestion-name i {
        color: var(--primary-color);
        font-size: 16px;
    }

    .suggestion-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .meta-item {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .meta-item i {
        font-size: 14px;
    }

    /* Selected contract display */
    .selected-user {
        margin-top: 8px;
        padding: 12px;
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .selected-user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .selected-user-details {
        flex: 1;
    }

    .selected-user-name {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .selected-user-name i {
        color: var(--primary-color);
    }

    .selected-user-meta {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-remove-user {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-remove-user:hover {
        background: var(--danger-color);
        color: white;
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-badge i {
        font-size: 12px;
    }

    .status-draft {
        background: #e3f2fd;
        color: #1976d2;
    }

    .status-review {
        background: #fff3e0;
        color: #f57c00;
    }

    .status-negotiation {
        background: #fce4ec;
        color: #c2185b;
    }

    .status-approved {
        background: #e8f5e9;
        color: #388e3c;
    }

    .status-active {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .status-executed {
        background: #e0f2f1;
        color: #00796b;
    }

    .status-completed {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .status-terminated {
        background: #ffebee;
        color: #c62828;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-top">
            <h1 class="page-title">
                <i class="ti ti-checklist"></i>
                Obligations Dashboard
            </h1>
            <button class="btn btn-success" onclick="openNewObligationModal()">
                <i class="ti ti-plus"></i>
                New Obligation
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon total">
                <i class="ti ti-list-check"></i>
            </div>
            <div class="stat-content">
                <h3 id="totalCount">0</h3>
                <p>Total Obligations</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon pending">
                <i class="ti ti-clock"></i>
            </div>
            <div class="stat-content">
                <h3 id="pendingCount">0</h3>
                <p>Pending / In Progress</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon overdue">
                <i class="ti ti-alert-triangle"></i>
            </div>
            <div class="stat-content">
                <h3 id="overdueCount">0</h3>
                <p>Overdue</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon completed">
                <i class="ti ti-circle-check"></i>
            </div>
            <div class="stat-content">
                <h3 id="completedCount">0</h3>
                <p>Completed</p>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filter-group">
            <span class="filter-label" style="color: white;">Search</span>
            <div class="search-box">
                <i class="ti ti-search"></i>
                <input type="text" id="searchInput" placeholder="Search obligations..." oninput="filterObligations()">
            </div>
        </div>
        <div class="filter-group">
            <span class="filter-label">Status</span>
            <select class="filter-control" id="statusFilter" onchange="filterObligations()">
                <option value="all">All Statuses</option>
                <option value="initiated">Initiated</option>
                <option value="in-progress">In Progress</option>
                <option value="pending">Pending</option>
                <option value="awaiting">Awaiting Approval</option>
                <option value="approved">Approved</option>
                <option value="completed">Completed</option>
                <option value="overdue">Overdue</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">Type</span>
            <select class="filter-control" id="typeFilter" onchange="filterObligations()">
                <option value="all">All Types</option>
                <option value="payment">Payment</option>
                <option value="deliverable">Deliverable</option>
                <option value="compliance">Compliance</option>
                <option value="reporting">Reporting</option>
                <option value="insurance">Insurance</option>
                <option value="performance">Performance</option>
                <option value="timely_completion">Timely Completion</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">Contract</span>
            <select class="filter-control" id="contractFilter" onchange="filterObligations()">
                <option value="all">All Contracts</option>
                <!-- Contracts loaded dynamically -->
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="ti ti-filter-off"></i>
                Clear
            </button>
            <button class="btn btn-primary" onclick="refreshObligations()">
                <i class="ti ti-refresh"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Obligations Table -->
    <div class="obligations-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="ti ti-list-check"></i>
                All Obligations
                <span class="obligation-count" id="obligationCount">0</span>
            </h2>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions" id="bulkActions">
            <span><span class="bulk-count" id="selectedCount">0</span> selected</span>
            <button class="btn btn-danger" onclick="bulkDelete()">
                <i class="ti ti-trash"></i>
                Delete Selected
            </button>
            <button class="btn btn-secondary" onclick="clearSelection()">
                <i class="ti ti-x"></i>
                Clear Selection
            </button>
        </div>

        <div class="table-container">
            <table class="obligations-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" class="row-checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>Obligation</th>
                        <th>Contract</th>
                        <th>Type</th>
                        <th>Owner</th>
                        <th>Status</th>
                        <th>Due Date</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="obligationsTableBody">
                    <!-- Obligations loaded dynamically -->
                </tbody>
            </table>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="ti ti-clipboard-off"></i>
            <h3>No Obligations Found</h3>
            <p>Try adjusting your filters or create a new obligation.</p>
        </div>

        <div class="table-footer">
            <div class="pagination-info" id="paginationInfo">
                Showing 0 obligations
            </div>
            <div class="pagination" id="pagination">
                <!-- Pagination buttons -->
            </div>
        </div>
    </div>
</div>

<!-- Edit/New Obligation Modal -->
<div class="modal-overlay" id="obligationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-plus-circle"></i>
                <span id="modalTitle">New Obligation</span>
            </h3>
            <button class="modal-close" onclick="closeModal('obligationModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="obligationForm">
                <input type="hidden" id="editObligationId">

                <div class="form-group">
                    <label class="form-label">Contract <span class="required">*</span></label>
                    <div class="user-search-container">
                        <input type="text" class="form-control" id="contractSearch" placeholder="Search contracts..."
                            autocomplete="off">
                        <input type="hidden" id="selectedContractId">
                        <div class="user-suggestions" id="contractSuggestions"></div>
                    </div>
                    <div class="selected-user" id="selectedContract" style="display: none;"></div>
                </div>

                <!-- <div class="form-group">
                    <label class="form-label">Contract</label>
                    <input type="text" class="form-control" id="obligationContractId" disabled
                        placeholder="Enter obligation title">
                </div> -->

                <div class="form-group">
                    <label class="form-label">Obligation Title <span class="required">*</span></label>
                    <input type="text" class="form-control" id="obligationTitle" required
                        placeholder="Enter obligation title">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="obligationDescription"
                        placeholder="Enter detailed description"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Obligation Type <span class="required">*</span></label>
                        <select class="form-control" id="obligationType" required>
                            <option value="">Select Type</option>
                            <option value="payment">Payment</option>
                            <option value="deliverable">Deliverable</option>
                            <option value="compliance">Compliance</option>
                            <option value="reporting">Reporting</option>
                            <option value="insurance">Insurance</option>
                            <option value="performance">Performance</option>
                            <option value="coordination">Coordination</option>
                            <option value="indemnification">Indemnification</option>
                            <option value="timely_completion">Timely Completion</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status <span class="required">*</span></label>
                        <select class="form-control" id="obligationStatus" required>
                            <option value="initiated">Initiated</option>
                            <option value="in-progress">In Progress</option>
                            <option value="pending">Pending Details</option>
                            <option value="awaiting">Awaiting Approval</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Owner</label>
                        <div class="user-search-container">
                            <input type="text" class="form-control" id="ownerSearch" placeholder="Search user..."
                                autocomplete="off">
                            <input type="hidden" id="ownerUserId">
                            <div class="user-suggestions" id="ownerSuggestions"></div>
                        </div>
                        <div class="selected-user" id="selectedOwner" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Escalation Contact</label>
                        <div class="user-search-container">
                            <input type="text" class="form-control" id="escalationSearch" placeholder="Search user..."
                                autocomplete="off">
                            <input type="hidden" id="escalationUserId">
                            <div class="user-suggestions" id="escalationSuggestions"></div>
                        </div>
                        <div class="selected-user" id="selectedEscalation" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Threshold Date</label>
                        <input type="date" class="form-control" id="thresholdDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date <span class="required">*</span></label>
                        <input type="date" class="form-control" id="dueDate" required>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('obligationModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveObligation()">
                <i class="ti ti-check"></i>
                Save Obligation
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p id="loadingText">Loading...</p>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

{% endblock %}

{% block extra_js %}
<script>
    // =====================================================
    // GLOBAL VARIABLES
    // =====================================================
    const API_BASE = '/api/obligations';
    let allObligations = [];
    let filteredObligations = [];
    let users = [];
    let contracts = [];
    let selectedObligations = new Set();
    let currentPage = 1;
    const pageSize = 10;

    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', async function () {
        // await loadContracts();
        await loadObligations();
        await loadUsers();
        setupUserSearch();
    });

    // =====================================================
    // DATA LOADING
    // =====================================================
    async function loadObligations() {
        showLoading(true, 'Loading obligations...');
        try {
            const response = await fetch(`${API_BASE}/`);
            if (!response.ok) throw new Error('Failed to load obligations');

            const data = await response.json();
            allObligations = Array.isArray(data) ? data : (data.obligations || []);

            // Check for overdue obligations
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            allObligations.forEach(obl => {
                if (obl.due_date && obl.status !== 'completed') {
                    const dueDate = new Date(obl.due_date);
                    if (dueDate < today) {
                        obl.status = 'overdue';
                    }
                }
            });

            filterObligations();
            updateStats();
        } catch (error) {
            console.error('Error loading obligations:', error);
            showToast('Failed to load obligations', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/users/company');
            if (!response.ok) throw new Error('Failed to load users');
            const data = await response.json();
            users = data.users || [];
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    // =============================================
    // LOAD CONTRACTS
    // =============================================
    let contractsList = [];


    let contractSearchTimeout = null;

    // =============================================
    // LOAD CONTRACTS
    // =============================================
    async function loadContracts() {
        try {
            console.log('üîÑ Loading contracts...');

            const response = await fetch('/api/contracts/my-contracts', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: Failed to load contracts`);
            }

            const data = await response.json();
            contractsList = data.contracts || [];

            console.log('üìã Loaded contracts:', contractsList.length);
            return contractsList;

        } catch (error) {
            console.error('‚ùå Error loading contracts:', error);
            showToast('Failed to load contracts: ' + error.message, 'error');
            return [];
        }
    }



    // =============================================
    // SEARCH CONTRACTS (with debounce)
    // =============================================
    function searchContracts(searchTerm) {
        console.log('üîç Searching contracts:', searchTerm);

        const suggestionsDiv = document.getElementById('contractSuggestions');

        if (!searchTerm || searchTerm.trim().length < 2) {
            suggestionsDiv.innerHTML = '';
            suggestionsDiv.style.display = 'none';
            return;
        }

        const term = searchTerm.toLowerCase().trim();

        // Filter contracts by number, title, or counterparty
        const matches = contractsList.filter(contract => {
            const number = (contract.contract_number || '').toLowerCase();
            const title = (contract.contract_title || '').toLowerCase();
            const counterparty = (contract.counterparty_name || '').toLowerCase();
            const status = (contract.status || '').toLowerCase();

            return number.includes(term) ||
                title.includes(term) ||
                counterparty.includes(term) ||
                status.includes(term);
        });

        console.log('üìä Found matches:', matches.length);

        if (matches.length === 0) {
            suggestionsDiv.innerHTML = '<div class="suggestion-item no-results">No contracts found</div>';
            suggestionsDiv.style.display = 'block';
            return;
        }

        // Display top 10 matches
        const html = matches.slice(0, 10).map(contract => {
            const statusBadge = getStatusBadge(contract.status);
            return `
            <div class="suggestion-item" onclick="selectContract(${contract.id}, '${escapeHtml(contract.contract_number)}', '${escapeHtml(contract.contract_title)}', '${escapeHtml(contract.status)}')">
                <div class="suggestion-main">
                    <div class="suggestion-name">
                        <i class="ti ti-file-text"></i>
                        ${contract.contract_number} - ${contract.contract_title}
                    </div>
                    <div class="suggestion-meta">
                        ${statusBadge}
                        ${contract.counterparty_name ? `<span class="meta-item"><i class="ti ti-building"></i> ${contract.counterparty_name}</span>` : ''}
                        ${contract.contract_value ? `<span class="meta-item"><i class="ti ti-currency-dollar"></i> ${formatCurrency(contract.contract_value, contract.currency)}</span>` : ''}
                    </div>
                </div>
            </div>
        `;
        }).join('');

        suggestionsDiv.innerHTML = html;
        suggestionsDiv.style.display = 'block';
    }


    // =============================================
    // SELECT CONTRACT
    // =============================================
    function selectContract(contractId, contractNumber, contractTitle, status) {
        console.log(' Selected contract:', contractId, contractNumber);

        // Set hidden input
        document.getElementById('selectedContractId').value = contractId;

        // Hide search, show selected
        document.getElementById('contractSearch').style.display = 'none';
        document.getElementById('contractSuggestions').style.display = 'none';

        // Show selected contract
        const selectedDiv = document.getElementById('selectedContract');
        const statusBadge = getStatusBadge(status);

        selectedDiv.innerHTML = `
        <div class="selected-user-info">
            <div class="selected-user-details">
                <div class="selected-user-name">
                    <i class="ti ti-file-text"></i>
                    ${contractNumber} - ${contractTitle}
                </div>
                <div class="selected-user-meta">
                    ${statusBadge}
                </div>
            </div>
            <button type="button" class="btn-remove-user" onclick="clearContractSelection()">
                <i class="ti ti-x"></i>
            </button>
        </div>
    `;
        selectedDiv.style.display = 'block';
    }


    function clearContractSelection() {
        console.log('üóëÔ∏è Clearing contract selection');

        document.getElementById('selectedContractId').value = '';
        document.getElementById('contractSearch').value = '';
        document.getElementById('contractSearch').style.display = 'block';
        document.getElementById('selectedContract').style.display = 'none';
        document.getElementById('contractSuggestions').style.display = 'none';

        // Focus on search field
        document.getElementById('contractSearch').focus();
    }


    function getStatusBadge(status) {
        const statusConfig = {
            'draft': { class: 'status-draft', icon: 'ti-file', text: 'Draft' },
            'internal_review': { class: 'status-review', icon: 'ti-eye', text: 'Review' },
            'negotiation': { class: 'status-negotiation', icon: 'ti-message-circle', text: 'Negotiation' },
            'approved': { class: 'status-approved', icon: 'ti-check', text: 'Approved' },
            'active': { class: 'status-active', icon: 'ti-circle-check', text: 'Active' },
            'executed': { class: 'status-executed', icon: 'ti-file-check', text: 'Executed' },
            'completed': { class: 'status-completed', icon: 'ti-circle-check-filled', text: 'Completed' },
            'terminated': { class: 'status-terminated', icon: 'ti-x', text: 'Terminated' }
        };

        const config = statusConfig[status] || { class: 'status-draft', icon: 'ti-file', text: status };
        return `<span class="status-badge ${config.class}"><i class="ti ${config.icon}"></i> ${config.text}</span>`;
    }


    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatCurrency(amount, currency = 'QAR') {
        if (!amount) return '';
        const formatted = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
        return `${formatted} ${currency}`;
    }




    // =============================================
    // POPULATE CONTRACT DROPDOWN
    // =============================================


    function populateContractDropdown(selectedContractId = null) {
        console.log('üîÑ populateContractDropdown() called');
        console.log('üìä contractsList:', contractsList.length, 'contracts');
        console.log('üéØ selectedContractId:', selectedContractId);

        const select = document.getElementById('obligationContractId');

        if (!select) {
            console.error('‚ùå SELECT ELEMENT NOT FOUND!');
            console.log('üîç Searching for select elements...');
            const allSelects = document.querySelectorAll('select');
            console.log('üìã Found selects:', allSelects.length);
            allSelects.forEach((s, i) => {
                console.log(`  ${i + 1}. id="${s.id}" name="${s.name}"`);
            });
            return;
        }

        console.log(' Found select element:', select.id);
        console.log('üìè Current options:', select.options.length);

        // Clear and add default option
        select.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Contract';
        select.appendChild(defaultOption);

        console.log('üîÑ After reset, options:', select.options.length);

        // Show all contracts (remove status filter for debugging)
        let addedCount = 0;

        contractsList.forEach((contract, index) => {
            try {
                const option = document.createElement('option');
                option.value = contract.id;
                option.textContent = `${contract.contract_number || 'N/A'} - ${contract.contract_title || 'Untitled'}`;

                if (selectedContractId && contract.id == selectedContractId) {
                    option.selected = true;
                    console.log(' Pre-selected:', contract.contract_number);
                }

                select.appendChild(option);
                addedCount++;

                // Log first 3 contracts
                if (index < 3) {
                    console.log(`  ${index + 1}. Added: ${option.value} - ${option.textContent}`);
                }
            } catch (err) {
                console.error(`‚ùå Error adding contract ${index}:`, err);
            }
        });

        console.log(` Total added: ${addedCount} contracts`);
        console.log(`üìä Final dropdown options: ${select.options.length}`);

        // Verify dropdown is visible
        const isVisible = select.offsetParent !== null;
        console.log('üëÅÔ∏è Dropdown visible:', isVisible);
        console.log('üìê Dropdown dimensions:', {
            width: select.offsetWidth,
            height: select.offsetHeight
        });
    }



    function refreshObligations() {
        loadObligations();
    }

    // =====================================================
    // FILTERING & RENDERING
    // =====================================================
    function filterObligations() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const contractFilter = document.getElementById('contractFilter').value;

        filteredObligations = allObligations.filter(obl => {
            // Search filter
            const matchesSearch = !search ||
                (obl.obligation_title || '').toLowerCase().includes(search) ||
                (obl.description || '').toLowerCase().includes(search) ||
                (obl.contract_title || '').toLowerCase().includes(search) ||
                (obl.contract_number || '').toLowerCase().includes(search);

            // Status filter
            const matchesStatus = statusFilter === 'all' || obl.status === statusFilter;

            // Type filter
            const matchesType = typeFilter === 'all' || obl.obligation_type === typeFilter;

            // Contract filter
            const matchesContract = contractFilter === 'all' ||
                String(obl.contract_id) === String(contractFilter);

            return matchesSearch && matchesStatus && matchesType && matchesContract;
        });

        currentPage = 1;
        renderObligations();
        document.getElementById('obligationCount').textContent = filteredObligations.length;
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('typeFilter').value = 'all';
        document.getElementById('contractFilter').value = 'all';
        filterObligations();
    }

    function renderObligations() {
        const tbody = document.getElementById('obligationsTableBody');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.querySelector('.table-container');

        if (filteredObligations.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            tableContainer.style.display = 'none';
            updatePagination();
            return;
        }

        emptyState.style.display = 'none';
        tableContainer.style.display = 'block';

        // Pagination
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageObligations = filteredObligations.slice(start, end);

        tbody.innerHTML = pageObligations.map(obl => `
        <tr data-id="${obl.id}" class="${selectedObligations.has(obl.id) ? 'selected' : ''}">
            <td>
                <input type="checkbox" class="row-checkbox" 
                       ${selectedObligations.has(obl.id) ? 'checked' : ''}
                       onchange="toggleSelection(${obl.id})">
            </td>
            <td>
                <div class="obligation-title">${escapeHtml(obl.obligation_title)}</div>
                <div class="obligation-desc">${escapeHtml(obl.description || '')}</div>
            </td>
            <td>
                <a href="/contract/obligations/${obl.contract_id}" class="contract-link">
                    ${escapeHtml(obl.contract_title || 'View Contract')}
                </a>
                <div class="contract-number">${escapeHtml(obl.contract_number || '')}</div>
            </td>
            <td>
                <span class="type-badge type-${obl.obligation_type || 'other'}">
                    ${formatType(obl.obligation_type)}
                </span>
            </td>
            <td>${renderUser(obl.owner_user_id, obl.owner_name)}</td>
            <td>
                <span class="status-badge status-${obl.status || 'initiated'}">
                    ${formatStatus(obl.status)}
                </span>
            </td>
            <td>${formatDueDate(obl.due_date)}</td>
            <td>
                <div class="table-actions">
                    <button class="action-btn view" onclick="viewContract(${obl.contract_id})" title="View Contract">
                        <i class="ti ti-eye"></i>
                    </button>
                    <button class="action-btn edit" onclick="editObligation(${obl.id})" title="Edit">
                        <i class="ti ti-pencil"></i>
                    </button>
                    <button class="action-btn delete" onclick="deleteObligation(${obl.id})" title="Delete">
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

        updatePagination();
    }

    function renderUser(userId, userName) {
        if (!userId && !userName) return '<span style="color: var(--text-muted);">-</span>';

        const name = userName || 'Unknown';
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

        return `
        <div class="user-display">
            <div class="user-avatar">${initials}</div>
            <span class="user-name">${escapeHtml(name)}</span>
        </div>
    `;
    }

    function updateStats() {
        const total = allObligations.length;
        const pending = allObligations.filter(o =>
            ['initiated', 'in-progress', 'pending', 'awaiting'].includes(o.status)
        ).length;
        const overdue = allObligations.filter(o => o.status === 'overdue').length;
        const completed = allObligations.filter(o => o.status === 'completed').length;

        document.getElementById('totalCount').textContent = total;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('overdueCount').textContent = overdue;
        document.getElementById('completedCount').textContent = completed;
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredObligations.length / pageSize);
        const start = (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, filteredObligations.length);

        document.getElementById('paginationInfo').textContent =
            filteredObligations.length === 0
                ? 'No obligations found'
                : `Showing ${start} to ${end} of ${filteredObligations.length} obligations`;

        const pagination = document.getElementById('pagination');
        let buttons = '';

        buttons += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
        <i class="ti ti-chevron-left"></i>
    </button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                buttons += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                buttons += `<button class="page-btn" disabled>...</button>`;
            }
        }

        buttons += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>
        <i class="ti ti-chevron-right"></i>
    </button>`;

        pagination.innerHTML = buttons;
    }

    function goToPage(page) {
        const totalPages = Math.ceil(filteredObligations.length / pageSize);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderObligations();
        }
    }

    // =====================================================
    // SELECTION
    // =====================================================
    function toggleSelection(id) {
        if (selectedObligations.has(id)) {
            selectedObligations.delete(id);
        } else {
            selectedObligations.add(id);
        }
        updateBulkActions();
        renderObligations();
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll').checked;

        if (selectAll) {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            filteredObligations.slice(start, end).forEach(obl => {
                selectedObligations.add(obl.id);
            });
        } else {
            selectedObligations.clear();
        }

        updateBulkActions();
        renderObligations();
    }

    function clearSelection() {
        selectedObligations.clear();
        document.getElementById('selectAll').checked = false;
        updateBulkActions();
        renderObligations();
    }

    function updateBulkActions() {
        const bulkActions = document.getElementById('bulkActions');
        const count = selectedObligations.size;

        if (count > 0) {
            bulkActions.classList.add('active');
            document.getElementById('selectedCount').textContent = count;
        } else {
            bulkActions.classList.remove('active');
        }
    }

    async function bulkDelete() {
        if (selectedObligations.size === 0) return;

        if (!confirm(`Are you sure you want to delete ${selectedObligations.size} obligation(s)?`)) return;

        showLoading(true, 'Deleting obligations...');

        try {
            const promises = Array.from(selectedObligations).map(id =>
                fetch(`${API_BASE}/${id}`, { method: 'DELETE' })
            );

            await Promise.all(promises);

            showToast(`Deleted ${selectedObligations.size} obligation(s)`, 'success');
            selectedObligations.clear();
            updateBulkActions();
            loadObligations();
        } catch (error) {
            console.error('Error deleting obligations:', error);
            showToast('Failed to delete some obligations', 'error');
        } finally {
            showLoading(false);
        }
    }

    // =====================================================
    // MODAL FUNCTIONS
    // =====================================================
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }




    async function openNewObligationModal() {
        console.log('üöÄ Opening New Obligation Modal');

        document.getElementById('modalTitle').textContent = 'New Obligation';
        document.getElementById('obligationForm').reset();
        document.getElementById('editObligationId').value = '';

        // Reset contract selection
        document.getElementById('selectedContractId').value = '';
        document.getElementById('contractSearch').value = '';
        document.getElementById('contractSearch').style.display = 'block';
        document.getElementById('selectedContract').style.display = 'none';
        document.getElementById('contractSuggestions').style.display = 'none';

        // Reset user selections
        document.getElementById('ownerUserId').value = '';
        document.getElementById('escalationUserId').value = '';
        document.getElementById('selectedOwner').style.display = 'none';
        document.getElementById('selectedEscalation').style.display = 'none';
        document.getElementById('ownerSearch').style.display = 'block';
        document.getElementById('escalationSearch').style.display = 'block';

        // Ensure contracts are loaded
        if (contractsList.length === 0) {
            showLoading(true, 'Loading contracts...');
            try {
                await loadContracts();
            } catch (error) {
                console.error('Error loading contracts:', error);
                showToast('Failed to load contracts', 'error');
            } finally {
                showLoading(false);
            }
        }

        openModal('obligationModal');
    }

    // =============================================
// EDIT OBLIGATION - COMPLETE FIXED VERSION
// =============================================
async function editObligation(id) {
    console.log('');
    console.log('========================================');
    console.log('‚úèÔ∏è EDITING OBLIGATION:', id);
    console.log('========================================');
    
    const obl = allObligations.find(o => o.id === id);
    if (!obl) {
        console.error('‚ùå Obligation not found in allObligations array');
        showToast('Obligation not found', 'error');
        return;
    }

    console.log('üìã Obligation data:', {
        id: obl.id,
        contract_id: obl.contract_id,
        contract_title: obl.contract_title,
        contract_number: obl.contract_number,
        title: obl.obligation_title
    });

    // Show loading
    showLoading(true, 'Loading obligation details...');

    try {
        // Set modal title and form values
        document.getElementById('modalTitle').textContent = 'Edit Obligation';
        document.getElementById('editObligationId').value = id;
        document.getElementById('obligationTitle').value = obl.obligation_title || '';
        document.getElementById('obligationDescription').value = obl.description || '';
        document.getElementById('obligationType').value = obl.obligation_type || '';
        document.getElementById('obligationStatus').value = obl.status || 'initiated';
        document.getElementById('thresholdDate').value = obl.threshold_date ? obl.threshold_date.split('T')[0] : '';
        document.getElementById('dueDate').value = obl.due_date ? obl.due_date.split('T')[0] : '';

        // ==========================================
        // CONTRACT SELECTION HANDLING
        // ==========================================
        console.log('üîÑ Processing contract selection...');
        
        if (obl.contract_id) {
            console.log('üìù Contract ID exists:', obl.contract_id);
            
            // Ensure contracts are loaded
            if (contractsList.length === 0) {
                console.log('üì• Contracts not loaded yet, loading now...');
                await loadContracts();
                console.log(' Contracts loaded:', contractsList.length);
            } else {
                console.log(' Contracts already loaded:', contractsList.length);
            }
            
            // Find contract in the list
            const contract = contractsList.find(c => {
                // Try both strict and loose equality
                return c.id == obl.contract_id || c.id === obl.contract_id || 
                       parseInt(c.id) === parseInt(obl.contract_id);
            });
            
            if (contract) {
                console.log(' Found contract in list:', {
                    id: contract.id,
                    number: contract.contract_number,
                    title: contract.contract_title
                });
                
                // Select the contract
                selectContract(
                    contract.id, 
                    contract.contract_number, 
                    contract.contract_title,
                    contract.status || 'active'
                );
                
                console.log(' Contract selected successfully');
            } else {
                // Contract not in list - use obligation data as fallback
                console.warn('‚ö†Ô∏è Contract not found in contractsList');
                console.log('üîç Searching for contract_id:', obl.contract_id);
                console.log('üìä Available contract IDs:', contractsList.map(c => c.id).slice(0, 5));
                
                if (obl.contract_title || obl.contract_number) {
                    console.log('üìù Using contract data from obligation');
                    
                    // Manually set the contract selection
                    document.getElementById('selectedContractId').value = obl.contract_id;
                    document.getElementById('contractSearch').style.display = 'none';
                    document.getElementById('contractSuggestions').style.display = 'none';
                    
                    const selectedDiv = document.getElementById('selectedContract');
                    const displayText = obl.contract_number 
                        ? `${obl.contract_number} - ${obl.contract_title || 'Contract'}`
                        : (obl.contract_title || `Contract ID: ${obl.contract_id}`);
                    
                    selectedDiv.innerHTML = `
                        <div class="selected-user-info">
                            <div class="selected-user-details">
                                <div class="selected-user-name">
                                    <i class="ti ti-file-text"></i>
                                    ${displayText}
                                </div>
                                <div class="selected-user-meta">
                                    <span class="status-badge status-active">
                                        <i class="ti ti-file"></i> Contract
                                    </span>
                                </div>
                            </div>
                            <button type="button" class="btn-remove-user" onclick="clearContractSelection()">
                                <i class="ti ti-x"></i>
                            </button>
                        </div>
                    `;
                    selectedDiv.style.display = 'block';
                    
                    console.log(' Contract display set from obligation data');
                } else {
                    console.error('‚ùå No contract information available');
                    clearContractSelection();
                }
            }
        } else {
            console.log('‚ÑπÔ∏è No contract associated with this obligation');
            clearContractSelection();
        }

        // ==========================================
        // OWNER USER SELECTION
        // ==========================================
        if (obl.owner_user_id) {
            console.log('üë§ Setting owner:', obl.owner_user_id, obl.owner_name);
            document.getElementById('ownerUserId').value = obl.owner_user_id;
            setSelectedUser('owner', obl.owner_user_id, obl.owner_name);
        } else {
            document.getElementById('ownerUserId').value = '';
            document.getElementById('selectedOwner').style.display = 'none';
            document.getElementById('ownerSearch').style.display = 'block';
        }

        // ==========================================
        // ESCALATION USER SELECTION
        // ==========================================
        if (obl.escalation_user_id) {
            console.log('üì¢ Setting escalation:', obl.escalation_user_id, obl.escalation_name);
            document.getElementById('escalationUserId').value = obl.escalation_user_id;
            setSelectedUser('escalation', obl.escalation_user_id, obl.escalation_name);
        } else {
            document.getElementById('escalationUserId').value = '';
            document.getElementById('selectedEscalation').style.display = 'none';
            document.getElementById('escalationSearch').style.display = 'block';
        }

        // Hide loading and open modal
        showLoading(false);
        openModal('obligationModal');
        
        // Final verification after modal opens
        setTimeout(() => {
            const selectedContractId = document.getElementById('selectedContractId').value;
            const selectedContractDiv = document.getElementById('selectedContract');
            const isVisible = selectedContractDiv.style.display !== 'none';
            
            console.log('');
            console.log('üîç FINAL VERIFICATION:');
            console.log('  ‚úì Selected Contract ID:', selectedContractId);
            console.log('  ‚úì Contract Display Visible:', isVisible);
            console.log('  ‚úì Modal Open:', document.getElementById('obligationModal').classList.contains('active'));
            console.log('========================================');
            console.log('');
            
            if (!selectedContractId && obl.contract_id) {
                console.error('‚ö†Ô∏è WARNING: Contract should be selected but isn\'t!');
                showToast('Warning: Contract selection may need manual verification', 'warning');
            }
        }, 200);
        
    } catch (error) {
        console.error('‚ùå ERROR in editObligation:', error);
        console.error('Stack:', error.stack);
        showToast('Error loading obligation details: ' + error.message, 'error');
        showLoading(false);
    }
}



    // function setContractValue(contractId) {
    //     const contractSelect = document.getElementById('obligationContractId');
    //     if (!contractSelect) return;

    //     const attempts = [0, 50, 100, 200, 500];

    //     attempts.forEach(delay => {
    //         setTimeout(() => {
    //             const idAsString = String(contractId);
    //             const idAsNumber = Number(contractId);

    //             let optionFound = false;
    //             for (let i = 0; i < contractSelect.options.length; i++) {
    //                 const optValue = contractSelect.options[i].value;
    //                 if (optValue == contractId || optValue == idAsString || optValue == idAsNumber) {
    //                     contractSelect.selectedIndex = i;
    //                     optionFound = true;
    //                     break;
    //                 }
    //             }

    //             // if (!optionFound && delay === 0) {
    //             //     loadContracts().then(() => {
    //             //         setTimeout(() => setContractValue(contractId), 100);
    //             //     });
    //             // }
    //         }, delay);
    //     });
    // }


    //  NEW HELPER FUNCTION: Load contracts and set value
    // async function loadContractsAndSet(contractId) {
    //     try {
    //         // Reload contracts if needed
    //         if (!contracts || contracts.length === 0) {
    //             await loadContracts();
    //         }

    //         // Set the value after contracts are loaded
    //         const contractSelect = document.getElementById('obligationContractId');
    //         if (contractSelect && contractId) {
    //             contractSelect.value = contractId;
    //         }
    //     } catch (error) {
    //         console.error('Error loading contracts for edit:', error);
    //     }
    // }

    async function saveObligation() {
        const form = document.getElementById('obligationForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const editId = document.getElementById('editObligationId').value;
        const isEdit = !!editId;

        // Get contract_id from hidden input
        const contractId = document.getElementById('selectedContractId').value;

        if (!contractId) {
            showToast('Please select a contract', 'error');
            return;
        }

        const payload = {
            contract_id: parseInt(contractId),
            obligation_title: document.getElementById('obligationTitle').value.trim(),
            description: document.getElementById('obligationDescription').value.trim(),
            obligation_type: document.getElementById('obligationType').value,
            status: document.getElementById('obligationStatus').value,
            owner_user_id: document.getElementById('ownerUserId').value || null,
            escalation_user_id: document.getElementById('escalationUserId').value || null,
            threshold_date: document.getElementById('thresholdDate').value || null,
            due_date: document.getElementById('dueDate').value || null
        };

        console.log('üíæ Saving obligation:', payload);

        showLoading(true, isEdit ? 'Updating obligation...' : 'Creating obligation...');

        try {
            const url = isEdit ? `${API_BASE}/${editId}` : `${API_BASE}/`;
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save obligation');
            }

            showToast(
                isEdit ? 'Obligation updated successfully' : 'Obligation created successfully',
                'success'
            );
            closeModal('obligationModal');
            loadObligations();
        } catch (error) {
            console.error('Error saving obligation:', error);
            showToast(error.message || 'Failed to save obligation', 'error');
        } finally {
            showLoading(false);
        }
    }


    async function deleteObligation(id) {
        if (!confirm('Are you sure you want to delete this obligation?')) return;

        showLoading(true, 'Deleting obligation...');

        try {
            const response = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to delete obligation');
            }

            showToast('Obligation deleted successfully', 'success');
            loadObligations();
        } catch (error) {
            console.error('Error deleting obligation:', error);
            showToast(error.message || 'Failed to delete obligation', 'error');
        } finally {
            showLoading(false);
        }
    }

    function viewContract(contractId) {
        window.location.href = `/contract/obligations/${contractId}`;
    }

    // =====================================================
    // USER SEARCH
    // =====================================================
    function setupUserSearch() {
        const ownerSearch = document.getElementById('ownerSearch');
        const escalationSearch = document.getElementById('escalationSearch');

        ownerSearch.addEventListener('input', () => searchUsers('owner', ownerSearch.value));
        escalationSearch.addEventListener('input', () => searchUsers('escalation', escalationSearch.value));

        ownerSearch.addEventListener('focus', () => searchUsers('owner', ownerSearch.value));
        escalationSearch.addEventListener('focus', () => searchUsers('escalation', escalationSearch.value));

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-search-container')) {
                document.querySelectorAll('.user-suggestions').forEach(el => el.classList.remove('active'));
            }
        });
    }

    function searchUsers(type, query) {
        const suggestionsEl = document.getElementById(`${type}Suggestions`);

        if (query.length < 1) {
            suggestionsEl.classList.remove('active');
            return;
        }

        const filtered = users.filter(u => {
            const fullName = `${u.first_name} ${u.last_name}`.toLowerCase();
            const email = (u.email || '').toLowerCase();
            const q = query.toLowerCase();
            return fullName.includes(q) || email.includes(q);
        }).slice(0, 5);

        if (filtered.length === 0) {
            suggestionsEl.innerHTML = '<div class="user-suggestion-item" style="color: var(--text-muted);">No users found</div>';
        } else {
            suggestionsEl.innerHTML = filtered.map(u => `
            <div class="user-suggestion-item" onclick="selectUser('${type}', ${u.id}, '${escapeHtml(u.first_name)} ${escapeHtml(u.last_name)}')">
                <div class="user-avatar">${u.first_name[0]}${u.last_name[0]}</div>
                <div>
                    <div style="font-weight: 500;">${escapeHtml(u.first_name)} ${escapeHtml(u.last_name)}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${escapeHtml(u.email)}</div>
                </div>
            </div>
        `).join('');
        }

        suggestionsEl.classList.add('active');
    }

    function selectUser(type, userId, userName) {
        document.getElementById(`${type}UserId`).value = userId;
        document.getElementById(`${type}Search`).style.display = 'none';
        document.getElementById(`${type}Suggestions`).classList.remove('active');
        setSelectedUser(type, userId, userName);
    }

    function setSelectedUser(type, userId, userName) {
        const selectedEl = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}`);
        const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

        selectedEl.innerHTML = `
        <div class="user-avatar">${initials}</div>
        <span>${escapeHtml(userName)}</span>
        <button class="remove-user" onclick="removeUser('${type}')">
            <i class="ti ti-x"></i>
        </button>
    `;
        selectedEl.style.display = 'flex';
    }

    function removeUser(type) {
        document.getElementById(`${type}UserId`).value = '';
        document.getElementById(`${type}Search`).value = '';
        document.getElementById(`${type}Search`).style.display = 'block';
        document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}`).style.display = 'none';
    }

    // =====================================================
    // UTILITY FUNCTIONS
    // =====================================================
    function showLoading(show, text = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        document.getElementById('loadingText').textContent = text;
        overlay.classList.toggle('active', show);
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
        <i class="ti ti-${type === 'success' ? 'check' : type === 'error' ? 'x' : 'info-circle'}"></i>
        ${escapeHtml(message)}
    `;
        container.appendChild(toast);

        setTimeout(() => toast.remove(), 4000);
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatType(type) {
        if (!type) return 'Other';
        return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatStatus(status) {
        if (!status) return 'Initiated';
        const statusMap = {
            'initiated': 'Initiated',
            'in-progress': 'In Progress',
            'pending': 'Pending',
            'awaiting': 'Awaiting Approval',
            'approved': 'Approved',
            'rejected': 'Rejected',
            'completed': 'Completed',
            'overdue': 'Overdue'
        };
        return statusMap[status] || status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatDueDate(dateStr) {
        if (!dateStr) return '<span style="color: var(--text-muted);">-</span>';
        const date = new Date(dateStr);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

        if (date < today) {
            return `<span class="date-display overdue">${formattedDate}</span>`;
        }

        const daysUntil = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
        if (daysUntil <= 7) {
            return `<span class="date-display warning">${formattedDate}</span>`;
        }

        return `<span class="date-display">${formattedDate}</span>`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        console.log('üì± Initializing contract search...');

        // Pre-load contracts
        loadContracts().then(() => {
            console.log(' Contracts pre-loaded');
        });

        // Contract search input with debounce
        const contractSearchInput = document.getElementById('contractSearch');
        if (contractSearchInput) {
            contractSearchInput.addEventListener('input', function (e) {
                clearTimeout(contractSearchTimeout);
                contractSearchTimeout = setTimeout(() => {
                    searchContracts(e.target.value);
                }, 300); // 300ms debounce
            });

            // Close suggestions on outside click
            document.addEventListener('click', function (e) {
                const suggestionsDiv = document.getElementById('contractSuggestions');
                if (suggestionsDiv &&
                    !contractSearchInput.contains(e.target) &&
                    !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }
    });
</script>
{% endblock %}