{% extends "base.html" %}
{% block title %}Contract Obligations - CALIM 360{% endblock %}

{% block head %}
<style>
:root {
    --primary: #3b82f6;
    --primary-dark: #2563eb;
    --success: #10b981;
    --success-dark: #059669;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;
    --purple: #8b5cf6;
    --text-dark: #1f2937;
    --text-muted: #6b7280;
    --border: #e5e7eb;
    --bg-light: #f9fafb;
    --bg-card: #ffffff;
}

.page-content {
    padding: 1.5rem;
    max-width: 1400px;
    margin: 0 auto;
}

/* Page Header */
.page-header {
    margin-bottom: 1.5rem;
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.page-title i {
    color: var(--purple);
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--bg-light);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-dark);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
}

.back-btn:hover {
    background: var(--border);
}

/* Contract Info Card */
.contract-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1.25rem;
    color: white;
    margin-bottom: 1.5rem;
}

.contract-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.info-label {
    font-size: 0.75rem;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 0.95rem;
    font-weight: 600;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-ai {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.btn-ai:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover {
    background: var(--success-dark);
}

.btn-info {
    background: var(--info);
    color: white;
}

.btn-info:hover {
    background: #0891b2;
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    background: var(--border);
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Obligations Table */
.obligations-card {
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: hidden;
}

.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.obligation-count {
    background: var(--primary);
    color: white;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
}

.table-container {
    overflow-x: auto;
}

.obligations-table {
    width: 100%;
    border-collapse: collapse;
}

.obligations-table th,
.obligations-table td {
    padding: 0.875rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.obligations-table th {
    background: var(--bg-light);
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
}

.obligations-table tbody tr:hover {
    background: var(--bg-light);
}

.obligation-title {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.obligation-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Status Badge */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-initiated { background: #dbeafe; color: #1d4ed8; }
.status-in-progress { background: #fef3c7; color: #b45309; }
.status-pending { background: #fed7aa; color: #c2410c; }
.status-awaiting { background: #e0e7ff; color: #4338ca; }
.status-approved { background: #d1fae5; color: #047857; }
.status-rejected { background: #fee2e2; color: #b91c1c; }
.status-completed { background: #d1fae5; color: #047857; }
.status-overdue { background: #fee2e2; color: #b91c1c; }

/* Type Badge */
.type-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 500;
    text-transform: uppercase;
}

.type-payment { background: #dcfce7; color: #166534; }
.type-deliverable { background: #dbeafe; color: #1e40af; }
.type-compliance { background: #fef3c7; color: #92400e; }
.type-reporting { background: #e0e7ff; color: #4338ca; }
.type-insurance { background: #fce7f3; color: #be185d; }
.type-performance { background: #cffafe; color: #0e7490; }
.type-other { background: #f3f4f6; color: #4b5563; }

/* User Display */
.user-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.user-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
}

.user-name {
    font-size: 0.85rem;
    color: var(--text-dark);
}

/* Action Buttons in Table */
.table-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.action-btn:hover {
    background: var(--bg-light);
}

.action-btn.edit:hover { color: var(--primary); border-color: var(--primary); }
.action-btn.delete:hover { color: var(--danger); border-color: var(--danger); }

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    margin: 0 0 0.5rem;
    color: var(--text-dark);
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-content.large {
    max-width: 900px;
}

.modal-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header.gradient {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.modal-header.success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.modal-title {
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: inherit;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.modal-close:hover {
    opacity: 1;
}

.modal-body {
    padding: 1.25rem;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

/* Form Styles */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-dark);
    margin-bottom: 0.375rem;
}

.form-label .required {
    color: var(--danger);
}

.form-control {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.875rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

textarea.form-control {
    min-height: 80px;
    resize: vertical;
}

/* User Search */
.user-search-container {
    position: relative;
}

.user-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    display: none;
}

.user-suggestions.active {
    display: block;
}

.user-suggestion-item {
    padding: 0.625rem 0.875rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.2s;
}

.user-suggestion-item:hover {
    background: var(--bg-light);
}

.selected-user {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-light);
    border-radius: 8px;
    margin-top: 0.5rem;
}

.selected-user .remove-user {
    margin-left: auto;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
}

.selected-user .remove-user:hover {
    color: var(--danger);
}

/* AI Obligations List */
.ai-obligations-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.ai-obligation-item {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s;
}

.ai-obligation-item:hover {
    border-color: var(--primary);
}

.ai-obligation-item.selected {
    border-color: var(--success);
    background: rgba(16, 185, 129, 0.05);
}

.ai-obligation-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.ai-obligation-title {
    font-weight: 600;
    color: var(--text-dark);
}

.ai-obligation-desc {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.5;
}

.checkbox-indicator {
    width: 22px;
    height: 22px;
    border: 2px solid var(--border);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
}

.ai-obligation-item.selected .checkbox-indicator {
    background: var(--success);
    border-color: var(--success);
    color: white;
}

/* Preset Tabs */
.preset-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.preset-tab {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: white;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.preset-tab.active {
    background: var(--success);
    border-color: var(--success);
    color: white;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.loading-overlay.active {
    display: flex;
}

.loading-content {
    text-align: center;
}

.loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Toast Notification */
.toast-container {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 3000;
}

.toast {
    padding: 0.875rem 1.25rem;
    border-radius: 8px;
    background: var(--text-dark);
    color: white;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Date Display */
.date-display {
    font-size: 0.85rem;
    color: var(--text-dark);
}

.date-display.overdue {
    color: var(--danger);
    font-weight: 500;
}

.date-display.warning {
    color: var(--warning);
    font-weight: 500;
}

/* Responsive */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .btn {
        justify-content: center;
    }
    
    .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-top">
            <h1 class="page-title">
                <i class="ti ti-checklist"></i>
                Manage Obligations
            </h1>
            <a href="/contracts?module=operations" class="back-btn">
                <i class="ti ti-arrow-left"></i>
                Back to Contracts
            </a>
        </div>
    </div>

    <!-- Contract Info Card -->
    <div class="contract-info-card" id="contractInfoCard">
        <div class="contract-info-grid">
            <div class="info-item">
                <span class="info-label">Contract Number</span>
                <span class="info-value" id="contractNumber">Loading...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Contract Title</span>
                <span class="info-value" id="contractTitle">Loading...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Contract Type</span>
                <span class="info-value" id="contractType">Loading...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Status</span>
                <span class="info-value" id="contractStatus">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn btn-ai" onclick="openAIGenerateModal()" id="generateAIBtn">
            <i class="ti ti-sparkles"></i>
            Generate Obligations (AI)
        </button>
        <button class="btn btn-success" onclick="openNewObligationModal()">
            <i class="ti ti-plus"></i>
            New Obligation
        </button>
        <button class="btn btn-info" onclick="openPresetModal()">
            <i class="ti ti-template"></i>
            Add from Preset
        </button>
        <button class="btn btn-secondary" onclick="refreshObligations()">
            <i class="ti ti-refresh"></i>
            Refresh
        </button>
    </div>

    <!-- Obligations Table -->
    <div class="obligations-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="ti ti-list-check"></i>
                Contract Obligations
                <span class="obligation-count" id="obligationCount">0</span>
            </h2>
        </div>
        <div class="table-container">
            <table class="obligations-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Obligation</th>
                        <th>Type</th>
                        <th>Owner</th>
                        <th>Escalation</th>
                        <th>Status</th>
                        <th>Threshold</th>
                        <th>Due Date</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="obligationsTableBody">
                    <!-- Obligations loaded dynamically -->
                </tbody>
            </table>
        </div>
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="ti ti-clipboard-off"></i>
            <h3>No Obligations Found</h3>
            <p>Generate obligations using AI, add manually, or select from presets.</p>
        </div>
    </div>
</div>

<!-- AI Generate Modal -->
<div class="modal-overlay" id="aiGenerateModal">
    <div class="modal-content large">
        <div class="modal-header gradient">
            <h3 class="modal-title">
                <i class="ti ti-sparkles"></i>
                AI-Generated Obligations
            </h3>
            <button class="modal-close" onclick="closeModal('aiGenerateModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" id="aiModalBody">
            <div class="info-box" style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <p style="margin: 0; color: #1e40af; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-info-circle"></i>
                    Click "Analyze Contract" to extract obligations using AI. Review and select which ones to add.
                </p>
            </div>
            <div id="aiObligationsList" class="ai-obligations-list">
                <!-- AI obligations will be loaded here -->
            </div>
        </div>
        <div class="modal-footer" id="aiModalFooter">
            <button class="btn btn-secondary" onclick="closeModal('aiGenerateModal')">Cancel</button>
            <button class="btn btn-ai" onclick="analyzeContract()" id="analyzeBtn">
                <i class="ti ti-sparkles"></i>
                Analyze Contract
            </button>
            <button class="btn btn-success" onclick="addSelectedAIObligations()" id="addAIBtn" style="display: none;">
                <i class="ti ti-check"></i>
                Add Selected (<span id="selectedCount">0</span>)
            </button>
        </div>
    </div>
</div>

<!-- New Obligation Modal -->
<div class="modal-overlay" id="newObligationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-plus-circle"></i>
                <span id="obligationModalTitle">New Obligation</span>
            </h3>
            <button class="modal-close" onclick="closeModal('newObligationModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="obligationForm">
                <input type="hidden" id="editObligationId">
                
                <div class="form-group">
                    <label class="form-label">Obligation Title <span class="required">*</span></label>
                    <input type="text" class="form-control" id="obligationTitle" required 
                           placeholder="Enter obligation title">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="obligationDescription" 
                              placeholder="Enter detailed description"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Obligation Type <span class="required">*</span></label>
                        <select class="form-control" id="obligationType" required>
                            <option value="">Select Type</option>
                            <option value="payment">Payment</option>
                            <option value="deliverable">Deliverable</option>
                            <option value="compliance">Compliance</option>
                            <option value="reporting">Reporting</option>
                            <option value="insurance">Insurance</option>
                            <option value="performance">Performance</option>
                            <option value="coordination">Coordination</option>
                            <option value="indemnification">Indemnification</option>
                            <option value="timely_completion">Timely Completion</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status <span class="required">*</span></label>
                        <select class="form-control" id="obligationStatus" required>
                            <option value="initiated">Initiated</option>
                            <option value="in-progress">In Progress</option>
                            <option value="pending">Pending Details</option>
                            <option value="awaiting">Awaiting Approval</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Owner</label>
                        <div class="user-search-container">
                            <input type="text" class="form-control" id="ownerSearch" 
                                   placeholder="Search user..." autocomplete="off">
                            <input type="hidden" id="ownerUserId">
                            <div class="user-suggestions" id="ownerSuggestions"></div>
                        </div>
                        <div class="selected-user" id="selectedOwner" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Escalation Contact</label>
                        <div class="user-search-container">
                            <input type="text" class="form-control" id="escalationSearch" 
                                   placeholder="Search user..." autocomplete="off">
                            <input type="hidden" id="escalationUserId">
                            <div class="user-suggestions" id="escalationSuggestions"></div>
                        </div>
                        <div class="selected-user" id="selectedEscalation" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Threshold Date</label>
                        <input type="date" class="form-control" id="thresholdDate">
                        <small style="color: var(--text-muted);">Reminder will be sent on this date</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date <span class="required">*</span></label>
                        <input type="date" class="form-control" id="dueDate" required>
                        <small style="color: var(--text-muted);">Escalation triggered if breached</small>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('newObligationModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveObligation()">
                <i class="ti ti-check"></i>
                Save Obligation
            </button>
        </div>
    </div>
</div>

<!-- Preset Obligations Modal -->
<div class="modal-overlay" id="presetModal">
    <div class="modal-content large">
        <div class="modal-header success">
            <h3 class="modal-title">
                <i class="ti ti-template"></i>
                Preset Obligations
            </h3>
            <button class="modal-close" onclick="closeModal('presetModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="preset-tabs">
                <button class="preset-tab active" onclick="switchPresetTab('client')" data-tab="client">
                    <i class="ti ti-building"></i> Client/Contractor
                </button>
                <button class="preset-tab" onclick="switchPresetTab('subcontractor')" data-tab="subcontractor">
                    <i class="ti ti-users"></i> Sub-Contractor
                </button>
            </div>
            <div id="presetObligationsList" class="ai-obligations-list">
                <!-- Preset obligations loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('presetModal')">Cancel</button>
            <button class="btn btn-success" onclick="addSelectedPresets()" id="addPresetsBtn">
                <i class="ti ti-check"></i>
                Add Selected (<span id="presetSelectedCount">0</span>)
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p id="loadingText">Loading...</p>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

{% endblock %}

{% block extra_js %}
<script>
// =====================================================
// GLOBAL VARIABLES
// =====================================================
const contractId = {{ contract_id }};
const API_BASE = '/api/obligations';
let obligations = [];
let users = [];
let selectedAIObligations = new Set();
let selectedPresets = new Set();
let currentPresetTab = 'client';
let aiGeneratedObligations = [];

// Preset Obligations Data
const presetObligations = {
    client: [
        { id: 'c1', title: 'Payment', description: 'Timely payment for the work completed as per the agreed terms.', type: 'payment' },
        { id: 'c2', title: 'Provision of Information', description: 'Provide necessary information and resources for the subcontractor to complete the work.', type: 'coordination' },
        { id: 'c3', title: 'Coordination', description: 'Facilitate coordination with other Sub-contractors or stakeholders as needed.', type: 'coordination' },
        { id: 'c4', title: 'Support', description: 'Offer reasonable support and assistance to the subcontractor.', type: 'coordination' },
        { id: 'c5', title: 'Inspection and Acceptance', description: 'Conduct inspections of the work and accept it according to the agreement terms.', type: 'compliance' },
        { id: 'c6', title: 'Dispute Resolution', description: 'Establish a process for resolving disputes that may arise (mutual resolution, mediation, Arbitration).', type: 'compliance' },
        { id: 'c7', title: 'Compliance with Contractual Terms', description: 'Ensure that the overall project complies with the terms of the main contract with client.', type: 'compliance' }
    ],
    subcontractor: [
        { id: 's1', title: 'Performance of Work', description: 'Complete the specified work as detailed in the agreement.', type: 'deliverable' },
        { id: 's2', title: 'Adherence to Standards', description: 'Meet industry standards and any specific quality requirements.', type: 'compliance' },
        { id: 's3', title: 'Compliance with Laws', description: 'Follow all applicable laws, regulations, and safety standards.', type: 'compliance' },
        { id: 's4', title: 'Timely Completion', description: 'Deliver work within the agreed timeline and notify of any potential delays.', type: 'timely_completion' },
        { id: 's5', title: 'Reporting', description: 'Provide regular updates on progress and any issues encountered.', type: 'reporting' },
        { id: 's6', title: 'Subcontracting Limits', description: 'Not subcontract further without the primary contractor\'s consent.', type: 'compliance' },
        { id: 's7', title: 'Bonds and Guarantee', description: 'Maintain Bonds and Guarantees as per contractual requirement.', type: 'insurance' },
        { id: 's8', title: 'Insurance', description: 'Maintain appropriate insurance coverage (liability, workers\' compensation, etc.).', type: 'insurance' },
        { id: 's9', title: 'Indemnification', description: 'Hold the primary contractor harmless from any claims arising from the subcontractor\'s work.', type: 'indemnification' },
        { id: 's10', title: 'Payment Terms', description: 'Comply with the agreed payment terms and conditions (milestones, if any).', type: 'payment' },
        { id: 's11', title: 'Confidentiality', description: 'Keep sensitive information confidential as stipulated in the agreement.', type: 'compliance' },
        { id: 's12', title: 'Compliance with Contractual Terms', description: 'Ensure that the overall project complies with the terms of the Agreement.', type: 'compliance' },
        { id: 's13', title: 'Sub-Contractor Responsibility', description: 'Strictly abide with all sub-contractor responsibility as per agreement.', type: 'compliance' }
    ]
};

// =====================================================
// INITIALIZATION
// =====================================================
document.addEventListener('DOMContentLoaded', function() {
    loadContractDetails();
    loadObligations();
    loadUsers();
    setupUserSearch();
});

// =====================================================
// API FUNCTIONS
// =====================================================
async function loadContractDetails() {
    try {
        const response = await fetch(`/api/contracts/${contractId}`);
        if (!response.ok) throw new Error('Failed to load contract');
        const contract = await response.json();
        
        document.getElementById('contractNumber').textContent = contract.contract_number || 'N/A';
        document.getElementById('contractTitle').textContent = contract.contract_title || 'N/A';
        document.getElementById('contractType').textContent = contract.contract_type || 'N/A';
        document.getElementById('contractStatus').textContent = contract.status || 'N/A';
    } catch (error) {
        console.error('Error loading contract:', error);
        showToast('Failed to load contract details', 'error');
    }
}

async function loadObligations() {
    showLoading(true, 'Loading obligations...');
    try {
        const response = await fetch(`${API_BASE}/?contract_id=${contractId}`);
        if (!response.ok) throw new Error('Failed to load obligations');
        
        const data = await response.json();
        obligations = Array.isArray(data) ? data : (data.obligations || []);
        renderObligations();
    } catch (error) {
        console.error('Error loading obligations:', error);
        showToast('Failed to load obligations', 'error');
    } finally {
        showLoading(false);
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/api/users/company');
        if (!response.ok) throw new Error('Failed to load users');
        const data = await response.json();
        users = data.users || [];
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

function refreshObligations() {
    loadObligations();
}

// =====================================================
// RENDER FUNCTIONS
// =====================================================
function renderObligations() {
    const tbody = document.getElementById('obligationsTableBody');
    const emptyState = document.getElementById('emptyState');
    const countEl = document.getElementById('obligationCount');
    
    countEl.textContent = obligations.length;
    
    if (obligations.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        document.querySelector('.table-container').style.display = 'none';
        return;
    }
    
    emptyState.style.display = 'none';
    document.querySelector('.table-container').style.display = 'block';
    
    tbody.innerHTML = obligations.map(obl => `
        <tr data-id="${obl.id}">
            <td>
                <div class="obligation-title">${escapeHtml(obl.obligation_title)}</div>
                <div class="obligation-desc">${escapeHtml(obl.description || '')}</div>
            </td>
            <td>
                <span class="type-badge type-${obl.obligation_type || 'other'}">
                    ${formatType(obl.obligation_type)}
                </span>
            </td>
            <td>${renderUser(obl.owner_user_id, obl.owner_name)}</td>
            <td>${renderUser(obl.escalation_user_id, obl.escalation_name)}</td>
            <td>
                <span class="status-badge status-${obl.status || 'initiated'}">
                    ${formatStatus(obl.status)}
                </span>
            </td>
            <td>${formatDate(obl.threshold_date)}</td>
            <td>${formatDueDate(obl.due_date)}</td>
            <td>
                <div class="table-actions">
                    <button class="action-btn edit" onclick="editObligation(${obl.id})" title="Edit">
                        <i class="ti ti-pencil"></i>
                    </button>
                    <button class="action-btn delete" onclick="deleteObligation(${obl.id})" title="Delete">
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function renderUser(userId, userName) {
    if (!userId && !userName) return '<span style="color: var(--text-muted);">Not assigned</span>';
    
    const name = userName || 'Unknown';
    const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    
    return `
        <div class="user-display">
            <div class="user-avatar">${initials}</div>
            <span class="user-name">${escapeHtml(name)}</span>
        </div>
    `;
}

// =====================================================
// MODAL FUNCTIONS
// =====================================================
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function openNewObligationModal() {
    document.getElementById('obligationModalTitle').textContent = 'New Obligation';
    document.getElementById('obligationForm').reset();
    document.getElementById('editObligationId').value = '';
    document.getElementById('ownerUserId').value = '';
    document.getElementById('escalationUserId').value = '';
    document.getElementById('selectedOwner').style.display = 'none';
    document.getElementById('selectedEscalation').style.display = 'none';
    document.getElementById('ownerSearch').style.display = 'block';
    document.getElementById('escalationSearch').style.display = 'block';
    openModal('newObligationModal');
}

function editObligation(id) {
    const obl = obligations.find(o => o.id === id);
    if (!obl) return;
    
    document.getElementById('obligationModalTitle').textContent = 'Edit Obligation';
    document.getElementById('editObligationId').value = id;
    document.getElementById('obligationTitle').value = obl.obligation_title || '';
    document.getElementById('obligationDescription').value = obl.description || '';
    document.getElementById('obligationType').value = obl.obligation_type || '';
    document.getElementById('obligationStatus').value = obl.status || 'initiated';
    document.getElementById('thresholdDate').value = obl.threshold_date ? obl.threshold_date.split('T')[0] : '';
    document.getElementById('dueDate').value = obl.due_date ? obl.due_date.split('T')[0] : '';
    
    // Set owner
    if (obl.owner_user_id) {
        document.getElementById('ownerUserId').value = obl.owner_user_id;
        setSelectedUser('owner', obl.owner_user_id, obl.owner_name);
    } else {
        document.getElementById('ownerUserId').value = '';
        document.getElementById('selectedOwner').style.display = 'none';
        document.getElementById('ownerSearch').style.display = 'block';
    }
    
    // Set escalation
    if (obl.escalation_user_id) {
        document.getElementById('escalationUserId').value = obl.escalation_user_id;
        setSelectedUser('escalation', obl.escalation_user_id, obl.escalation_name);
    } else {
        document.getElementById('escalationUserId').value = '';
        document.getElementById('selectedEscalation').style.display = 'none';
        document.getElementById('escalationSearch').style.display = 'block';
    }
    
    openModal('newObligationModal');
}

async function saveObligation() {
    const form = document.getElementById('obligationForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const editId = document.getElementById('editObligationId').value;
    const isEdit = !!editId;
    
    const payload = {
        contract_id: contractId,
        obligation_title: document.getElementById('obligationTitle').value.trim(),
        description: document.getElementById('obligationDescription').value.trim(),
        obligation_type: document.getElementById('obligationType').value,
        status: document.getElementById('obligationStatus').value,
        owner_user_id: document.getElementById('ownerUserId').value || null,
        escalation_user_id: document.getElementById('escalationUserId').value || null,
        threshold_date: document.getElementById('thresholdDate').value || null,
        due_date: document.getElementById('dueDate').value || null
    };
    
    showLoading(true, isEdit ? 'Updating obligation...' : 'Creating obligation...');
    
    try {
        const url = isEdit ? `${API_BASE}/${editId}` : `${API_BASE}/`;
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to save obligation');
        }
        
        showToast(isEdit ? 'Obligation updated successfully' : 'Obligation created successfully', 'success');
        closeModal('newObligationModal');
        loadObligations();
    } catch (error) {
        console.error('Error saving obligation:', error);
        showToast(error.message || 'Failed to save obligation', 'error');
    } finally {
        showLoading(false);
    }
}

async function deleteObligation(id) {
    if (!confirm('Are you sure you want to delete this obligation?')) return;
    
    showLoading(true, 'Deleting obligation...');
    
    try {
        const response = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete obligation');
        }
        
        showToast('Obligation deleted successfully', 'success');
        loadObligations();
    } catch (error) {
        console.error('Error deleting obligation:', error);
        showToast(error.message || 'Failed to delete obligation', 'error');
    } finally {
        showLoading(false);
    }
}

// =====================================================
// AI GENERATION
// =====================================================
function openAIGenerateModal() {
    selectedAIObligations.clear();
    aiGeneratedObligations = [];
    document.getElementById('aiObligationsList').innerHTML = `
        <div class="empty-state" style="padding: 2rem;">
            <i class="ti ti-robot"></i>
            <h3>AI Analysis Ready</h3>
            <p>Click "Analyze Contract" to extract obligations from the contract content using AI.</p>
        </div>
    `;
    document.getElementById('analyzeBtn').style.display = 'inline-flex';
    document.getElementById('addAIBtn').style.display = 'none';
    openModal('aiGenerateModal');
}

async function analyzeContract() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> Analyzing...';
    
    document.getElementById('aiObligationsList').innerHTML = `
        <div style="text-align: center; padding: 3rem;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem; color: var(--text-muted);">Analyzing contract and extracting obligations...</p>
        </div>
    `;
    
    try {
        const response = await fetch(`${API_BASE}/generate-ai/${contractId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to generate obligations');
        }
        
        const data = await response.json();
        aiGeneratedObligations = Array.isArray(data) ? data : (data.obligations || []);
        
        if (aiGeneratedObligations.length === 0) {
            document.getElementById('aiObligationsList').innerHTML = `
                <div class="empty-state" style="padding: 2rem;">
                    <i class="ti ti-file-search"></i>
                    <h3>No Obligations Found</h3>
                    <p>AI could not extract obligations from this contract. Try adding manually.</p>
                </div>
            `;
        } else {
            renderAIObligations();
        }
        
        analyzeBtn.style.display = 'none';
        document.getElementById('addAIBtn').style.display = aiGeneratedObligations.length > 0 ? 'inline-flex' : 'none';
    } catch (error) {
        console.error('Error generating AI obligations:', error);
        document.getElementById('aiObligationsList').innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="ti ti-alert-triangle" style="color: var(--danger);"></i>
                <h3>Analysis Failed</h3>
                <p>${escapeHtml(error.message)}</p>
            </div>
        `;
        showToast(error.message || 'Failed to analyze contract', 'error');
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="ti ti-sparkles"></i> Analyze Contract';
    }
}

function renderAIObligations() {
    const container = document.getElementById('aiObligationsList');
    
    container.innerHTML = aiGeneratedObligations.map((obl, index) => `
        <div class="ai-obligation-item ${selectedAIObligations.has(index) ? 'selected' : ''}" 
             onclick="toggleAISelection(${index})" data-index="${index}">
            <div class="ai-obligation-header">
                <span class="ai-obligation-title">${escapeHtml(obl.title)}</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="type-badge type-${obl.type || 'other'}">${formatType(obl.type)}</span>
                    <div class="checkbox-indicator">
                        ${selectedAIObligations.has(index) ? '<i class="ti ti-check"></i>' : ''}
                    </div>
                </div>
            </div>
            <p class="ai-obligation-desc">${escapeHtml(obl.description)}</p>
        </div>
    `).join('');
    
    updateSelectedCount();
}

function toggleAISelection(index) {
    if (selectedAIObligations.has(index)) {
        selectedAIObligations.delete(index);
    } else {
        selectedAIObligations.add(index);
    }
    renderAIObligations();
}

function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedAIObligations.size;
}

async function addSelectedAIObligations() {
    if (selectedAIObligations.size === 0) {
        showToast('Please select at least one obligation', 'warning');
        return;
    }
    
    showLoading(true, `Adding ${selectedAIObligations.size} obligation(s)...`);
    
    try {
        const promises = Array.from(selectedAIObligations).map(index => {
            const obl = aiGeneratedObligations[index];
            return fetch(`${API_BASE}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId,
                    obligation_title: obl.title,
                    description: obl.description,
                    obligation_type: obl.type || 'other',
                    status: 'initiated',
                    is_ai_generated: true
                })
            });
        });
        
        const results = await Promise.all(promises);
        const failed = results.filter(r => !r.ok);
        
        if (failed.length > 0) {
            throw new Error(`Failed to add ${failed.length} obligation(s)`);
        }
        
        showToast(`Successfully added ${selectedAIObligations.size} obligation(s)`, 'success');
        closeModal('aiGenerateModal');
        loadObligations();
    } catch (error) {
        console.error('Error adding AI obligations:', error);
        showToast(error.message || 'Failed to add obligations', 'error');
    } finally {
        showLoading(false);
    }
}

// =====================================================
// PRESET OBLIGATIONS
// =====================================================
function openPresetModal() {
    selectedPresets.clear();
    currentPresetTab = 'client';
    updatePresetTabs();
    renderPresetObligations();
    openModal('presetModal');
}

function switchPresetTab(tab) {
    currentPresetTab = tab;
    selectedPresets.clear();
    updatePresetTabs();
    renderPresetObligations();
}

function updatePresetTabs() {
    document.querySelectorAll('.preset-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === currentPresetTab);
    });
}

function renderPresetObligations() {
    const container = document.getElementById('presetObligationsList');
    const presets = presetObligations[currentPresetTab] || [];
    
    container.innerHTML = presets.map(obl => `
        <div class="ai-obligation-item ${selectedPresets.has(obl.id) ? 'selected' : ''}" 
             onclick="togglePresetSelection('${obl.id}')" data-id="${obl.id}">
            <div class="ai-obligation-header">
                <span class="ai-obligation-title">${escapeHtml(obl.title)}</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="type-badge type-${obl.type || 'other'}">${formatType(obl.type)}</span>
                    <div class="checkbox-indicator">
                        ${selectedPresets.has(obl.id) ? '<i class="ti ti-check"></i>' : ''}
                    </div>
                </div>
            </div>
            <p class="ai-obligation-desc">${escapeHtml(obl.description)}</p>
        </div>
    `).join('');
    
    updatePresetSelectedCount();
}

function togglePresetSelection(id) {
    if (selectedPresets.has(id)) {
        selectedPresets.delete(id);
    } else {
        selectedPresets.add(id);
    }
    renderPresetObligations();
}

function updatePresetSelectedCount() {
    document.getElementById('presetSelectedCount').textContent = selectedPresets.size;
}

async function addSelectedPresets() {
    if (selectedPresets.size === 0) {
        showToast('Please select at least one preset', 'warning');
        return;
    }
    
    showLoading(true, `Adding ${selectedPresets.size} preset(s)...`);
    
    try {
        const allPresets = [...presetObligations.client, ...presetObligations.subcontractor];
        
        const promises = Array.from(selectedPresets).map(id => {
            const obl = allPresets.find(p => p.id === id);
            if (!obl) return Promise.resolve({ ok: true });
            
            return fetch(`${API_BASE}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId,
                    obligation_title: obl.title,
                    description: obl.description,
                    obligation_type: obl.type || 'other',
                    status: 'initiated',
                    is_ai_generated: false
                })
            });
        });
        
        const results = await Promise.all(promises);
        const failed = results.filter(r => !r.ok);
        
        if (failed.length > 0) {
            throw new Error(`Failed to add ${failed.length} preset(s)`);
        }
        
        showToast(`Successfully added ${selectedPresets.size} preset(s)`, 'success');
        closeModal('presetModal');
        loadObligations();
    } catch (error) {
        console.error('Error adding presets:', error);
        showToast(error.message || 'Failed to add presets', 'error');
    } finally {
        showLoading(false);
    }
}

// =====================================================
// USER SEARCH
// =====================================================
function setupUserSearch() {
    const ownerSearch = document.getElementById('ownerSearch');
    const escalationSearch = document.getElementById('escalationSearch');
    
    ownerSearch.addEventListener('input', () => searchUsers('owner', ownerSearch.value));
    escalationSearch.addEventListener('input', () => searchUsers('escalation', escalationSearch.value));
    
    ownerSearch.addEventListener('focus', () => searchUsers('owner', ownerSearch.value));
    escalationSearch.addEventListener('focus', () => searchUsers('escalation', escalationSearch.value));
    
    // Close suggestions on click outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.user-search-container')) {
            document.querySelectorAll('.user-suggestions').forEach(el => el.classList.remove('active'));
        }
    });
}

function searchUsers(type, query) {
    const suggestionsEl = document.getElementById(`${type}Suggestions`);
    
    if (query.length < 1) {
        suggestionsEl.classList.remove('active');
        return;
    }
    
    const filtered = users.filter(u => {
        const fullName = `${u.first_name} ${u.last_name}`.toLowerCase();
        const email = (u.email || '').toLowerCase();
        const q = query.toLowerCase();
        return fullName.includes(q) || email.includes(q);
    }).slice(0, 5);
    
    if (filtered.length === 0) {
        suggestionsEl.innerHTML = '<div class="user-suggestion-item" style="color: var(--text-muted);">No users found</div>';
    } else {
        suggestionsEl.innerHTML = filtered.map(u => `
            <div class="user-suggestion-item" onclick="selectUser('${type}', ${u.id}, '${escapeHtml(u.first_name)} ${escapeHtml(u.last_name)}')">
                <div class="user-avatar">${u.first_name[0]}${u.last_name[0]}</div>
                <div>
                    <div style="font-weight: 500;">${escapeHtml(u.first_name)} ${escapeHtml(u.last_name)}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${escapeHtml(u.email)}</div>
                </div>
            </div>
        `).join('');
    }
    
    suggestionsEl.classList.add('active');
}

function selectUser(type, userId, userName) {
    document.getElementById(`${type}UserId`).value = userId;
    document.getElementById(`${type}Search`).style.display = 'none';
    document.getElementById(`${type}Suggestions`).classList.remove('active');
    setSelectedUser(type, userId, userName);
}

function setSelectedUser(type, userId, userName) {
    const selectedEl = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}`);
    const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    
    selectedEl.innerHTML = `
        <div class="user-avatar">${initials}</div>
        <span>${escapeHtml(userName)}</span>
        <button class="remove-user" onclick="removeUser('${type}')">
            <i class="ti ti-x"></i>
        </button>
    `;
    selectedEl.style.display = 'flex';
}

function removeUser(type) {
    document.getElementById(`${type}UserId`).value = '';
    document.getElementById(`${type}Search`).value = '';
    document.getElementById(`${type}Search`).style.display = 'block';
    document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}`).style.display = 'none';
}

// =====================================================
// UTILITY FUNCTIONS
// =====================================================
function showLoading(show, text = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingText').textContent = text;
    overlay.classList.toggle('active', show);
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="ti ti-${type === 'success' ? 'check' : type === 'error' ? 'x' : 'info-circle'}"></i>
        ${escapeHtml(message)}
    `;
    container.appendChild(toast);
    
    setTimeout(() => toast.remove(), 4000);
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function formatType(type) {
    if (!type) return 'Other';
    return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatStatus(status) {
    if (!status) return 'Initiated';
    const statusMap = {
        'initiated': 'Initiated',
        'in-progress': 'In Progress',
        'pending': 'Pending',
        'awaiting': 'Awaiting Approval',
        'approved': 'Approved',
        'rejected': 'Rejected',
        'completed': 'Completed',
        'overdue': 'Overdue'
    };
    return statusMap[status] || status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatDate(dateStr) {
    if (!dateStr) return '<span style="color: var(--text-muted);">-</span>';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
}

function formatDueDate(dateStr) {
    if (!dateStr) return '<span style="color: var(--text-muted);">-</span>';
    const date = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    
    if (date < today) {
        return `<span class="date-display overdue">${formattedDate}</span>`;
    }
    
    const daysUntil = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
    if (daysUntil <= 7) {
        return `<span class="date-display warning">${formattedDate}</span>`;
    }
    
    return `<span class="date-display">${formattedDate}</span>`;
}
</script>
{% endblock %}