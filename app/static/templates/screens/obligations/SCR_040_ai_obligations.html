{% extends "base.html" %}

{% block title %}AI Obligations - Contract {{ contract_id }}{% endblock %}

{% block head %}
<style>
    :root {
        --primary-color: #2762cb;
        --secondary-color: #73B4E0;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #3b82f6;
        --text-color: #1e293b;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --background-light: #f8fafc;
        --transition: all 0.2s ease;
    }

    .page-content {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Header */
    .page-header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .page-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-color);
    }

    .page-title i {
        color: var(--primary-color);
    }

    .contract-info {
        display: flex;
        gap: 2rem;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
        font-size: 0.9rem;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-ai {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-ai:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-success:hover:not(:disabled) {
        background: #059669;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover:not(:disabled) {
        background: #4b5563;
    }

    /* AI Obligations Grid */
    .obligations-grid {
        display: grid;
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .obligation-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 2px solid var(--border-color);
        transition: var(--transition);
        cursor: pointer;
        position: relative;
    }

    .obligation-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.1);
    }

    .obligation-card.selected {
        border-color: var(--primary-color);
        background: #f0f6ff;
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.15);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        flex: 1;
    }

    .card-badges {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-priority {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-priority.high {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-priority.medium {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-priority.low {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-confidence {
        background: #d1fae5;
        color: #065f46;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .card-description {
        color: var(--text-muted);
        margin-bottom: 1rem;
        line-height: 1.6;
    }

    .card-meta {
        display: flex;
        gap: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .edit-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: white;
        border: 1px solid var(--border-color);
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
        transition: var(--transition);
    }

    .edit-btn:hover {
        background: var(--background-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 900px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1.5rem 2rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-color);
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: var(--transition);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    /* User Search */
    .user-search-container {
        position: relative;
    }

    .user-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-top: 0.25rem;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 100;
        display: none;
    }

    .user-suggestions.show {
        display: block;
    }

    .user-suggestion-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: var(--transition);
        border-bottom: 1px solid var(--border-color);
    }

    .user-suggestion-item:last-child {
        border-bottom: none;
    }

    .user-suggestion-item:hover {
        background: var(--background-light);
    }

    .user-name {
        font-weight: 500;
        color: var(--text-color);
    }

    .user-email {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .selected-user {
        background: var(--background-light);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .remove-user {
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        font-size: 1.2rem;
    }

    /* Loading */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .info-box {
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-left: 4px solid var(--info-color);
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: start;
        gap: 1rem;
    }

    .info-box i {
        color: var(--info-color);
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    /* Summary Section */
    .summary-section {
        background: var(--background-light);
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin-top: 1.5rem;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .summary-label {
        font-weight: 600;
        color: var(--text-color);
    }

    .summary-value {
        color: var(--primary-color);
        font-weight: 600;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    /* Toast */
    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none;
        align-items: center;
        gap: 1rem;
        z-index: 10000;
        min-width: 300px;
    }

    .toast.show {
        display: flex;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .toast-icon {
        font-size: 1.5rem;
    }

    .toast.success .toast-icon {
        color: var(--success-color);
    }

    .toast.error .toast-icon {
        color: var(--danger-color);
    }

    /* Table Styles */
    table {
        font-size: 0.9rem;
    }

    table th {
        white-space: nowrap;
    }

    table tr:hover {
        background: var(--background-light);
    }

    table button {
        margin: 0 0.25rem;
    }

    table button:hover {
        transform: translateY(-1px);
    }

    /* Preset Tabs */
    .preset-tab {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-muted);
        transition: var(--transition);
        white-space: nowrap;
    }

    .preset-tab:hover {
        color: var(--text-color);
        background: var(--background-light);
    }

    .preset-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .preset-obligation-item {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .preset-obligation-item:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(39, 98, 203, 0.1);
    }

    .preset-obligation-item.selected {
        border-color: var(--success-color);
        background: #f0fdf4;
    }

    .preset-check {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        transition: var(--transition);
    }

    .preset-obligation-item.selected .preset-check {
        background: var(--success-color);
        border-color: var(--success-color);
    }

    .btn-info {
        background: var(--info-color);
        color: white;
    }

    .btn-info:hover:not(:disabled) {
        background: #2563eb;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-content">
    <!-- Header -->
    <div class="page-header">
        <div class="header-top">
            <h1 class="page-title">
                <i class="ti ti-sparkles"></i>
                AI Obligations Generation
            </h1>
        </div>
        <div class="contract-info" id="contractInfo">
            <div class="info-item">
                <i class="ti ti-file-text"></i>
                <span>Loading contract details...</span>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn btn-ai" onclick="generateAIObligations()" id="generateBtn">
            <i class="ti ti-sparkles"></i>
            Generate Obligations (AI)
        </button>
        <button class="btn btn-success" onclick="openNewObligationModal()" id="newObligationBtn">
            <i class="ti ti-plus"></i>
            New Obligation
        </button>
        <button class="btn btn-info" onclick="openPresetModal()" id="presetBtn">
            <i class="ti ti-template"></i>
            Add from Preset
        </button>
        <button class="btn btn-success" onclick="addSelectedObligations()" id="addBtn" style="display: none;">
            <i class="ti ti-check"></i>
            Add Selected to Database
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='/obligations'">
            <i class="ti ti-arrow-left"></i>
            Back to Dashboard
        </button>
    </div>

    <!-- Existing Obligations Section -->
    <div id="existingObligationsSection" style="display: none;">
        <div style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="ti ti-list-check"></i>
                Existing Obligations
            </h3>
            <div id="existingObligationsList"></div>
        </div>
    </div>

    <!-- Obligations Grid -->
    <div id="obligationsContainer">
        <div class="empty-state">
            <i class="ti ti-file-search"></i>
            <h3>No obligations generated yet</h3>
            <p>Click "Generate Obligations (AI)" to analyze the contract and extract obligations automatically.</p>
        </div>
    </div>
</div>

<!-- AI Obligations Modal -->
<div class="modal" id="aiObligationsModal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header" style="position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
            <h3 class="modal-title" style="color: white;">
                <i class="ti ti-sparkles"></i>
                AI-Generated Obligations
            </h3>
            <button class="modal-close" style="color: white; border-color: rgba(255,255,255,0.3);" onclick="closeAIModal()">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div class="info-box">
                <i class="ti ti-info-circle"></i>
                <div>
                    <strong>Review AI-Generated Obligations</strong>
                    <p style="margin: 0.5rem 0 0 0; color: var(--text-muted);">
                        Click on cards to select/deselect. Click the edit icon to assign owners, set dates, or modify details.
                    </p>
                </div>
            </div>
            
            <div id="aiObligationsGrid"></div>
            
            <div class="summary-section">
                <div class="summary-row">
                    <span class="summary-label">Selected Obligations:</span>
                    <span class="summary-value" id="aiSelectedCount">0 / 0</span>
                </div>
                <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
                    Click "Add Selected to Database" to save selected obligations.
                </div>
            </div>
        </div>
        <div class="modal-footer" style="position: sticky; bottom: 0; background: white; border-top: 1px solid var(--border-color);">
            <button class="btn btn-secondary" onclick="closeAIModal()">
                <i class="ti ti-x"></i> Cancel
            </button>
            <button class="btn btn-success" onclick="addSelectedAIObligations()">
                <i class="ti ti-check"></i> Add Selected to Database
            </button>
        </div>
    </div>
</div>

<!-- Edit Obligation Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header" style="position: sticky; top: 0; z-index: 10;">
            <h3 class="modal-title">
                <i class="ti ti-edit"></i>
                Edit Obligation
            </h3>
            <button class="modal-close" onclick="closeEditModal()">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="editForm" onsubmit="saveObligationEdit(event)">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="editTitle" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="editDescription" rows="3" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-control" id="editCategory">
                            <option value="payment">Payment</option>
                            <option value="delivery">Delivery</option>
                            <option value="compliance">Compliance</option>
                            <option value="reporting">Reporting</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="insurance">Insurance</option>
                            <option value="coordination">Coordination</option>
                            <option value="inspection">Inspection</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-control" id="editPriority">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Owner (Search by Email)</label>
                    <div class="user-search-container">
                        <input type="text" 
                               class="form-control" 
                               id="ownerSearch" 
                               placeholder="Type email to search users..."
                               oninput="searchUsers('owner')"
                               autocomplete="off">
                        <div class="user-suggestions" id="ownerSuggestions"></div>
                    </div>
                    <div id="selectedOwner" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Escalation To (Search by Email)</label>
                    <div class="user-search-container">
                        <input type="text" 
                               class="form-control" 
                               id="escalationSearch" 
                               placeholder="Type email to search users..."
                               oninput="searchUsers('escalation')"
                               autocomplete="off">
                        <div class="user-suggestions" id="escalationSuggestions"></div>
                    </div>
                    <div id="selectedEscalation" style="display: none;"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Threshold Date</label>
                        <input type="date" class="form-control" id="editThresholdDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="editDueDate">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Source Clause</label>
                    <input type="text" class="form-control" id="editClause" disabled>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        <i class="ti ti-x"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="ti ti-check"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Obligation Modal -->
<div class="modal" id="newObligationModal">
    <div class="modal-content">
        <div class="modal-header" style="position: sticky; top: 0; z-index: 10;">
            <h3 class="modal-title">
                <i class="ti ti-plus"></i>
                Create New Obligation
            </h3>
            <button class="modal-close" onclick="closeNewObligationModal()">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="newObligationForm" onsubmit="saveNewObligation(event)">
                <div class="form-group">
                    <label class="form-label">Title <span style="color: var(--danger-color);">*</span></label>
                    <input type="text" class="form-control" id="newTitle" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="newDescription" rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-control" id="newCategory">
                            <option value="payment">Payment</option>
                            <option value="delivery">Delivery</option>
                            <option value="compliance">Compliance</option>
                            <option value="reporting">Reporting</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="insurance">Insurance</option>
                            <option value="coordination">Coordination</option>
                            <option value="inspection">Inspection</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="newStatus">
                            <option value="initiated">Initiated</option>
                            <option value="in_progress">In Progress</option>
                            <option value="pending_details">Pending Details</option>
                            <option value="awaiting_approval">Awaiting Approval</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Owner (Search by Email)</label>
                    <div class="user-search-container">
                        <input type="text" 
                               class="form-control" 
                               id="newOwnerSearch" 
                               placeholder="Type email to search users..."
                               oninput="searchUsersNew('owner')"
                               autocomplete="off">
                        <div class="user-suggestions" id="newOwnerSuggestions"></div>
                    </div>
                    <div id="newSelectedOwner" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Escalation To (Search by Email)</label>
                    <div class="user-search-container">
                        <input type="text" 
                               class="form-control" 
                               id="newEscalationSearch" 
                               placeholder="Type email to search users..."
                               oninput="searchUsersNew('escalation')"
                               autocomplete="off">
                        <div class="user-suggestions" id="newEscalationSuggestions"></div>
                    </div>
                    <div id="newSelectedEscalation" style="display: none;"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Threshold Date</label>
                        <input type="date" class="form-control" id="newThresholdDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date <span style="color: var(--danger-color);">*</span></label>
                        <input type="date" class="form-control" id="newDueDate" required>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNewObligationModal()">
                        <i class="ti ti-x"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="ti ti-check"></i> Create Obligation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preset Obligations Modal -->
<div class="modal" id="presetModal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header" style="position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #10b981, #059669); color: white;">
            <h3 class="modal-title" style="color: white;">
                <i class="ti ti-template"></i>
                Preset Obligations Templates
            </h3>
            <button class="modal-close" style="color: white; border-color: rgba(255,255,255,0.3);" onclick="closePresetModal()">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div class="info-box" style="margin-bottom: 1.5rem;">
                <i class="ti ti-info-circle"></i>
                <div>
                    <strong>Select Preset Obligations</strong>
                    <p style="margin: 0.5rem 0 0 0; color: var(--text-muted);">
                        These are common obligations based on your contract type. Select the ones you need and they'll be added to your contract.
                    </p>
                </div>
            </div>

            <!-- Profile Type Tabs -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); overflow-x: auto;">
                <button class="preset-tab active" data-profile="client" onclick="switchPresetProfile('client')">
                    Client
                </button>
                <button class="preset-tab" data-profile="consultant" onclick="switchPresetProfile('consultant')">
                    Consultant
                </button>
                <button class="preset-tab" data-profile="contractor" onclick="switchPresetProfile('contractor')">
                    Contractor
                </button>
                <button class="preset-tab" data-profile="sub_contractor" onclick="switchPresetProfile('sub_contractor')">
                    Sub-Contractor
                </button>
            </div>

            <!-- Preset Obligations List -->
            <div id="presetObligationsList" style="max-height: 400px; overflow-y: auto;">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="modal-footer">
                <div style="flex: 1;">
                    <span id="presetSelectedCount" style="font-weight: 600; color: var(--primary-color);">0 selected</span>
                </div>
                <button class="btn btn-secondary" onclick="closePresetModal()">
                    <i class="ti ti-x"></i> Cancel
                </button>
                <button class="btn btn-success" onclick="addPresetObligations()">
                    <i class="ti ti-check"></i> Add Selected Presets
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <i class="toast-icon ti ti-check-circle"></i>
    <div class="toast-message" id="toastMessage">Success!</div>
</div>

<script>
// =====================================================
// GLOBAL VARIABLES
// =====================================================
const contractId = {{ contract_id }};
let aiObligations = [];
let selectedObligations = new Set();
let currentEditIndex = null;
let selectedOwner = null;
let selectedEscalation = null;
let newSelectedOwner = null;
let newSelectedEscalation = null;
let searchTimeout = null;
let existingObligations = [];
let currentPresetProfile = 'client';
let selectedPresets = new Set();

// Preset Obligations Templates
const presetObligations = {
    client: [
        {
            id: 'client_1',
            title: 'Payment',
            description: 'Timely payment for the work completed as per the agreed terms.',
            category: 'payment',
            priority: 'high'
        },
        {
            id: 'client_2',
            title: 'Provision of Information',
            description: 'Provide necessary information and resources for the contractor to complete the work.',
            category: 'coordination',
            priority: 'medium'
        },
        {
            id: 'client_3',
            title: 'Coordination',
            description: 'Facilitate coordination with other contractors or stakeholders as needed.',
            category: 'coordination',
            priority: 'medium'
        },
        {
            id: 'client_4',
            title: 'Inspection and Acceptance',
            description: 'Conduct inspections of the work and accept it according to the agreement terms.',
            category: 'inspection',
            priority: 'high'
        },
        {
            id: 'client_5',
            title: 'Access to Site',
            description: 'Provide timely access to work site and necessary facilities.',
            category: 'coordination',
            priority: 'high'
        }
    ],
    consultant: [
        {
            id: 'consultant_1',
            title: 'Professional Services Delivery',
            description: 'Deliver professional consulting services as per the scope of work.',
            category: 'delivery',
            priority: 'high'
        },
        {
            id: 'consultant_2',
            title: 'Progress Reporting',
            description: 'Submit regular progress reports and updates to the client.',
            category: 'reporting',
            priority: 'medium'
        },
        {
            id: 'consultant_3',
            title: 'Professional Indemnity Insurance',
            description: 'Maintain adequate professional indemnity insurance coverage.',
            category: 'insurance',
            priority: 'high'
        },
        {
            id: 'consultant_4',
            title: 'Quality Assurance',
            description: 'Ensure all deliverables meet agreed quality standards.',
            category: 'compliance',
            priority: 'high'
        },
        {
            id: 'consultant_5',
            title: 'Confidentiality',
            description: 'Maintain confidentiality of client information and project details.',
            category: 'compliance',
            priority: 'high'
        }
    ],
    contractor: [
        {
            id: 'contractor_1',
            title: 'Performance of Work',
            description: 'Complete the specified work as detailed in the agreement.',
            category: 'delivery',
            priority: 'high'
        },
        {
            id: 'contractor_2',
            title: 'Adherence to Standards',
            description: 'Meet industry standards and any specific quality requirements.',
            category: 'compliance',
            priority: 'high'
        },
        {
            id: 'contractor_3',
            title: 'Compliance with Laws',
            description: 'Follow all applicable laws, regulations, and safety standards.',
            category: 'compliance',
            priority: 'high'
        },
        {
            id: 'contractor_4',
            title: 'Timely Completion',
            description: 'Deliver work within the agreed timeline and notify of any potential delays.',
            category: 'delivery',
            priority: 'high'
        },
        {
            id: 'contractor_5',
            title: 'Progress Reporting',
            description: 'Provide regular updates on progress and any issues encountered.',
            category: 'reporting',
            priority: 'medium'
        },
        {
            id: 'contractor_6',
            title: 'Insurance Coverage',
            description: 'Maintain appropriate insurance coverage (liability, workers compensation, etc.).',
            category: 'insurance',
            priority: 'high'
        },
        {
            id: 'contractor_7',
            title: 'Performance Bond',
            description: 'Provide and maintain performance bond as per contractual requirements.',
            category: 'insurance',
            priority: 'high'
        }
    ],
    sub_contractor: [
        {
            id: 'sub_1',
            title: 'Performance of Work',
            description: 'Complete the specified work as detailed in the agreement.',
            category: 'delivery',
            priority: 'high'
        },
        {
            id: 'sub_2',
            title: 'Adherence to Standards',
            description: 'Meet industry standards and any specific quality requirements.',
            category: 'compliance',
            priority: 'high'
        },
        {
            id: 'sub_3',
            title: 'Compliance with Laws',
            description: 'Follow all applicable laws, regulations, and safety standards.',
            category: 'compliance',
            priority: 'high'
        },
        {
            id: 'sub_4',
            title: 'Timely Completion',
            description: 'Deliver work within the agreed timeline and notify of any potential delays.',
            category: 'delivery',
            priority: 'high'
        },
        {
            id: 'sub_5',
            title: 'Reporting',
            description: 'Provide regular updates on progress and any issues encountered.',
            category: 'reporting',
            priority: 'medium'
        },
        {
            id: 'sub_6',
            title: 'Subcontracting Limits',
            description: 'Not subcontract further without the primary contractor\'s consent.',
            category: 'compliance',
            priority: 'high'
        },
        {
            id: 'sub_7',
            title: 'Insurance',
            description: 'Maintain appropriate insurance coverage (liability, workers\' compensation, etc.).',
            category: 'insurance',
            priority: 'high'
        },
        {
            id: 'sub_8',
            title: 'Indemnification',
            description: 'Hold the primary contractor harmless from any claims arising from the subcontractor\'s work.',
            category: 'compliance',
            priority: 'high'
        },
        {
            id: 'sub_9',
            title: 'Payment Terms',
            description: 'Comply with the agreed payment terms and conditions.',
            category: 'payment',
            priority: 'high'
        },
        {
            id: 'sub_10',
            title: 'Compliance with Contractual Terms',
            description: 'Ensure that the overall project complies with the terms of the main contract with client in back to back basis.',
            category: 'compliance',
            priority: 'high'
        }
    ]
};

// =====================================================
// INITIALIZATION
// =====================================================
document.addEventListener('DOMContentLoaded', function() {
    loadContractDetails();
    loadExistingObligations();
});

// =====================================================
// CONTRACT DETAILS
// =====================================================
async function loadContractDetails() {
    try {
        const response = await fetch(`/api/contracts/${contractId}`, {
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('Failed to load contract');

        const data = await response.json();
        const contract = data.data || data;

        document.getElementById('contractInfo').innerHTML = `
            <div class="info-item">
                <i class="ti ti-file-text"></i>
                <span><strong>${contract.contract_number}</strong></span>
            </div>
            <div class="info-item">
                <i class="ti ti-tag"></i>
                <span>${contract.contract_title}</span>
            </div>
            <div class="info-item">
                <i class="ti ti-category"></i>
                <span>${contract.contract_type || 'N/A'}</span>
            </div>
        `;
    } catch (error) {
        console.error('Error loading contract:', error);
        showToast('Failed to load contract details', 'error');
    }
}

// =====================================================
// AI GENERATION
// =====================================================
async function generateAIObligations() {
    const btn = document.getElementById('generateBtn');
    const originalHTML = btn.innerHTML;
    
    try {
        // Show loading
        showLoading(true);
        btn.disabled = true;
        btn.innerHTML = '<i class="ti ti-loader" style="animation: spin 0.8s linear infinite;"></i> Analyzing Contract...';

        const response = await fetch(`/api/obligations/generate-ai/${contractId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to generate obligations');
        }

        aiObligations = await response.json();
        
        if (aiObligations.length === 0) {
            throw new Error('No obligations were extracted from the contract');
        }

        // Show results in modal
        renderAIObligationsInModal();
        document.getElementById('aiObligationsModal').classList.add('show');
        showToast(`Successfully extracted ${aiObligations.length} obligations`, 'success');

    } catch (error) {
        console.error('Error generating obligations:', error);
        showToast(error.message || 'Failed to generate obligations', 'error');
    } finally {
        showLoading(false);
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

function closeAIModal() {
    document.getElementById('aiObligationsModal').classList.remove('show');
    selectedObligations.clear();
}

// =====================================================
// RENDER AI OBLIGATIONS IN MODAL
// =====================================================
function renderAIObligationsInModal() {
    const container = document.getElementById('aiObligationsGrid');
    
    if (aiObligations.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="ti ti-file-search"></i>
                <h3>No obligations found</h3>
                <p>The AI analysis did not find any obligations in this contract.</p>
            </div>
        `;
        return;
    }

    const html = `
        <div class="obligations-grid">
            ${aiObligations.map((obl, index) => `
                <div class="obligation-card ${selectedObligations.has(index) ? 'selected' : ''}" 
                     onclick="toggleAISelection(${index})" 
                     data-index="${index}">
                    <button class="edit-btn" onclick="event.stopPropagation(); editAIObligation(${index})">
                        <i class="ti ti-edit"></i>
                    </button>
                    <div class="card-header">
                        <div class="card-title">${obl.title}</div>
                        <div class="card-badges">
                            <span class="badge badge-priority ${obl.priority}">${obl.priority.toUpperCase()}</span>
                            <span class="badge badge-confidence">
                                <i class="ti ti-sparkles"></i>
                                ${Math.round(obl.confidence * 100)}%
                            </span>
                        </div>
                    </div>
                    <div class="card-description">${obl.description}</div>
                    <div class="card-meta">
                        <div class="meta-item">
                            <i class="ti ti-category"></i>
                            ${obl.category}
                        </div>
                        ${obl.clause_reference ? `
                            <div class="meta-item">
                                <i class="ti ti-bookmark"></i>
                                ${obl.clause_reference}
                            </div>
                        ` : ''}
                        ${obl.owner ? `
                            <div class="meta-item">
                                <i class="ti ti-user"></i>
                                ${obl.owner.name}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('')}
        </div>
    `;

    container.innerHTML = html;
    updateAISelectedCount();
}

// =====================================================
// SELECTION HANDLING FOR AI OBLIGATIONS
// =====================================================
function toggleAISelection(index) {
    if (selectedObligations.has(index)) {
        selectedObligations.delete(index);
    } else {
        selectedObligations.add(index);
    }
    
    const card = document.querySelector(`#aiObligationsGrid [data-index="${index}"]`);
    if (card) {
        card.classList.toggle('selected');
    }
    updateAISelectedCount();
}

function updateAISelectedCount() {
    const countEl = document.getElementById('aiSelectedCount');
    if (countEl) {
        countEl.textContent = `${selectedObligations.size} / ${aiObligations.length}`;
    }
}

// =====================================================
// EDIT OBLIGATION (for AI-generated)
// =====================================================
function editAIObligation(index) {
    currentEditIndex = index;
    const obl = aiObligations[index];

    document.getElementById('editTitle').value = obl.title;
    document.getElementById('editDescription').value = obl.description;
    document.getElementById('editCategory').value = obl.category;
    document.getElementById('editPriority').value = obl.priority;
    document.getElementById('editClause').value = obl.clause_reference || '';
    document.getElementById('editThresholdDate').value = obl.threshold_date || '';
    document.getElementById('editDueDate').value = obl.due_date || '';

    // Reset user selections
    selectedOwner = obl.owner || null;
    selectedEscalation = obl.escalation || null;

    if (selectedOwner) {
        showSelectedUser('owner', selectedOwner);
    } else {
        document.getElementById('selectedOwner').style.display = 'none';
        document.getElementById('ownerSearch').style.display = 'block';
    }

    if (selectedEscalation) {
        showSelectedUser('escalation', selectedEscalation);
    } else {
        document.getElementById('selectedEscalation').style.display = 'none';
        document.getElementById('escalationSearch').style.display = 'block';
    }

    document.getElementById('editModal').classList.add('show');
}

// EDIT EXISTING OBLIGATION (for table)
async function editExistingObligation(obligationId) {
    const obligation = existingObligations.find(o => o.id === obligationId);
    if (!obligation) return;

    // Populate the new obligation form with existing data
    document.getElementById('newTitle').value = obligation.obligation_title;
    document.getElementById('newDescription').value = obligation.description || '';
    document.getElementById('newCategory').value = obligation.obligation_type || 'other';
    document.getElementById('newStatus').value = obligation.status || 'initiated';
    document.getElementById('newThresholdDate').value = obligation.threshold_date ? obligation.threshold_date.split('T')[0] : '';
    document.getElementById('newDueDate').value = obligation.due_date ? obligation.due_date.split('T')[0] : '';

    // Set owner if exists
    if (obligation.owner_user_id && obligation.owner_name) {
        newSelectedOwner = {
            id: obligation.owner_user_id,
            name: obligation.owner_name,
            email: obligation.owner_email
        };
        showSelectedUserNew('owner', newSelectedOwner);
    } else {
        newSelectedOwner = null;
        document.getElementById('newSelectedOwner').style.display = 'none';
        document.getElementById('newOwnerSearch').style.display = 'block';
    }

    // Set escalation if exists
    if (obligation.escalation_user_id && obligation.escalation_name) {
        newSelectedEscalation = {
            id: obligation.escalation_user_id,
            name: obligation.escalation_name,
            email: obligation.escalation_email
        };
        showSelectedUserNew('escalation', newSelectedEscalation);
    } else {
        newSelectedEscalation = null;
        document.getElementById('newSelectedEscalation').style.display = 'none';
        document.getElementById('newEscalationSearch').style.display = 'block';
    }

    // Change form submit to update instead of create
    const form = document.getElementById('newObligationForm');
    form.onsubmit = async (event) => {
        event.preventDefault();
        await updateExistingObligation(obligationId);
    };

    // Change button text
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="ti ti-check"></i> Update Obligation';

    // Open modal
    document.getElementById('newObligationModal').classList.add('show');
}

async function updateExistingObligation(obligationId) {
    try {
        showLoading(true);

        const obligationData = {
            obligation_title: document.getElementById('newTitle').value,
            description: document.getElementById('newDescription').value,
            obligation_type: document.getElementById('newCategory').value,
            owner_user_id: newSelectedOwner?.id,
            escalation_user_id: newSelectedEscalation?.id,
            threshold_date: document.getElementById('newThresholdDate').value || null,
            due_date: document.getElementById('newDueDate').value,
            status: document.getElementById('newStatus').value
        };

        const response = await fetch(`/api/obligations/${obligationId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(obligationData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update obligation');
        }

        showToast('Obligation updated successfully', 'success');
        closeNewObligationModal();
        
        // Reset form
        const form = document.getElementById('newObligationForm');
        form.onsubmit = saveNewObligation;
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="ti ti-check"></i> Create Obligation';
        
        await loadExistingObligations();

    } catch (error) {
        console.error('Error updating obligation:', error);
        showToast(error.message || 'Failed to update obligation', 'error');
    } finally {
        showLoading(false);
    }
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
    currentEditIndex = null;
    selectedOwner = null;
    selectedEscalation = null;
}

function saveObligationEdit(event) {
    event.preventDefault();

    if (currentEditIndex === null) return;

    aiObligations[currentEditIndex] = {
        ...aiObligations[currentEditIndex],
        title: document.getElementById('editTitle').value,
        description: document.getElementById('editDescription').value,
        category: document.getElementById('editCategory').value,
        priority: document.getElementById('editPriority').value,
        threshold_date: document.getElementById('editThresholdDate').value,
        due_date: document.getElementById('editDueDate').value,
        owner: selectedOwner,
        escalation: selectedEscalation
    };

    renderObligations();
    closeEditModal();
    showToast('Obligation updated successfully', 'success');
}

// =====================================================
// USER SEARCH
// =====================================================
async function searchUsers(type) {
    const searchInput = document.getElementById(`${type}Search`);
    const suggestionsDiv = document.getElementById(`${type}Suggestions`);
    const query = searchInput.value.trim();

    // Clear previous timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    // Hide suggestions if query is empty
    if (!query) {
        suggestionsDiv.classList.remove('show');
        return;
    }

    // Debounce search
    searchTimeout = setTimeout(async () => {
        try {
            suggestionsDiv.innerHTML = `
                <div class="user-suggestion-item" style="text-align: center; color: var(--text-muted);">
                    <i class="ti ti-loader" style="animation: spin 0.8s linear infinite;"></i>
                    Searching...
                </div>
            `;
            suggestionsDiv.classList.add('show');

            const response = await fetch(`/api/users/search?email=${encodeURIComponent(query)}`, {
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error('Search failed');

            const users = await response.json();

            if (users.length === 0) {
                suggestionsDiv.innerHTML = `
                    <div class="user-suggestion-item" style="text-align: center; color: var(--text-muted);">
                        <i class="ti ti-user-x"></i>
                        No users found
                    </div>
                `;
            } else {
                suggestionsDiv.innerHTML = users.map(user => `
                    <div class="user-suggestion-item" onclick="selectUser('${type}', ${user.id}, '${user.full_name}', '${user.email}')">
                        <div class="user-name">${user.full_name}</div>
                        <div class="user-email">${user.email}</div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error searching users:', error);
            suggestionsDiv.innerHTML = `
                <div class="user-suggestion-item" style="text-align: center; color: var(--danger-color);">
                    <i class="ti ti-alert-circle"></i>
                    Search failed
                </div>
            `;
        }
    }, 300);
}

function selectUser(type, userId, userName, userEmail) {
    const user = { id: userId, name: userName, email: userEmail };
    
    if (type === 'owner') {
        selectedOwner = user;
    } else {
        selectedEscalation = user;
    }

    showSelectedUser(type, user);
    
    // Hide suggestions
    document.getElementById(`${type}Suggestions`).classList.remove('show');
    document.getElementById(`${type}Search`).value = '';
}

function showSelectedUser(type, user) {
    const container = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}`);
    container.innerHTML = `
        <div class="selected-user">
            <div>
                <div class="user-name">${user.name}</div>
                <div class="user-email">${user.email}</div>
            </div>
            <button class="remove-user" onclick="removeUser('${type}')">
                <i class="ti ti-x"></i>
            </button>
        </div>
    `;
    container.style.display = 'block';
    document.getElementById(`${type}Search`).style.display = 'none';
}

function removeUser(type) {
    if (type === 'owner') {
        selectedOwner = null;
    } else {
        selectedEscalation = null;
    }
    
    document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}`).style.display = 'none';
    document.getElementById(`${type}Search`).style.display = 'block';
}

// =====================================================
// ADD TO DATABASE
// =====================================================
async function addSelectedObligations() {
    if (selectedObligations.size === 0) {
        showToast('Please select at least one obligation', 'error');
        return;
    }

    const obligationsToAdd = Array.from(selectedObligations).map(index => aiObligations[index]);
    
    // Validate that all have required fields
    const missingDetails = obligationsToAdd.some(obl => !obl.owner || !obl.due_date);
    if (missingDetails) {
        showToast('Please edit obligations to assign owners and due dates before adding', 'error');
        return;
    }

    try {
        showLoading(true);

        const promises = obligationsToAdd.map(obl => 
            fetch(`/api/obligations/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contract_id: contractId,
                    obligation_title: obl.title,
                    description: obl.description,
                    obligation_type: obl.category,
                    owner_user_id: obl.owner?.id,
                    escalation_user_id: obl.escalation?.id,
                    threshold_date: obl.threshold_date,
                    due_date: obl.due_date,
                    status: 'initiated',
                    is_ai_generated: true
                })
            })
        );

        const results = await Promise.all(promises);
        const failed = results.filter(r => !r.ok);

        if (failed.length > 0) {
            throw new Error(`Failed to add ${failed.length} obligations`);
        }

        showToast(`Successfully added ${obligationsToAdd.length} obligations`, 'success');
        
        // Redirect to obligations dashboard
        setTimeout(() => {
            window.location.href = '/obligations';
        }, 1500);

    } catch (error) {
        console.error('Error adding obligations:', error);
        showToast(error.message || 'Failed to add obligations', 'error');
    } finally {
        showLoading(false);
    }
}

// =====================================================
// UTILITY FUNCTIONS
// =====================================================
function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
        overlay.classList.add('active');
    } else {
        overlay.classList.remove('active');
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const messageEl = document.getElementById('toastMessage');
    
    toast.className = `toast ${type}`;
    messageEl.textContent = message;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Close suggestions when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.user-search-container')) {
        document.querySelectorAll('.user-suggestions').forEach(el => {
            el.classList.remove('show');
        });
    }
});

// =====================================================
// EXISTING OBLIGATIONS
// =====================================================
async function loadExistingObligations() {
    try {
        const response = await fetch(`/api/obligations/contract/${contractId}`, {
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('Failed to load existing obligations');

        existingObligations = await response.json();
        
        if (existingObligations.length > 0) {
            displayExistingObligations();
            // Hide the empty state in obligationsContainer
            document.getElementById('obligationsContainer').style.display = 'none';
        } else {
            // Show empty state
            document.getElementById('obligationsContainer').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading existing obligations:', error);
    }
}

function displayExistingObligations() {
    const section = document.getElementById('existingObligationsSection');
    const list = document.getElementById('existingObligationsList');
    
    if (existingObligations.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    
    list.innerHTML = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--background-light); border-bottom: 2px solid var(--border-color);">
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Obligation</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Category</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Owner</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Due Date</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Status</th>
                        <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${existingObligations.map(obl => `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.75rem;">
                                <div style="font-weight: 500;">${obl.obligation_title}</div>
                                ${obl.description ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">${obl.description.substring(0, 100)}${obl.description.length > 100 ? '...' : ''}</div>` : ''}
                                ${obl.is_ai_generated ? '<span class="badge" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 0.7rem; margin-top: 0.25rem; display: inline-block;"><i class="ti ti-sparkles"></i> AI</span>' : ''}
                            </td>
                            <td style="padding: 0.75rem;">
                                <span class="badge" style="background: var(--background-light); color: var(--text-color);">${obl.obligation_type || 'other'}</span>
                            </td>
                            <td style="padding: 0.75rem;">
                                ${obl.owner_name ? `
                                    <div style="font-size: 0.9rem;">${obl.owner_name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">${obl.owner_email}</div>
                                ` : '<span style="color: var(--text-muted);">Unassigned</span>'}
                            </td>
                            <td style="padding: 0.75rem;">
                                ${obl.due_date ? new Date(obl.due_date).toLocaleDateString() : '<span style="color: var(--text-muted);">No date</span>'}
                            </td>
                            <td style="padding: 0.75rem;">
                                <span class="badge badge-priority ${getStatusPriority(obl.status)}">${formatStatus(obl.status)}</span>
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <button onclick="editExistingObligation(${obl.id})" class="btn" style="padding: 0.5rem; font-size: 0.9rem;">
                                    <i class="ti ti-edit"></i>
                                </button>
                                <button onclick="deleteObligation(${obl.id})" class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.9rem; background: var(--danger-color);">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function formatStatus(status) {
    if (!status) return 'N/A';
    return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function getStatusPriority(status) {
    const highPriority = ['overdue', 'pending_details'];
    const mediumPriority = ['in_progress', 'awaiting_approval'];
    
    if (highPriority.includes(status)) return 'high';
    if (mediumPriority.includes(status)) return 'medium';
    return 'low';
}

async function editExistingObligation(obligationId) {
    const obligation = existingObligations.find(o => o.id === obligationId);
    if (!obligation) return;

    // This would need a separate modal or reuse the edit modal
    // For now, let's show a toast
    showToast('Edit existing obligations from the main Obligations Dashboard', 'info');
}

async function deleteObligation(obligationId) {
    if (!confirm('Are you sure you want to delete this obligation? This action cannot be undone.')) return;

    try {
        showLoading(true);

        const response = await fetch(`/api/obligations/${obligationId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            // Check if it's a foreign key constraint error
            if (errorData.detail && errorData.detail.includes('foreign key constraint')) {
                throw new Error('Cannot delete this obligation because it has related updates or tracking records. Please remove those first.');
            }
            throw new Error(errorData.detail || 'Failed to delete obligation');
        }

        showToast('Obligation deleted successfully', 'success');
        await loadExistingObligations();

    } catch (error) {
        console.error('Error deleting obligation:', error);
        showToast(error.message || 'Failed to delete obligation', 'error');
    } finally {
        showLoading(false);
    }
}

// =====================================================
// NEW OBLIGATION MODAL
// =====================================================
function openNewObligationModal() {
    document.getElementById('newObligationModal').classList.add('show');
    // Reset form
    document.getElementById('newObligationForm').reset();
    newSelectedOwner = null;
    newSelectedEscalation = null;
    document.getElementById('newSelectedOwner').style.display = 'none';
    document.getElementById('newSelectedEscalation').style.display = 'none';
    document.getElementById('newOwnerSearch').style.display = 'block';
    document.getElementById('newEscalationSearch').style.display = 'block';
}

function closeNewObligationModal() {
    document.getElementById('newObligationModal').classList.remove('show');
}

async function saveNewObligation(event) {
    event.preventDefault();

    try {
        showLoading(true);

        const obligationData = {
            contract_id: contractId,
            obligation_title: document.getElementById('newTitle').value,
            description: document.getElementById('newDescription').value,
            obligation_type: document.getElementById('newCategory').value,
            owner_user_id: newSelectedOwner?.id,
            escalation_user_id: newSelectedEscalation?.id,
            threshold_date: document.getElementById('newThresholdDate').value || null,
            due_date: document.getElementById('newDueDate').value,
            status: document.getElementById('newStatus').value,
            is_ai_generated: false
        };

        const response = await fetch('/api/obligations/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(obligationData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create obligation');
        }

        showToast('Obligation created successfully', 'success');
        closeNewObligationModal();
        await loadExistingObligations();

    } catch (error) {
        console.error('Error creating obligation:', error);
        showToast(error.message || 'Failed to create obligation', 'error');
    } finally {
        showLoading(false);
    }
}

// User search for new obligation modal
async function searchUsersNew(type) {
    const searchInput = document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Search`);
    const suggestionsDiv = document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Suggestions`);
    const query = searchInput.value.trim();

    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    if (!query) {
        suggestionsDiv.classList.remove('show');
        return;
    }

    searchTimeout = setTimeout(async () => {
        try {
            suggestionsDiv.innerHTML = `
                <div class="user-suggestion-item" style="text-align: center; color: var(--text-muted);">
                    <i class="ti ti-loader" style="animation: spin 0.8s linear infinite;"></i>
                    Searching...
                </div>
            `;
            suggestionsDiv.classList.add('show');

            const response = await fetch(`/api/users/search?email=${encodeURIComponent(query)}`, {
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error('Search failed');

            const users = await response.json();

            if (users.length === 0) {
                suggestionsDiv.innerHTML = `
                    <div class="user-suggestion-item" style="text-align: center; color: var(--text-muted);">
                        <i class="ti ti-user-x"></i>
                        No users found
                    </div>
                `;
            } else {
                suggestionsDiv.innerHTML = users.map(user => `
                    <div class="user-suggestion-item" onclick="selectUserNew('${type}', ${user.id}, '${user.full_name}', '${user.email}')">
                        <div class="user-name">${user.full_name}</div>
                        <div class="user-email">${user.email}</div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error searching users:', error);
            suggestionsDiv.innerHTML = `
                <div class="user-suggestion-item" style="text-align: center; color: var(--danger-color);">
                    <i class="ti ti-alert-circle"></i>
                    Search failed
                </div>
            `;
        }
    }, 300);
}

function selectUserNew(type, userId, userName, userEmail) {
    const user = { id: userId, name: userName, email: userEmail };
    
    if (type === 'owner') {
        newSelectedOwner = user;
    } else {
        newSelectedEscalation = user;
    }

    showSelectedUserNew(type, user);
    
    document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Suggestions`).classList.remove('show');
    document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Search`).value = '';
}

function showSelectedUserNew(type, user) {
    const container = document.getElementById(`newSelected${type.charAt(0).toUpperCase() + type.slice(1)}`);
    container.innerHTML = `
        <div class="selected-user">
            <div>
                <div class="user-name">${user.name}</div>
                <div class="user-email">${user.email}</div>
            </div>
            <button class="remove-user" onclick="removeUserNew('${type}')">
                <i class="ti ti-x"></i>
            </button>
        </div>
    `;
    container.style.display = 'block';
    document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Search`).style.display = 'none';
}

function removeUserNew(type) {
    if (type === 'owner') {
        newSelectedOwner = null;
    } else {
        newSelectedEscalation = null;
    }
    
    document.getElementById(`newSelected${type.charAt(0).toUpperCase() + type.slice(1)}`).style.display = 'none';
    document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Search`).style.display = 'block';
}

// =====================================================
// PRESET OBLIGATIONS
// =====================================================
function openPresetModal() {
    document.getElementById('presetModal').classList.add('show');
    selectedPresets.clear();
    currentPresetProfile = 'client'; // Default to client
    
    // Set active tab
    document.querySelectorAll('.preset-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.profile === currentPresetProfile) {
            tab.classList.add('active');
        }
    });
    
    displayPresetObligations();
}

function closePresetModal() {
    document.getElementById('presetModal').classList.remove('show');
    selectedPresets.clear();
}

function switchPresetProfile(profile) {
    currentPresetProfile = profile;
    
    // Update active tab
    document.querySelectorAll('.preset-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.profile === profile) {
            tab.classList.add('active');
        }
    });
    
    selectedPresets.clear();
    displayPresetObligations();
}

function displayPresetObligations() {
    const container = document.getElementById('presetObligationsList');
    const obligations = presetObligations[currentPresetProfile] || [];
    
    if (obligations.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="ti ti-inbox"></i>
                <p>No preset obligations available for this profile.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = obligations.map(obl => `
        <div class="preset-obligation-item ${selectedPresets.has(obl.id) ? 'selected' : ''}" 
             onclick="togglePresetSelection('${obl.id}')"
             data-preset-id="${obl.id}">
            <div style="display: flex; align-items: start; gap: 1rem;">
                <div class="preset-check">
                    ${selectedPresets.has(obl.id) ? '<i class="ti ti-check"></i>' : ''}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem;">
                        ${obl.title}
                    </div>
                    <div style="color: var(--text-muted); margin-bottom: 0.75rem; line-height: 1.5;">
                        ${obl.description}
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <span class="badge" style="background: var(--background-light); color: var(--text-color);">
                            <i class="ti ti-category"></i> ${obl.category}
                        </span>
                        <span class="badge badge-priority ${obl.priority}">
                            ${obl.priority.toUpperCase()}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    updatePresetCount();
}

function togglePresetSelection(presetId) {
    if (selectedPresets.has(presetId)) {
        selectedPresets.delete(presetId);
    } else {
        selectedPresets.add(presetId);
    }
    
    // Update UI
    const item = document.querySelector(`[data-preset-id="${presetId}"]`);
    const check = item.querySelector('.preset-check');
    
    if (selectedPresets.has(presetId)) {
        item.classList.add('selected');
        check.innerHTML = '<i class="ti ti-check"></i>';
    } else {
        item.classList.remove('selected');
        check.innerHTML = '';
    }
    
    updatePresetCount();
}

function updatePresetCount() {
    document.getElementById('presetSelectedCount').textContent = 
        `${selectedPresets.size} selected`;
}

async function addPresetObligations() {
    if (selectedPresets.size === 0) {
        showToast('Please select at least one preset obligation', 'error');
        return;
    }

    try {
        showLoading(true);
        
        const obligations = presetObligations[currentPresetProfile];
        const obligationsToAdd = Array.from(selectedPresets).map(id => 
            obligations.find(o => o.id === id)
        ).filter(Boolean);

        const promises = obligationsToAdd.map(obl => 
            fetch('/api/obligations/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contract_id: contractId,
                    obligation_title: obl.title,
                    description: obl.description,
                    obligation_type: obl.category,
                    status: 'initiated',
                    is_ai_generated: false
                })
            })
        );

        const results = await Promise.all(promises);
        const failed = results.filter(r => !r.ok);

        if (failed.length > 0) {
            throw new Error(`Failed to add ${failed.length} preset obligations`);
        }

        showToast(`Successfully added ${obligationsToAdd.length} preset obligations`, 'success');
        closePresetModal();
        await loadExistingObligations();

    } catch (error) {
        console.error('Error adding preset obligations:', error);
        showToast(error.message || 'Failed to add preset obligations', 'error');
    } finally {
        showLoading(false);
    }
}

</script>
{% endblock %}
