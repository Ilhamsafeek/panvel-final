{% extends "base.html" %}

{% block title %}User Settings{% endblock %}

{% block head %}
<style>
    /* User Settings Specific Styles */
    .settings-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .page-title h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
    }

    .page-title i {
        font-size: 2rem;
        color: var(--primary-color);
    }

    .settings-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 2rem;
    }

    .settings-sidebar {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        height: fit-content;
        position: sticky;
        top: calc(var(--header-height) + 2rem);
    }

    .user-info-card {
        padding: 1.5rem;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
    }

    .user-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: 600;
        margin: 0 auto 1rem;
    }

    .user-type-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: var(--info-bg);
        color: var(--info-color);
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.5rem;
        text-transform: uppercase;
    }

    .settings-nav {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 8px;
        color: var(--text-color);
        cursor: pointer;
        transition: var(--transition);
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 0.925rem;
    }

    .settings-nav-item:hover {
        background: var(--background-light);
        color: var(--primary-color);
    }

    .settings-nav-item.active {
        background: rgba(39, 98, 203, 0.08);
        color: var(--primary-color);
        font-weight: 600;
    }

    .settings-content {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        overflow: hidden;
    }

    .settings-section {
        display: none;
        padding: 2rem;
    }

    .settings-section.active {
        display: block;
    }

    .section-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
    }

    .section-description {
        color: var(--text-muted);
        font-size: 0.925rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.875rem;
    }

    .required {
        color: var(--danger-color);
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.925rem;
        transition: var(--transition);
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .form-control:disabled {
        background: var(--background-light);
        cursor: not-allowed;
    }

    .form-hint {
        font-size: 0.813rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .document-upload-card {
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1.5rem;
        background: var(--background-light);
    }

    .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .document-title {
        font-weight: 600;
        color: var(--text-color);
    }

    .document-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.813rem;
    }

    .status-valid {
        color: var(--success-color);
    }

    .status-expired {
        color: var(--danger-color);
    }

    .upload-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .upload-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .toggle-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: var(--background-light);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .toggle-label {
        font-weight: 600;
        color: var(--text-color);
    }

    .toggle-description {
        font-size: 0.813rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .toggle-switch {
        position: relative;
        width: 48px;
        height: 24px;
    }

    .toggle-switch input {
        display: none;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: var(--border-color);
        transition: 0.3s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: white;
        transition: 0.3s;
        border-radius: 50%;
    }

    input:checked+.toggle-slider {
        background: var(--success-color);
    }

    input:checked+.toggle-slider:before {
        transform: translateX(24px);
    }

    .license-card {
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.05), rgba(115, 180, 224, 0.05));
        border-radius: 8px;
        border: 1px solid rgba(39, 98, 203, 0.2);
        margin-bottom: 1.5rem;
    }

    .license-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .license-type {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .license-details {
        display: flex;
        gap: 2rem;
        font-size: 0.875rem;
    }

    .license-detail-item {
        display: flex;
        flex-direction: column;
    }

    .license-detail-label {
        color: var(--text-muted);
    }

    .license-detail-value {
        font-weight: 600;
        color: var(--text-color);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 0.925rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: #1e4ba8;
    }

    .btn-secondary {
        background: white;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--background-light);
    }

    .settings-actions {
        padding: 1.5rem 2rem;
        background: var(--background-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid var(--border-color);
    }

    .loading-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 1024px) {
        .settings-layout {
            grid-template-columns: 1fr;
        }

        .settings-sidebar {
            position: static;
        }
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    .modules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .module-card {
        background: var(--background-light);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
    }

    .module-card.subscribed {
        border-color: var(--success-color);
        background: rgba(16, 185, 129, 0.05);
    }

    .module-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .module-header {
        display: flex;
        align-items: start;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .module-icon {
        width: 48px;
        height: 48px;
        background: var(--primary-color);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
    }

    .module-card.subscribed .module-icon {
        background: var(--success-color);
    }

    .subscription-badge {
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--success-color);
        color: white;
    }

    .module-card:not(.subscribed) .subscription-badge {
        background: var(--text-muted);
    }

    .module-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-color);
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .module-description {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .module-features {
        list-style: none;
        margin-bottom: 1rem;
        padding-left: 0;
    }

    .module-features li {
        font-size: 0.813rem;
        color: var(--text-muted);
        padding: 0.25rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .module-features li::before {
        content: "✓";
        color: var(--success-color);
        font-weight: bold;
        font-size: 1rem;
    }

    .module-action-btn {
        width: 100%;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .module-action-btn.subscribe-btn {
        background: var(--primary-color);
        color: white;
    }

    .module-action-btn.subscribe-btn:hover {
        background: #1e4ba8;
    }

    .module-action-btn.unsubscribe-btn {
        background: transparent;
        color: var(--danger-color);
        border: 1px solid var(--danger-color);
    }

    .module-action-btn.unsubscribe-btn:hover {
        background: var(--danger-color);
        color: white;
    }

    .module-action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .loading-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }
</style>


<style>
    /* ===================================================== 
   MODAL STYLES - Add this to your existing <style> tag
   ===================================================== */

    /* Modal Base Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 99999;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .modal.active {
        display: flex !important;
        opacity: 1;
        pointer-events: all;
    }

    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 1;
    }

    .modal-container {
        position: relative;
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow: hidden;
        z-index: 2;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--background-light);
    }

    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-color);
    }

    .modal-close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
        padding: 0;
    }

    .modal-close-btn:hover {
        background: var(--border-color);
        color: var(--text-color);
    }

    .modal-body {
        padding: 1.5rem;
        max-height: calc(90vh - 160px);
        overflow-y: auto;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        background: var(--background-light);
    }

    /* License Option Styles */
    .license-options {
        display: grid;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .license-option-card {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        background: white;
        position: relative;
    }

    .license-option-card:hover {
        border-color: var(--primary-color);
        background: var(--background-light);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .license-option-card input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .license-option-card input[type="radio"]:checked+.license-option-content {
        border-left-color: var(--primary-color);
    }

    .license-option-card:has(input[type="radio"]:checked) {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, white 0%, rgba(39, 98, 203, 0.05) 100%);
    }

    .license-option-content {
        display: flex;
        gap: 1rem;
        align-items: start;
        padding-left: 1rem;
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
    }

    .license-option-content i {
        font-size: 2rem;
        color: var(--primary-color);
        flex-shrink: 0;
    }

    .license-option-content strong {
        display: block;
        font-size: 1.125rem;
        margin-bottom: 0.25rem;
        color: var(--text-color);
    }

    .license-option-content p {
        margin: 0 0 0.5rem 0;
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .license-option-content ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .license-option-content ul li {
        margin-bottom: 0.25rem;
    }

    /* Alert Styles */
    .alert {
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .alert-info {
        background: #dbeafe;
        border: 1px solid #3b82f6;
        color: #1e40af;
    }

    .alert i {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .alert strong {
        font-weight: 600;
    }

    /* Form Select in Modal */
    .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.925rem;
        transition: var(--transition);
        font-family: inherit;
        background: white;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    /* Button Styles for Modal */
    .btn-outline-primary {
        background: white;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
    }

    .btn-outline-primary:hover {
        background: var(--primary-color);
        color: white;
    }

    /* Responsive Modal */
    @media (max-width: 640px) {
        .modal-container {
            width: 95%;
            max-height: 95vh;
        }

        .modal-body {
            max-height: calc(95vh - 160px);
        }
    }
</style>



<style>
    /* License Card Styles */
    .license-card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .license-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .license-type-display {
        display: flex;
        align-items: center;
    }

    .license-type {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .license-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .license-detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .license-detail-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .license-detail-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    /* License Toggle */
    .license-toggle-container {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: var(--background-light);
        border-radius: 8px;
    }

    .btn-group {
        display: flex;
        gap: 0.5rem;
    }

    .license-toggle-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        background: white;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-radius: 6px;
    }

    .license-toggle-btn:hover {
        background: var(--background-light);
    }

    .license-toggle-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Modules Grid */
    .modules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .module-card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
    }

    .module-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .module-card.subscribed {
        border-color: var(--success-color);
        background: linear-gradient(135deg, var(--card-background) 0%, rgba(34, 197, 94, 0.05) 100%);
    }

    .module-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .module-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .subscription-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .subscription-badge.active {
        background: var(--success-color);
        color: white;
    }

    .subscription-badge.inactive {
        background: var(--background-light);
        color: var(--text-muted);
    }

    .module-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-color);
    }

    .module-description {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
    }

    .module-pricing {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--background-light);
        border-radius: 6px;
    }

    .price-amount {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .price-period {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .module-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* License Option Cards */
    .license-options {
        display: grid;
        gap: 1rem;
    }

    .license-option-card {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
    }

    .license-option-card:hover {
        border-color: var(--primary-color);
        background: var(--background-light);
    }

    .license-option-card input[type="radio"] {
        display: none;
    }

    .license-option-card input[type="radio"]:checked+.license-option-content {
        border-left: 4px solid var(--primary-color);
    }

    .license-option-content {
        display: flex;
        gap: 1rem;
        align-items: start;
        padding-left: 1rem;
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
    }

    .license-option-content i {
        font-size: 2rem;
        color: var(--primary-color);
    }

    .license-option-content ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .loading-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .modules-grid {
            grid-template-columns: 1fr;
        }

        .license-details {
            grid-template-columns: 1fr;
        }

        .license-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }


    /* Button Loading States */
    .btn {
        position: relative;
        transition: all 0.3s ease;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-loading-text {
        pointer-events: none;
        position: relative;
    }

    .btn-loading-text::before {
        content: "";
        display: inline-block;
        width: 14px;
        height: 14px;
        margin-right: 8px;
        border: 2px solid transparent;
        border-radius: 50%;
        border-top-color: currentColor;
        animation: spin 0.6s linear infinite;
        vertical-align: middle;
    }

    .module-action-btn.loading {
        pointer-events: none;
        opacity: 0.7;
    }

    .module-action-btn.loading i {
        display: none;
    }

    .module-action-btn.loading::before {
        content: "";
        display: inline-block;
        width: 14px;
        height: 14px;
        margin-right: 8px;
        border: 2px solid transparent;
        border-radius: 50%;
        border-top-color: currentColor;
        animation: spin 0.6s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <i class="ti ti-user-cog"></i>
            <h1>User Settings</h1>
        </div>
        <p style="color: var(--text-muted);">Manage your profile and account preferences</p>
    </div>

    <!-- Settings Layout -->
    <div class="settings-layout">
        <!-- Settings Sidebar -->
        <div class="settings-sidebar">
            <!-- User Info Card -->
            <div class="user-info-card">
                <div class="user-avatar-large" id="userAvatar">{{ user.avatar_initial if user else 'U' }}</div>
                <div class="user-name" id="userName">{{ user.full_name if user else 'Loading...' }}</div>
                <div style="font-size: 0.875rem; color: var(--text-muted);" id="userEmail">{{ user.email if user else ''
                    }}</div>
                <div class="user-type-badge" id="userType">{{ user.user_type if user else 'USER' }}</div>
            </div>

            <!-- Navigation -->
            <nav class="settings-nav">
                <button class="settings-nav-item active" onclick="switchSection('personal')" data-section="personal">
                    <i class="ti ti-user"></i>
                    <span>Personal Information</span>
                </button>
                <button class="settings-nav-item" onclick="switchSection('company')" data-section="company">
                    <i class="ti ti-building"></i>
                    <span>Company Information</span>
                </button>
                <button class="settings-nav-item" onclick="switchSection('security')" data-section="security">
                    <i class="ti ti-shield"></i>
                    <span>Security</span>
                </button>
                <button class="settings-nav-item" onclick="switchSection('preferences')" data-section="preferences">
                    <i class="ti ti-adjustments"></i>
                    <span>Account Preferences</span>
                </button>
                <button class="settings-nav-item" onclick="switchSection('license')" data-section="license">
                    <i class="ti ti-certificate"></i>
                    <span>License & Users</span>
                </button>

            </nav>
        </div>

        <!-- Settings Content -->
        <div class="settings-content">
            <!-- Personal Information Section -->
            <div class="settings-section active" id="personalSection">
                <div class="section-header">
                    <h2 class="section-title">Personal Information</h2>
                    <p class="section-description">Update your personal details</p>
                </div>

                <form id="personalInfoForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                First Name <span class="required">*</span>
                            </label>
                            <input type="text" class="form-control" id="firstName" name="first_name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Last Name <span class="required">*</span>
                            </label>
                            <input type="text" class="form-control" id="lastName" name="last_name" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Email Address <span class="required">*</span>
                        </label>
                        <input type="email" class="form-control" id="email" disabled>
                        <span class="form-hint">Contact support to change email address</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Job Title</label>
                            <input type="text" class="form-control" id="jobTitle" name="job_title">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Country/Region</label>
                        <select class="form-control" id="country" name="country">
                            <option value="qatar" selected>Qatar</option>
                            <option value="uae">United Arab Emirates</option>
                            <option value="saudi">Saudi Arabia</option>
                            <option value="kuwait">Kuwait</option>
                            <option value="bahrain">Bahrain</option>
                            <option value="oman">Oman</option>
                        </select>
                    </div>
                </form>
            </div>

            <!-- Company Information Section -->
            <div class="settings-section" id="companySection">
                <div class="section-header">
                    <h2 class="section-title">Company Information</h2>
                    <p class="section-description">Manage your organization details and compliance documents</p>
                </div>

                <form id="companyInfoForm">
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="companyName" disabled>
                        <span class="form-hint">Contact admin to update company name</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Industry</label>
                            <select class="form-control" id="industry" name="industry">
                                <option value="construction">Construction</option>
                                <option value="oil-gas">Oil & Gas</option>
                                <option value="technology">Technology</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="finance">Finance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company Size</label>
                            <select class="form-control" id="companySize" name="company_size">
                                <option value="1-10">1-10 employees</option>
                                <option value="11-50">11-50 employees</option>
                                <option value="51-200">51-200 employees</option>
                                <option value="201-500">201-500 employees</option>
                                <option value="501-1000">501-1000 employees</option>
                                <option value="1000+">1000+ employees</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Company Website</label>
                        <input type="url" class="form-control" id="website" name="website">
                    </div>

                    <!-- CR Document -->
                    <div class="document-upload-card">
                        <div class="document-header">
                            <div>
                                <div class="document-title">Commercial Registration (CR)</div>
                                <div style="font-size: 0.813rem; color: var(--text-muted);" id="crNumber">CR Number: -
                                </div>
                            </div>
                            <div class="document-status status-valid" id="crStatus">
                                <i class="ti ti-circle-check"></i>
                                <span>Not uploaded</span>
                            </div>
                        </div>
                        <button type="button" class="upload-btn" onclick="document.getElementById('crUpload').click()">
                            <i class="ti ti-upload"></i>
                            Update CR Document
                        </button>
                        <input type="file" id="crUpload" hidden accept=".pdf,.jpg,.jpeg,.png">
                    </div>

                    <!-- QID Document -->
                    <div class="document-upload-card">
                        <div class="document-header">
                            <div>
                                <div class="document-title">Qatar ID (QID)</div>
                                <div style="font-size: 0.813rem; color: var(--text-muted);" id="qidNumber">QID: -</div>
                            </div>
                            <div class="document-status status-valid" id="qidStatus">
                                <i class="ti ti-circle-check"></i>
                                <span>Not uploaded</span>
                            </div>
                        </div>
                        <button type="button" class="upload-btn" onclick="document.getElementById('qidUpload').click()">
                            <i class="ti ti-upload"></i>
                            Update QID Document
                        </button>
                        <input type="file" id="qidUpload" hidden accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </form>
            </div>

            <!-- Security Section -->
            <div class="settings-section" id="securitySection">
                <div class="section-header">
                    <h2 class="section-title">Security Settings</h2>
                    <p class="section-description">Keep your account secure</p>
                </div>

                <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">Change Password</h3>

                <form id="passwordForm">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" name="current_password"
                            placeholder="Enter current password">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password"
                                placeholder="Enter new password">
                            <span class="form-hint">Minimum 8 characters with letters and numbers</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirm_password"
                                placeholder="Confirm new password">
                        </div>
                    </div>
                </form>

                <h3 style="margin: 2rem 0 1rem 0; font-size: 1.125rem;">Security Settings</h3>

                <div class="toggle-item">
                    <div>
                        <div class="toggle-label">Two-Factor Authentication</div>
                        <div class="toggle-description">Add an extra layer of security to your account</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="twoFA">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Account Preferences Section -->
            <div class="settings-section" id="preferencesSection">
                <div class="section-header">
                    <h2 class="section-title">Account Preferences</h2>
                    <p class="section-description">Customize your experience</p>
                </div>

                <form id="preferencesForm">
                    <div class="form-group">
                        <label class="form-label">User Type</label>
                        <select class="form-control" id="userTypeField" disabled>
                            <option value="client">Client</option>
                            <option value="contractor">Contractor</option>
                            <option value="subcontractor">Sub-Contractor</option>
                            <option value="consultant">Consultant</option>
                            <option value="supplier">Supplier</option>
                            <option value="pmo">PMO</option>
                        </select>
                        <span class="form-hint">User type cannot be changed after registration</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Language Preference</label>
                            <select class="form-control" id="languagePreference" name="language_preference">
                                <option value="en">English</option>
                                <option value="ar">العربية (Arabic)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time Zone</label>
                            <select class="form-control" id="timezone" name="timezone">
                                <option value="Asia/Qatar">Asia/Qatar (UTC+03:00)</option>
                                <option value="Asia/Dubai">Asia/Dubai (UTC+04:00)</option>
                                <option value="Asia/Riyadh">Asia/Riyadh (UTC+03:00)</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem 0; font-size: 1.125rem;">Notifications</h3>

                    <div class="toggle-item">
                        <div>
                            <div class="toggle-label">Email Notifications</div>
                            <div class="toggle-description">Receive updates about contracts and deadlines</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="emailNotifications" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-item">
                        <div>
                            <div class="toggle-label">Newsletter</div>
                            <div class="toggle-description">Receive product updates and announcements</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="newsletter">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-item">
                        <div>
                            <div class="toggle-label">SMS Notifications</div>
                            <div class="toggle-description">Get critical alerts via SMS</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="smsNotifications">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </form>
            </div>

            <!-- License & Users Section -->
            <div class="settings-section" id="licenseSection">
                <div class="section-header">
                    <h2 class="section-title">License & Users</h2>
                    <p class="section-description">Manage your subscription and user seats</p>
                </div>

                <!-- Current License Card -->
                <div class="license-card">
                    <div class="license-header">
                        <div class="license-type-display">
                            <i class="ti ti-license" style="font-size: 1.5rem; margin-right: 0.5rem;"></i>
                            <div>
                                <div class="license-type" id="licenseType">Loading...</div>
                                <small class="text-muted" id="licenseDescription">Please wait...</small>
                            </div>
                        </div>

                        <!-- License Type Switcher -->
                        <div id="licenseSwitcher">
                            <button class="btn btn-outline-primary" onclick="openLicenseModal()">
                                <i class="ti ti-settings"></i>
                                Change License
                            </button>
                        </div>
                    </div>

                    <div class="license-details">
                        <div class="license-detail-item">
                            <span class="license-detail-label">
                                <i class="ti ti-file-text"></i>
                                Contract Limit
                            </span>
                            <span class="license-detail-value" id="contractLimit">-</span>
                        </div>
                        <div class="license-detail-item">
                            <span class="license-detail-label">
                                <i class="ti ti-users"></i>
                                User Seats
                            </span>
                            <span class="license-detail-value" id="userSeats">-</span>
                        </div>
                        <div class="license-detail-item">
                            <span class="license-detail-label">
                                <i class="ti ti-user-check"></i>
                                Active Users
                            </span>
                            <span class="license-detail-value" id="activeUsers">-</span>
                        </div>
                        <div class="license-detail-item">
                            <span class="license-detail-label">
                                <i class="ti ti-calendar"></i>
                                Renewal Date
                            </span>
                            <span class="license-detail-value" id="renewalDate">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Module Subscriptions Section -->
            <div class="settings-section" id="subscriptionsSection">
                <div class="section-header">
                    <h2 class="section-title">Module Subscriptions</h2>
                    <p class="section-description">Choose and subscribe to the modules you need</p>
                </div>

                <!-- License Type Toggle for Pricing Preview -->
                <div class="license-toggle-container" style="margin-bottom: 1.5rem;">
                    <label style="margin-right: 1rem; font-weight: 500;">View Pricing For:</label>
                    <div class="btn-group">
                        <button class="btn btn-sm license-toggle-btn active" data-license="individual"
                            onclick="switchPricingView('individual')">
                            <i class="ti ti-user"></i>
                            Individual
                        </button>
                        <button class="btn btn-sm license-toggle-btn" data-license="corporate"
                            onclick="switchPricingView('corporate')">
                            <i class="ti ti-building"></i>
                            Corporate
                        </button>
                    </div>
                </div>

                <!-- Modules Grid -->
                <div id="modulesContainer" class="modules-grid">
                    <!-- Modules will be loaded here dynamically -->
                    <div class="loading-state">
                        <i class="ti ti-loader" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                        <p>Loading modules...</p>
                    </div>
                </div>
            </div>


            <!-- License Change Modal -->
            <div class="modal" id="licenseModal">
                <div class="modal-backdrop" onclick="closeLicenseModal()"></div>
                <div class="modal-container">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="ti ti-license"></i>
                            Change License Plan
                        </h3>
                        <button class="modal-close-btn" onclick="closeLicenseModal()">
                            <i class="ti ti-x"></i>
                        </button>
                    </div>

                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">License Type</label>
                            <div class="license-options">
                                <label class="license-option-card">
                                    <input type="radio" name="newLicenseType" value="individual">
                                    <div class="license-option-content">
                                        <i class="ti ti-user"></i>
                                        <div>
                                            <strong>Individual License</strong>
                                            <p>Perfect for freelancers and small teams</p>
                                            <ul>
                                                <li>Up to 10 contracts</li>
                                                <li>1-5 users</li>
                                                <li>Basic features</li>
                                            </ul>
                                        </div>
                                    </div>
                                </label>

                                <label class="license-option-card">
                                    <input type="radio" name="newLicenseType" value="corporate">
                                    <div class="license-option-content">
                                        <i class="ti ti-building"></i>
                                        <div>
                                            <strong>Corporate License</strong>
                                            <p>For growing businesses and enterprises</p>
                                            <ul>
                                                <li>Unlimited contracts</li>
                                                <li>6-20 users</li>
                                                <li>Advanced features</li>
                                                <li>Priority support</li>
                                            </ul>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="numberOfUsersGroup">
                            <label class="form-label">Number of Users</label>
                            <select class="form-select" id="numberOfUsers">
                                <option value="">Select Number of Users</option>
                                <option value="1">1 User</option>
                                <option value="2">2 Users</option>
                                <option value="3">3 Users</option>
                                <option value="4">4 Users</option>
                                <option value="5">5 Users</option>
                                <option value="6">6 Users</option>
                                <option value="7">7 Users</option>
                                <option value="8">8 Users</option>
                                <option value="9">9 Users</option>
                                <option value="10">10 Users</option>
                                <option value="15">15 Users</option>
                                <option value="20">20 Users</option>
                            </select>
                        </div>

                        <div class="alert alert-info">
                            <i class="ti ti-info-circle"></i>
                            <div>
                                <strong>Note:</strong> Changing your license will update module pricing.
                                Existing subscriptions will remain active.
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeLicenseModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateLicense()">
                            <i class="ti ti-check"></i>
                            Update License
                        </button>
                    </div>
                </div>
            </div>

            <!-- Save Actions -->
            <div class="settings-actions">
                <div id="lastSaved" style="color: var(--text-muted); font-size: 0.875rem;">
                    Loading...
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="location.reload()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveCurrentSection()">
                        <i class="ti ti-device-floppy"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global state
    let currentSettings = {};
    let currentSection = 'personal';

    // Load user settings on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadUserSettings();
    });

    // Load user settings from API
    async function loadUserSettings() {
        try {
            showLoading(true);

            const response = await fetch('/api/user/settings', {
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to load settings');
            }

            const result = await response.json();
            currentSettings = result.data;

            // Populate form fields
            populatePersonalInfo(currentSettings.personal);
            populateCompanyInfo(currentSettings.company);
            populateSecuritySettings(currentSettings.security);
            populatePreferences(currentSettings.preferences);
            populateLicenseInfo(currentSettings.license);

            // Update sidebar
            updateSidebar(currentSettings.personal);

            document.getElementById('lastSaved').textContent = 'Settings loaded';

        } catch (error) {
            console.error('Error loading settings:', error);
            showToast('Failed to load settings', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Populate Personal Information
    function populatePersonalInfo(data) {
        if (!data) return;

        document.getElementById('firstName').value = data.first_name || '';
        document.getElementById('lastName').value = data.last_name || '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('phone').value = data.phone || '';
        document.getElementById('jobTitle').value = data.job_title || '';
    }

    // Populate Company Information
    function populateCompanyInfo(data) {
        if (!data) {
            document.getElementById('companyName').value = 'No Company';
            return;
        }

        document.getElementById('companyName').value = data.company_name || '';
        document.getElementById('industry').value = data.industry || '';
        document.getElementById('website').value = data.website || '';

        if (data.cr_number) {
            document.getElementById('crNumber').textContent = `CR Number: ${data.cr_number}`;
        }

        if (data.qid_number) {
            document.getElementById('qidNumber').textContent = `QID: ${data.qid_number}`;
        }
    }

    // Populate Security Settings
    function populateSecuritySettings(data) {
        if (!data) return;

        document.getElementById('twoFA').checked = data.two_factor_enabled || false;
    }

    // Populate Preferences
    function populatePreferences(data) {
        if (!data) return;

        document.getElementById('userTypeField').value = data.user_type || '';
        document.getElementById('languagePreference').value = data.language_preference || 'en';
        document.getElementById('timezone').value = data.timezone || 'Asia/Qatar';
        document.getElementById('emailNotifications').checked = data.email_notifications !== false;
        document.getElementById('newsletter').checked = data.newsletter || false;
        document.getElementById('smsNotifications').checked = data.sms_notifications || false;
    }

    // Populate License Information
    function populateLicenseInfo(data) {
        if (!data) return;

        document.getElementById('licenseType').textContent = data.type || 'Individual';
        document.getElementById('contractLimit').textContent = data.max_contracts || '10';
        document.getElementById('userSeats').textContent = `${data.max_users || 1} Users`;
        document.getElementById('activeUsers').textContent = `${data.active_users || 1} / ${data.max_users || 1}`;

        if (data.expiry) {
            const expiryDate = new Date(data.expiry);
            document.getElementById('renewalDate').textContent = expiryDate.toLocaleDateString();
        }
    }

    // Update Sidebar
    function updateSidebar(data) {
        if (!data) return;

        const initials = `${data.first_name?.[0] || ''}${data.last_name?.[0] || ''}`.toUpperCase();
        document.getElementById('userAvatar').textContent = initials || 'U';
        document.getElementById('userName').textContent = `${data.first_name || ''} ${data.last_name || ''}`.trim() || 'User';
        document.getElementById('userEmail').textContent = data.email || '';
    }

    // Switch Section
    function switchSection(sectionName) {
        currentSection = sectionName;

        // Update navigation
        document.querySelectorAll('.settings-nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.section === sectionName);
        });

        // Update content
        document.querySelectorAll('.settings-section').forEach(section => {
            section.classList.remove('active');
        });

        const targetSection = document.getElementById(sectionName + 'Section');
        if (targetSection) {
            targetSection.classList.add('active');
        }
    }

    // Save Current Section
    async function saveCurrentSection() {
        switch (currentSection) {
            case 'personal':
                await savePersonalInfo();
                break;
            case 'company':
                await saveCompanyInfo();
                break;
            case 'security':
                await saveSecuritySettings();
                break;
            case 'preferences':
                await savePreferences();
                break;
            default:
                showToast('Nothing to save in this section', 'info');
        }
    }

    // Save Personal Information
    async function savePersonalInfo() {
        const saveButton = document.querySelector('.settings-actions .btn-primary');

        try {
            const formData = {
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                job_title: document.getElementById('jobTitle').value,
                country: document.getElementById('country').value
            };

            setButtonLoading(saveButton, true, 'Saving...');

            const response = await fetch('/api/user/settings/personal', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                showToast('Personal information updated successfully', 'success');
                await loadUserSettings();
            } else {
                throw new Error(result.message || 'Failed to update');
            }
        } catch (error) {
            console.error('Error saving personal info:', error);
            showToast('Failed to update personal information', 'error');
        } finally {
            setButtonLoading(saveButton, false);
        }
    }
    // Save Company Information
    async function saveCompanyInfo() {
        try {
            const formData = {
                industry: document.getElementById('industry').value,
                company_size: document.getElementById('companySize').value,
                website: document.getElementById('website').value
            };

            showLoading(true);

            const response = await fetch('/api/user/settings/company', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                showToast('Company information updated successfully', 'success');
            } else {
                throw new Error(result.message || 'Failed to update');
            }

        } catch (error) {
            console.error('Error saving company info:', error);
            showToast('Failed to update company information', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Save Security Settings (Password)
    async function saveSecuritySettings() {
        const currentPass = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPassword').value;
        const confirmPass = document.getElementById('confirmPassword').value;

        // If password fields are filled, validate and save password
        if (currentPass || newPass || confirmPass) {
            if (!currentPass) {
                showToast('Please enter your current password', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showToast('New passwords do not match', 'error');
                return;
            }

            if (newPass.length < 8) {
                showToast('Password must be at least 8 characters', 'error');
                return;
            }

            try {
                showLoading(true);

                const response = await fetch('/api/user/settings/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        current_password: currentPass,
                        new_password: newPass,
                        confirm_password: confirmPass
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    showToast('Password updated successfully', 'success');
                } else {
                    throw new Error(result.message || 'Failed to update password');
                }

            } catch (error) {
                console.error('Error changing password:', error);
                showToast(error.message || 'Failed to change password', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Save 2FA setting
        try {
            showLoading(true);

            const response = await fetch('/api/user/settings/security', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    two_factor_enabled: document.getElementById('twoFA').checked
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast('Security settings updated', 'success');
            }

        } catch (error) {
            console.error('Error updating security settings:', error);
        } finally {
            showLoading(false);
        }
    }

    // Save Preferences
    async function savePreferences() {
        try {
            const formData = {
                language_preference: document.getElementById('languagePreference').value,
                timezone: document.getElementById('timezone').value,
                email_notifications: document.getElementById('emailNotifications').checked,
                newsletter: document.getElementById('newsletter').checked,
                sms_notifications: document.getElementById('smsNotifications').checked
            };

            showLoading(true);

            const response = await fetch('/api/user/settings/preferences', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                showToast('Preferences updated successfully', 'success');
            } else {
                throw new Error(result.message || 'Failed to update');
            }

        } catch (error) {
            console.error('Error saving preferences:', error);
            showToast('Failed to update preferences', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Handle CR Document Upload
    document.getElementById('crUpload')?.addEventListener('change', async function (e) {
        if (!e.target.files[0]) return;

        try {
            showLoading(true);

            const formData = new FormData();
            formData.append('file', e.target.files[0]);

            const response = await fetch('/api/user/settings/upload-document?document_type=cr', {
                method: 'POST',
                credentials: 'include',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showToast('CR document uploaded successfully', 'success');
            } else {
                throw new Error(result.message || 'Upload failed');
            }

        } catch (error) {
            console.error('Error uploading CR:', error);
            showToast('Failed to upload CR document', 'error');
        } finally {
            showLoading(false);
        }
    });

    // Handle QID Document Upload
    document.getElementById('qidUpload')?.addEventListener('change', async function (e) {
        if (!e.target.files[0]) return;

        try {
            showLoading(true);

            const formData = new FormData();
            formData.append('file', e.target.files[0]);

            const response = await fetch('/api/user/settings/upload-document?document_type=qid', {
                method: 'POST',
                credentials: 'include',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showToast('QID document uploaded successfully', 'success');
            } else {
                throw new Error(result.message || 'Upload failed');
            }

        } catch (error) {
            console.error('Error uploading QID:', error);
            showToast('Failed to upload QID document', 'error');
        } finally {
            showLoading(false);
        }
    });

    // Show Loading Overlay
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.add('active');
        } else {
            overlay.classList.remove('active');
        }
    }

    // Show Toast Notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--info-color)'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001;
        animation: slideInUp 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        max-width: 400px;
    `;

        const icon = type === 'success' ? 'check' : type === 'error' ? 'x' : 'info-circle';
        toast.innerHTML = `<i class="ti ti-${icon}"></i> ${message}`;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
`;
    document.head.appendChild(style);



</script>

<script>


    // ===== LOADING UTILITY FUNCTIONS =====
    function setButtonLoading(button, loading, loadingText = 'Loading...') {
        if (!button) return;

        if (loading) {
            button.dataset.originalHtml = button.innerHTML;
            button.dataset.originalDisabled = button.disabled;
            button.disabled = true;
            button.classList.add('btn-loading-text');
            button.innerHTML = `<i class="ti ti-loader" style="animation: spin 0.6s linear infinite;"></i> ${loadingText}`;
        } else {
            if (button.dataset.originalHtml) {
                button.innerHTML = button.dataset.originalHtml;
            }
            button.disabled = button.dataset.originalDisabled === 'true';
            button.classList.remove('btn-loading-text');
            delete button.dataset.originalHtml;
            delete button.dataset.originalDisabled;
        }
    }
    // Check if user can access subscriptions
    async function checkSubscriptionAccess() {
        try {
            const response = await fetch('/api/subscriptions/access-info', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                return data.can_manage_subscriptions;
            }
            return false;
        } catch (error) {
            console.error('Error checking subscription access:', error);
            return false;
        }
    }

    // Initialize subscription navigation
    document.addEventListener('DOMContentLoaded', async () => {
        const canManage = await checkSubscriptionAccess();

        // Only add navigation item if user can manage subscriptions
        if (canManage) {
            const subscriptionsNavItem = `
                <button class="settings-nav-item" data-section="subscriptions" onclick="switchSection('subscriptions')">
                    <i class="ti ti-packages"></i>
                    <span>Module Subscriptions</span>
                </button>
            `;

            const nav = document.querySelector('.settings-nav');
            if (nav) {
                nav.insertAdjacentHTML('beforeend', subscriptionsNavItem);
            }
        }

        // Override switchSection to handle loading
        const originalSwitchSection = window.switchSection;
        window.switchSection = async function (sectionName) {
            originalSwitchSection(sectionName);
            if (sectionName === 'subscriptions') {
                const canManage = await checkSubscriptionAccess();
                if (canManage) {
                    document.getElementById('subscriptionAccessCheck').style.display = 'none';
                    document.getElementById('modulesContainer').style.display = 'grid';
                    loadModuleSubscriptions();
                } else {
                    document.getElementById('subscriptionAccessCheck').style.display = 'block';
                    document.getElementById('modulesContainer').style.display = 'none';
                }
            }
        };
    });

    // Module definitions with icons and features
    const moduleData = {
        'clm': {
            icon: 'ti ti-file-text',
            title: 'Contract Lifecycle Management',
            description: 'Complete contract management from creation to execution',
            features: [
                'Contract creation & templates',
                'Version control & tracking',
                'Digital signatures',
                'Approval workflows'
            ]
        },
        'correspondence': {
            icon: 'ti ti-mail',
            title: 'Correspondence Management',
            description: 'Manage all project communications and documentation',
            features: [
                'Email integration',
                'Document tracking',
                'Response management',
                'Audit trails'
            ]
        },
        'obligations': {
            icon: 'ti ti-list-check',
            title: 'Obligations Tracking',
            description: 'Track and manage contractual obligations and deliverables',
            features: [
                'Automated reminders',
                'Deadline tracking',
                'Progress monitoring',
                'Escalation alerts'
            ]
        },
        'risk': {
            icon: 'ti ti-alert-triangle',
            title: 'Risk Management',
            description: 'Identify, assess, and mitigate project risks',
            features: [
                'Risk assessment',
                'Mitigation planning',
                'Real-time monitoring',
                'Compliance tracking'
            ]
        },
        'reports': {
            icon: 'ti ti-chart-bar',
            title: 'Reports & Analytics',
            description: 'Comprehensive reporting and business intelligence',
            features: [
                'Custom dashboards',
                'Data visualization',
                'Export capabilities',
                'Scheduled reports'
            ]
        },
        'blockchain': {
            icon: 'ti ti-lock',
            title: 'Blockchain Audit Trail',
            description: 'Immutable record-keeping with blockchain technology',
            features: [
                'Tamper-proof records',
                'Hyperledger Fabric',
                'Compliance verification',
                'Digital certificates'
            ]
        },
        'expert': {
            icon: 'ti ti-users',
            title: 'Expert Consultation',
            description: 'Connect with legal and technical experts',
            features: [
                'Video consultation',
                'Chat support',
                'Document review',
                'Expert advice'
            ]
        }
    };

    // Subscribe to module
    async function subscribeToModule(moduleCode, button) {
        try {
            button.disabled = true;
            button.innerHTML = '<i class="ti ti-loader"></i> Subscribing...';

            const response = await fetch(`/api/subscriptions/subscribe/${moduleCode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast(data.message || 'Successfully subscribed!', 'success');
                setTimeout(() => loadModuleSubscriptions(), 500);
            } else {
                throw new Error(data.detail || 'Subscription failed');
            }
        } catch (error) {
            console.error('Subscribe error:', error);
            showToast(error.message || 'Failed to subscribe', 'error');
            button.disabled = false;
            button.innerHTML = '<i class="ti ti-plus"></i> Subscribe';
        }
    }

    // Unsubscribe from module
    async function unsubscribeFromModule(moduleCode, button) {
        if (!confirm('Are you sure you want to unsubscribe from this module? You will lose access to its features.')) {
            return;
        }

        try {
            button.disabled = true;
            button.innerHTML = '<i class="ti ti-loader"></i> Unsubscribing...';

            const response = await fetch(`/api/subscriptions/unsubscribe/${moduleCode}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast(data.message || 'Successfully unsubscribed', 'success');
                setTimeout(() => loadModuleSubscriptions(), 500);
            } else {
                throw new Error(data.detail || 'Unsubscribe failed');
            }
        } catch (error) {
            console.error('Unsubscribe error:', error);
            showToast(error.message || 'Failed to unsubscribe', 'error');
            button.disabled = false;
            button.innerHTML = '<i class="ti ti-trash"></i> Unsubscribe';
        }
    }

    // Create module card
    function createModuleCard(module, isSubscribed) {
        const info = moduleData[module.code] || {
            icon: 'ti ti-package',
            title: module.name,
            description: module.description || 'Module description',
            features: []
        };

        const card = document.createElement('div');
        card.className = `module-card ${isSubscribed ? 'subscribed' : ''}`;
        card.innerHTML = `
            <div class="module-header">
                <div class="module-icon">
                    <i class="${info.icon}"></i>
                </div>
                <span class="subscription-badge">
                    ${isSubscribed ? 'Active' : 'Available'}
                </span>
            </div>
            <h3 class="module-title">${info.title}</h3>
            <p class="module-description">${info.description}</p>
            ${info.features.length > 0 ? `
                <ul class="module-features">
                    ${info.features.map(f => `<li>${f}</li>`).join('')}
                </ul>
            ` : ''}
            <button 
                class="module-action-btn ${isSubscribed ? 'unsubscribe-btn' : 'subscribe-btn'}" 
                onclick="${isSubscribed ? 'unsubscribeFromModule' : 'subscribeToModule'}('${module.code}', this)"
            >
                <i class="ti ti-${isSubscribed ? 'trash' : 'plus'}"></i>
                ${isSubscribed ? 'Unsubscribe' : 'Subscribe'}
            </button>
        `;
        return card;
    }

    // Load module subscriptions
    async function loadModuleSubscriptions() {
        const container = document.getElementById('modulesContainer');

        try {
            const response = await fetch('/api/subscriptions/modules', {
                credentials: 'include'
            });

            if (!response.ok) {
                if (response.status === 403) {
                    // User is internal - show access restricted message
                    container.style.display = 'none';
                    document.getElementById('subscriptionAccessCheck').style.display = 'block';
                    return;
                }
                throw new Error('Failed to load modules');
            }

            const data = await response.json();

            if (data.success && data.modules) {
                container.innerHTML = '';
                container.className = 'modules-grid';
                container.style.display = 'grid';

                data.modules.forEach(module => {
                    const card = createModuleCard(module, module.subscribed);
                    container.appendChild(card);
                });
            } else {
                throw new Error('Invalid response format');
            }
        } catch (error) {
            console.error('Load modules error:', error);
            container.innerHTML = `
                <div class="loading-state">
                    <p style="color: var(--danger-color);">Failed to load modules. Please refresh the page.</p>
                </div>
            `;
            showToast('Failed to load modules', 'error');
        }
    }
</script>

<script>
    // =====================================================
    // MODAL FUNCTIONS - Replace your existing modal JavaScript with this
    // =====================================================

    let currentLicenseType = 'individual';
    let currentPricingView = 'individual';

    // Open license modal
    function openLicenseModal() {
        console.log('Opening license modal...'); // Debug

        const modal = document.getElementById('licenseModal');
        if (!modal) {
            console.error('Modal element not found!');
            alert('Error: Modal not found. Please refresh the page.');
            return;
        }

        // Add active class to show modal
        modal.classList.add('active');

        // Prevent body scroll
        document.body.style.overflow = 'hidden';

        // Pre-select current license type
        const radioButton = document.querySelector(`input[name="newLicenseType"][value="${currentLicenseType}"]`);
        if (radioButton) {
            radioButton.checked = true;

            // Highlight the selected card
            document.querySelectorAll('.license-option-card').forEach(card => {
                const input = card.querySelector('input[type="radio"]');
                if (input && input.checked) {
                    card.style.borderColor = 'var(--primary-color)';
                }
            });

            updateUserOptions();
        }

        console.log('Modal opened successfully');
    }

    // Close license modal
    function closeLicenseModal() {
        console.log('Closing license modal...');

        const modal = document.getElementById('licenseModal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    // Update user options based on license type
    function updateUserOptions() {
        const selectedType = document.querySelector('input[name="newLicenseType"]:checked')?.value;
        const userSelect = document.getElementById('numberOfUsers');

        console.log('Updating user options for license type:', selectedType);

        if (!userSelect) {
            console.error('User select element not found');
            return;
        }

        if (selectedType === 'individual') {
            // Individual: 1-5 users
            userSelect.innerHTML = `
            <option value="">Select Number of Users</option>
            <option value="1">1 User</option>
            <option value="2">2 Users</option>
            <option value="3">3 Users</option>
            <option value="4">4 Users</option>
            <option value="5">5 Users</option>
        `;
        } else if (selectedType === 'corporate') {
            // Corporate: 6-20 users
            userSelect.innerHTML = `
            <option value="">Select Number of Users</option>
            <option value="6">6 Users</option>
            <option value="7">7 Users</option>
            <option value="8">8 Users</option>
            <option value="9">9 Users</option>
            <option value="10">10 Users</option>
            <option value="15">15 Users</option>
            <option value="20">20 Users</option>
        `;
        }
    }

    // Update license
    async function updateLicense() {
        const licenseType = document.querySelector('input[name="newLicenseType"]:checked')?.value;
        const numberOfUsers = parseInt(document.getElementById('numberOfUsers').value);

        if (!licenseType) {
            showToast('Please select a license type', 'error');
            return;
        }

        if (!numberOfUsers) {
            showToast('Please select number of users', 'error');
            return;
        }

        const updateButton = document.querySelector('#licenseModal .btn-primary');

        try {
            setButtonLoading(updateButton, true, 'Updating License...');

            const response = await fetch('/api/v1/users/license/update', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                credentials: 'include',
                body: JSON.stringify({
                    license_type: licenseType,
                    number_of_users: numberOfUsers
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast(data.message || 'License updated successfully', 'success');
                closeLicenseModal();

                if (typeof loadLicenseInfo === 'function') {
                    await loadLicenseInfo();
                }
                if (typeof loadModules === 'function') {
                    await loadModules(licenseType);
                }
            } else {
                showToast(data.message || 'Failed to update license', 'error');
            }
        } catch (error) {
            console.error('Error updating license:', error);
            showToast('Failed to update license. Please try again.', 'error');
        } finally {
            setButtonLoading(updateButton, false);
        }
    }
    // Load license info
    async function loadLicenseInfo() {
        try {
            const response = await fetch('/api/v1/users/license/info', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.license) {
                const license = data.license;
                currentLicenseType = license.type;

                // Update license display
                document.getElementById('licenseType').textContent =
                    license.type === 'individual' ? 'Individual License' : 'Corporate License';

                document.getElementById('licenseDescription').textContent =
                    license.type === 'individual'
                        ? 'Perfect for freelancers and small teams'
                        : 'For growing businesses and enterprises';

                document.getElementById('contractLimit').textContent = license.max_contracts;
                document.getElementById('userSeats').textContent = license.number_of_users + ' Users';
                document.getElementById('activeUsers').textContent =
                    `${license.active_users} / ${license.max_users}`;

                if (license.expiry) {
                    const expiryDate = new Date(license.expiry);
                    document.getElementById('renewalDate').textContent =
                        expiryDate.toLocaleDateString();
                } else {
                    document.getElementById('renewalDate').textContent = 'No expiry date';
                }

                // Show license switcher if needed (uncomment if you want to show for all users)
                // document.getElementById('licenseSwitcher').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading license info:', error);
            showToast('Failed to load license information', 'error');
        }
    }

    // Load modules with pricing
    async function loadModules(licenseType = null) {
        const viewType = licenseType || currentPricingView;

        try {
            const response = await fetch(`/api/v1/users/license/modules/pricing?license_type=${viewType}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.modules) {
                renderModules(data.modules);
            }
        } catch (error) {
            console.error('Error loading modules:', error);
            showToast('Failed to load modules', 'error');
        }
    }

    // Render modules
   function renderModules(modules) {
    const container = document.getElementById('modulesContainer');
    
    if (!modules || modules.length === 0) {
        container.innerHTML = `
            <div class="loading-state">
                <i class="ti ti-package"></i>
                <p>No modules available</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = modules.map(module => `
        <div class="module-card ${module.is_subscribed ? 'subscribed' : ''}">
            <div class="module-header">
                <div class="module-icon">
                    <i class="${module.icon}"></i>
                </div>
                <span class="subscription-badge ${module.is_subscribed ? 'active' : 'inactive'}">
                    ${module.is_subscribed ? 'Subscribed' : 'Not Subscribed'}
                </span>
            </div>
            
            <h3 class="module-title">${module.module_name}</h3>
            <p class="module-description">${module.module_description}</p>
            
            <div class="module-pricing">
                <span class="price-amount">${module.currency} ${module.price_monthly.toFixed(2)}</span>
                <span class="price-period">/ month</span>
                <span class="text-muted" style="margin-left: auto; font-size: 0.75rem;">
                    or ${module.currency} ${module.price_annual.toFixed(2)}/year
                </span>
            </div>
            
            <div class="module-actions">
                <button class="module-action-btn ${module.is_subscribed ? 'unsubscribe-btn' : 'subscribe-btn'}" 
                        data-module="${module.module_code}" 
                        data-action="${module.is_subscribed ? 'unsubscribe' : 'subscribe'}">
                    <i class="ti ti-${module.is_subscribed ? 'x' : 'plus'}"></i>
                    ${module.is_subscribed ? 'Unsubscribe' : 'Subscribe'}
                </button>
            </div>
        </div>
    `).join('');
    
    // Add event listeners
    container.querySelectorAll('.module-action-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const moduleCode = this.dataset.module;
            const action = this.dataset.action;
            toggleSubscription(moduleCode, action, this);
        });
    });
}
    // Switch pricing view
    function switchPricingView(licenseType) {
        currentPricingView = licenseType;

        // Update active button
        document.querySelectorAll('.license-toggle-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeBtn = document.querySelector(`[data-license="${licenseType}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }

        // Reload modules with new pricing
        loadModules(licenseType);
    }

    // Toggle module subscription
    async function toggleSubscription(moduleCode, action, buttonElement) {
        if (!buttonElement) {
            buttonElement = event?.target?.closest('button');
        }

        try {
            if (buttonElement) {
                setButtonLoading(buttonElement, true, action === 'subscribe' ? 'Subscribing...' : 'Unsubscribing...');
            }

            const response = await fetch('/api/v1/users/modules/subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                credentials: 'include',
                body: JSON.stringify({
                    module_code: moduleCode,
                    action: action
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => {
                    loadModules();
                }, 500);
            } else {
                showToast(data.message || 'Failed to update subscription', 'error');
                if (buttonElement) {
                    setButtonLoading(buttonElement, false);
                }
            }
        } catch (error) {
            console.error('Error toggling subscription:', error);
            showToast('Failed to update subscription', 'error');
            if (buttonElement) {
                setButtonLoading(buttonElement, false);
            }
        }
    }

    // =====================================================
    // EVENT LISTENERS - Initialize when DOM is ready
    // =====================================================

    document.addEventListener('DOMContentLoaded', function () {
        console.log('Initializing license modal...');

        // Load initial data
        loadLicenseInfo();
        loadModules();

        // Set up radio button listeners
        const radioButtons = document.querySelectorAll('input[name="newLicenseType"]');
        radioButtons.forEach(radio => {
            radio.addEventListener('change', function () {
                updateUserOptions();

                // Update card styling
                document.querySelectorAll('.license-option-card').forEach(card => {
                    const input = card.querySelector('input[type="radio"]');
                    if (input === this) {
                        card.style.borderColor = 'var(--primary-color)';
                    } else {
                        card.style.borderColor = 'var(--border-color)';
                    }
                });
            });
        });

        // Click on card to select radio
        document.querySelectorAll('.license-option-card').forEach(card => {
            card.addEventListener('click', function (e) {
                // Don't trigger if clicking the radio directly
                if (e.target.type === 'radio') return;

                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                }
            });
        });

        // Close modal on ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeLicenseModal();
            }
        });

        // Close modal on backdrop click
        const modal = document.getElementById('licenseModal');
        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeLicenseModal();
                }
            });
        }

        console.log('License modal initialized successfully');
    });

    // =====================================================
    // TEST FUNCTION - Use in browser console to debug
    // =====================================================

    window.testModal = function () {
        console.log('Testing modal...');
        console.log('Modal element:', document.getElementById('licenseModal'));
        console.log('Button element:', document.querySelector('button[onclick*="openLicenseModal"]'));
        openLicenseModal();
    };
</script>

{% endblock %}