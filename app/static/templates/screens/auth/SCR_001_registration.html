{% extends "auth-base.html" %}

{% block title %}CALIM360 - User Registration{% endblock %}

{% block extra_css %}
<style>
    /* Progress Steps */
    .progress-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .progress-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--border-color);
        z-index: 0;
    }

    .progress-line {
        position: absolute;
        top: 20px;
        left: 0;
        height: 2px;
        background: var(--primary-color);
        z-index: 0;
        transition: width 0.5s ease;
        width: 0%;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
        flex: 1;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--white);
        border: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: var(--transition);
        margin-bottom: 0.5rem;
    }

    .step-circle i {
        font-size: 18px;
        display: none;
    }

    .step.active .step-circle {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: var(--white);
    }

    .step.completed .step-circle {
        background: var(--success-color);
        border-color: var(--success-color);
        color: var(--white);
    }

    .step.completed .step-circle i {
        display: block;
    }

    .step.completed .step-circle .step-number {
        display: none;
    }

    .step-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-align: center;
    }

    /* Form Steps Content */
    .form-step {
        display: none;
        animation: fadeIn 0.5s ease;
        max-width: 900px;
        margin: 0 auto;
    }

    .form-step.active {
        display: block;
    }

    .form-row.three-cols {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .form-label i {
        font-size: 16px;
        color: var(--text-muted);
    }

    /* File Upload */
    .file-upload {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        border: 2px dashed var(--border-color);
        border-radius: 10px;
        background: var(--background-light);
        cursor: pointer;
        transition: var(--transition);
    }

    .file-upload:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    .file-upload.has-files {
        background: var(--success-bg);
        border-color: var(--success-color);
    }

    .file-upload input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .file-upload-content {
        text-align: center;
    }

    .upload-icon {
        font-size: 48px;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .file-list {
        margin-top: 1rem;
        text-align: left;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--white);
        border-radius: 5px;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .file-item i {
        color: var(--success-color);
    }

    /* License Type Cards */
    .license-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .license-card {
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 1.5rem;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .license-card:hover {
        border-color: var(--secondary-color);
        box-shadow: var(--shadow-md);
    }

    .license-card.selected {
        border-color: var(--primary-color);
        background: var(--info-bg);
    }

    .license-card input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .license-title {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .license-title i {
        color: var(--primary-color);
    }

    .license-description {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .license-price {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    /* Password Strength */
    .password-strength {
        margin-top: 0.5rem;
        height: 4px;
        background: var(--border-color);
        border-radius: 2px;
        overflow: hidden;
    }

    .password-strength-bar {
        height: 100%;
        transition: var(--transition);
        border-radius: 2px;
    }

    .password-strength-bar.weak {
        width: 33%;
        background: var(--danger-color);
    }

    .password-strength-bar.medium {
        width: 66%;
        background: var(--warning-color);
    }

    .password-strength-bar.strong {
        width: 100%;
        background: var(--success-color);
    }

    .password-requirements {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 0.5rem;
        box-shadow: var(--shadow-md);
        z-index: 10;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }

    .password-requirements.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .password-requirements::before {
        content: '';
        position: absolute;
        top: -6px;
        left: 20px;
        width: 12px;
        height: 12px;
        background: var(--white);
        border-left: 1px solid var(--border-color);
        border-top: 1px solid var(--border-color);
        transform: rotate(45deg);
    }

    .requirements-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .requirements-title i {
        color: var(--primary-color);
        font-size: 16px;
    }

    .requirement {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.813rem;
        color: var(--text-muted);
        transition: var(--transition);
    }

    .requirement:last-child {
        margin-bottom: 0;
    }

    .requirement.met {
        color: var(--success-color);
    }

    .requirement i {
        font-size: 14px;
        flex-shrink: 0;
    }

    /* Ensure parent form-group is positioned relative */
    .form-group {
        position: relative;
    }

    /* Two-Factor Auth Toggle */
    .two-factor-toggle {
        background: var(--background-light);
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 1rem 0;
    }

    .toggle-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .toggle-icon {
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        color: var(--white);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toggle-text h4 {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .toggle-text p {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .switch {
        position: relative;
        width: 50px;
        height: 26px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--border-color);
        transition: var(--transition);
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: var(--white);
        transition: var(--transition);
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: var(--primary-color);
    }

    input:checked+.slider:before {
        transform: translateX(24px);
    }

    /* CAPTCHA */
    .captcha-container {
        background: var(--background-light);
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .captcha-image {
        background: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 0.5rem 1rem;
        font-family: monospace;
        font-size: 1.5rem;
        letter-spacing: 5px;
        user-select: none;
        background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0),
            linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
    }

    .captcha-refresh {
        background: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: 5px;
        padding: 0.5rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .captcha-refresh:hover {
        background: #1e4ea8;
    }

    /* Tooltips */
    .tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
        color: var(--primary-color);
        margin-left: 0.25rem;
    }

    .tooltip i {
        font-size: 14px;
    }

    .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: var(--text-color);
        color: var(--white);
        text-align: center;
        border-radius: 6px;
        padding: 0.5rem;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.75rem;
    }

    .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .progress-steps {
            font-size: 0.7rem;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            font-size: 0.875rem;
        }

        .license-cards {
            grid-template-columns: 1fr;
        }
    }

    .module-banner {
        background-color: #e7f3ff;
        color: #004085;
        padding: 15px 20px;
        text-align: center;
        border-radius: 6px;
        border-left: 4px solid #0d6efd;
        margin-bottom: 25px;
        font-size: 16px;
    }

    .module-banner i {
        margin-right: 8px;
        color: #0d6efd;
    }

    .module-banner strong {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Main Registration Container -->
<div class="registration-container">



    <div class="registration-card">

       
        <div class="form-container">
            <div class="form-header">
                <h1 class="form-title">
                    Create Your Account
                </h1>
                <!-- <p class="form-subtitle">Join Smart CLM to streamline your contract management</p> -->
            </div>

             <!-- Only shows banner IF module_name exists -->
        {% if module_name %}
        <div class="module-banner" role="alert">
            <i class="ti ti-info-circle me-2"></i>
            <strong>You're signing up for:</strong> {{ module_name }}
        </div>
        {% endif %}

            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="progress-line" id="progressLine"></div>
                <div class="step active" data-step="1">
                    <div class="step-circle">
                        <span class="step-number">1</span>
                        <i class="ti ti-check"></i>
                    </div>
                    <span class="step-label">User Info</span>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle">
                        <span class="step-number">2</span>
                        <i class="ti ti-check"></i>
                    </div>
                    <span class="step-label">Company Details</span>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle">
                        <span class="step-number">3</span>
                        <i class="ti ti-check"></i>
                    </div>
                    <span class="step-label">Preferences</span>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle">
                        <span class="step-number">4</span>
                        <i class="ti ti-check"></i>
                    </div>
                    <span class="step-label">Security</span>
                </div>
                <div class="step" data-step="5">
                    <div class="step-circle">
                        <span class="step-number">5</span>
                        <i class="ti ti-check"></i>
                    </div>
                    <span class="step-label">Verification</span>
                </div>
            </div>

            <!-- Alert Messages -->
            <div class="alert success" id="successAlert" style="display: none;">
                <i class="ti ti-circle-check"></i>
                <span>Registration successful! Check your email for verification.</span>
            </div>

            <div class="alert error" id="errorAlert" style="display: none;">
                <i class="ti ti-alert-circle"></i>
                <span id="errorMessage">Please correct the errors below.</span>
            </div>

            <!-- Registration Form -->
            <form id="registrationForm">

                <!-- Step 1: User Information -->
                <div class="form-step active" data-step="1">
                    <!-- <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-user"></i>
                        </div>
                        <h2 class="section-title">User Information</h2>
                    </div> -->

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                First Name <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" name="firstName" required>
                            <i class="ti ti-user input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please enter your first name
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Last Name <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" name="lastName" required>
                            <i class="ti ti-user input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please enter your last name
                            </span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Email Address <span class="required">*</span>
                                <span class="tooltip">
                                    <i class="ti ti-info-circle"></i>
                                    <span class="tooltip-text">Used for account verification and communication</span>
                                </span>
                            </label>
                            <input type="email" class="form-input" name="email" required>
                            <i class="ti ti-mail input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please enter a valid email address
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Phone Number
                                <span class="tooltip">
                                    <i class="ti ti-info-circle"></i>
                                    <span class="tooltip-text">Optional, but useful for support</span>
                                </span>
                            </label>
                            <input type="tel" class="form-input" name="phone" placeholder="+974 XXXX XXXX">
                            <i class="ti ti-phone input-icon"></i>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Password <span class="required">*</span>
                            </label>
                            <input type="password" class="form-input" name="password" id="password" required>
                            <i class="ti ti-lock input-icon"></i>
                            <div class="password-strength">
                                <div class="password-strength-bar" id="strengthBar"></div>
                            </div>
                            <div class="password-requirements" id="passwordRequirements">
                                <div class="requirements-title">
                                    <i class="ti ti-shield-check"></i>
                                    Password Requirements
                                </div>
                                <div class="requirement" id="req-length">
                                    <i class="ti ti-circle"></i>
                                    At least 8 characters
                                </div>
                                <div class="requirement" id="req-uppercase">
                                    <i class="ti ti-circle"></i>
                                    One uppercase letter
                                </div>
                                <div class="requirement" id="req-number">
                                    <i class="ti ti-circle"></i>
                                    One number
                                </div>
                                <div class="requirement" id="req-special">
                                    <i class="ti ti-circle"></i>
                                    One special character
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Confirm Password <span class="required">*</span>
                            </label>
                            <input type="password" class="form-input" name="confirmPassword" required>
                            <i class="ti ti-lock-check input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Passwords do not match
                            </span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Job Title <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" name="jobTitle" required>
                            <i class="ti ti-briefcase input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please enter your job title
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                User Type <span class="required">*</span>
                            </label>
                            <select class="form-select" name="userType" required>
                                <option value="">Select User Type</option>
                                <option value="client">Client</option>
                                <option value="contractor">Contractor</option>
                                <option value="subcontractor">Sub-Contractor</option>
                                <option value="consultant">Consultant</option>
                                <option value="supplier">Supplier</option>
                                <option value="pmo">PMO</option>
                            </select>
                            <i class="ti ti-users input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please select user type
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Company Information -->
                <div class="form-step" data-step="2">
                    <!-- <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-building"></i>
                        </div>
                        <h2 class="section-title">Company Information</h2>
                    </div> -->

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Company Name <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" name="companyName" required>
                            <i class="ti ti-building input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please enter company name
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Industry <span class="required">*</span>
                            </label>
                            <select class="form-select" name="industry" required>
                                <option value="">Select Industry</option>
                                <option value="construction">Construction</option>
                                <option value="oil-gas">Oil & Gas</option>
                                <option value="technology">Technology</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="finance">Finance</option>
                                <option value="retail">Retail</option>
                                <option value="manufacturing">Manufacturing</option>
                                <option value="education">Education</option>
                                <option value="government">Government</option>
                                <option value="other">Other</option>
                            </select>
                            <i class="ti ti-category input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please select an industry
                            </span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Company Size <span class="required">*</span>
                            </label>
                            <select class="form-select" name="companySize" required>
                                <option value="">Select Company Size</option>
                                <option value="1-10">1-10 employees</option>
                                <option value="11-50">11-50 employees</option>
                                <option value="51-200">51-200 employees</option>
                                <option value="201-500">201-500 employees</option>
                                <option value="501-1000">501-1000 employees</option>
                                <option value="1000+">1000+ employees</option>
                            </select>
                            <i class="ti ti-users-group input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please select company size
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Company Website
                            </label>
                            <input type="url" class="form-input" name="website" placeholder="https://example.com">
                            <i class="ti ti-world input-icon"></i>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Country/Region <span class="required">*</span>
                            </label>
                            <select class="form-select" name="country" required>
                                <option value="">Select Country</option>
                                <option value="QA">Qatar</option>
                                <option value="AE">United Arab Emirates</option>
                                <option value="SA">Saudi Arabia</option>
                                <option value="KW">Kuwait</option>
                                <option value="BH">Bahrain</option>
                                <option value="OM">Oman</option>
                                <option value="US">United States</option>
                                <option value="GB">United Kingdom</option>
                                <option value="other">Other</option>
                            </select>
                            <i class="ti ti-map-pin input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please select country
                            </span>
                        </div>
                    </div>

                    <div class="section-header" style="margin-top: 2rem;">
                        <div class="section-icon">
                            <i class="ti ti-id"></i>
                        </div>
                        <h3 class="section-title">Authorized Representative</h3>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Authorized Representative Name
                            </label>
                            <input type="text" class="form-input" name="authRepName">
                            <i class="ti ti-user-check input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Authorized Rep QID
                            </label>
                            <input type="text" class="form-input" name="authRepQID" placeholder="XXXXXXXXXXX">
                            <i class="ti ti-id-badge input-icon"></i>
                        </div>
                    </div>

                    <div class="form-row three-cols">
                        <div class="form-group">
                            <label class="form-label">
                                CR Number <span class="required">*</span>
                                <span class="tooltip">
                                    <i class="ti ti-info-circle"></i>
                                    <span class="tooltip-text">Commercial Registration Number</span>
                                </span>
                            </label>
                            <input type="text" class="form-input" name="crNumber" required>
                            <i class="ti ti-certificate input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please enter CR number
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                CR Expiry Date <span class="required">*</span>
                            </label>
                            <input type="date" class="form-input" name="crExpiryDate" id="crExpiryDate" required>
                            <i class="ti ti-calendar input-icon"></i>
                            <span class="error-message" id="crExpiryError">
                                <i class="ti ti-alert-circle"></i>
                                CR has expired
                            </span>
                        </div>
                        <div class="form-group">
                            <div class="alert warning" id="crExpiryWarning" style="display: none;">
                                <i class="ti ti-alert-triangle"></i>
                                CR has expired!
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="ti ti-upload"></i>
                            Upload CR/QID Documents
                            <span class="tooltip">
                                <i class="ti ti-info-circle"></i>
                                <span class="tooltip-text">Upload Commercial Registration and QID documents</span>
                            </span>
                        </label>
                        <div class="file-upload" id="documentUpload">
                            <input type="file" name="documents" id="documents" multiple accept=".pdf,.jpg,.jpeg,.png">
                            <div class="file-upload-content">
                                <i class="ti ti-cloud-upload upload-icon"></i>
                                <p>Click to upload or drag and drop</p>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                    PDF, JPG, PNG up to 10MB each
                                </p>
                                <div class="file-list" id="fileList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Account Preferences -->
                <div class="form-step" data-step="3">
                    <!-- <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-settings"></i>
                        </div>
                        <h2 class="section-title">Account Preferences</h2>
                    </div> -->

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Time Zone <span class="required">*</span>
                            </label>
                            <select class="form-select" name="timeZone" required>
                                <option value="">Select Time Zone</option>
                                <option value="UTC+3">UTC+3 (Qatar/Saudi Arabia)</option>
                                <option value="UTC+4">UTC+4 (Dubai)</option>
                                <option value="UTC+0">UTC+0 (London)</option>
                                <option value="UTC-5">UTC-5 (New York)</option>
                                <option value="UTC-8">UTC-8 (Los Angeles)</option>
                                <option value="UTC+8">UTC+8 (Singapore)</option>
                            </select>
                            <i class="ti ti-clock input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please select time zone
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Language Preference <span class="required">*</span>
                            </label>
                            <select class="form-select" name="language" required>
                                <option value="">Select Language</option>
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                            </select>
                            <i class="ti ti-language input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please select language preference
                            </span>
                        </div>
                    </div>

                    <div class="section-header" style="margin-top: 2rem;">
                        <div class="section-icon">
                            <i class="ti ti-license"></i>
                        </div>
                        <h3 class="section-title">License Type</h3>
                    </div>

                    <div class="license-cards">
                        <div class="license-card" onclick="selectLicense('individual')">
                            <input type="radio" name="licenseType" value="individual" id="individualLicense">
                            <label for="individualLicense">
                                <div class="license-title">
                                    <i class="ti ti-user"></i>
                                    Individual License
                                </div>
                                <div class="license-description">
                                    Perfect for freelancers and small teams
                                </div>
                                <ul style="font-size: 0.875rem; color: var(--text-muted); margin: 0.5rem 0;">
                                    <li>Up to 10 contracts</li>
                                    <li>Basic features</li>
                                    <li>Email support</li>
                                </ul>
                                <!-- <div class="license-price">$29/month</div> -->
                            </label>
                        </div>
                        <div class="license-card" onclick="selectLicense('corporate')">
                            <input type="radio" name="licenseType" value="corporate" id="corporateLicense">
                            <label for="corporateLicense">
                                <div class="license-title">
                                    <i class="ti ti-building"></i>
                                    Corporate License
                                </div>
                                <div class="license-description">
                                    For growing businesses and enterprises
                                </div>
                                <ul style="font-size: 0.875rem; color: var(--text-muted); margin: 0.5rem 0;">
                                    <li>Unlimited contracts</li>
                                    <li>Advanced features</li>
                                    <li>Priority support</li>
                                    <li>5+ users included</li>
                                </ul>
                                <!-- <div class="license-price">$199/month</div> -->
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Number of Users <span class="required">*</span>
                            </label>
                            <select class="form-select" name="numberOfUsers" required>
                                <option value="">Select Number of Users</option>
                                <option value="1">1 User</option>
                                <option value="2">2 Users</option>
                                <option value="3">3 Users</option>
                                <option value="4">4 Users</option>
                                <option value="5">5 Users</option>
                                <option value="6-10">6-10 Users</option>
                                <option value="11-20">11-20 Users</option>
                                <option value="20+">20+ Users</option>
                            </select>
                            <i class="ti ti-users input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please select number of users
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Security Information -->
                <div class="form-step" data-step="4">
                    <!-- <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-shield-lock"></i>
                        </div>
                        <h2 class="section-title">Security Information</h2>
                    </div> -->

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Security Question <span class="required">*</span>
                            </label>
                            <select class="form-select" name="securityQuestion" required>
                                <option value="">Select Security Question</option>
                                <option value="pet">What was the name of your first pet?</option>
                                <option value="school">What elementary school did you attend?</option>
                                <option value="city">In what city were you born?</option>
                                <option value="mother">What is your mother's maiden name?</option>
                                <option value="friend">What is your best friend's name?</option>
                                <option value="car">What was your first car?</option>
                            </select>
                            <i class="ti ti-help input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please select a security question
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Security Answer <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" name="securityAnswer" required>
                            <i class="ti ti-key input-icon"></i>
                            <span class="error-message">
                                <i class="ti ti-alert-circle"></i>
                                Please provide an answer
                            </span>
                        </div>
                    </div>

                    <div class="two-factor-toggle">
                        <div class="toggle-info">
                            <div class="toggle-icon">
                                <i class="ti ti-shield-check"></i>
                            </div>
                            <div class="toggle-text">
                                <h4>Two-Factor Authentication</h4>
                                <p>Add an extra layer of security to your account</p>
                            </div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" name="twoFactorAuth" id="twoFactorAuth">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="captcha-container">
                        <div style="flex: 1;">
                            <label class="form-label">
                                Enter CAPTCHA <span class="required">*</span>
                            </label>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div class="captcha-image" id="captchaImage">A7B9X2</div>
                                <button type="button" class="captcha-refresh" onclick="refreshCaptcha()">
                                    <i class="ti ti-refresh"></i>
                                </button>
                                <input type="text" class="form-input" name="captcha" required style="flex: 1;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Terms and Verification -->
                <div class="form-step" data-step="5">
                    <!-- <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-checkbox"></i>
                        </div>
                        <h2 class="section-title">Terms and Verification</h2>
                    </div> -->

                    <div class="checkbox-group">
                        <input type="checkbox" class="checkbox-input" id="terms" name="terms" required>
                        <label for="terms" class="checkbox-label">
                            I accept the <a href="#" onclick="showModal('terms'); return false;">Terms and
                                Conditions</a> <span class="required">*</span>
                        </label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" class="checkbox-input" id="privacy" name="privacy" required>
                        <label for="privacy" class="checkbox-label">
                            I have read and agree to the <a href="#"
                                onclick="showModal('privacy'); return false;">Privacy Policy</a> <span
                                class="required">*</span>
                        </label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" class="checkbox-input" id="dataConsent" name="dataConsent">
                        <label for="dataConsent" class="checkbox-label">
                            I consent to the processing of my personal data for the purposes described in the Privacy
                            Policy
                        </label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" class="checkbox-input" id="newsletter" name="newsletter">
                        <label for="newsletter" class="checkbox-label">
                            Subscribe to newsletter for product updates and best practices
                        </label>
                    </div>

                    <div style="background: var(--info-bg); padding: 1rem; border-radius: 10px; margin-top: 2rem;">
                        <h4 style="color: var(--info-color); margin-bottom: 0.5rem;">
                            <i class="ti ti-mail"></i>
                            Email Verification Required
                        </h4>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">
                            After registration, you will receive a confirmation email with a verification link.
                            Please check your inbox and verify your email address to activate your account.
                        </p>
                    </div>
                </div>

                <!-- Button Group -->
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                        <i class="ti ti-arrow-left"></i>
                        Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        <span class="btn-text">
                            Next
                            <i class="ti ti-arrow-right"></i>
                        </span>
                        <div class="spinner"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Form Navigation
    let currentStep = 1;
    const totalSteps = 5;
    const form = document.getElementById('registrationForm');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const progressLine = document.getElementById('progressLine');

    // Email validation helper
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(String(email).toLowerCase());
    }

    // Show alert message
    function showAlert(message, type) {
        const alertDiv = type === 'success' ? document.getElementById('successAlert') : document.getElementById('errorAlert');
        const messageSpan = type === 'error' ? document.getElementById('errorMessage') : alertDiv.querySelector('span');

        messageSpan.textContent = message;
        alertDiv.style.display = 'flex';

        // Auto-hide after 5 seconds
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 5000);

        // Scroll to top to show alert
        document.querySelector('.registration-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Step Navigation
    function showStep(step) {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(s => {
            s.classList.remove('active');
        });

        // Show current step
        document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');

        // Update progress steps
        document.querySelectorAll('.step').forEach((s, index) => {
            if (index + 1 < step) {
                s.classList.add('completed');
                s.classList.remove('active');
            } else if (index + 1 === step) {
                s.classList.add('active');
                s.classList.remove('completed');
            } else {
                s.classList.remove('active', 'completed');
            }
        });

        // Update progress line
        const progressPercentage = ((step - 1) / (totalSteps - 1)) * 100;
        progressLine.style.width = progressPercentage + '%';

        // Update buttons
        prevBtn.style.display = step === 1 ? 'none' : 'flex';

        const btnText = nextBtn.querySelector('.btn-text');
        if (step === totalSteps) {
            btnText.innerHTML = '<i class="ti ti-user-check"></i> Register';
        } else {
            btnText.innerHTML = 'Next <i class="ti ti-arrow-right"></i>';
        }

        // Scroll to top of form
        document.querySelector('.registration-card').scrollIntoView({ behavior: 'smooth' });
    }

    // Validate current step
    function validateStep(step) {
        const currentStepElement = document.querySelector(`.form-step[data-step="${step}"]`);
        const inputs = currentStepElement.querySelectorAll('.form-input[required], .form-select[required]');
        let isValid = true;
        let errorMessages = [];

        inputs.forEach(input => {
            const fieldName = input.name || 'This field';

            // Check if empty
            if (!input.value.trim()) {
                input.classList.add('error');
                const errorSpan = input.parentElement.querySelector('.error-message');
                if (errorSpan) errorSpan.style.display = 'flex';
                isValid = false;
                return; // Skip other validations if empty
            } else {
                input.classList.remove('error');
                const errorSpan = input.parentElement.querySelector('.error-message');
                if (errorSpan) errorSpan.style.display = 'none';
            }

            // Email validation
            if (input.type === 'email' && !validateEmail(input.value)) {
                input.classList.add('error');
                const errorSpan = input.parentElement.querySelector('.error-message');
                if (errorSpan) {
                    errorSpan.innerHTML = '<i class="ti ti-alert-circle"></i> Please enter a valid email address';
                    errorSpan.style.display = 'flex';
                }
                errorMessages.push('Please enter a valid email address');
                isValid = false;
            }

            // Password confirmation validation
            if (input.name === 'confirmPassword') {
                const password = document.getElementById('password').value;
                if (input.value !== password) {
                    input.classList.add('error');
                    const errorSpan = input.parentElement.querySelector('.error-message');
                    if (errorSpan) {
                        errorSpan.innerHTML = '<i class="ti ti-alert-circle"></i> Passwords do not match';
                        errorSpan.style.display = 'flex';
                    }
                    errorMessages.push('Passwords do not match');
                    isValid = false;
                } else {
                    input.classList.remove('error');
                    const errorSpan = input.parentElement.querySelector('.error-message');
                    if (errorSpan) errorSpan.style.display = 'none';
                }
            }

            // Password strength validation
            if (input.name === 'password') {
                const password = input.value;
                const requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[^a-zA-Z0-9]/.test(password)
                };

                if (!requirements.length || !requirements.uppercase || !requirements.number || !requirements.special) {
                    input.classList.add('error');
                    errorMessages.push('Password does not meet requirements');
                    isValid = false;
                }
            }
        });

        // Validate checkboxes on last step
        if (step === 5) {
            const termsCheckbox = document.getElementById('terms');
            const privacyCheckbox = document.getElementById('privacy');

            if (!termsCheckbox.checked || !privacyCheckbox.checked) {
                errorMessages.push('Please accept Terms and Conditions and Privacy Policy');
                isValid = false;
            }
        }

        // Validate license selection on step 3
        if (step === 3) {
            const licenseType = document.querySelector('input[name="licenseType"]:checked');
            if (!licenseType) {
                errorMessages.push('Please select a license type');
                isValid = false;
            }
        }

        // Validate CR expiry date on step 2
        if (step === 2) {
            const crExpiryDate = document.getElementById('crExpiryDate');
            if (crExpiryDate && crExpiryDate.value) {
                const selectedDate = new Date(crExpiryDate.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (selectedDate < today) {
                    errorMessages.push('Commercial Registration has expired');
                    isValid = false;
                }
            }
        }

        // Show error messages
        if (!isValid && errorMessages.length > 0) {
            showAlert(errorMessages[0], 'error');
        }

        return isValid;
    }

    // Next button click
    nextBtn.addEventListener('click', async function () {
        if (!validateStep(currentStep)) {
            return;
        }

        if (currentStep < totalSteps) {
            currentStep++;
            showStep(currentStep);
        } else {
            // Submit form
            await submitForm();
        }
    });

    // Previous button click
    prevBtn.addEventListener('click', function () {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });

    // Real-time password confirmation validation
    const confirmPasswordInput = document.querySelector('input[name="confirmPassword"]');
    confirmPasswordInput?.addEventListener('input', function () {
        const password = document.getElementById('password').value;
        const errorSpan = this.parentElement.querySelector('.error-message');

        if (this.value && this.value !== password) {
            this.classList.add('error');
            if (errorSpan) {
                errorSpan.innerHTML = '<i class="ti ti-alert-circle"></i> Passwords do not match';
                errorSpan.style.display = 'flex';
            }
        } else if (this.value && this.value === password) {
            this.classList.remove('error');
            if (errorSpan) errorSpan.style.display = 'none';
        }
    });

    // Also validate confirm password when main password changes
    const passwordInput = document.getElementById('password');
    passwordInput?.addEventListener('input', function () {
        const confirmPassword = document.querySelector('input[name="confirmPassword"]');
        if (confirmPassword && confirmPassword.value) {
            const errorSpan = confirmPassword.parentElement.querySelector('.error-message');

            if (confirmPassword.value !== this.value) {
                confirmPassword.classList.add('error');
                if (errorSpan) {
                    errorSpan.innerHTML = '<i class="ti ti-alert-circle"></i> Passwords do not match';
                    errorSpan.style.display = 'flex';
                }
            } else {
                confirmPassword.classList.remove('error');
                if (errorSpan) errorSpan.style.display = 'none';
            }
        }
    });

    // Password strength checker with popup
    const strengthBar = document.getElementById('strengthBar');
    const passwordRequirements = document.getElementById('passwordRequirements');

    // Show popup on focus/mouseenter
    passwordInput?.addEventListener('focus', function () {
        passwordRequirements.classList.add('show');
    });

    passwordInput?.addEventListener('mouseenter', function () {
        if (document.activeElement !== this) {
            passwordRequirements.classList.add('show');
        }
    });

    // Hide popup on blur/mouseleave
    passwordInput?.addEventListener('blur', function () {
        setTimeout(() => {
            passwordRequirements.classList.remove('show');
        }, 200);
    });

    passwordInput?.addEventListener('mouseleave', function () {
        if (document.activeElement !== this) {
            setTimeout(() => {
                passwordRequirements.classList.remove('show');
            }, 200);
        }
    });

    // Password validation and strength calculation
    passwordInput?.addEventListener('input', function () {
        const password = this.value;
        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[^a-zA-Z0-9]/.test(password)
        };

        // Update requirements display
        const reqLength = document.getElementById('req-length');
        reqLength.className = requirements.length ? 'requirement met' : 'requirement';
        reqLength.innerHTML = requirements.length ?
            '<i class="ti ti-circle-check"></i> At least 8 characters' :
            '<i class="ti ti-circle"></i> At least 8 characters';

        const reqUppercase = document.getElementById('req-uppercase');
        reqUppercase.className = requirements.uppercase ? 'requirement met' : 'requirement';
        reqUppercase.innerHTML = requirements.uppercase ?
            '<i class="ti ti-circle-check"></i> One uppercase letter' :
            '<i class="ti ti-circle"></i> One uppercase letter';

        const reqNumber = document.getElementById('req-number');
        reqNumber.className = requirements.number ? 'requirement met' : 'requirement';
        reqNumber.innerHTML = requirements.number ?
            '<i class="ti ti-circle-check"></i> One number' :
            '<i class="ti ti-circle"></i> One number';

        const reqSpecial = document.getElementById('req-special');
        reqSpecial.className = requirements.special ? 'requirement met' : 'requirement';
        reqSpecial.innerHTML = requirements.special ?
            '<i class="ti ti-circle-check"></i> One special character' :
            '<i class="ti ti-circle"></i> One special character';

        // Calculate strength
        if (requirements.length) strength++;
        if (requirements.uppercase) strength++;
        if (requirements.number) strength++;
        if (requirements.special) strength++;

        strengthBar.className = 'password-strength-bar';

        if (password.length === 0) {
            strengthBar.style.width = '0';
        } else if (strength <= 1) {
            strengthBar.classList.add('weak');
        } else if (strength <= 2) {
            strengthBar.classList.add('medium');
        } else {
            strengthBar.classList.add('strong');
        }
    });

    // CR Expiry Date Validation
    const crExpiryDate = document.getElementById('crExpiryDate');
    crExpiryDate?.addEventListener('change', function () {
        const selectedDate = new Date(this.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selectedDate < today) {
            this.classList.add('error');
            document.getElementById('crExpiryWarning').style.display = 'flex';
            document.getElementById('crExpiryError').style.display = 'flex';
        } else {
            this.classList.remove('error');
            document.getElementById('crExpiryWarning').style.display = 'none';
            document.getElementById('crExpiryError').style.display = 'none';
        }
    });

    // File Upload Handling
    const fileInput = document.getElementById('documents');
    const fileList = document.getElementById('fileList');
    const uploadDiv = document.getElementById('documentUpload');
    let uploadedFiles = [];

    fileInput?.addEventListener('change', function (e) {
        const files = Array.from(e.target.files);
        uploadedFiles = uploadedFiles.concat(files);

        if (uploadedFiles.length > 0) {
            uploadDiv.classList.add('has-files');
            fileList.innerHTML = '<div style="margin-top: 1rem; font-weight: 600;">Uploaded Files:</div>';

            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <i class="ti ti-file"></i>
                    <span>${file.name} (${formatFileSize(file.size)})</span>
                    <button type="button" onclick="removeFile(${index})" style="margin-left: auto; background: none; border: none; color: var(--danger-color); cursor: pointer;">
                        <i class="ti ti-x"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        }
    });

    // Remove file function
    function removeFile(index) {
        uploadedFiles.splice(index, 1);
        const dataTransfer = new DataTransfer();
        uploadedFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;

        if (uploadedFiles.length === 0) {
            uploadDiv.classList.remove('has-files');
            fileList.innerHTML = '';
        } else {
            // Re-render file list
            fileList.innerHTML = '<div style="margin-top: 1rem; font-weight: 600;">Uploaded Files:</div>';
            uploadedFiles.forEach((file, idx) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <i class="ti ti-file"></i>
                    <span>${file.name} (${formatFileSize(file.size)})</span>
                    <button type="button" onclick="removeFile(${idx})" style="margin-left: auto; background: none; border: none; color: var(--danger-color); cursor: pointer;">
                        <i class="ti ti-x"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        }
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i), 2) + ' ' + sizes[i];
    }

    // License selection
    function selectLicense(type) {
        document.querySelectorAll('.license-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`#${type}License`).checked = true;
        document.querySelector(`#${type}License`).closest('.license-card').classList.add('selected');
    }

    // CAPTCHA refresh
    function refreshCaptcha() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let captcha = '';
        for (let i = 0; i < 6; i++) {
            captcha += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('captchaImage').textContent = captcha;
    }

    // Submit form to FastAPI backend
    async function submitForm() {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Add uploaded files to data
        if (uploadedFiles.length > 0) {
            data.documents = uploadedFiles;
        }

        // Show loading state
        nextBtn.classList.add('loading');
        nextBtn.disabled = true;

        try {
            // Replace with your actual FastAPI endpoint
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();

                // Show success message
                showAlert('Registration successful! Check your email for verification.', 'success');

                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = '/login';
                }, 3000);
            } else {
                const error = await response.json();
                showAlert(error.detail || 'Registration failed. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Registration error:', error);
            showAlert('An error occurred. Please try again later.', 'error');
        } finally {
            nextBtn.classList.remove('loading');
            nextBtn.disabled = false;
        }
    }

    // Modal functions
    function showModal(type) {
        // In production, these would open actual modal dialogs
        if (type === 'terms') {
            alert('Terms and Conditions Modal - This would display full terms');
        } else if (type === 'privacy') {
            alert('Privacy Policy Modal - This would display privacy policy');
        }
        return false;
    }

    // Initialize
    showStep(currentStep);
    refreshCaptcha();

    console.log('Registration form initialized successfully');
</script>
{% endblock %}