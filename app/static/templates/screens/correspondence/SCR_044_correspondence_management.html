<!-- SCR-044: Document Correspondence Management Screen (Initiator) -->
<!-- File: app/templates/screens/correspondence/SCR_044_correspondence_management.html -->
{% extends "base.html" %}

{% block title %}Correspondence Management{% endblock %}

{% block page_title %}Correspondence Management{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-left">
                <div class="page-icon">
                    <i class="ti ti-mail"></i>
                </div>
                <div class="header-info">
                    <h1 class="page-title">Correspondence Management</h1>
                    <p class="page-subtitle">AI-powered document analysis and query resolution</p>
                </div>
            </div>
            <div class="header-actions">
                <!-- <button class="btn-secondary" onclick="showCorrespondenceHistory()">
                    <i class="ti ti-history"></i>
                    History
                </button> -->
                <button class="btn-secondary" onclick="openModal('helpModal')">
                    <i class="ti ti-help"></i>
                    Help
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Module Scope & Limitations Notice -->
        <div class="limitations-notice">
            <div class="limitations-header">
                <div class="limitations-icon">
                    <i class="ti ti-info-circle"></i>
                </div>
                <h3 class="limitations-title">Module Scope & Limitations</h3>
            </div>

            <div class="limitations-content">
                <ul class="limitation-list">
                    <li class="limitation-item">
                        <i class="ti ti-file-upload"></i>
                        <span><strong>Files:</strong> 50 MB max per file, 10 files per batch, 500 MB per session (PDF,
                            DOC, DOCX, XLS, XLSX, TXT, RTF, ODT)</span>
                    </li>
                    <li class="limitation-item">
                        <i class="ti ti-message-question"></i>
                        <span><strong>Queries:</strong> 5,000 characters max per query, 200,000 characters max document
                            content, 10-60 seconds processing time</span>
                    </li>
                    <li class="limitation-item">
                        <i class="ti ti-alert-triangle"></i>
                        <span><strong>Guidance:</strong> Responses are guidance-based and require human verification for
                            critical legal decisions</span>
                    </li>
                    <!-- <li class="limitation-item">
                <i class="ti ti-lock"></i>
                <span><strong>Access:</strong> Role-based permissions, 30-minute session timeout, max 3 concurrent sessions</span>
            </li> -->
                    <li class="limitation-item">
                        <i class="ti ti-shield-check"></i>
                        <span><strong>Compliance:</strong> All actions logged with audit trail, SHA-256 file
                            verification enabled</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Mode Selection Cards -->
        <div class="mode-selection">
            <div class="mode-card active" id="projectMode" onclick="selectMode('project')">
                <div class="mode-icon">
                    <i class="ti ti-folder"></i>
                </div>
                <div class="mode-content">
                    <h3>Project Level Analysis</h3>
                    <p>Analyze multiple documents within a project to get comprehensive guidance</p>
                    <div class="mode-features">
                        <span class="feature-tag">
                            <i class="ti ti-files"></i>
                            Multi-document
                        </span>
                        <span class="feature-tag">
                            <i class="ti ti-brain"></i>
                            AI Analysis
                        </span>
                    </div>
                </div>
                <div class="mode-selector">
                    <div class="radio-button active"></div>
                </div>
            </div>

            <div class="mode-card" id="documentMode" onclick="selectMode('document')">
                <div class="mode-icon">
                    <i class="ti ti-file-text"></i>
                </div>
                <div class="mode-content">
                    <h3>Document Level Analysis</h3>
                    <p>Focus on specific contract document for detailed correspondence guidance</p>
                    <div class="mode-features">
                        <span class="feature-tag">
                            <i class="ti ti-file"></i>
                            Single document
                        </span>
                        <span class="feature-tag">
                            <i class="ti ti-message"></i>
                            Quick Response
                        </span>
                    </div>
                </div>
                <div class="mode-selector">
                    <div class="radio-button"></div>
                </div>
            </div>
        </div>



        <!-- Project Mode Content -->
        <div class="analysis-section" id="projectSection">
            <!-- Project Selection -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-info">
                        <h3>Select Project</h3>
                        <p>Choose a project to analyze its documents for correspondence guidance</p>
                    </div>
                    <button class="btn-outline" onclick="refreshProjects()">
                        <i class="ti ti-refresh"></i>
                        Refresh
                    </button>
                </div>

                <div class="project-grid">
                    <!-- Projects will be loaded dynamically from API -->
                </div>
            </div>

            <!-- Document Selection -->
            <div class="section-card" id="documentSelectionSection" style="display: none;">
                <div class="section-header">
                    <div class="section-info">
                        <h3>Select Documents for Analysis</h3>
                        <p>Choose documents to be used as reference for your query</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn-primary" onclick="uploadDocumentsToProject()">
                            <i class="ti ti-upload"></i>
                            Upload
                        </button>
                        <button class="btn-outline" onclick="selectAllDocuments()">
                            <i class="ti ti-check-box"></i>
                            Select All
                        </button>
                        <button class="btn-outline" onclick="clearDocumentSelection()">
                            <i class="ti ti-square"></i>
                            Clear All
                        </button>
                    </div>
                </div>

                <div class="document-list">
                    <!-- Documents will be loaded dynamically from API -->
                </div>

                <div class="section-actions">
                    <button class="btn-primary" onclick="proceedToQuery()" id="proceedBtn" disabled>
                        <i class="ti ti-arrow-right"></i>
                        Proceed to Query
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload Modal HTML -->
        <div class="modal" id="uploadModal">
            <div class="modal-overlay" onclick="closeUploadModal()"></div>
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3><i class="ti ti-upload"></i> Upload Documents</h3>
                    <button class="btn-icon" onclick="closeUploadModal()">
                        <i class="ti ti-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Upload Dropzone -->
                    <div class="upload-dropzone" id="uploadDropzone">
                        <i class="ti ti-cloud-upload"></i>
                        <h4>Drag & Drop Files Here</h4>
                        <p>or click to browse</p>
                        <p class="upload-hint">Supported: PDF, DOC, DOCX, XLS, XLSX, TXT, RTF, ODT, EML (Max 50MB each)
                        </p>
                        <input type="file" id="fileInput" multiple
                            accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.rtf,.odt,.eml" style="display: none;">
                    </div>

                    <!-- Selected Files List -->
                    <div id="selectedFilesList" style="display: none;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4>Selected Files (<span id="fileCount">0</span>)</h4>
                            <button class="btn-text" onclick="clearAllFiles()">
                                <i class="ti ti-trash"></i>
                                Clear All
                            </button>
                        </div>
                        <div id="filesListContainer"></div>
                    </div>


                    <!-- Upload Progress -->
                    <div id="uploadProgress" style="display: none; margin-top: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Uploading...</span>
                            <span id="uploadPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="uploadProgressBar"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeUploadModal()">Cancel</button>
                    <button class="btn-primary" id="startUploadBtn" onclick="startUpload()" disabled>
                        <i class="ti ti-upload"></i>
                        Upload Files
                    </button>
                </div>
            </div>
        </div>

        <style>
            /* Upload Modal Styles */
            .upload-dropzone {
                border: 2px dashed var(--border-color);
                border-radius: 8px;
                padding: 3rem 2rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
                background: #f8f9fa;
            }

            .upload-dropzone:hover {
                border-color: var(--primary-color);
                background: #f0f7ff;
            }

            .upload-dropzone.drag-over {
                border-color: var(--primary-color);
                background: #e8f4ff;
                transform: scale(1.02);
            }

            .upload-dropzone i {
                font-size: 3rem;
                color: var(--primary-color);
                margin-bottom: 1rem;
                display: block;
            }

            .upload-dropzone h4 {
                margin: 0.5rem 0;
                color: var(--text-color);
            }

            .upload-dropzone p {
                color: var(--text-muted);
                margin: 0.25rem 0;
            }

            .upload-hint {
                font-size: 0.875rem;
                margin-top: 0.5rem !important;
            }

            .file-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0.75rem;
                background: #f9fafb;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                margin-bottom: 0.5rem;
                transition: all 0.2s ease;
            }

            .file-item:hover {
                background: #f0f7ff;
                border-color: var(--primary-color);
            }

            .file-info {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                flex: 1;
                min-width: 0;
            }

            .file-icon {
                font-size: 1.5rem;
                color: var(--primary-color);
                flex-shrink: 0;
            }

            .file-details {
                flex: 1;
                min-width: 0;
            }

            .file-name {
                font-weight: 500;
                color: var(--text-color);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .file-size {
                font-size: 0.875rem;
                color: var(--text-muted);
            }

            .file-remove {
                background: transparent;
                border: none;
                color: var(--error-color);
                cursor: pointer;
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
                transition: all 0.2s ease;
                flex-shrink: 0;
            }

            .file-remove:hover {
                background: #fee;
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: #e5e7eb;
                border-radius: 4px;
                overflow: hidden;
            }

            .progress-fill {
                height: 100%;
                background: var(--primary-color);
                transition: width 0.3s ease;
                width: 0%;
            }
        </style>

        <script>
            // =====================================================
            // DOCUMENT UPLOAD FUNCTIONALITY
            // =====================================================

            let selectedFiles = [];
            let uploadInProgress = false;

            // Initialize upload functionality when DOM is ready
            function initializeUpload() {
                const dropzone = document.getElementById('uploadDropzone');
                const fileInput = document.getElementById('fileInput');

                if (!dropzone || !fileInput) {
                    console.warn('‚ö†Ô∏è Upload elements not found, retrying...');
                    setTimeout(initializeUpload, 100);
                    return;
                }

                // Dropzone click event
                dropzone.addEventListener('click', (e) => {
                    if (!uploadInProgress) {
                        fileInput.click();
                    }
                });

                // Drag and drop events
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropzone.classList.add('drag-over');
                });

                dropzone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropzone.classList.remove('drag-over');
                });

                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropzone.classList.remove('drag-over');

                    if (!uploadInProgress) {
                        const files = Array.from(e.dataTransfer.files);
                        handleFileSelection(files);
                    }
                });

                // File input change event
                fileInput.addEventListener('change', (e) => {
                    if (!uploadInProgress) {
                        const files = Array.from(e.target.files);
                        handleFileSelection(files);
                    }
                });

                console.log('‚úÖ Upload functionality initialized');
            }

            // Handle file selection
            function handleFileSelection(files) {
                console.log('üìÅ Files selected:', files.length);

                // Validate file count
                if (files.length > 10) {
                    showNotification('Maximum 10 files allowed per upload', 'warning');
                    files = files.slice(0, 10);
                }

                // Filter and validate files
                const validFiles = files.filter(file => {
                    // Check file size (50MB)
                    if (file.size > 50 * 1024 * 1024) {
                        showNotification(`File "${file.name}" exceeds 50MB limit`, 'warning');
                        return false;
                    }

                    // Check file extension
                    const allowedExtensions = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.txt', '.rtf', '.odt', '.eml'];
                    const fileExt = '.' + file.name.split('.').pop().toLowerCase();

                    if (!allowedExtensions.includes(fileExt)) {
                        showNotification(`File type "${fileExt}" not allowed for "${file.name}"`, 'warning');
                        return false;
                    }

                    // Check for duplicates
                    const isDuplicate = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                    if (isDuplicate) {
                        showNotification(`File "${file.name}" already selected`, 'info');
                        return false;
                    }

                    return true;
                });

                if (validFiles.length === 0) {
                    return;
                }

                // Add valid files to selection
                selectedFiles.push(...validFiles);
                renderFilesList();

                // Show upload options and enable button
                document.getElementById('selectedFilesList').style.display = 'block';
                document.getElementById('uploadOptions').style.display = 'block';
                document.getElementById('startUploadBtn').disabled = false;

                console.log('‚úÖ Valid files added:', validFiles.length);
            }

            // Render files list
            function renderFilesList() {
                const container = document.getElementById('filesListContainer');
                const fileCount = document.getElementById('fileCount');

                if (!container || !fileCount) return;

                fileCount.textContent = selectedFiles.length;

                container.innerHTML = selectedFiles.map((file, index) => {
                    const fileExt = file.name.split('.').pop().toLowerCase();
                    const fileSize = formatFileSize(file.size);

                    const iconMap = {
                        'pdf': 'ti-file-type-pdf',
                        'doc': 'ti-file-type-doc',
                        'docx': 'ti-file-type-doc',
                        'xls': 'ti-file-type-xls',
                        'xlsx': 'ti-file-type-xls',
                        'txt': 'ti-file-text',
                        'rtf': 'ti-file-text',
                        'odt': 'ti-file-text',
                        'eml': 'ti-mail'
                    };

                    const icon = iconMap[fileExt] || 'ti-file';

                    return `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="ti ${icon}"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${escapeHtml(file.name)}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                    </div>
                    <button class="file-remove" onclick="removeFile(${index})" title="Remove" ${uploadInProgress ? 'disabled' : ''}>
                        <i class="ti ti-x"></i>
                    </button>
                </div>
            `;
                }).join('');
            }

            // Remove file from selection
            function removeFile(index) {
                if (uploadInProgress) return;

                selectedFiles.splice(index, 1);

                if (selectedFiles.length === 0) {
                    clearAllFiles();
                } else {
                    renderFilesList();
                }

                console.log('üóëÔ∏è File removed, remaining:', selectedFiles.length);
            }

            // Clear all files
            function clearAllFiles() {
                if (uploadInProgress) return;

                selectedFiles = [];
                document.getElementById('selectedFilesList').style.display = 'none';
                document.getElementById('uploadOptions').style.display = 'none';
                document.getElementById('startUploadBtn').disabled = true;
                document.getElementById('fileInput').value = '';
                document.getElementById('uploadNotes').value = '';

                console.log('üóëÔ∏è All files cleared');
            }

            // Format file size
            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '0 B';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Open upload modal
            function openUploadModal() {
                // if (!selectedProject) {
                //     showNotification('Please select a project first', 'warning');
                //     return;
                // }

                const modal = document.getElementById('uploadModal');
                if (modal) {
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';

                    // Reset modal state
                    clearAllFiles();
                    uploadInProgress = false;
                    document.getElementById('uploadProgress').style.display = 'none';

                    console.log('üì§ Upload modal opened');
                }
            }

            // Close upload modal
            function closeUploadModal() {
                if (uploadInProgress) {
                    if (!confirm('Upload in progress. Are you sure you want to cancel?')) {
                        return;
                    }
                }

                const modal = document.getElementById('uploadModal');
                if (modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = '';

                    // Reset modal state
                    clearAllFiles();
                    uploadInProgress = false;
                    document.getElementById('uploadProgress').style.display = 'none';
                    document.getElementById('uploadProgressBar').style.width = '0%';
                    document.getElementById('uploadPercentage').textContent = '0%';

                    console.log('‚ùå Upload modal closed');
                }
            }

            // Start upload process
            async function startUpload() {
                if (selectedFiles.length === 0) {
                    showNotification('Please select files to upload', 'warning');
                    return;
                }

                if (!selectedProject) {
                    showNotification('Please select a project first', 'warning');
                    closeUploadModal();
                    return;
                }

                if (uploadInProgress) {
                    return;
                }

                uploadInProgress = true;
                const uploadBtn = document.getElementById('startUploadBtn');
                const progressContainer = document.getElementById('uploadProgress');
                const progressBar = document.getElementById('uploadProgressBar');
                const progressText = document.getElementById('uploadPercentage');
                const notes = document.getElementById('uploadNotes').value.trim();

                // Disable controls
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="loading-spinner"></span> Uploading...';
                progressContainer.style.display = 'block';

                try {
                    const formData = new FormData();

                    // Append all files
                    selectedFiles.forEach(file => {
                        formData.append('files', file);
                    });

                    // Append metadata
                    formData.append('document_type', 'correspondence');
                    formData.append('notes', notes || 'Uploaded for correspondence analysis');

                    console.log(`üì§ Uploading ${selectedFiles.length} files to project ${selectedProject}...`);

                    // Simulate progress (since we can't track actual upload progress easily)
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += 5;
                        if (progress <= 90) {
                            progressBar.style.width = progress + '%';
                            progressText.textContent = progress + '%';
                        }
                    }, 200);

                    const response = await fetch(`/api/projects/${selectedProject}/documents/upload`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });

                    clearInterval(progressInterval);

                    if (response.status === 401) {
                        showNotification('Please log in to continue', 'error');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 1500);
                        return;
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || `Upload failed with status ${response.status}`);
                    }

                    const result = await response.json();

                    // Complete progress
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';

                    if (result.success) {
                        const uploadedCount = result.data?.uploaded?.length || selectedFiles.length;
                        console.log(`‚úÖ Successfully uploaded ${uploadedCount} file(s)`);
                        showNotification(`Successfully uploaded ${uploadedCount} file(s)`, 'success');

                        // Reload documents
                        await loadProjectDocuments(selectedProject);

                        // Close modal after a brief delay
                        setTimeout(() => {
                            closeUploadModal();
                        }, 1000);
                    } else {
                        throw new Error(result.message || 'Upload failed');
                    }

                } catch (error) {
                    console.error('‚ùå Upload error:', error);
                    showNotification(`Upload failed: ${error.message}`, 'error');

                    // Reset button state
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="ti ti-upload"></i> Upload Files';
                } finally {
                    uploadInProgress = false;

                    // Hide progress after a delay
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';
                    }, 2000);
                }
            }

            // Upload documents to project (called from button)
            function uploadDocumentsToProject() {
                openUploadModal();
            }

            // Initialize on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeUpload);
            } else {
                initializeUpload();
            }

            console.log('‚úÖ Upload script loaded');
        </script>

        <!-- Document Mode Content -->
        <div class="analysis-section" id="documentSection" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-info">
                        <h3>Select Document</h3>
                        <p>Choose a specific contract document for focused analysis</p>
                    </div>



                    <div class="header-actions">
                        <button class="btn-primary" onclick="uploadDocumentsToProject()">
                            <i class="ti ti-upload"></i>
                            Upload
                        </button>

                        <button class="btn-outline" onclick="refreshDocumentModeList()">
                            <i class="ti ti-refresh"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="document-selector-grid" id="documentModeGrid">
                    <!-- Documents will be loaded here dynamically from API -->
                </div>
            </div>
        </div>

        <!-- Query Interface -->
        <div class="query-section" id="querySection" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-info">
                        <h3>AI Query Interface</h3>
                        <p>Ask questions about your selected documents and get AI-powered guidance</p>
                    </div>
                    <div class="query-stats">
                        <span class="stat-item">
                            <i class="ti ti-files"></i>
                            <span id="selectedCount">2</span> documents selected
                        </span>
                    </div>
                </div>

                <div class="query-interface">
                    <!-- Predefined Query Templates -->
                    <div class="query-templates">
                        <h4>Quick Query Templates</h4>
                        <div class="template-grid">
                            <button class="template-btn" onclick="useTemplate('backcharge')">
                                <i class="ti ti-alert-triangle"></i>
                                <span>Back Charge Defense</span>
                            </button>
                            <button class="template-btn" onclick="useTemplate('dispute')">
                                <i class="ti ti-gavel"></i>
                                <span>Dispute Resolution</span>
                            </button>
                            <button class="template-btn" onclick="useTemplate('termination')">
                                <i class="ti ti-x-circle"></i>
                                <span>Contract Termination</span>
                            </button>
                            <button class="template-btn" onclick="useTemplate('compliance')">
                                <i class="ti ti-shield-check"></i>
                                <span>Compliance Check</span>
                            </button>
                        </div>
                    </div>

                    <!-- Query Input Area -->
                    <div class="query-input-section">
                        <div class="query-form">
                            <div class="form-group">
                                <label for="queryInput" class="form-label">Your Query</label>
                                <div class="query-input-wrapper">
                                    <textarea id="queryInput" class="query-textarea"
                                        placeholder="Describe your situation or ask a specific question about the selected documents..."
                                        rows="4"></textarea>
                                    <div class="input-actions">
                                        <button class="btn-icon" onclick="clearQuery()" title="Clear">
                                            <i class="ti ti-x"></i>
                                        </button>
                                        <button class="btn-icon" onclick="pasteFromClipboard()" title="Paste">
                                            <i class="ti ti-clipboard"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="toneSelector" class="form-label">Response Tone</label>
                                    <select id="toneSelector" class="form-select">
                                        <option value="default">Default - Neutral tone</option>
                                        <option value="appreciative">Appreciative - Expressing gratitude</option>
                                        <option value="assertive">Assertive - Direct and confident</option>
                                        <option value="cautionary">Cautionary - Warning or careful advice</option>
                                        <option value="conciliatory">Conciliatory - Seeking to resolve conflict</option>
                                        <option value="consultative">Consultative - Expert guidance</option>
                                        <option value="convincing">Convincing - Persuasive</option>
                                        <option value="enthusiastic">Enthusiastic - Cheerful and energetic</option>
                                        <option value="formal">Formal - Professional and structured</option>
                                        <option value="friendly">Friendly - Warm and approachable</option>
                                        <option value="motivating">Motivating - Encouraging and inspiring</option>
                                        <option value="professional">Professional - Polished and business-like</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="urgencyLevel" class="form-label">Urgency Level</label>
                                    <select id="urgencyLevel" class="form-select">
                                        <option value="normal">Normal</option>
                                        <option value="high">High Priority</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>

                            <div class="query-actions">
                                <button class="btn-secondary" onclick="saveAsDraft()">
                                    <i class="ti ti-device-floppy"></i>
                                    Save as Draft
                                </button>
                                <button class="btn-primary" onclick="submitQuery()" id="submitBtn">
                                    <i class="ti ti-send"></i>
                                    Submit Query
                                </button>
                                <!-- <div class="divider">OR</div> -->
                                <!-- <button class="btn-outline" onclick="letAIGenerate()">
                                    <i class="ti ti-sparkles"></i>
                                    Let AI Generate a Response
                                </button> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response Section -->
        <div class="response-section" id="responseSection" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-info">
                        <h3>AI Analysis & Recommendations</h3>
                        <p>Based on your selected documents and query</p>
                    </div>
                    <div class="response-actions">
                        <button class="btn-outline" onclick="exportResponse()">
                            <i class="ti ti-download"></i>
                            Download
                        </button>
                        <button class="btn-outline" onclick="shareResponse()">
                            <i class="ti ti-share"></i>
                            Share
                        </button>
                        <button class="btn-secondary" onclick="generateNewResponse()">
                            <i class="ti ti-refresh"></i>
                            Regenerate
                        </button>
                    </div>
                </div>

                <div class="response-content">
                    <div class="response-meta">
                        <div class="confidence-score">
                            <span class="score-label">Confidence Score:</span>
                            <div class="score-bar">
                                <div class="score-fill" style="width: 92%;"></div>
                            </div>
                            <span class="score-value">92%</span>
                        </div>
                        <div class="analysis-time">
                            <i class="ti ti-clock"></i>
                            <span>Analysis completed in 2.3 seconds</span>
                        </div>
                    </div>

                    <div class="response-body">
                        <div class="response-text" id="responseText">
                            <!-- AI Response will be populated here -->
                        </div>
                    </div>

                    <div class="response-footer">
                        <div class="source-references">
                            <h4>Source References</h4>
                            <div class="reference-list">
                                <div class="reference-item">
                                    <i class="ti ti-file-text"></i>
                                    <span>Document 1, Clause 15.2 - Dispute Resolution</span>
                                </div>
                                <div class="reference-item">
                                    <i class="ti ti-mail"></i>
                                    <span>Email 1 - Back charge notice from QatarEnergy</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MOD-060: Ask Query Modal -->
<div class="modal" id="queryModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">AI Query Assistant</h3>
            <button class="modal-close" onclick="closeModal('queryModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-query-form">
                <div class="form-group">
                    <label>Selected Documents</label>
                    <div class="selected-docs-preview">
                        <span class="doc-chip">Document 1</span>
                        <span class="doc-chip">Document 2</span>
                        <span class="doc-chip email">Email 1</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="modalQueryInput">Your Question</label>
                    <textarea id="modalQueryInput" rows="4"
                        placeholder="Ask anything about the selected documents..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalToneSelect">Response Tone</label>
                        <select id="modalToneSelect">
                            <option value="formal">Formal</option>
                            <option value="conciliatory">Conciliatory</option>
                            <option value="assertive">Assertive</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('queryModal')">Cancel</button>
            <button class="btn-primary" onclick="submitModalQuery()">
                <i class="ti ti-send"></i>
                Submit Query
            </button>
        </div>
    </div>
</div>

<!-- MOD-061: AI Response Preview Modal -->
<div class="modal" id="responsePreviewModal">
    <div class="modal-content modal-xl">
        <div class="modal-header">
            <h3 class="modal-title">AI Response Preview</h3>
            <button class="modal-close" onclick="closeModal('responsePreviewModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="response-preview-content">
                <div class="preview-header">
                    <div class="query-info">
                        <h4>Original Query:</h4>
                        <p id="previewQuery">How should we respond to the back charge letter from QatarEnergy?</p>
                    </div>
                    <div class="tone-badge">
                        <span id="previewTone">Formal Tone</span>
                    </div>
                </div>
                <div class="preview-response">
                    <div id="previewResponseText">
                        <!-- AI Response Preview -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-outline" onclick="editResponse()">
                <i class="ti ti-edit"></i>
                Edit Response
            </button>
            <button class="btn-secondary" onclick="closeModal('responsePreviewModal')">Close</button>
            <button class="btn-primary" onclick="acceptResponse()">
                <i class="ti ti-check"></i>
                Accept Response
            </button>
        </div>
    </div>
</div>

<!-- MOD-064: Document Preview Modal -->
<div class="modal" id="documentPreviewModal">
    <div class="modal-content modal-xl">
        <div class="modal-header">
            <h3 class="modal-title" id="previewDocTitle">Document Preview</h3>
            <button class="modal-close" onclick="closeModal('documentPreviewModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="document-preview-content">
                <div class="preview-toolbar">
                    <button class="btn-icon" onclick="zoomIn()">
                        <i class="ti ti-zoom-in"></i>
                    </button>
                    <button class="btn-icon" onclick="zoomOut()">
                        <i class="ti ti-zoom-out"></i>
                    </button>
                    <button class="btn-icon" onclick="toggleFullscreen()">
                        <i class="ti ti-maximize"></i>
                    </button>
                </div>
                <div class="document-viewer" id="documentViewer">
                    <!-- Document content will be loaded here -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-outline" onclick="downloadDocument()">
                <i class="ti ti-download"></i>
                Download
            </button>
            <button class="btn-secondary" onclick="closeModal('documentPreviewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal" id="helpModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Correspondence Management Help</h3>
            <button class="modal-close" onclick="closeModal('helpModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="help-content">
                <h4>How to Use Correspondence Management</h4>
                <div class="help-steps">
                    <div class="help-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h5>Choose Analysis Mode</h5>
                            <p>Select between Project Level (multiple documents) or Document Level (single document)
                                analysis.</p>
                        </div>
                    </div>
                    <div class="help-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h5>Select Documents</h5>
                            <p>Choose the relevant documents or project to analyze for your correspondence needs.</p>
                        </div>
                    </div>
                    <div class="help-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h5>Ask Your Question</h5>
                            <p>Use the AI query interface to ask specific questions or use predefined templates.</p>
                        </div>
                    </div>
                    <div class="help-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h5>Review AI Response</h5>
                            <p>Get AI-powered analysis and recommendations with source references and confidence scores.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="closeModal('helpModal')">Got it</button>
        </div>
    </div>
</div>

<style>
    /* Correspondence Management Specific Styles - Inline Implementation */

    /* Common Button Styles */
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-size: 0.875rem;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-secondary {
        background: white;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-size: 0.875rem;
    }

    .btn-secondary:hover {
        background: var(--primary-color);
        color: white;
    }

    .btn-outline {
        background: transparent;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-size: 0.875rem;
    }

    .btn-outline:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(39, 98, 203, 0.02);
    }

    .btn-icon {
        background: transparent;
        border: none;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
        transition: var(--transition);
        color: var(--text-muted);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-icon:hover {
        background: var(--background-light);
        color: var(--primary-color);
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-color);
        font-size: 0.875rem;
        font-weight: 600;
    }

    .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        background: white;
        transition: var(--transition);
    }

    .form-select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    /* Breadcrumb */
    .breadcrumb {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 0.75rem 1rem;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .breadcrumb-item {
        display: flex;
        align-items: center;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .breadcrumb-item a {
        color: var(--text-muted);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
    }

    .breadcrumb-item a:hover {
        color: var(--primary-color);
    }

    .breadcrumb-item.active {
        color: var(--text-color);
        font-weight: 500;
    }

    .breadcrumb-separator {
        margin: 0 0.75rem;
        color: var(--text-muted);
    }

    /* Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
    }

    .modal.show {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transform: scale(0.9);
        transition: var(--transition);
    }

    .modal.show .modal-content {
        transform: scale(1);
    }

    .modal-lg {
        max-width: 800px;
    }

    .modal-xl {
        max-width: 1200px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        padding: 0.5rem;
        cursor: pointer;
        border-radius: 6px;
        color: var(--text-muted);
        transition: var(--transition);
    }

    .modal-close:hover {
        background: var(--background-light);
        color: var(--text-color);
    }

    .modal-body {
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
        background: var(--background-light);
    }

    /* Document Preview Styles */
    .preview-toolbar {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: var(--background-light);
        border-radius: 8px;
    }

    .document-viewer {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        min-height: 400px;
        overflow: auto;
    }

    /* Response Preview Styles */
    .response-preview-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .query-info h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .query-info p {
        color: var(--text-muted);
        font-style: italic;
        margin: 0;
    }

    .tone-badge {
        padding: 0.5rem 1rem;
        background: var(--primary-color);
        color: white;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .preview-response {
        background: var(--background-light);
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }

    .page-container {
        padding: 1.5rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-color);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .page-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .header-info h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
    }

    .header-info p {
        color: var(--text-muted);
        margin: 0.25rem 0 0 0;
        font-size: 0.875rem;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
    }

    /* Mode Selection */
    .mode-selection {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .mode-card {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .mode-card:hover {
        border-color: var(--secondary-color);
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.1);
    }

    .mode-card.active {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.02);
    }

    .mode-icon {
        width: 48px;
        height: 48px;
        background: var(--background-light);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .mode-card.active .mode-icon {
        background: var(--primary-color);
        color: white;
    }

    .mode-content h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .mode-content p {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .mode-features {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .feature-tag {
        background: var(--background-light);
        color: var(--text-muted);
        padding: 0.25rem 0.75rem;
        border-radius: 16px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .mode-card.active .feature-tag {
        background: rgba(39, 98, 203, 0.1);
        color: var(--primary-color);
    }

    .mode-selector {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }

    .radio-button {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-radius: 50%;
        position: relative;
        transition: var(--transition);
    }

    .radio-button.active {
        border-color: var(--primary-color);
    }

    .radio-button.active::after {
        content: '';
        width: 10px;
        height: 10px;
        background: var(--primary-color);
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    /* Section Cards */
    .section-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-color);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .section-info h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .section-info p {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin: 0;
    }

    /* Project Grid */
    .project-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1rem;
    }

    .project-card {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .project-card:hover {
        border-color: var(--secondary-color);
        box-shadow: 0 2px 8px rgba(39, 98, 203, 0.1);
    }

    .project-card.active {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.02);
    }

    .project-status {
        margin-bottom: 0.75rem;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 16px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-badge.in-progress {
        background: var(--warning-bg);
        color: var(--warning-color);
    }

    .status-badge.internal-review {
        background: var(--info-bg);
        color: var(--info-color);
    }

    .project-info h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .project-code {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
    }

    .project-meta {
        display: flex;
        gap: 1rem;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .project-actions {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        transition: var(--transition);
    }

    .project-card:hover .project-actions {
        opacity: 1;
    }

    /* Document List */
    .document-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .document-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
    }

    .document-item:hover {
        border-color: var(--secondary-color);
        background: var(--background-light);
    }

    .document-selector {
        flex-shrink: 0;
    }

    .checkbox-label {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .checkbox-label i {
        font-size: 0.875rem;
        color: white;
        opacity: 0;
        transition: var(--transition);
    }

    input[type="checkbox"]:checked+.checkbox-label {
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    input[type="checkbox"]:checked+.checkbox-label i {
        opacity: 1;
    }

    input[type="checkbox"] {
        display: none;
    }

    .document-icon {
        width: 40px;
        height: 40px;
        background: var(--background-light);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .document-icon.email {
        background: rgba(255, 159, 67, 0.1);
        color: #ff9f43;
    }

    .document-info {
        flex: 1;
    }

    .document-info h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .document-info p {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .document-meta {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .meta-tag {
        background: var(--background-light);
        color: var(--text-muted);
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .meta-tag.urgent {
        background: rgba(220, 53, 69, 0.1);
        color: var(--danger-color);
    }

    .document-actions {
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        transition: var(--transition);
    }

    .document-item:hover .document-actions {
        opacity: 1;
    }

    /* Query Templates */
    .query-templates {
        margin-bottom: 2rem;
    }

    .query-templates h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }

    .template-btn {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-align: left;
    }

    .template-btn:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.02);
    }

    .template-btn i {
        font-size: 1.25rem;
        color: var(--primary-color);
    }

    .template-btn span {
        font-weight: 500;
        color: var(--text-color);
    }

    /* Query Input */
    .query-input-wrapper {
        position: relative;
    }

    .query-textarea {
        width: 100%;
        min-height: 120px;
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        line-height: 1.5;
        resize: vertical;
        transition: var(--transition);
    }

    .query-textarea:focus {
        border-color: var(--primary-color);
        outline: none;
    }

    .input-actions {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        display: flex;
        gap: 0.25rem;
    }

    .query-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .divider {
        color: var(--text-muted);
        font-size: 0.875rem;
        font-weight: 500;
    }

    /* Response Section */
    .response-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--background-light);
        border-radius: 8px;
    }

    .confidence-score {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .score-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .score-bar {
        width: 100px;
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }

    .score-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--success-color), var(--primary-color));
        border-radius: 4px;
        transition: var(--transition);
    }

    .score-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--success-color);
    }

    .analysis-time {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .response-body {
        margin-bottom: 1.5rem;
    }

    .response-text {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        min-height: 200px;
        line-height: 1.6;
    }

    .source-references h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .reference-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .reference-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--background-light);
        border-radius: 6px;
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .reference-item i {
        color: var(--primary-color);
    }

    /* Query Stats */
    .query-stats {
        display: flex;
        gap: 1rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--background-light);
        border-radius: 20px;
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .stat-item i {
        color: var(--primary-color);
    }

    /* Modal Enhancements */
    .modal-query-form .selected-docs-preview {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }

    .doc-chip {
        background: var(--background-light);
        color: var(--text-color);
        padding: 0.25rem 0.75rem;
        border-radius: 16px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .doc-chip.email {
        background: rgba(255, 159, 67, 0.1);
        color: #ff9f43;
    }

    .doc-chip::before {
        content: 'üìÑ';
        font-size: 0.75rem;
    }

    .doc-chip.email::before {
        content: 'üìß';
    }

    /* Document Selector Grid */
    .document-selector-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }

    .document-card {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .document-card:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.02);
    }

    .document-type {
        width: 48px;
        height: 48px;
        background: var(--background-light);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        font-size: 1.5rem;
    }

    .document-details {
        flex: 1;
    }

    .document-details h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .document-details p {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .document-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .document-status {
        flex-shrink: 0;
    }

    .status-badge.draft {
        background: var(--warning-bg);
        color: var(--warning-color);
    }

    .status-badge.active {
        background: var(--success-bg);
        color: var(--success-color);
    }

    /* Help Content */
    .help-steps {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .help-step {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }

    .step-number {
        width: 32px;
        height: 32px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
    }

    .step-content h5 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .step-content p {
        color: var(--text-muted);
        font-size: 0.875rem;
        line-height: 1.5;
        margin: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .mode-selection {
            grid-template-columns: 1fr;
        }

        .project-grid {
            grid-template-columns: 1fr;
        }

        .template-grid {
            grid-template-columns: 1fr;
        }

        .query-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .header-content {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .response-meta {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
    }

    /* Animation for loading states */
    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .loading {
        animation: pulse 2s infinite;
    }

    /* Focus states for accessibility */
    .template-btn:focus,
    .project-card:focus,
    .document-item:focus,
    .document-card:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }
</style>

<style>
    /* Add these styles to the existing CSS file or in the <style> section */
    .limitations-notice {
        background: rgba(255, 202, 152, 0.1);
        border: 1px solid #ffc107;
        border-radius: 12px;
        padding: 24px;
        margin: 24px 0;
        position: relative;
        overflow: hidden;
    }

    .limitations-notice::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, #ffc107, lch(72.04% 82.98 68.3));
    }

    .limitations-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .limitations-icon {
        width: 40px;
        height: 40px;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .limitations-icon i {
        font-size: 20px;
        color: #ff9800;
    }

    .limitations-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--warning-color);
        margin: 0;
    }

    .limitations-content {
        display: grid;
        gap: 16px;
    }

    .limitation-group {
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .limitation-group-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .limitation-group-title i {
        font-size: 16px;
        color: var(--secondary-color);
    }

    .limitation-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .limitation-item {
        padding: 8px 0;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        font-size: 14px;
        color: var(--text-muted);
        line-height: 1.5;
    }

    .limitation-item i {
        font-size: 16px;
        color: #f19e22;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .limitation-item strong {
        color: var(--text-color);
        font-weight: 500;
    }

    .expand-limitations {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 16px;
        padding: 8px 16px;
        background: transparent;
        border: 1px solid #ffc107;
        border-radius: 6px;
        color: var(--warning-color);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .expand-limitations:hover {
        background: #fff;
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
    }

    .limitations-notice.expanded .expand-limitations i {
        transform: rotate(180deg);
    }

    .limitations-notice:not(.expanded) .limitation-group:nth-child(n+3) {
        display: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .limitations-notice {
            padding: 16px;
            margin: 16px 0;
        }

        .limitations-title {
            font-size: 16px;
        }

        .limitation-group {
            padding: 12px;
        }
    }


    /* =====================================================
   ADD THESE STYLES TO YOUR <style> SECTION
   Enhanced AI Response Display with Better Alignment
   ===================================================== */

    /* Main Response Container */
    .response-body {
        margin-bottom: 2rem;
    }

    .response-text {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        min-height: 200px;
        line-height: 1.8;
        font-size: 0.95rem;
        color: var(--text-color);
    }

    /* Response Text Formatting */
    .response-text h1,
    .response-text h2,
    .response-text h3,
    .response-text h4,
    .response-text h5 {
        color: var(--primary-color);
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
        line-height: 1.3;
    }

    .response-text h1 {
        font-size: 1.75rem;
    }

    .response-text h2 {
        font-size: 1.5rem;
    }

    .response-text h3 {
        font-size: 1.25rem;
    }

    .response-text h4 {
        font-size: 1.1rem;
    }

    .response-text p {
        margin-bottom: 1rem;
        line-height: 1.8;
    }

    .response-text ul,
    .response-text ol {
        margin: 1rem 0;
        padding-left: 2rem;
    }

    .response-text li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    .response-text strong {
        color: var(--text-color);
        font-weight: 600;
    }

    .response-text code {
        background: var(--background-light);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .response-text hr {
        border: none;
        border-top: 2px solid var(--border-color);
        margin: 2rem 0;
    }

    /* Recommendations Section */
    .recommendations-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.05), rgba(255, 152, 0, 0.05));
        border-radius: 12px;
        border-left: 4px solid #ffc107;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
    }

    .recommendations-section h4 {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
        color: #f57c00;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .recommendations-section h4 i {
        font-size: 1.5rem;
    }

    .recommendation-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .recommendation-list li {
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        background: white;
        border-radius: 8px;
        border-left: 3px solid #ffc107;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        line-height: 1.6;
        transition: all 0.3s ease;
    }

    .recommendation-list li:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
    }

    .recommendation-list li::before {
        content: "üí°";
        margin-right: 0.75rem;
        font-size: 1.2rem;
    }

    /* Key Points Section */
    .key-points-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(33, 150, 243, 0.05), rgba(30, 136, 229, 0.05));
        border-radius: 12px;
        border-left: 4px solid #2196f3;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
    }

    .key-points-section h4 {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
        color: #1976d2;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .key-points-section h4 i {
        font-size: 1.5rem;
    }

    .key-points-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .key-points-list li {
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        background: white;
        border-radius: 8px;
        border-left: 3px solid #2196f3;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        line-height: 1.6;
        transition: all 0.3s ease;
    }

    .key-points-list li:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
    }

    .key-points-list li::before {
        content: "üîë";
        margin-right: 0.75rem;
        font-size: 1.2rem;
    }

    /* Suggested Actions Section */
    .suggested-actions-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.05), rgba(67, 160, 71, 0.05));
        border-radius: 12px;
        border-left: 4px solid #4caf50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
    }

    .suggested-actions-section h4 {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
        color: #388e3c;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .suggested-actions-section h4 i {
        font-size: 1.5rem;
    }

    .actions-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .actions-list li {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1.25rem;
        margin-bottom: 0.75rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        line-height: 1.6;
        transition: all 0.3s ease;
    }

    .actions-list li:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
    }

    .action-number {
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        color: white;
        border-radius: 50%;
        font-weight: 700;
        font-size: 0.95rem;
        flex-shrink: 0;
        box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
    }

    /* Error Message Styling */
    .error-message {
        padding: 1.5rem;
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        border: 2px solid #ef5350;
        border-radius: 12px;
        color: #c62828;
        text-align: center;
    }

    .error-message i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        display: block;
        color: #ef5350;
    }

    .error-message strong {
        display: block;
        margin-bottom: 0.75rem;
        font-size: 1.2rem;
        color: #c62828;
    }

    .error-message p {
        margin: 0.5rem 0;
        line-height: 1.6;
    }

    /* Response Meta Information */
    .response-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1.25rem;
        background: linear-gradient(135deg, var(--background-light), #f8f9fa);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .confidence-score {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .score-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .score-bar {
        width: 120px;
        height: 10px;
        background: var(--border-color);
        border-radius: 6px;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .score-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #66bb6a);
        border-radius: 6px;
        transition: width 0.6s ease, background 0.3s ease;
    }

    .score-value {
        font-size: 1rem;
        font-weight: 700;
        color: #4caf50;
    }

    .analysis-time {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .analysis-time i {
        font-size: 1.1rem;
        color: var(--primary-color);
    }

    /* Source References */
    .response-footer {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--background-light);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .source-references h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .source-references h4::before {
        content: "üìé";
        font-size: 1.3rem;
    }

    .reference-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .reference-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: white;
        border-radius: 8px;
        font-size: 0.9rem;
        color: var(--text-muted);
        transition: all 0.3s ease;
        cursor: pointer;
        border: 1px solid var(--border-color);
    }

    .reference-item:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.02);
        transform: translateX(4px);
    }

    .reference-item i {
        color: var(--primary-color);
        font-size: 1.2rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .response-text {
            padding: 1.5rem;
            font-size: 0.9rem;
        }

        .recommendations-section,
        .key-points-section,
        .suggested-actions-section {
            padding: 1rem;
        }

        .response-meta {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .confidence-score {
            width: 100%;
        }

        .score-bar {
            flex: 1;
        }
    }

    /* Print Styles */
    @media print {

        .response-actions,
        .btn-icon {
            display: none !important;
        }

        .response-text,
        .recommendations-section,
        .key-points-section,
        .suggested-actions-section {
            page-break-inside: avoid;
        }
    }

    /* Animation for sections appearing */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .recommendations-section,
    .key-points-section,
    .suggested-actions-section {
        animation: fadeInUp 0.5s ease forwards;
    }

    .recommendations-section {
        animation-delay: 0.1s;
    }

    .key-points-section {
        animation-delay: 0.2s;
    }

    .suggested-actions-section {
        animation-delay: 0.3s;
    }
</style>

<style>
    /* =====================================================
   ENHANCED RESPONSE TEXT FORMATTING - ADD TO YOUR CSS
   ===================================================== */

    /* Main Response Container with Better Spacing */
    .response-section {
        margin-top: 2rem;
    }

    .response-content {
        background: white;
    }

    /* Response Text Formatting - Proper Document Structure */
    .response-text {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2.5rem;
        min-height: 200px;
        line-height: 1.8;
        font-size: 0.95rem;
        color: var(--text-color);
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
    }

    /* Headers with Proper Spacing */
    .response-text h1,
    .response-text h2,
    .response-text h3,
    .response-text h4 {
        color: var(--primary-color);
        font-weight: 600;
        line-height: 1.4;
        margin-top: 2rem;
        margin-bottom: 1rem;
        clear: both;
    }

    .response-text h1 {
        font-size: 1.75rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.75rem;
    }

    .response-text h2 {
        font-size: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
    }

    .response-text h3 {
        font-size: 1.25rem;
        margin-top: 1.75rem;
    }

    .response-text h4 {
        font-size: 1.1rem;
        margin-top: 1.5rem;
    }

    .response-text h5 {
        font-size: 1rem;
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        color: var(--text-color);
        font-weight: 600;
    }

    /* Paragraphs with Proper Spacing */
    .response-text p {
        margin-bottom: 1.25rem;
        line-height: 1.8;
        text-align: justify;
        color: var(--text-color);
    }

    /* Lists with Better Formatting */
    .response-text ul,
    .response-text ol {
        margin: 1.5rem 0;
        padding-left: 2.5rem;
        line-height: 1.8;
    }

    .response-text li {
        margin-bottom: 0.75rem;
        line-height: 1.7;
        color: var(--text-color);
    }

    .response-text ul li {
        list-style-type: disc;
    }

    .response-text ol li {
        list-style-type: decimal;
    }

    /* Nested Lists */
    .response-text ul ul,
    .response-text ol ol,
    .response-text ul ol,
    .response-text ol ul {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }

    /* Strong/Bold Text */
    .response-text strong,
    .response-text b {
        color: var(--text-color);
        font-weight: 700;
    }

    /* Emphasis/Italic */
    .response-text em,
    .response-text i {
        font-style: italic;
        color: var(--text-muted);
    }

    /* Code Blocks */
    .response-text code {
        background: var(--background-light);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-family: 'Courier New', 'Consolas', monospace;
        font-size: 0.9em;
        color: #e83e8c;
        border: 1px solid var(--border-color);
    }

    .response-text pre {
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        overflow-x: auto;
        margin: 1.5rem 0;
    }

    .response-text pre code {
        background: transparent;
        padding: 0;
        border: none;
        color: var(--text-color);
    }

    /* Blockquotes */
    .response-text blockquote {
        border-left: 4px solid var(--primary-color);
        padding-left: 1.5rem;
        margin: 1.5rem 0;
        font-style: italic;
        color: var(--text-muted);
        background: var(--background-light);
        padding: 1rem 1.5rem;
        border-radius: 0 8px 8px 0;
    }

    /* Horizontal Rules */
    .response-text hr {
        border: none;
        border-top: 2px solid var(--border-color);
        margin: 2.5rem 0;
    }

    /* Tables */
    .response-text table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5rem 0;
        border: 1px solid var(--border-color);
    }

    .response-text th,
    .response-text td {
        padding: 0.75rem;
        text-align: left;
        border: 1px solid var(--border-color);
    }

    .response-text th {
        background: var(--background-light);
        font-weight: 600;
        color: var(--text-color);
    }

    .response-text tr:nth-child(even) {
        background: var(--background-light);
    }

    /* Links */
    .response-text a {
        color: var(--primary-color);
        text-decoration: underline;
        transition: var(--transition);
    }

    .response-text a:hover {
        color: var(--secondary-color);
    }

    /* Special Formatting for Analysis Content */
    .response-text .executive-summary {
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.05), rgba(30, 136, 229, 0.05));
        border-left: 4px solid var(--primary-color);
        padding: 1.5rem;
        border-radius: 8px;
        margin: 2rem 0;
    }

    .response-text .critical-notice {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.05), rgba(255, 82, 82, 0.05));
        border-left: 4px solid var(--danger-color);
        padding: 1.5rem;
        border-radius: 8px;
        margin: 2rem 0;
    }

    .response-text .warning-notice {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.05), rgba(255, 152, 0, 0.05));
        border-left: 4px solid var(--warning-color);
        padding: 1.5rem;
        border-radius: 8px;
        margin: 2rem 0;
    }

    /* Section Dividers */
    .response-text .section-divider {
        display: flex;
        align-items: center;
        text-align: center;
        margin: 2rem 0;
    }

    .response-text .section-divider::before,
    .response-text .section-divider::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid var(--border-color);
    }

    .response-text .section-divider::before {
        margin-right: 1rem;
    }

    .response-text .section-divider::after {
        margin-left: 1rem;
    }

    /* Highlight Important Text */
    .response-text mark {
        background: rgba(255, 235, 59, 0.3);
        padding: 0.125rem 0.25rem;
        border-radius: 3px;
    }

    /* Special Characters and Symbols */
    .response-text .bullet-point {
        margin-right: 0.5rem;
        color: var(--primary-color);
    }

    /* Print Styles */
    @media print {
        .response-text {
            border: none;
            padding: 0;
        }

        .response-text h1,
        .response-text h2 {
            page-break-after: avoid;
        }

        .response-text ul,
        .response-text ol {
            page-break-inside: avoid;
        }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .response-text {
            padding: 1.5rem;
            font-size: 0.9rem;
        }

        .response-text h1 {
            font-size: 1.5rem;
        }

        .response-text h2 {
            font-size: 1.25rem;
        }

        .response-text ul,
        .response-text ol {
            padding-left: 1.5rem;
        }
    }
</style>

<script>

    // Global state
    let currentMode = 'project';
    let selectedProject = null;
    let selectedDocuments = [];
    let selectedDocument = null;
    let allProjects = []; // Store fetched projects
    let allDocuments = [];
    // Store fetched documents


    // =====================================================
    // HELPER: Get Authentication Token
    // =====================================================
    function getAuthToken() {
        // First check localStorage/sessionStorage
        let token = localStorage.getItem('token') || sessionStorage.getItem('token');

        if (token) {
            return token;
        }

        // If not found, try to get from cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'access_token' || name === 'token') {
                return value;
            }
        }

        return '';
    }
    // =====================================================
    // HELPER: Get Auth Headers
    // =====================================================
    function getAuthHeaders() {
        const token = getAuthToken();
        return {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${token}`
        };
    }

    // =====================================================
    // FIXED: Load Real Projects from API with Auth
    // =====================================================
    async function loadProjects() {
        try {
            const response = await fetch('/api/projects/list?page=1&page_size=50', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (response.status === 401) {
                console.log('Unauthorized - redirecting to login');
                showNotification('Please log in to continue', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('Projects loaded:', result);

            if (result.success && result.data) {
                allProjects = result.data;

                // Fetch document counts for each project
                await fetchDocumentCounts(result.data);

                renderProjects(result.data);
            } else {
                console.error('Failed to load projects:', result);
                showNotification('Failed to load projects', 'error');
                renderEmptyProjects();
            }
        } catch (error) {
            console.error('Error loading projects:', error);
            showNotification('Error loading projects: ' + error.message, 'error');
            renderEmptyProjects();
        }
    }
    async function fetchDocumentCounts(projects) {
        const countPromises = projects.map(async (project) => {
            try {
                const response = await fetch(`/api/projects/${project.id}/documents`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        project.documentCount = result.data.length;
                    } else {
                        project.documentCount = 0;
                    }
                } else {
                    project.documentCount = 0;
                }
            } catch (error) {
                console.warn(`Failed to fetch document count for project ${project.id}:`, error);
                project.documentCount = 0;
            }
        });

        await Promise.all(countPromises);
    }
    // =====================================================
    // FIXED: Load ALL Documents from ALL Projects with Auth
    // =====================================================
    async function loadAllDocuments() {
        try {
            showNotification('Loading documents...', 'info');

            // Step 1: Get all projects first
            const projectsResponse = await fetch('/api/projects/list?page=1&page_size=100', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (projectsResponse.status === 401) {
                console.log('Unauthorized - redirecting to login');
                showNotification('Please log in to continue', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            if (!projectsResponse.ok) {
                throw new Error(`Failed to load projects: ${projectsResponse.status}`);
            }

            const projectsResult = await projectsResponse.json();
            console.log('Projects loaded:', projectsResult);

            if (!projectsResult.success || !projectsResult.data || projectsResult.data.length === 0) {
                console.log('No projects found');
                renderEmptyDocuments();
                return;
            }

            // Step 2: Get documents from ALL projects
            const allProjects = projectsResult.data;
            let allDocs = [];

            for (const project of allProjects) {
                try {
                    const docsResponse = await fetch(`/api/projects/${project.id}/documents`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });

                    if (docsResponse.ok) {
                        const docsResult = await docsResponse.json();
                        if (docsResult.success && docsResult.data) {
                            const docsWithProject = docsResult.data.map(doc => ({
                                ...doc,
                                project_id: project.id,
                                project_title: project.title,
                                project_code: project.code
                            }));
                            allDocs = allDocs.concat(docsWithProject);
                        }
                    }
                } catch (error) {
                    console.warn(`Failed to load documents for project ${project.id}:`, error);
                }
            }

            console.log(`‚úÖ Loaded ${allDocs.length} documents from ${allProjects.length} projects`);

            if (allDocs.length > 0) {
                allDocuments = allDocs;
                renderDocuments(allDocs);
                showNotification(`${allDocs.length} documents loaded from all projects`, 'success');

                const docSection = document.getElementById('documentSelectionSection');
                if (docSection) {
                    docSection.style.display = 'block';
                }
            } else {
                renderEmptyDocuments();
                showNotification('No documents found in any project', 'info');
            }

        } catch (error) {
            console.error('Error loading documents:', error);
            showNotification('Error loading documents: ' + error.message, 'error');
            renderEmptyDocuments();
        }
    }

    // =====================================================
    // Helper: Clean and Structure Response Text
    // =====================================================
    function cleanResponseHTML(html) {
        // Remove extra whitespace
        html = html.replace(/\s+/g, ' ');

        // Ensure proper spacing around headers
        html = html.replace(/<\/h([1-6])>/g, '</h$1>\n');
        html = html.replace(/<h([1-6])>/g, '\n<h$1>');

        // Ensure proper spacing around lists
        html = html.replace(/<\/ul>/g, '</ul>\n');
        html = html.replace(/<\/ol>/g, '</ol>\n');
        html = html.replace(/<ul>/g, '\n<ul>\n');
        html = html.replace(/<ol>/g, '\n<ol>\n');

        // Ensure proper spacing around paragraphs
        html = html.replace(/<\/p>/g, '</p>\n');
        html = html.replace(/<p>/g, '\n<p>');

        return html.trim();
    }

    // =====================================================
    // UPDATED: Display AI Response with Better Formatting
    // =====================================================
    function displayRealAIResponse(result) {
        const responseText = document.getElementById('responseText');

        if (!responseText) {
            console.error('Response text element not found');
            return;
        }

        // Process and format the AI content
        let formattedContent = result.content || '<p>No analysis content returned.</p>';

        // Add proper line breaks and formatting
        formattedContent = formatAIResponseContent(formattedContent);

        // Display the formatted content
        responseText.innerHTML = formattedContent;

        // Update confidence score
        updateConfidenceScore(result.confidence || 0);

        // Update processing time
        updateProcessingTime(result.processingTime || 0);

        // Update source references
        updateSourceReferences(result.sources || []);

        // Display additional sections
        if (result.recommendations && result.recommendations.length > 0) {
            displayRecommendations(result.recommendations);
        }

        if (result.key_points && result.key_points.length > 0) {
            displayKeyPoints(result.key_points);
        }

        if (result.suggested_actions && result.suggested_actions.length > 0) {
            displaySuggestedActions(result.suggested_actions);
        }

        console.log(`‚úÖ AI used ${result.tokens_used || 0} tokens`);
    }

    // =====================================================
    // NEW: Format AI Response Content for Better Display
    // =====================================================
    function formatAIResponseContent(content) {
        if (!content) return '';

        // Convert markdown-style headers to proper HTML
        content = content.replace(/^# (.+)$/gm, '<h1>$1</h1>');
        content = content.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        content = content.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        content = content.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
        content = content.replace(/^##### (.+)$/gm, '<h5>$1</h5>');

        // Convert **bold** and *italic*
        content = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        content = content.replace(/\*(.+?)\*/g, '<em>$1</em>');

        // Convert bullet points
        content = content.replace(/^[‚Ä¢¬∑] (.+)$/gm, '<li>$1</li>');
        content = content.replace(/^- (.+)$/gm, '<li>$1</li>');

        // Wrap consecutive list items in <ul>
        content = content.replace(/(<li>.*<\/li>\s*)+/g, '<ul>$&</ul>');

        // Convert numbered lists
        content = content.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
        content = content.replace(/(<li>.*<\/li>\s*)+/g, (match) => {
            if (!match.includes('<ul>')) {
                return '<ol>' + match + '</ol>';
            }
            return match;
        });

        // Add paragraph tags to text blocks
        const lines = content.split('\n');
        let formatted = '';
        let inList = false;

        for (let line of lines) {
            line = line.trim();

            if (!line) {
                formatted += '<br>';
                continue;
            }

            if (line.startsWith('<h') || line.startsWith('<ul>') || line.startsWith('<ol>') || line.startsWith('<li>')) {
                formatted += line + '\n';
                inList = line.startsWith('<ul>') || line.startsWith('<ol>');
            } else if (line.startsWith('</ul>') || line.startsWith('</ol>')) {
                formatted += line + '\n';
                inList = false;
            } else if (!inList && !line.startsWith('<')) {
                formatted += '<p>' + line + '</p>\n';
            } else {
                formatted += line + '\n';
            }
        }

        return formatted;
    }

    // =====================================================
    // Display functions for recommendations, key points, etc.
    // =====================================================
    function displayRecommendations(recommendations) {
        const responseSection = document.getElementById('responseSection');
        if (!responseSection) return;

        const recommendationsHtml = `
            <div class="recommendations-section">
                <h4><i class="ti ti-bulb"></i> Recommendations</h4>
                <ul class="recommendation-list">
                    ${recommendations.map(rec => `<li>${escapeHtml(rec)}</li>`).join('')}
                </ul>
            </div>
        `;

        const existingRecommendations = responseSection.querySelector('.recommendations-section');
        if (existingRecommendations) {
            existingRecommendations.remove();
        }

        responseSection.insertAdjacentHTML('beforeend', recommendationsHtml);
    }

    function displayKeyPoints(keyPoints) {
        const responseSection = document.getElementById('responseSection');
        if (!responseSection) return;

        const keyPointsHtml = `
            <div class="key-points-section">
                <h4><i class="ti ti-key"></i> Key Points</h4>
                <ul class="key-points-list">
                    ${keyPoints.map(point => `<li>${escapeHtml(point)}</li>`).join('')}
                </ul>
            </div>
        `;

        const existingKeyPoints = responseSection.querySelector('.key-points-section');
        if (existingKeyPoints) {
            existingKeyPoints.remove();
        }

        responseSection.insertAdjacentHTML('beforeend', keyPointsHtml);
    }

    function displaySuggestedActions(actions) {
        const responseSection = document.getElementById('responseSection');
        if (!responseSection) return;

        const actionsHtml = `
            <div class="suggested-actions-section">
                <h4><i class="ti ti-checklist"></i> Suggested Actions</h4>
                <ul class="actions-list">
                    ${actions.map((action, idx) => `
                        <li>
                            <span class="action-number">${idx + 1}</span>
                            ${escapeHtml(action)}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;

        const existingActions = responseSection.querySelector('.suggested-actions-section');
        if (existingActions) {
            existingActions.remove();
        }

        responseSection.insertAdjacentHTML('beforeend', actionsHtml);
    }

    function displayErrorResponse(errorMessage) {
        const responseText = document.getElementById('responseText');
        if (!responseText) return;

        responseText.innerHTML = `
            <div class="error-message">
                <i class="ti ti-alert-circle"></i>
                <strong>Analysis Error</strong>
                <p>${escapeHtml(errorMessage)}</p>
                <p style="margin-top: 0.5rem; font-size: 0.875rem;">Please try again or contact support if the issue persists.</p>
            </div>
        `;

        updateConfidenceScore(0);
        const timeElement = document.querySelector('.analysis-time span');
        if (timeElement) {
            timeElement.textContent = 'Analysis failed';
        }
    }

    function updateConfidenceScore(confidence) {
        const scoreFill = document.querySelector('.score-fill');
        const scoreValue = document.querySelector('.score-value');

        if (scoreFill && scoreValue) {
            const confidencePercent = Math.round(confidence);
            scoreFill.style.width = `${confidencePercent}%`;
            scoreValue.textContent = `${confidencePercent}%`;

            if (confidencePercent >= 90) {
                scoreFill.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
                scoreValue.style.color = '#28a745';
            } else if (confidencePercent >= 75) {
                scoreFill.style.background = 'linear-gradient(90deg, #ffc107, #28a745)';
                scoreValue.style.color = '#ffc107';
            } else if (confidencePercent >= 60) {
                scoreFill.style.background = 'linear-gradient(90deg, #ff9800, #ffc107)';
                scoreValue.style.color = '#ff9800';
            } else {
                scoreFill.style.background = 'linear-gradient(90deg, #dc3545, #ff9800)';
                scoreValue.style.color = '#dc3545';
            }
        }
    }

    function updateProcessingTime(timeInSeconds) {
        const timeElement = document.querySelector('.analysis-time span');
        if (timeElement) {
            timeElement.textContent = `Analysis completed in ${timeInSeconds.toFixed(1)} seconds`;
        }
    }

    function updateSourceReferences(sources) {
        const referenceList = document.querySelector('.reference-list');
        if (!referenceList) return;

        if (!sources || sources.length === 0) {
            referenceList.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">No source references available.</p>';
            return;
        }

        referenceList.innerHTML = sources.map(source => {
            const iconMap = {
                'email': 'ti-mail',
                'document': 'ti-file-text',
                'contract': 'ti-file-certificate',
                'pdf': 'ti-file-type-pdf',
                'doc': 'ti-file-type-doc',
                'docx': 'ti-file-type-doc'
            };

            const icon = iconMap[source.type] || 'ti-file-text';

            return `
                <div class="reference-item" data-source-id="${source.id}">
                    <i class="ti ${icon}"></i>
                    <span>${escapeHtml(source.name)} - ${escapeHtml(source.contract || 'Document')}</span>
                </div>
            `;
        }).join('');
    }

    // =====================================================
    // Render Projects in the Grid
    // =====================================================
    function renderProjects(projects) {
        const projectGrid = document.querySelector('.project-grid');

        if (!projectGrid) {
            console.error('Project grid not found');
            return;
        }

        if (!projects || projects.length === 0) {
            renderEmptyProjects();
            return;
        }

        projectGrid.innerHTML = projects.map((project, index) => {
            const statusMap = {
                'active': { class: 'in-progress', label: 'Active' },
                'planning': { class: 'internal-review', label: 'Planning' },
                'completed': { class: 'completed', label: 'Completed' },
                'on-hold': { class: 'on-hold', label: 'On Hold' },
                'draft': { class: 'draft', label: 'Draft' },
                'in-progress': { class: 'in-progress', label: 'In Progress' },
                'internal-review': { class: 'internal-review', label: 'Internal Review' }
            };

            const statusInfo = statusMap[project.status] || { class: 'internal-review', label: project.status };
            const startDate = project.startDate ? new Date(project.startDate).toLocaleDateString() : 'Not set';

            // Use the fetched document count
            const docCount = project.documentCount || 0;

            return `
            <div class="project-card ${index === 0 ? 'active' : ''}" onclick="selectProject(this, ${project.id})">
                <div class="project-status">
                    <span class="status-badge ${statusInfo.class}">${statusInfo.label}</span>
                </div>
                <div class="project-info">
                    <h4>${escapeHtml(project.title || 'Untitled Project')}</h4>
                    <p class="project-code">Code: ${escapeHtml(project.code || 'N/A')}</p>
                    <div class="project-meta">
                        <span class="meta-item">
                            <i class="ti ti-calendar"></i>
                            ${startDate}
                        </span>
                        <span class="meta-item">
                            <i class="ti ti-file"></i>
                            ${docCount} Document${docCount !== 1 ? 's' : ''}
                        </span>
                    </div>
                </div>
                <div class="project-actions">
                    <button class="btn-icon" onclick="viewProjectDetails(event, ${project.id})" title="View Details">
                        <i class="ti ti-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="viewAuditTrail(event, ${project.id})" title="Audit Trail">
                        <i class="ti ti-history"></i>
                    </button>
                </div>
            </div>
        `;
        }).join('');

        // Auto-select first project
        if (projects.length > 0) {
            setTimeout(() => {
                const firstCard = projectGrid.querySelector('.project-card');
                if (firstCard && firstCard.classList.contains('active')) {
                    selectProject(firstCard, projects[0].id);
                }
            }, 100);
        }
    }

    // =====================================================
    // Render Empty State
    // =====================================================
    function renderEmptyProjects() {
        const projectGrid = document.querySelector('.project-grid');
        if (!projectGrid) return;

        projectGrid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;">
                <i class="ti ti-folder-off"></i>
            </div>
            <h3 style="color: var(--text-color); margin-bottom: 0.5rem;">No Projects Found</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Create your first project to start managing correspondence
            </p>
            <button class="btn-primary" onclick="window.location.href='/projects/create'">
                <i class="ti ti-plus"></i>
                Create Project
            </button>
        </div>
    `;
    }

    // =====================================================
    // Helper Function to Escape HTML
    // =====================================================
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
    }

    // =====================================================
    // Refresh Projects Function
    // =====================================================
    async function refreshProjects() {
        showNotification('Refreshing project list...', 'info');
        await loadProjects();
        showNotification('Project list updated!', 'success');
    }

    // =====================================================
    // Mode Selection
    // =====================================================
    function selectMode(mode) {
        currentMode = mode;

        document.querySelectorAll('.mode-card').forEach(card => {
            card.classList.remove('active');
            card.querySelector('.radio-button').classList.remove('active');
        });

        const selectedCard = document.getElementById(mode + 'Mode');
        if (selectedCard) {
            selectedCard.classList.add('active');
            selectedCard.querySelector('.radio-button').classList.add('active');
        }

        document.getElementById('projectSection').style.display = mode === 'project' ? 'block' : 'none';
        document.getElementById('documentSection').style.display = mode === 'document' ? 'block' : 'none';

        // Load document mode list when switching to document mode
        if (mode === 'document') {
            loadDocumentModeList();
        }

        resetSelections();
    }

    // =====================================================
    // Project Selection
    // =====================================================
    function selectProject(element, projectId) {
        document.querySelectorAll('.project-card').forEach(card => {
            card.classList.remove('active');
        });

        element.classList.add('active');
        selectedProject = projectId;

        const project = allProjects.find(p => p.id === projectId);
        if (project) {
            console.log('Selected project:', project);
        }

        const docSection = document.getElementById('documentSelectionSection');
        if (docSection) {
            docSection.style.display = 'block';
            setTimeout(() => {
                docSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }

        loadProjectDocuments(projectId);
    }

    // =====================================================
    // FIXED: Load Documents for Selected Project with Auth
    // =====================================================
    async function loadProjectDocuments(projectId) {
        try {
            showNotification('Loading documents...', 'info');

            const response = await fetch(`/api/projects/${projectId}/documents`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (response.status === 401) {
                console.log('Unauthorized - redirecting to login');
                showNotification('Please log in to continue', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('Documents loaded:', result);

            if (result.success && result.data) {
                allDocuments = result.data;

                // Update project document count in the array
                const project = allProjects.find(p => p.id === projectId);
                if (project) {
                    project.documentCount = result.data.length;
                }

                renderDocuments(result.data);
                showNotification(`${result.data.length} document${result.data.length !== 1 ? 's' : ''} loaded`, 'success');
            } else {
                console.log('No documents found for project');
                renderEmptyDocuments();
            }
        } catch (error) {
            console.error('Error loading documents:', error);
            showNotification('Error loading documents: ' + error.message, 'error');
            renderEmptyDocuments();
        }
    }
    // =====================================================
    // Render Documents
    // =====================================================
    function renderDocuments(documents) {
        const documentList = document.querySelector('.document-list');

        if (!documentList) {
            console.error('Document list not found');
            return;
        }

        if (!documents || documents.length === 0) {
            renderEmptyDocuments();
            return;
        }

        selectedDocuments = [];

        documentList.innerHTML = documents.map((doc, index) => {
            const iconMap = {
                'pdf': 'ti-file-type-pdf',
                'doc': 'ti-file-type-doc',
                'docx': 'ti-file-type-doc',
                'xls': 'ti-file-type-xls',
                'xlsx': 'ti-file-type-xls',
                'txt': 'ti-file-text',
                'email': 'ti-mail',
                'eml': 'ti-mail',
                'contract': 'ti-file-text',
                'specification': 'ti-file-text',
                'scope': 'ti-file-text',
                'financial': 'ti-file-type-xls',
                'certificate': 'ti-certificate'
            };

            const fileType = (doc.type || '').toLowerCase();
            const icon = iconMap[fileType] || 'ti-file-text';
            const isEmail = fileType === 'email' || fileType === 'eml' || (doc.name || '').toLowerCase().includes('.eml');

            const uploadDate = doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : 'Unknown';
            const fileSize = doc.size || doc.file_size || '‚Äî';

            return `
            <div class="document-item" data-doc-id="${doc.id}" onclick="toggleDocument(this, '${doc.id}')">
                <div class="document-selector">
                    <input type="checkbox" id="doc-${doc.id}">
                    <label for="doc-${doc.id}" class="checkbox-label">
                        <i class="ti ti-check"></i>
                    </label>
                </div>
                <div class="document-icon ${isEmail ? 'email' : ''}">
                    <i class="ti ${icon}"></i>
                </div>
                <div class="document-info">
                    <h4>${escapeHtml(doc.name)}</h4>
                    <p>${doc.project_title ? 'Project: ' + escapeHtml(doc.project_title) : 'Document'}</p>
                    <div class="document-meta">
                        <span class="meta-tag">
                            <i class="ti ${icon}"></i>
                            ${fileType ? fileType.toUpperCase() : 'FILE'}
                        </span>
                        ${doc.project_code ? `
                            <span class="meta-tag">
                                <i class="ti ti-folder"></i>
                                ${escapeHtml(doc.project_code)}
                            </span>
                        ` : ''}
                        <span class="meta-tag">
                            <i class="ti ti-calendar"></i>
                            ${uploadDate}
                        </span>
                        ${fileSize !== '‚Äî' ? `
                            <span class="meta-tag">
                                <i class="ti ti-file-size"></i>
                                ${fileSize}
                            </span>
                        ` : ''}
                    </div>
                </div>
                <div class="document-actions">
                    <button class="btn-icon" onclick="previewDocument(event, '${doc.id}')" title="Preview">
                        <i class="ti ti-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="downloadDocument(event, '${doc.id}')" title="Download">
                        <i class="ti ti-download"></i>
                    </button>
                    ${isEmail ? `
                        <button class="btn-icon" onclick="replyToEmail(event, '${doc.id}')" title="Reply">
                            <i class="ti ti-reply"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        }).join('');

        updateProceedButton();
        updateSelectedCount();
    }

    // =====================================================
    // UPDATED: Render Empty Documents State with working upload
    // =====================================================
    function renderEmptyDocuments() {
        const documentList = document.querySelector('.document-list');
        if (!documentList) return;

        documentList.innerHTML = `
        <div style="text-align: center; padding: 3rem; grid-column: 1/-1;">
            <div style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;">
                <i class="ti ti-file-off"></i>
            </div>
            <h3 style="color: var(--text-color); margin-bottom: 0.5rem;">No Documents Found</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Upload documents to this project to start analyzing them
            </p>
            <button class="btn-primary" onclick="uploadDocumentsToProject()">
                <i class="ti ti-upload"></i>
                Upload Documents
            </button>
        </div>
    `;
    }

    // =====================================================
    // Document Selection
    // =====================================================
    function toggleDocument(element, docId) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        if (!checkbox) return;

        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
            if (!selectedDocuments.includes(docId)) {
                selectedDocuments.push(docId);
            }
            element.classList.add('selected');
        } else {
            selectedDocuments = selectedDocuments.filter(id => id !== docId);
            element.classList.remove('selected');
        }

        updateProceedButton();
        updateSelectedCount();
    }

    function selectAllDocuments() {
        document.querySelectorAll('.document-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
            const docItem = checkbox.closest('.document-item');
            docItem.classList.add('selected');
            const docId = docItem.getAttribute('data-doc-id');
            if (docId && !selectedDocuments.includes(docId)) {
                selectedDocuments.push(docId);
            }
        });

        updateProceedButton();
        updateSelectedCount();
        showNotification('All documents selected', 'success');
    }

    function clearDocumentSelection() {
        document.querySelectorAll('.document-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.document-item').classList.remove('selected');
        });

        selectedDocuments = [];
        updateProceedButton();
        updateSelectedCount();
        showNotification('Document selection cleared', 'info');
    }

    function updateProceedButton() {
        const proceedBtn = document.getElementById('proceedBtn');
        if (proceedBtn) {
            proceedBtn.disabled = selectedDocuments.length === 0;
        }
    }

    function updateSelectedCount() {
        const countElement = document.getElementById('selectedCount');
        if (countElement) {
            countElement.textContent = selectedDocuments.length;
        }
    }

    // =====================================================
    // Document Mode Selection
    // =====================================================
    function selectDocument(element, docId) {
        document.querySelectorAll('.document-card').forEach(card => {
            card.classList.remove('active');
        });

        element.classList.add('active');
        selectedDocument = docId;
        selectedDocuments = [docId]; // Set single document for document mode
        proceedToQuery();
    }

    // =====================================================
    // Proceed to Query
    // =====================================================
    function proceedToQuery() {
        const querySection = document.getElementById('querySection');
        if (querySection) {
            querySection.style.display = 'block';
            document.getElementById('responseSection').style.display = 'none';

            setTimeout(() => {
                querySection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }
    }

    // =====================================================
    // Query Templates
    // =====================================================
    function useTemplate(templateType) {
        const queryInput = document.getElementById('queryInput');
        if (!queryInput) return;

        const templates = {
            'backcharge': "We received a back charge letter. Based on the selected project files, please provide contractually viable guidance on how to defend our rights and respond to this back charge while ensuring our best benefit.",
            'dispute': "There appears to be a dispute regarding contract terms. Please analyze the selected documents and provide guidance on the best approach for dispute resolution based on the contract clauses.",
            'termination': "We need guidance on contract termination procedures. Please review the selected documents and advise on the proper termination process and our rights/obligations.",
            'compliance': "Please review the selected documents for compliance with contractual obligations and highlight any areas of concern or recommended actions."
        };

        const template = templates[templateType] || '';
        if (template) {
            queryInput.value = template;
            queryInput.focus();
            showNotification('Template applied', 'success');
        }
    }

    // =====================================================
    // FIXED: Query Submission with Authentication
    // =====================================================
    async function submitQuery() {
        const queryText = document.getElementById('queryInput').value.trim();
        const tone = document.getElementById('toneSelector').value;
        const urgency = document.getElementById('urgencyLevel').value;

        // Validation
        if (!queryText) {
            showNotification('Please enter your query before submitting.', 'warning');
            document.getElementById('queryInput').focus();
            return;
        }

        if (currentMode === 'project' && selectedDocuments.length === 0) {
            showNotification('Please select at least one document for analysis.', 'warning');
            return;
        }

        if (currentMode === 'document' && !selectedDocument && selectedDocuments.length === 0) {
            showNotification('Please select a document for analysis.', 'warning');
            return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing with AI...';
        submitBtn.disabled = true;

        try {
            const startTime = Date.now();

            // Prepare request payload
            const requestPayload = {
                query: queryText,
                mode: currentMode,
                document_ids: selectedDocuments,
                project_id: selectedProject,
                tone: tone,
                urgency: urgency,
                language: 'en'
            };

            console.log('üì§ Sending analysis request:', requestPayload);

            // Make API call with credentials
            const response = await fetch('/api/correspondence/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include', // Important: sends cookies
                body: JSON.stringify(requestPayload)
            });

            console.log('üì• Response status:', response.status);

            // Handle 401 Unauthorized
            if (response.status === 401) {
                console.log('Unauthorized - redirecting to login');
                showNotification('Please log in to continue', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Analysis request failed with status ${response.status}`);
            }

            const result = await response.json();
            console.log('‚úÖ Analysis response received:', result);

            // Display the real AI response
            displayRealAIResponse(result);

            // Show response section
            document.getElementById('responseSection').style.display = 'block';
            setTimeout(() => {
                document.getElementById('responseSection').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);

            showNotification('AI analysis completed successfully!', 'success');

        } catch (error) {
            console.error('‚ùå Query submission error:', error);
            showNotification(`Error: ${error.message}`, 'error');
            displayErrorResponse(error.message);
            document.getElementById('responseSection').style.display = 'block';

        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // =====================================================
    // Document Actions
    // =====================================================
    function previewDocument(event, docId) {
        event.stopPropagation();

        const doc = allDocuments.find(d => d.id == docId);
        const docName = doc ? doc.name : 'Document Preview';

        document.getElementById('previewDocTitle').textContent = docName;
        openModal('documentPreviewModal');

        const viewer = document.getElementById('documentViewer');
        viewer.innerHTML = `
        <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
            <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
            <p>Loading document preview...</p>
        </div>
    `;

        setTimeout(() => {
            viewer.innerHTML = `
            <div style="background: white; padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color);">
                <h3>${docName}</h3>
                <p><strong>Document Type:</strong> ${doc ? doc.type : 'Unknown'}</p>
                <p><strong>Project:</strong> ${doc ? doc.project_title : 'N/A'}</p>
                <p><strong>Size:</strong> ${doc ? (doc.size || doc.file_size || 'Unknown') : 'Unknown'}</p>
                <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border-color);">
                <div style="line-height: 1.6;">
                    <p>Document preview will be displayed here. Integrate with a document viewer library for full functionality.</p>
                </div>
            </div>
        `;
        }, 1500);
    }

    function downloadDocument(event, docId) {
        if (event) event.stopPropagation();
        const doc = allDocuments.find(d => d.id == docId);
        if (doc && doc.path) {
            const token = getAuthToken();
            const downloadUrl = doc.path + (doc.path.includes('?') ? '&' : '?') + `token=${token}`;
            window.open(downloadUrl, '_blank');
        } else {
            showNotification('Document download started...', 'success');
        }
    }

    function replyToEmail(event, emailId) {
        if (event) event.stopPropagation();
        openModal('queryModal');
    }

    // =====================================================
    // Project Actions
    // =====================================================
    function viewProjectDetails(event, projectId) {
        if (event) event.stopPropagation();
        window.location.href = `/projects/${projectId}`;
    }

    function viewAuditTrail(event, projectId) {
        if (event) event.stopPropagation();
        showNotification('Opening audit trail...', 'info');
    }

    // =====================================================
    // Utility Functions
    // =====================================================
    function clearQuery() {
        document.getElementById('queryInput').value = '';
    }

    async function pasteFromClipboard() {
        try {
            if (navigator.clipboard) {
                const text = await navigator.clipboard.readText();
                document.getElementById('queryInput').value = text;
                showNotification('Text pasted from clipboard', 'success');
            }
        } catch {
            showNotification('Unable to access clipboard', 'warning');
        }
    }

    function saveAsDraft() {
        const queryText = document.getElementById('queryInput').value.trim();
        if (!queryText) {
            showNotification('Nothing to save as draft.', 'warning');
            return;
        }
        localStorage.setItem('correspondence_draft', JSON.stringify({
            query: queryText,
            selectedDocuments,
            selectedProject,
            timestamp: Date.now()
        }));
        showNotification('Query saved as draft!', 'success');
    }

    // =====================================================
    // Response Actions
    // =====================================================
    function exportResponse() {
        showNotification('Exporting response...', 'info');
    }

    function shareResponse() {
        if (navigator.share) {
            navigator.share({
                title: 'AI Correspondence Analysis',
                text: 'AI-generated correspondence analysis',
                url: window.location.href
            });
        } else {
            showNotification('Share functionality not supported', 'warning');
        }
    }

    function generateNewResponse() {
        submitQuery();
    }

    // =====================================================
    // Modal Functions
    // =====================================================
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
    }

    function letAIGenerate() {
        openModal('responsePreviewModal');
    }

    function submitModalQuery() {
        const query = document.getElementById('modalQueryInput')?.value.trim();
        if (!query) {
            showNotification('Please enter your query.', 'warning');
            return;
        }

        const mainQueryInput = document.getElementById('queryInput');
        if (mainQueryInput) {
            mainQueryInput.value = query;
        }

        closeModal('queryModal');
        showNotification('Query transferred!', 'success');
    }

    function editResponse() {
        closeModal('responsePreviewModal');
    }

    function acceptResponse() {
        closeModal('responsePreviewModal');
        document.getElementById('responseSection').style.display = 'block';
    }

    // =====================================================
    // Document Viewer Functions
    // =====================================================
    function zoomIn() {
        const viewer = document.getElementById('documentViewer');
        if (viewer) {
            const currentZoom = parseFloat(viewer.style.zoom) || 1;
            viewer.style.zoom = (currentZoom + 0.1).toString();
        }
    }

    function zoomOut() {
        const viewer = document.getElementById('documentViewer');
        if (viewer) {
            const currentZoom = parseFloat(viewer.style.zoom) || 1;
            viewer.style.zoom = Math.max(0.5, currentZoom - 0.1).toString();
        }
    }

    function toggleFullscreen() {
        const modal = document.getElementById('documentPreviewModal');
        if (modal) modal.classList.toggle('fullscreen');
    }

    // =====================================================
    // Reset Functions
    // =====================================================
    function resetSelections() {
        selectedProject = null;
        selectedDocuments = [];
        selectedDocument = null;

        ['documentSelectionSection', 'querySection', 'responseSection'].forEach(id => {
            const section = document.getElementById(id);
            if (section) section.style.display = 'none';
        });

        const queryInput = document.getElementById('queryInput');
        if (queryInput) queryInput.value = '';

        document.querySelectorAll('.project-card, .document-card').forEach(card => {
            card.classList.remove('active');
        });

        document.querySelectorAll('.document-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.document-item')?.classList.remove('selected');
        });

        updateProceedButton();
    }

    // =====================================================
    // Notification Function
    // =====================================================
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem;
        background: ${type === 'success' ? 'var(--success-bg)' :
                type === 'warning' ? 'var(--warning-bg)' :
                    type === 'error' ? '#fee' : 'var(--info-bg)'};
        color: ${type === 'success' ? 'var(--success-color)' :
                type === 'warning' ? 'var(--warning-color)' :
                    type === 'error' ? 'var(--danger-color)' : 'var(--info-color)'};
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000; max-width: 400px; animation: slideInRight 0.3s ease;
        display: flex; align-items: center; gap: 0.5rem;
    `;

        const icon = type === 'success' ? 'ti-check-circle' :
            type === 'warning' ? 'ti-alert-triangle' :
                type === 'error' ? 'ti-x-circle' : 'ti-info-circle';

        notification.innerHTML = `<i class="ti ${icon}"></i><span>${message}</span>`;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }

    // =====================================================
    // FIXED: Load Documents for Document Mode with Auth
    // =====================================================
    async function loadDocumentModeList() {
        const grid = document.getElementById('documentModeGrid');

        if (!grid) {
            console.error('Document mode grid not found');
            return;
        }

        grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
            <div class="loading-spinner" style="margin: 0 auto 2rem; width: 3rem; height: 3rem;"></div>
            <p style="color: var(--text-muted);">Loading all documents...</p>
        </div>
    `;

        try {
            const projectsResponse = await fetch('/api/projects/list?page=1&page_size=100', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (projectsResponse.status === 401) {
                console.log('Unauthorized - redirecting to login');
                showNotification('Please log in to continue', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            if (!projectsResponse.ok) {
                throw new Error(`Failed to load projects: ${projectsResponse.status}`);
            }

            const projectsResult = await projectsResponse.json();

            if (!projectsResult.success || !projectsResult.data || projectsResult.data.length === 0) {
                renderEmptyDocumentModeGrid();
                return;
            }

            const allProjects = projectsResult.data;
            let allDocs = [];

            for (const project of allProjects) {
                try {
                    const docsResponse = await fetch(`/api/projects/${project.id}/documents`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });

                    if (docsResponse.ok) {
                        const docsResult = await docsResponse.json();
                        if (docsResult.success && docsResult.data) {
                            const docsWithProject = docsResult.data.map(doc => ({
                                ...doc,
                                project_id: project.id,
                                project_title: project.title,
                                project_code: project.code
                            }));
                            allDocs = allDocs.concat(docsWithProject);
                        }
                    }
                } catch (error) {
                    console.warn(`Failed to load documents for project ${project.id}:`, error);
                }
            }

            console.log(`‚úÖ Loaded ${allDocs.length} documents for document mode`);

            if (allDocs.length > 0) {
                renderDocumentModeGridWithDocuments(allDocs);
                showNotification(`${allDocs.length} documents loaded`, 'success');
            } else {
                renderEmptyDocumentModeGrid();
            }

        } catch (error) {
            console.error('Error loading documents for document mode:', error);
            showNotification('Error loading documents: ' + error.message, 'error');
            renderEmptyDocumentModeGrid();
        }
    }

    function renderDocumentModeGridWithDocuments(documents) {
        const grid = document.getElementById('documentModeGrid');

        if (!grid) return;

        if (!documents || documents.length === 0) {
            renderEmptyDocumentModeGrid();
            return;
        }

        grid.innerHTML = documents.map(doc => {
            const typeIcons = {
                'pdf': 'ti-file-type-pdf',
                'doc': 'ti-file-type-doc',
                'docx': 'ti-file-type-doc',
                'xls': 'ti-file-type-xls',
                'xlsx': 'ti-file-type-xls',
                'txt': 'ti-file-text',
                'contract': 'ti-file-certificate',
                'email': 'ti-mail',
                'eml': 'ti-mail'
            };

            const fileType = (doc.type || 'document').toLowerCase();
            const icon = typeIcons[fileType] || 'ti-file-text';

            const lastUpdated = doc.uploaded_at ?
                new Date(doc.uploaded_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) :
                'Unknown';

            const statusBadge = ``;
            const pageInfo = doc.size || doc.file_size || '‚Äî';

            return `
            <div class="document-card" onclick="selectDocument(this, '${doc.id}')">
                <div class="document-type">
                    <i class="ti ${icon}"></i>
                </div>
                <div class="document-details">
                    <h4>${escapeHtml(doc.name || 'Untitled Document')}</h4>
                    <p>Project: ${escapeHtml(doc.project_title || 'N/A')}</p>
                    <div class="document-stats">
                        <span>${pageInfo}</span>
                        <span>Last updated: ${lastUpdated}</span>
                    </div>
                </div>
                <div class="document-status">
                    ${statusBadge}
                </div>
            </div>
        `;
        }).join('');
    }

    function renderEmptyDocumentModeGrid() {
        const grid = document.getElementById('documentModeGrid');

        if (!grid) return;

        grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;">
                <i class="ti ti-file-off"></i>
            </div>
            <h3 style="color: var(--text-color); margin-bottom: 0.5rem;">No Documents Found</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Upload documents to enable document-level analysis
            </p>
        </div>
    `;
    }




    async function refreshDocumentModeList() {
        showNotification('Refreshing document list...', 'info');
        await loadDocumentModeList();
        showNotification('Document list updated!', 'success');
    }

    // =====================================================
    // FIXED: Initialize on Page Load with Auth Check
    // =====================================================
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Correspondence Management: Initializing...');

        // Don't check token immediately, let the API calls handle auth
        // The backend will return 401 if not authenticated

        loadProjects();
        updateProceedButton();

        const style = document.createElement('style');
        style.textContent = `
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .modal.fullscreen .modal-content { width: 100vw; height: 100vh; max-width: none; border-radius: 0; }
        .loading-spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: white; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    `;
        document.head.appendChild(style);
    });


    // =====================================================
    // Keyboard Shortcuts
    // =====================================================
    document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            const queryInput = document.getElementById('queryInput');
            if (queryInput && queryInput === document.activeElement) {
                submitQuery();
            }
        }

        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.show').forEach(modal => {
                modal.classList.remove('show');
            });
            document.body.style.overflow = '';
        }
    });
    // =====================================================
    // UPDATED: Select Project with Simple Loader
    // =====================================================
    async function selectProject(element, projectId) {
        document.querySelectorAll('.project-card').forEach(card => {
            card.classList.remove('active');
        });

        element.classList.add('active');
        selectedProject = projectId;

        const docSection = document.getElementById('documentSelectionSection');
        if (docSection) {
            docSection.style.display = 'block';

            // Show loader
            const documentList = document.querySelector('.document-list');
            if (documentList) {
                documentList.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                    <div class="loading-spinner" style="margin: 0 auto 2rem; width: 3rem; height: 3rem;"></div>
                    <p style="color: var(--text-muted);">Loading project documents...</p>
                </div>
            `;
            }

            setTimeout(() => {
                docSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        await loadProjectDocuments(projectId);
    }

    // =====================================================
    // UPDATED: Load Projects with Simple Loader
    // =====================================================
    async function loadProjects() {
        const projectGrid = document.querySelector('.project-grid');

        if (!projectGrid) return;

        // Show loader
        projectGrid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
            <div class="loading-spinner" style="margin: 0 auto 2rem; width: 3rem; height: 3rem;"></div>
            <p style="color: var(--text-muted);">Loading projects...</p>
        </div>
    `;

        try {
            const response = await fetch('/api/projects/list?page=1&page_size=50', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (response.status === 401) {
                showNotification('Please log in to continue', 'error');
                setTimeout(() => window.location.href = '/login', 1500);
                return;
            }

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const result = await response.json();

            if (result.success && result.data) {
                allProjects = result.data;
                await fetchDocumentCounts(result.data);
                renderProjects(result.data);
            } else {
                renderEmptyProjects();
            }
        } catch (error) {
            console.error('Error loading projects:', error);
            showNotification('Error loading projects', 'error');
            renderEmptyProjects();
        }
    }
</script>


<script>
    // Correspondence Management JavaScript - Inline Implementation
    // Complete functionality for document analysis, AI queries, and response generation

    /**
     * Correspondence Management Module
     * Handles document analysis, AI queries, and response generation
     */

    class CorrespondenceManager {
        constructor() {
            this.currentMode = 'project';
            this.selectedProject = null;
            this.selectedDocuments = [];
            this.selectedDocument = null;
            this.queryHistory = [];
            this.aiResponses = [];

            this.init();
        }

        init() {
            this.bindEvents();
            this.updateUI();
            this.loadSettings();
        }

        bindEvents() {
            // Mode selection
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const mode = card.id.replace('Mode', '');
                    this.selectMode(mode);
                });
            });

            // Project selection
            document.querySelectorAll('.project-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const projectId = card.getAttribute('data-project-id') || 'project-1';
                    this.selectProject(card, projectId);
                });
            });

            // Document toggles
            document.querySelectorAll('.document-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.document-actions')) {
                        const docId = item.getAttribute('data-doc-id') || item.querySelector('input').id;
                        this.toggleDocument(item, docId);
                    }
                });
            });

            // Query form submission
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', () => this.submitQuery());
            }

            // Template buttons
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateType = btn.getAttribute('data-template') ||
                        btn.textContent.toLowerCase().replace(/\s+/g, '');
                    this.useTemplate(templateType);
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));

            // Auto-save functionality
            const queryInput = document.getElementById('queryInput');
            if (queryInput) {
                let saveTimeout;
                queryInput.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => this.autoSave(), 2000);
                });
            }
        }

        selectMode(mode) {
            this.currentMode = mode;

            // Update UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
                card.querySelector('.radio-button').classList.remove('active');
            });

            const selectedCard = document.getElementById(mode + 'Mode');
            if (selectedCard) {
                selectedCard.classList.add('active');
                selectedCard.querySelector('.radio-button').classList.add('active');
            }

            // Show/hide sections
            document.getElementById('projectSection').style.display =
                mode === 'project' ? 'block' : 'none';
            document.getElementById('documentSection').style.display =
                mode === 'document' ? 'block' : 'none';

            this.resetSelections();
            this.trackEvent('mode_selected', { mode });
        }

        selectProject(element, projectId) {
            // Remove previous selection
            document.querySelectorAll('.project-card').forEach(card => {
                card.classList.remove('active');
            });

            // Add selection to clicked project
            element.classList.add('active');
            this.selectedProject = projectId;

            // Show document selection section with animation
            const docSection = document.getElementById('documentSelectionSection');
            if (docSection) {
                docSection.style.display = 'block';
                docSection.classList.add('fade-in');

                // Smooth scroll to section
                setTimeout(() => {
                    docSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);
            }

            this.trackEvent('project_selected', { projectId });
        }

        toggleDocument(element, docId) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            if (!checkbox) return;

            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                this.selectedDocuments.push(docId);
                element.classList.add('selected');
            } else {
                this.selectedDocuments = this.selectedDocuments.filter(id => id !== docId);
                element.classList.remove('selected');
            }

            this.updateProceedButton();
            this.updateSelectedCount();
            this.trackEvent('document_toggled', { docId, selected: checkbox.checked });
        }

        selectAllDocuments() {
            document.querySelectorAll('.document-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('.document-item').classList.add('selected');
            });

            this.selectedDocuments = ['doc-1', 'doc-2', 'email-1', 'email-2'];
            this.updateProceedButton();
            this.updateSelectedCount();
            this.showNotification('All documents selected', 'success');
        }

        clearDocumentSelection() {
            document.querySelectorAll('.document-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.document-item').classList.remove('selected');
            });

            this.selectedDocuments = [];
            this.updateProceedButton();
            this.updateSelectedCount();
            this.showNotification('Document selection cleared', 'info');
        }

        updateProceedButton() {
            const proceedBtn = document.getElementById('proceedBtn');
            if (proceedBtn) {
                proceedBtn.disabled = this.selectedDocuments.length === 0;

                if (this.selectedDocuments.length > 0) {
                    proceedBtn.classList.add('pulse');
                    setTimeout(() => proceedBtn.classList.remove('pulse'), 1000);
                }
            }
        }

        updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = this.selectedDocuments.length;
            }

            // Update document chips in modal
            this.updateDocumentChips();
        }

        updateDocumentChips() {
            const chipsContainer = document.querySelector('.selected-docs-preview');
            if (!chipsContainer) return;

            const docNames = {
                'doc-1': 'Document 1',
                'doc-2': 'Document 2',
                'email-1': 'Email 1',
                'email-2': 'Email 2'
            };

            chipsContainer.innerHTML = this.selectedDocuments
                .map(docId => {
                    const isEmail = docId.includes('email');
                    return `<span class="doc-chip ${isEmail ? 'email' : ''}">${docNames[docId]}</span>`;
                })
                .join('');
        }

        proceedToQuery() {
            const querySection = document.getElementById('querySection');
            if (querySection) {
                querySection.style.display = 'block';
                querySection.classList.add('fade-in');

                setTimeout(() => {
                    querySection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);
            }

            document.getElementById('responseSection').style.display = 'none';
            this.trackEvent('proceed_to_query');
        }

        useTemplate(templateType) {
            const queryInput = document.getElementById('queryInput');
            if (!queryInput) return;

            const templates = {
                'backcharge': "We received a back charge letter from QatarEnergy. Based on the selected project files, please provide contractually viable guidance on how to defend our rights and respond to this back charge while ensuring our best benefit.",
                'dispute': "There appears to be a dispute regarding contract terms. Please analyze the selected documents and provide guidance on the best approach for dispute resolution based on the contract clauses.",
                'termination': "We need guidance on contract termination procedures. Please review the selected documents and advise on the proper termination process and our rights/obligations.",
                'compliance': "Please review the selected documents for compliance with contractual obligations and highlight any areas of concern or recommended actions.",
                'backchargedefense': "We received a back charge letter from QatarEnergy. Based on the selected project files, please provide contractually viable guidance on how to defend our rights and respond to this back charge while ensuring our best benefit.", // Fallback
                'disputeresolution': "There appears to be a dispute regarding contract terms. Please analyze the selected documents and provide guidance on the best approach for dispute resolution based on the contract clauses.",     // Fallback
                'contracttermination': "We need guidance on contract termination procedures. Please review the selected documents and advise on the proper termination process and our rights/obligations.", // Fallback
                'compliancecheck': "Please review the selected documents for compliance with contractual obligations and highlight any areas of concern or recommended actions."    // Fallback
            };

            const template = templates[templateType.toLowerCase()];
            if (template) {
                queryInput.value = template;
                queryInput.focus();

                // Add visual feedback
                queryInput.classList.add('template-filled');
                setTimeout(() => queryInput.classList.remove('template-filled'), 1000);

                this.trackEvent('template_used', { templateType });
            }
        }

        async submitQuery() {
            const queryText = document.getElementById('queryInput').value.trim();
            const tone = document.getElementById('toneSelector').value;
            const urgency = document.getElementById('urgencyLevel').value;

            // Validation
            if (!this.validateQuerySubmission(queryText)) {
                return;
            }

            // Show loading state
            this.setLoadingState(true);

            try {
                // Process AI query with real API call
                const response = await this.processAIQuery({
                    query: queryText,
                    tone: tone,
                    urgency: urgency,
                    documents: this.selectedDocuments,
                    mode: this.currentMode
                });

                // Check if there was an error
                if (response.error) {
                    this.showNotification('Failed to analyze correspondence. Please try again.', 'error');
                    this.setLoadingState(false);
                    return;
                }

                // Store query and response
                this.queryHistory.push({
                    query: queryText,
                    tone: tone,
                    urgency: urgency,
                    timestamp: new Date(),
                    documents: [...this.selectedDocuments]
                });

                this.aiResponses.push(response);

                // Display response with enhanced formatting
                this.displayAIResponse(response);
                this.showResponseSection();

                // Display recommendations and key points if available
                if (response.recommendations && response.recommendations.length > 0) {
                    this.displayRecommendations(response.recommendations);
                }

                if (response.keyPoints && response.keyPoints.length > 0) {
                    this.displayKeyPoints(response.keyPoints);
                }

                if (response.suggestedActions && response.suggestedActions.length > 0) {
                    this.displaySuggestedActions(response.suggestedActions);
                }

                this.showNotification('AI analysis completed successfully!', 'success');
                this.trackEvent('query_submitted', {
                    queryLength: queryText.length,
                    tone,
                    urgency,
                    documentCount: this.selectedDocuments.length,
                    processingTime: response.processingTime,
                    tokensUsed: response.tokensUsed
                });

            } catch (error) {
                console.error('Query submission error:', error);
                this.showNotification('Error processing query. Please try again.', 'error');
            } finally {
                this.setLoadingState(false);
            }
        }


        displayRecommendations(recommendations) {
            const responseSection = document.getElementById('responseSection');
            if (!responseSection) return;

            const recommendationsHtml = `
        <div class="recommendations-section">
            <h4><i class="ti ti-bulb"></i> Recommendations</h4>
            <ul class="recommendation-list">
                ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
            </ul>
        </div>
    `;

            // Append to response section
            const existingRecommendations = responseSection.querySelector('.recommendations-section');
            if (existingRecommendations) {
                existingRecommendations.remove();
            }

            responseSection.insertAdjacentHTML('beforeend', recommendationsHtml);
        }

        displayKeyPoints(keyPoints) {
            const responseSection = document.getElementById('responseSection');
            if (!responseSection) return;

            const keyPointsHtml = `
        <div class="key-points-section">
            <h4><i class="ti ti-key"></i> Key Points</h4>
            <ul class="key-points-list">
                ${keyPoints.map(point => `<li>${point}</li>`).join('')}
            </ul>
        </div>
    `;

            // Append to response section
            const existingKeyPoints = responseSection.querySelector('.key-points-section');
            if (existingKeyPoints) {
                existingKeyPoints.remove();
            }

            responseSection.insertAdjacentHTML('beforeend', keyPointsHtml);
        }

        displaySuggestedActions(actions) {
            const responseSection = document.getElementById('responseSection');
            if (!responseSection) return;

            const actionsHtml = `
        <div class="suggested-actions-section">
            <h4><i class="ti ti-checklist"></i> Suggested Actions</h4>
            <ul class="actions-list">
                ${actions.map((action, idx) => `
                    <li>
                        <span class="action-number">${idx + 1}</span>
                        ${action}
                    </li>
                `).join('')}
            </ul>
        </div>
    `;

            // Append to response section
            const existingActions = responseSection.querySelector('.suggested-actions-section');
            if (existingActions) {
                existingActions.remove();
            }

            responseSection.insertAdjacentHTML('beforeend', actionsHtml);
        }

        validateQuerySubmission(queryText) {
            if (!queryText) {
                this.showNotification('Please enter your query before submitting.', 'warning');
                document.getElementById('queryInput').focus();
                return false;
            }

            if (this.currentMode === 'project' && this.selectedDocuments.length === 0) {
                this.showNotification('Please select at least one document for analysis.', 'warning');
                return false;
            }

            if (this.currentMode === 'document' && !this.selectedDocument) {
                this.showNotification('Please select a document for analysis.', 'warning');
                return false;
            }

            return true;
        }
        async processAIQuery(params) {
            /**
             * Process AI query by calling the backend API
             * This replaces the simulated response with real Claude AI integration
             */

            const startTime = Date.now();

            try {
                // Prepare request payload
                const requestPayload = {
                    query: params.query,
                    mode: params.mode, // 'project' or 'document'
                    document_ids: params.documents.map(doc => doc.id),
                    project_id: this.currentProjectId, // If project mode
                    tone: params.tone,
                    urgency: params.urgency,
                    language: 'en' // or 'ar' based on user preference
                };

                console.log('üì§ Sending analysis request:', requestPayload);

                // Call the correspondence analyze endpoint
                const response = await fetch('/api/correspondence/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Analysis request failed');
                }

                const result = await response.json();
                console.log('‚úÖ Analysis response received:', result);

                // Return formatted response for display
                return {
                    content: result.content,
                    confidence: result.confidence,
                    processingTime: result.processingTime,
                    sources: result.sources || [],
                    recommendations: result.recommendations || [],
                    keyPoints: result.key_points || [],
                    suggestedActions: result.suggested_actions || [],
                    tokensUsed: result.tokens_used,
                    timestamp: result.timestamp
                };

            } catch (error) {
                console.error('‚ùå AI Query Error:', error);

                // Return error response
                return {
                    content: `<div class="error-message">
                <i class="ti ti-alert-circle"></i>
                <strong>Analysis Error</strong>
                <p>${error.message}</p>
                <p>Please try again or contact support if the issue persists.</p>
            </div>`,
                    confidence: 0,
                    processingTime: (Date.now() - startTime) / 1000,
                    sources: [],
                    recommendations: [],
                    error: true
                };
            }
        }

        generateMockResponse(params) {
            const { query, tone, documents } = params;

            // Analyze query for key terms
            const isBackcharge = query.toLowerCase().includes('back charge');
            const isDispute = query.toLowerCase().includes('dispute');
            const isTermination = query.toLowerCase().includes('termination');

            let responseContent = '';

            if (isBackcharge) {
                responseContent = this.getBackchargeResponse(tone);
            } else if (isDispute) {
                responseContent = this.getDisputeResponse(tone);
            } else if (isTermination) {
                responseContent = this.getTerminationResponse(tone);
            } else {
                responseContent = this.getGeneralResponse(query, tone);
            }

            return {
                content: responseContent,
                confidence: 85 + Math.random() * 15, // 85-100%
                processingTime: (2000 + Math.random() * 2000) / 1000,
                sources: this.generateSourceReferences(documents),
                tone: tone,
                query: query,
                timestamp: new Date()
            };
        }

        getBackchargeResponse(tone) {
            const responses = {
                formal: `
                <h4>Formal Response Strategy for Back Charge Dispute</h4>
                <p><strong>Executive Summary:</strong> Based on the contract analysis, we recommend a structured formal response to dispute the back charge on procedural and substantive grounds.</p>
                
                <div style="margin: 1.5rem 0;">
                    <h5>1. Procedural Deficiencies</h5>
                    <ul>
                        <li>The back charge was not raised following the dispute resolution mechanism outlined in the contract</li>
                        <li>No proper notice was provided during the contract termination process</li>
                        <li>The claim lacks the required supporting documentation</li>
                    </ul>
                </div>
                
                <div style="margin: 1.5rem 0;">
                    <h5>2. Recommended Actions</h5>
                    <ul>
                        <li>Submit formal dispute notice within contractual timeframes</li>
                        <li>Request detailed justification and supporting evidence</li>
                        <li>Invoke relevant contract clauses protecting your rights</li>
                        <li>Preserve all records for potential arbitration</li>
                    </ul>
                </div>
                
                <div style="background: var(--info-bg); padding: 1rem; border-radius: 8px;">
                    <p><strong>Next Steps:</strong> Draft formal response letter within 14 days, following the template provided in Appendix A of your contract.</p>
                </div>
            `,
                conciliatory: `
                <h4>Collaborative Approach to Back Charge Resolution</h4>
                <p>We understand QatarEnergy's concerns and are committed to resolving this matter amicably while protecting our legitimate interests.</p>
                
                <div style="margin: 1.5rem 0;">
                    <h5>Proposed Resolution Path</h5>
                    <p>We suggest initiating a collaborative discussion to:</p>
                    <ul>
                        <li>Understand the specific concerns underlying the back charge</li>
                        <li>Review relevant contract provisions together</li>
                        <li>Explore mutually acceptable solutions</li>
                        <li>Avoid lengthy dispute procedures that benefit neither party</li>
                    </ul>
                </div>
            `,
                assertive: `
                <h4>Strong Defense Against Improper Back Charge</h4>
                <p><strong>Position:</strong> The back charge is procedurally flawed and substantively unjustified. We reject it in its entirety.</p>
                
                <div style="margin: 1.5rem 0;">
                    <h5>Key Arguments</h5>
                    <ul>
                        <li>Clear violation of contractual dispute procedures</li>
                        <li>Failure to raise claims during contract performance</li>
                        <li>Lack of evidence supporting the claimed damages</li>
                        <li>Untimely assertion waives any potential claims</li>
                    </ul>
                </div>
                
                <div style="background: var(--warning-bg); padding: 1rem; border-radius: 8px;">
                    <p><strong>Demand:</strong> Immediate withdrawal of the back charge and confirmation that no deductions will be made.</p>
                </div>
            `
            };

            return responses[tone] || responses.formal;
        }

        getDisputeResponse(tone) {
            return `
            <h4>Dispute Resolution Guidance</h4>
            <p>Based on contract analysis, here's your optimal dispute resolution strategy:</p>
            
            <div style="margin: 1.5rem 0;">
                <h5>Contract Analysis</h5>
                <p>Your contract provides for a three-tier dispute resolution process:</p>
                <ul>
                    <li>Direct negotiation (30 days)</li>
                    <li>Mediation (60 days)</li>
                    <li>Arbitration (final binding resolution)</li>
                </ul>
            </div>
            
            <div style="margin: 1.5rem 0;">
                <h5>Recommended Strategy</h5>
                <p>Initiate formal dispute resolution while maintaining commercial relationships.</p>
            </div>
        `;
        }

        getTerminationResponse(tone) {
            return `
            <h4>Contract Termination Guidance</h4>
            <p>Analysis of termination clauses and recommended approach:</p>
            
            <div style="margin: 1.5rem 0;">
                <h5>Termination Rights</h5>
                <p>Based on contract review, termination may be available under:</p>
                <ul>
                    <li>Material breach provisions (Clause 15.1)</li>
                    <li>Convenience termination (Clause 15.3)</li>
                    <li>Force majeure (Clause 16.2)</li>
                </ul>
            </div>
            
            <div style="margin: 1.5rem 0;">
                <h5>Notice Requirements</h5>
                <p>Ensure compliance with all procedural requirements for valid termination.</p>
            </div>
        `;
        }

        getGeneralResponse(query, tone) {
            return `
            <h4>AI Analysis Results</h4>
            <p>Based on your query: "${query.substring(0, 100)}${query.length > 100 ? '...' : ''}"</p>
            
            <div style="margin: 1.5rem 0;">
                <h5>Key Findings</h5>
                <p>Our analysis has identified several important considerations relevant to your query.</p>
            </div>
            
            <div style="margin: 1.5rem 0;">
                <h5>Recommendations</h5>
                <p>Based on the selected documents and contract terms, we recommend a structured approach to address your concerns.</p>
            </div>
        `;
        }

        generateSourceReferences(documents) {
            const references = {
                'doc-1': 'Document 1, Clause 15.2 - Dispute Resolution',
                'doc-2': 'Document 2, Section 8 - Technical Specifications',
                'email-1': 'Email 1 - Back charge notice from QatarEnergy',
                'email-2': 'Email 2 - Contract termination correspondence'
            };

            return documents.map(docId => ({
                id: docId,
                reference: references[docId] || `Document ${docId}`,
                type: docId.includes('email') ? 'email' : 'document'
            }));
        }

        displayAIResponse(response) {
            const responseText = document.getElementById('responseText');
            if (!responseText) return;

            responseText.innerHTML = response.content;

            // Update confidence score
            this.updateConfidenceScore(response.confidence);

            // Update processing time
            this.updateProcessingTime(response.processingTime);

            // Update source references
            this.updateSourceReferences(response.sources);

            // Add copy functionality
            this.addCopyFunctionality(responseText);
        }

        updateConfidenceScore(confidence) {
            const scoreFill = document.querySelector('.score-fill');
            const scoreValue = document.querySelector('.score-value');

            if (scoreFill && scoreValue) {
                scoreFill.style.width = `${confidence}%`;
                scoreValue.textContent = `${Math.round(confidence)}%`;

                // Color coding based on confidence
                if (confidence >= 90) {
                    scoreFill.style.background = 'var(--success-color)';
                } else if (confidence >= 75) {
                    scoreFill.style.background = 'linear-gradient(90deg, var(--warning-color), var(--success-color))';
                } else {
                    scoreFill.style.background = 'var(--warning-color)';
                }
            }
        }

        updateProcessingTime(time) {
            const timeElement = document.querySelector('.analysis-time span');
            if (timeElement) {
                timeElement.textContent = `Analysis completed in ${time.toFixed(1)} seconds`;
            }
        }

        updateSourceReferences(sources) {
            const referenceList = document.querySelector('.reference-list');
            if (!referenceList) return;

            referenceList.innerHTML = sources.map(source => `
            <div class="reference-item" data-source-id="${source.id}">
                <i class="ti ti-${source.type === 'email' ? 'mail' : 'file-text'}"></i>
                <span>${source.reference}</span>
            </div>
        `).join('');

            // Add click handlers for source references
            referenceList.querySelectorAll('.reference-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sourceId = item.getAttribute('data-source-id');
                    this.highlightSource(sourceId);
                });
            });
        }

        addCopyFunctionality(responseElement) {
            // Add copy button to response
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn-icon copy-response-btn';
            copyBtn.innerHTML = '<i class="ti ti-copy"></i>';
            copyBtn.title = 'Copy response';
            copyBtn.style.cssText = 'position: absolute; top: 1rem; right: 1rem;';

            responseElement.style.position = 'relative';
            responseElement.appendChild(copyBtn);

            copyBtn.addEventListener('click', () => {
                this.copyResponseToClipboard(responseElement.textContent);
            });
        }

        async copyResponseToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                this.showNotification('Response copied to clipboard!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                this.showNotification('Failed to copy response', 'error');
            }
        }

        showResponseSection() {
            const responseSection = document.getElementById('responseSection');
            if (responseSection) {
                responseSection.style.display = 'block';
                responseSection.classList.add('fade-in');

                setTimeout(() => {
                    responseSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 300);
            }
        }

        setLoadingState(loading) {
            const submitBtn = document.getElementById('submitBtn');
            if (!submitBtn) return;

            if (loading) {
                submitBtn.dataset.originalContent = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';
                submitBtn.disabled = true;
            } else {
                submitBtn.innerHTML = submitBtn.dataset.originalContent || '<i class="ti ti-send"></i> Submit Query';
                submitBtn.disabled = false;
            }
        }

        // Additional utility methods

        autoSave() {
            const queryText = document.getElementById('queryInput').value;
            if (queryText.trim()) {
                localStorage.setItem('correspondence_draft', JSON.stringify({
                    query: queryText,
                    mode: this.currentMode,
                    selectedDocuments: this.selectedDocuments,
                    timestamp: Date.now()
                }));

                this.showNotification('Draft saved automatically', 'info');
            }
        }

        loadSettings() {
            // Load saved draft
            try {
                const draft = localStorage.getItem('correspondence_draft');
                if (draft) {
                    const parsed = JSON.parse(draft);
                    const age = Date.now() - parsed.timestamp;

                    // Only restore if less than 24 hours old
                    if (age < 24 * 60 * 60 * 1000) {
                        const queryInput = document.getElementById('queryInput');
                        if (queryInput && !queryInput.value) {
                            queryInput.value = parsed.query;
                            this.showNotification('Previous draft restored', 'info');
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + Enter to submit query
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const queryInput = document.getElementById('queryInput');
                if (queryInput && queryInput === document.activeElement) {
                    e.preventDefault();
                    this.submitQuery();
                }
            }

            // Escape to close modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    modal.classList.remove('show');
                });
                document.body.style.overflow = '';
            }

            // Ctrl/Cmd + S to save draft
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                this.autoSave();
            }
        }

        trackEvent(eventName, properties = {}) {
            // Analytics tracking
            console.log('Event:', eventName, properties);

            // Integration with analytics service would go here
            // Example: analytics.track(eventName, properties);
        }

        highlightSource(sourceId) {
            // Highlight referenced source in UI
            const sourceElement = document.querySelector(`[data-doc-id="${sourceId}"]`);
            if (sourceElement) {
                sourceElement.classList.add('highlighted');
                sourceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                setTimeout(() => {
                    sourceElement.classList.remove('highlighted');
                }, 3000);
            }
        }

        updateUI() {
            // Update button states, counters, etc.
            this.updateProceedButton();
            this.updateSelectedCount();
        }

        resetSelections() {
            this.selectedProject = null;
            this.selectedDocuments = [];
            this.selectedDocument = null;

            // Hide sections
            const sections = ['documentSelectionSection', 'querySection', 'responseSection'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                }
            });

            // Clear form
            const queryInput = document.getElementById('queryInput');
            if (queryInput) {
                queryInput.value = '';
            }

            // Reset selections in UI
            document.querySelectorAll('.project-card, .document-card').forEach(card => {
                card.classList.remove('active');
            });

            document.querySelectorAll('.document-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            this.updateUI();
        }

        showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            const icons = {
                success: 'ti-check-circle',
                warning: 'ti-alert-triangle',
                error: 'ti-x-circle',
                info: 'ti-info-circle'
            };

            notification.innerHTML = `
            <i class="ti ${icons[type] || icons.info}"></i>
            <span>${message}</span>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="ti ti-x"></i>
            </button>
        `;

            // Position and style
            notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--${type === 'success' ? 'success' :
                    type === 'warning' ? 'warning' :
                        type === 'error' ? 'danger' : 'info'}-color);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideInRight 0.3s ease;
        `;

            document.body.appendChild(notification);

            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
    }

    // Global functions for template compatibility
    window.correspondenceManager = new CorrespondenceManager();

    // Export individual functions for backward compatibility
    window.selectMode = (mode) => window.correspondenceManager.selectMode(mode);
    window.selectProject = (element, projectId) => window.correspondenceManager.selectProject(element, projectId);
    window.toggleDocument = (element, docId) => window.correspondenceManager.toggleDocument(element, docId);
    window.selectAllDocuments = () => window.correspondenceManager.selectAllDocuments();
    window.clearDocumentSelection = () => window.correspondenceManager.clearDocumentSelection();
    window.proceedToQuery = () => window.correspondenceManager.proceedToQuery();
    window.useTemplate = (templateType) => window.correspondenceManager.useTemplate(templateType);
    window.submitQuery = () => window.correspondenceManager.submitQuery();

    // Additional global functions for UI interactions
    window.clearQuery = () => {
        document.getElementById('queryInput').value = '';
    };

    window.pasteFromClipboard = async () => {
        try {
            if (navigator.clipboard) {
                const text = await navigator.clipboard.readText();
                document.getElementById('queryInput').value = text;
                window.correspondenceManager.showNotification('Text pasted from clipboard', 'success');
            }
        } catch (error) {
            window.correspondenceManager.showNotification('Unable to access clipboard', 'warning');
        }
    };

    window.saveAsDraft = () => {
        window.correspondenceManager.autoSave();
    };

    // Modal functions
    window.openModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    };

    window.closeModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
    };

    // Document action functions
    window.previewDocument = (event, docId) => {
        if (event) event.stopPropagation();

        const docTitles = {
            'doc-1': 'Main Power Services Agreement.pdf',
            'doc-2': 'Technical Specifications.docx',
            'email-1': 'Back charge letter from QatarEnergy.eml',
            'email-2': 'Contract termination notice.eml'
        };

        document.getElementById('previewDocTitle').textContent = docTitles[docId] || 'Document Preview';
        window.openModal('documentPreviewModal');

        // Simulate document loading
        const viewer = document.getElementById('documentViewer');
        viewer.innerHTML = `
        <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
            <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
            <p>Loading document preview...</p>
        </div>
    `;

        setTimeout(() => {
            viewer.innerHTML = `
            <div style="background: white; padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color);">
                <h3>${docTitles[docId]}</h3>
                <p><strong>Document Type:</strong> ${docId.includes('email') ? 'Email Communication' : 'Contract Document'}</p>
                <p><strong>Last Modified:</strong> January 15, 2025</p>
                <p><strong>Size:</strong> ${docId.includes('email') ? '45 KB' : '2.3 MB'}</p>
                <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border-color);">
                <div style="line-height: 1.6;">
                    <p>This is a preview of the document content. The actual document viewer would display the full content with proper formatting, highlighting, and navigation features.</p>
                    <p>Key sections would be highlighted and cross-referenced with related clauses and obligations.</p>
                    ${docId === 'email-1' ? '<p><strong>Subject:</strong> Back Charge Notice - Contract Deductions</p><p><strong>From:</strong> contracts@qatarenergy.qa</p>' : ''}
                </div>
            </div>
        `;
        }, 1500);
    };

    window.downloadDocument = (event, docId) => {
        if (event) event.stopPropagation();
        window.correspondenceManager.showNotification('Document download started...', 'success');
    };

    window.replyToEmail = (event, emailId) => {
        if (event) event.stopPropagation();
        window.openModal('queryModal');

        // Pre-fill with reply context
        const modalQueryInput = document.getElementById('modalQueryInput');
        if (modalQueryInput) {
            modalQueryInput.value = 'Please help me draft a professional reply to this email.';
        }
    };

    // Project action functions
    window.viewProjectDetails = (event, projectId) => {
        if (event) event.stopPropagation();
        window.correspondenceManager.showNotification('Opening project details...', 'info');
    };

    window.viewAuditTrail = (event, projectId) => {
        if (event) event.stopPropagation();
        window.correspondenceManager.showNotification('Opening audit trail...', 'info');
    };

    window.refreshProjects = () => {
        window.correspondenceManager.showNotification('Refreshing project list...', 'info');
        setTimeout(() => {
            window.correspondenceManager.showNotification('Project list updated!', 'success');
        }, 1000);
    };

    // Response action functions
    window.exportResponse = () => {
        window.correspondenceManager.showNotification('Exporting response as PDF...', 'info');
        setTimeout(() => {
            window.correspondenceManager.showNotification('Response exported successfully!', 'success');
        }, 2000);
    };

    window.shareResponse = () => {
        if (navigator.share) {
            navigator.share({
                title: 'AI Correspondence Analysis',
                text: 'AI-generated correspondence analysis and recommendations',
                url: window.location.href
            });
        } else {
            window.correspondenceManager.copyResponseToClipboard(
                document.getElementById('responseText')?.textContent || 'AI Response'
            );
        }
    };

    window.generateNewResponse = () => {
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Regenerating...';
            submitBtn.disabled = true;

            setTimeout(() => {
                submitBtn.innerHTML = '<i class="ti ti-send"></i> Submit Query';
                submitBtn.disabled = false;
                window.correspondenceManager.showNotification('New response generated!', 'success');
            }, 2000);
        }
    };

    // AI Generation functions
    window.letAIGenerate = () => {
        window.openModal('responsePreviewModal');

        // Populate preview modal with AI-generated content
        const previewQuery = document.getElementById('previewQuery');
        const previewTone = document.getElementById('previewTone');
        const previewResponseText = document.getElementById('previewResponseText');

        if (previewQuery) {
            previewQuery.textContent = "Please draft a formal response disputing the deductions on the basis that proper dispute mechanism was not followed and it was not mentioned during termination letter";
        }

        if (previewTone) {
            previewTone.textContent = "Formal Tone";
        }

        if (previewResponseText) {
            previewResponseText.innerHTML = `
            <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                <h4>Proposed Response</h4>
                <p><strong>Subject:</strong> Formal Dispute of Back Charge Deductions - Contract No. [Contract Number]</p>
                
                <p>Dear QatarEnergy Team,</p>
                
                <p>We acknowledge receipt of your back charge letter dated [Date]. After careful review of the contract terms and termination procedures, we formally dispute the proposed deductions on the following grounds:</p>
                
                <ol>
                    <li><strong>Procedural Non-Compliance:</strong> The back charge was not raised in accordance with the dispute resolution mechanism outlined in Clause [X] of our agreement.</li>
                    <li><strong>Omission During Termination:</strong> No mention of these charges was made during the formal contract termination process, which suggests they were not identified at the time of contract closure.</li>
                    <li><strong>Lack of Supporting Documentation:</strong> The back charge lacks sufficient detail and supporting evidence as required under our contractual terms.</li>
                </ol>
                
                <p>We request that you withdraw these charges and provide detailed justification if you wish to pursue this matter through the proper contractual dispute resolution process.</p>
                
                <p>We look forward to your prompt response and resolution of this matter.</p>
                
                <p>Sincerely,<br>[Your Name]<br>[Your Title]</p>
            </div>
        `;
        }
    };

    // Modal interaction functions
    window.submitModalQuery = () => {
        const query = document.getElementById('modalQueryInput')?.value.trim();
        if (!query) {
            window.correspondenceManager.showNotification('Please enter your query.', 'warning');
            return;
        }

        // Transfer to main query
        const mainQueryInput = document.getElementById('queryInput');
        if (mainQueryInput) {
            mainQueryInput.value = query;
        }

        window.closeModal('queryModal');

        // Scroll to query section
        const querySection = document.getElementById('querySection');
        if (querySection) {
            querySection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        window.correspondenceManager.showNotification('Query transferred to main interface!', 'success');
    };

    window.editResponse = () => {
        window.closeModal('responsePreviewModal');
        window.correspondenceManager.showNotification('Response opened for editing.', 'info');
    };

    window.acceptResponse = () => {
        const previewResponse = document.getElementById('previewResponseText')?.innerHTML;
        const responseText = document.getElementById('responseText');

        if (previewResponse && responseText) {
            responseText.innerHTML = previewResponse;
        }

        window.closeModal('responsePreviewModal');

        // Show response section
        const responseSection = document.getElementById('responseSection');
        if (responseSection) {
            responseSection.style.display = 'block';
            responseSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        window.correspondenceManager.showNotification('AI response accepted and applied!', 'success');
    };

    // Document viewer functions
    window.zoomIn = () => {
        const viewer = document.getElementById('documentViewer');
        if (viewer) {
            const currentZoom = parseFloat(viewer.style.zoom) || 1;
            viewer.style.zoom = (currentZoom + 0.1).toString();
        }
    };

    window.zoomOut = () => {
        const viewer = document.getElementById('documentViewer');
        if (viewer) {
            const currentZoom = parseFloat(viewer.style.zoom) || 1;
            const newZoom = Math.max(0.5, currentZoom - 0.1);
            viewer.style.zoom = newZoom.toString();
        }
    };

    window.toggleFullscreen = () => {
        const modal = document.getElementById('documentPreviewModal');
        if (modal) {
            modal.classList.toggle('fullscreen');
        }
    };

    // Help and utility functions
    window.showCorrespondenceHistory = () => {
        window.correspondenceManager.showNotification('Opening correspondence history...', 'info');
        // This would typically open a history modal or navigate to a history page
    };

    // Document selection functions for single document mode
    window.selectDocument = (element, docId) => {
        document.querySelectorAll('.document-card').forEach(card => {
            card.classList.remove('active');
        });

        element.classList.add('active');
        window.correspondenceManager.selectedDocument = docId;

        // Proceed to query automatically
        window.correspondenceManager.proceedToQuery();
    };

    // Enhanced notification system
    window.showNotification = (message, type = 'info') => {
        window.correspondenceManager.showNotification(message, type);
    };

    // Initialization when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize tooltips
        initializeTooltips();

        // Initialize auto-save
        initializeAutoSave();

        // Initialize keyboard shortcuts help
        initializeKeyboardShortcuts();

        // Initialize accessibility features
        initializeAccessibility();

        console.log('Correspondence Management initialized');
    });

    function initializeTooltips() {
        // Add tooltips to buttons and interactive elements
        const elementsWithTooltips = document.querySelectorAll('[title]');
        elementsWithTooltips.forEach(element => {
            element.addEventListener('mouseenter', showTooltip);
            element.addEventListener('mouseleave', hideTooltip);
        });
    }

    function showTooltip(event) {
        const element = event.target;
        const title = element.getAttribute('title');
        if (!title) return;

        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.textContent = title;
        tooltip.style.cssText = `
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        z-index: 10001;
        pointer-events: none;
        white-space: nowrap;
    `;

        document.body.appendChild(tooltip);

        // Position tooltip
        const rect = element.getBoundingClientRect();
        tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
        tooltip.style.top = `${rect.top - tooltip.offsetHeight - 5}px`;

        element.tooltipElement = tooltip;

        // Remove title to prevent browser tooltip
        element.setAttribute('data-title', title);
        element.removeAttribute('title');
    }

    function hideTooltip(event) {
        const element = event.target;
        if (element.tooltipElement) {
            element.tooltipElement.remove();
            element.tooltipElement = null;
        }

        // Restore title
        const title = element.getAttribute('data-title');
        if (title) {
            element.setAttribute('title', title);
            element.removeAttribute('data-title');
        }
    }

    function initializeAutoSave() {
        // Set up auto-save for form data
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            input.addEventListener('change', () => {
                // Debounced auto-save
                clearTimeout(input.autoSaveTimeout);
                input.autoSaveTimeout = setTimeout(() => {
                    window.correspondenceManager.autoSave();
                }, 2000);
            });
        });
    }

    function initializeKeyboardShortcuts() {
        // Create keyboard shortcuts help
        const shortcutsHelp = {
            'Ctrl/Cmd + Enter': 'Submit query',
            'Ctrl/Cmd + S': 'Save draft',
            'Escape': 'Close modals',
            'Tab': 'Navigate between elements',
            'Enter': 'Activate buttons and links'
        };

        // Add keyboard shortcuts info to help modal
        const helpModal = document.getElementById('helpModal');
        if (helpModal) {
            const helpBody = helpModal.querySelector('.modal-body');
            if (helpBody) {
                const shortcutsSection = document.createElement('div');
                shortcutsSection.innerHTML = `
                <h4 style="margin-top: 2rem;">Keyboard Shortcuts</h4>
                <div class="shortcuts-list">
                    ${Object.entries(shortcutsHelp).map(([key, desc]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <kbd style="background: var(--background-light); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: monospace;">${key}</kbd>
                            <span>${desc}</span>
                        </div>
                    `).join('')}
                </div>
            `;
                helpBody.appendChild(shortcutsSection);
            }
        }
    }

    function initializeAccessibility() {
        // Add ARIA labels and roles
        const buttons = document.querySelectorAll('button:not([aria-label])');
        buttons.forEach(button => {
            if (!button.getAttribute('aria-label')) {
                const text = button.textContent.trim() || button.title || 'Button';
                button.setAttribute('aria-label', text);
            }
        });

        // Add role to custom elements
        const cards = document.querySelectorAll('.project-card, .document-card, .mode-card');
        cards.forEach(card => {
            card.setAttribute('role', 'button');
            card.setAttribute('tabindex', '0');

            // Add keyboard support
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    card.click();
                }
            });
        });

        // Add live region for notifications
        const liveRegion = document.createElement('div');
        liveRegion.setAttribute('aria-live', 'polite');
        liveRegion.setAttribute('aria-atomic', 'true');
        liveRegion.style.cssText = 'position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;';
        document.body.appendChild(liveRegion);

        // Announce notifications to screen readers
        const originalShowNotification = window.correspondenceManager.showNotification;
        window.correspondenceManager.showNotification = function (message, type) {
            originalShowNotification.call(this, message, type);
            liveRegion.textContent = `${type}: ${message}`;
        };
    }
    function updateConfidenceScore(confidence) {
        const scoreFill = document.querySelector('.score-fill');
        const scoreValue = document.querySelector('.score-value');

        if (scoreFill && scoreValue) {
            const confidencePercent = Math.round(confidence);

            // Animate the score bar
            scoreFill.style.width = `${confidencePercent}%`;
            scoreValue.textContent = `${confidencePercent}%`;

            // Color coding based on confidence level
            if (confidencePercent >= 90) {
                scoreFill.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
                scoreValue.style.color = '#28a745';
            } else if (confidencePercent >= 75) {
                scoreFill.style.background = 'linear-gradient(90deg, #ffc107, #28a745)';
                scoreValue.style.color = '#ffc107';
            } else if (confidencePercent >= 60) {
                scoreFill.style.background = 'linear-gradient(90deg, #ff9800, #ffc107)';
                scoreValue.style.color = '#ff9800';
            } else {
                scoreFill.style.background = 'linear-gradient(90deg, #dc3545, #ff9800)';
                scoreValue.style.color = '#dc3545';
            }
        }
    }
    function updateProcessingTime(timeInSeconds) {
        const timeElement = document.querySelector('.analysis-time span');
        if (timeElement) {
            timeElement.textContent = `Analysis completed in ${timeInSeconds.toFixed(1)} seconds`;
        }
    }

    // =====================================================
    // UPDATE: Source References Display
    // =====================================================
    function updateSourceReferences(sources) {
        const referenceList = document.querySelector('.reference-list');
        if (!referenceList) return;

        if (!sources || sources.length === 0) {
            referenceList.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">No source references available.</p>';
            return;
        }

        referenceList.innerHTML = sources.map(source => {
            const iconMap = {
                'email': 'ti-mail',
                'document': 'ti-file-text',
                'contract': 'ti-file-certificate',
                'pdf': 'ti-file-type-pdf',
                'doc': 'ti-file-type-doc',
                'docx': 'ti-file-type-doc'
            };

            const icon = iconMap[source.type] || 'ti-file-text';

            return `
            <div class="reference-item" data-source-id="${source.id}">
                <i class="ti ${icon}"></i>
                <span>${escapeHtml(source.name)} - ${escapeHtml(source.contract || 'Document')}</span>
            </div>
        `;
        }).join('');
    }

    // =====================================================
    // NEW: Display Recommendations
    // =====================================================
    function displayRecommendations(recommendations) {
        const responseSection = document.getElementById('responseSection');
        if (!responseSection) return;

        // Remove existing recommendations section
        const existing = responseSection.querySelector('.recommendations-section');
        if (existing) existing.remove();

        const recommendationsHtml = `
        <div class="recommendations-section">
            <h4><i class="ti ti-bulb"></i> Recommendations</h4>
            <ul class="recommendation-list">
                ${recommendations.map(rec => `<li>${escapeHtml(rec)}</li>`).join('')}
            </ul>
        </div>
    `;

        responseSection.querySelector('.response-content').insertAdjacentHTML('beforeend', recommendationsHtml);
    }

    // =====================================================
    // NEW: Display Key Points
    // =====================================================
    function displayKeyPoints(keyPoints) {
        const responseSection = document.getElementById('responseSection');
        if (!responseSection) return;

        // Remove existing key points section
        const existing = responseSection.querySelector('.key-points-section');
        if (existing) existing.remove();

        const keyPointsHtml = `
        <div class="key-points-section">
            <h4><i class="ti ti-key"></i> Key Points</h4>
            <ul class="key-points-list">
                ${keyPoints.map(point => `<li>${escapeHtml(point)}</li>`).join('')}
            </ul>
        </div>
    `;

        responseSection.querySelector('.response-content').insertAdjacentHTML('beforeend', keyPointsHtml);
    }

    // =====================================================
    // NEW: Display Suggested Actions
    // =====================================================
    function displaySuggestedActions(actions) {
        const responseSection = document.getElementById('responseSection');
        if (!responseSection) return;

        // Remove existing actions section
        const existing = responseSection.querySelector('.suggested-actions-section');
        if (existing) existing.remove();

        const actionsHtml = `
        <div class="suggested-actions-section">
            <h4><i class="ti ti-checklist"></i> Suggested Actions</h4>
            <ul class="actions-list">
                ${actions.map((action, idx) => `
                    <li>
                        <span class="action-number">${idx + 1}</span>
                        ${escapeHtml(action)}
                    </li>
                `).join('')}
            </ul>
        </div>
    `;

        responseSection.querySelector('.response-content').insertAdjacentHTML('beforeend', actionsHtml);
    }

    // =====================================================
    // NEW: Display Error Response
    // =====================================================
    function displayErrorResponse(errorMessage) {
        const responseText = document.getElementById('responseText');
        if (!responseText) return;

        responseText.innerHTML = `
        <div class="error-message">
            <i class="ti ti-alert-circle"></i>
            <strong>Analysis Error</strong>
            <p>${escapeHtml(errorMessage)}</p>
            <p style="margin-top: 0.5rem; font-size: 0.875rem;">Please try again or contact support if the issue persists.</p>
        </div>
    `;

        // Set confidence to 0
        updateConfidenceScore(0);

        // Clear processing time
        const timeElement = document.querySelector('.analysis-time span');
        if (timeElement) {
            timeElement.textContent = 'Analysis failed';
        }

        // Clear source references
        const referenceList = document.querySelector('.reference-list');
        if (referenceList) {
            referenceList.innerHTML = '';
        }
    }

    // Export for use in other modules
    if (typeof module !== 'undefined' && module.exports) {
        module.exports = { CorrespondenceManager };
    }
</script>



{% endblock %}