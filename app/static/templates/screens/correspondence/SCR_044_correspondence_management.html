<!-- File: app/static/templates/screens/correspondence/SCR_044_correspondence_management.html -->
{% extends "base.html" %}

{% block title %}Correspondence Management{% endblock %}

{% block head %}
<style>
    /* =====================================================
       CORRESPONDENCE MANAGEMENT - CALIM 360 
       Project & Document Level Analysis
       ===================================================== */

    .correspondence-container {
        display: flex;
        height: calc(100vh - var(--header-height));
        background: var(--background-light);
        overflow: hidden;
        width: 100%;
    }

    /* When sidebar is collapsed, this container takes full width */
    .sidebar-collapsed~.main-content .correspondence-container,
    body.sidebar-collapsed .correspondence-container {
        width: 100%;
    }

    /* =====================================================
       LEFT SIDEBAR - Mode & Selection Panel
       ===================================================== */
    .selection-sidebar {
        width: 360px;
        background: white;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        box-shadow: var(--shadow-sm);
    }

    .correspondance-sidebar-header {
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, var(--primary-color), #1e4bb8);
        color: white;
    }

    .sidebar-title {
        display: flex;
        align-items: center;
        gap: 0.875rem;
    }

    .sidebar-title-icon {
        /* width: 44px;
        height: 44px; */
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .sidebar-title h1 {
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0;
    }

    .sidebar-title p {
        font-size: 0.75rem;
        opacity: 0.85;
        margin: 0.125rem 0 0 0;
    }

    /* =====================================================
       MODE SELECTION - Project vs Document Level
       ===================================================== */
    .mode-selection {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--background-light);
    }

    .mode-label {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
        display: block;
    }

    .mode-cards {
        display: flex;
        gap: 0.75rem;
    }

    .mode-card {
        flex: 1;
        padding: 0.875rem;
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
    }

    .mode-card:hover {
        border-color: var(--secondary-color);
    }

    .mode-card.active {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    .mode-card-icon {
        width: 36px;
        height: 36px;
        background: var(--background-light);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        color: var(--primary-color);
        font-size: 1.125rem;
    }

    .mode-card.active .mode-card-icon {
        background: var(--primary-color);
        color: white;
    }

    .mode-card-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.125rem;
    }

    .mode-card-desc {
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    /* =====================================================
       PROJECT SELECTION (Project Level Mode)
       ===================================================== */
    .project-selection {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }

    .section-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .project-select {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.85rem;
        background: white;
        cursor: pointer;
        transition: var(--transition);
    }

    .project-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    /* =====================================================
       DOCUMENT LIST
       ===================================================== */
    .docs-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .docs-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
    }

    .docs-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .docs-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .docs-count {
        background: var(--primary-color);
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .docs-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.375rem 0.625rem;
        font-size: 0.75rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        color: var(--text-color);
        transition: var(--transition);
    }

    .btn-sm:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .btn-sm.primary {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .btn-sm.primary:hover {
        background: #1e4bb8;
    }

    /* Search Box */
    .search-container {
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
    }

    .search-box {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.5rem 0.75rem 0.5rem 2.25rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.85rem;
        background: var(--background-light);
        transition: var(--transition);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        background: white;
    }

    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* Document List - Optimized for many documents */
    .docs-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
    }

    .docs-list::-webkit-scrollbar {
        width: 6px;
    }

    .docs-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .docs-list::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 3px;
    }

    .docs-list::-webkit-scrollbar-thumb:hover {
        background-color: var(--text-muted);
    }

    .doc-item {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.625rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.15s, border-color 0.15s;
        margin-bottom: 0.125rem;
        border: 1px solid transparent;
    }

    .doc-item:hover {
        background: var(--background-light);
        border-color: var(--border-color);
    }

    .doc-item.selected {
        background: rgba(39, 98, 203, 0.08);
        border-color: rgba(39, 98, 203, 0.3);
    }

    .doc-checkbox {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
        cursor: pointer;
        flex-shrink: 0;
    }

    /* For Document Level - Radio buttons */
    .doc-radio {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
        cursor: pointer;
        flex-shrink: 0;
    }

    .doc-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .doc-icon.pdf {
        background: #fee2e2;
        color: #dc2626;
    }

    .doc-icon.docx {
        background: #dbeafe;
        color: #2563eb;
    }

    .doc-icon.email {
        background: #fef3c7;
        color: #d97706;
    }

    .doc-icon.xlsx {
        background: #d1fae5;
        color: #059669;
    }

    .doc-info {
        flex: 1;
        min-width: 0;
    }

    .doc-name {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .doc-meta {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 0.125rem;
    }

    /* Selection Summary - Enhanced */
    .selection-summary {
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border-color);
        background: linear-gradient(to right, rgba(39, 98, 203, 0.05), rgba(115, 180, 224, 0.05));
    }

    .selection-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .selection-text {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .selection-text i {
        font-size: 1rem;
    }

    .clear-btn {
        font-size: 0.75rem;
        color: var(--text-muted);
        background: white;
        border: 1px solid var(--border-color);
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .clear-btn:hover {
        background: #fee2e2;
        border-color: var(--danger-color);
        color: var(--danger-color);
    }

    /* Selected docs preview chips */
    .selected-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-top: 0.5rem;
        max-height: 60px;
        overflow-y: auto;
    }

    .selected-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.2rem 0.5rem;
        background: white;
        border: 1px solid rgba(39, 98, 203, 0.2);
        border-radius: 4px;
        font-size: 0.7rem;
        color: var(--primary-color);
        max-width: 120px;
    }

    .selected-chip span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 2.5rem 1.5rem;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 2.5rem;
        opacity: 0.25;
        margin-bottom: 0.75rem;
        display: block;
    }

    .empty-state p {
        font-size: 0.85rem;
        margin-bottom: 1rem;
    }

    /* =====================================================
       MAIN CHAT AREA
       ===================================================== */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: var(--background-light);
    }

    /* Chat Header */
    .chat-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow-sm);
    }

    .chat-header-left h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }

    .chat-header-left p {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin: 0.125rem 0 0 0;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .icon-btn {
        width: 38px;
        height: 38px;
        border: 1px solid var(--border-color);
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-muted);
        transition: var(--transition);
    }

    .icon-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    /* Chat Messages */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        /* padding: 2rem; */
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Welcome State */
    .welcome-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        /* padding: 3rem; */
    }

    .welcome-icon {
        width: 72px;
        height: 72px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 24px rgba(39, 98, 203, 0.25);
    }

    .welcome-state h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .welcome-state>p {
        color: var(--text-muted);
        font-size: 0.9rem;
        max-width: 500px;
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    /* Quick Prompts */
    .quick-prompts {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        max-width: 600px;
        width: 100%;
    }

    .quick-prompt {
        padding: 1.25rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        text-align: left;
        cursor: pointer;
        transition: var(--transition);
    }

    .quick-prompt:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .quick-prompt-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.1), rgba(115, 180, 224, 0.1));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        font-size: 1.125rem;
        margin-bottom: 0.75rem;
    }

    .quick-prompt-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .quick-prompt-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
        line-height: 1.4;
    }

    /* Message Bubbles */
    .message {
        display: flex;
        gap: 1rem;
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1rem;
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, var(--primary-color), #1e4bb8);
        color: white;
    }

    .message.ai .message-avatar {
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        color: white;
    }

    .message-content {
        flex: 1;
        min-width: 0;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .message-sender {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .message-time {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .message-body {
        background: white;
        padding: 1rem 1rem;
        /* border-radius: 12px; */
        font-size: 0.9rem;
        line-height: 1.7;
        color: var(--text-color);
        /* border: 1px solid var(--border-color); */
        box-shadow: var(--shadow-sm);
    }

    .message.user .message-body {
        background: rgba(202, 203, 204, 0.05);
        border-color: rgba(39, 98, 203, 0.15);
    }

    .message.user .message-content{
        background-color: rgb(221, 227, 236);
    }

    .message-body h2,
    .message-body h3,
    .message-body h4 {
        color: var(--primary-color);
        margin: 1.25rem 0 0.75rem 0;
        font-weight: 600;
    }

    .message-body h2:first-child,
    .message-body h3:first-child {
        margin-top: 0;
    }

    .message-body h2 {
        font-size: 1.1rem;
    }

    .message-body h3 {
        font-size: 1rem;
    }

    .message-body p {
        margin-bottom: 0.75rem;
    }

    .message-body p:last-child {
        margin-bottom: 0;
    }

    .message-body ul,
    .message-body ol {
        margin: 0.75rem 0;
        padding-left: 1.5rem;
    }

    .message-body li {
        margin-bottom: 0.375rem;
    }

    .message-body strong {
        font-weight: 600;
    }

    /* Message Actions */
    .message-actions {
        display: flex;
        gap: 0.25rem;
        margin-top: 0.75rem;
    }

    .msg-action-btn {
        padding: 0.375rem 0.75rem;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 6px;
        font-size: 0.75rem;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        transition: var(--transition);
    }

    .msg-action-btn:hover {
        background: var(--background-light);
        border-color: var(--border-color);
        color: var(--primary-color);
    }

    /* Confidence & Sources */
    .confidence-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        background: var(--success-bg);
        color: var(--success-color);
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .sources-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .sources-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .source-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .source-tag {
        padding: 0.25rem 0.75rem;
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.75rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        gap: 0.375rem;
        padding: 0.5rem 0;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--primary-color);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {

        0%,
        60%,
        100% {
            transform: translateY(0);
            opacity: 0.4;
        }

        30% {
            transform: translateY(-4px);
            opacity: 1;
        }
    }

    /* =====================================================
       INPUT AREA
       ===================================================== */
    .chat-input-area {
        padding: 1.25rem 2rem 1.5rem;
        background: white;
        border-top: 1px solid var(--border-color);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
    }

    .input-container {
        max-width: 900px;
        margin: 0 auto;
    }

    /* Options Row */
    .input-options {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        margin-bottom: 0.875rem;
        flex-wrap: wrap;
    }

    .option-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .option-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .option-select {
        padding: 0.375rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.8rem;
        background: white;
        cursor: pointer;
        min-width: 120px;
        transition: var(--transition);
    }

    .option-select:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    /* Main Input */
    .input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 0.75rem;
        background: var(--background-light);
        border: 2px solid var(--border-color);
        border-radius: 14px;
        padding: 0.75rem;
        transition: var(--transition);
    }

    .input-wrapper:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(39, 98, 203, 0.1);
    }

    .query-textarea {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 0.95rem;
        line-height: 1.5;
        resize: none;
        min-height: 24px;
        max-height: 200px;
        padding: 0.25rem 0.5rem;
        font-family: inherit;
        color: var(--text-color);
    }

    .query-textarea:focus {
        outline: none;
    }

    .query-textarea::placeholder {
        color: var(--text-muted);
    }

    .input-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .attach-btn {
        width: 38px;
        height: 38px;
        border: none;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .attach-btn:hover {
        background: white;
        color: var(--primary-color);
    }

    .submit-btn {
        width: 44px;
        height: 44px;
        border: none;
        background: linear-gradient(135deg, var(--primary-color), #1e4bb8);
        border-radius: 10px;
        cursor: pointer;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        transition: var(--transition);
    }

    .submit-btn:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(39, 98, 203, 0.35);
    }

    .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* =====================================================
       UPLOAD MODAL - FIXED
       ===================================================== */
    /* UPLOAD MODAL */
    /* =====================================================
   UPLOAD MODAL - COMPLETE FIX
   ===================================================== */
    .modal-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.6) !important;
        display: none !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 999999 !important;
    }

    .modal-overlay.active {
        display: flex !important;
    }

    .modal {
        background: white !important;
        border-radius: 16px !important;
        width: 90% !important;
        max-width: 520px !important;
        /* max-height: 90vh; */
        overflow-y: auto !important;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5) !important;
        position: relative !important;
        z-index: 1000000 !important;
        display: block !important;
        margin: auto !important;
    }

    .modal-header {
        padding: 1.25rem 1.5rem !important;
        border-bottom: 1px solid #e5e7eb !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        background: #f9fafb !important;
        border-radius: 16px 16px 0 0 !important;
    }

    .modal-header h3 {
        font-size: 1.125rem !important;
        font-weight: 600 !important;
        color: #1f2937 !important;
        margin: 0 !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .modal-close {
        width: 32px !important;
        height: 32px !important;
        border: none !important;
        background: transparent !important;
        border-radius: 8px !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: #6b7280 !important;
    }

    .modal-close:hover {
        background: #ef4444 !important;
        color: white !important;
    }

    .modal-body {
        padding: 1.5rem !important;
    }

    .upload-zone {
        border: 2px dashed #d1d5db !important;
        border-radius: 12px !important;
        padding: 2.5rem !important;
        text-align: center !important;
        cursor: pointer !important;
        background: #f9fafb !important;
    }

    .upload-zone:hover {
        border-color: #2762cb !important;
        background: rgba(39, 98, 203, 0.05) !important;
    }

    .upload-zone i {
        font-size: 2.5rem !important;
        color: #2762cb !important;
        margin-bottom: 1rem !important;
        display: block !important;
    }

    .upload-zone h4 {
        font-size: 1rem !important;
        font-weight: 600 !important;
        color: #1f2937 !important;
        margin-bottom: 0.5rem !important;
    }

    .upload-zone p {
        font-size: 0.85rem !important;
        color: #6b7280 !important;
        margin: 0 !important;
    }

    .upload-zone input {
        display: none !important;
    }

    .upload-list {
        margin-top: 1rem !important;
        max-height: 200px !important;
        overflow-y: auto !important;
    }

    .upload-item {
        display: flex !important;
        align-items: center !important;
        gap: 0.75rem !important;
        padding: 0.75rem !important;
        background: #f9fafb !important;
        border-radius: 8px !important;
        margin-bottom: 0.5rem !important;
    }

    .upload-item-icon {
        width: 32px !important;
        height: 32px !important;
        background: white !important;
        border-radius: 6px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: #2762cb !important;
    }

    .upload-item-info {
        flex: 1 !important;
    }

    .upload-item-name {
        font-size: 0.85rem !important;
        font-weight: 500 !important;
        color: #1f2937 !important;
    }

    .upload-item-size {
        font-size: 0.75rem !important;
        color: #6b7280 !important;
    }

    .upload-item-remove {
        width: 28px !important;
        height: 28px !important;
        border: none !important;
        background: transparent !important;
        border-radius: 6px !important;
        cursor: pointer !important;
        color: #6b7280 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .upload-item-remove:hover {
        background: #fee2e2 !important;
        color: #ef4444 !important;
    }

    .modal-footer {
        padding: 1rem 1.5rem !important;
        border-top: 1px solid #e5e7eb !important;
        display: flex !important;
        justify-content: flex-end !important;
        gap: 0.75rem !important;
    }

    .btn {
        padding: 0.625rem 1.25rem !important;
        border-radius: 8px !important;
        font-size: 0.875rem !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .btn-outline {
        background: white !important;
        border: 1px solid #d1d5db !important;
        color: #1f2937 !important;
    }

    .btn-outline:hover {
        border-color: #2762cb !important;
        color: #2762cb !important;
    }

    .btn-primary {
        background: linear-gradient(135deg, #2762cb, #1e4bb8) !important;
        border: none !important;
        color: white !important;
    }

    .btn-primary:hover {
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.3) !important;
    }

    .btn .ti-loader {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Hide chatbot button on this page */
    .chatbot-button,
    #chatbotButton {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
    }

    /* Ensure sidebar is collapsed on this page */

    /* Pagination for Documents */
    .docs-pagination {
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border-color);
        background: white;
        font-size: 0.75rem;
        display: none;
    }

    .pagination-info {
        color: var(--text-muted);
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .page-btn {
        width: 28px;
        height: 28px;
        border: 1px solid var(--border-color);
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: var(--text-color);
        transition: var(--transition);
    }

    .page-btn:hover:not(:disabled) {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .page-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .page-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .per-page-select {
        padding: 0.25rem 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.75rem;
        background: white;
        margin-left: 0.5rem;
    }

    /* =====================================================
       TOAST NOTIFICATIONS
       ===================================================== */
    .toast-container {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .toast {
        padding: 0.875rem 1.25rem;
        background: white;
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 0.625rem;
        animation: slideIn 0.3s ease;
        font-size: 0.875rem;
    }

    .toast.success {
        border-left: 4px solid var(--success-color);
    }

    .toast.error {
        border-left: 4px solid var(--danger-color);
    }

    .toast.info {
        border-left: 4px solid var(--primary-color);
    }

    .toast.warning {
        border-left: 4px solid #f0ad4e;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* =====================================================
       RESPONSIVE
       ===================================================== */
    @media (max-width: 1024px) {
        .selection-sidebar {
            width: 320px;
        }

        .quick-prompts {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .correspondence-container {
            flex-direction: column;
        }

        .selection-sidebar {
            width: 100%;
            height: auto;
            max-height: 40vh;
            border-right: none;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-input-area {
            padding: 1rem;
        }

        .mode-cards {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="correspondence-container">
    <!-- Left Sidebar -->
    <aside class="selection-sidebar">
        <!-- <div class="correspondance-sidebar-header">
            <div class="sidebar-title">
                <div class="sidebar-title-icon">
                    <i class="ti ti-mail-cog"></i>
                </div>
                <div>
                    <h3>Correspondence Management</h3>
                    <p>AI-Powered Document Analysis</p>
                </div>
            </div>
        </div> -->

        <!-- Mode Selection -->
        <div class="mode-selection">
            <!-- <label class="mode-label">Analysis Mode</label> -->
            <div class="mode-cards">
                <div class="mode-card active" data-mode="project" onclick="setAnalysisMode('project')">
                    <div class="mode-card-icon">
                        <i class="ti ti-folders"></i>
                    </div>
                    <div class="mode-card-title">Project Level</div>
                    <div class="mode-card-desc">Multiple documents</div>
                </div>
                <div class="mode-card" data-mode="document" onclick="setAnalysisMode('document')">
                    <div class="mode-card-icon">
                        <i class="ti ti-file-analytics"></i>
                    </div>
                    <div class="mode-card-title">Document Level</div>
                    <div class="mode-card-desc">Single document</div>
                </div>
            </div>
        </div>

        <!-- Project Selection (Project Mode) -->
        <div class="project-selection" id="projectSelection">
            <div class="section-header">
                <span class="section-title">Select Project</span>
            </div>
            <select id="projectSelect" class="project-select" onchange="onProjectChange()">
                <option value="">-- Choose a Project --</option>
            </select>
        </div>

        <!-- Document Section -->
        <div class="docs-section">
            <div class="docs-header">
                <div class="docs-header-left">
                    <span class="docs-title" id="docsTitle">Documents</span>
                    <span class="docs-count" id="docsCount">0</span>
                </div>
                <div class="docs-actions">
                    <button class="btn-sm primary" onclick="openUploadModal()" title="Upload Documents">
                        <i class="ti ti-upload"></i> Upload
                    </button>
                    <button class="btn-sm" onclick="selectAllDocs()" id="selectAllBtn" title="Select All">
                        <i class="ti ti-checks"></i>
                    </button>
                </div>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <i class="ti ti-search search-icon"></i>
                    <input type="text" class="search-input" id="docSearchInput" placeholder="Search documents..."
                        oninput="filterDocs()">
                </div>
            </div>

            <div class="docs-list" id="docsList">
                <div class="empty-state">
                    <i class="ti ti-folder-open"></i>
                    <p>Select a project to view documents</p>
                </div>
            </div>

            <!-- Pagination -->
            <div class="docs-pagination" id="docsPagination">
                <div class="pagination-info">
                    <span id="paginationInfo"></span>
                    <select class="per-page-select" id="perPageSelect" onchange="changePerPage()">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="pagination-controls" id="paginationControls"></div>
            </div>

            <div class="selection-summary" id="selectionSummary" style="display: none;">
                <div class="selection-info">
                    <span class="selection-text"><i class="ti ti-files"></i> <span id="selectedCount">0</span>
                        document(s) selected</span>
                    <button class="clear-btn" onclick="clearDocSelection()">
                        <i class="ti ti-x"></i> Clear
                    </button>
                </div>

            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
        <header class="chat-header">
            <div class="chat-header-left">
                
                <h2 id="chatHeaderTitle"><i class="ti ti-mail-cog"></i>  AI Correspondence Management</h2>
                <p id="chatHeaderSubtitle">Select documents and ask questions</p>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="exportChat()" title="Export">
                    <i class="ti ti-download"></i>
                </button>
                <button class="icon-btn" onclick="clearChat()" title="New Chat">
                    <i class="ti ti-refresh"></i>
                </button>
                <button class="icon-btn" onclick="showHelp()" title="Help">
                    <i class="ti ti-help"></i>
                </button>
            </div>
        </header>

        <div class="chat-messages" id="chatMessages">
            <div class="welcome-state" id="welcomeState">
                <!-- <div class="welcome-icon">
                    <i class="ti ti-robot"></i>
                </div> -->
                <!-- <h2>Correspondence AI Assistant</h2> -->
                <p>Select a project and documents from the sidebar, then ask questions about your contracts, request
                    analysis, or draft professional correspondence.</p>

                <div class="quick-prompts">
                    <button class="quick-prompt" onclick="useQuickPrompt('summary')">
                        <div class="quick-prompt-icon"><i class="ti ti-list-details"></i></div>
                        <div class="quick-prompt-title">Summarize Documents</div>
                        <div class="quick-prompt-desc">Get key points and obligations</div>
                    </button>
                    <button class="quick-prompt" onclick="useQuickPrompt('obligations')">
                        <div class="quick-prompt-icon"><i class="ti ti-checklist"></i></div>
                        <div class="quick-prompt-title">Extract Obligations</div>
                        <div class="quick-prompt-desc">Find deadlines and requirements</div>
                    </button>
                    <button class="quick-prompt" onclick="useQuickPrompt('risks')">
                        <div class="quick-prompt-icon"><i class="ti ti-alert-triangle"></i></div>
                        <div class="quick-prompt-title">Risk Assessment</div>
                        <div class="quick-prompt-desc">Identify potential risks</div>
                    </button>
                    <button class="quick-prompt" onclick="useQuickPrompt('dispute')">
                        <div class="quick-prompt-icon"><i class="ti ti-gavel"></i></div>
                        <div class="quick-prompt-title">Dispute Guidance</div>
                        <div class="quick-prompt-desc">Advice on contractual disputes</div>
                    </button>
                </div>
            </div>
        </div>



        <!-- Input Area -->
        <div class="chat-input-area">
            <!-- <div class="selected-chips" id="selectedChips"> -->
            <!-- Selected document chips rendered here -->
            <!-- </div> -->
            <div class="input-container">
                <div class="input-options">
                    <div class="option-group">
                        <span class="option-label">Tone:</span>
                        <select id="toneSelect" class="option-select">
                            <option value="professional">Professional</option>
                            <option value="formal">Formal</option>
                            <option value="friendly">Friendly</option>
                            <option value="assertive">Assertive</option>
                            <option value="diplomatic">Diplomatic</option>
                            <option value="appreciative">Appreciative</option>
                            <option value="cautionary">Cautionary</option>
                            <option value="conciliatory">Conciliatory</option>
                            <option value="consultative">Consultative</option>
                            <option value="convincing">Convincing</option>
                            <option value="enthusiastic">Enthusiastic</option>
                            <option value="motivating">Motivating</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <span class="option-label">Urgency:</span>
                        <select id="urgencySelect" class="option-select">
                            <option value="normal">Normal</option>
                            <option value="high">High Priority</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <span class="option-label">Language:</span>
                        <select id="languageSelect" class="option-select">
                            <option value="en">English</option>
                            <option value="ar">Arabic</option>
                        </select>
                    </div>
                </div>

                <div class="input-wrapper">
                    <textarea id="queryInput" class="query-textarea" rows="1"
                        placeholder="Ask a question about your documents..."
                        oninput="autoResize(this); updateSubmitState()"></textarea>
                    <div class="input-actions">
                        <button class="submit-btn" id="submitBtn" onclick="submitQuery()" disabled>
                            <i class="ti ti-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Upload Modal - Hidden by default -->
<!-- Upload Modal -->
<div id="uploadModal" class="modal-overlay" style="max-height: 72vh;">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="ti ti-upload"></i> Upload Documents</h3>
            <button class="modal-close" onclick="closeUploadModal()" type="button">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="upload-project-wrapper" id="uploadProjectWrapper" style="margin-bottom: 1rem;">
                <label
                    style="font-size: 0.8rem; font-weight: 600; color: var(--text-color); display: block; margin-bottom: 0.5rem;">
                    <i class="ti ti-folder"></i> Upload to Project <span style="color: var(--danger-color);">*</span>
                </label>
                <select id="uploadProjectSelect" class="project-select" style="width: 100%;">
                    <option value="">-- Select a Project --</option>
                </select>
            </div>

            <div class="upload-zone" id="uploadZone">
                <i class="ti ti-cloud-upload"></i>
                <h4>Drag & Drop Files Here</h4>
                <p>or click to browse (PDF, DOCX, EML, XLSX supported)</p>
                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.eml,.msg,.xlsx,.xls">
            </div>
            <div class="upload-list" id="uploadList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeUploadModal()" type="button">Cancel</button>
            <button class="btn btn-primary" id="uploadBtn" onclick="uploadFiles()" disabled type="button">
                <i class="ti ti-upload"></i> Upload
            </button>
        </div>
    </div>
</div>


<div class="toast-container" id="toastContainer"></div>

<script>
    (function () {
        // =====================================================
        // PRIVATE STATE - Avoid global conflicts
        // =====================================================
        const state = {
            analysisMode: 'project',
            selectedProject: null,
            selectedContract: null,
            allDocuments: [],
            allDocumentsGlobal: [], // All documents across all projects
            allContracts: [], // All contracts for filtering
            projectsList: [], // All projects for upload selector
            filteredDocs: [],
            selectedDocs: new Set(),
            chatHistory: [],
            filesToUpload: [],
            currentPage: 1,
            perPage: 25,
            lastUserQuery: ''
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Add page-specific class to body
            document.body.classList.add('correspondence-page');

            // Auto-collapse main sidebar for this page
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                // Check if sidebar is NOT already collapsed (check both classes for safety)
                const isCollapsed = sidebar.classList.contains('collapsed') ||
                    sidebar.classList.contains('sidebar-collapsed');

                if (!isCollapsed) {
                    // Try using the global toggleSidebar function first
                    if (typeof toggleSidebar === 'function') {
                        toggleSidebar();
                    } else {
                        // Fallback: manually collapse - ADD BOTH CLASSES!
                        sidebar.classList.add('collapsed');           // <-- This was missing!
                        sidebar.classList.add('sidebar-collapsed');

                        const mainContent = document.querySelector('.main-content');
                        if (mainContent) {
                            mainContent.classList.add('sidebar-collapsed');
                        }

                        // Also update body class that some templates use
                        document.body.classList.add('sidebar-collapsed');

                        // Save to localStorage so toggleSidebar() stays in sync
                        localStorage.setItem('sidebarCollapsed', 'true');
                    }
                }
            }

            // Hide chatbot button
            const chatbotBtn = document.getElementById('chatbotButton');
            if (chatbotBtn) {
                chatbotBtn.style.setProperty('display', 'none', 'important');
            }

            loadProjects();
            setupDragDrop();

            document.getElementById('queryInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitQuery();
                }
            });
        });
        // Cleanup when leaving the page
        window.addEventListener('beforeunload', () => {
            document.body.classList.remove('correspondence-page');
        });

        // =====================================================
        // API & DATA LOADING
        // =====================================================
        async function loadProjects() {
            try {
                const response = await fetch('/api/v1/correspondence/projects', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (!response.ok) throw new Error('Failed to load projects');

                const data = await response.json();
                const projectSelect = document.getElementById('projectSelect');

                if (projectSelect) {
                    projectSelect.innerHTML = '<option value="">-- Choose a Project --</option>';
                }

                state.allDocumentsGlobal = [];
                state.allContracts = [];
                state.projectsList = [];
                const contractsSet = new Set();

                (data.data || []).forEach(project => {
                    state.projectsList.push({
                        id: project.id,
                        name: project.project_name,
                        code: project.project_code
                    });

                    if (projectSelect) {
                        projectSelect.innerHTML += `<option value="${project.id}" data-docs='${JSON.stringify(project.documents || [])}'>${escapeHtml(project.project_name)} (${project.project_code})</option>`;
                    }

                    (project.documents || []).forEach(doc => {
                        state.allDocumentsGlobal.push({
                            ...doc,
                            project_id: project.id,
                            project_name: project.project_name,
                            project_code: project.project_code
                        });

                        if (doc.contract_number && !contractsSet.has(doc.contract_number)) {
                            contractsSet.add(doc.contract_number);
                            state.allContracts.push({
                                number: doc.contract_number,
                                title: doc.contract_title || doc.contract_number
                            });
                        }
                    });
                });

                if (state.analysisMode === 'document') {
                    state.allDocuments = [...state.allDocumentsGlobal];
                    state.filteredDocs = [...state.allDocuments];
                    renderDocs();
                }

                return state.projectsList;

            } catch (error) {
                console.error('Error loading projects:', error);
                showToast('Failed to load projects', 'error');
                return [];
            }
        }


        window.onProjectChange = function () {
            const select = document.getElementById('projectSelect');
            const selectedOption = select.options[select.selectedIndex];

            state.selectedProject = select.value;
            state.selectedDocs.clear();
            state.currentPage = 1; // Reset pagination

            if (!state.selectedProject) {
                state.allDocuments = [];
                renderDocs();
                updateSelectionUI();
                return;
            }

            try {
                state.allDocuments = JSON.parse(selectedOption.dataset.docs || '[]');
            } catch (e) {
                state.allDocuments = [];
            }

            state.filteredDocs = [...state.allDocuments];
            renderDocs();
            updateSelectionUI();

            document.getElementById('chatHeaderSubtitle').textContent =
                `Project: ${selectedOption.text}`;
        };

        // =====================================================
        // MODE MANAGEMENT
        // =====================================================
        window.setAnalysisMode = function (mode) {
            state.analysisMode = mode;
            state.currentPage = 1; // Reset pagination
            state.selectedDocs.clear();

            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.toggle('active', card.dataset.mode === mode);
            });

            const selectAllBtn = document.getElementById('selectAllBtn');
            const projectSelection = document.getElementById('projectSelection');
            const contractSelection = document.getElementById('contractSelection');

            if (mode === 'document') {
                // Document Level: Hide project selection, show contract filter, load all docs
                document.getElementById('docsTitle').textContent = 'Select Document';
                selectAllBtn.style.display = 'none';
                projectSelection.style.display = 'none';
                contractSelection.style.display = 'block';

                // Load all documents from all projects
                state.allDocuments = [...state.allDocumentsGlobal];
                state.filteredDocs = [...state.allDocuments];
                state.selectedProject = null;

                document.getElementById('chatHeaderSubtitle').textContent = 'Single document analysis';
            } else {
                // Project Level: Show project selection, hide contract filter
                document.getElementById('docsTitle').textContent = 'Documents';
                selectAllBtn.style.display = 'flex';
                projectSelection.style.display = 'block';
                contractSelection.style.display = 'none';

                // Reset to require project selection
                state.allDocuments = [];
                state.filteredDocs = [];
                document.getElementById('projectSelect').value = '';

                document.getElementById('chatHeaderSubtitle').textContent = 'Select a project to begin';
            }

            renderDocs();
            updateSelectionUI();
        };

        window.onContractFilter = function () {
            const contractNumber = document.getElementById('contractSelect').value;
            state.selectedContract = contractNumber;
            state.currentPage = 1;

            if (contractNumber) {
                state.filteredDocs = state.allDocumentsGlobal.filter(doc => doc.contract_number === contractNumber);
            } else {
                state.filteredDocs = [...state.allDocumentsGlobal];
            }

            state.allDocuments = [...state.filteredDocs];
            renderDocs();
        };

        // =====================================================
        // DOCUMENT RENDERING
        // =====================================================
        function renderDocs() {
            const container = document.getElementById('docsList');
            const totalDocs = state.filteredDocs.length;
            document.getElementById('docsCount').textContent = totalDocs;

            // Calculate pagination
            const totalPages = Math.ceil(totalDocs / state.perPage);
            const startIdx = (state.currentPage - 1) * state.perPage;
            const endIdx = Math.min(startIdx + state.perPage, totalDocs);
            const pageDocs = state.filteredDocs.slice(startIdx, endIdx);

            // Show/hide pagination
            const paginationEl = document.getElementById('docsPagination');
            if (totalDocs > state.perPage) {
                paginationEl.style.display = 'flex';
                document.getElementById('paginationInfo').textContent = `Showing ${startIdx + 1}-${endIdx} of ${totalDocs}`;
                renderPagination(totalPages);
            } else {
                paginationEl.style.display = totalDocs > 0 ? 'flex' : 'none';
                if (totalDocs > 0) {
                    document.getElementById('paginationInfo').textContent = `Showing ${totalDocs} document${totalDocs > 1 ? 's' : ''}`;
                    document.getElementById('paginationControls').innerHTML = '';
                }
            }

            if (pageDocs.length === 0) {
                const emptyMessage = state.analysisMode === 'document'
                    ? 'No documents available. Upload documents to get started.'
                    : (state.selectedProject ? 'No documents found in this project' : 'Select a project to view documents');

                container.innerHTML = `
                <div class="empty-state">
                    <i class="ti ti-file-off"></i>
                    <p>${emptyMessage}</p>
                </div>
            `;
                return;
            }

            const isDocMode = state.analysisMode === 'document';
            const inputType = isDocMode ? 'radio' : 'checkbox';
            const inputName = isDocMode ? 'docRadio' : '';

            container.innerHTML = pageDocs.map(doc => {
                const type = getDocType(doc.document_name);
                const isSelected = state.selectedDocs.has(doc.id);
                const projectInfo = state.analysisMode === 'document' && doc.project_name ?
                    `<span style="color: var(--primary-color);">${escapeHtml(doc.project_code || doc.project_name)}</span>  ` : '';

                return `
                <div class="doc-item ${isSelected ? 'selected' : ''}" onclick="toggleDoc('${doc.id}')">
                    <input type="${inputType}" class="doc-${inputType}" name="${inputName}" 
                        ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleDoc('${doc.id}')">
                    <div class="doc-icon ${type}">
                        <i class="ti ti-file-text"></i>
                    </div>
                    <div class="doc-info">
                        <div class="doc-name" title="${escapeHtml(doc.document_name)}">${escapeHtml(doc.document_name)}</div>
                        <div class="doc-meta">${projectInfo}${formatDate(doc.uploaded_at)}  ${formatFileSize(doc.file_size)}</div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderPagination(totalPages) {
            const container = document.getElementById('paginationControls');
            const current = state.currentPage;

            let html = `<button class="page-btn" onclick="goToPage(${current - 1})" ${current === 1 ? 'disabled' : ''}><i class="ti ti-chevron-left"></i></button>`;

            // Smart pagination: show first, last, current, and nearby pages
            const pages = [];
            pages.push(1);
            if (current > 3) pages.push('...');
            for (let i = Math.max(2, current - 1); i <= Math.min(totalPages - 1, current + 1); i++) {
                if (!pages.includes(i)) pages.push(i);
            }
            if (current < totalPages - 2) pages.push('...');
            if (totalPages > 1) pages.push(totalPages);

            pages.forEach(p => {
                if (p === '...') {
                    html += `<span style="padding: 0 0.25rem; color: var(--text-muted);">...</span>`;
                } else {
                    html += `<button class="page-btn ${p === current ? 'active' : ''}" onclick="goToPage(${p})">${p}</button>`;
                }
            });

            html += `<button class="page-btn" onclick="goToPage(${current + 1})" ${current === totalPages ? 'disabled' : ''}><i class="ti ti-chevron-right"></i></button>`;

            container.innerHTML = html;
        }

        window.goToPage = function (page) {
            const totalPages = Math.ceil(state.filteredDocs.length / state.perPage);
            if (page < 1 || page > totalPages) return;
            state.currentPage = page;
            renderDocs();
        };

        window.changePerPage = function () {
            state.perPage = parseInt(document.getElementById('perPageSelect').value);
            state.currentPage = 1;
            renderDocs();
        };

        window.filterDocs = function () {
            const search = document.getElementById('docSearchInput').value.toLowerCase();

            // Start with the appropriate base set
            let baseDocs = state.analysisMode === 'document'
                ? (state.selectedContract ? state.allDocumentsGlobal.filter(d => d.contract_number === state.selectedContract) : state.allDocumentsGlobal)
                : state.allDocuments;

            state.filteredDocs = baseDocs.filter(doc =>
                doc.document_name.toLowerCase().includes(search)
            );
            state.currentPage = 1; // Reset to first page on search
            renderDocs();
        };

        // =====================================================
        // REGENERATE RESPONSE
        // =====================================================
        window.regenerateResponse = function () {
            if (state.lastUserQuery && state.selectedDocs.size > 0) {
                document.getElementById('queryInput').value = state.lastUserQuery;
                submitQuery();
            } else {
                showToast('No previous query to regenerate', 'warning');
            }
        };

        // =====================================================
        // SELECTION MANAGEMENT
        // =====================================================
        window.toggleDoc = function (docId) {
            if (state.analysisMode === 'document') {
                // Single selection for document mode
                state.selectedDocs.clear();
                state.selectedDocs.add(docId);
            } else {
                // Multi-selection for project mode
                if (state.selectedDocs.has(docId)) {
                    state.selectedDocs.delete(docId);
                } else {
                    state.selectedDocs.add(docId);
                }
            }
            renderDocs();
            updateSelectionUI();
        };

        window.selectAllDocs = function () {
            if (state.analysisMode === 'document') return;
            state.filteredDocs.forEach(doc => state.selectedDocs.add(doc.id));
            renderDocs();
            updateSelectionUI();
            showToast(`Selected ${state.filteredDocs.length} documents`, 'success');
        };

        window.clearDocSelection = function () {
            state.selectedDocs.clear();
            renderDocs();
            updateSelectionUI();
        };

        function updateSelectionUI() {
            const count = state.selectedDocs.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectionSummary').style.display = count > 0 ? 'block' : 'none';

            // Render selected document chips
            const chipsContainer = document.getElementById('selectedChips');
            if (count > 0 && chipsContainer) {
                const selectedDocsList = state.allDocuments.filter(d => state.selectedDocs.has(d.id));
                const maxChips = 6;
                const displayDocs = selectedDocsList.slice(0, maxChips);
                const remaining = selectedDocsList.length - maxChips;

                chipsContainer.innerHTML = displayDocs.map(doc => `
                <div class="selected-chip" title="${escapeHtml(doc.document_name)}">
                    <i class="ti ti-file-text"></i>
                    <span>${escapeHtml(doc.document_name.substring(0, 15))}${doc.document_name.length > 15 ? '...' : ''}</span>
                </div>
            `).join('') + (remaining > 0 ? `<div class="selected-chip">+${remaining} more</div>` : '');
            }

            updateSubmitState();
        }

        // =====================================================
        // UPLOAD FUNCTIONALITY
        // =====================================================
        window.openUploadModal = function () {
            console.log('Opening modal...');

            state.filesToUpload = [];
            renderUploadList();

            const modal = document.getElementById('uploadModal');
            const selector = document.getElementById('uploadProjectSelect');
            const wrapper = document.getElementById('uploadProjectWrapper');

            if (!modal) {
                alert('Modal element not found!');
                return;
            }

            // Populate project selector
            selector.innerHTML = '<option value="">-- Select a Project --</option>';
            state.projectsList.forEach(p => {
                selector.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)} (${escapeHtml(p.code)})</option>`;
            });

            // Pre-select if in project mode
            if (state.analysisMode === 'project' && state.selectedProject) {
                selector.value = state.selectedProject;
            }

            modal.style.display = 'flex';
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            console.log('Modal opened');
        };
        window.closeUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
            }
            document.body.style.overflow = '';
            state.filesToUpload = [];
            document.getElementById('fileInput').value = '';
            renderUploadList();
        };

        function setupDragDrop() {
            const zone = document.getElementById('uploadZone');
            const modal = document.getElementById('uploadModal');
            const fileInput = document.getElementById('fileInput');

            // Click on zone to trigger file input
            zone.addEventListener('click', () => {
                fileInput.click();
            });

            // Handle file selection
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Close modal when clicking on overlay (outside modal)
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUploadModal();
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeUploadModal();
                }
            });

            // Drag and drop handlers
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        function handleFiles(files) {
            const allowedTypes = ['.pdf', '.doc', '.docx', '.eml', '.msg', '.xlsx', '.xls'];

            Array.from(files).forEach(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (allowedTypes.includes(ext)) {
                    // Avoid duplicates
                    if (!state.filesToUpload.some(f => f.name === file.name && f.size === file.size)) {
                        state.filesToUpload.push(file);
                    }
                } else {
                    showToast(`${file.name} - unsupported format`, 'warning');
                }
            });

            renderUploadList();
        }

        function renderUploadList() {
            const container = document.getElementById('uploadList');
            document.getElementById('uploadBtn').disabled = state.filesToUpload.length === 0;

            if (state.filesToUpload.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = state.filesToUpload.map((file, i) => `
            <div class="upload-item">
                <div class="upload-item-icon">
                    <i class="ti ti-file"></i>
                </div>
                <div class="upload-item-info">
                    <div class="upload-item-name">${escapeHtml(file.name)}</div>
                    <div class="upload-item-size">${formatFileSize(file.size)}</div>
                </div>
                <button class="upload-item-remove" onclick="removeUploadFile(${i})">
                    <i class="ti ti-x"></i>
                </button>
            </div>
        `).join('');
        }

        window.removeUploadFile = function (index) {
            state.filesToUpload.splice(index, 1);
            renderUploadList();
        };

        window.uploadFiles = async function () {
            if (state.filesToUpload.length === 0) return;

            // Get project ID based on mode
            let projectId = state.selectedProject;
            if (state.analysisMode === 'document') {
                const uploadProjectSelect = document.getElementById('uploadProjectSelect');
                if (uploadProjectSelect) {
                    projectId = uploadProjectSelect.value;
                }
            }

            if (!projectId) {
                showToast('Please select a project for upload', 'warning');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const originalContent = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="ti ti-loader"></i> Uploading...';

            try {
                const formData = new FormData();
                state.filesToUpload.forEach(file => formData.append('files', file));
                formData.append('project_id', projectId);

                const response = await fetch('/api/v1/correspondence/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` },
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                const result = await response.json();
                showToast(`${state.filesToUpload.length} file(s) uploaded successfully`, 'success');
                closeUploadModal();

                // Reload all data
                await loadProjects();

                // If in project mode, re-select the project
                if (state.analysisMode === 'project' && state.selectedProject) {
                    document.getElementById('projectSelect').value = state.selectedProject;
                    onProjectChange();
                }

            } catch (error) {
                console.error('Upload error:', error);
                showToast('Upload failed. Please try again.', 'error');
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalContent;
            }
        };

        // =====================================================
        // QUERY SUBMISSION
        // =====================================================
        window.submitQuery = async function () {
            const query = document.getElementById('queryInput').value.trim();
            if (!query || state.selectedDocs.size === 0) {
                if (state.selectedDocs.size === 0) {
                    showToast('Please select at least one document', 'warning');
                }
                return;
            }

            // Save for regeneration
            state.lastUserQuery = query;

            document.getElementById('welcomeState').style.display = 'none';
            addMessage('user', query);

            document.getElementById('queryInput').value = '';
            autoResize(document.getElementById('queryInput'));
            updateSubmitState();

            const typingId = showTypingIndicator();

            try {
                const response = await fetch('/api/v1/correspondence/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        query: query,
                        mode: state.analysisMode,
                        document_ids: [...state.selectedDocs],
                        project_id: state.selectedProject,
                        tone: document.getElementById('toneSelect').value,
                        urgency: document.getElementById('urgencySelect').value,
                        language: document.getElementById('languageSelect').value
                    })
                });

                if (!response.ok) throw new Error('Analysis failed');

                const data = await response.json();
                removeTypingIndicator(typingId);

                addMessage('ai', data.content, {
                    confidence: data.confidence,
                    sources: data.sources || []
                });

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator(typingId);
                addMessage('ai', 'I apologize, but I encountered an error. Please try again.', { isError: true });
                showToast('Analysis failed', 'error');
            }
        };

        // =====================================================
        // CHAT MESSAGE RENDERING
        // =====================================================
        function addMessage(type, content, options = {}) {
            const container = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            let formattedContent = content;
            if (typeof marked !== 'undefined') {
                formattedContent = marked.parse(content);
            } else {
                formattedContent = content.replace(/\n/g, '<br>');
            }

            let sourcesHtml = '';
            if (options.sources && options.sources.length > 0) {
                sourcesHtml = `
                <div class="sources-section">
                    <div class="sources-title">Sources</div>
                    <div class="source-tags">
                        ${options.sources.map(s => `
                            <span class="source-tag">
                                <i class="ti ti-file-text"></i>
                                ${escapeHtml(s.name || s.document_name || 'Document')}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
            }

            const confidenceBadge = options.confidence ?
                `<span class="confidence-badge"><i class="ti ti-sparkles"></i> ${Math.round(options.confidence * 100)}%</span>` : '';

            messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="ti ti-${type === 'user' ? 'user' : 'robot'}"></i>
            </div>
            <div class="message-content">
                <div class="message-header">
                    <span class="message-sender">${type === 'user' ? 'You' : 'CALIM AI'}</span>
                    <span class="message-time">${time}</span>
                   
                </div>
                <div class="message-body">${formattedContent}${sourcesHtml}</div>
                ${type === 'ai' ? `
                    <div class="message-actions">
                        <button class="msg-action-btn" onclick="copyMsgText(this)"><i class="ti ti-copy"></i> Copy</button>
                        <button class="msg-action-btn" onclick="downloadMsgText(this)"><i class="ti ti-download"></i> Download</button>
                        <button class="msg-action-btn" onclick="regenerateResponse()"><i class="ti ti-refresh"></i> Regenerate</button>
                    </div>
                ` : ''}
            </div>
        `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            state.chatHistory.push({ type, content, time });
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const id = 'typing-' + Date.now();

            const div = document.createElement('div');
            div.id = id;
            div.className = 'message ai';
            div.innerHTML = `
            <div class="message-avatar"><i class="ti ti-robot"></i></div>
            <div class="message-content">
                <div class="message-body">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        `;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // =====================================================
        // QUICK PROMPTS
        // =====================================================
        window.useQuickPrompt = function (type) {
            const prompts = {
                summary: 'Please provide a comprehensive summary of the selected documents, highlighting key points and action items.',
                obligations: 'Extract all contractual obligations including party responsibilities, deadlines, and compliance requirements.',
                risks: 'Analyze these documents for potential risks including legal, financial, and operational concerns.',
                dispute: 'We have received a back charge letter. Please advise on how to administer the contract and defend our rights.'
            };

            document.getElementById('queryInput').value = prompts[type] || '';
            // document.getElementById('welcomeState').style.display = 'none';
            document.getElementById('queryInput').focus();
            autoResize(document.getElementById('queryInput'));
            updateSubmitState();
        };

        // =====================================================
        // UTILITIES
        // =====================================================
        window.autoResize = function (el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        };

        window.updateSubmitState = function () {
            const query = document.getElementById('queryInput').value.trim();
            document.getElementById('submitBtn').disabled = !(query && state.selectedDocs.size > 0);
        };

        function getAuthToken() {
            return localStorage.getItem('access_token') || '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function getDocType(filename) {
            if (!filename) return 'other';
            const ext = filename.split('.').pop().toLowerCase();
            if (ext === 'pdf') return 'pdf';
            if (['doc', 'docx'].includes(ext)) return 'docx';
            if (['xls', 'xlsx'].includes(ext)) return 'xlsx';
            if (['eml', 'msg'].includes(ext)) return 'email';
            return 'other';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '-';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: 'ti-check', error: 'ti-x', warning: 'ti-alert-triangle', info: 'ti-info-circle' };
            toast.innerHTML = `<i class="ti ${icons[type] || icons.info}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        // =====================================================
        // MESSAGE ACTIONS
        // =====================================================
        window.copyMsgText = function (btn) {
            const text = btn.closest('.message-content').querySelector('.message-body').innerText;
            navigator.clipboard.writeText(text).then(() => showToast('Copied!', 'success'));
        };

        window.downloadMsgText = function (btn) {
            const text = btn.closest('.message-content').querySelector('.message-body').innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `response-${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            showToast('Downloaded', 'success');
        };

        window.clearChat = function () {
            document.getElementById('chatMessages').innerHTML = `
            <div class="welcome-state" id="welcomeState">
                <div class="welcome-icon"><i class="ti ti-robot"></i></div>
                <h2>Correspondence AI Assistant</h2>
                <p>Select a project and documents, then ask questions about contracts or draft correspondence.</p>
                <div class="quick-prompts">
                    <button class="quick-prompt" onclick="useQuickPrompt('summary')">
                        <div class="quick-prompt-icon"><i class="ti ti-list-details"></i></div>
                        <div class="quick-prompt-title">Summarize Documents</div>
                        <div class="quick-prompt-desc">Get key points and obligations</div>
                    </button>
                    <button class="quick-prompt" onclick="useQuickPrompt('obligations')">
                        <div class="quick-prompt-icon"><i class="ti ti-checklist"></i></div>
                        <div class="quick-prompt-title">Extract Obligations</div>
                        <div class="quick-prompt-desc">Find deadlines and requirements</div>
                    </button>
                    <button class="quick-prompt" onclick="useQuickPrompt('risks')">
                        <div class="quick-prompt-icon"><i class="ti ti-alert-triangle"></i></div>
                        <div class="quick-prompt-title">Risk Assessment</div>
                        <div class="quick-prompt-desc">Identify potential risks</div>
                    </button>
                    <button class="quick-prompt" onclick="useQuickPrompt('dispute')">
                        <div class="quick-prompt-icon"><i class="ti ti-gavel"></i></div>
                        <div class="quick-prompt-title">Dispute Guidance</div>
                        <div class="quick-prompt-desc">Advice on contractual disputes</div>
                    </button>
                </div>
            </div>
        `;
            state.chatHistory = [];
            showToast('Chat cleared', 'info');
        };

        window.exportChat = function () {
            if (state.chatHistory.length === 0) {
                showToast('No conversation to export', 'warning');
                return;
            }
            const text = state.chatHistory.map(m => `[${m.time}] ${m.type === 'user' ? 'You' : 'CALIM AI'}:\n${m.content}`).join('\n\n---\n\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `chat-${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            showToast('Exported', 'success');
        };

        window.showHelp = function () {
            showToast('1. Select mode  2. Choose project  3. Select documents  4. Ask questions', 'info');
        };
    })();
</script>
{% endblock %}