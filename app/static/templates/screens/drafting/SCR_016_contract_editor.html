{% extends "base.html" %}

{% block title %}Contract Editor - CALIM360{% endblock %}

{% block head %}
<link rel="stylesheet" href="/app/static/css/contract-edit.css">
<link rel="stylesheet" href="/static/css/bubble-comments.css">
<style>
    .modal-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }


    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: white;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }


    /* Disabled workflow option styles */
    .disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
        background: #f5f5f5 !important;
    }

    .disabled input[type="radio"] {
        cursor: not-allowed !important;
        pointer-events: none;
    }

    /* Additional styles for workflow integration */
    .workflow-status-bar {
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.05), rgba(115, 180, 224, 0.05));
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .workflow-status-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .workflow-status-label {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .workflow-status-value {
        font-weight: 600;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .workflow-setup-btn {
        padding: 0.5rem 1rem;
        background: white;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .workflow-setup-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    /* Workflow Modal Styles */
    .workflow-option-card {
        padding: 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        margin-bottom: 1rem;
    }

    .workflow-option-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.15);
    }

    .workflow-option-card.selected {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.05), rgba(115, 180, 224, 0.05));
    }

    .workflow-option-card.selected::after {
        content: '\2713';
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    /* Workflow Stepper Styles */
    .workflow-stepper {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .stepper-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .stepper-line {
        position: absolute;
        top: 24px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--border-color);
        z-index: 0;
    }

    .stepper-progress {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background: var(--success-color);
        transition: width 0.3s ease;
        z-index: 1;
    }

    .stepper-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        z-index: 2;
        cursor: pointer;
        flex: 1;
    }

    .step-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 3px solid var(--border-color);
        transition: all 0.3s ease;
        font-size: 1.25rem;
    }

    .stepper-step.completed .step-icon-wrapper {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }

    .stepper-step.active .step-icon-wrapper {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        box-shadow: 0 0 0 8px rgba(39, 98, 203, 0.1);
    }

    .stepper-step.pending .step-icon-wrapper {
        background: white;
        border-color: var(--border-color);
        color: var(--text-muted);
    }

    .step-label {
        font-size: 0.8125rem;
        color: var(--text-muted);
        text-align: center;
        font-weight: 500;
    }

    .stepper-step.completed .step-label,
    .stepper-step.active .step-label {
        color: var(--text-color);
        font-weight: 600;
    }

    .step-date {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* AI Features Styles */
    .ai-toolbar-group {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0 0.5rem;
        /* border-left: 2px solid var(--primary-color); */
    }

    .ai-toolbar-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.875rem;
    }

    .ai-toolbar-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(39, 98, 203, 0.3);
    }

    /* Risk Modal Styles */
    .risk-modal {
        max-width: 1000px;
    }

    .risk-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .risk-stat {
        background: var(--background-light);
        padding: 1.25rem;
        border-radius: 8px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    .risk-stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .risk-stat-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .risk-stat.high {
        border-color: var(--danger-color);
        background: rgba(220, 53, 69, 0.05);
    }

    .risk-stat.high .risk-stat-value {
        color: var(--danger-color);
    }

    .risk-stat.medium {
        border-color: var(--warning-color);
        background: rgba(255, 193, 7, 0.05);
    }

    .risk-stat.medium .risk-stat-value {
        color: var(--warning-color);
    }

    .risk-stat.low {
        border-color: var(--success-color);
        background: rgba(40, 167, 69, 0.05);
    }

    .risk-stat.low .risk-stat-value {
        color: var(--success-color);
    }


    /* Simple Signature Styles */
    .signature-btn {
        background: linear-gradient(135deg, var(--success-color), #20c997);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .signature-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .signature-field {
        border: 2px dashed var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
        padding: 1rem;
        border-radius: 8px;
        min-width: 200px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0.5rem 0;
    }

    .signature-field:hover {
        background: rgba(39, 98, 203, 0.1);
    }

    .signature-field.signed {
        border: 2px solid var(--success-color);
        background: rgba(40, 167, 69, 0.05);
        cursor: default;
    }

    .signature-canvas {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: white;
        cursor: crosshair;
        width: 100%;
        height: 200px;
        display: block;
    }

    .signature-preview {
        font-family: 'Brush Script MT', cursive;
        font-size: 2rem;
        text-align: center;
        padding: 1rem;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: white;
    }

    /* Loading Overlay */
    /* Loading Overlay with Logo */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        /* Grey overlay */
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
    }

    .loading-overlay.show {
        display: flex;
    }

    /* Logo Container */
    .logo-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        /* Space between logo and text */
        animation: fadeIn 0.5s ease;
    }

    /* Logo Row */
    .logo-row {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Animated Logo */
    .loading-logo {
        width: 50px;
        height: auto;
        animation: pulse 2s ease-in-out infinite;
        filter: drop-shadow(0 4px 12px rgba(255, 255, 255, 0.3));
    }

    /* Text Row */
    .text-row {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Loading Text */
    .loading-overlay .loading-text {
        color: #ffffff;
        font-size: 16px;
        font-weight: 500;
        letter-spacing: 0.5px;
        animation: fadeInOut 2s ease-in-out infinite;
        margin: 0;
    }

    /* Pulse Animation for Logo */
    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.05);
            opacity: 0.8;
        }
    }

    /* Fade In Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Fade In/Out Animation for Text */
    @keyframes fadeInOut {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* Remove old loader styles if they exist */
    .loader {
        display: none;
    }

    /* Fade In Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Fade In/Out Animation for Text */
    @keyframes fadeInOut {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* Remove old loader styles if they exist */
    .loader {
        display: none;
    }

    /* Hide editor until loaded */
    #contractEditor {
        display: none;
    }

    #contractEditor.loaded {
        display: block;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }


    /* Upload Area Styles */
    .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    .upload-area.dragover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.1);
    }

    /* File Item Styles - FIXED */
    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .file-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .remove-file-btn {
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
    }

    .remove-file-btn:hover {
        background: var(--danger-bg);
    }
</style>

<style>
    /* =====================================================
   BLOCKCHAIN VERIFICATION STYLES
   File: static/css/blockchain-verification.css
   ===================================================== */

    /* ==========================================
   Blockchain Card Styles
   ========================================== */

    .blockchain-card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .blockchain-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .blockchain-header {
        background: linear-gradient(135deg, #2762cb 0%, #73B4E0 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.25rem 0.25rem 0 0;
    }

    .blockchain-header h5 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .blockchain-body {
        padding: 1.5rem;
    }

    /* ==========================================
   Verification Indicator Styles
   ========================================== */

    #blockchain-indicator,
    [id^="blockchain-indicator"] {
        padding: 1rem;
        border-radius: 0.5rem;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }

    .blockchain-verifying {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #6c757d;
        font-size: 0.95rem;
    }

    .blockchain-verified {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .blockchain-tampered {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .blockchain-error {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    .blockchain-new {
        background: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    /* Alert Styles within Blockchain */
    .blockchain-body .alert {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
    }

    .blockchain-body .alert svg {
        flex-shrink: 0;
    }

    /* ==========================================
   Button Styles
   ========================================== */

    .blockchain-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .blockchain-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: pointer;
    }

    .blockchain-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .blockchain-btn:active {
        transform: translateY(0);
    }

    .blockchain-btn-primary {
        background: #2762cb;
        color: white;
        border-color: #2762cb;
    }

    .blockchain-btn-primary:hover {
        background: #1e4fa0;
        border-color: #1e4fa0;
    }

    .blockchain-btn-outline {
        background: white;
        color: #2762cb;
        border-color: #2762cb;
    }

    .blockchain-btn-outline:hover {
        background: #2762cb;
        color: white;
    }

    .blockchain-btn-secondary {
        background: white;
        color: #6c757d;
        border-color: #6c757d;
    }

    .blockchain-btn-secondary:hover {
        background: #6c757d;
        color: white;
    }

    /* ==========================================
   Info Text Styles
   ========================================== */

    .blockchain-info-text {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .blockchain-info-text small {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6c757d;
        font-size: 0.85rem;
    }

    .blockchain-info-text svg {
        flex-shrink: 0;
        color: #2762cb;
    }

    /* ==========================================
   Spinner Styles
   ========================================== */

    .blockchain-spinner {
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2762cb;
        border-radius: 50%;
        animation: blockchain-spin 1s linear infinite;
    }

    @keyframes blockchain-spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* ==========================================
   Modal Styles
   ========================================== */

    .blockchain-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: blockchain-fade-in 0.3s ease;
    }

    @keyframes blockchain-fade-in {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .blockchain-modal-dialog {
        background: white;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: blockchain-slide-up 0.3s ease;
    }

    @keyframes blockchain-slide-up {
        from {
            transform: translateY(50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .blockchain-modal-header {
        background: linear-gradient(135deg, #2762cb 0%, #73B4E0 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .blockchain-modal-header h5 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .blockchain-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s ease;
    }

    .blockchain-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .blockchain-modal-body {
        padding: 2rem;
    }

    .blockchain-certificate-icon {
        text-align: center;
        margin-bottom: 2rem;
    }

    .blockchain-certificate-icon svg {
        width: 80px;
        height: 80px;
        color: #28a745;
        animation: blockchain-check-in 0.5s ease;
    }

    @keyframes blockchain-check-in {
        0% {
            transform: scale(0);
            opacity: 0;
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .blockchain-certificate-icon h4 {
        margin-top: 1rem;
        color: #333;
        font-weight: 600;
    }

    .blockchain-certificate-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5rem 0;
    }

    .blockchain-certificate-table td {
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
    }

    .blockchain-certificate-table td:first-child {
        background: #f8f9fa;
        font-weight: 600;
        width: 35%;
        color: #495057;
    }

    .blockchain-certificate-table code {
        background: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        color: #e83e8c;
        word-break: break-all;
    }

    .blockchain-certificate-table .badge {
        padding: 0.4rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .blockchain-certificate-table .badge.bg-success {
        background: #28a745 !important;
        color: white;
    }

    .blockchain-modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    /* ==========================================
   Responsive Design
   ========================================== */

    @media (max-width: 768px) {
        .blockchain-buttons {
            flex-direction: column;
        }

        .blockchain-btn {
            width: 100%;
            justify-content: center;
        }

        .blockchain-modal-dialog {
            width: 95%;
            margin: 1rem;
        }

        .blockchain-certificate-table td:first-child {
            width: 40%;
            font-size: 0.9rem;
        }

        .blockchain-certificate-table code {
            font-size: 0.75rem;
        }
    }

    @media (max-width: 576px) {
        .blockchain-header h5 {
            font-size: 1rem;
        }

        .blockchain-body {
            padding: 1rem;
        }

        .blockchain-modal-body {
            padding: 1.5rem;
        }

        .blockchain-certificate-table {
            font-size: 0.9rem;
        }
    }

    /* ==========================================
   Print Styles
   ========================================== */

    @media print {

        .blockchain-buttons,
        .blockchain-modal-footer,
        .blockchain-modal-close {
            display: none !important;
        }

        .blockchain-modal {
            background: white;
            position: relative;
        }

        .blockchain-modal-dialog {
            box-shadow: none;
            max-width: 100%;
        }

        .blockchain-certificate-table {
            page-break-inside: avoid;
        }
    }

    /* ==========================================
   Icon Styles
   ========================================== */

    .blockchain-icon-shield {
        color: #2762cb;
    }

    .blockchain-icon-verified {
        color: #28a745;
    }

    .blockchain-icon-tampered {
        color: #dc3545;
    }

    .blockchain-icon-warning {
        color: #ffc107;
    }

    .blockchain-icon-info {
        color: #17a2b8;
    }

    /* ==========================================
   Animation Effects
   ========================================== */

    .blockchain-pulse {
        animation: blockchain-pulse-animation 2s ease-in-out infinite;
    }

    @keyframes blockchain-pulse-animation {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .blockchain-bounce {
        animation: blockchain-bounce-animation 1s ease infinite;
    }

    @keyframes blockchain-bounce-animation {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    /* ==========================================
   Utility Classes
   ========================================== */

    .blockchain-text-primary {
        color: #2762cb !important;
    }

    .blockchain-text-success {
        color: #28a745 !important;
    }

    .blockchain-text-danger {
        color: #dc3545 !important;
    }

    .blockchain-text-warning {
        color: #ffc107 !important;
    }

    .blockchain-text-info {
        color: #17a2b8 !important;
    }

    .blockchain-bg-light {
        background-color: #f8f9fa !important;
    }

    .blockchain-border-primary {
        border-color: #2762cb !important;
    }

    .blockchain-shadow {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .blockchain-shadow-lg {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
</style>


<style>
    .clause-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .clause-item:hover {
        background: #f8f9fa;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border-color: var(--primary-color);
    }

    .clause-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary-color);
    }

    .clause-item span {
        flex: 1;
        font-size: 0.9rem;
        color: var(--text-color);
    }

    .clause-item input[type="checkbox"]:checked+span {
        font-weight: 500;
    }
</style>



<style>
    /* AI Loader Animation */
    .ai-loader {
        width: 60px;
        height: 60px;
        border: 4px solid var(--border-color);
        border-top-color: var(--warning-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    .loader-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Risk Stats Grid */
    .risk-stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        padding: 1.5rem;
        background: var(--background-light);
        border-bottom: 1px solid var(--border-color);
    }

    .risk-stat-card {
        background: white;
        padding: 1.25rem;
        border-radius: 12px;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .risk-stat-card.high {
        border-color: var(--danger-color);
        background: rgba(220, 53, 69, 0.05);
    }

    .risk-stat-card.medium {
        border-color: var(--warning-color);
        background: rgba(255, 193, 7, 0.05);
    }

    .risk-stat-card.low {
        border-color: var(--success-color);
        background: rgba(40, 167, 69, 0.05);
    }

    .risk-stat-card.score {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    .risk-stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .risk-stat-card.high .risk-stat-value {
        color: var(--danger-color);
    }

    .risk-stat-card.medium .risk-stat-value {
        color: var(--warning-color);
    }

    .risk-stat-card.low .risk-stat-value {
        color: var(--success-color);
    }

    .risk-stat-card.score .risk-stat-value {
        color: var(--primary-color);
    }

    .risk-stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        font-weight: 600;
    }

    /* Executive Summary */
    .executive-summary {
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.05), rgba(39, 98, 203, 0.02));
        border-bottom: 1px solid var(--border-color);
    }

    .executive-summary h4 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        color: var(--primary-color);
    }

    /* Risk Items List */
    .risk-items-container {
        padding: 1.5rem;
    }

    .risk-item {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        margin-bottom: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .risk-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .risk-item.high {
        border-left: 4px solid var(--danger-color);
    }

    .risk-item.medium {
        border-left: 4px solid var(--warning-color);
    }

    .risk-item.low {
        border-left: 4px solid var(--success-color);
    }

    .risk-item-header {
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        background: var(--background-light);
        transition: background 0.2s ease;
    }

    .risk-item-header:hover {
        background: var(--background-hover);
    }

    .risk-item-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
    }

    .risk-item-badges {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .severity-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .severity-badge.high {
        background: var(--danger-color);
        color: white;
    }

    .severity-badge.medium {
        background: var(--warning-color);
        color: #333;
    }

    .severity-badge.low {
        background: var(--success-color);
        color: white;
    }

    .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        background: var(--background-light);
        color: var(--text-muted);
        border: 1px solid var(--border-color);
    }

    .risk-item-content {
        padding: 1.25rem;
        display: none;
        border-top: 1px solid var(--border-color);
    }

    .risk-item.expanded .risk-item-content {
        display: block;
    }

    .risk-detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .risk-detail-item {
        padding: 0.75rem;
        background: var(--background-light);
        border-radius: 8px;
    }

    .risk-detail-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .risk-detail-value {
        font-size: 0.875rem;
        color: var(--text-color);
    }

    .recommendation-box {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
        border: 1px solid var(--success-color);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .recommendation-box h5 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--success-color);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    /* Compliance Status */
    .compliance-section {
        padding: 1.5rem;
        background: var(--background-light);
        border-top: 1px solid var(--border-color);
    }

    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }

    .compliance-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .compliance-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .compliance-icon.pass {
        background: var(--success-color);
        color: white;
    }

    .compliance-icon.fail {
        background: var(--danger-color);
        color: white;
    }

    .compliance-icon.pending {
        background: var(--warning-color);
        color: white;
    }

    /* Score Ring */
    .score-ring {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto;
    }

    .score-ring svg {
        transform: rotate(-90deg);
    }

    .score-ring circle {
        fill: none;
        stroke-width: 8;
    }

    .score-ring .bg {
        stroke: var(--border-color);
    }

    .score-ring .progress {
        stroke: var(--primary-color);
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease;
    }

    .score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .risk-stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .risk-detail-grid {
            grid-template-columns: 1fr;
        }

        .compliance-grid {
            grid-template-columns: 1fr;
        }
    }
</style>



<style>
    /* Blockchain Monitor Button */
    .blockchain-btn-info {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        color: white;
        border: none;
    }

    .blockchain-btn-info:hover {
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        transform: translateY(-2px);
    }

    /* Live Indicator Animation */
    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* Modal Overlay */
    #blockchainMonitorModal.show {
        display: flex !important;
    }

    /* Activity Item Styles */
    .activity-item {
        padding: 1rem;
        border-left: 3px solid #3b82f6;
        background: #f8fafc;
        border-radius: 0 8px 8px 0;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
    }

    .activity-item:hover {
        background: #eff6ff;
        border-left-color: #2563eb;
        transform: translateX(4px);
    }

    .activity-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .activity-item-type {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #1e293b;
        font-size: 0.875rem;
    }

    .activity-item-time {
        font-size: 0.75rem;
        color: #64748b;
    }

    .activity-item-details {
        font-size: 0.8125rem;
        color: #475569;
        margin-left: 1.75rem;
    }

    .activity-item-hash {
        font-family: monospace;
        font-size: 0.75rem;
        color: #6366f1;
        background: #eef2ff;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-top: 0.5rem;
        display: inline-block;
    }

    /* Scrollbar Styling */
    .activity-stream-modal::-webkit-scrollbar {
        width: 6px;
    }

    .activity-stream-modal::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .activity-stream-modal::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .activity-stream-modal::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>

<style>
    /* Blockchain Activity Panel Styles */
    .blockchain-evidence-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .evidence-panel-header {
        background: linear-gradient(135deg, #0066cc 0%, #00b4d8 100%);
        color: white;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .evidence-panel-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
    }

    .evidence-panel-title i {
        font-size: 1.5rem;
    }

    .live-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .live-dot {
        width: 6px;
        height: 6px;
        background: #10b981;
        border-radius: 50%;
        animation: livePulse 2s infinite;
    }

    @keyframes livePulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    .evidence-panel-body {
        padding: 1.5rem;
    }

    /* Network Status Bar */
    .network-status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .status-label {
        color: #64748b;
        font-weight: 500;
    }

    .status-value {
        color: #1e293b;
        font-weight: 700;
    }

    /* Activity Stream */
    .activity-stream {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .activity-stream::-webkit-scrollbar {
        width: 6px;
    }

    .activity-stream::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .activity-stream::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .stream-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: #f8fafc;
        border-left: 3px solid #0066cc;
        border-radius: 8px;
        transition: all 0.3s ease;
        animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .stream-item:hover {
        background: #f1f5f9;
        transform: translateX(4px);
    }

    .stream-item.success {
        border-left-color: #10b981;
    }

    .stream-item.processing {
        border-left-color: #f59e0b;
    }

    .stream-item.error {
        border-left-color: #ef4444;
    }

    .stream-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 1.25rem;
    }

    .stream-item.success .stream-icon {
        background: #d1fae5;
        color: #10b981;
    }

    .stream-item.processing .stream-icon {
        background: #fef3c7;
        color: #f59e0b;
    }

    .stream-item.error .stream-icon {
        background: #fee2e2;
        color: #ef4444;
    }



    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .stream-content {
        flex: 1;
    }

    .stream-title {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }

    .stream-description {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .stream-timestamp {
        font-size: 0.75rem;
        color: #94a3b8;
        font-family: 'Courier New', monospace;
    }

    .stream-metadata {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .metadata-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 0.7rem;
        font-family: 'Courier New', monospace;
    }

    /* Hash Visualization */
    .hash-visual {
        background: #1e293b;
        color: #10b981;
        padding: 0.75rem;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 0.75rem;
        word-break: break-all;
        margin-top: 0.5rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Empty State */
    .empty-activity-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #64748b;
    }

    .empty-activity-state i {
        font-size: 3rem;
        opacity: 0.3;
        margin-bottom: 1rem;
    }


    /* Email Search Suggestions Dropdown */
    .email-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
    }

    .email-suggestions::-webkit-scrollbar {
        width: 6px;
    }

    .email-suggestions::-webkit-scrollbar-track {
        background: var(--background-light);
    }

    .email-suggestions::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>


<style>
    /* Negotiation Container */
    .negotiation-container {
        display: flex;
        flex-direction: column;
        height: 600px;
        max-height: 80vh;
    }

    /* Status Bar */
    .negotiation-status {
        padding: 1rem 1.5rem;
        background: var(--background-light);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .participants {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .participant {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: white;
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .participant.online .status-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .session-actions {
        display: flex;
        gap: 0.5rem;
    }

    .session-btn {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .session-btn:hover {
        background: var(--background-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* Messages Area */
    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f8f9fa;
    }

    /* Welcome Message */
    .welcome-message {
        text-align: center;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .welcome-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 32px;
    }

    .welcome-message h4 {
        margin: 0 0 0.5rem 0;
        color: var(--text-color);
    }

    .welcome-message p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* System Message */
    .system-message {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: rgba(14, 165, 233, 0.1);
        border-left: 3px solid #0ea5e9;
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: #0369a1;
    }

    .system-icon {
        font-size: 18px;
    }

    /* Message */
    .message {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        max-width: 80%;
    }

    .message.user-msg {
        margin-left: auto;
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .message-content {
        flex: 1;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .sender {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-color);
    }

    .timestamp {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .message-text {
        padding: 0.75rem 1rem;
        background: white;
        border-radius: 8px;
        /* box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); */
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--text-color);
    }

    .user-msg .message-text {
        background: var(--primary-color);
        color: white;
    }

    /* Input Area */
    .input-area {
        /* padding: 1rem 1.5rem; */
        /* background: white; */
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
    }

    .send-btn {
        padding: 0.75rem 1.25rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        transition: all 0.3s ease;
        height: 44px;
    }

    .send-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    /* Suggestions */
    .suggestion-btn {
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .suggestion-btn:hover {
        background: var(--background-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* Loading Spinner Animation */
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Pending Message State */
    .message-pending {
        opacity: 0.7;
    }

    .message-pending .message-text {
        position: relative;
    }

    .message-pending .message-text::after {
        content: '';
        display: inline-block;
        width: 4px;
        height: 4px;
        background: currentColor;
        border-radius: 50%;
        margin-left: 0.5rem;
        animation: pulse-dot 1.5s ease-in-out infinite;
    }

    @keyframes pulse-dot {

        0%,
        100% {
            opacity: 0.3;
        }

        50% {
            opacity: 1;
        }
    }

    /* Send Button States */
    .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .send-btn:disabled:hover {
        background: var(--primary-color);
        transform: none;
    }

    /* Smooth Message Transitions */
    .message,
    .system-message {
        transition: opacity 0.3s ease-in;
    }

    /* Modal Large */
    .modal-content.modal-lg {
        max-width: 900px;
        width: 90vw;
    }

    /* Action Button Styles */
    .action-btn {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
    }

    .action-btn:hover {
        border-color: var(--primary-color);
        background: var(--background-light);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .action-btn-title {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .action-btn-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
    }


    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>



<style>
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .workflow-history-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .workflow-history-timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }

    .workflow-history-item {
        position: relative;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--background-light);
        border-radius: 8px;
        border-left: 3px solid transparent;
    }

    .workflow-history-item.approved {
        border-left-color: var(--success-color);
    }

    .workflow-history-item.rejected {
        border-left-color: var(--danger-color);
    }

    .workflow-history-item::before {
        content: '';
        position: absolute;
        left: -2.5rem;
        top: 1.25rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: white;
        border: 2px solid var(--border-color);
    }

    .workflow-history-item.approved::before {
        background: var(--success-color);
        border-color: var(--success-color);
    }

    .workflow-history-item.rejected::before {
        background: var(--danger-color);
        border-color: var(--danger-color);
    }

    .workflow-history-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .workflow-history-user {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .workflow-history-avatar {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .workflow-history-user-info {
        display: flex;
        flex-direction: column;
    }

    .workflow-history-user-name {
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.95rem;
    }

    .workflow-history-user-role {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .workflow-history-timestamp {
        font-size: 0.8rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .workflow-history-action {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .workflow-history-action.approved {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }

    .workflow-history-action.rejected {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .workflow-history-comment {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .workflow-history-step {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary-color);
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 500;
        margin-top: 0.5rem;
    }

    .workflow-history-empty {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-muted);
    }

    .workflow-history-empty i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Maximized state for editor-main */
    .editor-main.maximized {
        position: fixed;
        top: var(--header-height, 60px);
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        border-radius: 0;
        margin: 0;
        width: 100%;
        height: calc(100vh - var(--header-height, 60px));
    }
</style>



<style>
    /* AI Generation Banner - Simple sticky notification */
    #aiGenerationBanner {
        /* position: fixed; */
        top: 60px;
        /* Below the top navbar */
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 20px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        z-index: 999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        display: none;
        /* Hidden by default */
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    #aiGenerationBanner.active {
        display: flex;
    }

    #aiGenerationBanner .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: aiBannerSpin 1s linear infinite;
    }

    @keyframes aiBannerSpin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }


    /* Regenerate Modal Styles */
    #regenerateContractModal .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    #regenerateContractModal .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    #regenerateContractModal .modal-content {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 10001;
    }

    #regenerateContractModal .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
    }

    #regenerateContractModal .modal-header h3 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #2762CB;
    }

    #regenerateContractModal .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        transition: color 0.2s;
    }

    #regenerateContractModal .modal-close:hover {
        color: #000;
    }

    #regenerateContractModal .modal-body {
        padding: 1.5rem;
    }

    #regenerateContractModal .modal-footer {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        padding: 1.5rem;
        border-top: 1px solid #dee2e6;
    }

    #regenerateContractModal .alert-info {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        gap: 0.75rem;
        color: #1565c0;
    }

    #regenerateContractModal .alert-info i {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    /* Form styling */
    #regenerateContractModal .form-group {
        margin-bottom: 0;
    }

    #regenerateContractModal .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
        font-size: 0.875rem;
    }

    #regenerateContractModal .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    #regenerateContractModal .form-control:focus {
        outline: none;
        border-color: #2762CB;
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    #regenerateContractModal textarea.form-control {
        resize: vertical;
        font-family: inherit;
    }

    /* Buttons */
    #regenerateContractModal .btn {
        padding: 0.5rem 1.25rem;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    #regenerateContractModal .btn-secondary {
        background: #6c757d;
        color: white;
    }

    #regenerateContractModal .btn-secondary:hover {
        background: #5a6268;
    }

    #regenerateContractModal .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    #regenerateContractModal .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    #regenerateContractModal .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>



<style>
    /* Drag and drop hover effect */
    #uploadZoneDoc:hover {
        border-color: var(--primary-color);
        background: var(--primary-bg);
    }

    #uploadZoneDoc.dragging {
        border-color: var(--primary-color);
        background: var(--primary-bg);
        transform: scale(1.02);
    }

    /* File item styling */
    .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
    }

    .file-item:hover {
        background: var(--secondary-bg);
    }

    .file-item:last-child {
        border-bottom: none;
    }

    .file-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 1.5rem;
        margin-right: 1rem;
    }

    .file-info {
        flex: 1;
    }

    .file-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--text-color);
    }

    .file-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .file-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Document type badges */
    .doc-type-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .doc-type-exhibit {
        background: #e3f2fd;
        color: #1976d2;
    }

    .doc-type-amendment {
        background: #fff3e0;
        color: #f57c00;
    }

    .doc-type-certificate {
        background: #e8f5e9;
        color: #388e3c;
    }

    .doc-type-draft {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .doc-type-other {
        background: #f5f5f5;
        color: #616161;
    }
</style>




<style>
    .track-change-delete {
        text-decoration: line-through !important;
        text-decoration-color: #dc3545 !important;
        text-decoration-thickness: 2px !important;
        background: rgba(220, 53, 69, 0.15) !important;
        color: #dc3545 !important;
        padding: 2px 4px !important;
        border-radius: 3px !important;
        cursor: pointer !important;
    }

    .track-change-insert {
        background: rgba(40, 167, 69, 0.15) !important;
        border-bottom: 2px solid #28a745 !important;
        color: #155724 !important;
        padding: 2px 4px !important;
        border-radius: 3px !important;
        cursor: pointer !important;
    }

    .track-change-delete:hover,
    .track-change-insert:hover {
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    #trackChangesBtn.active {
        background: var(--primary-color) !important;
        color: white !important;
    }
</style>


<style>
    .modal-body label[style*="cursor"] {
        display: flex;
        align-items: center;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .modal-body label[style*="cursor"]:hover {
        border-color: #0066cc;
        background: #f8f9fa;
    }

    .modal-body label input[type="radio"]:checked+i {
        transform: scale(1.2);
    }

    .modal-body label:has(input[type="radio"]:checked) {
        border-color: #0066cc;
        background: rgba(0, 102, 204, 0.05);
    }
</style>


{% endblock %}

{% block content %}
<!-- Loading Overlay - Show by default -->
<div class="loading-overlay show" id="loadingOverlay">
    <div class="logo-container">
        <div class="logo-row">
            <img src="/static/img/logo/contriq-icon.png" alt="Contriq" class="loading-logo">
        </div>
        <div class="text-row">
            <div class="loading-text">Loading Contract...</div>
        </div>
    </div>
</div>

<!-- Contract Editor - Hidden until data loads -->
<div id="contractEditor"></div>


<!-- UPDATED BLOCKCHAIN SECTION WITH CSS CLASSES -->
<div class="card blockchain-card mb-3">
    <div class="blockchain-header">
        <h5>
            <i data-lucide="shield" class="blockchain-icon-shield"></i>
            Blockchain Verification
        </h5>
    </div>
    <div class="card-body blockchain-body">
        <!-- Verification Status -->
        <div id="blockchain-indicator" class="mb-3" data-contract-id="">
            <div class="blockchain-verifying">
                <div class="blockchain-spinner"></div>
                <span>Verifying document integrity on blockchain...</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="blockchain-buttons">
            <button type="button" class="blockchain-btn blockchain-btn-primary" onclick="showBlockchainCertificate()">
                <i data-lucide="award"></i>
                View Certificate
            </button>
            <button type="button" class="blockchain-btn blockchain-btn-outline" onclick="verifyContractNow()">
                <i data-lucide="refresh-cw"></i>
                Re-verify
            </button>
            <button type="button" class="blockchain-btn blockchain-btn-secondary" onclick="showBlockchainInfo()">
                <i data-lucide="info"></i>
                What is this?
            </button>
            <button id="openBlockchainMonitorBtn" onclick="openBlockchainOperations()"
                class="blockchain-btn blockchain-btn-info">
                <i class="ti ti-cube-3d-sphere"></i>
                View Blockchain Operations
            </button>


        </div>

        <!-- Info Text -->
        <div class="blockchain-info-text">
            <small>
                <i data-lucide="lock"></i>
                This contract is secured on Hyperledger Fabric blockchain for tamper-proof verification.
            </small>
        </div>
    </div>
</div>
<!-- END BLOCKCHAIN VERIFICATION SECTION -->


{% include 'modals/blockchain/MOD_073_blockchain_operations.html' %}

<!-- MOD-027/028: Contract Workflow Setup Modal -->
<div class="modal" id="contractWorkflowModal">
    <div class="modal-content modal-lg" style="max-width: 900px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-git-branch" style="font-size: 24px;"></i>
                Workflow Setup for This Contract
            </h3>
            <button class="modal-close" onclick="closeModal('contractWorkflowModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 2rem;">
            <!-- <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Setup a custom workflow for this specific contract:
            </p> -->

            <!-- Option 1: Use Master Workflow -->
            <!-- <div class="workflow-option-card" id="masterWorkflowOption" onclick="selectContractWorkflow('master')">
                <div style="display: flex; gap: 1rem;">
                    <div
                        style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        <i class="ti ti-settings-automation" style="font-size: 24px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--text-color);">Use Master Workflow</h4>
                        <p style="margin: 0 0 1rem 0; color: var(--text-muted); font-size: 0.875rem;">
                            Apply the default company workflow configured by your administrator
                        </p>

                        <div class="workflow-step-preview"
                            style="background: var(--background-light); padding: 1rem; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                                <span
                                    style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">1</span>
                                <span>Legal Review</span>
                                <i class="ti ti-arrow-right" style="color: var(--text-muted);"></i>
                                <span
                                    style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">2</span>
                                <span>Finance Approval</span>
                                <i class="ti ti-arrow-right" style="color: var(--text-muted);"></i>
                                <span
                                    style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">3</span>
                                <span>Executive Sign-off</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div> -->

            <!-- Option 2: Custom Workflow -->
            <!-- <div class="workflow-option-card selected" id="customWorkflowOption">
                <div style="display: flex; gap: 1rem;">
                    <div
                        style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        <i class="ti ti-adjustments-horizontal" style="font-size: 24px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--text-color);">Setup Custom Workflow</h4>
                        <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">
                            Create a bespoke workflow for this specific contract
                        </p>
                    </div>
                </div>
            </div> -->

            <!-- Custom Workflow Configuration -->
            <div id="customWorkflowConfig" style="display: block;">
                <h4 style="margin-bottom: 1rem;">Configure Workflow Steps</h4>

                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--background-light);">
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">Step</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">Role</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">User</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">Department</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="contractWorkflowSteps">
                        <!-- Workflow steps will be added here dynamically -->
                    </tbody>
                </table>

                <button onclick="addContractWorkflowStep()"
                    style="width: 100%; margin-top: 1rem; padding: 0.75rem; border: 2px dashed var(--border-color); background: transparent; color: var(--primary-color); border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">
                    <i class="ti ti-plus"></i> Add Workflow Step
                </button>
            </div>

        </div>
        <div class="modal-footer"
            style="border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-outline-secondary" onclick="closeModal('contractWorkflowModal')">
                Close
            </button>
            <button class="btn btn-primary" onclick="saveContractWorkflow()" id="saveWorkflowBtn" disabled>
                <i class="ti ti-device-floppy"></i>
                Save & Exit
            </button>
        </div>
    </div>
</div>

<!-- MOD-029: Send for Internal Review Modal - Enhanced -->
<div class="modal" id="internalReviewModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Send for Internal Review</h3>
            <button class="modal-close" onclick="closeModal('internalReviewModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">

            <div style="margin-bottom: 2rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    SEND TO SPECIFIC PERSONNEL:
                </label>

                <div style="position: relative;">
                    <input type="text" id="specificPersonnelSearch"
                        placeholder="Type to search users by name or email..." autocomplete="off"
                        style="width: 100%; padding: 0.75rem; padding-right: 2.5rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;">
                    <i class="ti ti-search"
                        style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                </div>

                <div id="userDropdownResults"
                    style="display: none; position: absolute; z-index: 1000; width: calc(100% - 3rem); max-height: 200px; overflow-y: auto; background: white; border: 2px solid var(--border-color); border-radius: 8px; margin-top: 0.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                </div>

                <div id="selectedUserDisplay"
                    style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: var(--background-light); border-radius: 6px; font-size: 0.875rem;">
                    <span id="selectedUserName"></span>
                    <button onclick="clearSelectedUser()"
                        style="float: right; background: none; border: none; color: var(--text-muted); cursor: pointer;">
                        <i class="ti ti-x"></i>
                    </button>
                </div>

                <input type="hidden" id="specificPersonnel">
            </div>

            <div style="text-align: center; margin: 2rem 0; position: relative;">
                <div
                    style="border-top: 1px solid var(--border-color); position: absolute; top: 50%; left: 0; right: 0;">
                </div>
                <span
                    style="background: white; padding: 0 1rem; position: relative; color: var(--text-muted); font-weight: 500; font-size: 1rem;">OR</span>
            </div>

            <!-- Master Workflow Option -->
            <div style="margin-bottom: 1.5rem;" id="masterWorkflowContainer">
                <label
                    style="display: flex; align-items: center; cursor: pointer; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease;"
                    id="masterWorkflowLabel"
                    onmouseover="if(!this.classList.contains('disabled')) { this.style.borderColor='var(--primary-color)'; this.style.background='var(--background-light)'; }"
                    onmouseout="if(!this.classList.contains('disabled')) { this.style.borderColor='var(--border-color)'; this.style.background='white'; }">
                    <input type="radio" name="reviewOption" id="masterWorkflow" value="masterWorkflow"
                        style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <span
                            style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); text-decoration: underline;">
                            USE MASTER WORKFLOW
                        </span>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);"
                            id="masterWorkflowDesc">
                            Automatically send to predefined reviewers in sequence
                        </p>
                    </div>
                    <button type="button" id="masterWorkflowSetupBtn"
                        style="display: none; margin-left: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer;"
                        onclick="event.preventDefault(); event.stopPropagation(); redirectToMasterWorkflowSetup();">
                        Setup Master Workflow
                    </button>
                </label>
            </div>

            <!-- Custom Workflow Option -->
            <div style="margin-bottom: 1.5rem;" id="customWorkflowContainer">
                <label
                    style="display: flex; align-items: center; cursor: pointer; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease;"
                    id="customWorkflowLabel"
                    onmouseover="if(!this.classList.contains('disabled')) { this.style.borderColor='var(--primary-color)'; this.style.background='var(--background-light)'; }"
                    onmouseout="if(!this.classList.contains('disabled')) { this.style.borderColor='var(--border-color)'; this.style.background='white'; }">
                    <input type="radio" name="reviewOption" id="customWorkflow" value="customWorkflow"
                        style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <span
                            style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); text-decoration: underline;">
                            USE CUSTOM WORKFLOW
                        </span>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);"
                            id="customWorkflowDesc">
                            Use workflow specific to this contract
                        </p>
                    </div>
                    <!-- <button type="button" id="customWorkflowSetupBtn"
                        style="display: none; margin-left: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer;"
                        onclick="event.preventDefault(); event.stopPropagation(); openCustomWorkflowSetup();">
                        Setup Custom Workflow
                    </button> -->
                </label>
            </div>

            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <label style="font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Additional
                    Notes (Optional):</label>
                <textarea id="reviewNotes" placeholder="Add any notes for the reviewers..."
                    style="width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.875rem; resize: vertical;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('internalReviewModal')">
                Close
            </button>
            <button class="btn btn-primary" onclick="submitInternalReview()">
                Submit
            </button>
        </div>
    </div>
</div>



<!-- MOD-029: Send for Internal Approval Modal -->
<div class="modal" id="internalApprovalModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Send for Approval</h3>
            <button class="modal-close" onclick="closeModal('internalApprovalModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 2rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    SEND TO SPECIFIC PERSONNEL:
                </label>
                <input type="text" id="specificPersonnel" placeholder="Enter email addresses (comma separated)"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;">
            </div>

            <div style="text-align: center; margin: 2rem 0; position: relative;">
                <div
                    style="border-top: 1px solid var(--border-color); position: absolute; top: 50%; left: 0; right: 0;">
                </div>
                <span
                    style="background: white; padding: 0 1rem; position: relative; color: var(--text-muted); font-weight: 500; font-size: 1rem;">OR</span>
            </div>


            <!-- Master Workflow Option -->
            <div style="margin-bottom: 1.5rem;" id="masterWorkflowContainerApproval">
                <label
                    style="display: flex; align-items: center; cursor: pointer; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease;"
                    id="masterWorkflowLabelApproval"
                    onmouseover="if(!this.classList.contains('disabled')) { this.style.borderColor='var(--primary-color)'; this.style.background='var(--background-light)'; }"
                    onmouseout="if(!this.classList.contains('disabled')) { this.style.borderColor='var(--border-color)'; this.style.background='white'; }">
                    <input type="radio" name="reviewOption" id="masterWorkflowApproval" value="masterWorkflow"
                        style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <span
                            style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); text-decoration: underline;">
                            USE MASTER WORKFLOW
                        </span>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);"
                            id="masterWorkflowDesc">
                            Automatically send to predefined reviewers in sequence
                        </p>
                    </div>
                    <button type="button" id="masterWorkflowSetupBtnApproval"
                        style="display: none; margin-left: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer;"
                        onclick="event.preventDefault(); event.stopPropagation(); redirectToMasterWorkflowSetup();">
                        Setup Master Workflow
                    </button>
                </label>
            </div>



            <!-- <div style="margin-bottom: 1.5rem;">
                <label
                    style="display: flex; align-items: center; cursor: pointer; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--background-light)'"
                    onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='white'">
                    <input type="radio" name="reviewOption" id="masterWorkflow" value="masterWorkflow"
                        style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <span
                            style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); text-decoration: underline;">
                            USE MASTER WORKFLOW
                        </span>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
                            Automatically send to predefined approvers in sequence
                        </p>
                    </div>
                </label>
            </div> -->


            <!-- Custom Workflow Option -->
            <div style="margin-bottom: 1.5rem;" id="customWorkflowContainerApproval">
                <label
                    style="display: flex; align-items: center; cursor: pointer; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease;"
                    id="customWorkflowLabelApproval"
                    onmouseover="if(!this.classList.contains('disabled')) { this.style.borderColor='var(--primary-color)'; this.style.background='var(--background-light)'; }"
                    onmouseout="if(!this.classList.contains('disabled')) { this.style.borderColor='var(--border-color)'; this.style.background='white'; }">
                    <input type="radio" name="reviewOption" id="customWorkflowApproval" value="customWorkflow"
                        style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <span
                            style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); text-decoration: underline;">
                            USE CUSTOM WORKFLOW
                        </span>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);"
                            id="customWorkflowDescApproval">
                            Use workflow specific to this contract
                        </p>
                    </div>
                    <!-- <button type="button" id="customWorkflowSetupBtn"
                        style="display: none; margin-left: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer;"
                        onclick="event.preventDefault(); event.stopPropagation(); openCustomWorkflowSetup();">
                        Setup Custom Workflow
                    </button> -->
                </label>
            </div>



            <!-- <div style="margin-bottom: 1.5rem;">
                <label
                    style="display: flex; align-items: center; cursor: pointer; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--background-light)'"
                    onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='white'">
                    <input type="radio" name="reviewOption" id="customWorkflow" value="customWorkflow"
                        style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <span
                            style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); text-decoration: underline;">
                            USE CUSTOM WORKFLOW
                        </span>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
                            Automatically send to predefined approvers in sequence
                        </p>
                    </div>


                </label>
            </div> -->

            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <label style="font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Additional
                    Notes (Optional):</label>
                <textarea id="reviewNotes" placeholder="Add any notes for the reviewers..."
                    style="width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.875rem; resize: vertical;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('internalApprovalModal')">
                Close
            </button>
            <button class="btn btn-primary" onclick="submitInternalApproval()">
                Submit
            </button>
        </div>
    </div>
</div>


<!-- MOD-029: Send for Signature Modal - Enhanced -->
<div class="modal" id="sendForSignatureModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Send for Signature</h3>
            <button class="modal-close" onclick="closeModal('sendForSignatureModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">



            <div style="margin-bottom: 1.5rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    Company e-Signee Email: <span style="color: var(--danger-color);">*</span>
                </label>
                <div style="position: relative;">
                    <input type="email" id="companyEmail" placeholder="Search or enter e-signee email address"
                        style="width: 100%; padding: 0.75rem; padding-right: 2.5rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;"
                        autocomplete="off" oninput="searchCompanyUsers(this.value)"
                        onfocus="searchCompanyUsers(this.value)" required>
                    <i class="ti ti-search"
                        style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;"></i>

                    <!-- Email Suggestions Dropdown -->
                    <div id="companyEmailSuggestions"
                        style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
            </div>


            <div style="margin-bottom: 1.5rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    Counter-Party e-Signee Email: <span style="color: var(--danger-color);">*</span>
                </label>
                <div style="position: relative;">
                    <input type="email" id="counterPartySignatureEmail"
                        placeholder="Search or enter counter-party email address"
                        style="width: 100%; padding: 0.75rem; padding-right: 2.5rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;"
                        autocomplete="off" oninput="searchCounterPartySignatureUsers(this.value)"
                        onfocus="searchCounterPartySignatureUsers(this.value)" required>
                    <i class="ti ti-search"
                        style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;"></i>

                    <!-- Email Suggestions Dropdown -->
                    <div id="counterPartyEmailSignatureSuggestions"
                        style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
                <small style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    The e-Signees will receive an email notification with access to sign and execute this
                    contract.
                </small>
            </div>

        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('sendForSignatureModal')">
                Close
            </button>
            <button class="btn btn-primary" onclick="submitSignatureWorkflow()">
                Send for Signature
            </button>
        </div>
    </div>
</div>





<!-- =====================================================
     LIVE NEGOTIATION CHAT MODAL
     ===================================================== -->
<div class="modal" id="liveNegotiationModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-video"></i>
                Live Negotiation Session
            </h3>
            <button class="modal-close" onclick="closeModal('liveNegotiationModal'); stopMessagePolling();">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div class="negotiation-container">
                <!-- Status Bar -->
                <div class="negotiation-status">
                    <div class="participants">
                        <!-- Participants will be loaded dynamically -->
                    </div>

                </div>

                <!-- Messages Area -->
                <div class="messages-area" id="chatMessages">
                    <!-- Messages will be loaded dynamically -->
                </div>


            </div>
        </div>
        <div class="modal-footer" style="display: flex; flex-direction: column; gap: 1rem; padding: 1.5rem;">
            <!-- Row 1: Input Area and Suggestions -->
            <div style="display: flex; gap: 1rem; align-items: flex-start;">
                <!-- Input Area -->
                <div class="input-area" style="flex: 1; display: flex; gap: 0.5rem;">
                    <textarea id="messageInput" placeholder="Type your message here..."
                        onkeypress="handleMessageKeyPress(event)"
                        style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; resize: none; min-height: 60px; font-family: inherit; font-size: 0.9rem;"></textarea>
                    <button class="send-btn" onclick="sendMessage()" style="align-self: flex-end;">
                        <i class="ti ti-send"></i>
                    </button>
                </div>


            </div>

            <!-- Quick Suggestions -->
            <div class="suggestions">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="suggestion-btn" onclick="insertSuggestion('I agree with the proposed terms.')">
                        I agree
                    </button>
                    <button class="suggestion-btn" onclick="insertSuggestion('Can we modify the payment schedule?')">
                        Modify payment
                    </button>
                    <button class="suggestion-btn" onclick="insertSuggestion('What about liability limits?')">
                        Liability limits
                    </button>
                    <button class="suggestion-btn" onclick="insertSuggestion('Let me consult with my team.')">
                        Consult team
                    </button>
                </div>
            </div>

            <!-- Row 2: Action Buttons -->
            <div
                style="display: flex; gap: 1rem; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <div class="session-actions">
                    <button class="session-btn" onclick="downloadMinutes()">
                        <i class="ti ti-download"></i>
                        Download Minutes
                    </button>
                </div>

                <button class="btn btn-outline-secondary"
                    onclick="closeModal('liveNegotiationModal'); stopMessagePolling();">
                    <i class="ti ti-x"></i>
                    End Session
                </button>


            </div>
        </div>
    </div>
</div>

<!-- Documents Modal -->
<div class="modal" id="documentsModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-paperclip"></i>
                Attach Supporting Documents
            </h3>
            <button class="modal-close" onclick="closeModal('documentsModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">

            <!-- Upload Section -->
            <div style="margin-bottom: 2rem;">
                <h5 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-upload" style="color: var(--primary-color);"></i>
                    Upload New Documents
                </h5>

                <!-- Document Type Selection -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Document Type <span style="color: var(--danger-color);">*</span>
                    </label>
                    <select class="filter-select" id="documentTypeSelect" style="width: 100%;">
                        <option value="exhibit">Exhibit / Attachment</option>
                        <option value="annex">Annex</option>
                        <option value="amendment">Amendment</option>
                        <option value="certificate">Certificate</option>
                        <option value="draft">Draft Version</option>
                        <option value="supporting_doc">Supporting Document</option>
                        <option value="technical_spec">Technical Specification</option>
                        <option value="financial_doc">Financial Document</option>
                        <option value="legal_opinion">Legal Opinion</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Notes/Purpose Field -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        Notes / Purpose (Optional)
                    </label>
                    <textarea id="documentNotes" class="search-input" placeholder="Add notes about this document..."
                        style="width: 100%; min-height: 60px; padding: 0.5rem; resize: vertical;"></textarea>
                </div>

                <!-- File Upload Zone -->
                <div id="uploadZoneDoc" onclick="document.getElementById('fileUploadDoc').click()"
                    style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; background: var(--secondary-bg); transition: all 0.3s;">
                    <i class="ti ti-cloud-upload"
                        style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                    <p style="margin: 0 0 0.5rem 0; font-weight: 600;">Drop files here or click to browse</p>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">
                        Supports: PDF, DOC, DOCX, XLS, XLSX, PPT, JPG, PNG, ZIP and more (Max 50MB each)
                    </p>
                    <input type="file" id="fileUploadDoc" multiple
                        accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf,.odt,.jpg,.jpeg,.png,.gif,.tiff,.zip,.msg,.eml"
                        style="display: none;" onchange="handleDocumentFileSelect(event)">
                </div>

                <!-- Selected Files Preview -->
                <div id="selectedFilesPreview" style="margin-top: 1rem; display: none;">
                    <h6 style="margin-bottom: 0.5rem; font-weight: 600;">Selected Files:</h6>
                    <div id="selectedFilesList" style="max-height: 150px; overflow-y: auto;">
                        <!-- Files will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Existing Documents Section -->
            <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                <h5 style="margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;">
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="ti ti-files" style="color: var(--primary-color);"></i>
                        Previously Attached Documents
                    </span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshDocumentsList()"
                        title="Refresh list">
                        <i class="ti ti-refresh"></i>
                    </button>
                </h5>

                <!-- Loading State -->
                <div id="documentsLoading" style="text-align: center; padding: 2rem; display: none;">
                    <i class="ti ti-loader" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                    <p style="margin-top: 1rem; color: var(--text-muted);">Loading documents...</p>
                </div>

                <!-- No Documents State -->
                <div id="noDocumentsMessage"
                    style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
                    <i class="ti ti-folder-open" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <p>No documents attached yet</p>
                </div>

                <!-- Documents List -->
                <div id="attachedDocumentsList"
                    style="border: 1px solid var(--border-color); border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <!-- Documents will be loaded here -->
                </div>
            </div>
        </div>

        <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 0.875rem; color: var(--text-muted);">
                <i class="ti ti-info-circle"></i>
                <span id="uploadStatusText">Select files to upload</span>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-outline-secondary" onclick="closeDocumentsModal()">
                    <i class="ti ti-x"></i>
                    Close
                </button>
                <button class="btn btn-primary" onclick="uploadContractDocuments()" id="uploadDocBtn" disabled>
                    <i class="ti ti-upload"></i>
                    Upload Documents
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Risk Summary Modal -->
<div class="modal" id="riskSummaryModal">
    <div class="modal-content modal-lg">
        <div class="modal-header" style="background: linear-gradient(135deg, var(--warning-color), #ffc107);">
            <h3 class="modal-title" style="color: white;">
                <i class="ti ti-alert-triangle"></i>
                AI Risk Analysis Report
            </h3>
            <button class="modal-close" onclick="closeModal('riskSummaryModal')"
                style="background: rgba(255,255,255,0.2); color: white;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" id="riskSummaryContent">
            <!-- Content injected by JavaScript -->
        </div>
    </div>
</div>

<!-- Version History Modal -->
<div class="modal" id="versionModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">Version History</h3>
            <button class="modal-close" onclick="closeModal('versionModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" id="versionHistoryContent">
            <!-- Will be populated dynamically -->
        </div>
        <div class="modal-footer">
            <!-- <button class="btn btn-outline-secondary" onclick="compareVersions()">Compare Versions</button> -->
            <button class="btn btn-primary" onclick="closeModal('versionModal')">Close</button>
        </div>
    </div>
</div>


<!-- Regenerate Contract Modal -->
<div id="regenerateContractModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeRegenerateModal()"></div>
    <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 class="modal-title" style="color:white">
                <i class="ti ti-refresh"></i> Regenerate Contract
            </h3>
            <button class="modal-close" onclick="closeRegenerateModal()">
                <i class="ti ti-x"></i>
            </button>
        </div>

        <div class="modal-body">
            <!-- Three Fields in One Row -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <!-- Contract Type -->
                <div>
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; font-size: 0.875rem;">
                        Contract Type <span style="color: var(--danger-color);">*</span>
                    </label>
                    <select id="regenContractType" class="form-control" required
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px;">
                        <option value="">Select Contract Type</option>
                        <option value="construction">Construction Contract</option>
                        <option value="service">Service Agreement</option>
                        <option value="supply">Supply Agreement</option>
                        <option value="consultancy">Consultancy Agreement</option>
                        <option value="nda">Non-Disclosure Agreement</option>
                        <option value="mou">Memorandum of Understanding</option>
                        <option value="loi">Letter of Intent</option>
                        <option value="purchase_order">Purchase Order</option>
                        <option value="subcontract">Subcontract Agreement</option>
                    </select>
                </div>

                <!-- Profile Type -->
                <div>
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; font-size: 0.875rem;">
                        Profile Type <span style="color: var(--danger-color);">*</span>
                    </label>
                    <select id="regenProfileType" class="form-control" required
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px;">
                        <option value="">Select Profile Type</option>
                        <option value="client">Client</option>
                        <option value="consultant">Consultant</option>
                        <option value="contractor">Contractor</option>
                        <option value="subcontractor">Sub-Contractor</option>
                    </select>
                </div>

                <!-- Jurisdiction -->
                <div>
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; font-size: 0.875rem;">
                        Jurisdiction <span style="color: var(--danger-color);">*</span>
                    </label>
                    <select id="regenJurisdiction" class="form-control" required
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px;">
                        <option value="">Select Jurisdiction</option>
                        <option value="Qatar" selected>Qatar</option>
                        <option value="UAE">United Arab Emirates (UAE)</option>
                        <option value="Saudi Arabia">Saudi Arabia</option>
                        <option value="Kuwait">Kuwait</option>
                        <option value="Bahrain">Bahrain</option>
                        <option value="Oman">Oman</option>
                        <option value="UK">United Kingdom</option>
                        <option value="USA">United States</option>
                        <option value="International">International Arbitration</option>
                    </select>
                </div>

                <div class="ai-question-item">
                    <label>
                        Contract Language <span style="color: var(--danger-color);">*</span>
                    </label>
                    <select id="regenLanguage" class="form-control">
                        <option value="en" selected>English</option>
                        <option value="ar">Arabic ()</option>
                        <option value="mirror">Mirror</option>
                    </select>
                </div>
            </div>


            <!-- Add/Remove Clauses Section -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <label style="font-weight: 600; margin: 0;">Contract Clauses</label>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleClauseSection()">
                        <i class="ti ti-list-check"></i>
                        <span id="clauseToggleText">Show Clause Selection</span>
                    </button>
                </div>

                <!-- Clause Selection Section (Hidden by default) -->
                <div id="regenClauseSection"
                    style="display: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; background: var(--background-light);">

                    <!-- Essential Clauses -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4
                            style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                            Essential Clauses
                        </h4>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem;">
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_performance_bond" checked>
                                <span>Performance Bond</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_retention_amount" checked>
                                <span>Retention Amount</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_payment_terms" checked>
                                <span>Payment Terms</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_timeline" checked>
                                <span>Timeline & Milestones</span>
                            </label>
                        </div>
                    </div>

                    <!-- Legal & Compliance -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4
                            style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                            Legal & Compliance
                        </h4>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem;">
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_back_to_back" checked>
                                <span>Back-to-Back Terms</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_intellectual_property" checked>
                                <span>Intellectual Property</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_non_compete">
                                <span>Non-Compete</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_data_protection">
                                <span>Data Protection (GDPR)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Risk Management -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4
                            style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                            Risk Management
                        </h4>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem;">
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_insurance" checked>
                                <span>Insurance Requirements</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_liability">
                                <span>Liability Limitation</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_indemnification">
                                <span>Indemnification</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_force_majeure">
                                <span>Force Majeure</span>
                            </label>
                        </div>
                    </div>

                    <!-- Contract Management -->
                    <div style="margin-bottom: 0;">
                        <h4
                            style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                            Contract Management
                        </h4>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem;">
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_termination" checked>
                                <span>Termination Conditions</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_arbitration" checked>
                                <span>Arbitration Clause</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_mediation">
                                <span>Mediation Clause</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_liquidated_damages">
                                <span>Liquidated Damages</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_kpi">
                                <span>Key Performance Indicators</span>
                            </label>
                            <label class="clause-item">
                                <input type="checkbox" name="regen_clause_governing_law">
                                <span>Governing Law</span>
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info" style="margin-top: 1rem; margin-bottom: 0;">
                        <i class="ti ti-info-circle"></i>
                        <span style="font-size: 0.875rem;">
                            Selected clauses will be included in the regenerated contract.
                            Uncheck any clause you don't want to include.
                        </span>
                    </div>
                </div>
            </div>

            <!-- Additional Requirements -->
            <div style="margin-bottom: 1.5rem;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                    Additional Requirements / Modifications
                </label>
                <textarea id="regenAdditionalRequirements" class="form-control"
                    placeholder="Enter any specific requirements, modifications, or special clauses..."
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; min-height: 100px; resize: vertical;"></textarea>
                <small style="color: var(--text-muted); font-size: 0.875rem;">
                    Example: "Include a clause about remote work conditions" or "Modify payment terms to 45 days"
                </small>
            </div>

            <!-- Payment Terms (Optional) -->
            <div style="margin-bottom: 1.5rem;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                    Payment Terms <span style="color: var(--text-muted); font-weight: 400;">(Optional)</span>
                </label>
                <input type="text" id="regenPaymentTerms" class="form-control"
                    placeholder="e.g., 30 days net, milestone-based, monthly"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px;">
            </div>

            <!-- Duration (Optional) -->
            <div style="margin-bottom: 0;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                    Contract Duration <span style="color: var(--text-muted); font-weight: 400;">(Optional)</span>
                </label>
                <input type="text" id="regenDuration" class="form-control" placeholder="e.g., 6 months, 1 year, 2 years"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px;">
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeRegenerateModal()">
                <i class="ti ti-x"></i> Cancel
            </button>
            <button class="btn btn-primary" onclick="submitRegeneration()">
                <i class="ti ti-refresh"></i> Regenerate Contract
            </button>
        </div>
    </div>
</div>

<!-- =====================================================
     IMPROVED EXPORT MODAL
     Replace the existing Export Modal in your HTML
     ===================================================== -->

<!-- Export Modal -->
<div class="modal" id="exportModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem; margin: 0;">
                <i class="ti ti-download" style="font-size: 24px;"></i>
                Export Document
            </h3>
            <button class="modal-close" onclick="closeModal('exportModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;">
                <i class="ti ti-x"></i>
            </button>
        </div>

        <div class="modal-body" style="padding: 2rem;">
            <p style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.95rem;">
                Select the format and options for exporting your contract document.
            </p>

            <!-- Export Format Selection -->
            <div style="margin-bottom: 2rem;">
                <label
                    style="display: block; font-weight: 600; font-size: 0.95rem; color: var(--text-color); margin-bottom: 1rem;">
                    Export Format:
                </label>
                <div style="display: grid; gap: 0.875rem;">
                    <!-- PDF Option -->
                    <label class="export-option-label"
                        style="display: flex; align-items: center; padding: 1rem; background: var(--background-light); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="exportFormat" value="pdf" checked
                            style="margin-right: 1rem; width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color);">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <i class="ti ti-file-type-pdf" style="font-size: 2rem; color: #ef4444;"></i>
                            <div>
                                <div style="font-weight: 600; font-size: 0.95rem;">PDF Document</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Professional, print-ready format
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Word Option -->
                    <label class="export-option-label"
                        style="display: flex; align-items: center; padding: 1rem; background: var(--background-light); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="exportFormat" value="word"
                            style="margin-right: 1rem; width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color);">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <i class="ti ti-file-type-docx" style="font-size: 2rem; color: #2563eb;"></i>
                            <div>
                                <div style="font-weight: 600; font-size: 0.95rem;">Microsoft Word</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Editable document (.docx)
                                </div>
                            </div>
                        </div>
                    </label>

                </div>
            </div>


            <!-- Info Box -->
            <div
                style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid var(--primary-color); border-radius: 6px; margin-top: 1.5rem;">
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <i class="ti ti-info-circle"
                        style="color: var(--primary-color); font-size: 1.25rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        The exported document will include the current version of the contract with all selected options
                        applied. Export may take a few seconds.
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end; background: var(--background-light); border-radius: 0 0 12px 12px;">
            <button class="btn btn-outline-secondary" onclick="closeModal('exportModal')"
                style="padding: 0.625rem 1.25rem; border: 1px solid var(--border-color); background: white; color: var(--text-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                <i class="ti ti-x"></i>
                Cancel
            </button>
            <button class="btn btn-primary" onclick="executeExport()"
                style="padding: 0.625rem 1.5rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; font-weight: 600;">
                <i class="ti ti-download"></i>
                Export Document
            </button>
        </div>
    </div>
</div>

<!-- Approval History Modal -->
<div class="modal" id="workflowHistoryModal">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
        <div class="modal-header">
            <div>
                <h3 class="modal-title">
                    <i class="ti ti-history"></i> Approval History & Comments
                </h3>
                <p id="workflowHistoryContractInfo" style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: white;">
                </p>
            </div>
            <button class="modal-close" onclick="closeModal('workflowHistoryModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="workflowHistoryContent">
                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <i class="ti ti-loader" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                    <p>Loading approval history...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('workflowHistoryModal')">
                Close
            </button>
        </div>
    </div>
</div>



<style>
    /* Export Modal Hover Effects */
    .export-option-label:hover {
        background: white !important;
        border-color: var(--primary-color) !important;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }

    .export-option-label:has(input:checked) {
        background: white !important;
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 1px var(--primary-color);
    }

    .checkbox-option-label:hover {
        background: white !important;
        border-color: var(--primary-color) !important;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3) !important;
        transform: rotate(90deg);
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: var(--secondary-color);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-outline-secondary {
        background: white;
        color: var(--text-muted);
        border: 1px solid var(--border-color);
    }

    .btn-outline-secondary:hover {
        background: var(--background-light);
    }

    /* Modern Negotiation Chat Styles - FIXED LAYOUT */
    .negotiation-container {
        height: 600px;
        display: flex;
        flex-direction: column;
        background: #fafafa;
    }

    .negotiation-status {
        background: white;
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }



    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }


    .participants {
        display: flex;
        gap: 2rem;
    }

    .participant {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-color);
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #10b981;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .session-actions {
        display: flex;
        gap: 0.5rem;
    }

    .session-btn {
        padding: 0.5rem 1rem;
        background: #196c28;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: #ffffff;
        transition: all 0.3s ease;
    }

    .session-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: 0;
        /* Important for flex child scrolling */
    }

    .welcome-message {
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .welcome-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 24px;
    }

    .welcome-message h4 {
        margin: 0 0 0.5rem 0;
        color: var(--text-color);
        font-size: 1.125rem;
    }

    .welcome-message p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .message {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        flex-shrink: 0;
    }

    .initiator-msg .message-avatar {
        background: linear-gradient(135deg, #64748b, #94a3b8);
    }

    .user-msg .message-avatar {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }

    .user-msg {
        flex-direction: row-reverse;
    }

    .user-msg .message-content {
        text-align: right;
    }

    .message-content {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .user-msg .message-content {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-color: var(--primary-color);
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
        font-size: 0.75rem;
    }

    .user-msg .message-header {
        color: rgba(255, 255, 255, 0.9);
    }

    .sender {
        font-weight: 600;
        color: var(--text-color);
    }

    .user-msg .sender {
        color: white;
    }

    .timestamp {
        color: var(--text-muted);
        font-size: 0.6875rem;
    }

    .user-msg .timestamp {
        color: rgba(255, 255, 255, 0.7);
    }

    .message-text {
        line-height: 1.4;
        color: var(--text-color);
        font-size: 0.875rem;
    }

    .user-msg .message-text {
        color: white;
    }

    .typing-indicator {
        display: flex;
        gap: 0.75rem;
        animation: slideIn 0.3s ease-out;
    }

    .typing-indicator .message-content {
        background: var(--background-light);
        border-style: dashed;
        color: var(--text-muted);
        font-style: italic;
    }

    .typing-dots {
        display: inline-flex;
        gap: 2px;
    }

    .typing-dots span {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: var(--text-muted);
        animation: typing-bounce 1.5s infinite;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: 0.3s;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0.6s;
    }

    @keyframes typing-bounce {

        0%,
        60%,
        100% {
            transform: translateY(0);
        }

        30% {
            transform: translateY(-8px);
        }
    }

    .message-input-area {
        background: white;
        border-top: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        position: sticky;
        bottom: 0;
        z-index: 10;
    }

    .input-container {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    #messageInput {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        outline: none;
        transition: all 0.3s ease;
    }

    #messageInput:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: var(--primary-color);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 16px;
    }

    .send-btn:hover {
        background: var(--secondary-color);
        transform: translateY(-1px);
    }

    .send-btn:disabled {
        background: var(--border-color);
        cursor: not-allowed;
        transform: none;
    }

    .input-suggestions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .suggestion-btn {
        padding: 0.375rem 0.75rem;
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 0.75rem;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .suggestion-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }


    /* Action Button Styles */
    .action-btn {
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        text-decoration: none;
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(39, 98, 203, 0.15);
    }

    .action-btn-title {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .action-btn-desc {
        font-size: 0.75rem;
        opacity: 0.8;
    }


    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0.25rem;
        display: flex;
        align-items: center;
    }

    .modal-close:hover {
        color: var(--text-color);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-color);
    }

    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9rem;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-outline-secondary {
        background: white;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .btn-outline-secondary:hover {
        background: #f8f9fa;
    }

    [dir="rtl"] {
        font-family: 'Segoe UI', 'Tahoma', 'Arial', sans-serif;
    }


    /* Hide chatbot button on this page */
    .chatbot-button,
    #chatbotButton {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
    }
</style>


<!-- MOD-021: Risk Assessment Modal -->
<div class="modal" id="riskAnalysisModal">
    <div class="modal-content modal-xl risk-modal">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--warning-color), #ffc107); color: white;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-alert-triangle"></i>
                AI Review Analysis Report

            </h3>
            <button class="modal-close" onclick="closeModal('riskAnalysisModal')"
                style="background: rgba(255,255,255,0.2); color: white;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 0; max-height: 70vh; overflow-y: auto;" id="riskAnalysisContent">
            <!-- Loading State -->
            <div id="riskLoadingState" class="text-center" style="padding: 3rem;">
                <div class="loader-container">
                    <div class="ai-loader"></div>
                    <div class="loader-text">
                        <h4 style="margin: 1rem 0 0.5rem; color: var(--text-color);">Analyzing Contract with AI</h4>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">We are reviewing your contract
                            for potential risks...</p>
                    </div>
                </div>
            </div>
            <!-- Results will be injected here -->
        </div>
        <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1rem 1.5rem;">
            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                <div id="analysisTimestamp" style="font-size: 0.75rem; color: var(--text-muted);">
                    <!-- Timestamp will be shown here -->
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-outline-secondary" onclick="exportRiskReport()">
                        <i class="ti ti-download"></i> Export PDF
                    </button>
                    <button class="btn btn-outline-primary" onclick="runRiskAnalysis()">
                        <i class="ti ti-refresh"></i> Re-analyze
                    </button>
                    <!-- <button class="btn btn-primary" onclick="applyRiskMitigation()">
                        <i class="ti ti-shield-check"></i> Apply Mitigations
                    </button> -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MOD-022: Clause Suggestion Modal -->
<div class="modal" id="clauseSuggestionModal">
    <div class="modal-content modal-lg">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-sparkles"></i>
                AI Clause Suggestions
            </h3>
            <button class="modal-close" onclick="closeModal('clauseSuggestionModal')"
                style="background: rgba(255,255,255,0.2); color: white;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 2rem;" id="clauseSuggestionContent">
            <div class="text-center" style="padding: 2rem;">
                <div class="loader" style="margin: 0 auto;"></div>
                <p style="margin-top: 1rem; color: var(--text-muted);">Getting AI suggestions...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('clauseSuggestionModal')">
                Cancel
            </button>
            <!-- <button class="btn btn-warning" onclick="editClauseManually()">
                <i class="ti ti-edit"></i> Edit Manually
            </button> -->
            <!-- <button class="btn btn-success" onclick="acceptSuggestion()">
                <i class="ti ti-check"></i> Accept Suggestion
            </button> -->
        </div>
    </div>
</div>

<!-- Simple Signature Modal -->
<div class="modal" id="signatureModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--success-color), #20c997); color: white;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-writing-sign"></i>
                Sign Document
            </h3>
            <button class="modal-close" onclick="closeModal('signatureModal')"
                style="background: rgba(255,255,255,0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="background: var(--background-light); padding: 1rem; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Signing as:</div>
                        <div style="font-weight: 600;" id="signerName">John Doe</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);" id="signerRole">Client
                            Representative</div>
                    </div>
                    <div id="partyIndicator"
                        style="padding: 0.25rem 0.75rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                        Initiator
                    </div>
                </div>
            </div>

            <div
                style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                <button class="signature-tab active" onclick="switchSignMethod('draw')"
                    style="padding: 0.75rem 1rem; background: none; border: none; color: var(--primary-color); cursor: pointer; border-bottom: 3px solid var(--primary-color); font-weight: 600;">
                    <i class="ti ti-pencil"></i> Draw
                </button>
                <button class="signature-tab" onclick="switchSignMethod('type')"
                    style="padding: 0.75rem 1rem; background: none; border: none; color: var(--text-muted); cursor: pointer;">
                    <i class="ti ti-keyboard"></i> Type
                </button>
            </div>

            <div id="drawSignature">
                <canvas class="signature-canvas" id="signCanvas"></canvas>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearCanvas()">
                        <i class="ti ti-eraser"></i> Clear
                    </button>
                </div>
            </div>

            <div id="typeSignature" style="display: none;">
                <input type="text" id="typedSig" placeholder="Type your name"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-bottom: 1rem;"
                    oninput="updateSignaturePreview()">
                <div class="signature-preview" id="sigPreview"></div>
            </div>

            <div style="margin-top: 0.5rem; padding: 1rem; background: var(--info-bg); border-radius: 8px;">
                <label style="display: flex; align-items: start; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="agreeTerms" style="margin-top: 0.25rem;" onchange="toggleSignButton()">
                    <span style="font-size: 0.875rem;">I agree to sign this document electronically</span>
                </label>
            </div>
        </div>
        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-outline-secondary" onclick="closeModal('signatureModal')">Cancel</button>
            <button class="btn btn-success" id="signBtn" onclick="applySignature()" disabled>
                <i class="ti ti-check"></i> Sign Document
            </button>
        </div>
    </div>
</div>

<!-- Find & Replace Modal -->
<div class="modal" id="findReplaceModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title">Find & Replace</h3>
            <button class="modal-close" onclick="closeModal('findReplaceModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Find:</label>
                <input type="text" id="findText"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Replace with:</label>
                <input type="text" id="replaceText"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
            <div>
                <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="caseSensitive" style="margin-right: 0.5rem;">
                    Case sensitive
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="findNext()">Find Next</button>
            <button class="btn btn-warning" onclick="replaceOne()">Replace</button>
            <button class="btn btn-primary" onclick="replaceAll()">Replace All</button>
        </div>
    </div>
</div>



<!-- MOD-030: Send to Counter-Party Modal -->
<div class="modal" id="sendToCounterPartyModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-send" style="font-size: 24px;"></i>
                Send to Counter-Party
            </h3>
            <button class="modal-close" onclick="closeModal('sendToCounterPartyModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 2rem;">
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Select the counter-party who will receive this contract for review and negotiation.
            </p>

            <div style="margin-bottom: 1.5rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    Counter-Party Email: <span style="color: var(--danger-color);">*</span>
                </label>
                <div style="position: relative;">
                    <input type="email" id="counterPartyEmail" placeholder="Search or enter counter-party email address"
                        style="width: 100%; padding: 0.75rem; padding-right: 2.5rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;"
                        autocomplete="off" oninput="searchCounterPartyUsers(this.value)"
                        onfocus="searchCounterPartyUsers(this.value)" required>
                    <i class="ti ti-search"
                        style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;"></i>

                    <!-- Email Suggestions Dropdown -->
                    <div id="counterPartyEmailSuggestions"
                        style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
                <small style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    The counter-party will receive an email notification with access to review and negotiate this
                    contract.
                </small>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    Additional Message (Optional):
                </label>
                <textarea id="counterPartyMessage" placeholder="Add any notes or instructions for the counter-party..."
                    style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; resize: vertical;"></textarea>
            </div>

            <!-- Info Alert -->
            <div
                style="padding: 1rem; background: var(--info-bg); border-radius: 8px; display: flex; align-items: start; gap: 0.75rem; margin-top: 1.5rem;">
                <i class="ti ti-info-circle" style="color: var(--info-color); font-size: 20px; margin-top: 2px;"></i>
                <div>
                    <strong style="color: var(--info-color);">Note:</strong>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--info-color);">
                        Once sent, the contract status will change to "Negotiation" and the counter-party will be able
                        to review, comment, and negotiate terms.
                    </p>
                </div>
            </div>
        </div>
        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-outline-secondary" onclick="closeModal('sendToCounterPartyModal')">
                Cancel
            </button>
            <button class="btn btn-primary" onclick="submitSendToCounterParty()">
                <i class="ti ti-send"></i>
                Send to Counter-Party
            </button>
        </div>
    </div>
</div>


<!-- Negotiation Options Modal -->
<div class="modal" id="negotiationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-message-circle"></i>
                Negotiation Options
            </h3>
            <button class="modal-close" onclick="closeModal('negotiationModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 2rem; color: var(--text-muted);">
                Choose how you would like to proceed with this contract negotiation:
            </p>

            <div style="display: grid; gap: 1.5rem;">
                <!-- Internal Negotiation Button -->
                <button class="action-btn" onclick="startInternalNegotiation()"
                    style="text-align: left; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--warning-color), #ffc107); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="ti ti-users" style="font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="action-btn-title" style="font-size: 1rem;">Internal Team Negotiation</div>
                            <div class="action-btn-desc">Real-time discussion with workflow participants</div>
                        </div>
                    </div>
                </button>

                <div style="text-align: center; margin: 1rem 0; position: relative;">
                    <div
                        style="border-top: 1px solid var(--border-color); position: absolute; top: 50%; left: 0; right: 0;">
                    </div>
                    <span
                        style="background: white; padding: 0 1rem; position: relative; color: var(--text-muted); font-weight: 500;">OR</span>
                </div>

                <!-- External Negotiation Button -->
                <button class="action-btn" onclick="startExternalNegotiation()"
                    style="text-align: left; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="ti ti-video" style="font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="action-btn-title" style="font-size: 1rem;">Negotiation with
                                Initiator/Counter-Party</div>
                            <div class="action-btn-desc">Real-time discussion with the contract initiator</div>
                        </div>
                    </div>
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('negotiationModal')">
                Close
            </button>
        </div>
    </div>
</div>





<!-- Negotiation Options Modal -->
<div class="modal" id="negotiationConfirmationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-message-circle"></i>
                Negotiation Confirmation
            </h3>
            <button class="modal-close" onclick="closeModal('negotiationConfirmationModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">


            <div style="display: grid; gap: 1.5rem;">

                <div style="text-align: center; margin: 1rem 0; position: relative;">

                    <span
                        style="background: white; padding: 0 1rem; position: relative; color: var(--text-muted); font-weight: 500;">Do
                        you want to initiate Negotiation by sending notification to Master Workflow? </span>
                </div>



            </div>
        </div>


        <div class="modal-footer">

            <button class="btn btn-primary" onclick="submitInitiateNegotiation()">
                <i class="ti ti-send"></i>
                Initiate Negotiation
            </button>
            <button class="btn btn-outline-secondary" onclick="closeModal('negotiationConfirmationModal')">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Execute Contract Confirmation Modal -->
<div class="modal" id="executeContractModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--success-color), #20c997); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-rocket" style="font-size: 24px;"></i>
                Execute Contract
            </h3>
            <button class="modal-close" onclick="closeModal('executeContractModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
        </div>

        <div class="modal-body" style="padding: 2rem;">
            <!-- Execution Checklist -->
            <div
                style="background: var(--info-bg); padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--info-color);">
                <h4
                    style="margin: 0 0 1rem 0; color: var(--info-color); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-checklist"></i>
                    Pre-Execution Checklist
                </h4>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <i class="ti ti-check" style="color: var(--success-color); font-size: 1.25rem;"></i>
                        <span>Both parties have signed the contract</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <i class="ti ti-check" style="color: var(--success-color); font-size: 1.25rem;"></i>
                        <span>All approvals have been completed</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <i class="ti ti-check" style="color: var(--success-color); font-size: 1.25rem;"></i>
                        <span>Contract content has been finalized</span>
                    </label>
                </div>
            </div>

            <!-- Execution Details -->
            <div
                style="background: var(--background-light); padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h5 style="margin: 0 0 1rem 0; color: var(--text-color);">Execution Details</h5>
                <div style="display: grid; gap: 0.75rem; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Execution Date:</span>
                        <strong id="executionDate">${new Date().toLocaleDateString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Effective Date:</span>
                        <strong id="effectiveDate">${new Date().toLocaleDateString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Contract Status:</span>
                        <strong style="color: var(--success-color);">Fully Executed</strong>
                    </div>
                </div>
            </div>

            <!-- What Happens Next -->
            <div
                style="padding: 1.25rem; background: rgba(40, 167, 69, 0.05); border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.2);">
                <h5
                    style="margin: 0 0 1rem 0; color: var(--success-color); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-info-circle"></i>
                    What Happens After Execution?
                </h5>
                <ul
                    style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem; line-height: 1.8;">
                    <li>Contract status will change to <strong>"Executed"</strong></li>
                    <li>Certificate of Completion will be generated</li>
                    <li>All parties will receive execution notifications</li>
                    <li>Contract will become active and enforceable</li>
                    <li>Obligation tracking will begin automatically</li>
                </ul>
            </div>

            <!-- Confirmation Checkbox -->
            <div
                style="margin-top: 1.5rem; padding: 1rem; background: white; border: 2px solid var(--border-color); border-radius: 8px;">
                <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer;">
                    <input type="checkbox" id="confirmExecution"
                        style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer; accent-color: var(--success-color);"
                        onchange="toggleExecuteButton()">
                    <span style="font-size: 0.9rem;">
                        I confirm that all parties have signed and all requirements are met. I authorize the execution
                        of this contract.
                    </span>
                </label>
            </div>
        </div>

        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-outline-secondary" onclick="closeModal('executeContractModal')">
                <i class="ti ti-x"></i>
                Cancel
            </button>
            <button class="btn btn-success" id="executeContractBtn" onclick="executeContract()" disabled
                style="background: linear-gradient(135deg, var(--success-color), #20c997); padding: 0.625rem 1.5rem;">
                <i class="ti ti-rocket"></i>
                Execute Contract
            </button>
        </div>
    </div>
</div>

<!-- Certificate of Completion Modal -->
<div class="modal" id="certificateModal">
    <div class="modal-content modal-lg" style="max-width: 900px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--success-color), #20c997); color: white;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-certificate"></i>
                Certificate of Completion
            </h3>
            <button class="modal-close" onclick="closeModal('certificateModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" id="certificateContent" style="padding: 2rem;">
            <!-- Certificate will be dynamically loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="downloadCertificate()">
                <i class="ti ti-download"></i>
                Download Certificate
            </button>
            <button class="btn btn-primary" onclick="closeModal('certificateModal')">
                Close
            </button>
        </div>
    </div>
</div>


<!-- Comments Panel -->
<!-- Comments Side Panel -->
<div id="commentsPanel" class="comments-panel"
    style="display: none; position: fixed; top: 0; right: 0; width: 450px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.15); z-index: 9999; flex-direction: column;">
    <div
        style="padding: 20px; border-bottom: 2px solid #e0e0e0; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="ti ti-message-circle" style="font-size: 24px; color: #0066cc;"></i>
            <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Comments</h3>
            <span id="commentsBadge"
                style="display: none; background: #0066cc; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
        </div>
        <button onclick="toggleCommentsPanel()"
            style="background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%;">
            <i class="ti ti-x" style="font-size: 20px; color: #666;"></i>
        </button>
    </div>

    <div id="commentsListContainer" style="flex: 1; overflow-y: auto; background: #fafbfc;">
        <div style="padding: 40px 20px; text-align: center; color: #888;">
            <i class="ti ti-loader" style="font-size: 48px; opacity: 0.5;"></i>
            <p style="margin-top: 15px;">Loading comments...</p>
        </div>
    </div>
</div>


<!-- Enhanced Add Comment Modal with Track Changes -->
<div class="modal" id="commentModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="modal-content"
        style="background: white; border-radius: 12px; width: 550px; max-width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div class="modal-header"
            style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
            <div class="modal-title"
                style="font-size: 18px; font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 10px;">

                <span id="modalTitle">Add Comment</span>
            </div>
            <button class="modal-close" onclick="closeModal('commentModal')"
                style="background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d; padding: 4px;"></button>
        </div>

        <div class="modal-body" style="padding: 20px;">
            <!-- Change Type Selection -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label"
                    style="display: block; font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 10px;">
                    <i class="ti ti-edit"></i> Action Type
                </label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="changeType" value="comment" checked
                            onchange="updateChangeType(this.value)" style="margin-right: 6px;">
                        <i class="ti ti-message-circle" style="color: #ffc107;"></i>
                        <span style="font-size: 14px;">Comment</span>
                    </label>
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="changeType" value="delete" onchange="updateChangeType(this.value)"
                            style="margin-right: 6px;">
                        <i class="ti ti-trash" style="color: #dc3545;"></i>
                        <span style="font-size: 14px;">Delete Text</span>
                    </label>
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="changeType" value="insert" onchange="updateChangeType(this.value)"
                            style="margin-right: 6px;">
                        <i class="ti ti-pencil" style="color: #28a745;"></i>
                        <span style="font-size: 14px;">Modify Text</span>
                    </label>
                </div>
            </div>

            <!-- Comment/Reason Text -->
            <div class="form-group" style="margin-bottom: 15px;">
                <label class="form-label"
                    style="display: block; font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                    <span id="commentLabel">Your Comment</span>
                </label>
                <textarea id="commentText" class="form-control" rows="3" placeholder="Enter your comment..."
                    style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
            </div>

            <!-- New Text (for modifications) -->
            <div class="form-group" id="newTextGroup" style="margin-bottom: 15px; display: none;">
                <label class="form-label"
                    style="display: block; font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                    <i class="ti ti-pencil"></i> New Text (Replacement)
                </label>
                <textarea id="newText" class="form-control" rows="2" placeholder="Enter the new text..."
                    style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
            </div>

            <!-- Selected Text Preview -->
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label"
                    style="display: block; font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                    <i class="ti ti-quote"></i> <span id="selectedLabel">Selected Text</span>
                </label>
                <div
                    style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 14px; border-left: 3px solid #0066cc;">
                    <em id="selectedTextPreview" style="color: #666;">No text selected</em>
                </div>
            </div>

            <!-- Preview Section -->
            <div id="changePreview"
                style="display: none; margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #ffc107;">
                <div style="font-size: 13px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                    <i class="ti ti-eye"></i> Preview:
                </div>
                <div id="previewContent" style="font-size: 13px; color: #333;"></div>
            </div>
        </div>

        <div class="modal-footer"
            style="padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeModal('commentModal')"
                style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; background: #6c757d; color: white;">
                Cancel
            </button>
            <button class="btn btn-primary" onclick="submitComment()"
                style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; background: #0066cc; color: white;">
                <span id="submitBtnText">Add Comment</span>
            </button>
        </div>
    </div>
</div>




<!-- Toggle Button -->
<button class="comments-toggle-btn" onclick="toggleCommentsPanel()"
    style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #0066cc, #0052a3); color: white; border: none; box-shadow: 0 4px 12px rgba(0,102,204,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 9998; transition: all 0.3s;">
    <i class="ti ti-message-circle" style="font-size: 24px; color:white"></i>
    <span id="commentsBadge2"
        style="display: none; position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; border: 2px solid white;">0</span>
</button>

<!-- In your contract editor template -->
<input type="hidden" id="currentUserId" value="{{ current_user.id }}">

<!-- Bubble Comments JavaScript -->
<script>
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const contractId = urlParams.get('id');

        if (contractId) {
            currentContractId = contractId;
            loadComments();
        }

        // Update preview when modal opens
        document.getElementById('addCommentBtn')?.addEventListener('click', () => {
            if (window.commentSelection) {
                document.getElementById('selectedTextPreview').textContent =
                    window.commentSelection.text;
            }
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
            e.preventDefault();
            openAddCommentModal();
        }
        if (e.key === 'Escape') {
            closeBubble();
            closeModal('commentModal');
        }
    });
</script>


<script>
    // =====================================================
    // GLOBAL VARIABLES
    // =====================================================
    //  CORRECTED URL PARSING
    let contractId = (() => {
        // First check query params (?id=123)
        const urlParams = new URLSearchParams(window.location.search);
        const idFromQuery = urlParams.get('id');
        if (idFromQuery) return idFromQuery;

        // Fallback to path parsing (/contract/edit/123)
        const pathParts = window.location.pathname.split('/');
        const editIndex = pathParts.indexOf('edit');
        if (editIndex !== -1 && pathParts[editIndex + 1]) {
            return pathParts[editIndex + 1];
        }

        // Last resort - check for any number in path
        const lastPart = pathParts[pathParts.length - 1];
        if (lastPart && !isNaN(lastPart)) return lastPart;

        return null;
    })();
    let contractData = null;
    let selectedContractWorkflow = null;
    let contractWorkflowStepCount = 1;
    let canvas, ctx, isDrawing = false;
    let currentSignatureField = null;
    let originalContent = '';
    let autoSaveInterval = null;
    let currentClauseText = '';
    let riskAnalysisData = null;
    let uploadedFiles = [];
    let regenSelectedClauses = [];



    // =====================================================
    // PAGE INITIALIZATION
    // =====================================================
    // =====================================================
    // PAGE INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('Loading contract ID:', contractId);

        await ensureWorkflowInstance();
        await checkWorkflowAvailability();
        await loadContractData();

        await saveAsDraft();
    });



    function toggleClauseSection() {
        const section = document.getElementById('regenClauseSection');
        const toggleText = document.getElementById('clauseToggleText');

        if (section.style.display === 'none') {
            section.style.display = 'block';
            toggleText.textContent = 'Hide Clause Selection';
        } else {
            section.style.display = 'none';
            toggleText.textContent = 'Show Clause Selection';
        }
    }




    async function ensureWorkflowInstance() {


        try {

            if (!contractId) {
                console.warn('No contract ID found');
                return;
            }

            const response = await fetch(`/api/contracts/workflow/ensure-instance/${contractId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                console.error('Failed to ensure workflow instance');
                return;
            }

            const data = await response.json();


            if (data.instance_created) {
                console.log(' Workflow instance auto-created:', data.workflow_name);
            } else if (data.instance_exists) {
                console.log(' Workflow instance already exists:', data.workflow_name);
            } else {
                console.log(' No master workflow configured for company');
            }

            // Store workflow info globally for later use
            window.contractWorkflowInfo = {
                hasInstance: data.instance_exists || data.instance_created,
                workflowId: data.workflow_id,
                workflowName: data.workflow_name,
                isMaster: data.is_master,
                status: data.status
            };

        } catch (error) {
            console.error(' Error ensuring workflow instance:', error);
        }
    }


    // =====================================================
    // DATA LOADING FUNCTIONS
    // =====================================================
    async function loadContractData() {
        try {
            console.log(' Loading contract data for ID:', contractId);

            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/contracts/edit/${contractId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            const data = await response.json();

            console.log('Contract data received:', data);

            if (data.success) {
                contractData = data;

                // Set currentContractId
                if (data.contract && data.contract.id) {
                    currentContractId = data.contract.id;
                    console.log(' currentContractId set to:', currentContractId);
                }

                // Render the editor
                renderContractEditor(data);

                //  NEW: Update signature fields with actual signature data
                if (data.certificate) {
                    console.log(' Certificate data found, updating signature displays...');
                    // Wait a moment for DOM to be ready
                    setTimeout(() => {
                        updateSignatureFields(data.certificate);
                    }, 500);
                }

                document.getElementById('contractEditor').classList.add('loaded');
                document.getElementById('contractEditor').style.display = 'block';
                hideLoader();

                // startAutoSave();

                // Initialize AI AFTER contract is rendered
                await initializeAIGeneration();
            } else {
                hideLoader();
                showError('Failed to load contract data: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading contract:', error);
            hideLoader();
            showError('Failed to load contract data: ' + error.message);
        }

        if (contractData.contract.status === 'executed' ||
            contractData.contract.status === 'signed') {

            // Lock the editor
            const editor = document.getElementById('contractContent');
            editor.contentEditable = false;
            editor.style.background = '#f9fafb';
            editor.style.border = '2px solid #fbbf24';

            // Disable all editing buttons
            document.querySelectorAll('.toolbar-btn, .editor-toolbar button').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });

            // Show warning banner
            showNotification('This contract cannot be edited. All changes are locked.', 'warning');

            // Add visible banner
            const banner = document.createElement('div');
            banner.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center;';
            banner.innerHTML = `
            <i class="ti ti-lock" style="font-size: 24px; color: #f59e0b;"></i>
            <strong style="color: #92400e;">CONTRACT EXECUTED & LOCKED</strong>
            <p style="margin: 5px 0 0 0; color: #92400e;">This contract is finalized and cannot be modified. All edits are permanently disabled.</p>
        `;
            document.querySelector('.contract-editor-wrapper').prepend(banner);
        }
    }

    // =====================================================
    // RENDERING FUNCTIONS
    // =====================================================
    function renderContractEditor(data) {
        const { contract, workflow, versions, current_approver, certificate } = data;
        console.log('Rendering contract:', contract);
        console.log('Contract content length:', contract.content ? contract.content.length : 0);
        console.log('Contract status:', contract.status);
        console.log('Certificate data:', certificate);
        console.log('Certificate workflow:', workflow);

        console.log('trsting');

        const editor = document.getElementById('contractContent');
        const language = contract.ai_generation_params?.language || 'en';
        if (language === 'ar') editor.setAttribute('dir', 'rtl');


        // Extract signatory data from certificate

        // =================================================================
        // SIGNATURE BLOCK RENDERING - FIXED VERSION
        // This code updates the renderContractEditor function signature block section
        // =================================================================

        // Extract signatory data from certificate with proper handling
        let clientSignatory = {
            name: '[Name]',
            signer_type: '[Title]',
            email: '',
            has_signed: false,
            signed_at: null,
            signature_data: null,
            signature_method: 'draw'  //  ADD THIS
        };

        let companySignatory = {
            name: '[Name]',
            signer_type: '[Title]',
            email: '',
            has_signed: false,
            signed_at: null,
            signature_data: null,
            signature_method: 'draw'  //  ADD THIS
        };

        if (certificate && certificate.signatories) {
            const clientSig = certificate.signatories.find(s =>
                s.signer_type === 'client' || s.signer_type === 'party_a'
            );
            const companySig = certificate.signatories.find(s =>
                s.signer_type === 'company' || s.signer_type === 'party_b' || s.signer_type === 'provider'
            );

            if (clientSig && clientSig.has_signed) {
                // Update client name and title fields in the DOM
                const clientNameSpan = document.querySelector('.signature-block-client .editable-field[contenteditable]');
                if (clientNameSpan && clientNameSpan.textContent === '[Name]') {
                    clientNameSpan.textContent = clientSig.name;
                }

                const clientTitleSpan = document.querySelectorAll('.signature-block-client .editable-field')[1];
                if (clientTitleSpan && clientTitleSpan.textContent === '[Title]') {
                    clientTitleSpan.textContent = 'Client Representative';
                }
            }

            if (companySig && companySig.has_signed) {
                // Update company name and title fields in the DOM
                const companyNameSpan = document.querySelector('.signature-block-company .editable-field[contenteditable]');
                if (companyNameSpan && companyNameSpan.textContent === '[Name]') {
                    companyNameSpan.textContent = companySig.name;
                }

                const companyTitleSpan = document.querySelectorAll('.signature-block-company .editable-field')[1];
                if (companyTitleSpan && companyTitleSpan.textContent === '[Title]') {
                    companyTitleSpan.textContent = 'Company Representative';
                }
            }
        }

        //  ADD HELPER FUNCTION to render actual signature
        function renderSignature(signatory) {
            if (!signatory.signature_data) {
                return '<div style="font-family: \'Brush Script MT\', cursive; font-size: 1.5rem; color: #000;">Digitally Signed</div>';
            }

            // If it's a base64 image (drawn signature)
            if (signatory.signature_data.startsWith('data:image')) {
                return `<img src="${signatory.signature_data}" 
                     alt="Signature" 
                     style="max-width: 200px; max-height: 80px; object-fit: contain;">`;
            }

            // If it's typed text
            return `<div style="font-family: 'Brush Script MT', cursive; font-size: 2rem; color: #000; padding: 0.5rem;">
                ${signatory.signature_data}
            </div>`;
        }

        // CLIENT SIGNATURE HTML
        const clientSignatureHTML = clientSignatory.has_signed
            ? `<div class="signature-field signed" id="clientSignature" 
            style="border: 2px solid #28a745; border-radius: 8px; padding: 1.5rem; background: #f0fff4; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
           <!--  ACTUAL SIGNATURE DISPLAY -->
           <div style="margin-bottom: 0.75rem;">
               ${renderSignature(clientSignatory)}
           </div>
           <div style="font-size: 0.875rem; color: #28a745; font-weight: 600; text-align: center;">
              
               <span style="font-size: 0.75rem;">
                   ${clientSignatory.signed_at ? new Date(clientSignatory.signed_at).toLocaleString() : 'N/A'}
               </span>
           </div>
       </div>`
            : `<div class="signature-field" id="clientSignature" 
            onclick="${(contract.status === 'signature' && contract.is_counterparty) ? "openSignature('client')" : "void(0)"}"
            style="border: 3px dashed #cbd5e0; border-radius: 8px; padding: 2rem; background: #f8fafc; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: ${(contract.status === 'signature' && contract.is_counterparty) ? 'pointer' : 'default'};">
           <i class="ti ti-writing-sign" style="font-size: 2.5rem; color: #94a3b8; margin-bottom: 0.75rem;"></i>
           <span style="color: #64748b; font-weight: 500;">Click to Sign (Client)</span>
       </div>`;

        // COMPANY SIGNATURE HTML  
        const companySignatureHTML = companySignatory.has_signed
            ? `<div class="signature-field signed" id="companySignature" 
            style="border: 2px solid #28a745; border-radius: 8px; padding: 1.5rem; background: #f0fff4; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
           <!--  ACTUAL SIGNATURE DISPLAY -->
           <div style="margin-bottom: 0.75rem;">
               ${renderSignature(companySignatory)}
           </div>
           <div style="font-size: 0.875rem; color: #28a745; font-weight: 600; text-align: center;">
               
               <span style="font-size: 0.75rem;">
                   ${companySignatory.signed_at ? new Date(companySignatory.signed_at).toLocaleString() : 'N/A'}
               </span>
           </div>
       </div>`
            : `<div class="signature-field" id="companySignature" 
            onclick="${(contract.status === 'signature' && !contract.is_counterparty) ? "openSignature('company')" : "void(0)"}"
            style="border: 3px dashed #cbd5e0; border-radius: 8px; padding: 2rem; background: #f8fafc; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: ${(contract.status === 'signature' && !contract.is_counterparty) ? 'pointer' : 'default'};">
           <i class="ti ti-writing-sign" style="font-size: 2.5rem; color: #94a3b8; margin-bottom: 0.75rem;"></i>
           <span style="color: #64748b; font-weight: 500;">Click to Sign (Company)</span>
       </div>`;

        // COMPLETE SIGNATURE BLOCK WITH AUTO-FILLED NAMES AND TITLES
        const signature_block = `
<div style="margin-top: 3rem; page-break-inside: avoid;">    
    <div style="display: flex; justify-content: space-between; gap: 3rem; margin-top: 3rem;">
        <!-- CLIENT SIGNATURE SECTION -->
        <div style="flex: 1;">
            ${clientSignatureHTML}
            <div style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <p style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 1rem; color: var(--primary-color);">
                    <strong>CLIENT</strong>
                </p>
                <p style="margin: 0.5rem 0; display: flex; align-items: center;">
                    <strong style="min-width: 60px;">Name:</strong> 
                    <span class="editable-field" 
                          contenteditable="${!clientSignatory.has_signed}"
                          style="flex: 1; padding: 0.25rem 0.5rem; border-bottom: 1px solid #e2e8f0; ${clientSignatory.has_signed ? 'background: #f0fff4; font-weight: 600;' : ''}">${clientSignatory.name}</span>
                </p>
                <p style="margin: 0.5rem 0; display: flex; align-items: center;">
                    <strong style="min-width: 60px;">Title:</strong> 
                    <span class="editable-field" 
                          contenteditable="${!clientSignatory.has_signed}"
                          style="flex: 1; padding: 0.25rem 0.5rem; border-bottom: 1px solid #e2e8f0; ${clientSignatory.has_signed ? 'background: #f0fff4; font-weight: 600;' : ''}">${clientSignatory.signer_type}</span>
                </p>
            </div>
        </div>
        
        <!-- COMPANY SIGNATURE SECTION -->
        <div style="flex: 1;">
            ${companySignatureHTML}
            <div style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <p style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 1rem; color: var(--secondary-color);">
                    <strong>COMPANY</strong>
                </p>
                <p style="margin: 0.5rem 0; display: flex; align-items: center;">
                    <strong style="min-width: 60px;">Name:</strong> 
                    <span class="editable-field" 
                          contenteditable="${!companySignatory.has_signed}"
                          style="flex: 1; padding: 0.25rem 0.5rem; border-bottom: 1px solid #e2e8f0; ${companySignatory.has_signed ? 'background: #f0fff4; font-weight: 600;' : ''}">${companySignatory.name}</span>
                </p>
                <p style="margin: 0.5rem 0; display: flex; align-items: center;">
                    <strong style="min-width: 60px;">Title:</strong> 
                    <span class="editable-field" 
                          contenteditable="${!companySignatory.has_signed}"
                          style="flex: 1; padding: 0.25rem 0.5rem; border-bottom: 1px solid #e2e8f0; ${companySignatory.has_signed ? 'background: #f0fff4; font-weight: 600;' : ''}">${companySignatory.signer_type}</span>
                </p>
            </div>
        </div>
    </div>
</div>`;

        console.log(' Signature block rendered with actual signatures and auto-filled names/titles');



        // Determine the action buttons based on contract status
        let actionButtons = '';

        if (contract.status === 'draft') {
            if (contract.is_initiator === true) {
                // Draft stage
                actionButtons = `
          <button class="btn btn-primary" onclick="submitForReview('${workflow ? workflow.status : 'nothing'}')">
    <i class="ti ti-send"></i> Submit for Internal Review
</button>`;



            }
            if (contract.approval_status === 'initiator_team_rejected') {
                actionButtons += `<button class="workflow-setup-btn" onclick="openWorkflowHistoryModal()" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="ti ti-history"></i> Approval History
                                    </button>`;
            }
        } else if ((contract.status === 'review')) {
            // Review stage

            if ((contract.is_initiator === true)) {
                actionButtons = getApprovalBadge(current_approver, workflow, 'review');
            } else {

                if ((workflow && workflow.is_my_workflow_turn === true) && (workflow && workflow.status != 'completed')) {

                    actionButtons = `
                    <button class="btn signature-btn" onclick="approveWorkflow(${contract.id},'internal_review')">
                        <i class="ti ti-check"></i> Approve
                    </button>
                    <button class="btn btn-danger" onclick="rejectWorkflow(${contract.id},'internal_review')">
                        <i class="ti ti-x"></i> Reject
                    </button>`;
                } else {
                    actionButtons = getApprovalBadge(current_approver, workflow, 'review');

                }

            }

            actionButtons += `<button class="workflow-setup-btn" onclick="openWorkflowHistoryModal()" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="ti ti-history"></i> Approval History
                                    </button>`;
        } else if ((contract.status === 'review_completed')) {

            if (contract.is_initiator === true) {
                actionButtons = `
            <button class="btn btn-primary" onclick="openSendToCounterPartyModal()">
                <i class="ti ti-send"></i> Send to Counter-Party
            </button>`;

            } else {
                actionButtons = ``;
            }
        }

        else if (contract.status === 'counterparty_internal_review') {

            if (contract.is_counterparty === true) {

                if ((workflow && workflow.status != 'active')) {

                    if (contract.is_party_b_lead == true) {

                        actionButtons = `
                    
        <button class="btn btn-success" onclick="markCounterpartyReviewComplete()">
            <i class="ti ti-check"></i> Quick Review
        </button>
        <button class="btn btn-primary" onclick="submitForReview('${workflow.status}')">
                <i class="ti ti-send"></i> Submit for Internal Review
            </button>`;
                    }
                } else if ((workflow && workflow.status == 'active')) {

                    if ((workflow && workflow.is_my_workflow_turn === true) && (workflow && workflow.status != 'completed')) {

                        actionButtons = `
                       
        <button class="btn signature-btn" onclick="approveWorkflow(${contract.id},'counterparty_internal_review')">
            <i class="ti ti-check"></i> Approve
        </button>
        <button class="btn btn-danger" onclick="rejectWorkflow(${contract.id}, 'counterparty_internal_review')">
            <i class="ti ti-x"></i> Reject
        </button>`;

                    } else {
                        //if I am not the current approver
                        actionButtons = getApprovalBadge(current_approver, workflow, 'review');
                    }
                    actionButtons += `
                    
                    <button class="workflow-setup-btn" onclick="openWorkflowHistoryModal()" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="ti ti-history"></i> Approval History
                                      </button>`;

                }


            }
        } else if ((contract.status === 'counterparty_review_completed')) {

            if (contract.is_party_b_lead == true) {
                actionButtons = `
          
            <button class="btn btn-primary" id="openNegotiationBtn" onclick="openNegotiationConfirmationModal()">
                <i class="ti ti-message-circle"></i> Initiate Negotiation
            </button>`;
            }
        } else if ((contract.status === 'negotiation')) {

            if (contract.is_counterparty === true) {

                if (contract.is_party_b_lead == true) {
                    // Negotiation stage
                    actionButtons = `
                 
            <button class="btn btn-success" onclick="quickApprove()">
                <i class="ti ti-check-circle"></i> Finalize Agreement
            </button>
            <button class="btn btn-primary" id="openNegotiationBtn" onclick="openNegotiationModal()">
                <i class="ti ti-message-circle"></i> Open Negotiation
            </button>
            <button class="btn btn-outline-secondary" onclick="openDocumentsModal()">
                <i class="ti ti-paperclip"></i> Attach Documents
            </button>`;
                } else {
                    actionButtons = `
           
            <button class="btn btn-primary" id="openNegotiationBtn" onclick="openNegotiationModal()">
                <i class="ti ti-message-circle"></i> Open Negotiation
            </button>`;
                }
            } else {

                if (contract.is_initiator === true) {
                    actionButtons = `
                  
            <button class="btn btn-primary" id="openNegotiationBtn" onclick="startExternalNegotiation()">
                <i class="ti ti-message-circle"></i> Open Negotiation
            </button>`;
                }
            }
        } else if (contract.status === 'negotiation_completed') {
            if ((contract.is_initiator === true)) {
                actionButtons = `
              
            <button class="btn btn-primary" onclick="initiateApprovalWorkflow()">
                <i class="ti ti-send"></i> Initiate Approval Workflow
            </button>`;
            }


        } else if (contract.status === 'approval') {


            if ((contract.is_counterparty === false)) {
                if ((workflow && workflow.is_my_workflow_turn === true) && (workflow && workflow.status != 'completed')) {

                    actionButtons = `
                    
        <button class="btn signature-btn" onclick="approveWorkflow(${contract.id},'approval')">
            <i class="ti ti-check"></i> Approve
        </button>
        <button class="btn btn-danger" onclick="rejectWorkflow(${contract.id}, 'approval')">
            <i class="ti ti-x"></i> Reject
        </button>`;
                } else {

                    actionButtons = getApprovalBadge(current_approver, workflow, 'approval');

                }

                actionButtons += `<button class="workflow-setup-btn" onclick="openWorkflowHistoryModal()" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="ti ti-history"></i> Approval History
                                        </button>`;
            }

        } else if (contract.status === 'approved') {

            if ((contract.is_initiator === true)) {

                // if ((workflow && workflow.status === 'completed')) {
                // Approved stage
                actionButtons = `
            <button class="btn btn-primary" onclick="initiateSignatureWorkflow()">
                <i class="ti ti-writing-sign"></i> Send for Signature
            </button>`;
                // } 


            }


        } else if (contract.status === 'signature') {

            const party = contract.is_counterparty ? 'client' : 'company';

            if (contract.is_esignee) {
                // Signature stage
                actionButtons = `
            <button class="btn btn-success" onclick="openSignatureModal('${party}')">
                <i class="ti ti-writing-sign"></i> Sign Contract
            </button>`;
            }
        } else if (contract.status === 'signed') {

            if ((contract.is_initiator === true)) {
                //  SIGNED STAGE - READY FOR EXECUTION
                actionButtons = `
            <button class="btn btn-success" onclick="openExecuteContractModal()" style="background: linear-gradient(135deg, var(--success-color), #20c997);">
                <i class="ti ti-rocket"></i> Execute Contract
            </button>
            <button class="btn btn-outline-secondary" onclick="exportDocument()">
                <i class="ti ti-download"></i> Download
            </button>`;
            }
        } else if (contract.status === 'executed') {
            // Executed stage - Show certificate and download
            actionButtons = `
            <button class="btn btn-success" onclick="viewExecutionCertificate()">
                <i class="ti ti-certificate"></i> View Certificate
            </button>
            <button class="btn btn-outline-secondary" onclick="exportDocument()">
                <i class="ti ti-download"></i> Download Contract
            </button>`;
        }

        document.getElementById('contractEditor').innerHTML = `
        <!-- Page Header -->
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: white; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem;">
            <div class="page-header-left">
                <h1 class="page-title" style="font-size: 1.5rem; font-weight: 600; color: var(--text-color); margin: 0;">Contract Editor</h1>
                <p class="page-description" style="color: var(--text-muted); font-size: 0.9rem; margin: 0.25rem 0 0 0;">${contract.title || 'Untitled'} - ${contract.contract_number || 'No Number'}</p>
                <input type="hidden" name="contract_number" value="${contract.contract_number || 'No Number'}"> 
            </div>
            <div class="page-header-right" style="display: flex; gap: 1rem;">
${actionButtons}
            </div>
        </div>
        <!-- Workflow Stepper -->
${renderWorkflowStepper(contract.status)}
        <!-- Workflow Status Bar -->
        <div class="workflow-status-bar">
            <div class="workflow-status-info">
                <span class="workflow-status-label">Active Workflow:</span>
                <span class="workflow-status-value">
                    <i class="ti ti-git-branch"></i>
                    <span id="workflowStatusText">${workflow ? workflow.template_name : 'Not Configured'}</span>
                </span>

           
            </div>
             <div class="ai-toolbar-group">
                 <button class="workflow-setup-btn" onclick="openWorkflowSetupModal()">
                    <i class="ti ti-settings-automation"></i> Setup Custom Workflow
                </button>
               
                ${!contract.is_counterparty ? `
    <button class="workflow-setup-btn" onclick="if('${contract.language}' !== 'en') { showNotification('Review Analysis is available only for English language contracts.', 'warning'); } else { openRiviewModal(); }">
        <i class="ti ti-alert-triangle"></i> Review Analysis
    </button>
    <button class="workflow-setup-btn" onclick="if('${contract.language}' !== 'en') { showNotification('Clause Analysis is available only for English language contracts.', 'warning'); } else { openClauseAnalysisModal(); }">
        <i class="ti ti-file-text"></i> Clause Analysis
    </button>
    ` : `<button class="workflow-setup-btn" onclick="if('${contract.language}' !== 'en') { showNotification('Risk Summary is available only for English language contracts.', 'warning'); } else { showRiskSummary(); }">
        <i class="ti ti-file-text"></i> Generate Risk Summary
    </button>`}
            </div>

        </div>

        
        <div class="editor-container">
            
            <div class="editor-main">
                <!-- Editor Toolbar -->
${renderEditorToolbar()}
                <!-- Document Info Bar -->
${renderDocumentInfo(contract, versions)}
<div id="aiGenerationBanner">
    <span>AI is creating your contract in real time and it will take a while. You may continue to work on the contract as it is getting generated</span>
</div>
                <!-- Editor Content Area -->
                <div class="editor-content">
                    <div class="editor-paper" contenteditable="true" id="contractContent">
${contract.content && contract.content.trim() !== '' ?
                (contract.content.includes('signature-field') ? contract.content : contract.content + signature_block)
                : getDefaultContractContent()}
                    </div>
                </div>
            </div>
        </div>
    `;

    }




    function renderSignature(signatory) {
        if (!signatory.signature_data) {
            return '<div style="font-family: \'Brush Script MT\', cursive; font-size: 1.5rem; color: #000;">Digitally Signed</div>';
        }
        if (signatory.signature_data.startsWith('data:image')) {
            return `<img src="${signatory.signature_data}" alt="Signature" style="max-width: 200px; max-height: 80px; object-fit: contain;">`;
        }
        return `<div style="font-family: 'Brush Script MT', cursive; font-size: 2rem; color: #000; padding: 0.5rem;">${signatory.signature_data}</div>`;
    }





    function updateSignatureFields(certificate) {
        console.log(' Updating signature fields with certificate data:', certificate);

        if (!certificate || !certificate.signatories || certificate.signatories.length === 0) {
            console.log(' No certificate data to display');
            return;
        }

        const clientSig = certificate.signatories.find(s => s.signer_type === 'client' || s.signer_type === 'party_a');
        const companySig = certificate.signatories.find(s => s.signer_type === 'company' || s.signer_type === 'party_b' || s.signer_type === 'provider');

        // Update CLIENT signature
        if (clientSig && clientSig.has_signed) {
            const clientField = document.getElementById('clientSignature');
            if (clientField) {
                clientField.innerHTML = `
                <div style="margin-bottom: 0.75rem;">${renderSignature(clientSig)}</div>
                <div style="font-size: 0.875rem; color: #28a745; font-weight: 600; text-align: center;">
                   
                    <span style="font-size: 0.75rem;">${clientSig.signed_at ? new Date(clientSig.signed_at).toLocaleString() : 'N/A'}</span>
                </div>
            `;
                clientField.style.border = '2px solid #28a745';
                clientField.style.background = '#f0fff4';
                clientField.onclick = null;
            }

            //  Update Name/Title fields for CLIENT
            const clientContainer = clientField?.parentElement;
            if (clientContainer) {
                const nameFields = clientContainer.querySelectorAll('.editable-field');
                if (nameFields[0]) nameFields[0].textContent = clientSig.name;
                if (nameFields[1]) nameFields[1].textContent = 'Client Representative';
            }
        }

        // Update COMPANY signature
        if (companySig && companySig.has_signed) {
            const companyField = document.getElementById('companySignature');
            if (companyField) {
                companyField.innerHTML = `
                <div style="margin-bottom: 0.75rem;">${renderSignature(companySig)}</div>
                <div style="font-size: 0.875rem; color: #28a745; font-weight: 600; text-align: center;">
                    
                    <span style="font-size: 0.75rem;">${companySig.signed_at ? new Date(companySig.signed_at).toLocaleString() : 'N/A'}</span>
                </div>
            `;
                companyField.style.border = '2px solid #28a745';
                companyField.style.background = '#f0fff4';
                companyField.onclick = null;
            }

            //  Update Name/Title fields for COMPANY
            const companyContainer = companyField?.parentElement;
            if (companyContainer) {
                const nameFields = companyContainer.querySelectorAll('.editable-field');
                if (nameFields[0]) nameFields[0].textContent = companySig.name;
                if (nameFields[1]) nameFields[1].textContent = 'Company Representative';
            }
        }

        console.log(' Signature fields and names updated');
    }


    function renderWorkflowStepper(status) {
        const steps = [
            {
                key: 'draft',
                icon: 'file-text',
                label: 'Draft',
                status: 'completed' // Draft is always completed if viewing the contract
            },
            {
                key: 'review',
                icon: 'users',
                label: 'Internal Review',
                status: status === 'draft' ? 'pending' :
                    status === 'review' ? 'active' :
                        status === 'review_completed' ? 'completed' :
                            // If any later stage, internal review must be completed
                            ['counterparty_internal_review', 'counterparty_review_completed',
                                'negotiation', 'negotiation_completed', 'approval', 'approved',
                                'signature', 'signed', 'executed'].includes(status) ? 'completed' :
                                'pending'
            },
            {
                key: 'counterparty_internal_review',
                icon: 'building',
                label: 'Counterparty Review',
                status: ['draft', 'review'].includes(status) ? 'pending' :
                    status === 'review_completed' ? 'pending' :
                        status === 'counterparty_internal_review' ? 'active' :
                            status === 'counterparty_review_completed' ? 'completed' :
                                // If negotiation or later stages, counterparty review must be completed
                                ['negotiation', 'negotiation_completed', 'approval', 'approved',
                                    'signature', 'signed', 'executed'].includes(status) ? 'completed' :
                                    'pending'
            },
            {
                key: 'negotiation',
                icon: 'message-circle',
                label: 'Negotiation',
                status: ['draft', 'review', 'review_completed', 'counterparty_internal_review'].includes(status) ? 'pending' :
                    status === 'counterparty_review_completed' ? 'pending' :
                        status === 'negotiation' ? 'active' :
                            status === 'negotiation_completed' ? 'completed' :
                                // If approval or later stages, negotiation must be completed
                                ['approval', 'approved', 'signature', 'signed', 'executed'].includes(status) ? 'completed' :
                                    'pending'
            },
            {
                key: 'approval',
                icon: 'circle-check',
                label: 'Approval',
                status: ['draft', 'review', 'review_completed', 'counterparty_internal_review',
                    'counterparty_review_completed', 'negotiation'].includes(status) ? 'pending' :
                    status === 'negotiation_completed' ? 'pending' :
                        status === 'approval' ? 'active' :
                            status === 'approved' ? 'completed' :
                                // If signing or later stages, approval must be completed
                                ['signature', 'signed', 'executed'].includes(status) ? 'completed' :
                                    'pending'
            },
            {
                key: 'signature',
                icon: 'writing-sign',
                label: 'Signature',
                status: ['draft', 'review', 'review_completed', 'counterparty_internal_review',
                    'counterparty_review_completed', 'negotiation', 'negotiation_completed',
                    'approval'].includes(status) ? 'pending' :
                    status === 'approved' ? 'pending' :
                        status === 'signature' ? 'active' :
                            status === 'signed' ? 'completed' :
                                status === 'executed' ? 'completed' :
                                    'pending'
            },
            {
                key: 'executed',
                icon: 'file-check',
                label: 'Executed',
                status: status === 'executed' ? 'completed' :
                    status === 'signed' ? 'pending' :
                        'pending'
            }
        ];


        return `
        <div class="workflow-stepper">
            <div class="stepper-container">
                <div class="stepper-line">
                    <div class="stepper-progress" id="stepperProgress" style="width: ${getProgressWidth(status)}%;"></div>
                </div>
                ${steps.map(step => `
                    <div class="stepper-step ${step.status}" >
                        <div class="step-icon-wrapper">
                            <i class="ti ti-${step.icon}"></i>
                        </div>
                        <span class="step-label">${step.label}</span>
                        <span class="step-date">${step.status === 'completed' ? 'Completed' :
                step.status === 'active' ? 'In Progress' :
                    'Pending'
            }</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    }


    function renderEditorToolbar() {
        return `
        <div class="editor-toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="execCmd('bold')" title="Bold">
                    <i class="ti ti-bold"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('italic')" title="Italic">
                    <i class="ti ti-italic"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('underline')" title="Underline">
                    <i class="ti ti-underline"></i>
                </button>
            </div>
            
            <div class="toolbar-group">
                <select class="toolbar-dropdown" onchange="execCmd('fontName', this.value)">
                    <option>Times New Roman</option>
                    <option>Arial</option>
                    <option>Calibri</option>
                </select>
                <select class="toolbar-dropdown" onchange="execCmd('fontSize', this.value)">
                    <option value="3">12pt</option>
                    <option value="4">14pt</option>
                    <option value="5">16pt</option>
                </select>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="execCmd('justifyLeft')" title="Align Left">
                    <i class="ti ti-align-left"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('justifyCenter')" title="Center">
                    <i class="ti ti-align-center"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('justifyRight')" title="Align Right">
                    <i class="ti ti-align-right"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('justifyFull')" title="Justify">
                    <i class="ti ti-align-justified"></i>
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="execCmd('insertOrderedList')" title="Numbered List">
                    <i class="ti ti-list-numbers"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="Bullet List">
                    <i class="ti ti-list"></i>
                </button>
                <button class="toolbar-btn" onclick="insertTable()" title="Insert Table">
                    <i class="ti ti-table"></i>
                </button>
            </div>
            
            <div class="toolbar-group">
              <button class="toolbar-btn primary" id="addCommentBtn">
            <i class="ti ti-message-plus"></i>
        </button>

       
                <button class="toolbar-btn" onclick="findReplace()" title="Find & Replace">
                    <i class="ti ti-search"></i>
                </button>
            </div>


             <button id="saveDraftBtn" class="btn signature-btn" onclick="saveAsDraft()">
                <i class="ti ti-device-floppy"></i> Save Contract
            </button>


            <!-- MAXIMIZE BUTTON - ADD THIS -->
        <div class="toolbar-group" style="margin-left: auto; border-right: none;">

            <button class="toolbar-btn" id="maximizeToggleBtn" onclick="toggleMaximizeEditor()" title="Fullscreen">
                <i class="ti ti-arrows-maximize"></i>
            </button>
        </div>

           
        </div>
    `;
    }

    function renderDocumentInfo(contract, versions) {
        const latestVersion = versions && versions.length > 0 ? versions[0] : null;

        return `
        <div class="document-info">
            <div class="document-title">
                <span class="document-name">${contract.title || 'Untitled'}</span>
                <span class="document-status saved" id="saveStatus">
                    <i class="ti ti-circle-check"></i> Loaded
                </span>
            </div>
            <div class="document-actions">
               
                <button class="btn btn-sm btn-outline-secondary" onclick="exportDocument()">
                    <i class="ti ti-download"></i> Export
                </button>
            </div>
        </div>
    `;
    }

    // =====================================================
    // HELPER FUNCTIONS
    // =====================================================
    function getProgressWidth(status) {
        const progress = {
            'draft': 0,
            'internal_review': 16.67,
            'counterparty_internal_review': 33.33,
            'negotiation': 50,
            'approved': 66.67,
            'signed': 83.33,
            'active': 83.33,
            'executed': 100
        };
        return progress[status] || 0;
    }

    function getDefaultContractContent() {
        return `
        <div class="contract-content">
            <h1 style="text-align: center;">SERVICE AGREEMENT</h1>
            
            <p>This Service Agreement ("Agreement") is entered into as of <span class="editable-field" contenteditable="true">[DATE]</span> between:</p>
            
            <div class="contract-clause" style="margin: 1.5rem 0;">
                <p><strong>CLIENT:</strong> <span class="editable-field" contenteditable="true">Qatar Energy Company</span>, a company organized and existing under the laws of Qatar</p>
            </div>
            
            <div class="contract-clause" style="margin: 1.5rem 0;">
                <p><strong>SERVICE PROVIDER:</strong> <span class="editable-field" contenteditable="true">[PROVIDER NAME]</span></p>
            </div>
            
            <h2>1. SCOPE OF SERVICES</h2>
            <div class="contract-clause" style="margin: 1rem 0;">
                <p><span class="clause-number">1.1</span> The Service Provider agrees to provide the following services ("Services"):</p>
                <p class="editable-field" contenteditable="true" style="margin-left: 2rem; font-style: italic;">[Describe the specific services to be provided]</p>
            </div>
            
            <h2>2. PAYMENT TERMS</h2>
            <div class="contract-clause" style="margin: 1rem 0;">
                <p><span class="clause-number">2.1</span> In consideration for the Services, the Client agrees to pay the Service Provider a total fee of <span class="editable-field" contenteditable="true">[AMOUNT]</span></p>
            </div>
            
            <h2>3. CONFIDENTIALITY</h2>
            <div class="contract-clause" style="margin: 1rem 0;">
                <p><span class="clause-number">3.1</span> Both parties acknowledge that they may have access to confidential information. Each party agrees to maintain the confidentiality of all confidential information received from the other party.</p>
            </div>
            
            <h2>4. TERM AND TERMINATION</h2>
            <div class="contract-clause" style="margin: 1rem 0;">
                <p><span class="clause-number">4.1</span> This Agreement shall commence on <span class="editable-field" contenteditable="true">[START DATE]</span> and continue until <span class="editable-field" contenteditable="true">[END DATE]</span></p>
                <p><span class="clause-number">4.2</span> Either party may terminate this Agreement upon thirty (30) days written notice.</p>
            </div>
            
            <div style="margin-top: 3rem;">
                <p><strong>IN WITNESS WHEREOF</strong>, the parties have executed this Agreement.</p>
                
                <div style="display: flex; justify-content: space-between; margin-top: 3rem;">
                    <div style="flex: 1; margin-right: 2rem;">
                        <div class="signature-field" id="clientSignature" onclick="openSignature('client')">
                            <div>
                                <i class="ti ti-writing-sign" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                                <span>Click to Sign (Client)</span>
                            </div>
                        </div>
                        <p style="margin-top: 1rem;"><strong>CLIENT</strong></p>
                        <p>Name: <span class="editable-field" contenteditable="true">[Name]</span></p>
                        <p>Title: <span class="editable-field" contenteditable="true">[Title]</span></p>
                    </div>
                    <div style="flex: 1;">
                        <div class="signature-field" id="providerSignature" onclick="openSignature('provider')">
                            <div>
                                <i class="ti ti-writing-sign" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                                <span>Click to Sign (Service Provider)</span>
                            </div>
                        </div>
                        <p style="margin-top: 1rem;"><strong>SERVICE PROVIDER</strong></p>
                        <p>Name: <span class="editable-field" contenteditable="true">[Name]</span></p>
                        <p>Title: <span class="editable-field" contenteditable="true">[Title]</span></p>
                    </div>
                </div>
            </div>
        </div>
    `;
    }

    // =====================================================
    // CONNECTED API FUNCTIONS - ALL BACKEND INTEGRATION
    // =====================================================

    // Save Draft
    async function saveAsDraft() {
        //  GET BUTTON AND SHOW LOADING
        const saveBtn = document.getElementById('saveDraftBtn');
        const originalContent = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> Saving...';

        try {
            console.log(' Saving draft...');

            //  FIX: Get content directly from the editor element
            const editor = document.getElementById('contractContent');
            if (!editor) {
                console.error(' Contract editor not found!');
                saveBtn.innerHTML = originalContent;
                saveBtn.disabled = false;
                showNotification('Contract editor not found', 'error');
                return;
            }

            // Get the content (innerHTML for contenteditable div, or value for textarea)
            const contractContent = editor.innerHTML || editor.value || '';

            if (!contractContent || contractContent.trim() === '') {
                console.warn(' Contract content is empty!');
                saveBtn.innerHTML = originalContent;
                saveBtn.disabled = false;
                showNotification('Cannot save empty contract', 'warning');
                return;
            }

            console.log(' Content length:', contractContent.length, 'characters');

            // Prepare data to save
            const data = {
                content: contractContent
            };

            // Save draft
            const response = await fetch(`/api/contracts/save-draft/${contractId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            console.log(' Save response:', result);

            if (result.success) {
                //  SHOW SUCCESS STATE
                saveBtn.innerHTML = '<i class="ti ti-check"></i> Saved!';

                // Display blockchain activities if available
                if (result.blockchain_activities && result.blockchain_activities.length > 0) {
                    console.log(' Blockchain activities received:', result.blockchain_activities.length);
                    if (typeof displayBlockchainActivities === 'function') {
                        displayBlockchainActivities(result.blockchain_activities);
                    }
                }

                showNotification('Draft saved successfully', 'success');

                //  RESTORE BUTTON AFTER 2 SECONDS
                setTimeout(() => {
                    saveBtn.innerHTML = originalContent;
                    saveBtn.disabled = false;
                }, 2000);

            } else {
                throw new Error(result.message || 'Save failed');
            }

        } catch (error) {
            console.error(' Error saving draft:', error);

            //  RESTORE BUTTON IMMEDIATELY ON ERROR
            saveBtn.innerHTML = originalContent;
            saveBtn.disabled = false;

            showNotification('Error saving draft: ' + error.message, 'error');
        }
    }

    // Submit for Review - CONNECTED TO BACKEND
    async function submitForReview(workflow_status) {

        // if (workflow_status != 'nothing') {
        openModal('internalReviewModal');
        // } else {
        // showNotification('Please setup workflow before proceeding', 'warning');
        // }

    }


    async function submitInternalReview() {
        const reviewType = document.querySelector('input[name="reviewOption"]:checked')?.value || 'specific';
        const personnelEmails = document.getElementById('specificPersonnel')?.value.split(',').map(e => e.trim()).filter(Boolean) || [];
        const notes = document.getElementById('reviewNotes')?.value || '';

        showLoader();
        try {
            const response = await fetch('/api/contracts/submit-approval', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId,
                    review_type: reviewType,
                    personnel_emails: personnelEmails,
                    notes: notes,
                    request_type: 'internal_review',
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Contract submitted for review', 'success');
                closeModal('internalReviewModal');
                // Update workflow status
                document.getElementById('workflowStatusText').textContent = 'In Review';
                setTimeout(async () => await refreshContractData(), 1000);
            } else {
                showNotification('Failed to submit for review', 'error');
            }
        } catch (error) {
            console.error('Error submitting for review:', error);
            showNotification('Failed to submit for review', 'error');
        } finally {
            hideLoader();
        }
    }

    // Risk Analysis - CONNECTED TO AI BACKEND
    async function openRiviewModal() {
        openModal('riskAnalysisModal');

        // Fetch risk analysis from backend
        try {
            const response = await fetch(`/api/contracts/risk-analysis/${contractId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success && data.analysis) {
                riskAnalysisData = data.analysis;
                displayRiskAnalysis(data.analysis);
            } else {
                showDefaultRiskAnalysis();
            }
        } catch (error) {
            console.error('Error fetching risk analysis:', error);
            showDefaultRiskAnalysis();
        }
    }

    function displayRiskAnalysis(analysis) {
        const content = document.getElementById('riskAnalysisContent');
        content.innerHTML = `
        <div class="risk-summary">
            <div class="risk-stat high">
                <div class="risk-stat-value">${analysis.high_risks || 0}</div>
                <div class="risk-stat-label">High Risk</div>
            </div>
            <div class="risk-stat medium">
                <div class="risk-stat-value">${analysis.medium_risks || 0}</div>
                <div class="risk-stat-label">Medium Risk</div>
            </div>
            <div class="risk-stat low">
                <div class="risk-stat-value">${analysis.low_risks || 0}</div>
                <div class="risk-stat-label">Low Risk</div>
            </div>
            <div class="risk-stat">
                <div class="risk-stat-value" style="color: var(--primary-color);">${analysis.overall_score || 0}</div>
                <div class="risk-stat-label">Overall Score</div>
            </div>
        </div>
        
        <div style="margin-top: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">Detailed Risk Analysis</h4>
            ${(analysis.risk_items || []).map(risk => `
                <div class="risk-item" style="background: white; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; overflow: hidden;">
                    <div class="risk-item-header" onclick="toggleRiskItem(this)" style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: var(--background-light);">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ti ti-alert-triangle"></i>
                            <span>${risk.issue}</span>
                        </div>
                        <span class="severity-badge ${risk.severity}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background: ${risk.severity === 'high' ? 'var(--danger-bg)' : risk.severity === 'medium' ? 'var(--warning-bg)' : 'var(--success-bg)'}; color: ${risk.severity === 'high' ? 'var(--danger-color)' : risk.severity === 'medium' ? 'var(--warning-color)' : 'var(--success-color)'};">
                            ${risk.severity}
                        </span>
                    </div>
                    <div class="risk-item-content" style="padding: 1.25rem; display: none;">
                        <p style="margin-bottom: 1rem; color: var(--text-muted);">
                            ${risk.description}
                        </p>
                        <div style="background: var(--background-light); padding: 1rem; border-radius: 6px; border-left: 4px solid var(--primary-color); margin-bottom: 1rem;">
                            <strong>${risk.clause_reference}:</strong> ${risk.recommendation}
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="viewClauseSuggestions('${risk.type}')">
                                <i class="ti ti-sparkles"></i> View AI Suggestions
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    }

    function showDefaultRiskAnalysis() {
        displayRiskAnalysis({
            overall_score: 72,
            high_risks: 2,
            medium_risks: 3,
            low_risks: 5,
            risk_items: [
                {
                    type: "termination",
                    severity: "high",
                    score: 85,
                    issue: "Unilateral termination rights",
                    description: "The counterparty has the right to terminate without cause with only 30 days notice.",
                    clause_reference: "Clause 4.2",
                    recommendation: "Consider adding mutual termination rights with 90 days notice"
                }
            ]
        });
    }


    function initiateLiveNegotiation() {
        closeModal('negotiationModal');
        setTimeout(() => openModal('liveNegotiationModal'), 300);
    }


    // Negotiation Functions
    function generateRiskSummary() {
        closeModal('negotiationModal');
        setTimeout(() => openModal('riskSummaryModal'), 300);
    }


    // Simplified modal opening
    function initiateLiveNegotiation() {
        console.log('Opening live negotiation modal');
        closeModal('negotiationModal');
        setTimeout(() => {
            openModal('liveNegotiationModal');
            // Focus input after modal opens
            setTimeout(() => {
                const input = document.getElementById('messageInput');
                if (input) {
                    input.focus();
                    console.log('Input focused');
                }
            }, 300);
        }, 300);
    }

    function downloadRiskReport() {
        showNotification('Downloading AI risk analysis report...', 'success');
    }


    function proceedWithNegotiation() {
        closeModal('riskSummaryModal');
        setTimeout(() => openModal('liveNegotiationModal'), 300);
    }


    // FIXED Chat Functions - Direct and Simple
    function sendMessage() {
        console.log('sendMessage called - direct function');

        const input = document.getElementById('messageInput');
        const messagesArea = document.getElementById('chatMessages');

        console.log('Elements found:', {
            input: !!input,
            inputValue: input ? input.value : 'N/A',
            messagesArea: !!messagesArea
        });

        if (!input || !messagesArea) {
            console.error('Required elements not found');
            showNotification('Chat elements not found. Please try refreshing.', 'success');

            return;
        }

        const message = input.value.trim();
        if (!message) {
            console.log('Empty message');
            input.focus();
            return;
        }

        console.log('Processing message:', message);

        // Add user message immediately
        addModernMessage('You', message, 'user');

        // Clear input
        input.value = '';
        input.focus();

        // Show typing and respond
        showModernTypingIndicator();

        setTimeout(() => {
            hideModernTypingIndicator();
            const response = generateSmartResponse(message);
            addModernMessage('Contract Initiator', response, 'initiator');
        }, 1000);

        console.log('Message processing complete');
    }

    // Direct click handler for send button
    function handleSendClick() {
        console.log('Send button clicked');
        sendMessage();
    }

    // Direct keypress handler for input
    function handleInputKeypress(event) {
        console.log('Key pressed in input:', event.key);
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    }


    let currentAnalysisData = null; // Store complete analysis
    let clauseReplacementMap = new Map(); // Track replacements


    async function openClauseAnalysisModal() {
        console.log(' Starting full contract clause analysis...');

        // Get the full contract content from the editor
        const contractEditor = document.getElementById('contractContent') ||
            document.getElementById('contractContentEditor') ||
            document.querySelector('.editor-paper[contenteditable="true"]');

        if (!contractEditor) {
            showNotification('Contract editor not found', 'error');
            return;
        }

        // Get the full content (innerText for plain text, preserving structure)
        let fullContent = contractEditor.innerText || contractEditor.textContent || '';
        fullContent = fullContent.trim();

        // Validate we have content
        if (!fullContent || fullContent.length < 50) {
            showNotification('Please add contract content before analyzing clauses', 'warning');
            return;
        }

        console.log(` Analyzing full contract content (${fullContent.length} characters)`);

        // Show loading state and open modal
        openModal('clauseSuggestionModal');

        // Show loading indicator in the modal
        const container = document.getElementById('clauseSuggestionContent');
        container.innerHTML = `
        <div style="text-align: center; padding: 3rem;">
            <div class="ai-loader"></div>
            <p style="margin-top: 1.5rem; color: var(--text-muted); font-size: 1.1rem;">
                <i class="ti ti-sparkles"></i> AI is analyzing all clauses in your contract...
            </p>
            <p style="color: var(--text-muted); font-size: 0.9rem;">
                This may take 10-20 seconds depending on contract length
            </p>
        </div>
    `;

        try {
            showLoader('AI is analyzing all clauses in your contract...');

            const language = generationParams?.language || 'en';

            // Call the new full contract analysis endpoint
            const response = await fetch('/api/contracts/analyze-full-contract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    contract_text: fullContent,
                    contract_id: contractId,
                    language: language
                })
            });

            hideLoader();

            if (!response.ok) {
                throw new Error('Failed to analyze contract clauses');
            }

            const data = await response.json();

            if (data.success && data.clauses_identified && data.clauses_identified.length > 0) {
                // Store analysis data globally for later use
                currentAnalysisData = data;
                clauseReplacementMap.clear(); // Reset replacement tracking

                // Display the comprehensive clause analysis
                displayFullClauseAnalysis(data);
            } else {
                closeModal('clauseSuggestionModal');
                showNotification('No clauses could be identified in the contract. Please ensure the contract has proper content.', 'warning');
            }

        } catch (error) {
            console.error('Error analyzing contract clauses:', error);
            hideLoader();
            closeModal('clauseSuggestionModal');
            showNotification('Failed to analyze contract clauses. Please try again or contact support.', 'error');
        }
    }

    function displayFullClauseAnalysis(analysisData) {
        const container = document.getElementById('clauseSuggestionContent');
        const clauses = analysisData.clauses_identified || [];
        const totalClauses = clauses.length;

        let html = `
        <!-- Header Section -->
        <div style="background: linear-gradient(135deg, var(--primary-color) 0%, #1e4d8b 100%); 
                    color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="ti ti-file-analytics"></i>
                        Contract Clause Analysis Report
                    </h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">
                        ${totalClauses} clause${totalClauses !== 1 ? 's' : ''} identified and analyzed
                    </p>
                </div>
               
            </div>
        </div>
        
        <!-- Overall Assessment -->
        ${analysisData.overall_assessment ? `
        <div style="background: var(--background-light); padding: 1.25rem; border-radius: 10px; 
                    border-left: 4px solid var(--info-color); margin-bottom: 1.5rem;">
            <h5 style="margin: 0 0 0.75rem 0; color: var(--text-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="ti ti-info-circle"></i> Overall Assessment
            </h5>
            <p style="margin: 0; color: var(--text-muted); line-height: 1.6;">
                ${escapeHtml(analysisData.overall_assessment)}
            </p>
        </div>
        ` : ''}
        
        <!-- Missing Clauses Alert -->
        ${analysisData.missing_clauses && analysisData.missing_clauses.length > 0 ? `
        <div style="background: #fff3cd; padding: 1.25rem; border-radius: 10px; 
                    border-left: 4px solid #ffc107; margin-bottom: 1.5rem;">
            <h5 style="margin: 0 0 0.75rem 0; color: #856404; display: flex; align-items: center; gap: 0.5rem;">
                <i class="ti ti-alert-triangle"></i> Recommended Additions
            </h5>
            <ul style="margin: 0; padding-left: 1.5rem; color: #856404;">
                ${analysisData.missing_clauses.map(clause => `<li>${escapeHtml(clause)}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        <h4 style="margin: 0 0 1.25rem 0; color: var(--text-color);">
            <i class="ti ti-list-details"></i> Identified Clauses & Suggestions
        </h4>
        
        <div style="display: flex; flex-direction: column; gap: 1.5rem;" id="clausesContainer">
    `;

        // Add each clause
        clauses.forEach((clause, index) => {
            const riskColor = {
                'low': 'var(--success-color)',
                'medium': 'var(--warning-color)',
                'high': 'var(--danger-color)'
            }[clause.risk_level.toLowerCase()] || 'var(--info-color)';

            const riskBgColor = {
                'low': 'var(--success-bg)',
                'medium': 'var(--warning-bg)',
                'high': 'var(--danger-bg)'
            }[clause.risk_level.toLowerCase()] || 'var(--info-bg)';

            const isReplaced = clauseReplacementMap.has(index);

            html += `
            <div id="clause-item-${index}" style="background: ${isReplaced ? '#e8f5e9' : 'white'}; 
                     border: 2px solid ${isReplaced ? '#4caf50' : '#e9ecef'}; 
                     border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
                
                ${isReplaced ? `
                <div style="background: #4caf50; color: white; padding: 0.5rem 1rem; 
                            border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-check"></i>
                    <strong>Suggestion Applied</strong>
                </div>
                ` : ''}
                
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <h5 style="margin: 0; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="ti ti-file-text"></i> ${escapeHtml(clause.clause_name)}
                    </h5>
                    <div style="display: flex; gap: 0.75rem;">
                        <span style="background: ${riskBgColor}; color: ${riskColor}; 
                                     padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                            ${clause.risk_level.toUpperCase()} RISK
                        </span>
                        <span style="background: var(--info-bg); color: var(--info-color); 
                                     padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                            ${clause.current_score}/5
                        </span>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600;">
                        <i class="ti ti-file-description"></i> CURRENT TEXT:
                    </div>
                    <p style="margin: 0; line-height: 1.6; font-size: 0.95rem;">
                        ${escapeHtml(clause.clause_text)}
                    </p>
                </div>
                
                ${clause.suggestions && clause.suggestions.length > 0 ? `
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">
                        <i class="ti ti-bulb"></i> AI SUGGESTIONS:
                    </div>
                    <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                        ${clause.suggestions.map(sug => `<li>${escapeHtml(sug)}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                ${clause.improved_version && clause.improved_version !== 'AI analysis unavailable - legal review recommended' ? `
                <div style="background: rgba(39, 98, 203, 0.05); padding: 1rem; border-radius: 8px; 
                            border-left: 3px solid var(--primary-color); margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; color: var(--primary-color); margin-bottom: 0.75rem; font-weight: 600;">
                        <i class="ti ti-sparkles"></i> SUGGESTED IMPROVED VERSION:
                    </div>
                    <p style="margin: 0; line-height: 1.6; font-size: 0.95rem;">
                        ${escapeHtml(clause.improved_version)}
                    </p>
                </div>
                ` : ''}
                
                ${clause.compliance_note ? `
                <div style="background: var(--success-bg); padding: 0.85rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.85rem; color: var(--success-color); font-weight: 600;">
                        <i class="ti ti-shield-check"></i> Qatar Law Compliance:
                    </div>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                        ${escapeHtml(clause.compliance_note)}
                    </p>
                </div>
                ` : ''}
                
              
            </div>
        `;
        });

        html += `
        </div>
        
        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e9ecef; 
                    display: flex; gap: 1rem; justify-content: space-between;">
            <button class="btn btn-outline-secondary" onclick="closeModal('clauseSuggestionModal')">
                <i class="ti ti-x"></i> Close
            </button>
            <div style="display: flex; gap: 0.75rem;">
                <button class="btn btn-outline-primary" onclick="downloadClauseAnalysis()">
                    <i class="ti ti-download"></i> Download Report
                </button>
                <button class="btn btn-primary" onclick="applyAllSuggestions()">
                    <i class="ti ti-checks"></i> Apply All Suggestions
                </button>
            </div>
        </div>
    `;

        container.innerHTML = html;
    }


    async function acceptClauseSuggestion(index, clauseName, improvedVersion, originalText) {
        if (!improvedVersion || improvedVersion === 'AI analysis unavailable - legal review recommended') {
            showNotification('No improved version available for this clause', 'warning');
            return;
        }

        try {
            const editor = document.getElementById('contractContent') ||
                document.getElementById('contractContentEditor') ||
                document.querySelector('.editor-paper[contenteditable="true"]');

            if (!editor) {
                showNotification('Contract editor not found', 'error');
                return;
            }

            showLoader(`Applying ${clauseName} suggestion...`);

            const applied = applyClauseReplacement(editor, originalText, improvedVersion, clauseName);

            hideLoader();

            if (applied) {
                clauseReplacementMap.set(index, {
                    originalText: originalText,
                    improvedVersion: improvedVersion,
                    clauseName: clauseName
                });

                const clauseItem = document.getElementById(`clause-item-${index}`);
                if (clauseItem) {
                    clauseItem.style.background = '#f0f0f0';
                    const buttonContainer = clauseItem.querySelector('div[style*="display: flex"]');
                    if (buttonContainer) {
                        buttonContainer.innerHTML = `
                        <div style="padding: 0.75rem; text-align: center;">
                            <i class="ti ti-check"></i> Applied to Contract
                        </div>
                    `;
                    }
                }

                showNotification(`${clauseName} suggestion applied`, 'success');

                if (typeof autoSaveContract === 'function') {
                    setTimeout(() => autoSaveContract(), 500);
                }
            }

        } catch (error) {
            hideLoader();
            console.error('Error accepting clause suggestion:', error);
            showNotification('Failed to apply suggestion', 'error');
        }
    }




    // =====================================================
    // EDIT CLAUSE MANUALLY
    // =====================================================

    function editClauseManually(index, clauseName) {
        try {
            closeModal('clauseSuggestionModal');

            const editor = document.getElementById('contractContent') ||
                document.getElementById('contractContentEditor') ||
                document.querySelector('.editor-paper[contenteditable="true"]');

            if (editor) {
                editor.focus();

                // Try to scroll to the clause if we can find it
                const plainContent = editor.innerText || editor.textContent || '';
                const headingPattern = new RegExp(escapeRegex(clauseName), 'i');
                const match = plainContent.match(headingPattern);

                if (match) {
                    // Scroll to approximate position
                    editor.scrollTop = editor.scrollTop + (match.index / plainContent.length) * editor.scrollHeight;
                }
            }

            showNotification(`Please locate and edit "${clauseName}" clause manually`, 'info');

        } catch (error) {
            console.error('Error in manual edit:', error);
            showNotification('Please edit the clause manually in the contract', 'info');
        }
    }



    // =====================================================
    // SKIP CLAUSE SUGGESTION
    // =====================================================
    function skipClauseSuggestion(index) {
        const clauseItem = document.getElementById(`clause-item-${index}`);
        if (clauseItem) {
            clauseItem.style.opacity = '0.5';
            clauseItem.style.filter = 'grayscale(100%)';
        }
        showNotification('Suggestion skipped', 'info');
    }


    async function applyAllSuggestions() {
        if (!currentAnalysisData || !currentAnalysisData.clauses_identified) {
            showNotification('No analysis data available', 'error');
            return;
        }

        const clauses = currentAnalysisData.clauses_identified;
        let appliedCount = 0;
        let skippedCount = 0;

        showLoader('Applying all suggestions...');

        try {
            const editor = document.getElementById('contractContent') ||
                document.getElementById('contractContentEditor') ||
                document.querySelector('.editor-paper[contenteditable="true"]');

            if (!editor) {
                throw new Error('Contract editor not found');
            }

            for (let index = 0; index < clauses.length; index++) {
                const clause = clauses[index];

                if (clauseReplacementMap.has(index)) {
                    continue;
                }

                const improvedVersion = clause.improved_version;
                const originalText = clause.clause_text;
                const clauseName = clause.clause_name;

                if (!improvedVersion || improvedVersion === 'AI analysis unavailable - legal review recommended') {
                    skippedCount++;
                    continue;
                }

                const applied = applyClauseReplacement(editor, originalText, improvedVersion, clauseName);

                if (applied) {
                    clauseReplacementMap.set(index, {
                        originalText: originalText,
                        improvedVersion: improvedVersion,
                        clauseName: clauseName
                    });
                    appliedCount++;

                    const clauseItem = document.getElementById(`clause-item-${index}`);
                    if (clauseItem) {
                        clauseItem.style.background = '#f0f0f0';
                    }
                } else {
                    skippedCount++;
                }

                if (index % 3 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            hideLoader();
            closeModal('clauseSuggestionModal');

            let message = `Applied ${appliedCount} suggestion(s).`;
            if (skippedCount > 0) {
                message += ` Skipped ${skippedCount}.`;
            }

            showNotification(message, appliedCount > 0 ? 'success' : 'warning');

            if (appliedCount > 0 && typeof autoSaveContract === 'function') {
                setTimeout(() => autoSaveContract(), 1000);
            }

        } catch (error) {
            hideLoader();
            console.error('Error applying suggestions:', error);
            showNotification('Failed to apply suggestions', 'error');
        }
    }




    function applyClauseReplacement(editor, originalText, improvedVersion, clauseName) {
        try {
            let content = editor.innerHTML;
            const plainContent = editor.innerText || editor.textContent || '';

            console.log(`Applying: ${clauseName}`);

            // STRATEGY 1: Find by heading
            const headingPatterns = [
                new RegExp(`\\b(Article|Section|Clause)?\\s*\\d+\\.?\\s*${escapeRegex(clauseName)}`, 'i'),
                new RegExp(`\\b${escapeRegex(clauseName)}\\b`, 'i'),
                new RegExp(`${escapeRegex(clauseName)}\\s*:`, 'i'),
                new RegExp(`\\d+\\.\\d+\\s+${escapeRegex(clauseName)}`, 'i'),
                new RegExp(`\\d*\\.?\\s*${escapeRegex(clauseName.toUpperCase())}`, 'i')
            ];

            for (let pattern of headingPatterns) {
                const match = plainContent.match(pattern);
                if (match) {
                    console.log(`Found heading: "${match[0]}"`);

                    // Extract the actual clause content after the heading
                    const actualContent = extractClauseContent(plainContent, match[0], match.index);

                    if (actualContent) {
                        // Find and replace the actual clause content with strikethrough + improved version
                        const contentToReplace = escapeRegex(actualContent);
                        const replaceRegex = new RegExp(contentToReplace, 'i');

                        if (replaceRegex.test(content)) {
                            content = content.replace(replaceRegex, () => {
                                return createSimpleReplacement(actualContent, improvedVersion);
                            });

                            editor.innerHTML = content;
                            console.log(`Applied after heading`);
                            return true;
                        }
                    }

                    // If content extraction failed, insert after heading
                    const headingRegex = new RegExp(escapeRegex(match[0]), 'gi');
                    if (headingRegex.test(content)) {
                        content = content.replace(headingRegex, (matched) => {
                            return matched + '\n\n' + createSimpleReplacement(originalText, improvedVersion);
                        });

                        editor.innerHTML = content;
                        console.log(`Applied after heading (fallback)`);
                        return true;
                    }
                }
            }

            console.log(`Heading not found, trying content match...`);

            // STRATEGY 2: Try to find the actual clause content
            const searchText = originalText.trim().substring(0, Math.min(200, originalText.length));
            const normalizedSearch = searchText.replace(/\s+/g, ' ');
            const normalizedContent = plainContent.replace(/\s+/g, ' ');

            if (normalizedContent.includes(normalizedSearch)) {
                console.log(`Found content match`);

                const searchRegex = new RegExp(escapeRegex(searchText).replace(/\s+/g, '\\s+'), 'i');

                if (searchRegex.test(content)) {
                    content = content.replace(searchRegex, (matched) => {
                        return createSimpleReplacement(matched, improvedVersion);
                    });

                    editor.innerHTML = content;
                    console.log(`Applied via content match`);
                    return true;
                }
            }

            // STRATEGY 3: Append at end if not found
            console.log(`Adding at end of document`);
            editor.innerHTML += '\n\n' + createSimpleReplacement(originalText, improvedVersion);
            return true;

        } catch (error) {
            console.error('Error:', error);
            return false;
        }
    }




    function applyClauseWithTrackChanges(editor, originalText, improvedVersion, clauseName) {
        try {
            let content = editor.innerHTML;
            const plainContent = editor.innerText || editor.textContent || '';

            console.log(` Applying: ${clauseName}`);

            // STRATEGY 1: Find by clause heading/title
            const headingPatterns = [
                new RegExp(`\\b(Article|Section|Clause)?\\s*\\d+\\.?\\s*${escapeRegex(clauseName)}`, 'i'),
                new RegExp(`\\b${escapeRegex(clauseName)}\\b`, 'i'),
                new RegExp(`${escapeRegex(clauseName)}\\s*:`, 'i'),
                new RegExp(`\\d+\\.\\d+\\s+${escapeRegex(clauseName)}`, 'i'),
                new RegExp(`\\d*\\.?\\s*${escapeRegex(clauseName.toUpperCase())}`, 'i')
            ];

            for (let pattern of headingPatterns) {
                const match = plainContent.match(pattern);
                if (match) {
                    console.log(` Found heading: "${match[0]}"`);

                    const actualClauseContent = extractClauseContent(plainContent, match[0], match.index);
                    const headingRegex = new RegExp(escapeRegex(match[0]), 'gi');

                    if (headingRegex.test(content)) {
                        content = content.replace(headingRegex, (matched) => {
                            const displayOriginal = actualClauseContent || originalText;
                            return matched + '\n' + createTrackChangesMarkup(displayOriginal, improvedVersion, clauseName, true);
                        });

                        editor.innerHTML = content;
                        console.log(` Applied in-place`);
                        return true;
                    }
                }
            }

            console.log(` Heading not found, trying content search...`);

            // STRATEGY 2: Content-based matching
            const searchText = originalText.trim().substring(0, Math.min(150, originalText.length));
            const normalizedSearch = searchText.replace(/\s+/g, ' ');
            const normalizedContent = plainContent.replace(/\s+/g, ' ');

            if (normalizedContent.includes(normalizedSearch)) {
                console.log(` Found content match`);

                const searchRegex = new RegExp(escapeRegex(searchText).replace(/\s+/g, '\\s+'), 'i');

                if (searchRegex.test(content)) {
                    content = content.replace(searchRegex, (matched) => {
                        return createTrackChangesMarkup(originalText, improvedVersion, clauseName, true);
                    });

                    editor.innerHTML = content;
                    console.log(` Applied via content`);
                    return true;
                }
            }

            // STRATEGY 3: Add as proposal at end
            console.log(` Adding as proposal at end`);
            editor.innerHTML += createTrackChangesMarkup(originalText, improvedVersion, clauseName, false);
            return true;

        } catch (error) {
            console.error(' Error:', error);
            return false;
        }
    }


    /**
     * Extract actual clause content from contract (between headings)
     */

    function extractClauseContent(plainText, headingText, headingIndex) {
        try {
            const startPos = headingIndex + headingText.length;

            // Find next heading
            const nextHeadingPattern = /\n\s*(Article|Section|Clause|\d+\.)\s+[A-Z]/g;
            nextHeadingPattern.lastIndex = startPos;

            const nextMatch = nextHeadingPattern.exec(plainText);
            const endPos = nextMatch ? nextMatch.index : Math.min(startPos + 1000, plainText.length);

            let content = plainText.substring(startPos, endPos).trim();

            if (content.length > 1000) {
                content = content.substring(0, 1000);
            }

            return content.length > 50 ? content : null;

        } catch (error) {
            return null;
        }
    }



    function createSimpleReplacement(originalText, improvedVersion) {
        return `<p style="text-decoration: line-through; margin: 0.5rem 0;">${escapeHtml(originalText)}</p>
<p style="margin: 0.5rem 0;">${escapeHtml(improvedVersion)}</p>`;
    }




    /**
     * Create HTML markup for track changes
     */
    function createTrackChangesMarkup(originalText, improvedVersion, clauseName, foundInPlace = true) {
        if (foundInPlace) {
            return `
<div style="margin: 1.5rem 0; padding: 1.25rem; background: #f8f9fa; border-left: 4px solid #28a745; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed #dee2e6;">
        <div style="font-size: 0.8rem; color: #dc3545; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
            <i class="ti ti-x"></i> Replaced
        </div>
        <p style="margin: 0; text-decoration: line-through; color: #6c757d; opacity: 0.6; line-height: 1.6; font-size: 0.9rem; font-style: italic;">
            ${escapeHtml(originalText)}
        </p>
    </div>

    <div style="background: linear-gradient(to right, #e8f5e9, #f1f8f4); padding: 1rem; border-radius: 6px; border-left: 3px solid #28a745;">
        <div style="font-size: 0.8rem; color: #28a745; font-weight: 700; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 0.5rem;">
            <i class="ti ti-sparkles" style="font-size: 1rem;"></i> 
            <span>Improved Version</span>
        </div>
        <p style="margin: 0; line-height: 1.7; font-size: 0.95rem; color: #1a1a1a; font-weight: 500;">
            ${escapeHtml(improvedVersion)}
        </p>
    </div>

    <div style="margin-top: 0.75rem; font-size: 0.7rem; color: #6c757d; text-align: right; display: flex; justify-content: space-between; align-items: center;">
        <span style="background: #e8f5e9; padding: 0.25rem 0.5rem; border-radius: 4px; color: #28a745; font-weight: 600;">
            <i class="ti ti-check"></i> AI Suggestion Applied
        </span>
        <span><i class="ti ti-clock"></i> ${new Date().toLocaleString()}</span>
    </div>
</div>`;
        } else {
            return `
<div style="margin: 2rem 0; padding: 1.5rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div style="font-size: 1rem; color: #856404; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
        <i class="ti ti-alert-triangle"></i> 
        <span>PROPOSED CHANGE - ${escapeHtml(clauseName)}</span>
    </div>
    
    <div style="background: #fff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #dc3545;">
        <div style="font-size: 0.85rem; color: #dc3545; font-weight: 600; margin-bottom: 0.5rem;">
            <i class="ti ti-file-text"></i> Current Version (Summary):
        </div>
        <p style="margin: 0; color: #6c757d; line-height: 1.6; font-size: 0.9rem; font-style: italic;">
            ${escapeHtml(originalText.substring(0, 300))}${originalText.length > 300 ? '...' : ''}
        </p>
    </div>

    <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; border-left: 3px solid #28a745;">
        <div style="font-size: 0.85rem; color: #28a745; font-weight: 600; margin-bottom: 0.5rem;">
            <i class="ti ti-sparkles"></i> Proposed Improved Version:
        </div>
        <p style="margin: 0; line-height: 1.6; font-size: 0.95rem; color: #1a1a1a; font-weight: 500;">
            ${escapeHtml(improvedVersion)}
        </p>
    </div>

    <div style="margin-top: 1rem; padding: 0.75rem; background: #fff; border-radius: 6px; border: 1px dashed #ffc107;">
        <p style="margin: 0; font-size: 0.85rem; color: #856404;">
            <i class="ti ti-info-circle"></i> <strong>Action Required:</strong> Please locate the "<strong>${escapeHtml(clauseName)}</strong>" section in your contract above and replace it with this improved version.
        </p>
    </div>

    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #6c757d; text-align: right;">
        <i class="ti ti-clock"></i> Suggested: ${new Date().toLocaleString()}
    </div>
</div>`;
        }
    }




    function escapeRegex(text) {
        return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }


    /**
     * Replace text in text nodes
     */
    function replaceInTextNodes(element, searchText, replaceFn) {
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );

        const nodes = [];
        let node;

        while (node = walker.nextNode()) {
            const normalizedText = node.textContent.replace(/\s+/g, ' ');
            if (normalizedText.includes(searchText)) {
                nodes.push(node);
            }
        }

        nodes.forEach(node => {
            replaceFn(node, node.textContent);
        });
    }

    /**
     * Find text node containing specific text
     */
    function findTextNode(element, searchText) {
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );

        let node;
        while (node = walker.nextNode()) {
            const normalizedText = node.textContent.replace(/\s+/g, ' ');
            if (normalizedText.includes(searchText)) {
                return node;
            }
        }

        return null;
    }


    async function downloadClauseAnalysis() {
        if (!currentAnalysisData || !currentAnalysisData.clauses_identified) {
            showNotification('No analysis data to download', 'error');
            return;
        }

        showLoader('Generating clause analysis report...');

        try {
            const clauses = currentAnalysisData.clauses_identified;
            const contractTitle = document.querySelector('h1')?.textContent || 'Contract';
            const currentDate = new Date().toLocaleDateString('en-GB');

            // Generate HTML report
            let htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Clause Analysis Report - ${escapeHtml(contractTitle)}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            color: #333;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #2762cb 0%, #1e4d8b 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }
        .header p {
            margin: 0;
            opacity: 0.9;
        }
        .info-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #2762cb;
        }
        .clause-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        .clause-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .clause-title {
            color: #2762cb;
            font-size: 1.3em;
            font-weight: 600;
            margin: 0;
        }
        .badges {
            display: flex;
            gap: 10px;
        }
        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-low { background: #d4edda; color: #155724; }
        .badge-medium { background: #fff3cd; color: #856404; }
        .badge-high { background: #f8d7da; color: #721c24; }
        .badge-score { background: #d1ecf1; color: #0c5460; }
        .section {
            margin-bottom: 20px;
        }
        .section-title {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .current-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .improved-text {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #4caf50;
            font-size: 0.95em;
        }
        .suggestions {
            list-style-type: none;
            padding-left: 0;
        }
        .suggestions li {
            padding: 8px 0 8px 25px;
            position: relative;
        }
        .suggestions li:before {
            content: "";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }
        .compliance {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #2e7d32;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            text-align: center;
            color: #666;
            font-size: 0.85em;
        }
        @media print {
            body { padding: 20px; }
            .clause-item { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1> Contract Clause Analysis Report</h1>
        <p><strong>Contract:</strong> ${escapeHtml(contractTitle)}</p>
        <p><strong>Analysis Date:</strong> ${currentDate}</p>
        <p><strong>Clauses Analyzed:</strong> ${clauses.length}</p>
        <p><strong>AI Engine:</strong> ${currentAnalysisData.ai_powered ? 'Claude AI' : 'Pattern Matching'}</p>
    </div>
    
    ${currentAnalysisData.overall_assessment ? `
    <div class="info-box">
        <h3 style="margin-top: 0;">Overall Assessment</h3>
        <p>${escapeHtml(currentAnalysisData.overall_assessment)}</p>
    </div>
    ` : ''}
    
    ${currentAnalysisData.missing_clauses && currentAnalysisData.missing_clauses.length > 0 ? `
    <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="margin-top: 0; color: #856404;"> Recommended Clause Additions</h3>
        <ul>
            ${currentAnalysisData.missing_clauses.map(c => `<li>${escapeHtml(c)}</li>`).join('')}
        </ul>
    </div>
    ` : ''}
    
    <h2>Detailed Clause Analysis</h2>
`;

            // Add each clause analysis
            clauses.forEach((clause, index) => {
                const riskClass = `badge-${clause.risk_level.toLowerCase()}`;

                htmlContent += `
    <div class="clause-item">
        <div class="clause-header">
            <h3 class="clause-title">${index + 1}. ${escapeHtml(clause.clause_name)}</h3>
            <div class="badges">
                <span class="badge ${riskClass}">${clause.risk_level.toUpperCase()} RISK</span>
                <span class="badge badge-score">Score: ${clause.current_score}/5</span>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Current Clause Text</div>
            <div class="current-text">${escapeHtml(clause.clause_text)}</div>
        </div>
        
        ${clause.suggestions && clause.suggestions.length > 0 ? `
        <div class="section">
            <div class="section-title">AI Recommendations</div>
            <ul class="suggestions">
                ${clause.suggestions.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${clause.improved_version && clause.improved_version !== 'AI analysis unavailable - legal review recommended' ? `
        <div class="section">
            <div class="section-title">Suggested Improved Version</div>
            <div class="improved-text">${escapeHtml(clause.improved_version)}</div>
        </div>
        ` : ''}
        
        ${clause.compliance_note ? `
        <div class="section">
            <div class="section-title">Qatar Law Compliance</div>
            <div class="compliance">
                <strong> Compliance Note:</strong> ${escapeHtml(clause.compliance_note)}
            </div>
        </div>
        ` : ''}
    </div>
`;
            });

            htmlContent += `
    <div class="footer">
        <p><strong>Generated by CALIM 360 Smart CLM</strong></p>
        <p>This AI-powered analysis is for reference purposes only. Please consult with legal counsel for final review.</p>
        <p> ${new Date().getFullYear()} CALIM 360. All rights reserved.</p>
    </div>
</body>
</html>
`;

            // Create blob and download
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Clause_Analysis_Report_${contractTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            hideLoader();
            showNotification('Clause analysis report downloaded successfully!', 'success');

        } catch (error) {
            hideLoader();
            console.error('Error generating report:', error);
            showNotification('Failed to generate report. Please try again.', 'error');
        }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    let selectedSuggestionIndex = 0;
    function selectSuggestion(index) {
        selectedSuggestionIndex = index;
        // Update UI to show selection
        document.querySelectorAll('#clauseSuggestionContent > div:last-child > div').forEach((el, idx) => {
            el.style.background = idx === index ? 'rgba(39, 98, 203, 0.1)' : 'rgba(39, 98, 203, 0.05)';
        });
    }

    function acceptSuggestion() {
        if (!window.currentSuggestions || !window.currentSuggestions[selectedSuggestionIndex]) {
            showNotification('No suggestion selected', 'warning');
            return;
        }

        const suggestion = window.currentSuggestions[selectedSuggestionIndex];

        if (!currentClauseText) {
            showNotification('No clause text to replace', 'warning');
            return;
        }

        try {
            const content = document.getElementById('contractContent');

            if (!content) {
                throw new Error('Contract editor not found');
            }

            console.log(' Looking for text:', currentClauseText);
            console.log(' Replacing with:', suggestion.suggested);

            //  METHOD 1: Try direct innerHTML replacement first
            let originalContent = content.innerHTML;
            let plainOriginal = content.innerText || content.textContent || '';

            // Check if the text exists in plain text form
            if (!plainOriginal.includes(currentClauseText)) {
                console.error(' Text not found in plain content');
                console.log('Expected:', currentClauseText);
                console.log('Available:', plainOriginal.substring(0, 200) + '...');
                showNotification('Could not find the original text to replace', 'error');
                return;
            }

            //  METHOD 2: Try simple string replacement (handles HTML tags)
            let newContent = originalContent.replace(currentClauseText, suggestion.suggested);

            // If simple replacement didn't work, try with normalized whitespace
            if (newContent === originalContent) {
                console.log(' Simple replacement failed, trying normalized...');

                // Normalize both strings (remove extra whitespace, trim)
                const normalizedClause = currentClauseText.trim().replace(/\s+/g, ' ');
                const normalizedContent = originalContent.replace(/\s+/g, ' ');

                newContent = normalizedContent.replace(normalizedClause, suggestion.suggested);

                // Restore original whitespace structure somewhat
                if (newContent !== normalizedContent) {
                    // Replacement worked with normalized text
                    originalContent = normalizedContent;
                }
            }

            // If still no change, try regex with escaped characters
            if (newContent === originalContent) {
                console.log(' Normalized replacement failed, trying regex...');

                // Escape special characters for regex
                const escapedText = currentClauseText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(escapedText, 'i'); // case insensitive

                newContent = originalContent.replace(regex, suggestion.suggested);
            }

            //  METHOD 3: Last resort - replace in the visible text area
            if (newContent === originalContent) {
                console.log(' All replacements failed, trying innerText...');

                let textContent = content.innerText || content.textContent || '';

                if (textContent.includes(currentClauseText)) {
                    // Replace in plain text
                    textContent = textContent.replace(currentClauseText, suggestion.suggested);

                    // Update as plain text (will lose formatting but works)
                    content.innerText = textContent;
                    newContent = content.innerHTML; // Get the updated HTML

                    console.log(' Applied via innerText');
                } else {
                    throw new Error('Text not found in any format');
                }
            }

            //  Apply the changes
            content.innerHTML = newContent;

            //  Force browser to recognize the change
            content.dispatchEvent(new Event('input', { bubbles: true }));
            content.dispatchEvent(new Event('change', { bubbles: true }));

            //  Verify by checking if the NEW text exists (not the old text)
            const verifyContent = content.innerText || content.textContent || '';
            const suggestionExists = verifyContent.includes(suggestion.suggested);
            const originalGone = !verifyContent.includes(currentClauseText);

            console.log('Verification:', {
                suggestionExists,
                originalGone,
                newTextSnippet: verifyContent.substring(0, 100)
            });

            if (suggestionExists || originalGone) {
                console.log(' Suggestion applied successfully');

                // Scroll to show the change
                content.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Track this change
                if (trackChangesEnabled && typeof trackChange === 'function') {
                    trackChange('ai_suggestion', currentClauseText, suggestion.suggested);
                }

                // Mark as modified
                if (typeof markAsDirty === 'function') {
                    markAsDirty();
                }

                showNotification(' AI suggestion applied successfully', 'success');

                // Save draft after applying suggestion
                saveAsDraft();

                // Close modal
                setTimeout(() => {
                    closeModal('clauseSuggestionModal');
                }, 500);

            } else {
                // Still failed - show what we tried
                console.error(' Verification failed');
                console.log('Original text:', currentClauseText);
                console.log('Replacement text:', suggestion.suggested);
                console.log('Current content snippet:', verifyContent.substring(0, 200));

                throw new Error('Could not verify the replacement was applied');
            }

        } catch (error) {
            console.error(' Error applying suggestion:', error);
            showNotification('Failed to apply suggestion: ' + error.message, 'error');

            // Offer alternative
            setTimeout(() => {
                if (confirm('Would you like to copy the suggestion to clipboard instead?')) {
                    copyToClipboard(suggestion.suggested);
                    showNotification('Suggestion copied to clipboard', 'info');
                }
            }, 1000);
        }
    }

    // Helper to copy text to clipboard
    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text);
        } else {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
    }
    // Helper function to highlight the replaced text
    function highlightReplacedText(text) {
        const content = document.getElementById('contractContent');
        if (!content) return;

        try {
            // Temporarily highlight the new text
            const tempHighlight = `<mark style="background: #90EE90; animation: fadeOut 3s forwards;">${text}</mark>`;
            const regex = new RegExp(text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

            content.innerHTML = content.innerHTML.replace(
                regex,
                (match) => tempHighlight.replace(text, match)
            );

            // Scroll to the highlighted text
            const mark = content.querySelector('mark');
            if (mark) {
                mark.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Remove highlight after 3 seconds
                setTimeout(() => {
                    if (mark && mark.parentNode) {
                        const textNode = document.createTextNode(mark.textContent);
                        mark.parentNode.replaceChild(textNode, mark);
                    }
                }, 3000);
            }
        } catch (e) {
            console.log('Could not highlight text:', e);
        }
    }

    // Add this CSS for the fade animation
    const style = document.createElement('style');
    style.textContent = `
    @keyframes fadeOut {
        0% { background: #90EE90; }
        70% { background: #90EE90; }
        100% { background: transparent; }
    }
`;
    document.head.appendChild(style);

    function editClauseManually() {
        closeModal('clauseSuggestionModal');
        showNotification('You can now edit the clause directly in the editor', 'info');
        // Focus on the editor
        document.getElementById('contractContent').focus();
    }

    // Version History - CONNECTED TO BACKEND
    async function showVersionHistory() {
        showLoader();
        try {
            const response = await fetch(`/api/contracts/versions/${contractId}`);
            const data = await response.json();

            if (data.success && data.versions) {
                displayVersionHistory(data.versions);
                openModal('versionModal');
            } else {
                showNotification('No version history available', 'info');
            }
        } catch (error) {
            console.error('Error fetching version history:', error);
            showNotification('Failed to load version history', 'error');
        } finally {
            hideLoader();
        }
    }

    function displayVersionHistory(versions) {
        const content = document.getElementById('versionHistoryContent');
        content.innerHTML = versions.map((version, index) => `
        <div style="padding: 1rem; background: ${index === 0 ? 'var(--background-light)' : 'white'}; border-radius: 8px; ${index === 0 ? 'border-left: 3px solid var(--primary-color);' : 'border: 1px solid var(--border-color);'} margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <strong>Version ${version.version} ${index === 0 ? '(Current)' : ''}</strong>
                <span style="color: var(--text-muted); font-size: 0.875rem;">${new Date(version.created_at).toLocaleString()}</span>
            </div>
            <p style="font-size: 0.875rem; color: var(--text-muted); margin: 0.5rem 0;">${version.notes || version.type || 'No notes'}</p>
            <p style="font-size: 0.8rem; margin: 0;">Modified by: ${version.created_by || 'Unknown'}</p>
           
        </div>
    `).join('');
    }

    async function compareVersions() {
        const v1 = prompt('Enter first version number:');
        const v2 = prompt('Enter second version number:');

        if (!v1 || !v2) return;

        showLoader();
        try {
            const response = await fetch(`/api/contracts/versions/compare?contract_id=${contractId}&version1=${v1}&version2=${v2}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`${data.total_changes} changes found between versions`, 'info');
            }
        } catch (error) {
            console.error('Error comparing versions:', error);
            showNotification('Failed to compare versions', 'error');
        } finally {
            hideLoader();
        }
    }

    // Export - CONNECTED TO BACKEND
    function exportDocument() {
        openModal('exportModal');
    }

    async function executeExport() {
        const formatInput = document.querySelector('input[name="exportFormat"]:checked');
        const format = formatInput ? formatInput.value : 'pdf';

        console.log(' Export requested:', format, 'for contract:', contractId);

        showLoader();
        showNotification(`Preparing ${format.toUpperCase()} export...`, 'info');

        try {
            // Build API URL
            const params = new URLSearchParams({
                format: format === 'word' ? 'docx' : format, // Convert 'word' to 'docx'
                include_signatures: 'true'
            });

            const apiUrl = `/api/contracts/export/${contractId}?${params.toString()}`;
            console.log(' Calling API:', apiUrl);

            // Call backend API
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log(' Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error(' Error response:', errorText);
                throw new Error(`Export failed with status ${response.status}`);
            }

            // Get filename from Content-Disposition header
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `contract_${contractId}.${format}`;

            if (contentDisposition) {
                const matches = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (matches && matches[1]) {
                    filename = matches[1].replace(/['"]/g, '');
                }
            }

            console.log(' Downloading as:', filename);

            // Download the file
            const blob = await response.blob();
            console.log(' Blob size:', blob.size, 'bytes');

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);

            closeModal('exportModal');
            hideLoader();
            showNotification(`Document exported successfully as ${format.toUpperCase()}`, 'success');
            console.log(' Export completed successfully');

        } catch (error) {
            console.error(' Export error:', error);
            hideLoader();
            showNotification(`Export failed: ${error.message}`, 'error');
        }
    }



    // =====================================================
    // SIGNATURE FUNCTIONS - CONNECTED TO BACKEND
    // =====================================================

    // Send for Signature - CONNECTED TO BACKEND
    async function sendForSignature() {
        if (!confirm('Send this contract for signature? Both parties will be notified to sign the document.')) {
            return;
        }

        showLoader();
        try {
            const response = await fetch('/api/contracts/send-for-signature', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Contract sent for signature successfully!', 'success');

                // Update workflow status
                document.getElementById('workflowStatusText').textContent = 'Awaiting Signatures';

                // CORRECTED: Mark Approval as COMPLETED (step 4)
                const approvalStep = document.querySelector('.stepper-step:nth-child(4)');
                if (approvalStep) {
                    approvalStep.classList.remove('pending', 'active');
                    approvalStep.classList.add('completed');
                    approvalStep.querySelector('.step-date').textContent = 'Completed';
                }

                // Set Signature as ACTIVE (step 5)
                const signatureStep = document.querySelector('.stepper-step:nth-child(5)');
                if (signatureStep) {
                    signatureStep.classList.remove('pending');
                    signatureStep.classList.add('active');
                    signatureStep.querySelector('.step-date').textContent = 'In Progress';
                }

                // Update progress bar to 83% (at signature stage)
                document.getElementById('stepperProgress').style.width = '83%';

                // Reload page after delay to show updated status
                setTimeout(async () => await refreshContractData(), 1000);
            } else {
                showNotification(data.message || 'Failed to send for signature', 'error');
            }
        } catch (error) {
            console.error('Error sending for signature:', error);
            showNotification('Failed to send for signature', 'error');
        } finally {
            hideLoader();
        }
    }

    async function submitSignatureWorkflow() {
        try {
            // Show loader
            showLoader();

            // Validate inputs
            console.log(' Sending for e-signature:', {
                company_user_id: selectedCompanyEmail ? selectedCompanyEmail.userId : null,
                counterparty_user_id: selectedCounterPartyEmail ? selectedCounterPartyEmail.userId : null,

                contractId: contractId
            });

            // Send request (NO BODY - fixes 422 error)
            const response = await fetch(`/api/contracts/${contractId}/esignature`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    party_esignature_authority_id: selectedCompanyEmail ? selectedCompanyEmail.userId : null,
                    counterparty_esignature_authority_id: selectedCounterPartySignatureEmail ? selectedCounterPartySignatureEmail.userId : null,
                })
            });

            const data = await response.json();
            console.log('Response:', data);

            if (response.ok && data.success) {
                showNotification('Contract sent for signature successfully!', 'success');

                // Close modal
                closeModal('sendForSignatureModal');

                // Reload contract data
                setTimeout(async () => {
                    await refreshContractData();
                }, 1000);

            } else {
                throw new Error(data.detail || data.message || 'Failed to send for signature');
            }

        } catch (error) {
            console.error(' Error sending for signature:', error);
            showNotification(error.message || 'Failed to send for signature', 'error');
        } finally {
            hideLoader();
        }
    }

    async function initiateApprovalWorkflow() {

        await checkWorkflowAvailability();
        openModal('internalApprovalModal');
        await loadCompanyUsersForReview();
        await clearSelectedUser();


    }

    async function submitInternalApproval() {
        const reviewType = document.querySelector('input[name="reviewOption"]:checked')?.value || 'specific';
        const personnelEmails = document.getElementById('specificPersonnel')?.value.split(',').map(e => e.trim()).filter(Boolean) || [];
        const notes = document.getElementById('reviewNotes')?.value || '';

        showLoader();
        try {
            const response = await fetch('/api/contracts/submit-approval', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId,
                    review_type: reviewType,
                    personnel_emails: personnelEmails,
                    notes: notes,
                    request_type: 'approval',
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Contract sent for approval successfully!', 'success');

                closeModal('internalApprovalModal');
                // Reload page after delay to show updated status
                setTimeout(async () => await refreshContractData(), 1000);
            } else {
                showNotification(data.message || 'Failed to send for approval', 'error');
            }
        } catch (error) {
            console.error('Error sending for approval:', error);
            showNotification('Failed to send for approval', 'error');
        } finally {
            hideLoader();
        }
    }



    async function initiateSignatureWorkflow() {
        openModal('sendForSignatureModal');
    }


    // =================================================================
    // SIGNATURE FUNCTIONALITY - FIXED VERSION
    // =================================================================

    // Open Signature Modal - Enhanced version with authority check
    function openSignatureModal(party) {
        console.log('partyyyy', party);
        // PREVENT MODAL IF NOT IN SIGNATURE STATUS
        if (contractData?.contract?.status !== 'signature') {
            showNotification('Contract must be in Signature stage before signing. Current status: ' +
                (contractData?.contract?.status || 'unknown').toUpperCase(), 'warning');
            return;
        }

        // Check if user has e-signature authority in workflow
        // if (!hasSignatureAuthority()) {
        //     showNotification('You are not authorized to sign this contract. Only users designated as E-Signature Authority in the workflow can sign.', 'error');
        //     return;
        // }


        currentSignatureField = party;

        const modal = document.getElementById('signatureModal');

        if (!modal) {
            console.error('Signature modal not found');
            showNotification('Signature modal not available', 'error');
            return;
        }

        // Set signer info based on party and contract data
        const signerNameEl = document.getElementById('signerName');
        const signerRoleEl = document.getElementById('signerRole');
        const partyIndicatorEl = document.getElementById('partyIndicator');

        // Get actual names from contract data
        const clientName = contractData?.contract?.party_b_company_name || 'Client Representative';
        const companyName = contractData?.contract?.company_name || 'Company Representative';

        if (party === 'client') {
            if (signerNameEl) signerNameEl.textContent = clientName;
            if (signerRoleEl) signerRoleEl.textContent = 'Client Signatory';
            if (partyIndicatorEl) {
                partyIndicatorEl.textContent = 'CLIENT';
                partyIndicatorEl.style.background = 'var(--primary-color)';
            }
        } else if (party === 'company') {
            if (signerNameEl) signerNameEl.textContent = companyName;
            if (signerRoleEl) signerRoleEl.textContent = 'Company Signatory';
            if (partyIndicatorEl) {
                partyIndicatorEl.textContent = 'COMPANY';
                partyIndicatorEl.style.background = 'var(--secondary-color)';
            }
        }

        // Reset modal state
        const agreeTerms = document.getElementById('agreeTerms');
        const typedSig = document.getElementById('typedSig');
        const signBtn = document.getElementById('signBtn');

        if (agreeTerms) agreeTerms.checked = false;
        if (typedSig) typedSig.value = '';
        if (signBtn) signBtn.disabled = true;

        // Reset signature preview
        const sigPreview = document.getElementById('sigPreview');
        if (sigPreview) sigPreview.textContent = '';

        // Set default to draw method
        switchSignMethod('draw');

        // Open modal
        openModal('signatureModal');

        // Initialize canvas after modal is visible
        setTimeout(() => {
            initCanvas();
        }, 100);
    }

    // Alternative: Open signature for specific party
    function openSignature(party) {
        // PREVENT MODAL IF NOT IN SIGNATURE STATUS
        if (contractData?.contract?.status !== 'signature') {
            showNotification('Contract must be in Signature stage before signing.', 'warning');
            return;
        }

        // Check if user has e-signature authority
        if (!hasSignatureAuthority()) {
            showNotification('You are not authorized to sign this contract. Only users designated as E-Signature Authority in the workflow can sign.', 'error');
            return;
        }

        currentSignatureField = party;
        const modal = document.getElementById('signatureModal');

        if (!modal) {
            console.error('Signature modal not found');
            showNotification('Signature modal not available', 'error');
            return;
        }

        const signerNameEl = document.getElementById('signerName');
        const signerRoleEl = document.getElementById('signerRole');
        const partyIndicatorEl = document.getElementById('partyIndicator');

        // Get actual names from contract data
        const clientName = contractData?.contract?.client_name || 'Client Representative';
        const companyName = contractData?.contract?.company_name || 'Company Representative';

        // Set signer info based on party
        if (party === 'client') {
            if (signerNameEl) signerNameEl.textContent = clientName;
            if (signerRoleEl) signerRoleEl.textContent = 'Client Signatory';
            if (partyIndicatorEl) {
                partyIndicatorEl.textContent = 'CLIENT';
                partyIndicatorEl.style.background = 'var(--primary-color)';
            }
        } else if (party === 'provider' || party === 'company') {
            if (signerNameEl) signerNameEl.textContent = companyName;
            if (signerRoleEl) signerRoleEl.textContent = 'Company Signatory';
            if (partyIndicatorEl) {
                partyIndicatorEl.textContent = 'COMPANY';
                partyIndicatorEl.style.background = 'var(--secondary-color)';
            }
        }

        // Reset modal state
        const agreeTerms = document.getElementById('agreeTerms');
        const typedSig = document.getElementById('typedSig');
        const signBtn = document.getElementById('signBtn');

        if (agreeTerms) agreeTerms.checked = false;
        if (typedSig) typedSig.value = '';
        if (signBtn) signBtn.disabled = true;

        // Reset signature preview
        const sigPreview = document.getElementById('sigPreview');
        if (sigPreview) sigPreview.textContent = '';

        // Set default to draw method
        switchSignMethod('draw');

        // Open modal
        openModal('signatureModal');

        // Initialize canvas after modal is visible
        setTimeout(() => {
            initCanvas();
        }, 100);
    }

    // Check if current user has signature authority in workflow
    function hasSignatureAuthority() {

        // Check if workflow data exists
        if (!contractData?.workflow) {
            console.warn('No workflow data available');
            return false;
        }

        const workflow = contractData.workflow;

        console.log(workflow);
        // If it's my workflow turn and role includes e-signature authority
        if (workflow.is_my_workflow_turn) {


            const currentStep = workflow.current_step_name?.toLowerCase() || '';
            if (currentStep.includes('e-sign') ||
                currentStep.includes('esign') ||
                currentStep.includes('signature') ||
                currentStep === 'e_sign authority') {
                return true;
            }
        }

        return false;
    }

    // Apply signature with enhanced response handling
    async function applySignature() {
        const signatureData = document.getElementById('typedSig')?.value ||
            (canvas ? canvas.toDataURL() : 'Digitally Signed');
        const signatureMethod = document.querySelector('.signature-tab.active')?.textContent.includes('Type') ? 'type' : 'draw';

        showLoader();
        try {
            console.log(' Sending signature request...');
            console.log('signature type', currentSignatureField);

            const response = await fetch('/api/contracts/signature/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`  // Ensure auth token is sent
                },
                credentials: 'include',  // Include cookies
                body: JSON.stringify({
                    contract_id: parseInt(contractId),
                    signer_type: currentSignatureField,
                    signature_method: signatureMethod,
                    signature_data: signatureData
                })
            });

            console.log(' Response status:', response.status, response.statusText);

            //  FIX: Check response.ok FIRST before parsing JSON
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || errorData.message || 'Failed to apply signature');
            }

            const data = await response.json();
            console.log(' Response data:', data);

            //  FIX: Now check data.success
            if (data.success) {
                // Close modal first
                closeModal('signatureModal');

                // Update UI to show signature with actual signature data
                const fieldId = currentSignatureField === 'client' ? 'clientSignature' : 'companySignature';
                const fieldElement = document.getElementById(fieldId);

                if (fieldElement) {
                    // Create signature display with actual signature
                    const signatureDisplay = signatureMethod === 'type'
                        ? `<div class="typed-signature">${signatureData}</div>`
                        : `<img src="${signatureData}" alt="Signature" style="max-width: 100%; height: auto;">`;

                    fieldElement.innerHTML = `
                    <div class="signature-applied">
                        ${signatureDisplay}
                        <p class="signature-info">
                            <small>Signed by ${data.signer_name || 'Current User'}</small><br>
                            <small>${new Date(data.signed_at).toLocaleString()}</small>
                        </p>
                    </div>
                `;
                    fieldElement.classList.add('signed');
                }

                // Show success notification with signer name
                showNotification(
                    data.message || `Signature applied successfully by ${data.signer_name}`,
                    'success'
                );

                // Update contract status if all parties signed
                if (data.all_signed) {
                    showNotification('All parties have signed! Contract is now executed.', 'success');

                    // Update status badge
                    const statusBadge = document.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = 'Executed';
                        statusBadge.className = 'status-badge status-executed';
                    }
                }

                // Reload contract data to reflect changes
                setTimeout(async () => {
                    await refreshContractData();
                }, 1500);

            } else {
                // Handle specific error cases
                if (data.not_authorized) {
                    showNotification(data.detail || 'Only E-Signature Authority can sign.', 'error');
                } else if (data.already_signed) {
                    showNotification(data.detail || 'You have already signed this contract', 'warning');
                } else {
                    showNotification(data.detail || data.message || 'Failed to apply signature', 'error');
                }
                closeModal('signatureModal');
            }

        } catch (error) {
            console.error(' Error applying signature:', error);
            hideLoader();
            showNotification(error.message || 'Failed to apply signature. Please try again.', 'error');
            closeModal('signatureModal');
        } finally {
            hideLoader();
        }
    }



    // Helper function to find elements containing specific text
    HTMLElement.prototype.contains = function (text) {
        return this.textContent.includes(text);
    };




    // Workflow Setup - CONNECTED TO BACKEND
    async function saveContractWorkflow() {
        if (!contractId) {
            showNotification('Contract ID not found. Please refresh the page.', 'error');
            return;
        }

        if (!selectedContractWorkflow) {
            showNotification('Please select a workflow type', 'warning');
            return;
        }

        console.log(' Saving workflow...');

        const saveWorkflowBtn = document.getElementById('saveWorkflowBtn');
        const originalContent = saveWorkflowBtn.innerHTML;
        saveWorkflowBtn.disabled = true;
        saveWorkflowBtn.innerHTML = '<i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> Saving...';

        console.log('Selected workflow type:', selectedContractWorkflow);

        const workflowData = {
            contract_id: contractId,
            workflow_type: selectedContractWorkflow
        };

        if (selectedContractWorkflow === 'custom') {
            console.log(' Collecting custom workflow steps...');

            const steps = [];
            const rows = document.querySelectorAll('#contractWorkflowSteps tr');

            console.log(`Found ${rows.length} workflow step rows`);

            rows.forEach((row, index) => {
                // Get role select and email input
                const roleSelect = row.querySelector('select:nth-of-type(1)');
                const emailInput = row.querySelector('input[type="email"]');

                const role = roleSelect?.value || '';
                const email = emailInput?.value || '';
                // Get department from input's data attribute
                const department = emailInput?.getAttribute('data-department') || '';

                console.log(`Row ${index + 1}: role="${role}", email="${email}", dept="${department}"`);

                // Only add if we have at least role and email
                if (role && email) {
                    steps.push({
                        step_order: index + 1,
                        step_label: role,
                        assigned_email: email,
                        department: department
                    });

                    console.log(` Added step ${index + 1}:`, {
                        step_order: index + 1,
                        step_label: role,
                        assigned_email: email,
                        department: department
                    });
                } else {
                    console.warn(` Skipping row ${index + 1}: missing role or email`);
                }
            });

            workflowData.steps = steps;
            workflowData.justification = "Custom workflow for this contract";

            console.log(` Prepared ${steps.length} steps for backend:`, steps);

            if (steps.length === 0) {
                saveWorkflowBtn.innerHTML = originalContent;
                saveWorkflowBtn.disabled = false;
                showNotification('Please add at least one workflow step with role and email.', 'warning');
                return;
            }
        }

        try {
            const response = await fetch('/api/contracts/workflow/setup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(workflowData)
            });

            const result = await response.json();

            if (response.ok) {
                showNotification('Workflow saved successfully!', 'success');
                closeModal('contractWorkflowModal');

                // Reload workflow to show saved data
                setTimeout(async () => await refreshContractData(), 500);
            } else {
                showNotification('Error: ' + (result.detail || 'Failed to save workflow'), 'error');
            }
        } catch (error) {
            console.error('Error saving workflow:', error);
            showNotification('Error saving workflow. Please try again.', 'error');
        } finally {
            saveWorkflowBtn.innerHTML = originalContent;
            saveWorkflowBtn.disabled = false;
        }
    }
    function downloadMinutes() {
        showNotification('Downloading negotiation minutes...', 'success');

    }

    function finalizeNegotiation() {
        if (confirm('Are you ready to finalize this negotiation? This will conclude the negotiation stage.')) {
            showNotification('Negotiation finalized successfully! Moving to next stage.', 'success');
            closeModal('liveNegotiationModal');
        }
    }
    // Track Changes - FULL FUNCTIONALITY

    function showTrackChangesPanel() {
        let panel = document.getElementById('trackChangesPanel');
        if (!panel) {
            panel = document.createElement('div');
            panel.id = 'trackChangesPanel';
            panel.style.cssText = `
            position: fixed;
            top: 70px;
            right: 430px;
            background: white;
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            z-index: 998;
            display: flex;
            gap: 12px;
            align-items: center;
        `;

            panel.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; color: #28a745; font-weight: 600; font-size: 14px;">
                <i class="ti ti-edit"></i>
                <span>Track Changes ON</span>
            </div>
            <button onclick="acceptAllChanges()" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 4px;">
                <i class="ti ti-check-circle"></i> Accept All
            </button>
            <button onclick="rejectAllChanges()" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 4px;">
                <i class="ti ti-circle-x"></i> Reject All
            </button>
        `;

            document.body.appendChild(panel);
        }
        panel.style.display = 'flex';
    }



    function hideTrackChangesPanel() {
        const panel = document.getElementById('trackChangesPanel');
        if (panel) panel.style.display = 'none';
    }





    async function updateTrackChangesStatus(action) {
        // Since metadata column doesn't exist, we'll handle track changes client-side only
        // and store the state in localStorage for persistence
        try {
            const trackChangesState = {
                contractId: contractId,
                enabled: action === 'enable',
                action: action,
                timestamp: new Date().toISOString(),
                changes: trackedChanges
            };

            // Store in localStorage
            localStorage.setItem(`track_changes_${contractId}`, JSON.stringify(trackChangesState));

            console.log('Track changes status updated locally:', trackChangesState);

            // Still save the content to create a new version
            if (action === 'accept_all' || action === 'reject_all') {
                await saveAsDraft();
            }
        } catch (error) {
            console.error('Error updating track changes:', error);
        }
    }

    function handleContentChange(e) {
        if (!trackChangesEnabled) {
            updateSaveStatus('editing');
            return;
        }

        // Don't track if user is just navigating
        if (!e || !e.inputType) return;

        const inputType = e.inputType;

        // Track deletions
        if (inputType.includes('delete')) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                // Mark deleted content (already handled by beforeinput)
            }
        }

        // Track insertions
        if (inputType.includes('insert')) {
            markRecentInsertions();
        }

        updateSaveStatus('editing');
    }



    document.getElementById('contractContent')?.addEventListener('beforeinput', function (e) {
        if (!trackChangesEnabled) return;

        const inputType = e.inputType;

        // Handle deletions
        if (inputType === 'deleteContentBackward' || inputType === 'deleteContentForward' || inputType === 'deleteByCut') {
            const selection = window.getSelection();

            if (selection.rangeCount > 0 && selection.toString().trim()) {
                e.preventDefault(); // Prevent actual deletion

                // Mark text as deleted instead
                const range = selection.getRangeAt(0);
                const deletedText = selection.toString();

                // Create deletion marker
                const span = document.createElement('span');
                span.className = 'track-change-delete';
                span.style.cssText = `
                text-decoration: line-through;
                text-decoration-color: #dc3545;
                text-decoration-thickness: 2px;
                background: rgba(220,53,69,0.15);
                color: #dc3545;
                padding: 2px 4px;
                border-radius: 3px;
                cursor: pointer;
            `;
                span.textContent = deletedText;
                span.title = `Deleted by ${currentUserName || 'User'}`;
                span.onclick = function () {
                    if (confirm('Accept this deletion?')) {
                        this.remove();
                        saveAsDraft();
                    } else if (confirm('Reject this deletion? (Restore text)')) {
                        this.replaceWith(document.createTextNode(deletedText));
                        saveAsDraft();
                    }
                };

                // Replace selection with deletion marker
                range.deleteContents();
                range.insertNode(span);

                // Clear selection
                selection.removeAllRanges();
            }
        }
    });





    function markRecentInsertions() {
        // This is a simplified version - in production use proper diff algorithm
        const content = document.getElementById('contractContent');
        const selection = window.getSelection();

        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;

            // Find recently inserted text nodes
            if (container.nodeType === Node.TEXT_NODE && container.textContent.trim()) {
                // Only mark if not already marked
                if (!container.parentElement.classList.contains('track-change-insert')) {
                    const span = document.createElement('span');
                    span.className = 'track-change-insert';
                    span.style.cssText = `
                    background: rgba(40,167,69,0.15);
                    border-bottom: 2px solid #28a745;
                    color: #155724;
                    padding: 2px 4px;
                    border-radius: 3px;
                    cursor: pointer;
                `;
                    span.textContent = container.textContent;
                    span.title = `Inserted by ${currentUserName || 'User'}`;
                    span.onclick = function () {
                        if (confirm('Accept this insertion?')) {
                            this.replaceWith(document.createTextNode(this.textContent));
                            saveAsDraft();
                        } else if (confirm('Reject this insertion? (Remove text)')) {
                            this.remove();
                            saveAsDraft();
                        }
                    };

                    container.parentNode.replaceChild(span, container);
                }
            }
        }
    }




    function trackChange(type, oldText, newText) {
        const change = {
            type: type,
            timestamp: new Date().toISOString(),
            user: 'Current User',
            oldText: oldText,
            newText: newText
        };

        trackedChanges.push(change);

        // Apply visual indicators
        if (type === 'insert') {
            // Wrap new text in insert indicator
            const diff = newText.replace(oldText, '');
            if (diff) {
                // This is simplified - in production, use proper diff marking
                console.log('Text inserted:', diff.substring(0, 50));
            }
        } else if (type === 'delete') {
            // Mark deleted text
            console.log('Text deleted');
        }
    }

    function acceptAllChanges() {
        const content = document.getElementById('contractContent');

        // Accept all deletions - remove them completely
        content.querySelectorAll('.track-change-delete').forEach(el => {
            el.remove();
        });

        // Accept all insertions - remove markup, keep text
        content.querySelectorAll('.track-change-insert').forEach(el => {
            const text = el.textContent;
            el.replaceWith(document.createTextNode(text));
        });

        trackedChanges = [];
        originalContent = content.innerHTML;

        showNotification('All changes accepted', 'success');
        saveAsDraft();
    }


    function rejectAllChanges() {
        const content = document.getElementById('contractContent');

        // Reject all deletions - restore text without markup
        content.querySelectorAll('.track-change-delete').forEach(el => {
            const text = el.textContent;
            el.replaceWith(document.createTextNode(text));
        });

        // Reject all insertions - remove them completely
        content.querySelectorAll('.track-change-insert').forEach(el => {
            el.remove();
        });

        trackedChanges = [];

        showNotification('All changes rejected', 'success');
        saveAsDraft();
    }



    // Find & Replace - FULL FUNCTIONALITY
    function findReplace() {
        openModal('findReplaceModal');
    }

    function findNext() {
        const findText = document.getElementById('findText').value;
        const caseSensitive = document.getElementById('caseSensitive').checked;

        if (!findText) return;

        const content = document.getElementById('contractContent');
        const text = content.innerText;
        const flags = caseSensitive ? 'g' : 'gi';
        const regex = new RegExp(findText, flags);

        const matches = text.match(regex);
        if (matches) {
            showNotification(`Found ${matches.length} occurrences`, 'info');
            // Highlight first match
            highlightText(findText, caseSensitive);
        } else {
            showNotification('No matches found', 'warning');
        }
    }

    function replaceOne() {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        const caseSensitive = document.getElementById('caseSensitive').checked;

        if (!findText) return;

        const content = document.getElementById('contractContent');
        const flags = caseSensitive ? '' : 'i';
        const regex = new RegExp(findText, flags);

        content.innerHTML = content.innerHTML.replace(regex, replaceText);

        if (trackChangesEnabled) {
            trackChange('replace', findText, replaceText);
        }

        showNotification('Replaced 1 occurrence', 'success');
        saveAsDraft();
    }

    function replaceAll() {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        const caseSensitive = document.getElementById('caseSensitive').checked;

        if (!findText) return;

        const content = document.getElementById('contractContent');
        const flags = caseSensitive ? 'g' : 'gi';
        const regex = new RegExp(findText, flags);

        const originalHtml = content.innerHTML;
        const newHtml = originalHtml.replace(regex, replaceText);
        const replacements = (originalHtml.match(regex) || []).length;

        content.innerHTML = newHtml;

        if (trackChangesEnabled && replacements > 0) {
            trackChange('replace_all', findText, replaceText);
        }

        showNotification(`Replaced ${replacements} occurrences`, 'success');
        closeModal('findReplaceModal');
        saveAsDraft();
    }




    // Auto-save functionality
    function startAutoSave() {
        // Clear any existing interval
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }

        // Save every 30 seconds if there are changes
        let lastContent = document.getElementById('contractContent').innerHTML;

        autoSaveInterval = setInterval(async () => {
            const currentContent = document.getElementById('contractContent').innerHTML;

            if (currentContent !== lastContent) {
                await saveAsDraft();
                lastContent = currentContent;
            }
        }, 30000); // 30 seconds
    }

    function updateSaveStatus(status) {
        const statusEl = document.getElementById('saveStatus');
        if (!statusEl) return;

        switch (status) {
            case 'saving':
                statusEl.innerHTML = '<i class="ti ti-loader-2"></i> Saving...';
                statusEl.style.color = 'var(--warning-color)';
                break;
            case 'saved':
                statusEl.innerHTML = '<i class="ti ti-circle-check"></i> Saved';
                statusEl.style.color = 'var(--success-color)';
                break;
            case 'editing':
                statusEl.innerHTML = '<i class="ti ti-pencil"></i> Editing...';
                statusEl.style.color = 'var(--text-muted)';
                break;
            case 'error':
                statusEl.innerHTML = '<i class="ti ti-alert-circle"></i> Save failed';
                statusEl.style.color = 'var(--danger-color)';
                break;
        }
    }

    // Additional Helper Functions
    function insertTable() {
        const rows = prompt('Number of rows:', '3');
        const cols = prompt('Number of columns:', '3');

        if (!rows || !cols) return;

        let table = '<table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">';
        table += '<thead><tr>';
        for (let c = 0; c < parseInt(cols); c++) {
            table += '<th style="border: 1px solid var(--border-color); padding: 0.5rem; background: var(--background-light);">Header ' + (c + 1) + '</th>';
        }
        table += '</tr></thead><tbody>';

        for (let r = 0; r < parseInt(rows); r++) {
            table += '<tr>';
            for (let c = 0; c < parseInt(cols); c++) {
                table += '<td style="border: 1px solid var(--border-color); padding: 0.5rem;">Cell</td>';
            }
            table += '</tr>';
        }
        table += '</tbody></table>';

        document.execCommand('insertHTML', false, table);
        saveAsDraft();
    }

    // Signature Canvas Functions
    function initCanvas() {
        canvas = document.getElementById('signCanvas');
        if (!canvas) return;

        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = 200;

        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch support
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
    }

    function stopDrawing() {
        isDrawing = false;
    }

    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' :
            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }

    function clearCanvas() {
        if (ctx && canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    function switchSignMethod(method) {
        // Get the clicked element - use event.currentTarget or pass it as parameter
        const clickedTab = event ? event.currentTarget : null;

        // Reset all tabs first
        document.querySelectorAll('.signature-tab').forEach(tab => {
            tab.style.color = 'var(--text-muted)';
            tab.style.borderBottom = 'none';
            tab.style.fontWeight = 'normal';
            tab.classList.remove('active');
        });

        // Highlight the active tab
        if (clickedTab) {
            clickedTab.style.color = 'var(--primary-color)';
            clickedTab.style.borderBottom = '3px solid var(--primary-color)';
            clickedTab.style.fontWeight = '600';
            clickedTab.classList.add('active');
        } else {
            // If no event (called programmatically), find the tab by method
            const tabs = document.querySelectorAll('.signature-tab');
            tabs.forEach(tab => {
                const isDrawTab = tab.textContent.includes('Draw');
                const isTypeTab = tab.textContent.includes('Type');

                if ((method === 'draw' && isDrawTab) || (method === 'type' && isTypeTab)) {
                    tab.style.color = 'var(--primary-color)';
                    tab.style.borderBottom = '3px solid var(--primary-color)';
                    tab.style.fontWeight = '600';
                    tab.classList.add('active');
                }
            });
        }

        // Show/hide the appropriate signature input
        document.getElementById('drawSignature').style.display = method === 'draw' ? 'block' : 'none';
        document.getElementById('typeSignature').style.display = method === 'type' ? 'block' : 'none';
    }



    function updateSignaturePreview() {
        const preview = document.getElementById('sigPreview');
        const input = document.getElementById('typedSig');
        preview.textContent = input.value;
    }

    function toggleSignButton() {
        const checkbox = document.getElementById('agreeTerms');
        const button = document.getElementById('signBtn');
        button.disabled = !checkbox.checked;
    }

    async function checkAllSignatures() {
        const clientSigned = document.getElementById('clientSignature')?.classList.contains('signed');
        const providerSigned = document.getElementById('providerSignature')?.classList.contains('signed') ||
            document.getElementById('companySignature')?.classList.contains('signed');

        if (clientSigned && providerSigned) {
            console.log(' Both parties have signed! Checking backend status...');

            // The status should already be 'signed' from the backend
            // Let's verify and update UI accordingly

            // Update the stepper: Signature step is now COMPLETED
            const signatureStep = document.querySelector('.stepper-step:nth-child(5)');
            if (signatureStep) {
                signatureStep.classList.remove('active', 'pending');
                signatureStep.classList.add('completed');
                signatureStep.querySelector('.step-date').textContent = 'Completed';
            }

            // Executed step should now be ACTIVE (ready for execution)
            const executedStep = document.querySelector('.stepper-step:nth-child(6)');
            if (executedStep) {
                executedStep.classList.remove('pending');
                executedStep.classList.add('active');
                executedStep.querySelector('.step-date').textContent = 'Ready';
            }

            // Update progress bar to 83% (signature completed, execution pending)
            const progressBar = document.getElementById('stepperProgress');
            if (progressBar) {
                progressBar.style.width = '83%';
            }

            // Update workflow status
            const statusText = document.getElementById('workflowStatusText');
            if (statusText) {
                statusText.textContent = 'Fully Signed - Ready for Execution';
            }

            showNotification('All parties have signed! Contract is now ready for execution.', 'success');

            // Reload page to show updated action buttons (Execute Contract button)
            setTimeout(async () => await refreshContractData(), 1500);
        }
    }

    // Document Upload Functions
    function triggerFileUpload() {
        document.getElementById('fileUpload').click();
    }

    function handleFileSelect(event) {
        const files = Array.from(event.target.files);
        uploadedFiles = uploadedFiles.concat(files);
        displayUploadedFiles();
        document.getElementById('uploadBtn').disabled = false;
    }

    function handleFileDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('dragover');
        const files = Array.from(event.dataTransfer.files);
        uploadedFiles = uploadedFiles.concat(files);
        displayUploadedFiles();
        document.getElementById('uploadBtn').disabled = false;
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('dragover');
    }

    function displayUploadedFiles() {
        const container = document.getElementById('uploadedFiles');
        if (!container) return;

        container.style.display = 'block';
        container.innerHTML = '';

        uploadedFiles.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            fileDiv.innerHTML = `
            <div class="file-name">
                <i class="ti ti-file" style="color: var(--primary-color);"></i>
                <span>${file.name}</span>
                <span style="color: var(--text-muted); font-size: 0.8rem;">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
            </div>
            <button class="remove-file-btn" onclick="removeUploadedFile(${index})" title="Remove file">
                <i class="ti ti-x"></i>
            </button>
        `;
            container.appendChild(fileDiv);
        });
    }

    function removeUploadedFile(index) {
        uploadedFiles.splice(index, 1);
        displayUploadedFiles();

        if (uploadedFiles.length === 0) {
            const container = document.getElementById('uploadedFiles');
            if (container) {
                container.style.display = 'none';
            }
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.disabled = true;
            }
        }
    }

    function uploadDocuments() {
        if (uploadedFiles.length > 0) {
            showNotification(`Uploading ${uploadedFiles.length} document(s)...`, 'success');

            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.innerHTML = '<i class="ti ti-loader"></i> Uploading...';
                uploadBtn.disabled = true;
            }

            setTimeout(() => {
                showNotification('Documents uploaded successfully!', 'success');

                uploadedFiles = [];
                const container = document.getElementById('uploadedFiles');
                if (container) {
                    container.style.display = 'none';
                }
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="ti ti-upload"></i> Upload Documents';
                    uploadBtn.disabled = true;
                }
                closeModal('documentsModal');
            }, 2000);
        }
    }

    function downloadDocument(docId) {
        showNotification(`Downloading document: ${docId}`, 'success');

    }




    function insertSuggestion(text) {
        const input = document.getElementById('messageInput');
        if (input) {
            input.value = text;
            input.focus();
        }
    }


    // Additional Functions
    function toggleRiskItem(header) {
        const item = header.closest('.risk-item');
        const content = item.querySelector('.risk-item-content');

        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
        } else {
            content.style.display = 'none';
        }
    }

    function exportRiskReport() {
        if (!riskAnalysisData) {
            showNotification('No risk analysis data to export', 'warning');
            return;
        }

        // Create a downloadable report
        const reportContent = `
Risk Analysis Report
Contract: ${contractData?.contract?.title || 'Unknown'}
Date: ${new Date().toLocaleDateString()}

Overall Score: ${riskAnalysisData.overall_score}
High Risks: ${riskAnalysisData.high_risks}
Medium Risks: ${riskAnalysisData.medium_risks}
Low Risks: ${riskAnalysisData.low_risks}

Detailed Findings:
${(riskAnalysisData.risk_items || []).map(item => `
- ${item.issue} (${item.severity})
  ${item.description}
  Recommendation: ${item.recommendation}
`).join('\n')}
    `;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `risk_analysis_${contractId}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification('Risk report exported', 'success');
    }

    function applyRiskMitigation() {
        if (!riskAnalysisData || !riskAnalysisData.risk_items) {
            showNotification('No risk mitigation available', 'warning');
            return;
        }

        if (confirm('Apply AI-suggested risk mitigation to the contract? This will modify the contract content.')) {
            // Apply suggestions to contract
            let contentModified = false;
            const content = document.getElementById('contractContent');

            riskAnalysisData.risk_items.forEach(risk => {
                if (risk.severity === 'high' && risk.recommendation) {
                    // This is simplified - in production, apply specific changes
                    contentModified = true;
                    showNotification(`Applied mitigation for: ${risk.issue}`, 'info');
                }
            });

            if (contentModified) {
                saveAsDraft();
                showNotification('Risk mitigation applied successfully', 'success');
            }

            closeModal('riskAnalysisModal');
        }
    }

    // Workflow Functions
    function selectContractWorkflow(type) {
        // Only custom workflow is available now
        console.log(' Setting up custom workflow');

        selectedContractWorkflow = 'custom';

        // Show custom workflow configuration
        document.getElementById('customWorkflowConfig').style.display = 'block';

        // Add default step if table is empty
        const tbody = document.getElementById('contractWorkflowSteps');
        if (tbody && tbody.children.length === 0) {
            console.log(' Adding default step');
            addContractWorkflowStep();
        }

        //  ENABLE SAVE BUTTON
        const saveBtn = document.getElementById('saveWorkflowBtn');
        if (saveBtn) {
            saveBtn.disabled = false;
            console.log(' Save button enabled');
        }
    }


    // Global variable to track current department badge ID
    let currentDeptBadgeId = null;

    // Updated: addContractWorkflowStep - with department badge instead of dropdown
    function addContractWorkflowStep() {
        contractWorkflowStepCount++;
        const tbody = document.getElementById('contractWorkflowSteps');
        const newRow = document.createElement('tr');

        const uniqueId = `emailInput_${Date.now()}_${contractWorkflowStepCount}`;
        const suggestionsId = `suggestions_${Date.now()}_${contractWorkflowStepCount}`;
        const deptBadgeId = `deptBadge_${Date.now()}_${contractWorkflowStepCount}`;
        const clearBtnId = `clearBtn_${Date.now()}_${contractWorkflowStepCount}`;

        newRow.innerHTML = `
    <td style="padding: 0.75rem;">
        <span style="width: 28px; height: 28px; background: var(--primary-color); color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600;">${contractWorkflowStepCount}</span>
    </td>
    <td style="padding: 0.75rem;">
        <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
            <option value="">Select Role</option>
            <option value="reviewer">Reviewer</option>
            <option value="approver">Approver</option>  
            <option value="legal_reviewer">Legal Reviewer</option>
            <option value="finance_approver">Finance Approver</option>
            <option value="director">Director</option>
            </select>
         
        </select>
    </td>
    <td style="padding: 0.75rem; position: relative;">
        <div style="position: relative;">
            <input type="email" 
                id="${uniqueId}"
                placeholder="Type to search users..." 
                oninput="searchWorkflowUsers(this, '${suggestionsId}', '${deptBadgeId}')"
                onfocus="searchWorkflowUsers(this, '${suggestionsId}', '${deptBadgeId}')"
                data-email=""
                data-department=""
                style="width: 100%; padding: 0.5rem 2.5rem 0.5rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
            <button type="button" 
                id="${clearBtnId}"
                onclick="clearWorkflowUser('${uniqueId}', '${deptBadgeId}')"
                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem; display: none; z-index: 10;">
                <i class="ti ti-x" style="font-size: 1rem;"></i>
            </button>
            <div id="${suggestionsId}" class="email-suggestions" style="display: none;"></div>
        </div>
    </td>
    <td style="padding: 0.75rem;">
        <div id="${deptBadgeId}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); font-size: 0.875rem; min-height: 38px;">
            <i class="ti ti-building" style="color: var(--primary-color);"></i>
            <span>Not assigned</span>
        </div>
    </td>
    <td style="padding: 0.75rem; text-align: center;">
        <button onclick="removeContractWorkflowStep(this)" 
            style="background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0.25rem 0.5rem;">
            <i class="ti ti-trash" style="font-size: 1.125rem;"></i>
        </button>
    </td>
    `;

        tbody.appendChild(newRow);
        console.log(` Added workflow step ${contractWorkflowStepCount}`);
    }

    function removeContractWorkflowStep(button) {
        const tbody = document.getElementById('contractWorkflowSteps');
        if (tbody.children.length > 1) {
            button.closest('tr').remove();
            updateContractStepNumbers();
        } else {
            showNotification('At least one workflow step is required', 'warning');
        }
    }

    function updateContractStepNumbers() {
        const tbody = document.getElementById('contractWorkflowSteps');
        const rows = tbody.querySelectorAll('tr');

        rows.forEach((row, index) => {
            const stepSpan = row.querySelector('span');
            if (stepSpan) {
                stepSpan.textContent = index + 1;
            }
        });

        contractWorkflowStepCount = rows.length;
        console.log(' Step numbers updated, total:', contractWorkflowStepCount);
    }


    async function openWorkflowSetupModal() {
        console.log(' Opening workflow modal for contract:', contractId);

        const modal = document.getElementById('contractWorkflowModal');
        if (!modal) {
            console.error(' Modal not found: contractWorkflowModal');
            return;
        }

        // Clear the table first
        const tbody = document.getElementById('contractWorkflowSteps');
        if (tbody) {
            tbody.innerHTML = '';
            contractWorkflowStepCount = 0;
        }

        // Auto-select custom workflow (only option)
        selectedContractWorkflow = 'custom';

        // Show the modal
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Load existing workflow data
        await loadExistingWorkflow('custom');

        // If no workflow loaded, add empty step
        if (tbody && tbody.children.length === 0) {
            console.log(' No existing workflow, adding empty step');
            addContractWorkflowStep();
        }

        // Enable the save button
        const saveBtn = document.getElementById('saveWorkflowBtn');
        if (saveBtn) {
            saveBtn.disabled = false;
            console.log(' Save button enabled');
        }
    }




    // Example usage:
    // loadExistingWorkflow();           // Load any workflow
    // loadExistingWorkflow('custom');   // Load only custom workflow (is_master=0)
    // loadExistingWorkflow('master');   // Load only master workflow (is_master=1)


    async function loadExistingWorkflow(contractType = null) {
        if (!contractId) {
            console.log(' No contract ID, skipping workflow load');
            return;
        }

        // Build URL with optional contract_type parameter
        let url = `/api/contracts/workflow/${contractId}`;
        if (contractType) {
            url += `?contract_type=${contractType}`;
        }

        console.log(` Loading workflow for contract: ${contractId}, type: ${contractType || 'any'}`);

        try {
            const response = await fetch(url);
            const data = await response.json();
            console.log(' Workflow API response:', data);

            if (data.success && data.workflow) {
                const workflow = data.workflow;
                console.log(' Workflow loaded:', workflow);
                console.log(' Steps:', workflow.steps);

                if (workflow.steps && workflow.steps.length > 0) {
                    console.log(` Populating ${workflow.steps.length} ${workflow.is_master ? 'master' : 'custom'} workflow steps`);
                    populateCustomWorkflowSteps(workflow.steps);
                }

                showNotification(`Workflow loaded: ${workflow.workflow_name || 'Custom Workflow'}`, 'success');
            } else {
                console.log(' No workflow found for this contract');
            }
        } catch (error) {
            console.error(' Error loading workflow:', error);
            showNotification('Could not load workflow', 'warning');
        }
    }


    // STEP 3: ADD this NEW function (resetWorkflowModal)
    function resetWorkflowModal() {
        console.log(' Resetting workflow modal to default state');

        // Custom workflow is always selected (only option)
        // document.getElementById('customWorkflowOption').classList.add('selected');
        document.getElementById('customWorkflowConfig').style.display = 'block';

        // Clear the table
        const tbody = document.getElementById('contractWorkflowSteps');
        if (tbody) {
            tbody.innerHTML = '';
        }
        contractWorkflowStepCount = 0;

        // Set default to custom workflow
        selectedContractWorkflow = 'custom';

        //  KEEP BUTTON ENABLED (changed from disabled = true)
        const saveBtn = document.getElementById('saveWorkflowBtn');
        if (saveBtn) {
            saveBtn.disabled = false;
            console.log(' Save button kept enabled');
        }
    }

    // STEP 4: ADD this NEW function (updateMasterWorkflowPreview)
    function updateMasterWorkflowPreview(steps) {
        console.log(' Updating master workflow preview with', steps.length, 'steps');

        const previewContainer = document.querySelector('#masterWorkflowOption .workflow-step-preview');
        if (!previewContainer) {
            console.warn(' Preview container not found');
            return;
        }

        let previewHTML = '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; flex-wrap: wrap;">';

        steps.forEach((step, index) => {
            const stepName = step.step_name || step.assignee_role || 'Review';
            const userCount = step.users ? step.users.length : 0;

            console.log(`  Step ${index + 1}: ${stepName} (${userCount} users)`);

            previewHTML += `
            <span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">${index + 1}</span>
            <span>${stepName}${userCount > 0 ? ` (${userCount})` : ''}</span>
        `;

            if (index < steps.length - 1) {
                previewHTML += '<i class="ti ti-arrow-right" style="color: var(--text-muted);"></i>';
            }
        });

        previewHTML += '</div>';
        previewContainer.innerHTML = previewHTML;
        console.log(' Master workflow preview updated');
    }


    function populateCustomWorkflowSteps(steps) {
        const tbody = document.getElementById('contractWorkflowSteps');
        if (!tbody) {
            console.error('contractWorkflowSteps tbody not found');
            return;
        }

        // Clear existing rows
        tbody.innerHTML = '';

        // Reset counter
        contractWorkflowStepCount = 0;

        console.log(' Populating custom workflow with', steps.length, 'steps');

        // Add each step - if step has multiple users, create one row per user
        steps.forEach((step, stepIndex) => {
            console.log(`Step ${stepIndex + 1}:`, step);

            if (step.users && step.users.length > 0) {
                // Create a row for each user in this step
                step.users.forEach((user, userIndex) => {
                    contractWorkflowStepCount++;
                    addWorkflowStepRow(step, user, contractWorkflowStepCount);
                });
            } else {
                // No users assigned, create empty row
                contractWorkflowStepCount++;
                addWorkflowStepRow(step, null, contractWorkflowStepCount);
            }
        });

        // Show custom workflow config
        const customConfig = document.getElementById('customWorkflowConfig');
        if (customConfig) {
            customConfig.style.display = 'block';
        }

        console.log(' Custom workflow populated with', contractWorkflowStepCount, 'rows');
    }

    function addWorkflowStepRow(step, user, rowNumber) {
        const tbody = document.getElementById('contractWorkflowSteps');
        const newRow = document.createElement('tr');

        // Determine values
        const stepType = step.step_type || step.assignee_role || '';
        const userEmail = user ? user.email : '';
        const department = step.department || (user ? user.department : '') || '';

        console.log(` Adding row ${rowNumber}:`, {
            stepType: stepType,
            userEmail: userEmail,
            department: department
        });

        const uniqueId = `emailInput_${Date.now()}_${rowNumber}`;
        const suggestionsId = `suggestions_${Date.now()}_${rowNumber}`;
        const deptBadgeId = `deptBadge_${Date.now()}_${rowNumber}`;

        newRow.innerHTML = `
    <td style="padding: 0.75rem;">
        <span style="width: 28px; height: 28px; background: var(--primary-color); color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600;">${rowNumber}</span>
    </td>
    <td style="padding: 0.75rem;">
        <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
            <option value="">Select Role</option>
            <option value="reviewer" ${stepType === 'reviewer' ? 'selected' : ''}>Reviewer</option>
            <option value="approver" ${stepType === 'approver' ? 'selected' : ''}>Approver</option>  
            <option value="legal_reviewer" ${stepType === 'legal_reviewer' ? 'selected' : ''}>Legal Reviewer</option>
            <option value="finance_approver" ${stepType === 'finance_approver' ? 'selected' : ''}>Finance Approver</option>
            <option value="director" ${stepType === 'director' ? 'selected' : ''}>Director</option>
        </select>
    </td>
    <td style="padding: 0.75rem; position: relative;">
        <input type="email" 
            id="${uniqueId}"
            placeholder="Type to search users..." 
            value="${userEmail}"
            oninput="searchWorkflowUsers(this, '${suggestionsId}', '${deptBadgeId}')"
            onfocus="searchWorkflowUsers(this, '${suggestionsId}', '${deptBadgeId}')"
            data-department="${department}"
            style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
        <div id="${suggestionsId}" class="email-suggestions" style="display: none;"></div>
    </td>
    <td style="padding: 0.75rem;">
        <div id="${deptBadgeId}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); font-size: 0.875rem; min-height: 38px;">
            <i class="ti ti-building" style="color: var(--primary-color);"></i>
            <span>${department || 'Not assigned'}</span>
        </div>
    </td>
    <td style="padding: 0.75rem; text-align: center;">
        <button onclick="removeContractWorkflowStep(this)" 
            style="background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0.25rem 0.5rem;">
            <i class="ti ti-trash" style="font-size: 1.125rem;"></i>
        </button>
    </td>
    `;

        tbody.appendChild(newRow);
        console.log(` Row ${rowNumber} added with email="${userEmail}" dept="${department}"`);
    }


    // STEP 7: ADD this NEW function (removeWorkflowStepRow)
    function removeWorkflowStepRow(button) {
        const tbody = document.getElementById('contractWorkflowSteps');
        if (tbody.children.length > 1) {
            button.closest('tr').remove();
            updateWorkflowStepNumbers();
        } else {
            showNotification('At least one workflow step is required.', 'warning');
        }
    }

    // STEP 8: ADD this NEW function (updateWorkflowStepNumbers)
    function updateWorkflowStepNumbers() {
        const rows = document.querySelectorAll('#contractWorkflowSteps tr');
        rows.forEach((row, index) => {
            const stepSpan = row.querySelector('span');
            if (stepSpan) {
                stepSpan.textContent = index + 1;
            }
        });
        contractWorkflowStepCount = rows.length;
        console.log(' Step numbers updated, total:', contractWorkflowStepCount);
    }

    // Search users function
    async function searchWorkflowUsers(input, suggestionsId, deptBadgeId) {
        const query = input.value.trim();
        const suggestionsDiv = document.getElementById(suggestionsId);

        currentSearchInput = input;
        currentDeptBadgeId = deptBadgeId; // Store for use in selectWorkflowUser

        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        if (!query) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                suggestionsDiv.innerHTML = `
                <div style="padding: 0.75rem; text-align: center; color: var(--text-muted);">
                    <i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> Searching...
                </div>
            `;
                suggestionsDiv.style.display = 'block';

                const response = await fetch(`/api/users/company?search=${encodeURIComponent(query)}&limit=10`);

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const data = await response.json();
                const users = data.users || [];

                if (users.length === 0) {
                    suggestionsDiv.innerHTML = `
                    <div style="padding: 0.75rem; text-align: center; color: var(--text-muted);">
                        <i class="ti ti-user-x"></i> No users found
                    </div>
                `;
                } else {
                    suggestionsDiv.innerHTML = users.map(user => {
                        const fullName = `${user.first_name} ${user.last_name}`.trim();
                        const badge = user.department ?
                            `<span style="font-size: 0.75rem; padding: 0.125rem 0.375rem; background: var(--primary-color); color: white; border-radius: 4px; margin-left: 0.25rem;">${user.department}</span>` : '';

                        // Store user data as JSON in data attribute
                        const userData = JSON.stringify({
                            email: user.email,
                            department: user.department || '',
                            fullName: fullName
                        });

                        return `
                        <div onclick='selectWorkflowUser(${JSON.stringify(userData)}, "${input.id}", "${suggestionsId}", "${deptBadgeId}")' 
                            style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;"
                            onmouseover="this.style.background='var(--background-light)'"
                            onmouseout="this.style.background='white'">
                            <div style="font-weight: 600; color: var(--text-color);">
                                ${fullName} ${badge}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                ${user.email}
                            </div>
                        </div>
                    `;
                    }).join('');
                }
            } catch (error) {
                console.error('Search error:', error);
                suggestionsDiv.innerHTML = `
                <div style="padding: 0.75rem; text-align: center; color: var(--danger-color);">
                    <i class="ti ti-alert-circle"></i> Search failed
                </div>
            `;
            }
        }, 300);
    }
    function clearWorkflowUser(inputId, deptBadgeId) {
        const input = document.getElementById(inputId);
        const deptBadge = document.getElementById(deptBadgeId);

        console.log(' Clearing user from input:', inputId);

        if (input) {
            // Clear input value and data attributes
            input.value = '';
            input.setAttribute('data-email', '');
            input.setAttribute('data-department', '');
            input.classList.remove('has-user-selected');

            // Hide clear button
            const clearBtn = input.nextElementSibling;
            if (clearBtn && clearBtn.tagName === 'BUTTON') {
                clearBtn.style.display = 'none';
            }

            // Focus input for new search
            input.focus();
        }

        // Reset department badge
        if (deptBadge) {
            const badgeText = deptBadge.querySelector('span');
            if (badgeText) {
                badgeText.textContent = 'Not assigned';
            }
        }

        console.log(' User cleared, ready for new search');
    }


    // Select user from suggestions
    function selectWorkflowUser(userDataJson, inputId, suggestionsId, deptBadgeId) {
        const userData = JSON.parse(userDataJson);
        const input = document.getElementById(inputId);
        const suggestionsDiv = document.getElementById(suggestionsId);
        const deptBadge = document.getElementById(deptBadgeId);

        console.log(' Selected user:', userData);

        // Set email value
        if (input) {
            input.value = userData.email;
            // Store department in data attribute
            input.setAttribute('data-department', userData.department || '');
        }

        // Update department badge
        if (deptBadge) {
            const badgeText = deptBadge.querySelector('span');
            if (badgeText) {
                badgeText.textContent = userData.department || 'Not assigned';
            }
            console.log(' Department updated to:', userData.department || 'Not assigned');
        }

        // Hide suggestions
        if (suggestionsDiv) {
            suggestionsDiv.style.display = 'none';
        }

        showNotification(`Selected: ${userData.fullName}`, 'success');
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', function (e) {
        const suggestions = document.querySelectorAll('.email-suggestions');
        suggestions.forEach(div => {
            if (!div.contains(e.target) && !e.target.classList.contains('email-search-input')) {
                div.style.display = 'none';
            }
        });
    });


    // Update master workflow preview with actual steps

    function updateMasterWorkflowPreview(steps) {
        const previewContainer = document.querySelector('#masterWorkflowOption .workflow-step-preview');
        if (!previewContainer) {
            console.warn('Preview container not found');
            return;
        }

        let previewHTML = '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; flex-wrap: wrap;">';

        steps.forEach((step, index) => {
            const stepName = step.step_name || step.assignee_role || 'Review';
            const userCount = step.users ? step.users.length : 0;

            previewHTML += `
            <span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">${index + 1}</span>
            <span>${stepName}${userCount > 0 ? ` (${userCount})` : ''}</span>
        `;

            if (index < steps.length - 1) {
                previewHTML += '<i class="ti ti-arrow-right" style="color: var(--text-muted);"></i>';
            }
        });

        previewHTML += '</div>';
        previewContainer.innerHTML = previewHTML;
        console.log(' Master workflow preview updated');
    }


    // Populate custom workflow steps table
    function populateCustomWorkflowSteps(steps) {
        const tbody = document.getElementById('contractWorkflowSteps');
        if (!tbody) {
            console.error('contractWorkflowSteps tbody not found');
            return;
        }

        // Clear existing rows
        tbody.innerHTML = '';

        // Reset counter
        contractWorkflowStepCount = 0;

        console.log(' Populating custom workflow with', steps.length, 'steps');

        // Add each step - if step has multiple users, create one row per user
        steps.forEach((step, stepIndex) => {
            console.log(`Step ${stepIndex + 1}:`, step);

            if (step.users && step.users.length > 0) {
                // Create a row for each user in this step
                step.users.forEach((user, userIndex) => {
                    contractWorkflowStepCount++;
                    addWorkflowStepRow(step, user, contractWorkflowStepCount);
                });
            } else {
                // No users assigned, create empty row
                contractWorkflowStepCount++;
                addWorkflowStepRow(step, null, contractWorkflowStepCount);
            }
        });

        // Show custom workflow config
        document.getElementById('customWorkflowConfig').style.display = 'block';
        console.log(' Custom workflow populated with', contractWorkflowStepCount, 'rows');
    }


    function updateStepNumbers() {
        const rows = document.querySelectorAll('#contractWorkflowSteps tr');
        rows.forEach((row, index) => {
            const stepNumber = row.querySelector('span');
            if (stepNumber) {
                stepNumber.textContent = index + 1;
            }
        });
        contractWorkflowStepCount = rows.length;
    }




    function navigateToStep(step) {
        showNotification(`Navigating to ${step} phase`, 'info');
    }

    function viewAsCounterParty() {
        window.location.href = `/contract/counter-party-edit/${contractId}`;
    }

    function execCmd(command, value) {
        document.execCommand(command, false, value || null);
        saveAsDraft();
    }

    // Utility Functions
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    }


    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';

            //  If closing workflow modal, reset it
            if (modalId === 'contractWorkflowModal') {
                // Don't reset completely, just clear table to prevent duplicates
                const tbody = document.getElementById('contractWorkflowSteps');
                if (tbody) {
                    tbody.innerHTML = '';
                }
                contractWorkflowStepCount = 0;
            }
        }
    }

    function showLoader(message) {
        let loader = document.getElementById('loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'loader';
            loader.className = 'loader-overlay';
            loader.innerHTML = `
            <div class="loader">
                <div class="spinner"></div>
                <p>${message}</p>
            </div>
        `;
            document.body.appendChild(loader);
        }
        loader.style.display = 'flex';
    }

    function hideLoader() {
        const loader = document.getElementById('loadingOverlay');
        if (loader) {
            loader.classList.remove('show');
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const colors = {
            success: 'var(--success-color)',
            error: 'var(--danger-color)',
            info: 'var(--primary-color)',
            warning: 'var(--warning-color)'
        };
        const icons = {
            success: 'check',
            error: 'alert-circle',
            info: 'info-circle',
            warning: 'alert-triangle'
        };
        notification.style.cssText = `
        position: fixed; 
        top: 10px; 
        right: 250px;  /* Increased from 20px to 40px */
        background: ${colors[type] || colors.info};
        color: white; 
        padding: 1rem 1.5rem; 
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        z-index: 10000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
        notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="ti ti-${icons[type] || icons.info}"></i>
            ${message}
        </div>
    `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 4000);
    }

    function showError(message) {
        document.getElementById('contractEditor').innerHTML = `
        <div style="padding: 3rem; text-align: center;">
            <i class="ti ti-alert-circle" style="font-size: 4rem; color: var(--danger-color);"></i>
            <h2 style="margin-top: 1rem; color: var(--text-color);">Error Loading Contract</h2>
            <p style="color: var(--text-muted); margin: 1rem 0;">${message}</p>
            <button onclick="refreshContractData()" class="btn btn-primary" style="margin-top: 1rem;">
                <i class="ti ti-refresh"></i> Retry
            </button>
        </div>
    `;
        document.getElementById('contractEditor').classList.add('loaded');
        document.getElementById('contractEditor').style.display = 'block';
    }

    // Clean up on page unload
    // window.addEventListener('beforeunload', function (e) {
    //     // Check if there are unsaved changes
    //     const currentContent = document.getElementById('contractContent')?.innerHTML || '';
    //     if (currentContent && currentContent !== originalContent) {
    //         e.preventDefault();
    //         e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    //         return e.returnValue;
    //     }
    // });

    // Cleanup intervals on page unload
    window.addEventListener('unload', function () {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });

    // =====================================================
    // SEND TO COUNTER-PARTY FUNCTIONS
    // =====================================================

    // Open Send to Counter-Party Modal
    function openSendToCounterPartyModal() {
        openModal('sendToCounterPartyModal');
    }

    // Submit Send to Counter-Party - CONNECTED TO BACKEND
    async function submitSendToCounterParty() {
        const email = document.getElementById('counterPartyEmail')?.value.trim();
        const message = document.getElementById('counterPartyMessage')?.value.trim() || '';

        if (!email) {
            showNotification('Please enter a counter-party email address', 'error');
            return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNotification('Please enter a valid email address', 'error');
            return;
        }

        showLoader();
        try {
            const response = await fetch('/api/contracts/send-to-counterparty', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId,
                    counterparty_email: email,
                    counterparty_user_id: selectedCounterPartyEmail ? selectedCounterPartyEmail.userId : null,
                    counterparty_company_id: selectedCounterPartyEmail ? selectedCounterPartyEmail.companyId : null,
                    counterparty_company_name: selectedCounterPartyEmail ? selectedCounterPartyEmail.companyName : null,
                    message: message
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Contract sent to counter-party successfully!', 'success');
                closeModal('sendToCounterPartyModal');
                document.getElementById('counterPartyEmail').value = '';
                document.getElementById('counterPartyMessage').value = '';
                selectedCounterPartyEmail = null;
                setTimeout(async () => await refreshContractData(), 1000);
            } else {
                showNotification(data.message || 'Failed to send contract to counter-party', 'error');
            }
        } catch (error) {
            console.error('Error sending to counter-party:', error);
            showNotification('Failed to send contract to counter-party', 'error');
        } finally {
            hideLoader();
        }
    }
    // =====================================================
    // COUNTER-PARTY ACTION FUNCTIONS (for negotiation stage)
    // =====================================================

    // Quick Approve - CONNECTED TO BACKEND

    async function quickApprove() {
        // Create custom confirmation modal
        const userConfirmed = await showCustomConfirm(
            'Finalize Agreement?',
            'Press "Yes" if you have completed the Negotiation before finalizing the Agreement else Press "No" if you want to approve without Negotiation'
        );

        if (userConfirmed) {
            showLoader();
            try {
                const response = await fetch('/api/contracts/quick-approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contract_id: contractId
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification(' Counterparty Approval Completed and sent to Initiator for next steps!', 'success');
                    setTimeout(async () => await refreshContractData(), 1000);
                } else {
                    showNotification(data.message || 'Failed to approve contract', 'error');
                }
            } catch (error) {
                console.error('Error approving contract:', error);
                showNotification('Failed to approve contract', 'error');
            } finally {
                hideLoader();
            }
        }
    }

    // Custom confirmation function where both buttons proceed
    function showCustomConfirm(title, message) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'modal modal-blur fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
            <div class="modal-dialog modal-sm modal-dialog-centered" id="quickfinalizeModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                         <button class="modal-close" onclick="closeModal('quickfinalizeModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" id="confirmYes">
                            <i class="ti ti-check icon"></i> Yes
                        </button>
                        <button type="button" class="btn btn-primary" id="confirmNo">
                            <i class="ti ti-x icon"></i> No
                        </button>
                    </div>
                </div>
            </div>
        `;

            document.body.appendChild(modal);

            // Both buttons do the same thing - proceed with approval
            const yesBtn = modal.querySelector('#confirmYes');
            const noBtn = modal.querySelector('#confirmNo');

            const handleClick = () => {
                modal.remove();
                resolve(true); // Both buttons return true to proceed
            };

            yesBtn.addEventListener('click', handleClick);
            noBtn.addEventListener('click', handleClick);
        });
    }


    // Open Negotiation Modal
    function openNegotiationModal() {
        openModal('negotiationModal');
    }






    function openNegotiationConfirmationModal() {
        openModal('negotiationConfirmationModal');
    }


    // =====================================================
    // EXECUTE CONTRACT FUNCTIONS
    // =====================================================

    // Open Execute Contract Modal - Only shown when contract is 'signed'
    function openExecuteContractModal() {
        // Verify contract is in signed status
        if (contractData?.contract?.status !== 'signed') {
            showNotification('Contract must be fully signed before execution', 'error');
            return;
        }

        // Update execution dates in modal
        const today = new Date();
        document.getElementById('executionDate').textContent = today.toLocaleDateString();
        document.getElementById('effectiveDate').textContent = today.toLocaleDateString();

        // Reset checkbox
        document.getElementById('confirmExecution').checked = false;
        document.getElementById('executeContractBtn').disabled = true;

        openModal('executeContractModal');
    }

    // Toggle Execute Button based on confirmation checkbox
    function toggleExecuteButton() {
        const checkbox = document.getElementById('confirmExecution');
        const button = document.getElementById('executeContractBtn');
        button.disabled = !checkbox.checked;
    }


    async function markCounterpartyReviewComplete() {
        if (!confirm('Do you want to confirm review?')) {
            return;
        }

        try {
            showLoader('Completing counterparty review...');

            const response = await fetch(
                `/api/contracts/${contractId}/complete-counterparty-review`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                }
            );

            const data = await response.json();

            if (data.success) {
                showNotification('Review completed successfully!', 'success');
                setTimeout(async () => await refreshContractData(), 1000);
            } else {
                showError(data.message);
            }
        } catch (error) {
            showError('Failed to complete review');
        } finally {
            hideLoader();
        }
    }

    // Execute Contract - CONNECTED TO BACKEND
    async function executeContract() {
        if (!confirm('Are you sure you want to execute this contract? This action will mark the contract as officially active and enforceable.')) {
            return;
        }

        showLoader();
        try {
            const response = await fetch('/api/contracts/execute-contract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: parseInt(contractId)
                })
            });

            const data = await response.json();

            if (data.success) {
                closeModal('executeContractModal');

                showNotification('Contract executed successfully!', 'success');

                // Update UI immediately
                updateUIForExecutedStatus();

                // Show Certificate of Completion
                setTimeout(() => {
                    displayCertificateOfCompletion(data.certificate_data);
                }, 1000);

                // Reload page after showing certificate
                setTimeout(async () => await refreshContractData(), 3000);
            } else {
                showNotification(data.detail || 'Failed to execute contract', 'error');
            }
        } catch (error) {
            console.error('Error executing contract:', error);
            showNotification('Failed to execute contract', 'error');
        } finally {
            hideLoader();
        }
    }

    // Update UI for Executed Status
    function updateUIForExecutedStatus() {
        // Update workflow stepper - mark all steps as completed
        const steps = document.querySelectorAll('.stepper-step');
        steps.forEach(step => {
            step.classList.remove('active', 'pending');
            step.classList.add('completed');
            const dateEl = step.querySelector('.step-date');
            if (dateEl) dateEl.textContent = 'Completed';
        });

        // Update progress bar to 100%
        const progressBar = document.getElementById('stepperProgress');
        if (progressBar) progressBar.style.width = '100%';

        // Update workflow status text
        const statusText = document.getElementById('workflowStatusText');
        if (statusText) statusText.textContent = 'Fully Executed';

        // Update page header if present
        const pageDescription = document.querySelector('.page-description');
        if (pageDescription) {
            pageDescription.innerHTML += ' <span style="color: var(--success-color); font-weight: 600;">- EXECUTED</span>';
        }
    }

    // Display Certificate of Completion
    function displayCertificateOfCompletion(certificateData) {
        const content = document.getElementById('certificateContent');

        const executionDate = new Date(certificateData.execution_date).toLocaleString();
        const signedDate = certificateData.signed_date ? new Date(certificateData.signed_date).toLocaleString() : 'N/A';

        content.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto; padding: 2rem; background: white; border: 2px solid var(--success-color); border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
            <!-- Certificate Header -->
            <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 3px solid var(--success-color);">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--success-color), #20c997); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2.5rem;">
                    <i class="ti ti-certificate"></i>
                </div>
                <h2 style="margin: 0; color: var(--success-color); font-size: 1.75rem;">Certificate of Completion</h2>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.95rem;">Contract Execution Verification</p>
            </div>
            
            <!-- Contract Details -->
            <div style="background: var(--background-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text-color);">Contract Information</h4>
                <div style="display: grid; gap: 0.75rem; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted); font-weight: 500;">Contract Number:</span>
                        <strong>${certificateData.contract_number || 'N/A'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted); font-weight: 500;">Contract Title:</span>
                        <strong>${certificateData.contract_title || 'N/A'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted); font-weight: 500;">Signed Date:</span>
                        <strong>${signedDate}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                        <span style="color: var(--text-muted); font-weight: 500;">Execution Date:</span>
                        <strong style="color: var(--success-color);">${executionDate}</strong>
                    </div>
                </div>
            </div>
            
            <!-- Signatories -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text-color);">Authorized Signatories</h4>
                ${certificateData.signatories.map((sig, index) => `
                    <div style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.25rem; flex-shrink: 0;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-color);">${sig.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <span style="text-transform: capitalize;">${sig.signer_type}</span>  
                                Signed: ${sig.signed_at ? new Date(sig.signed_at).toLocaleString() : 'N/A'}
                            </div>
                            ${sig.ip_address ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">IP: ${sig.ip_address}</div>` : ''}
                        </div>
                        <i class="ti ti-circle-check" style="font-size: 1.5rem; color: var(--success-color);"></i>
                    </div>
                `).join('')}
            </div>
            
            <!-- Verification Statement -->
            <div style="background: rgba(40, 167, 69, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--success-color); margin-bottom: 1.5rem;">
                <p style="margin: 0; font-size: 0.95rem; line-height: 1.6; color: var(--text-secondary);">
                    <strong>This certifies that</strong> the above-referenced contract has been executed by all authorized parties and is now legally binding and enforceable. All signatures have been verified and the contract is active as of the execution date stated above.
                </p>
            </div>
            
            <!-- Footer -->
            <div style="text-align: center; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                    Executed by: <strong>${certificateData.executed_by || 'System'}</strong>
                </p>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--text-muted);">
                    Certificate ID: CERT-${certificateData.contract_id}-${Date.now()}
                </p>
            </div>
        </div>
    `;

        openModal('certificateModal');
    }

    // Download Certificate

    async function downloadCertificate() {
        showLoader();
        try {
            const response = await fetch(`/api/contracts/execution-certificate/${contractId}`);
            const data = await response.json();

            if (data.success) {
                const certificateData = data.certificate;

                // Generate PDF certificate
                await generateCertificatePDF(certificateData);

                showNotification('Certificate downloaded successfully', 'success');
            } else {
                showNotification('Failed to download certificate', 'error');
            }
        } catch (error) {
            console.error('Error downloading certificate:', error);
            showNotification('Failed to download certificate', 'error');
        } finally {
            hideLoader();
        }
    }


    // New function to generate PDF certificate
    // REPLACE generateCertificatePDF() function - OPTIMIZED FOR SINGLE A4 PAGE

    async function generateCertificatePDF(certificateData) {
        // Format dates
        const executionDate = certificateData.execution_date ?
            new Date(certificateData.execution_date).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'N/A';

        const signedDate = certificateData.signed_date ?
            new Date(certificateData.signed_date).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'N/A';

        // Certificate ID
        const certificateId = `CERT-${certificateData.contract_id}-${Date.now()}`;

        // Create a temporary div optimized for A4 size (210mm x 297mm = ~794px x 1123px at 96dpi)
        const certificateDiv = document.createElement('div');
        certificateDiv.style.position = 'absolute';
        certificateDiv.style.left = '-9999px';
        certificateDiv.style.width = '794px';  // A4 width in pixels
        certificateDiv.style.height = '1123px'; // A4 height in pixels
        certificateDiv.style.padding = '30px';
        certificateDiv.style.backgroundColor = '#ffffff';
        certificateDiv.style.fontFamily = 'Arial, sans-serif';
        certificateDiv.style.boxSizing = 'border-box';
        certificateDiv.style.overflow = 'hidden';

        certificateDiv.innerHTML = `
        <div style="border: 5px solid #2563eb; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%); height: 100%; box-sizing: border-box; display: flex; flex-direction: column;">
            
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #2563eb; padding-bottom: 15px;">
                <div style="width: 60px; height: 60px; margin: 0 auto 10px; background: linear-gradient(135deg, #2563eb, #1d4ed8); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M9 12l2 2 4-4m6-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 style="margin: 0; font-size: 28px; color: #1e293b; font-weight: 700; letter-spacing: 1px;">
                    CERTIFICATE OF COMPLETION
                </h1>
                <p style="margin: 8px 0 0 0; font-size: 11px; color: #64748b; font-style: italic;">
                    Contract Lifecycle Management System - CALIM 360
                </p>
            </div>

            <!-- Contract Details -->
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 14px; font-weight: 600; border-bottom: 2px solid #2563eb; padding-bottom: 6px;">
                    Contract Information
                </h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 7px 0; font-weight: 600; color: #475569; width: 38%; font-size: 11px;">Contract Number:</td>
                        <td style="padding: 7px 0; color: #1e293b; font-weight: 500; font-size: 11px;">${certificateData.contract_number || 'N/A'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 7px 0; font-weight: 600; color: #475569; font-size: 11px;">Contract Title:</td>
                        <td style="padding: 7px 0; color: #1e293b; font-weight: 500; font-size: 11px;">${certificateData.contract_title || 'Untitled Contract'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 7px 0; font-weight: 600; color: #475569; font-size: 11px;">Execution Date:</td>
                        <td style="padding: 7px 0; color: #059669; font-weight: 600; font-size: 11px;">${executionDate}</td>
                    </tr>
                    <tr>
                        <td style="padding: 7px 0; font-weight: 600; color: #475569; font-size: 11px;">Signed Date:</td>
                        <td style="padding: 7px 0; color: #1e293b; font-weight: 500; font-size: 11px;">${signedDate}</td>
                    </tr>
                </table>
            </div>

            <!-- Authorized Signatories -->
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex: 1; overflow: hidden;">
                <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 14px; font-weight: 600; border-bottom: 2px solid #2563eb; padding-bottom: 6px;">
                    Authorized Signatories
                </h3>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${certificateData.signatories.map((sig, index) => `
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
                            <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #2563eb, #1d4ed8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; margin-right: 10px; flex-shrink: 0;">
                                ${index + 1}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 12px; color: #1e293b; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${sig.name}</div>
                                <div style="font-size: 10px; color: #64748b;">
                                    <span style="text-transform: capitalize; font-weight: 500;">${sig.signer_type}</span>  
                                    ${sig.signed_at ? new Date(sig.signed_at).toLocaleDateString() : 'Pending'}
                                </div>
                                ${sig.ip_address ? `<div style="font-size: 9px; color: #94a3b8; margin-top: 2px;">IP: ${sig.ip_address}</div>` : ''}
                            </div>
                            <div style="color: #059669; font-size: 22px; margin-left: 8px; flex-shrink: 0;"></div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Verification Statement -->
            <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-left: 3px solid #059669; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                <p style="margin: 0; font-size: 10px; line-height: 1.5; color: #065f46; font-weight: 500;">
                    <strong style="font-size: 11px;">CERTIFICATION:</strong> This certifies that the above-referenced contract has been executed by all authorized parties and is legally binding. All signatures verified and contract active as of execution date.
                </p>
            </div>

            <!-- Footer -->
            <div style="text-align: center; padding-top: 12px; border-top: 2px solid #e2e8f0;">
                <div style="margin-bottom: 8px;">
                    <p style="margin: 0; font-size: 10px; color: #64748b;">
                        <strong style="color: #1e293b;">Executed by:</strong> ${certificateData.executed_by || 'System'}
                    </p>
                    ${certificateData.executed_by_email ? `<p style="margin: 3px 0 0 0; font-size: 9px; color: #94a3b8;">${certificateData.executed_by_email}</p>` : ''}
                </div>
                <div style="padding: 8px; background: #f8fafc; border-radius: 6px;">
                    <p style="margin: 0; font-size: 9px; color: #64748b; font-weight: 600;">
                        Certificate ID: ${certificateId}
                    </p>
                    <p style="margin: 3px 0 0 0; font-size: 8px; color: #94a3b8;">
                        Generated: ${new Date().toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        })}
                    </p>
                </div>
                <p style="margin: 8px 0 0 0; font-size: 8px; color: #94a3b8; font-style: italic;">
                    CALIM 360 Smart Contract Lifecycle Management Platform
                </p>
            </div>
        </div>
    `;

        // Append to body temporarily
        document.body.appendChild(certificateDiv);

        try {
            // Wait for rendering
            await new Promise(resolve => setTimeout(resolve, 100));

            // Use html2canvas with exact A4 dimensions
            const canvas = await html2canvas(certificateDiv, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                width: 794,
                height: 1123,
                windowWidth: 794,
                windowHeight: 1123
            });

            // Get the jsPDF library
            const { jsPDF } = window.jspdf;

            // Create PDF with A4 dimensions
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // Add image to fit exactly on A4 (210mm x 297mm)
            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);

            // Save the PDF
            const fileName = `Certificate_of_Completion_${certificateData.contract_number || certificateData.contract_id}.pdf`;
            pdf.save(fileName);

            console.log(' Single-page PDF generated successfully:', fileName);

        } catch (error) {
            console.error(' Error generating PDF:', error);
            throw error;
        } finally {
            // Remove temporary div
            document.body.removeChild(certificateDiv);
        }
    }

    // View Certificate - Can be called anytime for executed contracts
    async function viewExecutionCertificate() {
        showLoader();
        try {
            const response = await fetch(`/api/contracts/execution-certificate/${contractId}`);
            const data = await response.json();

            if (data.success) {
                displayCertificateOfCompletion(data.certificate);
            } else {
                showNotification('Certificate not found', 'error');
            }
        } catch (error) {
            console.error('Error viewing certificate:', error);
            showNotification('Failed to load certificate', 'error');
        } finally {
            hideLoader();
        }
    }


</script>


<!-- Add this before </body> -->
<script src="/static/js/blockchain-verification.js"></script>

<script>
    // Get contract ID from URL or form


    // Set contract ID when page loads
    document.addEventListener('DOMContentLoaded', function () {

        if (contractId) {
            const indicator = document.getElementById('blockchain-indicator');
            if (indicator) {
                indicator.id = `blockchain-indicator-${contractId}`;
                indicator.setAttribute('data-contract-id', contractId);
            }

            // Auto-verify after 1 second
            setTimeout(() => {
                verifyContract(contractId);
            }, 1000);


            if (typeof contractId !== 'undefined' && contractId) {

            }
        }
    });


    window.refreshComments = function () {
        console.log(' Manually refreshing comments...');

        // Remove old bubbles
        document.querySelectorAll('.comment-bubble').forEach(b => b.remove());


    };

    // Wrapper function for verify button
    function verifyContractNow() {

        if (contractId) {
            verifyContract(contractId);
        } else {
            showNotification('Contract ID not found. Please save the contract first.', 'error');

        }
    }

    // Wrapper function for certificate button
    function showBlockchainCertificate() {
        if (contractId) {
            // Call the function from blockchain-verification.js
            showBlockchainCertificateById(contractId);
        } else {
            showNotification('Contract ID not found. Please save the contract first.', 'error');

        }
    }

    // Get contract content for hashing
    function getContractContent() {
        const contractNumber = document.getElementById('contract_number')?.value ||
            document.querySelector('[name="contract_number"]')?.value || '';
        const contractTitle = document.getElementById('contract_title')?.value ||
            document.querySelector('[name="contract_title"]')?.value || '';
        const contractType = document.getElementById('contract_type')?.value ||
            document.querySelector('[name="contract_type"]')?.value || '';
        const contractValue = document.getElementById('contract_value')?.value ||
            document.querySelector('[name="contract_value"]')?.value || '';
        const startDate = document.getElementById('start_date')?.value || '';
        const endDate = document.getElementById('end_date')?.value || '';

        return `${contractNumber}|${contractTitle}|${contractType}|${startDate}|${endDate}|${contractValue}`;
    }

    // Info modal function
    function showBlockchainInfo() {
        const infoText = ` Blockchain Verification

This contract is secured using Hyperledger Fabric blockchain technology.

Benefits:
 Tamper-proof - Any changes are immediately detected
 Immutable - Permanent record that cannot be altered
 Transparent - Full audit trail of all changes
 Compliant - Meets QFCRA regulatory requirements

The blockchain stores a cryptographic hash (SHA-256) of your contract, ensuring document integrity and authenticity.

How it works:
1. When you save the contract, a unique hash is generated
2. This hash is stored on the blockchain
3. Any future verification compares the current hash with the blockchain record
4. If they don't match, tampering is detected`;

        alert(infoText);
    }
</script>




<script>
    // =====================================================
    // AI RISK ANALYSIS JAVASCRIPT - Full Implementation
    // =====================================================

    // let riskAnalysisData = null;

    async function runRiskAnalysis() {
        const modal = document.getElementById('riskAnalysisModal');
        const content = document.getElementById('riskAnalysisContent');
        const badgeEl = document.getElementById('aiPoweredBadge');

        if (!contractId) {
            showNotification('No contract selected', 'error');
            return;
        }

        // Show loading state
        content.innerHTML = `
        <div class="text-center" style="padding: 3rem;">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; border-width: 0.25rem;">
                <div class="ai-loader"></div>
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 style="margin-top: 1.5rem; color: var(--text-color);">Analyzing Contract</h4>
            <p style="color: var(--text-muted);">AI is analyzing your contract for potential risks...</p>
        </div>
    `;

        openModal('riskAnalysisModal');

        try {
            console.log(` Requesting risk analysis for contract ${contractId}`);
            const response = await fetch(`/api/contracts/risk-analysis/${contractId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log(' Risk analysis response:', data);

            if (data.success && data.analysis) {
                riskAnalysisData = data.analysis;

                // Show AI badge if AI-powered
                if (data.ai_powered && badgeEl) {
                    badgeEl.style.display = 'inline-flex';
                }

                // Display the analysis
                displayRiskAnalysis(data.analysis);

                // Update timestamp
                const timestampEl = document.getElementById('analysisTimestamp');
                if (timestampEl) {
                    timestampEl.innerHTML = `
                    <i class="ti ti-clock"></i> 
                    Analyzed: ${new Date().toLocaleString()}
                    ${data.ai_powered ? '<span class="badge badge-ai"><i class="ti ti-robot"></i> AI Powered</span>' : ''}
                `;
                }

                showNotification('Risk analysis completed', 'success');
            } else {
                throw new Error(data.message || 'Failed to analyze contract');
            }

        } catch (error) {
            console.error(' Error in risk analysis:', error);
            content.innerHTML = `
            <div class="text-center" style="padding: 3rem;">
                <div style="width: 80px; height: 80px; background: rgba(220, 53, 69, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                    <i class="ti ti-alert-triangle" style="font-size: 2.5rem; color: var(--danger-color);"></i>
                </div>
                <h4 style="color: var(--text-color); margin-bottom: 0.5rem;">Analysis Failed</h4>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">${error.message}</p>
                <button class="btn btn-primary" onclick="runRiskAnalysis()">
                    <i class="ti ti-refresh"></i> Try Again
                </button>
            </div>
        `;
            showNotification('Risk analysis failed: ' + error.message, 'error');
        }
    }

    // Display Risk Analysis - FIXED VERSION
    function displayRiskAnalysis(analysis) {
        const content = document.getElementById('riskAnalysisContent');

        // Safely get values with defaults
        const highRisks = analysis.high_risks || 0;
        const mediumRisks = analysis.medium_risks || 0;
        const lowRisks = analysis.low_risks || 0;
        const safetyScore = analysis.overall_score || 0;
        const riskItems = analysis.risk_items || [];
        const executiveSummary = analysis.executive_summary || 'No summary available.';
        const riskLevel = analysis.risk_level || 'Unknown';

        console.log(' Displaying risk analysis:', {
            highRisks,
            mediumRisks,
            lowRisks,
            safetyScore,
            itemCount: riskItems.length
        });

        content.innerHTML = `
        <!-- Risk Statistics Header -->
        <div class="risk-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
            <div class="risk-stat-card high" style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(220, 53, 69, 0.2); text-align: center;">
                <div class="risk-stat-value" style="font-size: 2.5rem; font-weight: 700; color: #dc3545; margin-bottom: 0.5rem;">${highRisks}</div>
                <div class="risk-stat-label" style="font-size: 0.875rem; color: #6c757d; text-transform: uppercase; font-weight: 600;">HIGH RISK</div>
            </div>
            
            <div class="risk-stat-card medium" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(255, 193, 7, 0.2); text-align: center;">
                <div class="risk-stat-value" style="font-size: 2.5rem; font-weight: 700; color: #ffc107; margin-bottom: 0.5rem;">${mediumRisks}</div>
                <div class="risk-stat-label" style="font-size: 0.875rem; color: #6c757d; text-transform: uppercase; font-weight: 600;">MEDIUM RISK</div>
            </div>
            
            <div class="risk-stat-card low" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(40, 167, 69, 0.2); text-align: center;">
                <div class="risk-stat-value" style="font-size: 2.5rem; font-weight: 700; color: #28a745; margin-bottom: 0.5rem;">${lowRisks}</div>
                <div class="risk-stat-label" style="font-size: 0.875rem; color: #6c757d; text-transform: uppercase; font-weight: 600;">LOW RISK</div>
            </div>
            
            <div class="risk-stat-card safety" style="background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 123, 255, 0.05) 100%); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(0, 123, 255, 0.2); text-align: center;">
                <div class="risk-stat-value" style="font-size: 2.5rem; font-weight: 700; color: #007bff; margin-bottom: 0.5rem;">${safetyScore}%</div>
                <div class="risk-stat-label" style="font-size: 0.875rem; color: #6c757d; text-transform: uppercase; font-weight: 600;">SAFETY SCORE</div>
            </div>
        </div>
        
        <!-- Executive Summary -->
        ${executiveSummary ? `
        <div class="executive-summary" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #007bff; margin-bottom: 2rem;">
            <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #212529;">
                <i class="ti ti-report-analytics"></i> Executive Summary
            </h4>
            <p style="color: #495057; line-height: 1.8; margin: 0;">${executiveSummary}</p>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                <span class="badge" style="background: ${getRiskLevelColor(riskLevel)}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                    Overall Risk Level: ${riskLevel.toUpperCase()}
                </span>
            </div>
        </div>
        ` : ''}
        
        <!-- Detailed Risk Analysis -->
        <div class="risk-items-container">
            <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; color: #212529;">
                <i class="ti ti-list-details"></i>
                Detailed Risk Analysis
                <span style="background: #007bff; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                    ${riskItems.length} ${riskItems.length === 1 ? 'item' : 'items'} identified
                </span>
            </h4>
            
            ${riskItems.length > 0 ? riskItems.map((risk, index) => {
            const severity = (risk.severity || 'medium').toLowerCase();
            const severityColor = getSeverityColor(severity);
            const severityBg = getSeverityBackground(severity);

            return `
                <div class="risk-item" id="riskItem${index}" style="background: white; border: 2px solid ${severityBg}; border-radius: 12px; margin-bottom: 1rem; overflow: hidden; transition: all 0.3s ease;">
                    <div class="risk-item-header" onclick="toggleRiskItem(${index})" style="padding: 1.25rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: ${severityBg};">
                        <div class="risk-item-title" style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                            <i class="ti ti-${getRiskIcon(risk.type)}" style="font-size: 1.5rem; color: ${severityColor};"></i>
                            <div>
                                <div style="font-weight: 600; color: #212529; font-size: 1rem;">${risk.issue || 'Unknown Risk'}</div>
                                <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                                    ${formatRiskType(risk.type)}  ${risk.clause_reference || 'General'}
                                </div>
                            </div>
                        </div>
                        <div class="risk-item-badges" style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="severity-badge" style="background: ${severityColor}; color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                                ${severity}
                            </span>
                            ${risk.score ? `
                            <span style="background: white; color: ${severityColor}; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; border: 2px solid ${severityColor};">
                                Score: ${risk.score}
                            </span>
                            ` : ''}
                            <i class="ti ti-chevron-down" id="chevron${index}" style="font-size: 1.25rem; color: ${severityColor}; transition: transform 0.3s ease;"></i>
                        </div>
                    </div>
                    
                    <div class="risk-item-content" id="riskContent${index}" style="padding: 1.5rem; display: none; border-top: 1px solid ${severityBg};">
                        <p style="color: #495057; line-height: 1.8; margin-bottom: 1.5rem;">${risk.description || 'No description available.'}</p>
                        
                        ${risk.mitigation ? `
                        <div style="background: #e7f3ff; padding: 1.25rem; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="ti ti-bulb" style="color: #007bff;"></i>
                                <strong style="color: #007bff;">Recommended Mitigation:</strong>
                            </div>
                            <p style="margin: 0; color: #495057; line-height: 1.6;">${risk.mitigation}</p>
                        </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            ${risk.likelihood ? `
                            <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem;">Likelihood</div>
                                <div style="color: #212529; font-weight: 600;">${risk.likelihood}</div>
                            </div>
                            ` : ''}
                            ${risk.business_impact ? `
                            <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem;">Business Impact</div>
                                <div style="color: #212529; font-weight: 600;">${risk.business_impact}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                      
                    </div>
                </div>
                `;
        }).join('') : `
                <div class="text-center" style="padding: 3rem; background: #f8f9fa; border-radius: 12px;">
                    <i class="ti ti-circle-check" style="font-size: 4rem; color: #28a745; margin-bottom: 1rem;"></i>
                    <h5 style="color: #212529; margin-bottom: 0.5rem;">No Significant Risks Detected</h5>
                    <p style="color: #6c757d;">This contract appears to have minimal risk factors.</p>
                </div>
            `}
        </div>
    `;
    }


    // Helper Functions
    function getSeverityColor(severity) {
        const colors = {
            'critical': '#dc3545',
            'high': '#dc3545',
            'medium': '#ffc107',
            'low': '#28a745'
        };
        return colors[severity] || '#6c757d';
    }



    function getSeverityBackground(severity) {
        const backgrounds = {
            'critical': 'rgba(220, 53, 69, 0.08)',
            'high': 'rgba(220, 53, 69, 0.08)',
            'medium': 'rgba(255, 193, 7, 0.08)',
            'low': 'rgba(40, 167, 69, 0.08)'
        };
        return backgrounds[severity] || 'rgba(108, 117, 125, 0.08)';
    }

    function getRiskLevelColor(level) {
        const colors = {
            'Critical': '#dc3545',
            'High': '#fd7e14',
            'Medium': '#ffc107',
            'Low': '#28a745'
        };
        return colors[level] || '#6c757d';
    }



    // Display Error State
    function displayRiskAnalysisError(message) {
        const content = document.getElementById('riskAnalysisContent');
        content.innerHTML = `
        <div class="text-center" style="padding: 3rem;">
            <div style="width: 80px; height: 80px; background: rgba(220, 53, 69, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i class="ti ti-alert-triangle" style="font-size: 2.5rem; color: var(--danger-color);"></i>
            </div>
            <h4 style="color: var(--text-color); margin-bottom: 0.5rem;">Analysis Failed</h4>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">${message}</p>
            <button class="btn btn-primary" onclick="runRiskAnalysis()">
                <i class="ti ti-refresh"></i> Try Again
            </button>
        </div>
    `;
    }

    // Toggle Risk Item
    function toggleRiskItem(index) {
        const content = document.getElementById(`riskContent${index}`);
        const chevron = document.getElementById(`chevron${index}`);

        if (content && chevron) {
            const isExpanded = content.style.display === 'block';
            content.style.display = isExpanded ? 'none' : 'block';
            chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    }

    // Apply Mitigation
    function applyMitigation(index) {
        if (!riskAnalysisData || !riskAnalysisData.risk_items || !riskAnalysisData.risk_items[index]) {
            showNotification('Mitigation not available', 'warning');
            return;
        }

        const risk = riskAnalysisData.risk_items[index];

        if (!risk.mitigation) {
            showNotification('No mitigation strategy available for this risk', 'warning');
            return;
        }

        if (confirm(`Apply mitigation for: ${risk.issue}?\n\nThis will add a mitigation note to the contract.`)) {
            try {
                const editor = document.getElementById('contractContent');

                if (!editor) {
                    showNotification('Contract editor not found', 'error');
                    return;
                }

                // Get current content
                let currentContent = editor.value || editor.innerHTML || '';

                // Build mitigation note
                const mitigationNote = `\n\n[RISK MITIGATION NOTE - ${new Date().toLocaleString()}]

Issue: ${risk.issue}
Severity: ${risk.severity.toUpperCase()}
Affected Clause: ${risk.clause_reference || 'General'}

 RECOMMENDED MITIGATION:
${risk.mitigation}
\n`;

                // Append mitigation to contract
                const updatedContent = currentContent + mitigationNote;

                // Update editor
                if (editor.value !== undefined) {
                    editor.value = updatedContent;
                } else {
                    editor.innerHTML = updatedContent;
                }

                // Mark as modified
                if (typeof markAsDirty === 'function') {
                    markAsDirty();
                }

                // Save as draft
                saveAsDraft();

                showNotification(` Mitigation applied for: ${risk.issue}`, 'success');

            } catch (error) {
                console.error('Error applying mitigation:', error);
                showNotification('Failed to apply mitigation: ' + error.message, 'error');
            }
        }
    }
    // View Clause
    function viewClause(clauseReference) {
        showNotification(`Navigating to clause: ${clauseReference}`, 'info');
        // Add your clause navigation logic here
    }

    // Helper Functions
    function getRiskIcon(type) {
        const icons = {
            'Legal': 'scale',
            'Financial': 'currency-dollar',
            'Operational': 'settings',
            'Compliance': 'shield-check',
            'Dispute': 'gavel',
            'General': 'alert-circle'
        };
        return icons[type] || 'alert-triangle';
    }

    function formatRiskType(type) {
        return (type || 'General').replace(/_/g, ' ');
    }

    function formatBusinessImpact(impact) {
        return impact || 'To be assessed';
    }

    // Export Risk Report
    function exportRiskReport() {
        if (!riskAnalysisData) {
            showNotification('No risk analysis data to export', 'warning');
            return;
        }

        const reportContent = `

                    AI RISK ANALYSIS REPORT                        
                         CALIM 360 CLM                             


Contract: ${contractData?.contract?.title || 'Unknown Contract'}
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}



EXECUTIVE SUMMARY

Overall Safety Score: ${riskAnalysisData.overall_score}/100
High Risks: ${riskAnalysisData.high_risks}
Medium Risks: ${riskAnalysisData.medium_risks}
Low Risks: ${riskAnalysisData.low_risks}

${riskAnalysisData.executive_summary || ''}



DETAILED FINDINGS

${(riskAnalysisData.risk_items || []).map((item, i) => `
[${i + 1}] ${item.issue}
    Severity: ${item.severity?.toUpperCase()}
    Type: ${formatRiskType(item.type)}
    Score: ${item.score}/100
    
    Description:
    ${item.description}
    
    Clause Reference: ${item.clause_reference || 'N/A'}
    Qatar Law Reference: ${item.qatar_law_reference || 'N/A'}
    Business Impact: ${item.business_impact || 'N/A'}
    
     Recommendation:
    ${item.recommendation}
`).join('\n\n')}



KEY RECOMMENDATIONS

${(riskAnalysisData.recommendations_summary || []).map((rec, i) => `${i + 1}. ${rec}`).join('\n')}



COMPLIANCE STATUS

 QFCRA Compliant: ${riskAnalysisData.compliance_status?.qfcra_compliant ? ' Yes' : ' No'}
 Qatar Civil Code Aligned: ${riskAnalysisData.compliance_status?.qatar_civil_code_aligned ? ' Yes' : ' No'}
 Data Protection Compliant: ${riskAnalysisData.compliance_status?.data_protection_compliant ? ' Yes' : ' Review Required'}

${riskAnalysisData.compliance_status?.notes ? `Note: ${riskAnalysisData.compliance_status.notes}` : ''}



Generated by CALIM 360 Smart CLM
 ${new Date().getFullYear()} All Rights Reserved
    `;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `risk_analysis_report_${contractId}_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification('Risk report exported successfully', 'success');
    }


    // Show Risk Summary (Alternative View)
    function showRiskSummary() {
        if (riskAnalysisData) {
            displayRiskSummary(riskAnalysisData);
            openModal('riskSummaryModal');
        } else {
            runRiskAnalysis();
        }
    }

    function displayRiskSummary(analysis) {
        const content = document.getElementById('riskSummaryContent');
        content.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: rgba(220, 53, 69, 0.05); padding: 1.25rem; border-radius: 8px; text-align: center; border: 1px solid var(--danger-color);">
                <div style="font-size: 2rem; font-weight: bold; color: var(--danger-color);">${analysis.high_risks || 0}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">High Risk</div>
            </div>
            <div style="background: rgba(255, 193, 7, 0.05); padding: 1.25rem; border-radius: 8px; text-align: center; border: 1px solid var(--warning-color);">
                <div style="font-size: 2rem; font-weight: bold; color: var(--warning-color);">${analysis.medium_risks || 0}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Medium Risk</div>
            </div>
            <div style="background: rgba(40, 167, 69, 0.05); padding: 1.25rem; border-radius: 8px; text-align: center; border: 1px solid var(--success-color);">
                <div style="font-size: 2rem; font-weight: bold; color: var(--success-color);">${analysis.low_risks || 0}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Low Risk</div>
            </div>
            <div style="background: rgba(39, 98, 203, 0.05); padding: 1.25rem; border-radius: 8px; text-align: center; border: 1px solid var(--primary-color);">
                <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">${analysis.overall_score || 0}%</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Safety Score</div>
            </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <button class="btn btn-primary btn-block" onclick="closeModal('riskSummaryModal'); openModal('riskAnalysisModal');">
                <i class="ti ti-list-details"></i> View Detailed Analysis
            </button>
        </div>
    `;
    }
</script>


<script>



    // =====================================================
    // BLOCKCHAIN EVIDENCE SHOWCASE JAVASCRIPT
    // =====================================================

    // Activity tracking
    let activityLog = [];

    // Open Blockchain Operations Monitor Modal
    function openBlockchainMonitor() {
        console.log(' Opening blockchain monitor...');

        const modal = document.getElementById('blockchainMonitorModal');
        if (!modal) {
            console.error(' Blockchain monitor modal not found');
            showNotification('Blockchain monitor not available', 'error');
            return;
        }

        // Show modal
        modal.classList.add('show');
        modal.style.display = 'flex';

        // Load blockchain history
        loadBlockchainHistory();

        // Start auto-refresh
        startBlockchainMonitoring();
    }

    // Close Blockchain Operations Monitor Modal
    function closeBlockchainMonitor() {
        const modal = document.getElementById('blockchainMonitorModal');
        if (modal) {
            modal.classList.remove('show');
            modal.style.display = 'none';

            // Stop monitoring when modal closes
            stopBlockchainMonitoring();
        }
    }

    // Start monitoring (auto-refresh)
    function startBlockchainMonitoring() {
        if (blockchainMonitorInterval) {
            clearInterval(blockchainMonitorInterval);
        }

        // Initial load
        loadBlockchainHistory();

        // Auto-refresh every 15 seconds
        blockchainMonitorInterval = setInterval(() => {
            loadBlockchainHistory();
        }, 15000);

        console.log(' Blockchain monitoring started (15s interval)');
    }

    // Stop monitoring
    function stopBlockchainMonitoring() {
        if (blockchainMonitorInterval) {
            clearInterval(blockchainMonitorInterval);
            blockchainMonitorInterval = null;
        }
    }

    // Load blockchain activity from API
    async function loadBlockchainActivity() {
        try {

            // Get auth token
            const token = getAuthToken();

            // Fetch blockchain activity
            const response = await fetch(`/api/blockchain/activity/${contractId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch blockchain activity');
            }

            const data = await response.json();

            // Update network status
            if (data.network_status) {
                updateNetworkStatus(data.network_status);
            }

            // Update activity stream
            if (data.activities && data.activities.length > 0) {
                displayActivities(data.activities);
                updateStatistics(data.statistics);
            } else {
                // Show empty state
                showEmptyActivityState();
            }

        } catch (error) {
            console.error('Error loading blockchain activity:', error);
            showErrorState();
        }
    }

    // Update network status display
    function updateNetworkStatus(status) {
        const statusValue = document.getElementById('networkStatusValueModal');
        const peersCount = document.getElementById('peersCountModal');

        if (statusValue) {
            statusValue.textContent = status.status || 'Operational';
            statusValue.style.color = status.status === 'Operational' ? '#10b981' : '#ef4444';
        }

        if (peersCount) {
            peersCount.textContent = status.peers_count || '3';
        }
    }

    // Display blockchain activities
    function displayActivities(activities) {
        const streamContainer = document.getElementById('activityStreamModal');
        const emptyState = document.getElementById('emptyActivityState');

        if (emptyState) {
            emptyState.style.display = 'none';
        }

        if (!streamContainer) return;

        // Clear existing activities (except empty state)
        const existingActivities = streamContainer.querySelectorAll('.activity-item');
        existingActivities.forEach(item => item.remove());

        // Add new activities
        activities.forEach(activity => {
            const activityElement = createActivityElement(activity);
            streamContainer.insertBefore(activityElement, streamContainer.firstChild);
        });
    }

    // Create activity element
    function createActivityElement(activity) {
        const div = document.createElement('div');
        div.className = 'activity-item';

        const icon = getActivityIcon(activity.action);
        const timestamp = formatTimestamp(activity.timestamp);

        div.innerHTML = `
        <div class="activity-item-header">
            <div class="activity-item-type">
                <i class="ti ${icon}" style="font-size: 1.25rem; color: #3b82f6;"></i>
                <span>${getActivityTitle(activity.action)}</span>
            </div>
            <div class="activity-item-time">${timestamp}</div>
        </div>
        <div class="activity-item-details">
            ${activity.details?.details || 'Blockchain operation completed successfully'}
        </div>
        ${activity.details?.transaction_hash ? `
            <div class="activity-item-hash">
                TX: ${activity.details.transaction_hash.substring(0, 20)}...
            </div>
        ` : ''}
    `;

        return div;
    }

    // Get activity icon based on action type
    function getActivityIcon(action) {
        const icons = {
            'blockchain_storage': 'ti ti-database-export',
            'blockchain_verification': 'ti ti-shield-check',
            'contract_created': 'ti ti-file-plus',
            'contract_updated': 'ti ti-edit',
            'contract_signed': 'ti ti-signature',
            'document_uploaded': 'ti ti-cloud-upload'
        };
        return icons[action] || 'ti ti-activity';
    }
    // Get activity title
    function getActivityTitle(action) {
        const titles = {
            'blockchain_storage': 'Contract Stored on Blockchain',
            'blockchain_verification': 'Blockchain Verification',
            'contract_created': 'Contract Created',
            'contract_updated': 'Contract Updated',
            'contract_signed': 'Contract Signed',
            'document_uploaded': 'Document Uploaded'
        };
        return titles[action] || action.split('_').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }



    async function loadBlockchainHistory() {
        console.log(' Loading complete blockchain history...');

        const contractId = getContractId();
        if (!contractId) {
            console.error(' No contract ID found');
            showEmptyActivityState();
            return;
        }

        try {
            // Show loading state
            showLoadingState();

            // Fetch complete history from API
            const token = getAuthToken();
            const response = await fetch(`/api/blockchain/activity/${contractId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log(' Blockchain history loaded:', data);

            // Update network status
            if (data.network_status) {
                updateNetworkStatus(data.network_status);
            }

            // Display activities
            if (data.activities && data.activities.length > 0) {
                displayBlockchainActivities(data.activities);

                // Update statistics
                if (data.statistics) {
                    updateStatistics(data.statistics);
                }
            } else {
                showEmptyActivityState();
            }

        } catch (error) {
            console.error(' Error loading blockchain history:', error);
            showErrorState();
        }
    }




    function showLoadingState() {
        const stream = document.getElementById('activityStreamModal');
        const emptyState = document.getElementById('emptyActivityState');

        if (emptyState) {
            emptyState.style.display = 'none';
        }

        if (stream) {
            stream.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem; color: #3b82f6;">
                <div class="progress-spinner" style="width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                <p style="margin: 0; font-size: 1rem; font-weight: 500;">Loading blockchain history...</p>
            </div>
        `;
        }
    }



    // Update statistics
    function updateStatistics(stats) {
        if (!stats) return;

        const totalTx = document.getElementById('totalTransactions');
        const lastHash = document.getElementById('lastBlockHash');
        const lastActivity = document.getElementById('lastActivityTime');

        if (totalTx) totalTx.textContent = stats.total_transactions || '0';
        if (lastHash) {
            const hash = stats.last_block_hash;
            lastHash.textContent = hash ? `${hash.substring(0, 16)}...` : 'N/A';
        }
        if (lastActivity) lastActivity.textContent = stats.last_activity_time || 'Just now';
    }

    // Show empty activity state
    function showEmptyActivityState() {
        const emptyState = document.getElementById('emptyActivityState');
        if (emptyState) {
            emptyState.style.display = 'block';
        }

        // Clear any existing activities
        const stream = document.getElementById('activityStreamModal');
        if (stream) {
            const existingActivities = stream.querySelectorAll('.activity-item');
            existingActivities.forEach(item => item.remove());
        }
    }


    // Show error state
    function showErrorState() {
        const stream = document.getElementById('activityStreamModal');
        const emptyState = document.getElementById('emptyActivityState');

        if (emptyState) {
            emptyState.style.display = 'none';
        }

        if (stream) {
            stream.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem; color: #ef4444;">
                <i class="ti ti-alert-circle" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p style="margin: 0; font-size: 1rem; font-weight: 500;">Failed to load blockchain activity</p>
                <p style="font-size: 0.875rem; margin-top: 0.5rem; opacity: 0.7;">
                    Please try refreshing or contact support
                </p>
                <button onclick="loadBlockchainHistory()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Retry
                </button>
            </div>
        `;
        }
    }

    // Refresh blockchain activity manually
    function refreshBlockchainActivity() {
        loadBlockchainActivity();
    }

    // View full audit trail
    function viewFullAuditTrail() {
        // Redirect to audit trail page or open in new tab
        window.open('/audit-trail', '_blank');
    }

    // Get contract ID from URL or form

    function getContractId() {
        // Try URL parameter first
        const urlParams = new URLSearchParams(window.location.search);
        let contractId = urlParams.get('id') || urlParams.get('contract_id');

        // Try form input
        if (!contractId) {
            const contractIdInput = document.querySelector('[name="contract_id"]') ||
                document.querySelector('#contract_id');
            contractId = contractIdInput ? contractIdInput.value : null;
        }

        return contractId;
    }

    // Close modal when clicking outside
    window.addEventListener('click', function (event) {
        const modal = document.getElementById('blockchainMonitorModal');
        if (event.target === modal) {
            closeBlockchainMonitor();
        }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeBlockchainMonitor();
        }
    });




    // Toggle panel collapse
    function toggleEvidencePanel() {
        const panel = document.getElementById('blockchainEvidencePanel');
        panel.classList.toggle('collapsed');
    }

    // Load network status
    async function loadBlockchainNetworkStatus() {
        try {
            const response = await fetch('/api/blockchain/network-status', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            const data = await response.json();

            if (data.success) {
                updateNetworkStatus(data.network_status);
            }
        } catch (error) {
            console.error('Error loading network status:', error);
        }
    }

    // Update network status display
    function updateNetworkStatus(status) {
        const statusValue = document.getElementById('networkStatusValueModal');
        const peersCount = document.getElementById('peersCountModal');

        if (statusValue) {
            statusValue.textContent = status.status || 'Operational';
            statusValue.style.color = status.status === 'Operational' ? '#10b981' : '#ef4444';
        }

        if (peersCount) {
            peersCount.textContent = status.peers_count || '3';
        }
    }

    // Add activity to stream
    function addBlockchainActivity(activity) {
        activityLog.push(activity);

        const stream = document.getElementById('activityStream');

        // Remove empty state
        const emptyState = stream.querySelector('.empty-activity-state');
        if (emptyState) {
            emptyState.remove();
        }

        // Create activity item
        const item = document.createElement('div');
        item.className = `stream-item ${activity.status}`;
        item.id = `activity-${activity.id}`;

        // Get icon based on step
        const icon = getBlockchainIcon(activity.step);

        // Build metadata HTML
        let metadataHtml = '';
        if (activity.metadata && Object.keys(activity.metadata).length > 0) {
            metadataHtml = '<div class="stream-metadata">';
            for (const [key, value] of Object.entries(activity.metadata)) {
                if (key !== 'full_hash' && key !== 'data_size') {
                    metadataHtml += `<span class="metadata-tag"><i class="ti ti-point"></i> ${key}: ${value}</span>`;
                }
            }
            metadataHtml += '</div>';
        }

        // Add hash visualization for hash generation step
        let hashHtml = '';
        if (activity.step === 'hash_generation' && activity.metadata?.full_hash) {
            hashHtml = `<div class="hash-visual">${activity.metadata.full_hash}</div>`;
        }

        item.innerHTML = `
        <div class="stream-icon">
            <i class="${icon}"></i>
        </div>
        <div class="stream-content">
            <div class="stream-title">${formatStepName(activity.step)}</div>
            <div class="stream-description">${activity.details}</div>
            <div class="stream-timestamp">${new Date(activity.timestamp).toLocaleTimeString()}</div>
            ${hashHtml}
            ${metadataHtml}
        </div>
    `;

        // Insert at top of stream
        stream.insertBefore(item, stream.firstChild);

        // Scroll to show new item
        stream.scrollTop = 0;
    }

    // Show progress indicator
    function showBlockchainProgress(message) {
        const stream = document.getElementById('activityStream');

        const progress = document.createElement('div');
        progress.className = 'progress-indicator';
        progress.id = 'blockchain-progress';
        progress.innerHTML = `
        <div class="progress-spinner"></div>
        <div class="progress-text">${message}</div>
    `;

        stream.insertBefore(progress, stream.firstChild);
    }

    // Hide progress indicator
    function hideBlockchainProgress() {
        const progress = document.getElementById('blockchain-progress');
        if (progress) {
            progress.remove();
        }
    }

    // Process blockchain storage with activity logging
    async function storeContractOnBlockchainWithEvidence(contractId) {
        showBlockchainProgress('Initiating blockchain storage...');

        try {
            const response = await fetch(`/api/blockchain/store-contract/${contractId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            hideBlockchainProgress();

            if (data.success && data.activities) {
                // Display each activity step
                data.activities.forEach((activity, index) => {
                    setTimeout(() => {
                        addBlockchainActivity(activity);
                    }, index * 300); // Stagger the display for visual effect
                });

                return data;
            } else {
                addBlockchainActivity({
                    id: Date.now(),
                    step: 'error',
                    status: 'error',
                    details: data.error || 'Failed to store contract on blockchain',
                    timestamp: new Date().toISOString(),
                    metadata: {}
                });
                return null;
            }
        } catch (error) {
            hideBlockchainProgress();
            console.error('Error storing on blockchain:', error);
            addBlockchainActivity({
                id: Date.now(),
                step: 'error',
                status: 'error',
                details: `Error: ${error.message}`,
                timestamp: new Date().toISOString(),
                metadata: {}
            });
            return null;
        }
    }

    // Get icon for activity step
    function getBlockchainIcon(step) {
        const icons = {
            'data_extraction': 'ti ti-file-search',
            'hash_generation': 'ti ti-hash',
            'transaction_preparation': 'ti ti-file-code',
            'blockchain_submission': 'ti ti-cloud-upload',
            'database_storage': 'ti ti-database',
            'audit_logging': 'ti ti-history',
            'completion': 'ti ti-circle-check',
            'error': 'ti ti-alert-triangle'
        };
        return icons[step] || 'ti ti-point';
    }

    // Format step name for display
    function formatStepName(step) {
        return step.split('_').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadBlockchainNetworkStatus();
        // saveAsDraft();

        // Refresh network status every 30 seconds
        setInterval(loadBlockchainNetworkStatus, 30000);
    });

    // Example: Hook into contract save function
    // Replace your existing save function call with this:
    async function saveContractWithBlockchain() {
        // Your existing save logic here
        // ...

        // After successful save, store on blockchain
        const contractId = getContractIdFromURL(); // Your function to get contract ID
        if (contractId) {
            await storeContractOnBlockchainWithEvidence(contractId);
        }
    }

    // Helper function to get contract ID from URL
    function getContractIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }


</script>


<script>
    // =====================================================
    // BLOCKCHAIN ACTIVITY DISPLAY FUNCTIONS
    // =====================================================

    /**
     * Display blockchain activities in the panel
     */

    let blockchainMonitorInterval = null;
    function displayBlockchainActivities(activities) {
        console.log(' Displaying blockchain activities:', activities.length, 'items');

        //  FIX: Use correct element ID
        const stream = document.getElementById('activityStreamModal');
        if (!stream) {
            console.error(' Activity stream element not found');
            return;
        }

        // Hide empty state
        const emptyState = document.getElementById('emptyActivityState');
        if (emptyState) {
            emptyState.style.display = 'none';
        }

        // Clear existing activity items (but keep empty state)
        const existingActivities = stream.querySelectorAll('.activity-item');
        existingActivities.forEach(item => item.remove());

        // Display each activity with animation
        activities.forEach((activity, index) => {
            setTimeout(() => {
                addBlockchainActivityToStream(activity);
            }, index * 100); // Reduced delay for faster display
        });

        console.log(' Successfully displayed', activities.length, 'blockchain activities');
    }



    function addBlockchainActivityToStream(activity) {
        const stream = document.getElementById('activityStreamModal');
        if (!stream) return;

        console.log(' Adding activity to stream:', activity);

        const item = document.createElement('div');
        item.className = 'activity-item';

        // Determine icon and title based on activity type
        let icon, title, details;

        if (activity.step) {
            // New format from save operation
            icon = getBlockchainIcon(activity.step);
            title = formatStepName(activity.step);
            details = activity.details || 'Blockchain operation completed';
        } else if (activity.action) {
            // Format from API history
            icon = getActivityIcon(activity.action);
            title = getActivityTitle(activity.action);
            details = activity.details?.details || activity.details || 'Blockchain operation completed';
        } else {
            // Fallback
            icon = 'ti ti-point';
            title = 'Blockchain Operation';
            details = 'Operation completed successfully';
        }

        const timestamp = formatTimestamp(activity.timestamp);

        // Build metadata display
        let metadataHtml = '';
        const metadata = activity.metadata || activity.details;
        if (metadata && typeof metadata === 'object' && Object.keys(metadata).length > 0) {
            metadataHtml = '<div class="stream-metadata">';
            for (const [key, value] of Object.entries(metadata)) {
                if (key !== 'full_hash' && key !== 'data_size' && value && key !== 'details') {
                    metadataHtml += `
                    <span class="metadata-tag">
                        <i class="ti ti-point"></i> 
                        <strong>${key}:</strong> ${value}
                    </span>
                `;
                }
            }
            metadataHtml += '</div>';
        }

        // Add transaction hash display if available
        let hashHtml = '';
        const txHash = activity.details?.transaction_hash || metadata?.transaction_hash || metadata?.transaction_id;
        if (txHash) {
            hashHtml = `
            <div class="activity-item-hash">
                TX: ${txHash.substring(0, 20)}...
            </div>
        `;
        }

        item.innerHTML = `
        <div class="activity-item-header">
            <div class="activity-item-type">
                <i class="ti ${icon}" style="font-size: 1.25rem; color: #3b82f6;"></i>
                <span>${title}</span>
            </div>
            <div class="activity-item-time">${timestamp}</div>
        </div>
        <div class="activity-item-details">
            ${details}
        </div>
        ${hashHtml}
        ${metadataHtml}
    `;

        // Insert at top of stream (newest first)
        stream.insertBefore(item, stream.firstChild);
    }



    /**
     * Add a single activity to the stream
     */
    function addBlockchainActivity(activity) {
        const stream = document.getElementById('activityStream');
        if (!stream) return;

        console.log(' Adding activity:', activity.step);

        const item = document.createElement('div');
        item.className = `stream-item ${activity.status}`;

        const icon = getBlockchainActivityIcon(activity.step);

        // Build metadata HTML
        let metadataHtml = '';
        if (activity.metadata && Object.keys(activity.metadata).length > 0) {
            metadataHtml = '<div class="stream-metadata">';
            for (const [key, value] of Object.entries(activity.metadata)) {
                if (key !== 'full_hash' && key !== 'data_size' && value) {
                    metadataHtml += `
                    <span class="metadata-tag">
                        <i class="ti ti-point"></i> 
                        <strong>${key}:</strong> ${value}
                    </span>
                `;
                }
            }
            metadataHtml += '</div>';
        }

        // Add hash display for hash generation step
        let hashHtml = '';
        if (activity.step === 'hash_generation' && activity.metadata?.full_hash) {
            hashHtml = `<div class="hash-visual">${activity.metadata.full_hash}</div>`;
        }

        item.innerHTML = `
        <div class="stream-icon">
            <i class="${icon}"></i>
        </div>
        <div class="stream-content">
            <div class="stream-title">${formatStepName(activity.step)}</div>
            <div class="stream-description">${activity.details}</div>
            <div class="stream-timestamp">${new Date(activity.timestamp).toLocaleTimeString()}</div>
            ${hashHtml}
            ${metadataHtml}
        </div>
    `;

        stream.insertBefore(item, stream.firstChild);
    }

    /**
     * Get icon for blockchain activity step
     */
    function getBlockchainActivityIcon(step) {
        const icons = {
            'data_extraction': 'ti ti-file-search',
            'hash_generation': 'ti ti-hash',
            'transaction_preparation': 'ti ti-file-code',
            'blockchain_submission': 'ti ti-cloud-upload',
            'database_storage': 'ti ti-database',
            'audit_logging': 'ti ti-history',
            'completion': 'ti ti-circle-check',
            'error': 'ti ti-alert-triangle'
        };
        return icons[step] || 'ti ti-point';
    }

    /**
     * Format step name for display
     */
    function formatStepName(step) {
        return step.split('_').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }

    // Test function - run in console: testBlockchainDisplay()
    function testBlockchainDisplay() {
        const mockActivities = [
            {
                id: "1",
                step: "data_extraction",
                status: "success",
                details: "Successfully extracted 60,533 bytes of contract data",
                timestamp: new Date().toISOString(),
                metadata: { data_size: 60533 }
            },
            {
                id: "2",
                step: "hash_generation",
                status: "success",
                details: "Generated SHA-256 hash",
                timestamp: new Date().toISOString(),
                metadata: {
                    hash_algorithm: "SHA-256",
                    full_hash: "16a01b7b750ee5f9...8d34d311fb39963e"
                }
            },
            {
                id: "3",
                step: "completion",
                status: "success",
                details: "Contract successfully secured on blockchain",
                timestamp: new Date().toISOString(),
                metadata: { total_steps: 7 }
            }
        ];

        console.log(' Testing with mock data...');
        // displayBlockchainActivities(mockActivities);
    }

    // =====================================================
    // COUNTER-PARTY EMAIL SEARCH FUNCTIONS
    // =====================================================

    let searchTimeout;
    let selectedCounterPartyEmail = null;

    /**
     * Search users from database for counter-party email
     */
    async function searchCounterPartyUsers(query) {

        const suggestionsDiv = document.getElementById('counterPartyEmailSuggestions');

        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        // Hide suggestions if query is empty
        if (!query || query.trim().length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        // Debounce search - wait 300ms after user stops typing
        searchTimeout = setTimeout(async () => {
            try {
                // Show loading state
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                        <i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i>
                        Searching users...
                    </div>
                `;
                suggestionsDiv.style.display = 'block';

                // Call API to search users
                const response = await fetch(`/api/users/all?search=${encodeURIComponent(query)}&limit=10&type=counterparty`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });


                if (!response.ok) {
                    throw new Error('Failed to search users');
                }

                const data = await response.json();
                const users = data.users || [];

                console.log(users);
                // Display results
                if (users.length === 0) {
                    suggestionsDiv.innerHTML = `
                        <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                            <i class="ti ti-user-x" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <div>No users found matching "${query}"</div>
                            <small style="display: block; margin-top: 0.25rem;">You can still enter the email manually</small>
                        </div>
                    `;
                } else {
                    suggestionsDiv.innerHTML = users.map(user => {
                        const fullName = `${user.first_name} ${user.last_name}`.trim();
                        const userType = user.user_type ? ` (${user.user_type})` : '';
                        const department = user.department ? ` - ${user.department}` : '';
                        const companyName = (user.company_name || 'Unknown Company').replace(/'/g, "\\'");


                        return `
                            <div onclick="selectCounterPartyEmail('${user.email}', '${companyName}', ${user.id}, ${user.company_id || 'null'})" 
                                style="padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;"
                                onmouseover="this.style.background='var(--background-light)'" 
                                onmouseout="this.style.background='transparent'">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                        ${user.first_name.charAt(0)}${user.last_name.charAt(0)}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.125rem;">
                                            ${fullName}${userType}
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                                            <i class="ti ti-mail" style="font-size: 0.875rem;"></i> ${user.email}${department}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                suggestionsDiv.style.display = 'block';

            } catch (error) {
                console.error('Error searching users:', error);
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--danger-color);">
                        <i class="ti ti-alert-circle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <div>Error searching users</div>
                        <small style="display: block; margin-top: 0.25rem;">You can still enter the email manually</small>
                    </div>
                `;
                suggestionsDiv.style.display = 'block';
            }
        }, 300); // 300ms debounce
    }

    /**
     * Select an email from the suggestions
     */
    function selectCounterPartyEmail(email, companyName, userId, companyId) {
        const emailInput = document.getElementById('counterPartyEmail');
        const suggestionsDiv = document.getElementById('counterPartyEmailSuggestions');

        // Set the email value
        emailInput.value = email;

        // Store all the data
        selectedCounterPartyEmail = {
            email: email,
            companyName: companyName,
            userId: userId,
            companyId: companyId
        };

        // Hide suggestions
        suggestionsDiv.style.display = 'none';

        // Show notification with company name
        showNotification(`Selected: ${companyName} (${email})`, 'success');
    }
    /**
     * Close suggestions when clicking outside
     */
    document.addEventListener('click', function (event) {
        const emailInput = document.getElementById('counterPartyEmail');
        const suggestionsDiv = document.getElementById('counterPartyEmailSuggestions');

        if (emailInput && suggestionsDiv &&
            !emailInput.contains(event.target) &&
            !suggestionsDiv.contains(event.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });



    let searchSignatureTimeout;
    let selectedCounterPartySignatureEmail = null;

    /**
     * Search users from database for counter-party email
     */
    async function searchCounterPartySignatureUsers(query) {

        const suggestionsDiv = document.getElementById('counterPartyEmailSignatureSuggestions');

        // Clear previous timeout
        if (searchSignatureTimeout) {
            clearTimeout(searchSignatureTimeout);
        }

        // Hide suggestions if query is empty
        if (!query || query.trim().length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        // Debounce search - wait 300ms after user stops typing
        searchSignatureTimeout = setTimeout(async () => {
            try {
                // Show loading state
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                        <i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i>
                        Searching users...
                    </div>
                `;
                suggestionsDiv.style.display = 'block';

                // Call API to search users
                const response = await fetch(`/api/users/all?search=${encodeURIComponent(query)}&limit=10&type=counterparty`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });


                if (!response.ok) {
                    throw new Error('Failed to search users');
                }

                const data = await response.json();
                const users = data.users || [];

                console.log(users);
                // Display results
                if (users.length === 0) {
                    suggestionsDiv.innerHTML = `
                        <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                            <i class="ti ti-user-x" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <div>No users found matching "${query}"</div>
                            <small style="display: block; margin-top: 0.25rem;">You can still enter the email manually</small>
                        </div>
                    `;
                } else {
                    suggestionsDiv.innerHTML = users.map(user => {
                        const fullName = `${user.first_name} ${user.last_name}`.trim();
                        const userType = user.user_type ? ` (${user.user_type})` : '';
                        const department = user.department ? ` - ${user.department}` : '';
                        const companyName = (user.company_name || 'Unknown Company').replace(/'/g, "\\'");


                        return `
                            <div onclick="selectCounterPartySignatureEmail('${user.email}', '${companyName}', ${user.id}, ${user.company_id || 'null'})" 
                                style="padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;"
                                onmouseover="this.style.background='var(--background-light)'" 
                                onmouseout="this.style.background='transparent'">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                        ${user.first_name.charAt(0)}${user.last_name.charAt(0)}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.125rem;">
                                            ${fullName}${userType}
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                                            <i class="ti ti-mail" style="font-size: 0.875rem;"></i> ${user.email}${department}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                suggestionsDiv.style.display = 'block';

            } catch (error) {
                console.error('Error searching users:', error);
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--danger-color);">
                        <i class="ti ti-alert-circle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <div>Error searching users</div>
                        <small style="display: block; margin-top: 0.25rem;">You can still enter the email manually</small>
                    </div>
                `;
                suggestionsDiv.style.display = 'block';
            }
        }, 300); // 300ms debounce
    }

    /**
     * Select an email from the suggestions
     */
    function selectCounterPartySignatureEmail(email, companyName, userId, companyId) {
        const emailInput = document.getElementById('counterPartySignatureEmail');
        const suggestionsDiv = document.getElementById('counterPartyEmailSignatureSuggestions');

        // Set the email value
        emailInput.value = email;

        // Store all the data
        selectedCounterPartySignatureEmail = {
            email: email,
            companyName: companyName,
            userId: userId,
            companyId: companyId
        };

        // Hide suggestions
        suggestionsDiv.style.display = 'none';

        // Show notification with company name
        showNotification(`Selected: ${companyName} (${email})`, 'success');
    }
    /**
     * Close suggestions when clicking outside
     */
    document.addEventListener('click', function (event) {
        const emailInput = document.getElementById('counterPartySignatureEmail');
        const suggestionsDiv = document.getElementById('counterPartyEmailSignatureSuggestions');

        if (emailInput && suggestionsDiv &&
            !emailInput.contains(event.target) &&
            !suggestionsDiv.contains(event.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });



    let searchCompanyTimeout;
    let selectedCompanyEmail = null;

    /**
     * Search users from database for counter-party email
     */
    async function searchCompanyUsers(query) {
        const suggestionsDiv = document.getElementById('companyEmailSuggestions');

        // Clear previous timeout
        if (searchCompanyTimeout) {
            clearTimeout(searchCompanyTimeout);
        }

        // Hide suggestions if query is empty
        if (!query || query.trim().length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        // Debounce search - wait 300ms after user stops typing
        searchCompanyTimeout = setTimeout(async () => {
            try {
                // Show loading state
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                        <i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i>
                        Searching users...
                    </div>
                `;
                suggestionsDiv.style.display = 'block';

                // Call API to search users
                const response = await fetch(`/api/users/company?search=${encodeURIComponent(query)}&limit=10&type=counterparty`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to search users');
                }

                const data = await response.json();
                const users = data.users || [];

                // Display results
                if (users.length === 0) {
                    suggestionsDiv.innerHTML = `
                        <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                            <i class="ti ti-user-x" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <div>No users found matching "${query}"</div>
                            <small style="display: block; margin-top: 0.25rem;">You can still enter the email manually</small>
                        </div>
                    `;
                } else {
                    suggestionsDiv.innerHTML = users.map(user => {
                        const fullName = `${user.first_name} ${user.last_name}`.trim();
                        const userType = user.user_type ? ` (${user.user_type})` : '';
                        const department = user.department ? ` - ${user.department}` : '';
                        const companyName = (user.company_name || 'Unknown Company').replace(/'/g, "\\'");


                        return `
                            <div onclick="selectCompanyEmail('${user.email}', '${companyName}', ${user.id}, ${user.company_id || 'null'})" 
                                style="padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;"
                                onmouseover="this.style.background='var(--background-light)'" 
                                onmouseout="this.style.background='transparent'">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                        ${user.first_name.charAt(0)}${user.last_name.charAt(0)}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.125rem;">
                                            ${fullName}${userType}
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                                            <i class="ti ti-mail" style="font-size: 0.875rem;"></i> ${user.email}${department}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                suggestionsDiv.style.display = 'block';

            } catch (error) {
                console.error('Error searching users:', error);
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--danger-color);">
                        <i class="ti ti-alert-circle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <div>Error searching users</div>
                        <small style="display: block; margin-top: 0.25rem;">You can still enter the email manually</small>
                    </div>
                `;
                suggestionsDiv.style.display = 'block';
            }
        }, 300); // 300ms debounce
    }

    /**
     * Select an email from the suggestions
     */
    function selectCompanyEmail(email, companyName, userId, companyId) {
        const emailInput = document.getElementById('companyEmail');
        const suggestionsDiv = document.getElementById('companyEmailSuggestions');

        // Set the email value
        emailInput.value = email;

        // Store all the data
        selectedCompanyEmail = {
            email: email,
            companyName: companyName,
            userId: userId,
            companyId: companyId
        };

        // Hide suggestions
        suggestionsDiv.style.display = 'none';

        // Show notification with company name
        showNotification(`Selected: ${companyName} (${email})`, 'success');
    }
    /**
     * Close suggestions when clicking outside
     */
    document.addEventListener('click', function (event) {
        const emailInput = document.getElementById('companyEmail');
        const suggestionsDiv = document.getElementById('ccompanyEmailSuggestions');

        if (emailInput && suggestionsDiv &&
            !emailInput.contains(event.target) &&
            !suggestionsDiv.contains(event.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });



    async function submitInitiateNegotiation() {
        // Get the button
        const negotiationBtn = document.querySelector('button[onclick="submitInitiateNegotiation()"]');
        const originalButtonHTML = '<i class="ti ti-send"></i> Initiate Negotiation';

        try {
            console.log(' Starting negotiation initiation...');

            // Show loader overlay
            showLoader('Initiating negotiation...');

            //  DISABLE BUTTON AND SHOW LOADING STATE
            if (negotiationBtn) {
                negotiationBtn.disabled = true;
                negotiationBtn.innerHTML = '<i class="ti ti-loader"></i> Initiating...';
            }

            const response = await fetch('/api/v1/workflow/initiate-negotiation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contract_id: contractId,
                    comments: null
                })
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to initiate negotiation');
            }

            const result = await response.json();
            console.log(' Negotiation initiated:', result);

            // Hide loader
            hideLoader();

            //  RE-ENABLE BUTTON AND RESTORE TEXT
            if (negotiationBtn) {
                negotiationBtn.disabled = false;
                negotiationBtn.innerHTML = originalButtonHTML;
            }

            closeModal('negotiationConfirmationModal');

            // Show success message
            showNotification(result.message || 'Negotiation initiated successfully! Redirecting...', 'success');

            // Redirect or refresh page after delay
            setTimeout(() => {
                window.location.reload(); // Or redirect to specific page
            }, 1500);

        } catch (error) {
            console.error(' Error initiating negotiation:', error);

            // Hide loader
            hideLoader();

            //  RE-ENABLE BUTTON AND RESTORE TEXT ON ERROR
            if (negotiationBtn) {
                negotiationBtn.disabled = false;
                negotiationBtn.innerHTML = originalButtonHTML;
            }

            // Show error message
            showNotification(error.message || 'Failed to initiate negotiation. Please try again.', 'error');
        }
    }



    // Function to approve workflow
    async function approveWorkflow(contractId, type = null) {
        if (!confirm("Are you sure you want to approve this contract?")) {
            return;
        }


        try {
            const response = await fetch('/api/v1/workflow/approve-reject', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contract_id: contractId,
                    action: 'approve',
                    request_type: type,
                    comments: null
                })
            });

            const result = await response.json();

            if (response.ok) {
                showNotification(result.message || 'Contract approved successfully!', 'success');
                await refreshContractData();
            } else {
                showNotification('Error: ' + (result.detail || 'Failed to approve contract'), 'error');

            }
        } catch (error) {
            console.error('Error approving workflow:', error);

            showNotification('Error approving contract. Please try again.', 'error');

        }
    }


    // Function to reject workflow
    function rejectWorkflow(contractId, requestType = 'internal_review') {
        openRejectionModal(contractId, requestType);
    }

    // Function to open rejection modal
    function openRejectionModal(contractId, requestType = null) {
        const modalHtml = `
    <div class="modal-overlay" id="rejectionModal" style="display: flex;">
        <div class="modal-content" style="max-width: 500px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #e0e0e0;">
                <h3 class="modal-title" style="margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-x"></i> Reject Contract
                </h3>
                <button class="modal-close" onclick="closeRejectionModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="rejectionComment" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Reason for Rejection *</label>
                    <textarea 
                        id="rejectionComment" 
                        class="form-control" 
                        rows="4" 
                        placeholder="Please provide a reason for rejecting this contract..."
                        required
                        style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit;"
                    ></textarea>
                </div>
            </div>
            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-outline-secondary" onclick="closeRejectionModal()" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer;">
                    Cancel
                </button>
                <button class="btn btn-danger" onclick="submitRejection(${contractId},'${requestType}')" style="padding: 0.5rem 1rem; border-radius: 6px; border: none; background: #dc3545; color: white; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-x"></i> Submit Rejection
                </button>
            </div>
        </div>
    </div>
`;

        const existingModal = document.getElementById('rejectionModal');
        if (existingModal) {
            existingModal.remove();
        }

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Add inline styles for modal overlay
        const modal = document.getElementById('rejectionModal');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0, 0, 0, 0.5)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '10000';
    }

    // Function to close rejection modal
    function closeRejectionModal() {
        const modal = document.getElementById('rejectionModal');
        if (modal) {
            modal.remove();
        }
    }

    // Helper function to get current contract ID from URL
    function getCurrentContractId() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = parseInt(urlParams.get('id'));
        console.log(' Current contract ID from URL:', id);
        return id;
    }



    // Function to close rejection modal
    function closeRejectionModal() {
        const modal = document.getElementById('rejectionModal');
        if (modal) {
            modal.remove();
        }
    }

    // Function to submit rejection
    async function submitRejection(contractId, type = null) {
        const comment = document.getElementById('rejectionComment').value.trim();

        if (!comment) {
            showNotification(`Please provide a reason for rejection`, 'warning');
            return;
        }

        try {
            const response = await fetch('/api/v1/workflow/approve-reject', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contract_id: contractId,
                    action: 'reject',
                    request_type: type,
                    comments: comment
                })
            });

            const result = await response.json();

            if (response.ok) {
                closeRejectionModal();
                showNotification(`Rejection comment has been saved.`, 'success');

                await refreshContractData();
            } else {
                showNotification('Error: ' + (result.detail || 'Failed to reject contract'), 'success');

            }
        } catch (error) {
            console.error('Error rejecting workflow:', error);
            showNotification('Error rejecting contract. Please try again.', 'success');
        }
    }

    // Helper function to get current contract ID
    function getCurrentContractId() {
        const urlParams = new URLSearchParams(window.location.search);
        return parseInt(urlParams.get('id'));
    }
</script>


<script>

    function getApprovalBadge(current_approver, workflow, step_type) {
        console.log(current_approver);
        const approver = current_approver;
        const approverName = approver?.name || 'Approver';
        const approverDepartment = approver?.department || 'No Department';
        const approvalType = step_type?.includes('review') ? 'Review' : 'Approval';

        return `<span class="comment-count-badge" style="background: rgb(255, 243, 205); color: rgb(133, 100, 4); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 8px; display: inline-flex; gap: 6px;">
        <i class="ti ti-clock"></i> Awaiting ${approverName} ${approvalType} (${approverDepartment})
    </span>`;
    }
</script>


<script>
    // Function to open workflow history modal
    async function openWorkflowHistoryModal() {

        if (!contractId) {
            showNotification('Contract ID not found', 'error');
            return;
        }

        // Open modal
        openModal('workflowHistoryModal');

        // Fetch history
        await loadWorkflowHistory(contractId);
    }

    // Function to load workflow history
    async function loadWorkflowHistory(contractId) {
        const contentDiv = document.getElementById('workflowHistoryContent');

        try {
            const response = await fetch(`/api/v1/workflow/workflow-history/${contractId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // Display contract info
                if (result.contract) {
                    const contractInfo = document.getElementById('workflowHistoryContractInfo');
                    contractInfo.textContent = `Contract: ${result.contract.number} - ${result.contract.title}`;
                }

                displayWorkflowHistory(result.data);
            } else if (response.status === 403) {
                // Access denied
                contentDiv.innerHTML = `
                <div class="workflow-history-empty">
                    <i class="ti ti-lock"></i>
                    <p style="color: var(--danger-color); font-weight: 600;">Access Denied</p>
                    <small>You don't have permission to view this contract's workflow history</small>
                </div>
            `;
            } else {
                contentDiv.innerHTML = `
                <div class="workflow-history-empty">
                    <i class="ti ti-alert-circle"></i>
                    <p>Failed to load workflow history</p>
                </div>
            `;
            }
        } catch (error) {
            console.error('Error loading workflow history:', error);
            contentDiv.innerHTML = `
            <div class="workflow-history-empty">
                <i class="ti ti-alert-circle"></i>
                <p>Error loading workflow history</p>
            </div>
        `;
        }
    }

    // Function to display workflow history
    function displayWorkflowHistory(history) {
        const contentDiv = document.getElementById('workflowHistoryContent');

        if (!history || history.length === 0) {
            contentDiv.innerHTML = `
            <div class="workflow-history-empty">
                <i class="ti ti-file-text"></i>
                <p>No workflow history yet</p>
                <small>Approval and rejection comments will appear here</small>
            </div>
        `;
            return;
        }

        // Build timeline HTML
        let html = '<div class="workflow-history-timeline">';

        history.forEach(item => {
            const actionClass = item.action.toLowerCase().includes('approve') ? 'approved' : 'rejected';
            const actionIcon = item.action.toLowerCase().includes('approve') ? 'ti-check' : 'ti-x';
            const actionText = item.action.toLowerCase().includes('approve') ? 'Approved' : 'Rejected';

            // Get user initials
            const nameParts = item.user.name.split(' ');
            const initials = nameParts.map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();

            html += `
            <div class="workflow-history-item ${actionClass}">
                <div class="workflow-history-header">
                    <div class="workflow-history-user">
                        <div class="workflow-history-avatar">${initials}</div>
                        <div class="workflow-history-user-info">
                            <span class="workflow-history-user-name">${item.user.name}</span>
                            <span class="workflow-history-user-role">${item.user.role || item.user.department || 'Team Member'}</span>
                        </div>
                    </div>
                   
                </div>
                
                <div class="workflow-history-action ${actionClass}">
                    <i class="ti ${actionIcon}"></i>
                    ${actionText}
                </div>
                
                ${item.comment ? `
                    <div class="workflow-history-comment">
                        ${escapeHtml(item.comment)}
                    </div>
                ` : ''}
                
                ${item.workflow_step ? `
                    <div class="workflow-history-step">
                        <i class="ti ti-folder"></i>
                        Step ${item.workflow_step}
                    </div>
                ` : ''}
            </div>
        `;
        });

        html += '</div>';
        contentDiv.innerHTML = html;
    }

    // Helper function to format timestamp
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'Unknown time';

        // Parse the timestamp - handle both ISO format and MySQL datetime format
        let date;
        if (timestamp.includes('T')) {
            // ISO format: 2025-01-15T10:30:00
            date = new Date(timestamp);
        } else {
            // MySQL datetime format: 2025-01-15 10:30:00
            // Add 'T' to make it ISO-compatible, then parse
            date = new Date(timestamp.replace(' ', 'T'));
        }

        const now = new Date();
        const diff = now - date;

        // If timestamp seems to be in the future or more than 1 day in past due to timezone issues,
        // try to adjust by assuming server is in UTC
        if (diff < -3600000 || diff > 86400000) {
            // Get timezone offset in milliseconds
            const timezoneOffset = now.getTimezoneOffset() * 60000;
            date = new Date(date.getTime() - timezoneOffset);
            const adjustedDiff = now - date;

            // Use adjusted diff if it makes more sense
            if (adjustedDiff >= 0 && adjustedDiff < diff) {
                return formatRelativeTime(adjustedDiff, date);
            }
        }

        return formatRelativeTime(diff, date);
    }

    // Helper function to format relative time
    function formatRelativeTime(diff, date) {
        // Less than 1 minute
        if (diff < 60000) {
            return 'Just now';
        }

        // Less than 1 hour
        if (diff < 3600000) {
            const minutes = Math.floor(diff / 60000);
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        }

        // Less than 24 hours
        if (diff < 86400000) {
            const hours = Math.floor(diff / 3600000);
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        }

        // Less than 7 days
        if (diff < 604800000) {
            const days = Math.floor(diff / 86400000);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        // Format as date
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }


    function toggleMaximizeEditor() {
        const editorMain = document.querySelector('.editor-main');
        const toggleBtn = document.getElementById('maximizeToggleBtn');

        if (!editorMain) return;

        editorMain.classList.toggle('maximized');

        if (toggleBtn) {
            const icon = toggleBtn.querySelector('i');
            if (editorMain.classList.contains('maximized')) {
                icon.className = 'ti ti-arrows-minimize';
                toggleBtn.classList.add('active');
                toggleBtn.title = 'Exit Fullscreen';
            } else {
                icon.className = 'ti ti-arrows-maximize';
                toggleBtn.classList.remove('active');
                toggleBtn.title = 'Fullscreen';
            }
        }
    }

    // ESC key to exit maximize
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            const editorMain = document.querySelector('.editor-main.maximized');
            if (editorMain) {
                toggleMaximizeEditor();
            }
        }
    });




    // =====================================================
    // WORKFLOW AVAILABILITY CHECK
    // =====================================================

    let workflowAvailability = {
        master: { available: false, id: null, name: null },
        custom: { available: false, id: null, name: null }
    };

    /**
     * Check and update workflow options availability
     */
    async function checkWorkflowAvailability() {
        try {

            const response = await fetch(`/api/contracts/workflow/availability/${contractId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to check workflow availability');
            }

            const data = await response.json();
            workflowAvailability = {
                master: data.master_workflow,
                custom: data.custom_workflow
            };

            console.log(' Workflow availability checked:', workflowAvailability);
            updateWorkflowOptions();
            updateWorkflowOptionsApproval();

        } catch (error) {
            console.error(' Error checking workflow availability:', error);
            showNotification('Failed to check workflow availability', 'error');
        }
    }



    /**
     * Update workflow option UI based on availability
     */
    function updateWorkflowOptions() {
        const masterRadio = document.getElementById('masterWorkflow');
        const masterLabel = document.getElementById('masterWorkflowLabel');
        const masterDesc = document.getElementById('masterWorkflowDesc');
        const masterSetupBtn = document.getElementById('masterWorkflowSetupBtn');


        const customRadio = document.getElementById('customWorkflow');
        const customLabel = document.getElementById('customWorkflowLabel');
        const customDesc = document.getElementById('customWorkflowDesc');
        const customSetupBtn = document.getElementById('customWorkflowSetupBtn');

        // Handle Master Workflow
        if (workflowAvailability.master.available) {
            // Master workflow is available
            masterRadio.disabled = false;
            masterLabel.classList.remove('disabled');
            masterLabel.style.opacity = '1';
            masterLabel.style.cursor = 'pointer';
            masterLabel.style.background = 'white';
            // masterDesc.textContent = ``;
            masterSetupBtn.style.display = 'none';
        } else {
            // Master workflow NOT available - show setup option
            masterRadio.disabled = true;
            masterRadio.checked = false;
            masterLabel.classList.add('disabled');
            masterLabel.style.opacity = '0.5';
            masterLabel.style.cursor = 'not-allowed';
            masterLabel.style.background = '#f5f5f5';
            // masterDesc.textContent = 'Master workflow not configured for your company';
            masterSetupBtn.style.display = 'block';
        }

        // Handle Custom Workflow
        if (workflowAvailability.custom.available) {
            // Custom workflow is available
            customRadio.disabled = false;
            customLabel.classList.remove('disabled');
            customLabel.style.opacity = '1';
            customLabel.style.cursor = 'pointer';
            customLabel.style.background = 'white';
            customDesc.textContent = ``;
            // customSetupBtn.style.display = 'none';
        } else {
            // Custom workflow NOT available - show setup option
            customRadio.disabled = true;
            customRadio.checked = false;
            customLabel.classList.add('disabled');
            customLabel.style.opacity = '0.5';
            customLabel.style.cursor = 'not-allowed';
            customLabel.style.background = '#f5f5f5';
            customDesc.textContent = 'No custom workflow configured for this contract';
            // customSetupBtn.style.display = 'block';
        }
    }



    function updateWorkflowOptionsApproval() {
        const masterRadio = document.getElementById('masterWorkflowApproval');
        const masterLabel = document.getElementById('masterWorkflowLabelApproval');
        const masterDesc = document.getElementById('masterWorkflowDescApproval');
        const masterSetupBtn = document.getElementById('masterWorkflowSetupBtnApproval');


        const customRadio = document.getElementById('customWorkflowApproval');
        const customLabel = document.getElementById('customWorkflowLabelApproval');
        const customDesc = document.getElementById('customWorkflowDescApproval');
        const customSetupBtn = document.getElementById('customWorkflowSetupBtnApproval');

        console.log('ilham workflow', workflowAvailability);
        // Handle Master Workflow
        if (workflowAvailability.master.available) {
            // Master workflow is available
            masterRadio.disabled = false;
            masterLabel.classList.remove('disabled');
            masterLabel.style.opacity = '1';
            masterLabel.style.cursor = 'pointer';
            masterLabel.style.background = 'white';
            // masterDesc.textContent = ``;
            masterSetupBtn.style.display = 'none';
        } else {
            // Master workflow NOT available - show setup option
            masterRadio.disabled = true;
            masterRadio.checked = false;
            masterLabel.classList.add('disabled');
            masterLabel.style.opacity = '0.5';
            masterLabel.style.cursor = 'not-allowed';
            masterLabel.style.background = '#f5f5f5';
            // masterDesc.textContent = 'Master workflow not configured for your company';
            masterSetupBtn.style.display = 'block';
        }

        // Handle Custom Workflow
        if (workflowAvailability.custom.available) {
            // Custom workflow is available
            customRadio.disabled = false;
            customLabel.classList.remove('disabled');
            customLabel.style.opacity = '1';
            customLabel.style.cursor = 'pointer';
            customLabel.style.background = 'white';
            customDesc.textContent = ``;
            // customSetupBtn.style.display = 'none';
        } else {
            // Custom workflow NOT available - show setup option
            customRadio.disabled = true;
            customRadio.checked = false;
            customLabel.classList.add('disabled');
            customLabel.style.opacity = '0.5';
            customLabel.style.cursor = 'not-allowed';
            customLabel.style.background = '#f5f5f5';
            customDesc.textContent = 'No custom workflow configured for this contract';
            // customSetupBtn.style.display = 'block';
        }
    }


    /**
     * Redirect to master workflow setup page
     */
    function redirectToMasterWorkflowSetup() {
        if (confirm('You will be redirected to the Master Workflow Setup page. Any unsaved changes will be lost. Continue?')) {
            window.location.href = '/workflow-setup';  // Update with your actual workflow setup page URL
        }
    }

    /**
     * Open custom workflow setup modal (using existing contractWorkflowModal)
     */
    function openCustomWorkflowSetup() {
        // Close the internal review modal
        closeModal('internalReviewModal');

        // Open your existing contract workflow modal
        openModal('contractWorkflowModal');

        // If your existing modal has any initialization function, call it here
        // For example: initializeContractWorkflow();
    }

    // =====================================================
    // AI STREAMING FUNCTIONALITY (CORRECTED VERSION)
    // =====================================================



    // Set  as a global variable (used in regenerate function)

    console.log(' Contract ID from URL:', contractId);
    console.log(' Current Contract ID set to:', currentContractId);
    currentContractId = contractId;


    let isAIGenerated = false;
    let generationParams = null;

    // Wait for contract to fully load before checking AI generation
    async function initializeAIGeneration() {
        console.log(' Checking if contract is AI-generated...');

        if (!contractId) {
            console.log(' No contract ID available');
            return;
        }

        try {
            //  FETCH CONTRACT DATA FROM ENDPOINT
            console.log(` Fetching contract data from /api/contracts/edit/${contractId}`);

            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/contracts/edit/${contractId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.success || !data.contract) {
                console.log(' Invalid contract data received');
                return;
            }

            const contract = data.contract;

            console.log('=== AI GENERATION CHECK ===');
            console.log('Contract ID:', contract.id);
            console.log('Contract Number:', contract.contract_number);
            console.log('Is AI Generated:', contract.is_ai_generated);
            console.log('Has Params:', !!contract.ai_generation_params);
            console.log('==========================');

            //  CHECK IF AI-GENERATED FROM ENDPOINT DATA
            if (contract.is_ai_generated) {
                isAIGenerated = true;

                //  LOAD PARAMS FROM ENDPOINT RESPONSE
                if (contract.ai_generation_params) {
                    try {
                        if (typeof contract.ai_generation_params === 'string') {
                            generationParams = JSON.parse(contract.ai_generation_params);
                        } else {
                            generationParams = contract.ai_generation_params;
                        }
                        console.log(' Loaded generation params from database:', generationParams);
                    } catch (error) {
                        console.error(' Failed to parse generation params:', error);
                        generationParams = {};
                    }
                } else {
                    console.warn(' Contract is AI-generated but has no params');
                    generationParams = {};
                }

                // Wait for editor to be ready
                await waitForEditor();

                // Show regenerate button
                showRegenerateButton();

                //  CHECK IF CONTRACT HAS CONTENT
                const hasContent = contract.content && contract.content.trim().length > 100;

                if (!hasContent) {
                    console.log(' No content yet, starting AI generation...');
                    await startAIStreaming();
                } else {
                    console.log(' Contract already has content, regenerate available');
                }

            } else {
                console.log(' Contract is not AI-generated');
            }

        } catch (error) {
            console.error(' Error fetching contract data for AI check:', error);
        }
    }

    // Wait for editor element to exist
    function waitForEditor() {
        return new Promise((resolve) => {
            const checkEditor = setInterval(() => {
                const editor = document.getElementById('contractContent');
                if (editor) {
                    console.log(' Editor element found');
                    clearInterval(checkEditor);
                    resolve();
                } else {
                    console.log(' Waiting for editor element...');
                }
            }, 100);

            // Timeout after 10 seconds
            setTimeout(() => {
                clearInterval(checkEditor);
                resolve();
            }, 10000);
        });
    }

    async function checkIfAIGenerated() {
        if (!contractId || !contractData) return;

        try {
            const contract = contractData.contract;
            if (contract && contract.is_ai_generated) {
                isAIGenerated = true;
                await waitForEditor();
                showRegenerateButton();
                console.log(' Contract is AI-generated, regenerate button shown');
            }
        } catch (error) {
            console.error('Error checking AI status:', error);
        }
    }

    function showRegenerateButton() {
        console.log(' Looking for toolbar to add regenerate button...');


        if (contractData && contractData.contract) {
            const status = contractData.contract.status;

            if (status === 'executed' ||
                status === 'signed' || status === 'approved' || status === 'signature') {

                console.log(` Contract status is '${status}' - Regenerate button will NOT be shown`);
                return; // Exit function - don't show button
            }
        }

        // Wait for toolbar to exist
        const checkToolbar = setInterval(() => {
            let toolbar = document.querySelector('.document-actions');

            if (!toolbar) {
                toolbar = document.querySelector('.ai-toolbar-group');
            }

            if (!toolbar) {
                // Create toolbar above editor
                const editorContainer = document.querySelector('.editor-container');
                if (editorContainer) {
                    toolbar = document.createElement('div');
                    toolbar.className = 'document-actions';
                    toolbar.style.cssText = 'display: flex; gap: 0.5rem; padding: 1rem; border-bottom: 1px solid #dee2e6; background: white;';
                    editorContainer.insertBefore(toolbar, editorContainer.firstChild);
                }
            }

            if (toolbar && !document.getElementById('regenerateBtn')) {
                clearInterval(checkToolbar);

                const regenerateBtn = document.createElement('button');
                regenerateBtn.id = 'regenerateBtn';
                regenerateBtn.className = 'btn btn-secondary';
                regenerateBtn.style.cssText = `
                display: flex; 
                align-items: center; 
                gap: 0.5rem; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; 
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.3s ease;
            `;
                regenerateBtn.innerHTML = '<i class="ti ti-refresh"></i> Regenerate Contract';
                regenerateBtn.onclick = regenerateContract;

                regenerateBtn.onmouseover = function () {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                };
                regenerateBtn.onmouseout = function () {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                };

                toolbar.insertBefore(regenerateBtn, toolbar.firstChild);
                console.log(' Regenerate button added successfully');
            }
        }, 200);

        // Stop checking after 5 seconds
        setTimeout(() => clearInterval(checkToolbar), 5000);
    }

    let autoScrollEnabled = true;
    let scrollToBottomButton = null;
    let userIsScrolling = false;

    /**
     * Smoothly scroll editor-content to bottom
     */
    function scrollEditorToBottom(smooth = false) {
        const editorContent = document.querySelector('.editor-content') ||
            document.getElementById('editor-content') ||
            document.getElementById('contractContent');

        if (editorContent && !userIsScrolling) {
            if (smooth) {
                editorContent.scrollTo({
                    top: editorContent.scrollHeight,
                    behavior: 'smooth'
                });
            } else {
                editorContent.scrollTop = editorContent.scrollHeight;
            }

            const parent = editorContent.parentElement;
            if (parent && parent.scrollHeight > parent.clientHeight) {
                if (smooth) {
                    parent.scrollTo({
                        top: parent.scrollHeight,
                        behavior: 'smooth'
                    });
                } else {
                    parent.scrollTop = parent.scrollHeight;
                }
            }
        }
    }

    /**
     * Check if user is at the bottom of the editor
     */
    function isScrolledToBottom() {
        const editorContent = document.querySelector('.editor-content') ||
            document.getElementById('editor-content') ||
            document.getElementById('contractContent');

        if (!editorContent) return true;

        const threshold = 150; // pixels from bottom
        const scrollPosition = editorContent.scrollTop + editorContent.clientHeight;
        const scrollHeight = editorContent.scrollHeight;

        return scrollPosition >= scrollHeight - threshold;
    }

    /**
     * Create floating scroll-to-bottom button
     */
    function createScrollToBottomButton() {
        if (scrollToBottomButton) return;

        scrollToBottomButton = document.createElement('button');
        scrollToBottomButton.id = 'scrollToBottomBtn';
        scrollToBottomButton.innerHTML = '<i class="ti ti-arrow-down"></i>';
        scrollToBottomButton.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2762cb 0%, #1a4d9e 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.4);
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        z-index: 1000;
        transition: all 0.3s ease;
        animation: slideInUp 0.3s ease-out;
    `;

        // Hover effect
        scrollToBottomButton.onmouseover = function () {
            this.style.transform = 'scale(1.1)';
            this.style.boxShadow = '0 6px 20px rgba(39, 98, 203, 0.6)';
        };

        scrollToBottomButton.onmouseout = function () {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = '0 4px 12px rgba(39, 98, 203, 0.4)';
        };

        // Click handler
        scrollToBottomButton.onclick = function () {
            autoScrollEnabled = true;
            userIsScrolling = false;
            scrollEditorToBottom(true);
            hideScrollToBottomButton();
            console.log(' User clicked scroll button - auto-scroll resumed');
        };

        document.body.appendChild(scrollToBottomButton);

        // Add animation CSS if not exists
        if (!document.getElementById('scroll-button-animation')) {
            const style = document.createElement('style');
            style.id = 'scroll-button-animation';
            style.textContent = `
            @keyframes slideInUp {
                from {
                    transform: translateY(100px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            @keyframes pulse {
                0%, 100% {
                    box-shadow: 0 4px 12px rgba(39, 98, 203, 0.4);
                }
                50% {
                    box-shadow: 0 6px 20px rgba(39, 98, 203, 0.6);
                }
            }
            
            #scrollToBottomBtn.pulse {
                animation: pulse 2s infinite;
            }
        `;
            document.head.appendChild(style);
        }
    }

    /**
     * Show scroll-to-bottom button
     */
    function showScrollToBottomButton() {
        if (!scrollToBottomButton) {
            createScrollToBottomButton();
        }

        scrollToBottomButton.style.display = 'flex';
        scrollToBottomButton.classList.add('pulse');
    }

    /**
     * Hide scroll-to-bottom button
     */
    function hideScrollToBottomButton() {
        if (scrollToBottomButton) {
            scrollToBottomButton.style.display = 'none';
            scrollToBottomButton.classList.remove('pulse');
        }
    }

    /**
     * Setup scroll detection for manual scrolling
     */
    function setupScrollDetection() {
        const editorContent = document.querySelector('.editor-content') ||
            document.getElementById('editor-content') ||
            document.getElementById('contractContent');

        if (!editorContent) {
            console.warn(' Editor content not found for scroll detection');
            return;
        }

        let scrollTimeout;
        let isUserScrolling = false;

        // Detect when user starts scrolling
        editorContent.addEventListener('scroll', function () {
            userIsScrolling = true;
            isUserScrolling = true;

            // Clear previous timeout
            clearTimeout(scrollTimeout);

            // Debounce scroll event
            scrollTimeout = setTimeout(() => {
                userIsScrolling = false;
                isUserScrolling = false;

                const atBottom = isScrolledToBottom();

                if (!atBottom) {
                    // User scrolled up and stopped
                    autoScrollEnabled = false;
                    showScrollToBottomButton();
                    console.log(' User scrolled up, auto-scroll paused');
                } else {
                    // User is at bottom
                    autoScrollEnabled = true;
                    hideScrollToBottomButton();
                    console.log(' User at bottom, auto-scroll resumed');
                }
            }, 300); // Increased debounce time
        });

        // Detect wheel/touch events to immediately pause auto-scroll
        editorContent.addEventListener('wheel', function () {
            userIsScrolling = true;
            autoScrollEnabled = false;
        }, { passive: true });

        editorContent.addEventListener('touchstart', function () {
            userIsScrolling = true;
            autoScrollEnabled = false;
        }, { passive: true });

        console.log(' Scroll detection setup complete');
    }

    /**
     * Remove scroll detection and button
     */
    function cleanupScrollDetection() {
        hideScrollToBottomButton();
        autoScrollEnabled = true;
        userIsScrolling = false;
    }


    let aiStreamingInProgress = false;  // ADD THIS LINE



    async function startAIStreaming() {
        console.log(' Starting AI streaming...');

        // Set global flag to prevent other scripts from interfering
        aiStreamingInProgress = true;

        const editor = document.getElementById('contractContent');

        if (!editor) {
            console.error(' Contract editor element not found');
            showNotification('Contract editor not found. Please refresh the page.', 'error');
            aiStreamingInProgress = false;
            return;
        }

        const language = generationParams?.language || 'en';
        if (language === 'ar') editor.setAttribute('dir', 'rtl');

        console.log(' Editor found, starting stream...');

        // Reset auto-scroll state
        autoScrollEnabled = true;
        userIsScrolling = false;
        hideScrollToBottomButton();

        // Show banner
        showAIBanner();

        // Show loading state in editor
        editor.innerHTML = `
    <div style="text-align: center; padding: 4rem 2rem; color: #666;">
        <div style="width: 3rem; height: 3rem; border: 4px solid #f3f3f3; border-top: 4px solid #2762CB; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem;"></div>
        <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">AI is Generating Your Contract</h3>
        <p style="font-size: 1rem; max-width: 500px; margin: 0 auto;">
            This may take a while. The contract will appear here as it's being written...
        </p>
        <div id="streamProgress" style="margin-top: 1.5rem; font-size: 0.875rem; color: #888;">
            <i class="ti ti-dots"></i> Preparing...
        </div>
    </div>
    `;

        try {
            const token = localStorage.getItem('access_token');

            const response = await fetch(`/api/contracts/ai-generate-stream/${contractId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(generationParams || {})
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let accumulatedContent = '';

            //  FIX: Create streaming container and verify it exists
            function ensureStreamingContainer() {
                let contentDiv = document.getElementById('streamingContent');
                if (!contentDiv) {
                    console.log(' Creating streamingContent container...');
                    const editor = document.getElementById('contractContent');
                    if (editor) {
                        editor.innerHTML = '<div class="contract-document" id="streamingContent" style="min-height: 500px;"></div>';
                        contentDiv = document.getElementById('streamingContent');
                    }
                }
                return contentDiv;
            }

            // Create the initial container
            ensureStreamingContainer();
            console.log(' Initial streamingContent container created');

            // Setup scroll detection AFTER content div is created
            setTimeout(() => {
                setupScrollDetection();
            }, 500);

            while (true) {
                const { done, value } = await reader.read();

                if (done) {
                    console.log(' Streaming complete');
                    aiStreamingInProgress = false;  //  Clear flag

                    // Final scroll if at bottom and auto-scroll enabled
                    if (autoScrollEnabled && !userIsScrolling) {
                        scrollEditorToBottom();
                    }

                    // Cleanup after delay
                    setTimeout(() => {
                        cleanupScrollDetection();
                    }, 3000);

                    break;
                }

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonData = JSON.parse(line.substring(6));

                            if (jsonData.type === 'start') {
                                updateProgress(' Generating contract content...');
                                //  FIX: Ensure container exists when streaming starts
                                ensureStreamingContainer();

                            } else if (jsonData.type === 'content') {
                                accumulatedContent += jsonData.text;

                                //  FIX: Always ensure container exists before updating
                                const contentDiv = ensureStreamingContainer();
                                if (contentDiv) {
                                    contentDiv.innerHTML = accumulatedContent;
                                } else {
                                    console.error(' Failed to create streamingContent container');
                                }

                                const wordCount = accumulatedContent.split(/\s+/).filter(w => w.length > 0).length;
                                if (wordCount % 50 === 0) {
                                    updateProgress(` Writing contract... (${wordCount} words)`);
                                }

                                // Only auto-scroll when new content arrives AND auto-scroll is enabled
                                if (autoScrollEnabled && !userIsScrolling) {
                                    scrollEditorToBottom();
                                }

                            } else if (jsonData.type === 'done') {
                                updateProgress(` Complete! (${jsonData.word_count} words)`);
                                aiStreamingInProgress = false;  //  Clear flag

                                setTimeout(() => {
                                    const progress = document.getElementById('streamProgress');
                                    if (progress) progress.remove();
                                }, 2000);

                                showNotification(`Contract generated successfully! (${jsonData.word_count} words)`, 'success');

                                // Hide banner when complete
                                hideAIBanner();

                                // Final scroll if at bottom and auto-scroll enabled
                                if (autoScrollEnabled && !userIsScrolling) {
                                    scrollEditorToBottom();
                                }

                                // Cleanup scroll detection after delay
                                setTimeout(() => {
                                    cleanupScrollDetection();
                                }, 3000);

                                setTimeout(async () => await refreshContractData(), 1500);

                            } else if (jsonData.type === 'error') {
                                aiStreamingInProgress = false;  //  Clear flag
                                cleanupScrollDetection();
                                throw new Error(jsonData.message);
                            }
                        } catch (parseError) {
                            // Only log non-JSON parse errors
                            if (parseError.name !== 'SyntaxError') {
                                console.warn('Streaming error:', parseError);
                            }
                        }
                    }
                }
            }

        } catch (error) {
            console.error(' Streaming error:', error);
            aiStreamingInProgress = false;  //  Clear flag on error

            // Hide banner on error
            hideAIBanner();
            cleanupScrollDetection();

            editor.innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #dc3545;">
            <i class="ti ti-alert-circle" style="font-size: 3rem;"></i>
            <h3>Generation Failed</h3>
            <p>${error.message}</p>
            <button class="btn btn-primary" onclick="startAIStreaming()">
                <i class="ti ti-refresh"></i> Try Again
            </button>
        </div>
        `;
        }
    }




    function updateProgress(message) {
        const progressDiv = document.getElementById('streamProgress');
        if (progressDiv) {
            progressDiv.textContent = message;
        }
    }



    // =====================================================
    // REGENERATE CONTRACT FUNCTIONS
    // =====================================================
    function regenerateContract() {
        console.log(' Opening regenerate modal...');
        console.log(' Full generationParams:', generationParams);

        // Pre-fill modal with existing metadata
        if (generationParams) {
            // Set contract type
            const contractType = generationParams.contract_type || '';
            document.getElementById('regenContractType').value = contractType;

            // Set profile type
            const profileType = generationParams.profile_type || '';
            document.getElementById('regenProfileType').value = profileType;

            // ADD THIS: Set jurisdiction
            const jurisdiction = generationParams.jurisdiction || 'Qatar';
            document.getElementById('regenJurisdiction').value = jurisdiction;

            // Set additional requirements
            const additionalReqs = generationParams.metadata?.additional_requirements ||
                generationParams.metadata?.prompt || '';
            document.getElementById('regenAdditionalRequirements').value = additionalReqs;


            // Set payment terms
            const paymentTerms = generationParams.metadata?.payment_terms || '';
            document.getElementById('regenPaymentTerms').value = paymentTerms;

            // Set duration
            const duration = generationParams.metadata?.duration || '';
            document.getElementById('regenDuration').value = duration;

            // Restore clause selections if they exist
            const existingClauses = generationParams.selected_clauses || [];
            console.log(' Existing selected clauses:', existingClauses);

            if (existingClauses.length > 0) {
                // Show clause section if clauses were previously selected
                const section = document.getElementById('regenClauseSection');
                const toggleText = document.getElementById('clauseToggleText');
                section.style.display = 'block';
                toggleText.textContent = 'Hide Clause Selection';

                // Check the boxes for previously selected clauses
                existingClauses.forEach(clauseKey => {
                    const checkbox = document.querySelector(`input[name="regen_clause_${clauseKey}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`   Restored clause: ${clauseKey}`);
                    }
                });
            }
        }

        // Show modal
        const modal = document.getElementById('regenerateContractModal');
        modal.style.display = 'flex';

        console.log(' Regenerate modal opened');
    }



    function closeRegenerateModal() {
        const modal = document.getElementById('regenerateContractModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }



    function getRegenSelectedClauses() {
        regenSelectedClauses = [];

        // Get all checked checkboxes in regenerate modal
        const checkedBoxes = document.querySelectorAll('#regenClauseSection input[type="checkbox"]:checked');

        console.log(` Found ${checkedBoxes.length} checked clauses in regen modal`);

        checkedBoxes.forEach(checkbox => {
            // Extract clause key from name attribute (remove 'regen_clause_' prefix)
            const clauseKey = checkbox.name.replace('regen_clause_', '');

            if (clauseKey && clauseKey !== '') {
                regenSelectedClauses.push(clauseKey);
                console.log(`   Selected: ${clauseKey}`);
            }
        });

        console.log(` Total clauses selected for regeneration: ${regenSelectedClauses.length}`);
        console.log(' Selected clauses array:', regenSelectedClauses);

        return regenSelectedClauses;
    }


    async function submitRegeneration() {
        console.log(' Submitting regeneration request...');
        console.log(' Using Contract ID:', currentContractId);

        try {
            // Validate contract ID first
            if (!currentContractId || currentContractId === 'null' || currentContractId === null) {
                console.error(' Invalid contract ID:', currentContractId);
                showNotification('Error: Contract ID is missing. Please refresh the page.', 'error');
                return;
            }

            // Validate required fields
            const contractType = document.getElementById('regenContractType').value;
            const profileType = document.getElementById('regenProfileType').value;
            const jurisdiction = document.getElementById('regenJurisdiction').value; // ADD THIS
            const language = document.getElementById('regenLanguage').value;

            if (!contractType) {
                showNotification('Please select a contract type', 'warning');
                return;
            }

            if (!profileType) {
                showNotification('Please select a profile type', 'warning');
                return;
            }

            // ADD THIS VALIDATION
            if (!jurisdiction) {
                showNotification('Please select a jurisdiction', 'warning');
                return;
            }

            // Get clause selections
            const selectedClauses = getRegenSelectedClauses();

            // Get additional fields
            const additionalRequirements = document.getElementById('regenAdditionalRequirements').value.trim();
            const paymentTerms = document.getElementById('regenPaymentTerms').value.trim();
            const duration = document.getElementById('regenDuration').value.trim();

            // Prepare updated generation parameters
            const updatedParams = {
                contract_type: contractType,
                profile_type: profileType,
                selected_clauses: selectedClauses,
                clause_descriptions: selectedClauses,
                jurisdiction: jurisdiction, // UPDATED: Use the value from form field
                language: language || generationParams?.language,
                parties: generationParams?.parties || {},
                contract_value: generationParams?.contract_value,
                currency: generationParams?.currency,
                start_date: generationParams?.start_date,
                end_date: generationParams?.end_date,
                metadata: {
                    prompt: additionalRequirements || generationParams?.metadata?.prompt || '',
                    additional_requirements: additionalRequirements,
                    payment_terms: paymentTerms,
                    duration: duration
                }
            };

            console.log(' Updated params being sent:', updatedParams);
            console.log(' API URL:', `/api/contracts/${currentContractId}/update-metadata`);

            // Show loading indicator
            showLoader('Updating contract parameters...');

            // Step 1: Update contract metadata
            const token = getAuthToken();

            const updateResponse = await fetch(`/api/contracts/${currentContractId}/update-metadata`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                credentials: 'include',
                body: JSON.stringify({
                    ai_generation_params: updatedParams
                })
            });

            console.log(' Update response status:', updateResponse.status);

            if (!updateResponse.ok) {
                const errorData = await updateResponse.json();
                console.error(' Update failed:', errorData);
                throw new Error(errorData.detail || 'Failed to update metadata');
            }

            const updateResult = await updateResponse.json();
            console.log(' Metadata updated successfully:', updateResult);

            // Update local generationParams
            generationParams = updatedParams;

            // Close modal
            closeRegenerateModal();

            hideLoader();

            // Step 2: Regenerate contract content
            console.log(' Regenerating contract with AI...');

            // Show AI banner
            showAIBanner();

            // Clear editor and show loading
            const editor = document.getElementById('contractContent');
            if (editor) {
                editor.innerHTML = `
                <div style="text-align: center; padding: 4rem 2rem; color: #666;">
                    <div style="width: 3rem; height: 3rem; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem;"></div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">Regenerating Your Contract</h3>
                    <p style="font-size: 1rem; max-width: 500px; margin: 0 auto;">
                        AI is regenerating your contract with updated parameters and selected clauses. 
                        This may take a while...
                    </p>
                    <div id="streamProgress" style="margin-top: 1.5rem; font-size: 0.875rem; color: var(--primary-color);"></div>
                </div>
            `;
            }

            showNotification(
                `Contract regeneration started with ${selectedClauses.length} clause(s) selected`,
                'success'
            );

            // Call streaming endpoint
            await startAIStreaming();

            console.log(' Contract regeneration initiated');

        } catch (error) {
            hideLoader();
            console.error(' Regeneration error:', error);
            showNotification('Failed to regenerate contract: ' + error.message, 'error');
        }
    }


    // Add spinner animation CSS
    if (!document.getElementById('ai-streaming-styles')) {
        const style = document.createElement('style');
        style.id = 'ai-streaming-styles';
        style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
        document.head.appendChild(style);
    }

    console.log(' AI Streaming module loaded');


    function showAIBanner() {
        const banner = document.getElementById('aiGenerationBanner');
        if (banner) {
            banner.classList.add('active');
            console.log(' AI banner shown');
        }
    }

    function hideAIBanner() {
        const banner = document.getElementById('aiGenerationBanner');
        if (banner) {
            banner.classList.remove('active');
            console.log(' AI banner hidden');
        }
    }


    async function refreshContractData() {
        try {
            console.log(' Refreshing contract data...');

            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/contracts/edit/${contractId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            const data = await response.json();

            console.log(' Refreshed contract data:', data);

            if (data.success) {
                // Update global contractData
                contractData = data;

                // Set currentContractId
                if (data.contract && data.contract.id) {
                    currentContractId = data.contract.id;
                }

                console.log(' Contract content length:', data.contract.content?.length);
                console.log(' Certificate data:', data.certificate);

                //  CRITICAL: RE-RENDER THE ENTIRE EDITOR
                renderContractEditor(data);
                await checkWorkflowAvailability();
                await checkIfAIGenerated();


                //  UPDATE SIGNATURE FIELDS AFTER RENDERING
                if (data.certificate) {
                    console.log(' Updating signature displays with certificate data...');
                    setTimeout(() => {
                        updateSignatureFields(data.certificate);
                    }, 800);
                }

                // Update status badge
                if (data.contract && data.contract.status) {
                    const statusBadge = document.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = data.contract.status.charAt(0).toUpperCase() + data.contract.status.slice(1);
                        statusBadge.className = `status-badge status-${data.contract.status.toLowerCase()}`;
                    }
                }

                console.log(' Contract data refreshed and re-rendered successfully');

            } else {
                console.error(' Failed to refresh contract:', data.message);
            }
        } catch (error) {
            console.error(' Error refreshing contract:', error);
        }
    }



    function updateWorkflowStepper(workflow) {
        if (!workflow || !workflow.steps) return;

        const stepperSteps = document.querySelectorAll('.stepper-step');
        const progressBar = document.getElementById('stepperProgress');

        let activeStage = 0;
        const totalSteps = workflow.steps.length;

        workflow.steps.forEach((step, index) => {
            const stepEl = stepperSteps[index];
            if (!stepEl) return;

            // Clear previous classes
            stepEl.classList.remove('completed', 'active', 'pending');

            // Update based on status
            if (step.status === 'completed') {
                stepEl.classList.add('completed');
                stepEl.querySelector('.step-date').textContent = step.completed_date || 'Completed';
                activeStage = index + 1;
            } else if (step.status === 'active') {
                stepEl.classList.add('active');
                stepEl.querySelector('.step-date').textContent = 'In Progress';
                activeStage = index + 1;
            } else {
                stepEl.classList.add('pending');
                stepEl.querySelector('.step-date').textContent = 'Pending';
            }
        });

        // Update progress bar
        if (progressBar && totalSteps > 0) {
            const progressPercent = ((activeStage - 1) / (totalSteps - 1)) * 100;
            progressBar.style.width = `${progressPercent}%`;
        }
    }



    /**
     * Contract Documents Upload JavaScript
     * Add to contract-editor.js or include in SCR_016_contract_editor.html
     */

    // Global variable to store selected files
    let selectedDocumentFiles = [];

    // =====================================================
    // FILE SELECTION AND VALIDATION
    // =====================================================

    function handleDocumentFileSelect(event) {
        const files = Array.from(event.target.files);

        if (files.length === 0) {
            return;
        }

        console.log(` Selected ${files.length} files for upload`);

        // Validate each file
        const validFiles = [];
        const errors = [];

        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
        const ALLOWED_EXTENSIONS = [
            'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx',
            'txt', 'rtf', 'odt', 'jpg', 'jpeg', 'png', 'gif',
            'tiff', 'zip', 'msg', 'eml'
        ];

        files.forEach(file => {
            const fileName = file.name.toLowerCase();
            const fileExt = fileName.split('.').pop();

            // Check file extension
            if (!ALLOWED_EXTENSIONS.includes(fileExt)) {
                errors.push(`${file.name}: File type not allowed`);
                return;
            }

            // Check file size
            if (file.size > MAX_FILE_SIZE) {
                errors.push(`${file.name}: File exceeds 50MB limit`);
                return;
            }

            validFiles.push(file);
        });

        // Show errors if any
        if (errors.length > 0) {
            showNotification(
                `Some files were rejected:\n${errors.join('\n')}`,
                'warning'
            );
        }

        // Store valid files
        selectedDocumentFiles = validFiles;

        // Update UI
        displaySelectedFiles(validFiles);

        // Enable/disable upload button
        const uploadBtn = document.getElementById('uploadDocBtn');
        if (uploadBtn) {
            uploadBtn.disabled = validFiles.length === 0;
        }

        // Update status text
        const statusText = document.getElementById('uploadStatusText');
        if (statusText) {
            statusText.textContent = validFiles.length > 0
                ? `${validFiles.length} file(s) ready to upload`
                : 'Select files to upload';
        }
    }

    function displaySelectedFiles(files) {
        const previewContainer = document.getElementById('selectedFilesPreview');
        const filesList = document.getElementById('selectedFilesList');

        if (!previewContainer || !filesList) {
            return;
        }

        if (files.length === 0) {
            previewContainer.style.display = 'none';
            return;
        }

        previewContainer.style.display = 'block';
        filesList.innerHTML = '';

        files.forEach((file, index) => {
            const fileExt = file.name.split('.').pop().toLowerCase();
            const fileSize = formatFileSize(file.size);

            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
            <div style="display: flex; align-items: center; flex: 1;">
                <div class="file-icon" style="background: ${getFileIconColor(fileExt)};">
                    <i class="ti ti-${getFileIcon(fileExt)}" style="color: white;"></i>
                </div>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">${fileSize}</div>
                </div>
            </div>
            <button 
                class="btn btn-sm btn-outline-danger" 
                onclick="removeSelectedFile(${index})"
                title="Remove"
            >
                <i class="ti ti-x"></i>
            </button>
        `;

            filesList.appendChild(fileItem);
        });
    }

    function removeSelectedFile(index) {
        selectedDocumentFiles.splice(index, 1);
        displaySelectedFiles(selectedDocumentFiles);

        // Update upload button state
        const uploadBtn = document.getElementById('uploadDocBtn');
        if (uploadBtn) {
            uploadBtn.disabled = selectedDocumentFiles.length === 0;
        }

        // Update status text
        const statusText = document.getElementById('uploadStatusText');
        if (statusText) {
            statusText.textContent = selectedDocumentFiles.length > 0
                ? `${selectedDocumentFiles.length} file(s) ready to upload`
                : 'Select files to upload';
        }
    }

    // =====================================================
    // UPLOAD DOCUMENTS TO CONTRACT
    // =====================================================

    async function uploadContractDocuments() {
        if (selectedDocumentFiles.length === 0) {
            showNotification('Please select files to upload', 'warning');
            return;
        }

        const uploadBtn = document.getElementById('uploadDocBtn');
        const originalBtnContent = uploadBtn.innerHTML;

        try {
            // Get contract ID using helper function
            const contractId = getContractId();

            if (!contractId) {
                showNotification('Contract ID not found. Please refresh the page.', 'error');
                return;
            }

            // Get document type and notes
            const documentType = document.getElementById('documentTypeSelect')?.value || 'exhibit';
            const notes = document.getElementById('documentNotes')?.value || '';

            // Show loading state
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> Uploading...';

            // Create FormData
            const formData = new FormData();
            selectedDocumentFiles.forEach(file => {
                formData.append('files', file);
            });
            formData.append('document_type', documentType);
            formData.append('notes', notes);

            console.log(` Uploading ${selectedDocumentFiles.length} documents to contract ${contractId}`);

            // Upload files
            const response = await fetch(`/api/contracts/documents/upload/${contractId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
                },
                credentials: 'include',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Upload failed');
            }

            const result = await response.json();
            console.log(' Upload result:', result);

            // Show success message
            showNotification(
                `Successfully uploaded ${result.successful_uploads} of ${result.total_files} files`,
                result.successful_uploads === result.total_files ? 'success' : 'warning'
            );

            // Show errors if any
            if (result.errors && result.errors.length > 0) {
                console.error('Upload errors:', result.errors);
            }

            // Reset form
            selectedDocumentFiles = [];
            document.getElementById('fileUploadDoc').value = '';
            document.getElementById('documentNotes').value = '';
            displaySelectedFiles([]);

            // Refresh documents list
            await loadContractDocuments();

            // Reset button
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = originalBtnContent;

            // Update status text
            const statusText = document.getElementById('uploadStatusText');
            if (statusText) {
                statusText.textContent = 'Select files to upload';
            }

        } catch (error) {
            console.error(' Upload error:', error);
            showNotification(error.message || 'Failed to upload documents', 'error');

            // Reset button
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalBtnContent;
        }
    }

    // =====================================================
    // LOAD AND DISPLAY EXISTING DOCUMENTS
    // =====================================================

    async function loadContractDocuments() {
        // Get contract ID using helper function
        const contractId = getContractId();

        if (!contractId) {
            console.warn(' Contract ID not found for loading documents');
            return;
        }

        const listContainer = document.getElementById('attachedDocumentsList');
        const loadingDiv = document.getElementById('documentsLoading');
        const noDocsDiv = document.getElementById('noDocumentsMessage');

        if (!listContainer) {
            return;
        }

        try {
            // Show loading state
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (noDocsDiv) noDocsDiv.style.display = 'none';
            listContainer.style.display = 'none';

            const response = await fetch(`/api/contracts/documents/list/${contractId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to load documents');
            }

            const result = await response.json();
            console.log(` Loaded ${result.total_documents} documents`);

            // Hide loading
            if (loadingDiv) loadingDiv.style.display = 'none';

            // Show no documents message if empty
            if (result.total_documents === 0) {
                if (noDocsDiv) noDocsDiv.style.display = 'block';
                listContainer.style.display = 'none';
                return;
            }

            // Display documents
            listContainer.style.display = 'block';
            listContainer.innerHTML = '';

            result.documents.forEach(doc => {
                const fileExt = doc.name.split('.').pop().toLowerCase();
                const fileSize = formatFileSize(doc.size);
                const uploadDate = new Date(doc.uploaded_at).toLocaleDateString();

                const docItem = document.createElement('div');
                docItem.className = 'file-item';
                docItem.innerHTML = `
                <div style="display: flex; align-items: center; flex: 1; gap: 1rem;">
                    <div class="file-icon" style="background: ${getFileIconColor(fileExt)};">
                        <i class="ti ti-${getFileIcon(fileExt)}" style="color: white;"></i>
                    </div>
                    <div class="file-info" style="flex: 1;">
                        <div class="file-name">${doc.name}</div>
                        <div class="file-meta">
                            <span class="doc-type-badge doc-type-${doc.type}">${doc.type.replace('_', ' ')}</span>
                            <span style="margin-left: 0.5rem;">${fileSize}  ${uploadDate}</span>
                            <span style="margin-left: 0.5rem;">by ${doc.uploaded_by}</span>
                            ${doc.hash ? `<span style="margin-left: 0.5rem;" title="Blockchain Hash"> ${doc.hash}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="file-actions">
                    <button 
                        class="btn btn-sm btn-outline-primary" 
                        onclick="downloadDocument('${doc.id}', '${doc.name}')"
                        title="Download"
                    >
                        <i class="ti ti-download"></i>
                    </button>
                    <button 
                        class="btn btn-sm btn-outline-danger" 
                        onclick="deleteDocument('${doc.id}', '${doc.name}')"
                        title="Delete"
                    >
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
            `;

                listContainer.appendChild(docItem);
            });

        } catch (error) {
            console.error(' Error loading documents:', error);
            if (loadingDiv) loadingDiv.style.display = 'none';
            showNotification('Failed to load documents', 'error');
        }
    }

    async function refreshDocumentsList() {
        console.log(' Refreshing documents list...');
        await loadContractDocuments();
    }

    // =====================================================
    // DOCUMENT ACTIONS
    // =====================================================
    async function downloadDocument(documentId, fileName) {
        try {
            console.log(` Downloading document: ${fileName} (ID: ${documentId})`);

            // Show loading notification
            showNotification(`Preparing download: ${fileName}...`, 'info');

            // Create download URL with authentication
            const token = localStorage.getItem('access_token') || '';
            const downloadUrl = `/api/contracts/documents/download/${documentId}`;

            // Fetch the file
            const response = await fetch(downloadUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                credentials: 'include'
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: 'Download failed' }));
                throw new Error(error.detail || 'Failed to download document');
            }

            // Get the blob
            const blob = await response.blob();

            // Create a temporary URL for the blob
            const url = window.URL.createObjectURL(blob);

            // Create a temporary anchor element to trigger download
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName;

            // Append to body, click, and remove
            document.body.appendChild(a);
            a.click();

            // Clean up
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            console.log(` Download started: ${fileName}`);
            showNotification(`Download started: ${fileName}`, 'success');

        } catch (error) {
            console.error(' Download error:', error);
            showNotification(`Failed to download: ${error.message}`, 'error');
        }
    }

    async function viewDocument(documentId, fileName) {
        try {
            console.log(` Viewing document: ${fileName} (ID: ${documentId})`);

            const token = localStorage.getItem('access_token') || '';
            const viewUrl = `/api/contracts/documents/view/${documentId}?inline=true`;

            // Open in new tab with authentication
            const response = await fetch(viewUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to load document');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            // Open in new tab
            const newWindow = window.open(url, '_blank');

            if (!newWindow) {
                // Popup blocked, fallback to download
                showNotification('Popup blocked. Downloading instead...', 'warning');
                await downloadDocument(documentId, fileName);
            } else {
                showNotification(`Opening: ${fileName}`, 'success');

                // Clean up after a delay
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 60000); // Clean up after 1 minute
            }

        } catch (error) {
            console.error(' View error:', error);
            showNotification(`Failed to view document: ${error.message}`, 'error');
        }
    }


    async function deleteDocument(documentId, fileName) {
        if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/contracts/documents/delete/${documentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to delete document');
            }

            const result = await response.json();
            console.log(' Document deleted:', result);

            showNotification(`Document "${fileName}" deleted successfully`, 'success');

            // Refresh documents list
            await loadContractDocuments();

        } catch (error) {
            console.error(' Delete error:', error);
            showNotification('Failed to delete document', 'error');
        }
    }

    // =====================================================
    // MODAL MANAGEMENT
    // =====================================================

    function closeDocumentsModal() {
        // Reset form
        selectedDocumentFiles = [];
        document.getElementById('fileUploadDoc').value = '';
        document.getElementById('documentNotes').value = '';
        displaySelectedFiles([]);

        // Close modal
        closeModal('documentsModal');
    }

    // Load documents when modal is opened
    function openDocumentsModal() {
        openModal('documentsModal');
        loadContractDocuments();
    }

    // =====================================================
    // UTILITY FUNCTIONS
    // =====================================================

    /**
     * Get contract ID from multiple possible sources
     * Supports various URL patterns and global variables
     */
    function getContractId() {
        let contractId = null;

        // Method 1: Check for global contractId variable (most reliable)
        if (typeof window.contractId !== 'undefined' && window.contractId) {
            contractId = window.contractId;
            console.log(' Contract ID from global variable:', contractId);
            return contractId;
        }

        // Method 2: Check URL query parameter (?id=123)
        const urlParams = new URLSearchParams(window.location.search);
        contractId = urlParams.get('id');
        if (contractId) {
            console.log(' Contract ID from URL query:', contractId);
            return contractId;
        }

        // Method 3: Check URL path (/contract/edit/123 or /contract/editor/123)
        const pathParts = window.location.pathname.split('/');
        const editIndex = pathParts.findIndex(part => part === 'edit' || part === 'editor');
        if (editIndex !== -1 && pathParts[editIndex + 1]) {
            contractId = pathParts[editIndex + 1];
            console.log(' Contract ID from URL path:', contractId);
            return contractId;
        }

        // Method 4: Check for contract ID in page data attributes
        const editorElement = document.getElementById('contractContent');
        if (editorElement && editorElement.dataset.contractId) {
            contractId = editorElement.dataset.contractId;
            console.log(' Contract ID from data attribute:', contractId);
            return contractId;
        }

        // Method 5: Check for hidden input field
        const hiddenInput = document.getElementById('contract_id') || document.querySelector('input[name="contract_id"]');
        if (hiddenInput && hiddenInput.value) {
            contractId = hiddenInput.value;
            console.log(' Contract ID from hidden input:', contractId);
            return contractId;
        }

        console.error(' Contract ID not found. URL:', window.location.href);
        return null;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function getFileIcon(extension) {
        const iconMap = {
            pdf: 'file-text',
            doc: 'file-text',
            docx: 'file-text',
            xls: 'table',
            xlsx: 'table',
            ppt: 'presentation',
            pptx: 'presentation',
            txt: 'file-text',
            rtf: 'file-text',
            jpg: 'photo',
            jpeg: 'photo',
            png: 'photo',
            gif: 'photo',
            zip: 'file-zip',
            msg: 'mail',
            eml: 'mail'
        };
        return iconMap[extension] || 'file';
    }

    function getFileIconColor(extension) {
        const colorMap = {
            pdf: '#d32f2f',
            doc: '#1976d2',
            docx: '#1976d2',
            xls: '#388e3c',
            xlsx: '#388e3c',
            ppt: '#f57c00',
            pptx: '#f57c00',
            jpg: '#7b1fa2',
            jpeg: '#7b1fa2',
            png: '#7b1fa2',
            gif: '#7b1fa2',
            zip: '#616161',
            msg: '#0288d1',
            eml: '#0288d1'
        };
        return colorMap[extension] || '#757575';
    }

    // =====================================================
    // DRAG AND DROP SUPPORT
    // =====================================================

    document.addEventListener('DOMContentLoaded', function () {
        const uploadZone = document.getElementById('uploadZoneDoc');

        if (uploadZone) {
            uploadZone.addEventListener('dragover', function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('dragging');
            });

            uploadZone.addEventListener('dragleave', function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragging');
            });

            uploadZone.addEventListener('drop', function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragging');

                const files = e.dataTransfer.files;
                const fileInput = document.getElementById('fileUploadDoc');

                if (fileInput && files.length > 0) {
                    fileInput.files = files;
                    handleDocumentFileSelect({ target: fileInput });
                }
            });
        }
    });



    /**
     * Toggle the clause selection section visibility
     */
    function toggleClauseSection() {
        const section = document.getElementById('regenClauseSection');
        const toggleText = document.getElementById('clauseToggleText');

        if (section.style.display === 'none') {
            section.style.display = 'block';
            toggleText.textContent = 'Hide Clause Selection';
        } else {
            section.style.display = 'none';
            toggleText.textContent = 'Show Clause Selection';
        }
    }


</script>


<script>
    let companyUsers = [];
    let selectedUserEmail = '';

    // Load all company users
    async function loadCompanyUsersForReview() {
        console.log('loading');
        try {
            const response = await fetch('/api/users/company?limit=100', {
                method: 'GET',
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to fetch users');
            }

            const data = await response.json();
            companyUsers = data.users || [];

            console.log(' Loaded', companyUsers.length, 'users for review');

            if (companyUsers.length === 0) {
                showNotification('No users found in your company', 'warning');
            }
        } catch (error) {
            console.error(' Error loading users:', error);
            showNotification('Failed to load users', 'error');
        }
    }

    // Search and filter users
    function searchUsers(query) {
        if (!query || query.length < 2) {
            document.getElementById('userDropdownResults').style.display = 'none';
            return;
        }

        const filtered = companyUsers.filter(user => {
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.toLowerCase();
            const email = (user.email || '').toLowerCase();
            const department = (user.department || '').toLowerCase();
            const searchTerm = query.toLowerCase();

            return fullName.includes(searchTerm) ||
                email.includes(searchTerm) ||
                department.includes(searchTerm);
        });

        displayUserResults(filtered);
    }

    // Display search results
    function displayUserResults(users) {
        const resultsDiv = document.getElementById('userDropdownResults');

        if (users.length === 0) {
            resultsDiv.innerHTML = '<div style="padding: 0.75rem; color: var(--text-muted);">No users found</div>';
            resultsDiv.style.display = 'block';
            return;
        }

        resultsDiv.innerHTML = users.map(user => {
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
            const displayName = fullName || user.email;
            return `
        <div onclick="selectUser('${user.email}', '${displayName.replace(/'/g, "\\'")}', '${user.department || ''}')" 
             style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border-color);"
             onmouseover="this.style.background='var(--background-light)'"
             onmouseout="this.style.background='white'">
            <div style="font-weight: 500;">${displayName}</div>
            <div style="font-size: 0.875rem; color: var(--text-muted);">${user.email}</div>
            ${user.department ? `<div style="font-size: 0.75rem; color: var(--text-muted);">${user.department}</div>` : ''}
        </div>
    `}).join('');

        resultsDiv.style.display = 'block';
    }

    // Select user from dropdown
    function selectUser(email, name, department) {
        selectedUserEmail = email;
        document.getElementById('specificPersonnel').value = email;
        document.getElementById('specificPersonnelSearch').value = '';
        document.getElementById('userDropdownResults').style.display = 'none';

        // Show selected user
        document.getElementById('selectedUserName').textContent = `${name} (${email})${department ? ' - ' + department : ''}`;
        document.getElementById('selectedUserDisplay').style.display = 'block';
    }

    // Clear selected user
    function clearSelectedUser() {
        selectedUserEmail = '';
        document.getElementById('specificPersonnel').value = '';
        document.getElementById('selectedUserDisplay').style.display = 'none';
    }

    // Open modal and load users
    async function openInternalReviewModal() {
        await checkWorkflowAvailability();
        console.log(' DEBUG: openInternalReviewModal called');
        openModal('internalReviewModal');
        console.log(' DEBUG: Modal opened, now loading users...');
        await loadCompanyUsersForReview();
        await clearSelectedUser();
        console.log(' DEBUG: Cleared selected user');
    }

    // Setup search input listener
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('specificPersonnelSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                searchUsers(this.value);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !document.getElementById('userDropdownResults').contains(e.target)) {
                    document.getElementById('userDropdownResults').style.display = 'none';
                }
            });
        }
    });


    // Hook into the existing openModal function
    (function () {
        // Store the original openModal function
        const originalOpenModal = window.openModal;

        // Override openModal
        window.openModal = function (modalId) {
            // Call the original function first
            if (originalOpenModal) {
                originalOpenModal(modalId);
            } else {
                // Fallback if no original function exists
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }

            // If it's the internal review modal, load users
            if (modalId === 'internalReviewModal') {
                console.log(' Internal Review Modal opened - loading users...');
                if (typeof loadCompanyUsersForReview === 'function') {
                    loadCompanyUsersForReview();
                } else {
                    console.error(' loadCompanyUsersForReview function not found!');
                }
            }
        };

        console.log(' Modal hook installed for internal review');
    })();



    async function saveEsignature() {
        const contractId = document.getElementById('contract_id').value;
        const partyId = document.getElementById('companyEmail').value;
        const counterpartyId = document.getElementById('counterPartyEmail').value;

        if (!partyId || !counterpartyId) {
            alert('Please select both e-signature authorities');
            return;
        }

        try {
            const response = await fetch(`/api/contracts/${contractId}/esignature`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    party_authority_id: parseInt(partyId),
                    counterparty_authority_id: parseInt(counterpartyId)
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('E-signature authorities saved successfully!');
                bootstrap.Modal.getInstance(document.getElementById('sendForSignatureModal')).hide();
            }
        } catch (error) {
            console.error('Save error:', error);
            alert('Error saving e-signature authorities');
        }
    }




    // =====================================================
    // PERMANENT FIX FOR TRACK CHANGES
    // Add this to SCR_016_contract_editor.html
    // Place this AFTER all other script code, near the end of <script> section
    // =====================================================

    // =====================================================
    // WORKING TRACK CHANGES - BEFOREINPUT LISTENER
    // =====================================================
    // (function () {
    //     console.log(" Initializing WORKING Track Changes listener...");

    //     // Wait for DOM to be ready
    //     function initTrackChangesListener() {
    //         const contractContent = document.getElementById('contractContent');

    //         if (!contractContent) {
    //             console.error(" Contract content not found!");
    //             return;
    //         }

    //         console.log(" Attaching track changes beforeinput listener...");

    //         // Remove any existing listener by cloning (clean slate)
    //         const newContent = contractContent.cloneNode(true);
    //         contractContent.parentNode.replaceChild(newContent, contractContent);

    //         // Reattach the ID
    //         newContent.id = 'contractContent';

    //         // Attach the WORKING beforeinput listener
    //         newContent.addEventListener('beforeinput', function (e) {
    //             // Only process if track changes is enabled
    //             if (!trackChangesEnabled) {
    //                 return; // Normal editing
    //             }

    //             console.log(" Track Changes - beforeinput fired:", e.inputType);

    //             const inputType = e.inputType;

    //             // Handle DELETIONS
    //             if (inputType === 'deleteContentBackward' ||
    //                 inputType === 'deleteContentForward' ||
    //                 inputType === 'deleteByCut') {

    //                 const selection = window.getSelection();

    //                 if (selection.rangeCount > 0) {
    //                     const selectedText = selection.toString().trim();

    //                     if (selectedText) {
    //                         // PREVENT the actual deletion
    //                         e.preventDefault();
    //                         e.stopPropagation();

    //                         console.log(" Deletion prevented:", selectedText.substring(0, 50));

    //                         const range = selection.getRangeAt(0);

    //                         // Create strikethrough span
    //                         const span = document.createElement('span');
    //                         span.className = 'track-change-delete';
    //                         span.setAttribute('data-change-type', 'delete');
    //                         span.setAttribute('data-change-id', 'change_' + Date.now());
    //                         span.setAttribute('data-change-author', currentUserName || 'User');
    //                         span.setAttribute('data-change-date', new Date().toISOString());

    //                         // Apply inline styles (CRITICAL)
    //                         span.style.cssText = `
    //                         text-decoration: line-through;
    //                         text-decoration-color: #dc3545;
    //                         text-decoration-thickness: 2px;
    //                         background: rgba(220, 53, 69, 0.15);
    //                         color: #dc3545;
    //                         padding: 2px 4px;
    //                         border-radius: 3px;
    //                         cursor: pointer;
    //                         display: inline;
    //                     `;

    //                         span.textContent = selectedText;
    //                         span.title = `Deleted by ${currentUserName || 'User'} - Click to Accept/Reject`;

    //                         // Add click handler for Accept/Reject
    //                         span.onclick = function (evt) {
    //                             evt.stopPropagation();

    //                             const action = confirm(
    //                                 `Deleted by ${this.getAttribute('data-change-author')}\n\n` +
    //                                 `"${this.textContent.substring(0, 50)}..."\n\n` +
    //                                 `Click OK to ACCEPT (remove text)\n` +
    //                                 `Click Cancel to REJECT (restore text)`
    //                             );

    //                             if (action) {
    //                                 // Accept - remove the element
    //                                 console.log(" Deletion accepted");
    //                                 this.remove();
    //                                 saveAsDraft();
    //                             } else {
    //                                 // Reject - restore text
    //                                 console.log(" Deletion rejected - restoring text");
    //                                 const text = this.textContent;
    //                                 this.replaceWith(document.createTextNode(text));
    //                                 saveAsDraft();
    //                             }
    //                         };

    //                         // Insert the strikethrough span
    //                         range.deleteContents();
    //                         range.insertNode(span);

    //                         // Clear selection
    //                         selection.removeAllRanges();

    //                         // Track the change
    //                         if (typeof trackedChanges !== 'undefined') {
    //                             trackedChanges.push({
    //                                 id: span.getAttribute('data-change-id'),
    //                                 type: 'delete',
    //                                 text: selectedText,
    //                                 author: currentUserName || 'User',
    //                                 date: new Date().toISOString()
    //                             });
    //                         }

    //                         console.log(" RED STRIKETHROUGH CREATED!");

    //                         // Show notification
    //                         if (typeof showNotification === 'function') {
    //                             showNotification('Text marked for deletion', 'info');
    //                         }
    //                     }
    //                 }
    //             }

    //             // Handle INSERTIONS (optional - for green underline)
    //             else if (inputType === 'insertText' ||
    //                 inputType === 'insertFromPaste' ||
    //                 inputType === 'insertParagraph') {

    //                 // Let insertion happen normally for now
    //                 // You can add green underline tracking here later
    //                 console.log(" Text insertion:", e.data);
    //             }
    //         }, true); // Use capture phase

    //         console.log(" Track changes listener attached successfully!");
    //     }

    //     // Initialize when DOM is ready
    //     if (document.readyState === 'loading') {
    //         document.addEventListener('DOMContentLoaded', initTrackChangesListener);
    //     } else {
    //         initTrackChangesListener();
    //     }
    // })();

    // =====================================================
    // ENHANCED TOGGLE FUNCTION (replaces existing one)
    // =====================================================
    // Find your existing toggleTrackChanges() function and replace it with this:

    // async function toggleTrackChanges() {
    //     trackChangesEnabled = !trackChangesEnabled;
    //     const btn = document.getElementById('trackChangesBtn');

    //     if (trackChangesEnabled) {
    //         btn.classList.add('active');
    //         btn.style.background = 'var(--primary-color)';
    //         btn.style.color = 'white';

    //         // Store current content as baseline
    //         originalContent = document.getElementById('contractContent').innerHTML;

    //         // Show track changes panel
    //         showTrackChangesPanel();

    //         console.log(" Track changes ENABLED");
    //         console.log("   Now delete text - it should show RED STRIKETHROUGH");

    //         // Enable track changes on backend
    //         try {
    //             const response = await fetch(`/api/contracts/track-changes/${contractId}?action=enable`, {
    //                 method: 'POST'
    //             });
    //             const data = await response.json();
    //             if (data.success) {
    //                 showNotification('Track changes enabled - deletions will show strikethrough', 'success');
    //             }
    //         } catch (error) {
    //             console.error('Error enabling track changes:', error);
    //         }
    //     } else {
    //         btn.classList.remove('active');
    //         btn.style.background = '';
    //         btn.style.color = '';

    //         // Hide track changes panel
    //         hideTrackChangesPanel();

    //         console.log(" Track changes DISABLED");

    //         // Ask user what to do with tracked changes
    //         const action = confirm('Accept all tracked changes?') ? 'accept_all' : 'reject_all';

    //         if (action === 'accept_all') {
    //             acceptAllChanges();
    //         } else {
    //             rejectAllChanges();
    //         }

    //         try {
    //             const response = await fetch(`/api/contracts/track-changes/${contractId}?action=${action}`, {
    //                 method: 'POST'
    //             });
    //             await response.json();
    //         } catch (error) {
    //             console.error('Error disabling track changes:', error);
    //         }

    //         showNotification('Track changes disabled', 'info');
    //     }



    //     // =====================================================
    //     // WORKING FIX - Paste this ENTIRE thing in console
    //     // If this works, I'll show you where to add it permanently
    //     // =====================================================

    //     console.log(" APPLYING WORKING TRACK CHANGES FIX...\n");

    //     // Get the contract content element
    //     const contractContent = document.getElementById('contractContent');

    //     if (!contractContent) {
    //         console.error(" Contract content not found!");
    //     } else {
    //         console.log(" Found contract content element");

    //         // Remove ALL existing beforeinput listeners by replacing the element
    //         console.log(" Removing any existing listeners...");
    //         const newContent = contractContent.cloneNode(true);
    //         contractContent.parentNode.replaceChild(newContent, contractContent);

    //         // Make sure ID is set
    //         newContent.id = 'contractContent';
    //         newContent.contentEditable = 'true';

    //         console.log(" Element refreshed");

    //         // Now attach our listener to the NEW element
    //         console.log(" Attaching working beforeinput listener...");

    //         newContent.addEventListener('beforeinput', function (e) {
    //             console.log(" beforeinput FIRED:", e.inputType);

    //             // Check if track changes is enabled
    //             if (typeof trackChangesEnabled === 'undefined' || !trackChangesEnabled) {
    //                 console.log("  Track changes is OFF - letting deletion happen normally");
    //                 return;
    //             }

    //             console.log(" Track changes is ON - processing deletion...");

    //             const inputType = e.inputType;

    //             // Handle deletions
    //             if (inputType === 'deleteContentBackward' ||
    //                 inputType === 'deleteContentForward' ||
    //                 inputType === 'deleteByCut') {

    //                 console.log(" Delete event detected!");

    //                 const selection = window.getSelection();

    //                 if (selection.rangeCount > 0) {
    //                     const selectedText = selection.toString().trim();

    //                     if (selectedText) {
    //                         console.log(" Selected text:", selectedText.substring(0, 50));

    //                         // PREVENT DELETION
    //                         e.preventDefault();
    //                         e.stopPropagation();
    //                         e.stopImmediatePropagation();

    //                         console.log(" DELETION PREVENTED!");

    //                         const range = selection.getRangeAt(0);

    //                         // Create strikethrough span
    //                         const span = document.createElement('span');
    //                         span.className = 'track-change-delete';

    //                         // INLINE STYLES (critical!)
    //                         span.style.textDecoration = 'line-through';
    //                         span.style.textDecorationColor = '#dc3545';
    //                         span.style.textDecorationThickness = '2px';
    //                         span.style.background = 'rgba(220, 53, 69, 0.15)';
    //                         span.style.color = '#dc3545';
    //                         span.style.padding = '2px 4px';
    //                         span.style.borderRadius = '3px';
    //                         span.style.cursor = 'pointer';
    //                         span.style.display = 'inline';

    //                         span.textContent = selectedText;
    //                         span.title = 'Click to Accept/Reject';

    //                         // Add click handler
    //                         span.onclick = function (evt) {
    //                             evt.stopPropagation();
    //                             const accept = confirm('Accept deletion? (Click OK to remove, Cancel to restore)');
    //                             if (accept) {
    //                                 this.remove();
    //                             } else {
    //                                 this.replaceWith(document.createTextNode(this.textContent));
    //                             }
    //                         };

    //                         // Insert the span
    //                         range.deleteContents();
    //                         range.insertNode(span);

    //                         // Clear selection
    //                         selection.removeAllRanges();

    //                         console.log(" RED STRIKETHROUGH CREATED!");
    //                         console.log("   Look at the text - you should see it!");

    //                     } else {
    //                         console.log("  No text selected");
    //                     }
    //                 } else {
    //                     console.log("  No selection range");
    //                 }
    //             } else {
    //                 console.log("  Other input type:", inputType);
    //             }
    //         }, true); // Use capture phase!

    //         console.log("\n LISTENER ATTACHED!\n");
    //         console.log(" NOW TEST:");
    //         console.log("1. Make sure track changes is ON (green button)");
    //         console.log("2. Select some text");
    //         console.log("3. Press DELETE or BACKSPACE");
    //         console.log("4. Watch console for messages");
    //         console.log("5. Text should show RED STRIKETHROUGH!\n");
    //     }

    //     // Also make sure track changes is enabled
    //     if (typeof trackChangesEnabled !== 'undefined' && !trackChangesEnabled) {
    //         console.log("  Track changes is currently OFF");
    //         console.log("   Click the Track Changes button to enable it");
    //     } else if (typeof trackChangesEnabled !== 'undefined' && trackChangesEnabled) {
    //         console.log(" Track changes is ON - you're ready to test!");
    //     }
    // }

    // (function () {
    //     function initWorkingTrackChanges() {
    //         const contractContent = document.getElementById('contractContent');
    //         if (!contractContent) return;

    //         console.log(" Initializing working track changes listener...");

    //         contractContent.addEventListener('beforeinput', function (e) {
    //             if (!trackChangesEnabled) return;

    //             if (e.inputType === 'deleteContentBackward' ||
    //                 e.inputType === 'deleteContentForward' ||
    //                 e.inputType === 'deleteByCut') {

    //                 const selection = window.getSelection();
    //                 if (selection.rangeCount > 0) {
    //                     const selectedText = selection.toString().trim();
    //                     if (selectedText) {
    //                         e.preventDefault();
    //                         e.stopPropagation();

    //                         const range = selection.getRangeAt(0);
    //                         const span = document.createElement('span');
    //                         span.className = 'track-change-delete';
    //                         span.style.textDecoration = 'line-through';
    //                         span.style.textDecorationColor = '#dc3545';
    //                         span.style.textDecorationThickness = '2px';
    //                         span.style.background = 'rgba(220, 53, 69, 0.15)';
    //                         span.style.color = '#dc3545';
    //                         span.style.padding = '2px 4px';
    //                         span.style.borderRadius = '3px';
    //                         span.style.cursor = 'pointer';
    //                         span.textContent = selectedText;
    //                         span.title = 'Click to Accept/Reject';

    //                         span.onclick = function (evt) {
    //                             evt.stopPropagation();
    //                             const accept = confirm('Accept deletion?');
    //                             if (accept) {
    //                                 this.remove();
    //                                 saveAsDraft();
    //                             } else {
    //                                 this.replaceWith(document.createTextNode(this.textContent));
    //                                 saveAsDraft();
    //                             }
    //                         };

    //                         range.deleteContents();
    //                         range.insertNode(span);
    //                         selection.removeAllRanges();
    //                     }
    //                 }
    //             }
    //         }, true);

    //         console.log(" Track changes listener ready!");
    //     }

    //     if (document.readyState === 'loading') {
    //         document.addEventListener('DOMContentLoaded', initWorkingTrackChanges);
    //     } else {
    //         initWorkingTrackChanges();
    //     }
    // })();


    // Wait for everything to load, then attach the working listener
    window.addEventListener('load', function () {
        console.log(" Initializing permanent track changes fix...");

        setTimeout(function () {
            const contractContent = document.getElementById('contractContent');

            if (!contractContent) {
                console.error(" Contract content not found!");
                return;
            }

            //  ADD THIS CHECK - Don't attach if AI streaming is in progress
            if (typeof aiStreamingInProgress !== 'undefined' && aiStreamingInProgress) {
                console.log(" AI streaming in progress, delaying track changes setup...");
                // Retry after streaming might be done
                setTimeout(arguments.callee, 2000);
                return;
            }

            console.log(" Contract content found, attaching listener...");

            // Remove existing listeners by cloning
            const newContent = contractContent.cloneNode(true);
            contractContent.parentNode.replaceChild(newContent, contractContent);
            newContent.id = 'contractContent';
            newContent.contentEditable = 'true';

            // Attach the working beforeinput listener
            newContent.addEventListener('beforeinput', function (e) {
                // Only process if track changes is enabled
                if (typeof trackChangesEnabled === 'undefined' || !trackChangesEnabled) {
                    return; // Normal editing
                }

                const inputType = e.inputType;

                // Handle deletions
                if (inputType === 'deleteContentBackward' ||
                    inputType === 'deleteContentForward' ||
                    inputType === 'deleteByCut') {

                    const selection = window.getSelection();

                    if (selection.rangeCount > 0) {
                        const selectedText = selection.toString().trim();

                        if (selectedText) {
                            console.log(" Track changes: preventing deletion of:", selectedText.substring(0, 30));

                            // PREVENT DELETION
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();

                            const range = selection.getRangeAt(0);

                            // Create strikethrough span
                            const span = document.createElement('span');
                            span.className = 'track-change-delete';
                            span.setAttribute('data-change-type', 'delete');
                            span.setAttribute('data-change-author', currentUserName || 'User');
                            span.setAttribute('data-change-date', new Date().toISOString());

                            // INLINE STYLES (critical!)
                            span.style.textDecoration = 'line-through';
                            span.style.textDecorationColor = '#dc3545';
                            span.style.textDecorationThickness = '2px';
                            span.style.background = 'rgba(220, 53, 69, 0.15)';
                            span.style.color = '#dc3545';
                            span.style.padding = '2px 4px';
                            span.style.borderRadius = '3px';
                            span.style.cursor = 'pointer';
                            span.style.display = 'inline';

                            span.textContent = selectedText;
                            span.title = 'Deleted by ' + (currentUserName || 'User') + ' - Click to Accept/Reject';

                            // Add click handler for Accept/Reject
                            span.onclick = function (evt) {
                                evt.stopPropagation();
                                const accept = confirm(
                                    'Deleted by ' + this.getAttribute('data-change-author') + '\n\n' +
                                    '"' + this.textContent.substring(0, 100) + '..."\n\n' +
                                    'Click OK to ACCEPT (remove text)\n' +
                                    'Click Cancel to REJECT (restore text)'
                                );

                                if (accept) {
                                    console.log(" Deletion accepted");
                                    this.remove();
                                    if (typeof saveAsDraft === 'function') saveAsDraft();
                                } else {
                                    console.log(" Deletion rejected - restoring text");
                                    const text = this.textContent;
                                    this.replaceWith(document.createTextNode(text));
                                    if (typeof saveAsDraft === 'function') saveAsDraft();
                                }
                            };

                            // Insert the strikethrough span
                            range.deleteContents();
                            range.insertNode(span);

                            // Clear selection
                            selection.removeAllRanges();

                            console.log(" RED STRIKETHROUGH CREATED!");

                            // Track the change
                            if (typeof trackedChanges !== 'undefined') {
                                trackedChanges.push({
                                    id: 'change_' + Date.now(),
                                    type: 'delete',
                                    text: selectedText,
                                    author: currentUserName || 'User',
                                    date: new Date().toISOString()
                                });
                            }
                        }
                    }
                }
            }, true); // Use capture phase

            console.log(" PERMANENT track changes listener attached!");
            console.log("   Track changes will work after refresh!");

        }, 1000); // Wait 1 second for everything to load
    });


    // =====================================================
    // BULLETPROOF COMMENT BUTTON FIX
    // Add this to SCR_016_contract_editor.html AFTER bubble-comments.js
    // This will FORCE the button to work no matter what
    // =====================================================

    (function () {
        'use strict';

        console.log(' BULLETPROOF COMMENT BUTTON FIX LOADING...');

        let buttonFixed = false;
        let retryCount = 0;
        const MAX_RETRIES = 10;

        // =====================================================
        // MAIN FIX FUNCTION
        // =====================================================
        function forceFixCommentButton() {
            retryCount++;
            console.log(` Attempt ${retryCount}: Fixing comment button...`);

            const addBtn = document.getElementById('addCommentBtn');

            if (!addBtn) {
                console.warn(' Button not found yet, will retry...');
                if (retryCount < MAX_RETRIES) {
                    setTimeout(forceFixCommentButton, 500);
                }
                return;
            }

            console.log(' Found button:', addBtn);

            // METHOD 1: Remove ALL event listeners by replacing element
            const newBtn = addBtn.cloneNode(true);
            addBtn.parentNode.replaceChild(newBtn, addBtn);

            // METHOD 2: Add click handler directly to element
            newBtn.onclick = function (e) {
                console.log(' BUTTON CLICKED (onclick)');
                e.preventDefault();
                e.stopPropagation();
                handleCommentButtonClick(e);
            };

            // METHOD 3: Add addEventListener as backup
            newBtn.addEventListener('click', function (e) {
                console.log(' BUTTON CLICKED (addEventListener)');
                e.preventDefault();
                e.stopPropagation();
                handleCommentButtonClick(e);
            }, true); // Use capture phase

            // METHOD 4: Prevent any future listener removal
            Object.defineProperty(newBtn, 'onclick', {
                set: function (val) {
                    console.log(' Someone tried to change onclick!');
                },
                get: function () {
                    return function (e) {
                        handleCommentButtonClick(e);
                    };
                }
            });

            console.log(' Button fixed with multiple methods!');
            buttonFixed = true;

            // Also fix toggle button
            fixToggleButton();
        }

        // =====================================================
        // FIX TOGGLE PANEL BUTTON
        // =====================================================
        function fixToggleButton() {
            const toggleBtn = document.getElementById('toggleCommentsBtn');

            if (toggleBtn) {
                const newToggle = toggleBtn.cloneNode(true);
                toggleBtn.parentNode.replaceChild(newToggle, toggleBtn);

                newToggle.onclick = function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof toggleCommentsPanel === 'function') {
                        toggleCommentsPanel();
                    }
                };

                console.log(' Toggle button fixed');
            }
        }

        // =====================================================
        // HANDLE BUTTON CLICK
        // =====================================================
        function handleCommentButtonClick(e) {
            console.log(' Processing comment button click...');

            // Check if openAddCommentModal exists
            if (typeof openAddCommentModal === 'function') {
                console.log(' Using openAddCommentModal()');
                openAddCommentModal();
                return;
            }

            // Fallback: Manual implementation
            console.log(' openAddCommentModal not found, using fallback');
            openCommentModalManually();
        }

        // =====================================================
        // FALLBACK: MANUAL MODAL OPENING
        // =====================================================
        function openCommentModalManually() {
            const selection = window.getSelection();

            if (!selection.rangeCount || selection.toString().trim() === '') {
                showNotificationFallback('Please select text to comment on', 'warning');
                return;
            }

            const selectedText = selection.toString().trim();
            console.log(' Selected text:', selectedText);

            // Store selection
            window.commentSelection = {
                text: selectedText,
                range: selection.getRangeAt(0)
            };

            // Show modal
            const modal = document.getElementById('commentModal');
            if (!modal) {
                alert('Comment modal not found! Please refresh the page.');
                return;
            }

            modal.style.display = 'flex';

            // Clear textarea
            const textarea = document.getElementById('commentText');
            if (textarea) {
                textarea.value = '';
                setTimeout(() => textarea.focus(), 100);
            }

            // Update preview
            const preview = document.getElementById('selectedTextPreview');
            if (preview) {
                preview.textContent = selectedText;
            }

            console.log(' Modal opened manually');
        }

        // =====================================================
        // FALLBACK NOTIFICATION
        // =====================================================
        function showNotificationFallback(message, type) {
            // Try to use existing notification function
            if (typeof showNotification === 'function') {
                showNotification(message, type);
                return;
            }

            // Fallback: alert
            alert(message);
        }

        // =====================================================
        // MUTATION OBSERVER - Watch for button changes
        // =====================================================
        function setupMutationObserver() {
            const observer = new MutationObserver(function (mutations) {
                if (!buttonFixed) {
                    console.log(' DOM changed, checking button...');
                    forceFixCommentButton();
                }
            });

            // Watch the entire document for changes
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            console.log(' Mutation observer started');
        }

        // =====================================================
        // INITIALIZATION - Multiple triggers
        // =====================================================

        // Trigger 1: Immediate
        console.log(' Trigger 1: Immediate execution');
        setTimeout(forceFixCommentButton, 100);

        // Trigger 2: DOM Ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                console.log(' Trigger 2: DOMContentLoaded');
                forceFixCommentButton();
            });
        } else {
            console.log(' Trigger 2: DOM already loaded');
            forceFixCommentButton();
        }

        // Trigger 3: Window Load
        window.addEventListener('load', function () {
            console.log(' Trigger 3: Window load');
            forceFixCommentButton();
        });

        // Trigger 4: Delayed (for dynamically loaded content)
        setTimeout(function () {
            console.log(' Trigger 4: Delayed (1 second)');
            forceFixCommentButton();
        }, 1000);

        // Trigger 5: Watch for DOM changes
        if (typeof MutationObserver !== 'undefined') {
            setupMutationObserver();
        }

        // =====================================================
        // EXPOSE FUNCTIONS GLOBALLY
        // =====================================================
        window.forceFixCommentButton = forceFixCommentButton;
        window.handleCommentButtonClick = handleCommentButtonClick;

        console.log(' Bulletproof fix installed!');
        console.log(' Manual fix: forceFixCommentButton()');

    })();

</script>



<script>
    // Update modal based on change type
    function updateChangeType(type) {
        console.log(' Change type:', type);

        const modalTitle = document.getElementById('modalTitle');
        const commentLabel = document.getElementById('commentLabel');
        const selectedLabel = document.getElementById('selectedLabel');
        const newTextGroup = document.getElementById('newTextGroup');
        const changePreview = document.getElementById('changePreview');
        const submitBtnText = document.getElementById('submitBtnText');
        const commentText = document.getElementById('commentText');

        if (type === 'comment') {
            // Regular comment
            modalTitle.innerHTML = '<i class="ti ti-message-plus"></i> Add Comment';
            commentLabel.textContent = 'Your Comment';
            selectedLabel.textContent = 'Selected Text';
            newTextGroup.style.display = 'none';
            changePreview.style.display = 'none';
            submitBtnText.textContent = 'Add Comment';
            commentText.placeholder = 'Enter your comment...';

        } else if (type === 'delete') {
            // Delete text
            modalTitle.innerHTML = '<i class="ti ti-trash"></i> Mark for Deletion';
            commentLabel.textContent = 'Reason for Deletion';
            selectedLabel.textContent = 'Text to Delete';
            newTextGroup.style.display = 'none';
            submitBtnText.textContent = 'Mark as Deleted';
            commentText.placeholder = 'Why is this text being removed?';

            // Show preview
            changePreview.style.display = 'block';
            const selectedText = document.getElementById('selectedTextPreview').textContent;
            document.getElementById('previewContent').innerHTML = `
            <div style="text-decoration: line-through; color: #dc3545; background: rgba(220, 53, 69, 0.1); padding: 8px; border-radius: 4px;">
                ${selectedText}
            </div>
        `;

        } else if (type === 'insert') {
            // Modify/replace text
            modalTitle.innerHTML = '<i class="ti ti-pencil"></i> Modify Text';
            commentLabel.textContent = 'Reason for Change';
            selectedLabel.textContent = 'Original Text';
            newTextGroup.style.display = 'block';
            submitBtnText.textContent = 'Track Change';
            commentText.placeholder = 'Why is this change being made?';

            // Update preview when new text changes
            document.getElementById('newText').addEventListener('input', function () {
                const originalText = document.getElementById('selectedTextPreview').textContent;
                const newText = this.value;

                changePreview.style.display = 'block';
                document.getElementById('previewContent').innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong style="color: #dc3545;">Before:</strong>
                    <div style="text-decoration: line-through; color: #dc3545; background: rgba(220, 53, 69, 0.1); padding: 6px; border-radius: 4px; margin-top: 4px;">
                        ${originalText}
                    </div>
                </div>
                <div>
                    <strong style="color: #28a745;">After:</strong>
                    <div style="color: #28a745; background: rgba(40, 167, 69, 0.1); padding: 6px; border-radius: 4px; margin-top: 4px; border-left: 3px solid #28a745;">
                        ${newText || '(enter new text above)'}
                    </div>
                </div>
            `;
            });
        }
    }

    // Initialize on first load
    document.addEventListener('DOMContentLoaded', () => {
        updateChangeType('comment');
    });

    // Add to bubble-comments.js or in <script> tag

    function manualTrackChange() {
        // Get the comment ID from the highlighted text that's selected
        const selection = window.getSelection();
        if (!selection.rangeCount) {
            alert('Please click on the commented text first');
            return;
        }

        // Find the comment element
        let element = selection.anchorNode;
        if (element.nodeType === 3) element = element.parentElement;

        const commentEl = element.closest('[data-comment-id]');
        if (!commentEl) {
            alert('Please click on highlighted commented text');
            return;
        }

        const commentId = parseInt(commentEl.dataset.commentId);
        const comment = window.bcAllComments.find(c => c.id === commentId);

        if (!comment) {
            alert('Comment not found');
            return;
        }

        // Get current text
        const icon = commentEl.querySelector('.comment-icon');
        let currentText = commentEl.textContent;
        if (icon) currentText = currentText.replace('', '').trim();

        // Get original
        const originalText = comment.original_text || comment.selected_text;

        if (currentText === originalText) {
            alert('No change detected');
            return;
        }

        // Show confirmation
        if (confirm('Track this change?\n\nBEFORE: ' + originalText + '\nAFTER: ' + currentText)) {
            // Update via API
            fetch(`/api/contracts/comments/${commentId}/track-change`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    original_text: originalText,
                    new_text: currentText,
                    change_type: 'insert'
                })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    alert(' Change tracked!');
                    loadComments();
                }
            });
        }
    }


// window.saveAsDraft = function() {
//     console.log(' AUTO-SAVE DISABLED FOR TAMPERING TEST');
//     return Promise.resolve({ success: true });
// };

</script>


{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="/app/static/js/negotiation.js"></script>
<script src="/app/static/js/contract-edit.js?v=1"></script>
<script src="/app/static/js/bubble-comments.js?v=6"></script>
{% endblock %}