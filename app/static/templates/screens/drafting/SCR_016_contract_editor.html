{% extends "base.html" %}

{% block title %}Contract Editor - CALIM360{% endblock %}

{% block head %}
<link rel="stylesheet" href="/app/static/css/contract-edit.css">
<style>
    .modal-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }


    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: white;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    /* Additional styles for workflow integration */
    .workflow-status-bar {
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.05), rgba(115, 180, 224, 0.05));
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .workflow-status-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .workflow-status-label {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .workflow-status-value {
        font-weight: 600;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .workflow-setup-btn {
        padding: 0.5rem 1rem;
        background: white;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .workflow-setup-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    /* Workflow Modal Styles */
    .workflow-option-card {
        padding: 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        margin-bottom: 1rem;
    }

    .workflow-option-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.15);
    }

    .workflow-option-card.selected {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.05), rgba(115, 180, 224, 0.05));
    }

    .workflow-option-card.selected::after {
        content: '\2713';
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    /* Workflow Stepper Styles */
    .workflow-stepper {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .stepper-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .stepper-line {
        position: absolute;
        top: 24px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--border-color);
        z-index: 0;
    }

    .stepper-progress {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background: var(--success-color);
        transition: width 0.3s ease;
        z-index: 1;
    }

    .stepper-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        z-index: 2;
        cursor: pointer;
        flex: 1;
    }

    .step-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 3px solid var(--border-color);
        transition: all 0.3s ease;
        font-size: 1.25rem;
    }

    .stepper-step.completed .step-icon-wrapper {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }

    .stepper-step.active .step-icon-wrapper {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        box-shadow: 0 0 0 8px rgba(39, 98, 203, 0.1);
    }

    .stepper-step.pending .step-icon-wrapper {
        background: white;
        border-color: var(--border-color);
        color: var(--text-muted);
    }

    .step-label {
        font-size: 0.8125rem;
        color: var(--text-muted);
        text-align: center;
        font-weight: 500;
    }

    .stepper-step.completed .step-label,
    .stepper-step.active .step-label {
        color: var(--text-color);
        font-weight: 600;
    }

    .step-date {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* AI Features Styles */
    .ai-toolbar-group {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0 0.5rem;
        /* border-left: 2px solid var(--primary-color); */
    }

    .ai-toolbar-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.875rem;
    }

    .ai-toolbar-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(39, 98, 203, 0.3);
    }

    /* Risk Modal Styles */
    .risk-modal {
        max-width: 1000px;
    }

    .risk-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .risk-stat {
        background: var(--background-light);
        padding: 1.25rem;
        border-radius: 8px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    .risk-stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .risk-stat-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .risk-stat.high {
        border-color: var(--danger-color);
        background: rgba(220, 53, 69, 0.05);
    }

    .risk-stat.high .risk-stat-value {
        color: var(--danger-color);
    }

    .risk-stat.medium {
        border-color: var(--warning-color);
        background: rgba(255, 193, 7, 0.05);
    }

    .risk-stat.medium .risk-stat-value {
        color: var(--warning-color);
    }

    .risk-stat.low {
        border-color: var(--success-color);
        background: rgba(40, 167, 69, 0.05);
    }

    .risk-stat.low .risk-stat-value {
        color: var(--success-color);
    }

    /* Track Changes Styles */
    .track-change-insert {
        background: rgba(40, 167, 69, 0.1);
        border-bottom: 2px solid var(--success-color);
        position: relative;
    }

    .track-change-delete {
        background: rgba(220, 53, 69, 0.1);
        text-decoration: line-through;
        color: var(--danger-color);
    }

    .track-change-comment {
        background: rgba(255, 193, 7, 0.1);
        border-left: 3px solid var(--warning-color);
        padding-left: 0.5rem;
        margin-left: -0.5rem;
    }

    .change-indicator {
        position: absolute;
        right: -30px;
        top: 0;
        width: 25px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: white;
        font-weight: bold;
    }

    .change-indicator.insert {
        background: var(--success-color);
    }

    .change-indicator.delete {
        background: var(--danger-color);
    }

    /* Comment Bubble */
    /* .comment-bubble {
        position: absolute;
        right: -200px;
        background: white;
        border: 1px solid var(--warning-color);
        border-radius: 8px;
        padding: 0.5rem;
        width: 180px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        font-size: 0.8rem;
        z-index: 100;
    } */

    
    .comment-author {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
    }

    .comment-text {
        color: var(--text-color);
    }

    .comment-time {
        color: var(--text-muted);
        font-size: 0.7rem;
        margin-top: 0.25rem;
    }

    /* Simple Signature Styles */
    .signature-btn {
        background: linear-gradient(135deg, var(--success-color), #20c997);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .signature-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .signature-field {
        border: 2px dashed var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
        padding: 1rem;
        border-radius: 8px;
        min-width: 200px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0.5rem 0;
    }

    .signature-field:hover {
        background: rgba(39, 98, 203, 0.1);
    }

    .signature-field.signed {
        border: 2px solid var(--success-color);
        background: rgba(40, 167, 69, 0.05);
        cursor: default;
    }

    .signature-canvas {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: white;
        cursor: crosshair;
        width: 100%;
        height: 200px;
        display: block;
    }

    .signature-preview {
        font-family: 'Brush Script MT', cursive;
        font-size: 2rem;
        text-align: center;
        padding: 1rem;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: white;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loader {
        width: 60px;
        height: 60px;
        border: 6px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    .loading-text {
        color: var(--text-color);
        font-size: 1.1rem;
        font-weight: 500;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Hide editor until loaded */
    #contractEditor {
        display: none;
    }

    #contractEditor.loaded {
        display: block;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }


    /* Upload Area Styles */
    .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    .upload-area.dragover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.1);
    }

    /* File Item Styles - FIXED */
    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .file-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .remove-file-btn {
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
    }

    .remove-file-btn:hover {
        background: var(--danger-bg);
    }
</style>

<style>
    /* =====================================================
   BLOCKCHAIN VERIFICATION STYLES
   File: static/css/blockchain-verification.css
   ===================================================== */

    /* ==========================================
   Blockchain Card Styles
   ========================================== */

    .blockchain-card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .blockchain-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .blockchain-header {
        background: linear-gradient(135deg, #2762cb 0%, #73B4E0 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.25rem 0.25rem 0 0;
    }

    .blockchain-header h5 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .blockchain-body {
        padding: 1.5rem;
    }

    /* ==========================================
   Verification Indicator Styles
   ========================================== */

    #blockchain-indicator,
    [id^="blockchain-indicator"] {
        padding: 1rem;
        border-radius: 0.5rem;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }

    .blockchain-verifying {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #6c757d;
        font-size: 0.95rem;
    }

    .blockchain-verified {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .blockchain-tampered {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .blockchain-error {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    .blockchain-new {
        background: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    /* Alert Styles within Blockchain */
    .blockchain-body .alert {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
    }

    .blockchain-body .alert svg {
        flex-shrink: 0;
    }

    /* ==========================================
   Button Styles
   ========================================== */

    .blockchain-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .blockchain-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: pointer;
    }

    .blockchain-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .blockchain-btn:active {
        transform: translateY(0);
    }

    .blockchain-btn-primary {
        background: #2762cb;
        color: white;
        border-color: #2762cb;
    }

    .blockchain-btn-primary:hover {
        background: #1e4fa0;
        border-color: #1e4fa0;
    }

    .blockchain-btn-outline {
        background: white;
        color: #2762cb;
        border-color: #2762cb;
    }

    .blockchain-btn-outline:hover {
        background: #2762cb;
        color: white;
    }

    .blockchain-btn-secondary {
        background: white;
        color: #6c757d;
        border-color: #6c757d;
    }

    .blockchain-btn-secondary:hover {
        background: #6c757d;
        color: white;
    }

    /* ==========================================
   Info Text Styles
   ========================================== */

    .blockchain-info-text {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .blockchain-info-text small {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6c757d;
        font-size: 0.85rem;
    }

    .blockchain-info-text svg {
        flex-shrink: 0;
        color: #2762cb;
    }

    /* ==========================================
   Spinner Styles
   ========================================== */

    .blockchain-spinner {
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2762cb;
        border-radius: 50%;
        animation: blockchain-spin 1s linear infinite;
    }

    @keyframes blockchain-spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* ==========================================
   Modal Styles
   ========================================== */

    .blockchain-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: blockchain-fade-in 0.3s ease;
    }

    @keyframes blockchain-fade-in {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .blockchain-modal-dialog {
        background: white;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: blockchain-slide-up 0.3s ease;
    }

    @keyframes blockchain-slide-up {
        from {
            transform: translateY(50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .blockchain-modal-header {
        background: linear-gradient(135deg, #2762cb 0%, #73B4E0 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .blockchain-modal-header h5 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .blockchain-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s ease;
    }

    .blockchain-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .blockchain-modal-body {
        padding: 2rem;
    }

    .blockchain-certificate-icon {
        text-align: center;
        margin-bottom: 2rem;
    }

    .blockchain-certificate-icon svg {
        width: 80px;
        height: 80px;
        color: #28a745;
        animation: blockchain-check-in 0.5s ease;
    }

    @keyframes blockchain-check-in {
        0% {
            transform: scale(0);
            opacity: 0;
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .blockchain-certificate-icon h4 {
        margin-top: 1rem;
        color: #333;
        font-weight: 600;
    }

    .blockchain-certificate-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5rem 0;
    }

    .blockchain-certificate-table td {
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
    }

    .blockchain-certificate-table td:first-child {
        background: #f8f9fa;
        font-weight: 600;
        width: 35%;
        color: #495057;
    }

    .blockchain-certificate-table code {
        background: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        color: #e83e8c;
        word-break: break-all;
    }

    .blockchain-certificate-table .badge {
        padding: 0.4rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .blockchain-certificate-table .badge.bg-success {
        background: #28a745 !important;
        color: white;
    }

    .blockchain-modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    /* ==========================================
   Responsive Design
   ========================================== */

    @media (max-width: 768px) {
        .blockchain-buttons {
            flex-direction: column;
        }

        .blockchain-btn {
            width: 100%;
            justify-content: center;
        }

        .blockchain-modal-dialog {
            width: 95%;
            margin: 1rem;
        }

        .blockchain-certificate-table td:first-child {
            width: 40%;
            font-size: 0.9rem;
        }

        .blockchain-certificate-table code {
            font-size: 0.75rem;
        }
    }

    @media (max-width: 576px) {
        .blockchain-header h5 {
            font-size: 1rem;
        }

        .blockchain-body {
            padding: 1rem;
        }

        .blockchain-modal-body {
            padding: 1.5rem;
        }

        .blockchain-certificate-table {
            font-size: 0.9rem;
        }
    }

    /* ==========================================
   Print Styles
   ========================================== */

    @media print {

        .blockchain-buttons,
        .blockchain-modal-footer,
        .blockchain-modal-close {
            display: none !important;
        }

        .blockchain-modal {
            background: white;
            position: relative;
        }

        .blockchain-modal-dialog {
            box-shadow: none;
            max-width: 100%;
        }

        .blockchain-certificate-table {
            page-break-inside: avoid;
        }
    }

    /* ==========================================
   Icon Styles
   ========================================== */

    .blockchain-icon-shield {
        color: #2762cb;
    }

    .blockchain-icon-verified {
        color: #28a745;
    }

    .blockchain-icon-tampered {
        color: #dc3545;
    }

    .blockchain-icon-warning {
        color: #ffc107;
    }

    .blockchain-icon-info {
        color: #17a2b8;
    }

    /* ==========================================
   Animation Effects
   ========================================== */

    .blockchain-pulse {
        animation: blockchain-pulse-animation 2s ease-in-out infinite;
    }

    @keyframes blockchain-pulse-animation {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .blockchain-bounce {
        animation: blockchain-bounce-animation 1s ease infinite;
    }

    @keyframes blockchain-bounce-animation {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    /* ==========================================
   Utility Classes
   ========================================== */

    .blockchain-text-primary {
        color: #2762cb !important;
    }

    .blockchain-text-success {
        color: #28a745 !important;
    }

    .blockchain-text-danger {
        color: #dc3545 !important;
    }

    .blockchain-text-warning {
        color: #ffc107 !important;
    }

    .blockchain-text-info {
        color: #17a2b8 !important;
    }

    .blockchain-bg-light {
        background-color: #f8f9fa !important;
    }

    .blockchain-border-primary {
        border-color: #2762cb !important;
    }

    .blockchain-shadow {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .blockchain-shadow-lg {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
</style>


<style>
    /* AI Loader Animation */
    .ai-loader {
        width: 60px;
        height: 60px;
        border: 4px solid var(--border-color);
        border-top-color: var(--warning-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    .loader-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Risk Stats Grid */
    .risk-stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        padding: 1.5rem;
        background: var(--background-light);
        border-bottom: 1px solid var(--border-color);
    }

    .risk-stat-card {
        background: white;
        padding: 1.25rem;
        border-radius: 12px;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .risk-stat-card.high {
        border-color: var(--danger-color);
        background: rgba(220, 53, 69, 0.05);
    }

    .risk-stat-card.medium {
        border-color: var(--warning-color);
        background: rgba(255, 193, 7, 0.05);
    }

    .risk-stat-card.low {
        border-color: var(--success-color);
        background: rgba(40, 167, 69, 0.05);
    }

    .risk-stat-card.score {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    .risk-stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .risk-stat-card.high .risk-stat-value {
        color: var(--danger-color);
    }

    .risk-stat-card.medium .risk-stat-value {
        color: var(--warning-color);
    }

    .risk-stat-card.low .risk-stat-value {
        color: var(--success-color);
    }

    .risk-stat-card.score .risk-stat-value {
        color: var(--primary-color);
    }

    .risk-stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        font-weight: 600;
    }

    /* Executive Summary */
    .executive-summary {
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(39, 98, 203, 0.05), rgba(39, 98, 203, 0.02));
        border-bottom: 1px solid var(--border-color);
    }

    .executive-summary h4 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        color: var(--primary-color);
    }

    /* Risk Items List */
    .risk-items-container {
        padding: 1.5rem;
    }

    .risk-item {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        margin-bottom: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .risk-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .risk-item.high {
        border-left: 4px solid var(--danger-color);
    }

    .risk-item.medium {
        border-left: 4px solid var(--warning-color);
    }

    .risk-item.low {
        border-left: 4px solid var(--success-color);
    }

    .risk-item-header {
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        background: var(--background-light);
        transition: background 0.2s ease;
    }

    .risk-item-header:hover {
        background: var(--background-hover);
    }

    .risk-item-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
    }

    .risk-item-badges {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .severity-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .severity-badge.high {
        background: var(--danger-color);
        color: white;
    }

    .severity-badge.medium {
        background: var(--warning-color);
        color: #333;
    }

    .severity-badge.low {
        background: var(--success-color);
        color: white;
    }

    .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        background: var(--background-light);
        color: var(--text-muted);
        border: 1px solid var(--border-color);
    }

    .risk-item-content {
        padding: 1.25rem;
        display: none;
        border-top: 1px solid var(--border-color);
    }

    .risk-item.expanded .risk-item-content {
        display: block;
    }

    .risk-detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .risk-detail-item {
        padding: 0.75rem;
        background: var(--background-light);
        border-radius: 8px;
    }

    .risk-detail-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .risk-detail-value {
        font-size: 0.875rem;
        color: var(--text-color);
    }

    .recommendation-box {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
        border: 1px solid var(--success-color);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .recommendation-box h5 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--success-color);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    /* Compliance Status */
    .compliance-section {
        padding: 1.5rem;
        background: var(--background-light);
        border-top: 1px solid var(--border-color);
    }

    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }

    .compliance-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .compliance-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .compliance-icon.pass {
        background: var(--success-color);
        color: white;
    }

    .compliance-icon.fail {
        background: var(--danger-color);
        color: white;
    }

    .compliance-icon.pending {
        background: var(--warning-color);
        color: white;
    }

    /* Score Ring */
    .score-ring {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto;
    }

    .score-ring svg {
        transform: rotate(-90deg);
    }

    .score-ring circle {
        fill: none;
        stroke-width: 8;
    }

    .score-ring .bg {
        stroke: var(--border-color);
    }

    .score-ring .progress {
        stroke: var(--primary-color);
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease;
    }

    .score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .risk-stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .risk-detail-grid {
            grid-template-columns: 1fr;
        }

        .compliance-grid {
            grid-template-columns: 1fr;
        }
    }
</style>



<style>
    /* Blockchain Activity Panel Styles */
    .blockchain-evidence-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .evidence-panel-header {
        background: linear-gradient(135deg, #0066cc 0%, #00b4d8 100%);
        color: white;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .evidence-panel-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
    }

    .evidence-panel-title i {
        font-size: 1.5rem;
    }

    .live-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .live-dot {
        width: 6px;
        height: 6px;
        background: #10b981;
        border-radius: 50%;
        animation: livePulse 2s infinite;
    }

    @keyframes livePulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    .evidence-panel-body {
        padding: 1.5rem;
    }

    /* Network Status Bar */
    .network-status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .status-label {
        color: #64748b;
        font-weight: 500;
    }

    .status-value {
        color: #1e293b;
        font-weight: 700;
    }

    /* Activity Stream */
    .activity-stream {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .activity-stream::-webkit-scrollbar {
        width: 6px;
    }

    .activity-stream::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .activity-stream::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .stream-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: #f8fafc;
        border-left: 3px solid #0066cc;
        border-radius: 8px;
        transition: all 0.3s ease;
        animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .stream-item:hover {
        background: #f1f5f9;
        transform: translateX(4px);
    }

    .stream-item.success {
        border-left-color: #10b981;
    }

    .stream-item.processing {
        border-left-color: #f59e0b;
    }

    .stream-item.error {
        border-left-color: #ef4444;
    }

    .stream-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 1.25rem;
    }

    .stream-item.success .stream-icon {
        background: #d1fae5;
        color: #10b981;
    }

    .stream-item.processing .stream-icon {
        background: #fef3c7;
        color: #f59e0b;
    }

    .stream-item.error .stream-icon {
        background: #fee2e2;
        color: #ef4444;
    }



    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .stream-content {
        flex: 1;
    }

    .stream-title {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }

    .stream-description {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .stream-timestamp {
        font-size: 0.75rem;
        color: #94a3b8;
        font-family: 'Courier New', monospace;
    }

    .stream-metadata {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .metadata-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 0.7rem;
        font-family: 'Courier New', monospace;
    }

    /* Hash Visualization */
    .hash-visual {
        background: #1e293b;
        color: #10b981;
        padding: 0.75rem;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 0.75rem;
        word-break: break-all;
        margin-top: 0.5rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Empty State */
    .empty-activity-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #64748b;
    }

    .empty-activity-state i {
        font-size: 3rem;
        opacity: 0.3;
        margin-bottom: 1rem;
    }


    /* Email Search Suggestions Dropdown */
    .email-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
    }

    .email-suggestions::-webkit-scrollbar {
        width: 6px;
    }

    .email-suggestions::-webkit-scrollbar-track {
        background: var(--background-light);
    }

    .email-suggestions::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>


{% endblock %}

{% block content %}
<!-- Loading Overlay - Show by default -->
<div class="loading-overlay show" id="loadingOverlay">
    <div class="loader"></div>
    <div class="loading-text">Loading Contract...</div>
</div>

<!-- {{ user.company_id }} -->
<!-- Contract Editor - Hidden until data loads -->
<div id="contractEditor"></div>


<!-- UPDATED BLOCKCHAIN SECTION WITH CSS CLASSES -->
<div class="card blockchain-card mb-3">
    <div class="blockchain-header">
        <h5>
            <i data-lucide="shield" class="blockchain-icon-shield"></i>
            Blockchain Verification
        </h5>
    </div>
    <div class="card-body blockchain-body">
        <!-- Verification Status -->
        <div id="blockchain-indicator" class="mb-3" data-contract-id="">
            <div class="blockchain-verifying">
                <div class="blockchain-spinner"></div>
                <span>Verifying document integrity on blockchain...</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="blockchain-buttons">
            <button type="button" class="blockchain-btn blockchain-btn-primary" onclick="showBlockchainCertificate()">
                <i data-lucide="award"></i>
                View Certificate
            </button>
            <button type="button" class="blockchain-btn blockchain-btn-outline" onclick="verifyContractNow()">
                <i data-lucide="refresh-cw"></i>
                Re-verify
            </button>
            <button type="button" class="blockchain-btn blockchain-btn-secondary" onclick="showBlockchainInfo()">
                <i data-lucide="info"></i>
                What is this?
            </button>
        </div>

        <!-- Info Text -->
        <div class="blockchain-info-text">
            <small>
                <i data-lucide="lock"></i>
                This contract is secured on Hyperledger Fabric blockchain for tamper-proof verification.
            </small>
        </div>
    </div>
</div>
<!-- END BLOCKCHAIN VERIFICATION SECTION -->


<!-- Blockchain Evidence Panel HTML -->
<div class="blockchain-evidence-panel" id="blockchainEvidencePanel">
    <div class="evidence-panel-header">
        <div class="evidence-panel-title">
            <i class="ti ti-shield-lock"></i>
            Blockchain Operations Monitor
        </div>
        <div class="live-indicator">
            <span class="live-dot"></span>
            <span>LIVE</span>
        </div>
    </div>

    <div class="evidence-panel-body">
        <!-- Network Status Bar -->
        <div class="network-status-bar" id="networkStatusBar">
            <div class="status-item">
                <i class="ti ti-network" style="color: #0066cc;"></i>
                <span class="status-label">Network:</span>
                <span class="status-value">calim360-network</span>
            </div>
            <div class="status-item">
                <i class="ti ti-circle-check" style="color: #10b981;"></i>
                <span class="status-label">Status:</span>
                <span class="status-value" id="networkStatusValue">Operational</span>
            </div>
            <div class="status-item">
                <i class="ti ti-server" style="color: #0066cc;"></i>
                <span class="status-label">Peers:</span>
                <span class="status-value" id="peersCount">3</span>
            </div>
        </div>

        <!-- Activity Stream -->
        <div class="activity-stream" id="activityStream">
            <div class="empty-activity-state">
                <i class="ti ti-clock-hour-4"></i>
                <p>Waiting for blockchain operations...</p>
                <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                    Save or update the contract to see blockchain activity
                </p>
            </div>
        </div>
    </div>
</div>


<!-- MOD-027/028: Contract Workflow Setup Modal -->
<div class="modal" id="contractWorkflowModal">
    <div class="modal-content modal-lg" style="max-width: 900px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-git-branch" style="font-size: 24px;"></i>
                Workflow Setup for This Contract
            </h3>
            <button class="modal-close" onclick="closeModal('contractWorkflowModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 2rem;">
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Choose how approvals should be handled for this specific contract:
            </p>

            <!-- Option 1: Use Master Workflow -->
            <div class="workflow-option-card" id="masterWorkflowOption" onclick="selectContractWorkflow('master')">
                <div style="display: flex; gap: 1rem;">
                    <div
                        style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        <i class="ti ti-settings-automation" style="font-size: 24px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--text-color);">Use Master Workflow</h4>
                        <p style="margin: 0 0 1rem 0; color: var(--text-muted); font-size: 0.875rem;">
                            Apply the default company workflow configured by your administrator
                        </p>

                        <!-- Master Workflow Preview -->
                        <!-- <div class="workflow-step-preview"
                            style="background: var(--background-light); padding: 1rem; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                                <span
                                    style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">1</span>
                                <span>Legal Review</span>
                                <i class="ti ti-arrow-right" style="color: var(--text-muted);"></i>
                                <span
                                    style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">2</span>
                                <span>Finance Approval</span>
                                <i class="ti ti-arrow-right" style="color: var(--text-muted);"></i>
                                <span
                                    style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">3</span>
                                <span>Executive Sign-off</span>
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>

            <!-- Option 2: Custom Workflow -->
            <div class="workflow-option-card" id="customWorkflowOption" onclick="selectContractWorkflow('custom')">
                <div style="display: flex; gap: 1rem;">
                    <div
                        style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        <i class="ti ti-adjustments-horizontal" style="font-size: 24px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--text-color);">Setup Custom Workflow</h4>
                        <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">
                            Create a bespoke workflow for this specific contract
                        </p>
                    </div>
                </div>
            </div>

            <!-- Custom Workflow Configuration -->
            <div id="customWorkflowConfig"
                style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 1rem;">Configure Workflow Steps</h4>

                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--background-light);">
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">Step</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">Role</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">User</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">Department</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="contractWorkflowSteps">
                        <tr>
                            <td style="padding: 0.75rem;">
                                <span
                                    style="width: 28px; height: 28px; background: var(--primary-color); color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600;">1</span>
                            </td>
                            <td style="padding: 0.75rem;">
                                <select
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                                    <option value="">Select Role</option>
                                    <option value="reviewer">Reviewer</option>
                                    <option value="approver">Approver</option>
                                </select>
                            </td>
                            <td style="padding: 0.75rem;">
                                <input type="text" placeholder="Enter email or name"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                            </td>
                            <td style="padding: 0.75rem;">
                                <select
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                                    <option value="">Select Department</option>
                                    <option value="legal">Legal</option>
                                    <option value="finance">Finance</option>
                                    <option value="operations">Operations</option>
                                </select>
                            </td>
                            <td style="padding: 0.75rem;">
                                <button onclick="removeContractWorkflowStep(this)"
                                    style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <button onclick="addContractWorkflowStep()"
                    style="margin-top: 1rem; width: 100%; padding: 0.75rem; border: 2px dashed var(--border-color); background: transparent; color: var(--primary-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <i class="ti ti-plus"></i>
                    Add Workflow Step
                </button>
            </div>
        </div>
        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-outline-secondary" onclick="closeModal('contractWorkflowModal')">
                Back
            </button>
            <button class="btn btn-primary" onclick="saveContractWorkflow()" id="saveWorkflowBtn" disabled>
                <i class="ti ti-device-floppy"></i>
                Save & Exit
            </button>
        </div>
    </div>
</div>

<!-- MOD-029: Send for Internal Review Modal -->
<div class="modal" id="internalReviewModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Send for Internal Review</h3>
            <button class="modal-close" onclick="closeModal('internalReviewModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 2rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    SEND TO SPECIFIC PERSONNEL:
                </label>
                <input type="text" id="specificPersonnel" placeholder="Enter email addresses (comma separated)"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;">
            </div>

            <div style="text-align: center; margin: 2rem 0; position: relative;">
                <div
                    style="border-top: 1px solid var(--border-color); position: absolute; top: 50%; left: 0; right: 0;">
                </div>
                <span
                    style="background: white; padding: 0 1rem; position: relative; color: var(--text-muted); font-weight: 500; font-size: 1rem;">OR</span>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label
                    style="display: flex; align-items: center; cursor: pointer; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--background-light)'"
                    onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='white'">
                    <input type="radio" name="reviewOption" id="masterWorkflow" value="masterWorkflow"
                        style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <span
                            style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); text-decoration: underline;">
                            USE WORKFLOW
                        </span>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
                            Automatically send to predefined reviewers in sequence
                        </p>
                    </div>


                </label>
            </div>

            <!-- <div style="margin-bottom: 1.5rem;">
                <label
                    style="display: flex; align-items: center; cursor: pointer; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='var(--background-light)'"
                    onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='white'">
                    <input type="radio" name="reviewOption" id="masterWorkflow" value="masterWorkflow"
                        style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <span
                            style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); text-decoration: underline;">
                            USE CUSTOM WORKFLOW
                        </span>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
                            Automatically send to predefined reviewers in sequence
                        </p>
                    </div>


                </label>
            </div> -->

            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <label style="font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Additional
                    Notes (Optional):</label>
                <textarea id="reviewNotes" placeholder="Add any notes for the reviewers..."
                    style="width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.875rem; resize: vertical;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('internalReviewModal')">
                Close
            </button>
            <button class="btn btn-primary" onclick="submitInternalReview()">
                Submit
            </button>
        </div>
    </div>
</div>


<!-- Live Negotiation Chat Modal - COMPLETELY REDESIGNED -->
<div class="modal" id="liveNegotiationModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-video"></i>
                Live Negotiation Session
            </h3>
            <button class="modal-close" onclick="closeModal('liveNegotiationModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div class="negotiation-container">
                <!-- Status Bar -->
                <div class="negotiation-status">
                    <div class="participants">
                        <div class="participant online">
                            <div class="status-dot"></div>
                            <span>You (Counterparty)</span>
                        </div>
                        <div class="participant online">
                            <div class="status-dot"></div>
                            <span>Contract Initiator</span>
                        </div>
                    </div>
                    <div class="session-actions">
                        <button class="session-btn" onclick="downloadMinutes()">
                            <i class="ti ti-download"></i>
                            Download Minutes
                        </button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="messages-area" id="chatMessages">
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="ti ti-handshake"></i>
                        </div>
                        <h4>Negotiation Session Started</h4>
                        <p>You can now discuss contract terms in real-time with the initiator.</p>
                    </div>

                    <div class="message initiator-msg">
                        <div class="message-avatar">
                            <i class="ti ti-user"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="sender">Contract Initiator</span>
                                <span class="timestamp">Just now</span>
                            </div>
                            <div class="message-text">Hello! Ready to discuss the contract terms. I've reviewed your
                                concerns about the termination clause.</div>
                        </div>
                    </div>

                    <div class="message user-msg">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="sender">You</span>
                                <span class="timestamp">Just now</span>
                            </div>
                            <div class="message-text">Hi! Yes, I'd like to discuss making the termination rights more
                                balanced between both parties.</div>
                        </div>
                        <div class="message-avatar">
                            <i class="ti ti-user-check"></i>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="message-input-area">
                    <div class="input-container">
                        <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off"
                            onkeypress="handleInputKeypress(event)">
                        <button id="sendButton" class="send-btn" onclick="handleSendClick()">
                            <i class="ti ti-send"></i>
                        </button>
                    </div>
                    <div class="input-suggestions">
                        <button class="suggestion-btn" onclick="insertSuggestion('I agree with those terms')">I agree
                            with those terms</button>
                        <button class="suggestion-btn"
                            onclick="insertSuggestion('Can we modify the payment schedule?')">Can we modify the payment
                            schedule?</button>
                        <button class="suggestion-btn" onclick="insertSuggestion('What about liability limits?')">What
                            about liability limits?</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('liveNegotiationModal')">
                End Session
            </button>
            <button class="btn btn-success" onclick="finalizeNegotiation()">
                <i class="ti ti-check"></i>
                Finalize Agreement
            </button>
        </div>
    </div>
</div>


<!-- Documents Modal -->
<div class="modal" id="documentsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-paperclip"></i>
                Attach Documents
            </h3>
            <button class="modal-close" onclick="closeModal('documentsModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Existing Documents -->
            <div style="margin-bottom: 2rem;">
                <h5 style="margin-bottom: 1rem;">Previously Attached Documents</h5>

                <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ti ti-file-text" style="color: var(--primary-color);"></i>
                            <span>Technical Specifications.pdf</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline-secondary" onclick="viewDocument('tech-specs')">
                                <i class="ti ti-eye"></i>
                                View
                            </button>
                            <button class="btn btn-outline-secondary" onclick="downloadDocument('tech-specs')">
                                <i class="ti ti-download"></i>
                                Download
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ti ti-file-spreadsheet" style="color: var(--success-color);"></i>
                            <span>Budget Analysis.xlsx</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline-secondary" onclick="viewDocument('budget')">
                                <i class="ti ti-eye"></i>
                                View
                            </button>
                            <button class="btn btn-outline-secondary" onclick="downloadDocument('budget')">
                                <i class="ti ti-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload New Documents -->
            <div>
                <h5 style="margin-bottom: 1rem;">Upload New Documents</h5>

                <div class="upload-area" onclick="triggerFileUpload()" ondrop="handleFileDrop(event)"
                    ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <i class="ti ti-cloud-upload"
                        style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                    <p style="margin: 0 0 0.5rem 0; font-weight: 600;">Drop files here or click to browse</p>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">Supports PDF, DOC, DOCX, XLS,
                        XLSX (Max 10MB each)</p>
                    <input type="file" id="fileUpload" multiple accept=".pdf,.doc,.docx,.xls,.xlsx"
                        style="display: none;" onchange="handleFileSelect(event)">
                </div>

                <div id="uploadedFiles" style="margin-top: 1rem; display: none;">
                    <!-- Uploaded files will appear here -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('documentsModal')">
                Close
            </button>
            <button class="btn btn-primary" onclick="uploadDocuments()" id="uploadBtn" disabled>
                <i class="ti ti-upload"></i>
                Upload Documents
            </button>
        </div>
    </div>
</div>

<!-- Risk Summary Modal -->
<div class="modal" id="riskSummaryModal">
    <div class="modal-content modal-lg">
        <div class="modal-header" style="background: linear-gradient(135deg, var(--warning-color), #ffc107);">
            <h3 class="modal-title" style="color: white;">
                <i class="ti ti-alert-triangle"></i>
                AI Risk Analysis Report
            </h3>
            <button class="modal-close" onclick="closeModal('riskSummaryModal')"
                style="background: rgba(255,255,255,0.2); color: white;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" id="riskSummaryContent">
            <!-- Content injected by JavaScript -->
        </div>
    </div>
</div>

<!-- Version History Modal -->
<div class="modal" id="versionModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">Version History</h3>
            <button class="modal-close" onclick="closeModal('versionModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" id="versionHistoryContent">
            <!-- Will be populated dynamically -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="compareVersions()">Compare Versions</button>
            <button class="btn btn-primary" onclick="closeModal('versionModal')">Close</button>
        </div>
    </div>
</div>

<!-- =====================================================
     IMPROVED EXPORT MODAL
     Replace the existing Export Modal in your HTML
     ===================================================== -->

<!-- Export Modal -->
<div class="modal" id="exportModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem; margin: 0;">
                <i class="ti ti-download" style="font-size: 24px;"></i>
                Export Document
            </h3>
            <button class="modal-close" onclick="closeModal('exportModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;">
                <i class="ti ti-x"></i>
            </button>
        </div>

        <div class="modal-body" style="padding: 2rem;">
            <p style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.95rem;">
                Select the format and options for exporting your contract document.
            </p>

            <!-- Export Format Selection -->
            <div style="margin-bottom: 2rem;">
                <label
                    style="display: block; font-weight: 600; font-size: 0.95rem; color: var(--text-color); margin-bottom: 1rem;">
                    Export Format:
                </label>
                <div style="display: grid; gap: 0.875rem;">
                    <!-- PDF Option -->
                    <label class="export-option-label"
                        style="display: flex; align-items: center; padding: 1rem; background: var(--background-light); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="exportFormat" value="pdf" checked
                            style="margin-right: 1rem; width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color);">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <i class="ti ti-file-type-pdf" style="font-size: 2rem; color: #ef4444;"></i>
                            <div>
                                <div style="font-weight: 600; font-size: 0.95rem;">PDF Document</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Professional, print-ready format
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Word Option -->
                    <label class="export-option-label"
                        style="display: flex; align-items: center; padding: 1rem; background: var(--background-light); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="exportFormat" value="word"
                            style="margin-right: 1rem; width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color);">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <i class="ti ti-file-type-docx" style="font-size: 2rem; color: #2563eb;"></i>
                            <div>
                                <div style="font-weight: 600; font-size: 0.95rem;">Microsoft Word</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Editable document (.docx)
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- HTML Option -->
                    <label class="export-option-label"
                        style="display: flex; align-items: center; padding: 1rem; background: var(--background-light); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="exportFormat" value="html"
                            style="margin-right: 1rem; width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color);">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <i class="ti ti-file-code" style="font-size: 2rem; color: #f59e0b;"></i>
                            <div>
                                <div style="font-weight: 600; font-size: 0.95rem;">HTML Document</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Web-ready format
                                </div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Export Options -->
            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; font-weight: 600; font-size: 0.95rem; color: var(--text-color); margin-bottom: 0.875rem;">
                    Export Options:
                </label>

                <!-- Include Tracked Changes -->
                <label class="checkbox-option-label"
                    style="display: flex; align-items: flex-start; padding: 0.875rem; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem; transition: all 0.3s ease;">
                    <input type="checkbox" id="includeTrackedChanges" checked
                        style="margin-right: 0.875rem; margin-top: 2px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-color); flex-shrink: 0;">
                    <div>
                        <div style="font-weight: 500; font-size: 0.9rem;">Include Tracked Changes</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                            Show all modifications and edits in the exported document
                        </div>
                    </div>
                </label>

                <!-- Include Comments -->
                <label class="checkbox-option-label"
                    style="display: flex; align-items: flex-start; padding: 0.875rem; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                    <input type="checkbox" id="includeComments" checked
                        style="margin-right: 0.875rem; margin-top: 2px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-color); flex-shrink: 0;">
                    <div>
                        <div style="font-weight: 500; font-size: 0.9rem;">Include Comments</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                            Export with all annotations and review comments
                        </div>
                    </div>
                </label>
            </div>

            <!-- Info Box -->
            <div
                style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid var(--primary-color); border-radius: 6px; margin-top: 1.5rem;">
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <i class="ti ti-info-circle"
                        style="color: var(--primary-color); font-size: 1.25rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        The exported document will include the current version of the contract with all selected options
                        applied. Export may take a few seconds.
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end; background: var(--background-light); border-radius: 0 0 12px 12px;">
            <button class="btn btn-outline-secondary" onclick="closeModal('exportModal')"
                style="padding: 0.625rem 1.25rem; border: 1px solid var(--border-color); background: white; color: var(--text-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                <i class="ti ti-x"></i>
                Cancel
            </button>
            <button class="btn btn-primary" onclick="executeExport()"
                style="padding: 0.625rem 1.5rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; font-weight: 600;">
                <i class="ti ti-download"></i>
                Export Document
            </button>
        </div>
    </div>
</div>

<!-- Add these styles to your <style> section -->
<style>
    /* Export Modal Hover Effects */
    .export-option-label:hover {
        background: white !important;
        border-color: var(--primary-color) !important;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }

    .export-option-label:has(input:checked) {
        background: white !important;
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 1px var(--primary-color);
    }

    .checkbox-option-label:hover {
        background: white !important;
        border-color: var(--primary-color) !important;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3) !important;
        transform: rotate(90deg);
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: var(--secondary-color);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-outline-secondary {
        background: white;
        color: var(--text-muted);
        border: 1px solid var(--border-color);
    }

    .btn-outline-secondary:hover {
        background: var(--background-light);
    }

    /* Modern Negotiation Chat Styles - FIXED LAYOUT */
    .negotiation-container {
        height: 600px;
        display: flex;
        flex-direction: column;
        background: #fafafa;
    }

    .negotiation-status {
        background: white;
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }



    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }


    .participants {
        display: flex;
        gap: 2rem;
    }

    .participant {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-color);
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #10b981;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .session-actions {
        display: flex;
        gap: 0.5rem;
    }

    .session-btn {
        padding: 0.5rem 1rem;
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    .session-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: 0;
        /* Important for flex child scrolling */
    }

    .welcome-message {
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .welcome-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 24px;
    }

    .welcome-message h4 {
        margin: 0 0 0.5rem 0;
        color: var(--text-color);
        font-size: 1.125rem;
    }

    .welcome-message p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .message {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        flex-shrink: 0;
    }

    .initiator-msg .message-avatar {
        background: linear-gradient(135deg, #64748b, #94a3b8);
    }

    .user-msg .message-avatar {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }

    .user-msg {
        flex-direction: row-reverse;
    }

    .user-msg .message-content {
        text-align: right;
    }

    .message-content {
        flex: 1;
        background: white;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .user-msg .message-content {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-color: var(--primary-color);
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
        font-size: 0.75rem;
    }

    .user-msg .message-header {
        color: rgba(255, 255, 255, 0.9);
    }

    .sender {
        font-weight: 600;
        color: var(--text-color);
    }

    .user-msg .sender {
        color: white;
    }

    .timestamp {
        color: var(--text-muted);
        font-size: 0.6875rem;
    }

    .user-msg .timestamp {
        color: rgba(255, 255, 255, 0.7);
    }

    .message-text {
        line-height: 1.4;
        color: var(--text-color);
        font-size: 0.875rem;
    }

    .user-msg .message-text {
        color: white;
    }

    .typing-indicator {
        display: flex;
        gap: 0.75rem;
        animation: slideIn 0.3s ease-out;
    }

    .typing-indicator .message-content {
        background: var(--background-light);
        border-style: dashed;
        color: var(--text-muted);
        font-style: italic;
    }

    .typing-dots {
        display: inline-flex;
        gap: 2px;
    }

    .typing-dots span {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: var(--text-muted);
        animation: typing-bounce 1.5s infinite;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: 0.3s;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0.6s;
    }

    @keyframes typing-bounce {

        0%,
        60%,
        100% {
            transform: translateY(0);
        }

        30% {
            transform: translateY(-8px);
        }
    }

    .message-input-area {
        background: white;
        border-top: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        position: sticky;
        bottom: 0;
        z-index: 10;
    }

    .input-container {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    #messageInput {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        outline: none;
        transition: all 0.3s ease;
    }

    #messageInput:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: var(--primary-color);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 16px;
    }

    .send-btn:hover {
        background: var(--secondary-color);
        transform: translateY(-1px);
    }

    .send-btn:disabled {
        background: var(--border-color);
        cursor: not-allowed;
        transform: none;
    }

    .input-suggestions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .suggestion-btn {
        padding: 0.375rem 0.75rem;
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 0.75rem;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .suggestion-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }


    /* Action Button Styles */
    .action-btn {
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        text-decoration: none;
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(39, 98, 203, 0.15);
    }

    .action-btn-title {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .action-btn-desc {
        font-size: 0.75rem;
        opacity: 0.8;
    }
</style>

<!-- MOD-021: Risk Assessment Modal -->
<div class="modal" id="riskAnalysisModal">
    <div class="modal-content modal-xl risk-modal">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--warning-color), #ffc107); color: white;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-alert-triangle"></i>
                AI Risk Analysis Report
                <span id="aiPoweredBadge" class="badge"
                    style="background: rgba(255,255,255,0.2); font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 4px; display: none;">
                    <i class="ti ti-sparkles"></i> AI Powered
                </span>
            </h3>
            <button class="modal-close" onclick="closeModal('riskAnalysisModal')"
                style="background: rgba(255,255,255,0.2); color: white;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 0; max-height: 70vh; overflow-y: auto;" id="riskAnalysisContent">
            <!-- Loading State -->
            <div id="riskLoadingState" class="text-center" style="padding: 3rem;">
                <div class="loader-container">
                    <div class="ai-loader"></div>
                    <div class="loader-text">
                        <h4 style="margin: 1rem 0 0.5rem; color: var(--text-color);">Analyzing Contract with AI</h4>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">We are reviewing your contract
                            for potential risks...</p>
                    </div>
                </div>
            </div>
            <!-- Results will be injected here -->
        </div>
        <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1rem 1.5rem;">
            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                <div id="analysisTimestamp" style="font-size: 0.75rem; color: var(--text-muted);">
                    <!-- Timestamp will be shown here -->
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-outline-secondary" onclick="exportRiskReport()">
                        <i class="ti ti-download"></i> Export PDF
                    </button>
                    <button class="btn btn-outline-primary" onclick="runRiskAnalysis()">
                        <i class="ti ti-refresh"></i> Re-analyze
                    </button>
                    <!-- <button class="btn btn-primary" onclick="applyRiskMitigation()">
                        <i class="ti ti-shield-check"></i> Apply Mitigations
                    </button> -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MOD-022: Clause Suggestion Modal -->
<div class="modal" id="clauseSuggestionModal">
    <div class="modal-content modal-lg">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-sparkles"></i>
                AI Clause Suggestions
            </h3>
            <button class="modal-close" onclick="closeModal('clauseSuggestionModal')"
                style="background: rgba(255,255,255,0.2); color: white;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 2rem;" id="clauseSuggestionContent">
            <div class="text-center" style="padding: 2rem;">
                <div class="loader" style="margin: 0 auto;"></div>
                <p style="margin-top: 1rem; color: var(--text-muted);">Getting AI suggestions...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('clauseSuggestionModal')">
                Cancel
            </button>
            <button class="btn btn-warning" onclick="editClauseManually()">
                <i class="ti ti-edit"></i> Edit Manually
            </button>
            <button class="btn btn-success" onclick="acceptSuggestion()">
                <i class="ti ti-check"></i> Accept Suggestion
            </button>
        </div>
    </div>
</div>

<!-- Simple Signature Modal -->
<div class="modal" id="signatureModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--success-color), #20c997); color: white;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-writing-sign"></i>
                Sign Document
            </h3>
            <button class="modal-close" onclick="closeModal('signatureModal')"
                style="background: rgba(255,255,255,0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 2rem;">
            <div style="background: var(--background-light); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Signing as:</div>
                        <div style="font-weight: 600;" id="signerName">John Doe</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);" id="signerRole">Client
                            Representative</div>
                    </div>
                    <div id="partyIndicator"
                        style="padding: 0.25rem 0.75rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                        Initiator
                    </div>
                </div>
            </div>

            <div
                style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                <button class="signature-tab active" onclick="switchSignMethod('draw')"
                    style="padding: 0.75rem 1rem; background: none; border: none; color: var(--primary-color); cursor: pointer; border-bottom: 3px solid var(--primary-color); font-weight: 600;">
                    <i class="ti ti-pencil"></i> Draw
                </button>
                <button class="signature-tab" onclick="switchSignMethod('type')"
                    style="padding: 0.75rem 1rem; background: none; border: none; color: var(--text-muted); cursor: pointer;">
                    <i class="ti ti-keyboard"></i> Type
                </button>
            </div>

            <div id="drawSignature">
                <canvas class="signature-canvas" id="signCanvas"></canvas>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearCanvas()">
                        <i class="ti ti-eraser"></i> Clear
                    </button>
                </div>
            </div>

            <div id="typeSignature" style="display: none;">
                <input type="text" id="typedSig" placeholder="Type your name"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-bottom: 1rem;"
                    oninput="updateSignaturePreview()">
                <div class="signature-preview" id="sigPreview"></div>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--info-bg); border-radius: 8px;">
                <label style="display: flex; align-items: start; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="agreeTerms" style="margin-top: 0.25rem;" onchange="toggleSignButton()">
                    <span style="font-size: 0.875rem;">I agree to sign this document electronically</span>
                </label>
            </div>
        </div>
        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-outline-secondary" onclick="closeModal('signatureModal')">Cancel</button>
            <button class="btn btn-success" id="signBtn" onclick="applySignature()" disabled>
                <i class="ti ti-check"></i> Sign Document
            </button>
        </div>
    </div>
</div>

<!-- Find & Replace Modal -->
<div class="modal" id="findReplaceModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title">Find & Replace</h3>
            <button class="modal-close" onclick="closeModal('findReplaceModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Find:</label>
                <input type="text" id="findText"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Replace with:</label>
                <input type="text" id="replaceText"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
            <div>
                <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="caseSensitive" style="margin-right: 0.5rem;">
                    Case sensitive
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="findNext()">Find Next</button>
            <button class="btn btn-warning" onclick="replaceOne()">Replace</button>
            <button class="btn btn-primary" onclick="replaceAll()">Replace All</button>
        </div>
    </div>
</div>

<!-- Add Comment Modal -->
<div class="modal" id="commentModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Add Comment</h3>
            <button class="modal-close" onclick="closeModal('commentModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <textarea id="commentText" placeholder="Enter your comment..."
                style="width: 100%; min-height: 100px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; resize: vertical;"></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('commentModal')">Cancel</button>
            <button class="btn btn-primary" onclick="insertComment()">Add Comment</button>
        </div>
    </div>
</div>


<!-- MOD-030: Send to Counter-Party Modal -->
<div class="modal" id="sendToCounterPartyModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-send" style="font-size: 24px;"></i>
                Send to Counter-Party
            </h3>
            <button class="modal-close" onclick="closeModal('sendToCounterPartyModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 2rem;">
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Select the counter-party who will receive this contract for review and negotiation.
            </p>

            <div style="margin-bottom: 1.5rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    Counter-Party Email: <span style="color: var(--danger-color);">*</span>
                </label>
                <div style="position: relative;">
                    <input type="email" id="counterPartyEmail" placeholder="Search or enter counter-party email address"
                        style="width: 100%; padding: 0.75rem; padding-right: 2.5rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;"
                        autocomplete="off" oninput="searchCounterPartyUsers(this.value)"
                        onfocus="searchCounterPartyUsers(this.value)" required>
                    <i class="ti ti-search"
                        style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;"></i>

                    <!-- Email Suggestions Dropdown -->
                    <div id="counterPartyEmailSuggestions"
                        style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
                <small style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    The counter-party will receive an email notification with access to review and negotiate this
                    contract.
                </small>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label
                    style="font-weight: 600; font-size: 0.95rem; color: var(--text-color); display: block; margin-bottom: 0.75rem;">
                    Additional Message (Optional):
                </label>
                <textarea id="counterPartyMessage" placeholder="Add any notes or instructions for the counter-party..."
                    style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; resize: vertical;"></textarea>
            </div>

            <!-- Info Alert -->
            <div
                style="padding: 1rem; background: var(--info-bg); border-radius: 8px; display: flex; align-items: start; gap: 0.75rem; margin-top: 1.5rem;">
                <i class="ti ti-info-circle" style="color: var(--info-color); font-size: 20px; margin-top: 2px;"></i>
                <div>
                    <strong style="color: var(--info-color);">Note:</strong>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--info-color);">
                        Once sent, the contract status will change to "Negotiation" and the counter-party will be able
                        to review, comment, and negotiate terms.
                    </p>
                </div>
            </div>
        </div>
        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-outline-secondary" onclick="closeModal('sendToCounterPartyModal')">
                Cancel
            </button>
            <button class="btn btn-primary" onclick="submitSendToCounterParty()">
                <i class="ti ti-send"></i>
                Send to Counter-Party
            </button>
        </div>
    </div>
</div>


<!-- Negotiation Options Modal -->
<div class="modal" id="negotiationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ti ti-message-circle"></i>
                Negotiation Options
            </h3>
            <button class="modal-close" onclick="closeModal('negotiationModal')">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 2rem; color: var(--text-muted);">
                Choose how you would like to proceed with this contract:
            </p>

            <div style="display: grid; gap: 1.5rem;">
                <button class="action-btn" onclick="generateRiskSummary()" style="text-align: left; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--warning-color), #ffc107); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="ti ti-alert-triangle" style="font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="action-btn-title" style="font-size: 1rem;">Generate Risk Summary</div>
                            <div class="action-btn-desc">AI-powered analysis of contract risks and recommendations</div>
                        </div>
                    </div>
                </button>

                <div style="text-align: center; margin: 1rem 0; position: relative;">
                    <div
                        style="border-top: 1px solid var(--border-color); position: absolute; top: 50%; left: 0; right: 0;">
                    </div>
                    <span
                        style="background: white; padding: 0 1rem; position: relative; color: var(--text-muted); font-weight: 500;">OR</span>
                </div>

                <button class="action-btn" onclick="initiateLiveNegotiation()"
                    style="text-align: left; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: left; color: white;">
                            <i class="ti ti-video" style="font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="action-btn-title" style="font-size: 1rem;">Initiate Live Negotiation</div>
                            <div class="action-btn-desc">Real-time discussion with the initiator</div>
                        </div>
                    </div>
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="closeModal('negotiationModal')">
                Close
            </button>
        </div>
    </div>
</div>



<!-- Execute Contract Confirmation Modal -->
<div class="modal" id="executeContractModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--success-color), #20c997); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-rocket" style="font-size: 24px;"></i>
                Execute Contract
            </h3>
            <button class="modal-close" onclick="closeModal('executeContractModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="ti ti-x"></i>
            </button>
        </div>

        <div class="modal-body" style="padding: 2rem;">
            <!-- Execution Checklist -->
            <div
                style="background: var(--info-bg); padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--info-color);">
                <h4
                    style="margin: 0 0 1rem 0; color: var(--info-color); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-checklist"></i>
                    Pre-Execution Checklist
                </h4>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <i class="ti ti-check" style="color: var(--success-color); font-size: 1.25rem;"></i>
                        <span>Both parties have signed the contract</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <i class="ti ti-check" style="color: var(--success-color); font-size: 1.25rem;"></i>
                        <span>All approvals have been completed</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <i class="ti ti-check" style="color: var(--success-color); font-size: 1.25rem;"></i>
                        <span>Contract content has been finalized</span>
                    </label>
                </div>
            </div>

            <!-- Execution Details -->
            <div
                style="background: var(--background-light); padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h5 style="margin: 0 0 1rem 0; color: var(--text-color);">Execution Details</h5>
                <div style="display: grid; gap: 0.75rem; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Execution Date:</span>
                        <strong id="executionDate">${new Date().toLocaleDateString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Effective Date:</span>
                        <strong id="effectiveDate">${new Date().toLocaleDateString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Contract Status:</span>
                        <strong style="color: var(--success-color);">Fully Executed</strong>
                    </div>
                </div>
            </div>

            <!-- What Happens Next -->
            <div
                style="padding: 1.25rem; background: rgba(40, 167, 69, 0.05); border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.2);">
                <h5
                    style="margin: 0 0 1rem 0; color: var(--success-color); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ti ti-info-circle"></i>
                    What Happens After Execution?
                </h5>
                <ul
                    style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem; line-height: 1.8;">
                    <li>Contract status will change to <strong>"Executed"</strong></li>
                    <li>Certificate of Completion will be generated</li>
                    <li>All parties will receive execution notifications</li>
                    <li>Contract will become active and enforceable</li>
                    <li>Obligation tracking will begin automatically</li>
                </ul>
            </div>

            <!-- Confirmation Checkbox -->
            <div
                style="margin-top: 1.5rem; padding: 1rem; background: white; border: 2px solid var(--border-color); border-radius: 8px;">
                <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer;">
                    <input type="checkbox" id="confirmExecution"
                        style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer; accent-color: var(--success-color);"
                        onchange="toggleExecuteButton()">
                    <span style="font-size: 0.9rem;">
                        I confirm that all parties have signed and all requirements are met. I authorize the execution
                        of this contract.
                    </span>
                </label>
            </div>
        </div>

        <div class="modal-footer"
            style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-outline-secondary" onclick="closeModal('executeContractModal')">
                <i class="ti ti-x"></i>
                Cancel
            </button>
            <button class="btn btn-success" id="executeContractBtn" onclick="executeContract()" disabled
                style="background: linear-gradient(135deg, var(--success-color), #20c997); padding: 0.625rem 1.5rem;">
                <i class="ti ti-rocket"></i>
                Execute Contract
            </button>
        </div>
    </div>
</div>

<!-- Certificate of Completion Modal -->
<div class="modal" id="certificateModal">
    <div class="modal-content modal-lg" style="max-width: 900px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, var(--success-color), #20c997); color: white;">
            <h3 class="modal-title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="ti ti-certificate"></i>
                Certificate of Completion
            </h3>
            <button class="modal-close" onclick="closeModal('certificateModal')"
                style="background: rgba(255, 255, 255, 0.2); color: white;">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body" id="certificateContent" style="padding: 2rem;">
            <!-- Certificate will be dynamically loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline-secondary" onclick="downloadCertificate()">
                <i class="ti ti-download"></i>
                Download Certificate
            </button>
            <button class="btn btn-primary" onclick="closeModal('certificateModal')">
                Close
            </button>
        </div>
    </div>
</div>


<script>
    // =====================================================
    // GLOBAL VARIABLES
    // =====================================================
    let contractId = window.location.pathname.split('/').pop();
    let contractData = null;
    let selectedContractWorkflow = null;
    let contractWorkflowStepCount = 1;
    let canvas, ctx, isDrawing = false;
    let currentSignatureField = null;
    let trackChangesEnabled = false;
    let originalContent = '';
    let trackedChanges = [];
    let autoSaveInterval = null;
    let currentClauseText = '';
    let riskAnalysisData = null;
    let uploadedFiles = [];

    // =====================================================
    // PAGE INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('Loading contract ID:', contractId);
        await loadContractData();
    });

    // =====================================================
    // DATA LOADING FUNCTIONS
    // =====================================================
    async function loadContractData() {
        try {
            const response = await fetch(`/api/contracts/edit/${contractId}`);
            const data = await response.json();

            console.log('Contract data received:', data);

            if (data.success) {
                contractData = data;
                renderContractEditor(data);

                // Show editor, hide loader
                document.getElementById('contractEditor').classList.add('loaded');
                document.getElementById('contractEditor').style.display = 'block';
                hideLoader();

                // Start auto-save
                startAutoSave();
            } else {
                hideLoader();
                showError('Failed to load contract data: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading contract:', error);
            hideLoader();
            showError('Failed to load contract data: ' + error.message);
        }
    }



    // =====================================================
    // RENDERING FUNCTIONS
    // =====================================================
    function renderContractEditor(data) {
        const { contract, workflow, versions } = data;

        console.log('Rendering contract:', contract);
        console.log('Contract content length:', contract.content ? contract.content.length : 0);
        console.log('Contract status:', contract.status);

        const signature_block = `
        <div style="margin-top: 3rem;">
            <p><strong>IN WITNESS WHEREOF</strong>, the parties have executed this Agreement.</p>
            <div style="display: flex; justify-content: space-between; margin-top: 3rem;">
                <div style="flex: 1; margin-right: 2rem;">
                    <div class="signature-field" id="clientSignature" onclick="openSignature('client')">
                        <div>
                            <i class="ti ti-writing-sign" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                            <span>Click to Sign (Client)</span>
                        </div>
                    </div>
                    <p style="margin-top: 1rem;"><strong>CLIENT</strong></p>
                    <p>Name: <span class="editable-field" contenteditable="true">[Name]</span></p>
                    <p>Title: <span class="editable-field" contenteditable="true">[Title]</span></p>
                </div>
                <div style="flex: 1;">
                    <div class="signature-field" id="companySignature" onclick="openSignature('company')">
                        <div>
                            <i class="ti ti-writing-sign" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                            <span>Click to Sign (Company)</span>
                        </div>
                    </div>
                    <p style="margin-top: 1rem;"><strong>COMPANY</strong></p>
                    <p>Name: <span class="editable-field" contenteditable="true">[Name]</span></p>
                    <p>Title: <span class="editable-field" contenteditable="true">[Title]</span></p>
                </div>
            </div>
        </div>`;

        // Determine the action buttons based on contract status
        let actionButtons = '';

        if (contract.status === 'draft') {
            // Draft stage
            actionButtons = `
            <button class="btn signature-btn" onclick="saveAsDraft()">
                <i class="ti ti-device-floppy"></i> Save Draft
            </button>
            <button class="btn btn-primary" onclick="submitForReview()">
                <i class="ti ti-send"></i> Submit for Internal Review
            </button>`;
        } else if ((contract.status === 'review')) {
            // Review stage

            if ((contract.is_initiator === true)) {
                actionButtons = `
            <button class="btn signature-btn" onclick="saveAsDraft()">
                <i class="ti ti-device-floppy"></i> Save Draft
            </button>
            <button class="btn btn-primary" onclick="openSendToCounterPartyModal()">
                <i class="ti ti-send"></i> Send to Counter-Party
            </button>`;

            } else {
                actionButtons = `
            <button class="btn signature-btn" onclick="#">
                <i class="ti ti-check"></i> Approve
            </button>
            <button class="btn btn-danger" onclick="#">
                <i class="ti ti-send"></i> Reject
            </button>`;
            }
        } else if (contract.status === 'counterparty_internal_review') {

            if (contract.is_counterparty === true) {
                actionButtons = `
        <button class="btn btn-success" onclick="markCounterpartyReviewComplete()">
            <i class="ti ti-check"></i> Mark Review Complete
        </button>
    `;
            }


        } else if (contract.status === 'negotiation') {
            // Negotiation stage
            actionButtons = `
            <button class="btn btn-success" onclick="quickApprove()">
                <i class="ti ti-check-circle"></i> Quick Approve
            </button>
            <button class="btn btn-primary" onclick="openNegotiationModal()">
                <i class="ti ti-message-circle"></i> Initiate Negotiation
            </button>
            <button class="btn btn-outline-secondary" onclick="openDocumentsModal()">
                <i class="ti ti-paperclip"></i> Attach Documents
            </button>`;
        } else if (contract.status === 'approved') {
            // Approved stage
            actionButtons = `
            <button class="btn btn-primary" onclick="sendForSignature()">
                <i class="ti ti-writing-sign"></i> Initiate Approval Workflow
            </button>`;
        } else if (contract.status === 'signature') {
            // Signature stage
            actionButtons = `
            <button class="btn btn-success" onclick="openSignatureModal()">
                <i class="ti ti-writing-sign"></i> Sign Contract
            </button>`;
        } else if (contract.status === 'signed') {
            //  SIGNED STAGE - READY FOR EXECUTION
            actionButtons = `
            <button class="btn btn-success" onclick="openExecuteContractModal()" style="background: linear-gradient(135deg, var(--success-color), #20c997);">
                <i class="ti ti-rocket"></i> Execute Contract
            </button>
            <button class="btn btn-outline-secondary" onclick="exportDocument()">
                <i class="ti ti-download"></i> Download
            </button>`;
        } else if (contract.status === 'executed') {
            // Executed stage - Show certificate and download
            actionButtons = `
            <button class="btn btn-success" onclick="viewExecutionCertificate()">
                <i class="ti ti-certificate"></i> View Certificate
            </button>
            <button class="btn btn-outline-secondary" onclick="exportDocument()">
                <i class="ti ti-download"></i> Download Contract
            </button>`;
        }

        // Add View as Counter Party button for non-negotiation stages


        document.getElementById('contractEditor').innerHTML = `
        <!-- Page Header -->
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: white; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem;">
            <div class="page-header-left">
                <h1 class="page-title" style="font-size: 1.5rem; font-weight: 600; color: var(--text-color); margin: 0;">Contract Editor</h1>
                <p class="page-description" style="color: var(--text-muted); font-size: 0.9rem; margin: 0.25rem 0 0 0;">${contract.title || 'Untitled'} - ${contract.contract_number || 'No Number'}</p>
                <input type="hidden" name="contract_number" value="${contract.contract_number || 'No Number'}"> 
            </div>
            <div class="page-header-right" style="display: flex; gap: 1rem;">
${actionButtons}
            </div>
        </div>
        <!-- Workflow Stepper -->
${renderWorkflowStepper(contract.status)}
        <!-- Workflow Status Bar -->
        <div class="workflow-status-bar">
            <div class="workflow-status-info">
                <span class="workflow-status-label">Workflow Status:</span>
                <span class="workflow-status-value">
                    <i class="ti ti-git-branch"></i>
                    <span id="workflowStatusText">${workflow ? workflow.status : 'Not Configured'}</span>
                </span>
            </div>
             <div class="ai-toolbar-group">
                 <button class="workflow-setup-btn" onclick="openWorkflowSetupModal()">
                    <i class="ti ti-settings-automation"></i> Setup Custom Workflow
                </button>
                ${!contract.is_counterparty ? `
                <button class="ai-toolbar-btn" onclick="openRiskAnalysisModal()">
                    <i class="ti ti-alert-triangle"></i> Risk Analysis
                </button>
                <button class="ai-toolbar-btn" onclick="openClauseAnalysisModal()">
                    <i class="ti ti-file-text"></i> Clause Analysis
                </button>
                ` : `<button class="ai-toolbar-btn" onclick="openClauseAnalysisModal()">
                    <i class="ti ti-file-text"></i> Risk Summary
                </button>`}
            </div>
        </div>
        <div class="editor-container">
            <div class="editor-main">
                <!-- Editor Toolbar -->
${renderEditorToolbar()}
                <!-- Document Info Bar -->
${renderDocumentInfo(contract, versions)}
                <!-- Editor Content Area -->
                <div class="editor-content">
                    <div class="editor-paper" contenteditable="true" id="contractContent">
${contract.content && contract.content.trim() !== '' ?
                (contract.content.includes('signature-field') ? contract.content : contract.content + signature_block)
                : getDefaultContractContent()}
                    </div>
                </div>
            </div>
        </div>
    `;

    }

    function renderWorkflowStepper(status) {
        const steps = [
            {
                key: 'draft', icon: 'file-text', label: 'Draft',
                status: 'completed'
            },

            {
                key: 'review', icon: 'users', label: 'Internal Review',
                status: status === 'draft' ? 'pending' : status === 'review' ? 'active' : 'completed'
            },

            //  NEW STEP ADDED HERE
            {
                key: 'counterparty_internal_review', icon: 'building', label: 'Counterparty Review',
                status: ['draft', 'review'].includes(status) ? 'pending' :
                    status === 'counterparty_internal_review' ? 'active' : 'completed'
            },

            {
                key: 'negotiation', icon: 'message-circle', label: 'Negotiation',
                status: ['draft', 'review', 'counterparty_internal_review'].includes(status) ? 'pending' :
                    status === 'negotiation' ? 'active' : 'completed'
            },

            {
                key: 'approval', icon: 'circle-check', label: 'Approval',
                status: ['draft', 'review', 'counterparty_internal_review', 'negotiation'].includes(status) ? 'pending' :
                    status === 'approved' ? 'active' : 'completed'
            },

            {
                key: 'signature', icon: 'writing-sign', label: 'Signature',
                status: ['draft', 'review', 'counterparty_internal_review', 'negotiation', 'approved'].includes(status) ? 'pending' :
                    status === 'signed' ? 'active' : 'completed'
            },

            {
                key: 'executed', icon: 'file-check', label: 'Executed',
                status: status === 'executed' ? 'completed' : 'pending'
            }
        ];


        return `
        <div class="workflow-stepper">
            <div class="stepper-container">
                <div class="stepper-line">
                    <div class="stepper-progress" id="stepperProgress" style="width: ${getProgressWidth(status)}%;"></div>
                </div>
                ${steps.map(step => `
                    <div class="stepper-step ${step.status}" onclick="navigateToStep('${step.key}')">
                        <div class="step-icon-wrapper">
                            <i class="ti ti-${step.icon}"></i>
                        </div>
                        <span class="step-label">${step.label}</span>
                        <span class="step-date">${step.status === 'completed' ? 'Completed' :
                step.status === 'active' ? 'In Progress' :
                    'Pending'
            }</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    }



    function renderEditorToolbar() {
        return `
        <div class="editor-toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="execCmd('bold')" title="Bold">
                    <i class="ti ti-bold"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('italic')" title="Italic">
                    <i class="ti ti-italic"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('underline')" title="Underline">
                    <i class="ti ti-underline"></i>
                </button>
            </div>
            
            <div class="toolbar-group">
                <select class="toolbar-dropdown" onchange="execCmd('fontName', this.value)">
                    <option>Times New Roman</option>
                    <option>Arial</option>
                    <option>Calibri</option>
                </select>
                <select class="toolbar-dropdown" onchange="execCmd('fontSize', this.value)">
                    <option value="3">12pt</option>
                    <option value="4">14pt</option>
                    <option value="5">16pt</option>
                </select>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="execCmd('justifyLeft')" title="Align Left">
                    <i class="ti ti-align-left"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('justifyCenter')" title="Center">
                    <i class="ti ti-align-center"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('justifyRight')" title="Align Right">
                    <i class="ti ti-align-right"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('justifyFull')" title="Justify">
                    <i class="ti ti-align-justified"></i>
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="execCmd('insertOrderedList')" title="Numbered List">
                    <i class="ti ti-list-numbers"></i>
                </button>
                <button class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="Bullet List">
                    <i class="ti ti-list"></i>
                </button>
                <button class="toolbar-btn" onclick="insertTable()" title="Insert Table">
                    <i class="ti ti-table"></i>
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn ${trackChangesEnabled ? 'active' : ''}" onclick="toggleTrackChanges()" title="Track Changes" id="trackChangesBtn">
                    <i class="ti ti-git-compare"></i>
                </button>
                <button class="toolbar-btn" onclick="addComment()" title="Add Comment">
                    <i class="ti ti-message-plus"></i>
                </button>
                <button class="toolbar-btn" onclick="findReplace()" title="Find & Replace">
                    <i class="ti ti-search"></i>
                </button>
            </div>
            
           
        </div>
    `;
    }

    function renderDocumentInfo(contract, versions) {
        const latestVersion = versions && versions.length > 0 ? versions[0] : null;

        return `
        <div class="document-info">
            <div class="document-title">
                <span class="document-name">${contract.title || 'Untitled'} - Version ${latestVersion ? latestVersion.version : contract.current_version || '1'}</span>
                <span class="document-status saved" id="saveStatus">
                    <i class="ti ti-circle-check"></i> Loaded
                </span>
            </div>
            <div class="document-actions">
                <button class="btn btn-sm btn-outline-secondary" onclick="showVersionHistory()">
                    <i class="ti ti-history"></i> Version History
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportDocument()">
                    <i class="ti ti-download"></i> Export
                </button>
            </div>
        </div>
    `;
    }

    // =====================================================
    // HELPER FUNCTIONS
    // =====================================================
    function getProgressWidth(status) {
        const progress = {
            'draft': 0,
            'internal_review': 16.67,
            'counterparty_internal_review': 33.33,  //  ADD THIS LINE
            'negotiation': 50,
            'approved': 66.67,
            'signed': 83.33,
            'active': 83.33,
            'executed': 100
        };
        return progress[status] || 0;
    }

    function getDefaultContractContent() {
        return `
        <div class="contract-content">
            <h1 style="text-align: center;">SERVICE AGREEMENT</h1>
            
            <p>This Service Agreement ("Agreement") is entered into as of <span class="editable-field" contenteditable="true">[DATE]</span> between:</p>
            
            <div class="contract-clause" style="margin: 1.5rem 0;">
                <p><strong>CLIENT:</strong> <span class="editable-field" contenteditable="true">Qatar Energy Company</span>, a company organized and existing under the laws of Qatar</p>
            </div>
            
            <div class="contract-clause" style="margin: 1.5rem 0;">
                <p><strong>SERVICE PROVIDER:</strong> <span class="editable-field" contenteditable="true">[PROVIDER NAME]</span></p>
            </div>
            
            <h2>1. SCOPE OF SERVICES</h2>
            <div class="contract-clause" style="margin: 1rem 0;">
                <p><span class="clause-number">1.1</span> The Service Provider agrees to provide the following services ("Services"):</p>
                <p class="editable-field" contenteditable="true" style="margin-left: 2rem; font-style: italic;">[Describe the specific services to be provided]</p>
            </div>
            
            <h2>2. PAYMENT TERMS</h2>
            <div class="contract-clause" style="margin: 1rem 0;">
                <p><span class="clause-number">2.1</span> In consideration for the Services, the Client agrees to pay the Service Provider a total fee of <span class="editable-field" contenteditable="true">[AMOUNT]</span></p>
            </div>
            
            <h2>3. CONFIDENTIALITY</h2>
            <div class="contract-clause" style="margin: 1rem 0;">
                <p><span class="clause-number">3.1</span> Both parties acknowledge that they may have access to confidential information. Each party agrees to maintain the confidentiality of all confidential information received from the other party.</p>
            </div>
            
            <h2>4. TERM AND TERMINATION</h2>
            <div class="contract-clause" style="margin: 1rem 0;">
                <p><span class="clause-number">4.1</span> This Agreement shall commence on <span class="editable-field" contenteditable="true">[START DATE]</span> and continue until <span class="editable-field" contenteditable="true">[END DATE]</span></p>
                <p><span class="clause-number">4.2</span> Either party may terminate this Agreement upon thirty (30) days written notice.</p>
            </div>
            
            <div style="margin-top: 3rem;">
                <p><strong>IN WITNESS WHEREOF</strong>, the parties have executed this Agreement.</p>
                
                <div style="display: flex; justify-content: space-between; margin-top: 3rem;">
                    <div style="flex: 1; margin-right: 2rem;">
                        <div class="signature-field" id="clientSignature" onclick="openSignature('client')">
                            <div>
                                <i class="ti ti-writing-sign" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                                <span>Click to Sign (Client)</span>
                            </div>
                        </div>
                        <p style="margin-top: 1rem;"><strong>CLIENT</strong></p>
                        <p>Name: <span class="editable-field" contenteditable="true">[Name]</span></p>
                        <p>Title: <span class="editable-field" contenteditable="true">[Title]</span></p>
                    </div>
                    <div style="flex: 1;">
                        <div class="signature-field" id="providerSignature" onclick="openSignature('provider')">
                            <div>
                                <i class="ti ti-writing-sign" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                                <span>Click to Sign (Service Provider)</span>
                            </div>
                        </div>
                        <p style="margin-top: 1rem;"><strong>SERVICE PROVIDER</strong></p>
                        <p>Name: <span class="editable-field" contenteditable="true">[Name]</span></p>
                        <p>Title: <span class="editable-field" contenteditable="true">[Title]</span></p>
                    </div>
                </div>
            </div>
        </div>
    `;
    }

    // =====================================================
    // CONNECTED API FUNCTIONS - ALL BACKEND INTEGRATION
    // =====================================================

    // Save Draft
    async function saveAsDraft() {
        try {
            console.log(' Saving draft...');

            //  FIX: Get content directly from the editor element
            const editor = document.getElementById('contractContent');

            if (!editor) {
                console.error(' Contract editor not found!');
                showNotification('Contract editor not found', 'error');
                return;
            }

            // Get the content (innerHTML for contenteditable div, or value for textarea)
            const contractContent = editor.innerHTML || editor.value || '';

            if (!contractContent || contractContent.trim() === '') {
                console.warn(' Contract content is empty!');
                showNotification('Cannot save empty contract', 'warning');
                return;
            }

            console.log(' Content length:', contractContent.length, 'characters');

            // Prepare data to save
            const data = {
                content: contractContent
            };

            // Save draft
            const response = await fetch(`/api/contracts/save-draft/${contractId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            console.log(' Save response:', result);

            if (result.success) {
                // Display blockchain activities if available
                if (result.blockchain_activities && result.blockchain_activities.length > 0) {
                    console.log(' Blockchain activities received:', result.blockchain_activities.length);
                    if (typeof displayBlockchainActivities === 'function') {
                        displayBlockchainActivities(result.blockchain_activities);
                    }
                }

                showNotification('Draft saved successfully', 'success');
            } else {
                throw new Error(result.message || 'Save failed');
            }

        } catch (error) {
            console.error(' Error saving draft:', error);
            showNotification('Error saving draft: ' + error.message, 'error');
        }
    }


    // Submit for Review - CONNECTED TO BACKEND
    async function submitForReview() {
        openModal('internalReviewModal');
    }

    async function submitInternalReview() {
        const reviewType = document.querySelector('input[name="reviewOption"]:checked')?.value || 'specific';
        const personnelEmails = document.getElementById('specificPersonnel')?.value.split(',').map(e => e.trim()).filter(Boolean) || [];
        const notes = document.getElementById('reviewNotes')?.value || '';

        showLoader();
        try {
            const response = await fetch('/api/contracts/submit-review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId,
                    review_type: reviewType,
                    personnel_emails: personnelEmails,
                    notes: notes
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Contract submitted for review', 'success');
                closeModal('internalReviewModal');
                // Update workflow status
                document.getElementById('workflowStatusText').textContent = 'In Review';
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('Failed to submit for review', 'error');
            }
        } catch (error) {
            console.error('Error submitting for review:', error);
            showNotification('Failed to submit for review', 'error');
        } finally {
            hideLoader();
        }
    }

    // Risk Analysis - CONNECTED TO AI BACKEND
    async function openRiskAnalysisModal() {
        openModal('riskAnalysisModal');

        // Fetch risk analysis from backend
        try {
            const response = await fetch(`/api/contracts/risk-analysis/${contractId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success && data.analysis) {
                riskAnalysisData = data.analysis;
                displayRiskAnalysis(data.analysis);
            } else {
                showDefaultRiskAnalysis();
            }
        } catch (error) {
            console.error('Error fetching risk analysis:', error);
            showDefaultRiskAnalysis();
        }
    }

    function displayRiskAnalysis(analysis) {
        const content = document.getElementById('riskAnalysisContent');
        content.innerHTML = `
        <div class="risk-summary">
            <div class="risk-stat high">
                <div class="risk-stat-value">${analysis.high_risks || 0}</div>
                <div class="risk-stat-label">High Risk</div>
            </div>
            <div class="risk-stat medium">
                <div class="risk-stat-value">${analysis.medium_risks || 0}</div>
                <div class="risk-stat-label">Medium Risk</div>
            </div>
            <div class="risk-stat low">
                <div class="risk-stat-value">${analysis.low_risks || 0}</div>
                <div class="risk-stat-label">Low Risk</div>
            </div>
            <div class="risk-stat">
                <div class="risk-stat-value" style="color: var(--primary-color);">${analysis.overall_score || 0}</div>
                <div class="risk-stat-label">Overall Score</div>
            </div>
        </div>
        
        <div style="margin-top: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">Detailed Risk Analysis</h4>
            ${(analysis.risk_items || []).map(risk => `
                <div class="risk-item" style="background: white; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; overflow: hidden;">
                    <div class="risk-item-header" onclick="toggleRiskItem(this)" style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: var(--background-light);">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ti ti-alert-triangle"></i>
                            <span>${risk.issue}</span>
                        </div>
                        <span class="severity-badge ${risk.severity}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background: ${risk.severity === 'high' ? 'var(--danger-bg)' : risk.severity === 'medium' ? 'var(--warning-bg)' : 'var(--success-bg)'}; color: ${risk.severity === 'high' ? 'var(--danger-color)' : risk.severity === 'medium' ? 'var(--warning-color)' : 'var(--success-color)'};">
                            ${risk.severity}
                        </span>
                    </div>
                    <div class="risk-item-content" style="padding: 1.25rem; display: none;">
                        <p style="margin-bottom: 1rem; color: var(--text-muted);">
                            ${risk.description}
                        </p>
                        <div style="background: var(--background-light); padding: 1rem; border-radius: 6px; border-left: 4px solid var(--primary-color); margin-bottom: 1rem;">
                            <strong>${risk.clause_reference}:</strong> ${risk.recommendation}
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="viewClauseSuggestions('${risk.type}')">
                                <i class="ti ti-sparkles"></i> View AI Suggestions
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    }

    function showDefaultRiskAnalysis() {
        displayRiskAnalysis({
            overall_score: 72,
            high_risks: 2,
            medium_risks: 3,
            low_risks: 5,
            risk_items: [
                {
                    type: "termination",
                    severity: "high",
                    score: 85,
                    issue: "Unilateral termination rights",
                    description: "The counterparty has the right to terminate without cause with only 30 days notice.",
                    clause_reference: "Clause 4.2",
                    recommendation: "Consider adding mutual termination rights with 90 days notice"
                }
            ]
        });
    }


    function initiateLiveNegotiation() {
        closeModal('negotiationModal');
        setTimeout(() => openModal('liveNegotiationModal'), 300);
    }


    // Negotiation Functions
    function generateRiskSummary() {
        closeModal('negotiationModal');
        setTimeout(() => openModal('riskSummaryModal'), 300);
    }


    // Simplified modal opening
    function initiateLiveNegotiation() {
        console.log('Opening live negotiation modal');
        closeModal('negotiationModal');
        setTimeout(() => {
            openModal('liveNegotiationModal');
            // Focus input after modal opens
            setTimeout(() => {
                const input = document.getElementById('messageInput');
                if (input) {
                    input.focus();
                    console.log('Input focused');
                }
            }, 300);
        }, 300);
    }

    function downloadRiskReport() {
        alert('Downloading AI risk analysis report...');
    }


    function proceedWithNegotiation() {
        closeModal('riskSummaryModal');
        setTimeout(() => openModal('liveNegotiationModal'), 300);
    }


    // FIXED Chat Functions - Direct and Simple
    function sendMessage() {
        console.log('sendMessage called - direct function');

        const input = document.getElementById('messageInput');
        const messagesArea = document.getElementById('chatMessages');

        console.log('Elements found:', {
            input: !!input,
            inputValue: input ? input.value : 'N/A',
            messagesArea: !!messagesArea
        });

        if (!input || !messagesArea) {
            console.error('Required elements not found');
            alert('Chat elements not found. Please try refreshing.');
            return;
        }

        const message = input.value.trim();
        if (!message) {
            console.log('Empty message');
            input.focus();
            return;
        }

        console.log('Processing message:', message);

        // Add user message immediately
        addModernMessage('You', message, 'user');

        // Clear input
        input.value = '';
        input.focus();

        // Show typing and respond
        showModernTypingIndicator();

        setTimeout(() => {
            hideModernTypingIndicator();
            const response = generateSmartResponse(message);
            addModernMessage('Contract Initiator', response, 'initiator');
        }, 1000);

        console.log('Message processing complete');
    }

    // Direct click handler for send button
    function handleSendClick() {
        console.log('Send button clicked');
        sendMessage();
    }

    // Direct keypress handler for input
    function handleInputKeypress(event) {
        console.log('Key pressed in input:', event.key);
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    }


    async function openClauseAnalysisModal() {
        // Get user's selected text (if any)
        const selection = window.getSelection();
        let selectedText = selection.toString().trim();

        // Get the full contract content from the editor
        const contractEditor = document.getElementById('contractContentEditor');
        let fullContent = '';

        if (contractEditor) {
            // Get innerHTML (preserves HTML structure) or innerText (plain text)
            fullContent = contractEditor.innerText || contractEditor.textContent || '';
            fullContent = fullContent.trim();
        }

        // Determine what content to analyze
        let contentToAnalyze = '';

        if (selectedText && selectedText.length > 0) {
            // User has selected specific text - analyze that
            contentToAnalyze = selectedText;
            currentClauseText = selectedText;
            console.log(' Analyzing selected text:', contentToAnalyze.substring(0, 100) + '...');
        } else if (fullContent && fullContent.length > 0) {
            // No selection - analyze the entire contract content
            contentToAnalyze = fullContent;
            currentClauseText = fullContent;
            console.log(' Analyzing full contract content (', fullContent.length, 'characters)');
        } else {
            // No content available
            showNotification('Please select clause to analyze', 'warning');
            return;
        }

        // Validate we have content
        if (!contentToAnalyze || contentToAnalyze.length < 10) {
            showNotification('Please add contract content or select text to analyze', 'warning');
            return;
        }

        // Open the modal
        openModal('clauseSuggestionModal');

        // Get AI suggestions for the content
        try {
            showLoader('AI is analyzing the clause...');

            const response = await fetch('/api/contracts/clause-suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    clause_text: contentToAnalyze,
                    clause_type: 'general',
                    contract_id: contractId
                })
            });

            hideLoader();

            if (!response.ok) {
                throw new Error('Failed to get clause suggestions from AI');
            }

            const data = await response.json();

            if (data.success && data.suggestions && data.suggestions.length > 0) {
                displayClauseSuggestions(data.suggestions);
            } else {
                // No suggestions returned - close modal and show error
                closeModal('clauseSuggestionModal');
                showNotification('AI could not generate suggestions for this content. Please try again or contact support.', 'error');
            }

        } catch (error) {
            console.error('Error getting clause suggestions:', error);
            hideLoader();
            closeModal('clauseSuggestionModal');

            // Show honest error message
            showNotification('Failed to analyze clause. Please check your connection and try again.', 'error');
        }
    }
    function viewClauseSuggestions(clauseType) {
        closeModal('riskAnalysisModal');
        setTimeout(() => openClauseAnalysisModal(), 300);
    }

    // Helper function to display suggestions (keep existing function)
    function displayClauseSuggestions(suggestions) {
        const container = document.getElementById('clauseSuggestionContent');

        container.innerHTML = `
        <div style="background: var(--background-light); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--text-color);">
                <i class="ti ti-file-text"></i> Original Clause
            </h4>
            <p style="margin: 0; color: var(--text-muted); line-height: 1.6;">
                ${escapeHtml(currentClauseText || 'No text selected')}
            </p>
        </div>
        
        <h4 style="margin: 0 0 1rem 0; color: var(--text-color);">
            <i class="ti ti-sparkles"></i> AI Suggestions
        </h4>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            ${suggestions.map((sug, idx) => `
                <div onclick="selectSuggestion(${idx})" style="cursor: pointer; padding: 1.25rem; background: rgba(39, 98, 203, 0.05); border-radius: 8px; border: 2px solid transparent; transition: all 0.3s ease;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                        <h5 style="margin: 0; color: var(--primary-color); font-size: 1rem;">
                            Option ${idx + 1}
                        </h5>
                        <div style="display: flex; gap: 0.5rem;">
                            <span style="background: var(--success-bg); color: var(--success-color); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                                Legal: ${sug.legal_score || 5}/5
                            </span>
                            <span style="background: var(--info-bg); color: var(--info-color); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                                Business: ${sug.business_score || 4}/5
                            </span>
                        </div>
                    </div>
                    
                    <p style="margin: 0 0 0.75rem 0; color: var(--text-color); line-height: 1.6; font-weight: 500;">
                        ${escapeHtml(sug.suggested)}
                    </p>
                    
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem; line-height: 1.5;">
                        <i class="ti ti-info-circle"></i> <strong>Reasoning:</strong> ${escapeHtml(sug.reasoning)}
                    </p>
                    
                    <p style="margin: 0.75rem 0 0 0; color: var(--success-color); font-size: 0.85rem;">
                        <i class="ti ti-shield-check"></i> ${sug.compliance || 'Compliant with standard practices'}
                    </p>
                </div>
            `).join('')}
        </div>
    `;

        window.currentSuggestions = suggestions;
    }


    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    let selectedSuggestionIndex = 0;
    function selectSuggestion(index) {
        selectedSuggestionIndex = index;
        // Update UI to show selection
        document.querySelectorAll('#clauseSuggestionContent > div:last-child > div').forEach((el, idx) => {
            el.style.background = idx === index ? 'rgba(39, 98, 203, 0.1)' : 'rgba(39, 98, 203, 0.05)';
        });
    }

    function acceptSuggestion() {
        if (!window.currentSuggestions || !window.currentSuggestions[selectedSuggestionIndex]) {
            showNotification('No suggestion selected', 'warning');
            return;
        }

        const suggestion = window.currentSuggestions[selectedSuggestionIndex];

        if (!currentClauseText) {
            showNotification('No clause text to replace', 'warning');
            return;
        }

        try {
            const content = document.getElementById('contractContent');

            if (!content) {
                throw new Error('Contract editor not found');
            }

            console.log(' Looking for text:', currentClauseText);
            console.log(' Replacing with:', suggestion.suggested);

            //  METHOD 1: Try direct innerHTML replacement first
            let originalContent = content.innerHTML;
            let plainOriginal = content.innerText || content.textContent || '';

            // Check if the text exists in plain text form
            if (!plainOriginal.includes(currentClauseText)) {
                console.error(' Text not found in plain content');
                console.log('Expected:', currentClauseText);
                console.log('Available:', plainOriginal.substring(0, 200) + '...');
                showNotification('Could not find the original text to replace', 'error');
                return;
            }

            //  METHOD 2: Try simple string replacement (handles HTML tags)
            let newContent = originalContent.replace(currentClauseText, suggestion.suggested);

            // If simple replacement didn't work, try with normalized whitespace
            if (newContent === originalContent) {
                console.log(' Simple replacement failed, trying normalized...');

                // Normalize both strings (remove extra whitespace, trim)
                const normalizedClause = currentClauseText.trim().replace(/\s+/g, ' ');
                const normalizedContent = originalContent.replace(/\s+/g, ' ');

                newContent = normalizedContent.replace(normalizedClause, suggestion.suggested);

                // Restore original whitespace structure somewhat
                if (newContent !== normalizedContent) {
                    // Replacement worked with normalized text
                    originalContent = normalizedContent;
                }
            }

            // If still no change, try regex with escaped characters
            if (newContent === originalContent) {
                console.log(' Normalized replacement failed, trying regex...');

                // Escape special characters for regex
                const escapedText = currentClauseText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(escapedText, 'i'); // case insensitive

                newContent = originalContent.replace(regex, suggestion.suggested);
            }

            //  METHOD 3: Last resort - replace in the visible text area
            if (newContent === originalContent) {
                console.log(' All replacements failed, trying innerText...');

                let textContent = content.innerText || content.textContent || '';

                if (textContent.includes(currentClauseText)) {
                    // Replace in plain text
                    textContent = textContent.replace(currentClauseText, suggestion.suggested);

                    // Update as plain text (will lose formatting but works)
                    content.innerText = textContent;
                    newContent = content.innerHTML; // Get the updated HTML

                    console.log(' Applied via innerText');
                } else {
                    throw new Error('Text not found in any format');
                }
            }

            //  Apply the changes
            content.innerHTML = newContent;

            //  Force browser to recognize the change
            content.dispatchEvent(new Event('input', { bubbles: true }));
            content.dispatchEvent(new Event('change', { bubbles: true }));

            //  Verify by checking if the NEW text exists (not the old text)
            const verifyContent = content.innerText || content.textContent || '';
            const suggestionExists = verifyContent.includes(suggestion.suggested);
            const originalGone = !verifyContent.includes(currentClauseText);

            console.log('Verification:', {
                suggestionExists,
                originalGone,
                newTextSnippet: verifyContent.substring(0, 100)
            });

            if (suggestionExists || originalGone) {
                console.log(' Suggestion applied successfully');

                // Scroll to show the change
                content.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Track this change
                if (trackChangesEnabled && typeof trackChange === 'function') {
                    trackChange('ai_suggestion', currentClauseText, suggestion.suggested);
                }

                // Mark as modified
                if (typeof markAsDirty === 'function') {
                    markAsDirty();
                }

                showNotification(' AI suggestion applied successfully', 'success');

                // Save draft after applying suggestion
                saveAsDraft();

                // Close modal
                setTimeout(() => {
                    closeModal('clauseSuggestionModal');
                }, 500);

            } else {
                // Still failed - show what we tried
                console.error(' Verification failed');
                console.log('Original text:', currentClauseText);
                console.log('Replacement text:', suggestion.suggested);
                console.log('Current content snippet:', verifyContent.substring(0, 200));

                throw new Error('Could not verify the replacement was applied');
            }

        } catch (error) {
            console.error(' Error applying suggestion:', error);
            showNotification('Failed to apply suggestion: ' + error.message, 'error');

            // Offer alternative
            setTimeout(() => {
                if (confirm('Would you like to copy the suggestion to clipboard instead?')) {
                    copyToClipboard(suggestion.suggested);
                    showNotification('Suggestion copied to clipboard', 'info');
                }
            }, 1000);
        }
    }

    // Helper to copy text to clipboard
    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text);
        } else {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
    }
    // Helper function to highlight the replaced text
    function highlightReplacedText(text) {
        const content = document.getElementById('contractContent');
        if (!content) return;

        try {
            // Temporarily highlight the new text
            const tempHighlight = `<mark style="background: #90EE90; animation: fadeOut 3s forwards;">${text}</mark>`;
            const regex = new RegExp(text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

            content.innerHTML = content.innerHTML.replace(
                regex,
                (match) => tempHighlight.replace(text, match)
            );

            // Scroll to the highlighted text
            const mark = content.querySelector('mark');
            if (mark) {
                mark.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Remove highlight after 3 seconds
                setTimeout(() => {
                    if (mark && mark.parentNode) {
                        const textNode = document.createTextNode(mark.textContent);
                        mark.parentNode.replaceChild(textNode, mark);
                    }
                }, 3000);
            }
        } catch (e) {
            console.log('Could not highlight text:', e);
        }
    }

    // Add this CSS for the fade animation
    const style = document.createElement('style');
    style.textContent = `
    @keyframes fadeOut {
        0% { background: #90EE90; }
        70% { background: #90EE90; }
        100% { background: transparent; }
    }
`;
    document.head.appendChild(style);

    function editClauseManually() {
        closeModal('clauseSuggestionModal');
        showNotification('You can now edit the clause directly in the editor', 'info');
        // Focus on the editor
        document.getElementById('contractContent').focus();
    }

    // Version History - CONNECTED TO BACKEND
    async function showVersionHistory() {
        showLoader();
        try {
            const response = await fetch(`/api/contracts/versions/${contractId}`);
            const data = await response.json();

            if (data.success && data.versions) {
                displayVersionHistory(data.versions);
                openModal('versionModal');
            } else {
                showNotification('No version history available', 'info');
            }
        } catch (error) {
            console.error('Error fetching version history:', error);
            showNotification('Failed to load version history', 'error');
        } finally {
            hideLoader();
        }
    }

    function displayVersionHistory(versions) {
        const content = document.getElementById('versionHistoryContent');
        content.innerHTML = versions.map((version, index) => `
        <div style="padding: 1rem; background: ${index === 0 ? 'var(--background-light)' : 'white'}; border-radius: 8px; ${index === 0 ? 'border-left: 3px solid var(--primary-color);' : 'border: 1px solid var(--border-color);'} margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <strong>Version ${version.version} ${index === 0 ? '(Current)' : ''}</strong>
                <span style="color: var(--text-muted); font-size: 0.875rem;">${new Date(version.created_at).toLocaleString()}</span>
            </div>
            <p style="font-size: 0.875rem; color: var(--text-muted); margin: 0.5rem 0;">${version.notes || version.type || 'No notes'}</p>
            <p style="font-size: 0.8rem; margin: 0;">Modified by: ${version.created_by || 'Unknown'}</p>
            ${index > 0 ? `
                <div style="margin-top: 0.5rem;">
                    <button class="btn btn-sm btn-outline-primary" onclick="compareWithVersion(${version.version})">
                        Compare with Current
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="restoreVersion(${version.id})">
                        Restore This Version
                    </button>
                </div>
            ` : ''}
        </div>
    `).join('');
    }

    async function compareVersions() {
        const v1 = prompt('Enter first version number:');
        const v2 = prompt('Enter second version number:');

        if (!v1 || !v2) return;

        showLoader();
        try {
            const response = await fetch(`/api/contracts/versions/compare?contract_id=${contractId}&version1=${v1}&version2=${v2}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`${data.total_changes} changes found between versions`, 'info');
            }
        } catch (error) {
            console.error('Error comparing versions:', error);
            showNotification('Failed to compare versions', 'error');
        } finally {
            hideLoader();
        }
    }

    // Export - CONNECTED TO BACKEND
    function exportDocument() {
        openModal('exportModal');
    }

    async function executeExport() {
        // Get selected format
        const formatInput = document.querySelector('input[name="exportFormat"]:checked');
        const format = formatInput ? formatInput.value : 'pdf';

        // Get export options
        const includeTracked = document.getElementById('includeTrackedChanges')?.checked || false;
        const includeComments = document.getElementById('includeComments')?.checked || false;

        console.log(' Export requested:', { format, includeTracked, includeComments, contractId });

        // Show loading state
        showLoader();
        showNotification(`Preparing ${format.toUpperCase()} export...`, 'info');

        try {
            // Build API URL with query parameters
            const params = new URLSearchParams({
                format: format,
                include_tracked_changes: includeTracked.toString(),
                include_comments: includeComments.toString()
            });

            const apiUrl = `/api/contracts/export/${contractId}?${params.toString()}`;
            console.log(' API URL:', apiUrl);

            // Make POST request to export endpoint
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log(' Response status:', response.status);

            // Check if request was successful
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({
                    detail: `Export failed with status ${response.status}`
                }));
                throw new Error(errorData.detail || `Export failed with status ${response.status}`);
            }

            // Get filename from Content-Disposition header or create default
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `contract_${contractId}`;

            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (filenameMatch && filenameMatch[1]) {
                    filename = filenameMatch[1].replace(/['"]/g, '');
                }
            } else {
                // Add appropriate extension if not in filename
                const extensions = {
                    'pdf': 'pdf',
                    'word': 'docx',
                    'html': 'html',
                    'txt': 'txt'
                };
                filename += `.${extensions[format] || 'pdf'}`;
            }

            console.log(' Downloading as:', filename);

            // Get the blob
            const blob = await response.blob();
            console.log(' Blob received:', blob.type, blob.size, 'bytes');

            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;

            // Trigger download
            document.body.appendChild(a);
            a.click();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);

            // Close modal and show success
            closeModal('exportModal');
            hideLoader();
            showNotification(`Document exported successfully as ${format.toUpperCase()}`, 'success');

            console.log(' Export completed successfully');

        } catch (error) {
            console.error(' Export error:', error);
            hideLoader();
            showNotification(`Export failed: ${error.message}`, 'error');
        }
    }

    // Signature - CONNECTED TO BACKEND
    function openSignature(party) {
        currentSignatureField = party;
        const modal = document.getElementById('signatureModal');

        // Set signer info based on party
        if (party === 'client') {
            document.getElementById('signerName').textContent = 'Qatar Energy Representative';
            document.getElementById('signerRole').textContent = 'Client';
            document.getElementById('partyIndicator').textContent = 'Client';
            document.getElementById('partyIndicator').style.background = 'var(--primary-color)';
        } else {
            document.getElementById('signerName').textContent = 'Service Provider Representative';
            document.getElementById('signerRole').textContent = 'Service Provider';
            document.getElementById('partyIndicator').textContent = 'Counter Party';
            document.getElementById('partyIndicator').style.background = 'var(--secondary-color)';
        }

        openModal('signatureModal');
        setTimeout(() => initCanvas(), 100);
    }



    // =====================================================
    // SIGNATURE FUNCTIONS - CONNECTED TO BACKEND
    // =====================================================

    // Send for Signature - CONNECTED TO BACKEND
    async function sendForSignature() {
        if (!confirm('Send this contract for signature? Both parties will be notified to sign the document.')) {
            return;
        }

        showLoader();
        try {
            const response = await fetch('/api/contracts/send-for-signature', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Contract sent for signature successfully!', 'success');

                // Update workflow status
                document.getElementById('workflowStatusText').textContent = 'Awaiting Signatures';

                // CORRECTED: Mark Approval as COMPLETED (step 4)
                const approvalStep = document.querySelector('.stepper-step:nth-child(4)');
                if (approvalStep) {
                    approvalStep.classList.remove('pending', 'active');
                    approvalStep.classList.add('completed');
                    approvalStep.querySelector('.step-date').textContent = 'Completed';
                }

                // Set Signature as ACTIVE (step 5)
                const signatureStep = document.querySelector('.stepper-step:nth-child(5)');
                if (signatureStep) {
                    signatureStep.classList.remove('pending');
                    signatureStep.classList.add('active');
                    signatureStep.querySelector('.step-date').textContent = 'In Progress';
                }

                // Update progress bar to 83% (at signature stage)
                document.getElementById('stepperProgress').style.width = '83%';

                // Reload page after delay to show updated status
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification(data.message || 'Failed to send for signature', 'error');
            }
        } catch (error) {
            console.error('Error sending for signature:', error);
            showNotification('Failed to send for signature', 'error');
        } finally {
            hideLoader();
        }
    }


    // Open Signature Modal - Enhanced version
    function openSignatureModal() {
        // Determine the party based on current user context
        // This should ideally come from your backend/session
        const isInitiator = true; // Replace with actual logic: contractData?.is_initiator
        const party = isInitiator ? 'company' : 'client';

        currentSignatureField = party;
        const modal = document.getElementById('signatureModal');

        if (!modal) {
            console.error('Signature modal not found');
            showNotification('Signature modal not available', 'error');
            return;
        }

        // Set signer info based on party and contract data
        const signerNameEl = document.getElementById('signerName');
        const signerRoleEl = document.getElementById('signerRole');
        const partyIndicatorEl = document.getElementById('partyIndicator');

        if (party === 'client') {
            if (signerNameEl) signerNameEl.textContent = contractData?.contract?.client_name || 'Client Representative';
            if (signerRoleEl) signerRoleEl.textContent = 'Client';
            if (partyIndicatorEl) {
                partyIndicatorEl.textContent = 'Client';
                partyIndicatorEl.style.background = 'var(--primary-color)';
            }
        } else if (party === 'company') {
            if (signerNameEl) signerNameEl.textContent = contractData?.contract?.company_name || 'Company Representative';
            if (signerRoleEl) signerRoleEl.textContent = 'Service Provider';
            if (partyIndicatorEl) {
                partyIndicatorEl.textContent = 'Service Provider';
                partyIndicatorEl.style.background = 'var(--secondary-color)';
            }
        }

        // Reset modal state
        const agreeTerms = document.getElementById('agreeTerms');
        const typedSig = document.getElementById('typedSig');
        const signBtn = document.getElementById('signBtn');

        if (agreeTerms) agreeTerms.checked = false;
        if (typedSig) typedSig.value = '';
        if (signBtn) signBtn.disabled = true;

        // Reset signature preview
        const sigPreview = document.getElementById('sigPreview');
        if (sigPreview) sigPreview.textContent = '';

        // Set default to draw method
        switchSignMethod('draw');

        // Open modal
        openModal('signatureModal');

        // Initialize canvas after modal is visible
        setTimeout(() => {
            initCanvas();
        }, 100);
    }

    // Alternative: Open signature for specific party (used when clicking signature fields)
    function openSignature(party) {
        currentSignatureField = party;
        const modal = document.getElementById('signatureModal');

        if (!modal) {
            console.error('Signature modal not found');
            showNotification('Signature modal not available', 'error');
            return;
        }

        const signerNameEl = document.getElementById('signerName');
        const signerRoleEl = document.getElementById('signerRole');
        const partyIndicatorEl = document.getElementById('partyIndicator');

        // Set signer info based on party
        if (party === 'client') {
            if (signerNameEl) signerNameEl.textContent = contractData?.contract?.client_name || 'Client Representative';
            if (signerRoleEl) signerRoleEl.textContent = 'Client';
            if (partyIndicatorEl) {
                partyIndicatorEl.textContent = 'Client';
                partyIndicatorEl.style.background = 'var(--primary-color)';
            }
        } else if (party === 'provider' || party === 'company') {
            if (signerNameEl) signerNameEl.textContent = contractData?.contract?.company_name || 'Service Provider Representative';
            if (signerRoleEl) signerRoleEl.textContent = 'Service Provider';
            if (partyIndicatorEl) {
                partyIndicatorEl.textContent = party === 'provider' ? 'Service Provider' : 'Company';
                partyIndicatorEl.style.background = 'var(--secondary-color)';
            }
        }

        // Reset modal state
        const agreeTerms = document.getElementById('agreeTerms');
        const typedSig = document.getElementById('typedSig');
        const signBtn = document.getElementById('signBtn');

        if (agreeTerms) agreeTerms.checked = false;
        if (typedSig) typedSig.value = '';
        if (signBtn) signBtn.disabled = true;

        // Reset signature preview
        const sigPreview = document.getElementById('sigPreview');
        if (sigPreview) sigPreview.textContent = '';

        // Set default to draw method
        switchSignMethod('draw');

        // Open modal
        openModal('signatureModal');

        // Initialize canvas after modal is visible
        setTimeout(() => {
            initCanvas();
        }, 100);
    }

    async function applySignature() {
        const signatureData = document.getElementById('typedSig')?.value ||
            (canvas ? canvas.toDataURL() : 'Digitally Signed');
        const signatureMethod = document.querySelector('.signature-tab.active')?.textContent.includes('Type') ? 'type' : 'draw';

        showLoader();
        try {
            const response = await fetch('/api/contracts/signature/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: parseInt(contractId),
                    signer_type: currentSignatureField,
                    signature_method: signatureMethod,
                    signature_data: signatureData
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update UI to show signature
                const fieldId = currentSignatureField === 'client' ? 'clientSignature' :
                    (currentSignatureField === 'provider' ? 'providerSignature' : 'companySignature');
                const field = document.getElementById(fieldId);

                if (field) {
                    field.classList.add('signed');
                    field.innerHTML = `
                    <div style="font-family: 'Brush Script MT', cursive; font-size: 1.5rem; color: var(--success-color);">
                        ${document.getElementById('typedSig')?.value || 'Signed'}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Signed on ${new Date().toLocaleString()}
                    </div>
                `;
                    field.onclick = null;
                }

                showNotification('Signature applied successfully', 'success');
                closeModal('signatureModal');

                //  Check if both parties have signed
                if (data.both_signed && data.status === 'signed') {
                    // Both parties signed - status is now 'signed'
                    showNotification('Both parties have signed! Contract status changed to SIGNED.', 'success');

                    // Update contract status in memory
                    if (contractData && contractData.contract) {
                        contractData.contract.status = 'signed';
                    }

                    // Reload page to show Execute Contract button
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    // Only one party signed so far
                    checkAllSignatures();
                }

                // Save the contract after signing
                await saveAsDraft();
            } else {
                showNotification(data.detail || 'Failed to apply signature', 'error');
            }
        } catch (error) {
            console.error('Error applying signature:', error);
            showNotification('Failed to apply signature', 'error');
        } finally {
            hideLoader();
        }
    }


    // Workflow Setup - CONNECTED TO BACKEND
    async function saveContractWorkflow() {
        if (!selectedContractWorkflow) {
            alert('Please select a workflow type.');
            return;
        }

        console.log(' Saving workflow...');
        console.log('Selected workflow type:', selectedContractWorkflow);

        const workflowData = {
            contract_id: contractId,
            workflow_type: selectedContractWorkflow
        };

        if (selectedContractWorkflow === 'custom') {
            console.log(' Collecting custom workflow steps...');

            const steps = [];
            const rows = document.querySelectorAll('#contractWorkflowSteps tr');

            console.log(`Found ${rows.length} workflow step rows`);

            rows.forEach((row, index) => {
                // Get all select and input elements in this row
                const roleSelect = row.querySelector('select:nth-of-type(1)');
                const emailInput = row.querySelector('input[type="email"]');
                const deptSelect = row.querySelector('select:nth-of-type(2)');

                const role = roleSelect?.value || '';
                const email = emailInput?.value || '';
                const department = deptSelect?.value || '';

                console.log(`Row ${index + 1}: role="${role}", email="${email}", dept="${department}"`);

                // Only add if we have at least role and email
                if (role && email) {
                    steps.push({
                        step_order: index + 1,
                        step_label: role,
                        assigned_email: email,
                        department: department
                    });

                    console.log(` Added step ${index + 1}:`, {
                        step_order: index + 1,
                        step_label: role,
                        assigned_email: email,
                        department: department
                    });
                } else {
                    console.warn(` Skipping row ${index + 1}: missing role or email`);
                }
            });

            workflowData.steps = steps;
            workflowData.justification = "Custom workflow for this contract";

            console.log(` Prepared ${steps.length} steps for backend:`, steps);

            if (steps.length === 0) {
                alert('Please add at least one workflow step with role and email.');
                return;
            }
        }

        console.log(' Sending to backend:', workflowData);
        showLoader();

        try {
            const response = await fetch('/api/contracts/workflow/setup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(workflowData)
            });

            console.log(' Response status:', response.status);
            const data = await response.json();
            console.log(' Response data:', data);

            if (data.success) {
                showNotification(' Workflow configured successfully', 'success');
                closeModal('contractWorkflowModal');

                // Update status text
                document.getElementById('workflowStatusText').textContent =
                    selectedContractWorkflow === 'master' ?
                        'Master Workflow Applied' :
                        'Custom Workflow Applied';
            } else {
                showNotification(data.message || 'Failed to configure workflow', 'error');
            }
        } catch (error) {
            console.error(' Error saving workflow:', error);
            showNotification('Failed to save workflow', 'error');
        } finally {
            hideLoader();
        }
    }

    function downloadMinutes() {
        alert('Downloading negotiation minutes...');
    }

    function finalizeNegotiation() {
        if (confirm('Are you ready to finalize this negotiation? This will conclude the negotiation stage.')) {
            alert('Negotiation finalized successfully! Moving to next stage.');
            closeModal('liveNegotiationModal');
        }
    }
    // Track Changes - FULL FUNCTIONALITY
    async function toggleTrackChanges() {
        trackChangesEnabled = !trackChangesEnabled;
        const btn = document.getElementById('trackChangesBtn');

        if (trackChangesEnabled) {
            btn.classList.add('active');
            btn.style.background = 'var(--primary-color)';
            btn.style.color = 'white';

            // Store current content as baseline
            originalContent = document.getElementById('contractContent').innerHTML;

            // Enable track changes on backend
            await updateTrackChangesStatus('enable');

            showNotification('Track changes enabled', 'info');
        } else {
            btn.classList.remove('active');
            btn.style.background = '';
            btn.style.color = '';

            // Ask user what to do with tracked changes
            const action = confirm('Accept all tracked changes?') ? 'accept_all' : 'reject_all';
            await updateTrackChangesStatus(action);

            if (action === 'accept_all') {
                acceptAllChanges();
            } else {
                rejectAllChanges();
            }

            showNotification('Track changes disabled', 'info');
        }
    }

    async function updateTrackChangesStatus(action) {
        // Since metadata column doesn't exist, we'll handle track changes client-side only
        // and store the state in localStorage for persistence
        try {
            const trackChangesState = {
                contractId: contractId,
                enabled: action === 'enable',
                action: action,
                timestamp: new Date().toISOString(),
                changes: trackedChanges
            };

            // Store in localStorage
            localStorage.setItem(`track_changes_${contractId}`, JSON.stringify(trackChangesState));

            console.log('Track changes status updated locally:', trackChangesState);

            // Still save the content to create a new version
            if (action === 'accept_all' || action === 'reject_all') {
                await saveAsDraft();
            }
        } catch (error) {
            console.error('Error updating track changes:', error);
        }
    }

    function handleContentChange(e) {
        if (!trackChangesEnabled) {
            // Just update save status
            updateSaveStatus('editing');
            return;
        }

        // Track the change
        const currentContent = document.getElementById('contractContent').innerHTML;
        const changeType = currentContent.length > originalContent.length ? 'insert' : 'delete';

        // Simple change tracking - in production, use a proper diff algorithm
        trackChange(changeType, originalContent, currentContent);

        updateSaveStatus('editing');
    }

    function trackChange(type, oldText, newText) {
        const change = {
            type: type,
            timestamp: new Date().toISOString(),
            user: 'Current User',
            oldText: oldText,
            newText: newText
        };

        trackedChanges.push(change);

        // Apply visual indicators
        if (type === 'insert') {
            // Wrap new text in insert indicator
            const diff = newText.replace(oldText, '');
            if (diff) {
                // This is simplified - in production, use proper diff marking
                console.log('Text inserted:', diff.substring(0, 50));
            }
        } else if (type === 'delete') {
            // Mark deleted text
            console.log('Text deleted');
        }
    }

    function acceptAllChanges() {
        // Remove all track change markup
        const content = document.getElementById('contractContent');
        const cleanContent = content.innerHTML
            .replace(/<span class="track-change-insert[^>]*>(.*?)<\/span>/g, '$1')
            .replace(/<span class="track-change-delete[^>]*>.*?<\/span>/g, '');

        content.innerHTML = cleanContent;
        trackedChanges = [];
        originalContent = cleanContent;

        // Save the accepted changes
        saveAsDraft();
    }

    function rejectAllChanges() {
        // Restore original content
        document.getElementById('contractContent').innerHTML = originalContent;
        trackedChanges = [];
    }

    // Find & Replace - FULL FUNCTIONALITY
    function findReplace() {
        openModal('findReplaceModal');
    }

    function findNext() {
        const findText = document.getElementById('findText').value;
        const caseSensitive = document.getElementById('caseSensitive').checked;

        if (!findText) return;

        const content = document.getElementById('contractContent');
        const text = content.innerText;
        const flags = caseSensitive ? 'g' : 'gi';
        const regex = new RegExp(findText, flags);

        const matches = text.match(regex);
        if (matches) {
            showNotification(`Found ${matches.length} occurrences`, 'info');
            // Highlight first match
            highlightText(findText, caseSensitive);
        } else {
            showNotification('No matches found', 'warning');
        }
    }

    function replaceOne() {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        const caseSensitive = document.getElementById('caseSensitive').checked;

        if (!findText) return;

        const content = document.getElementById('contractContent');
        const flags = caseSensitive ? '' : 'i';
        const regex = new RegExp(findText, flags);

        content.innerHTML = content.innerHTML.replace(regex, replaceText);

        if (trackChangesEnabled) {
            trackChange('replace', findText, replaceText);
        }

        showNotification('Replaced 1 occurrence', 'success');
        saveAsDraft();
    }

    function replaceAll() {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        const caseSensitive = document.getElementById('caseSensitive').checked;

        if (!findText) return;

        const content = document.getElementById('contractContent');
        const flags = caseSensitive ? 'g' : 'gi';
        const regex = new RegExp(findText, flags);

        const originalHtml = content.innerHTML;
        const newHtml = originalHtml.replace(regex, replaceText);
        const replacements = (originalHtml.match(regex) || []).length;

        content.innerHTML = newHtml;

        if (trackChangesEnabled && replacements > 0) {
            trackChange('replace_all', findText, replaceText);
        }

        showNotification(`Replaced ${replacements} occurrences`, 'success');
        closeModal('findReplaceModal');
        saveAsDraft();
    }

    function highlightText(text, caseSensitive) {
        const content = document.getElementById('contractContent');
        const flags = caseSensitive ? 'g' : 'gi';
        const regex = new RegExp(`(${text})`, flags);

        content.innerHTML = content.innerHTML.replace(regex, '<mark style="background: yellow;">$1</mark>');

        // Scroll to first match
        const firstMatch = content.querySelector('mark');
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }


    let commentSelection = null;
    let activeCommentBubble = null;

    // Enhanced addComment function
    function addComment() {
        const selection = window.getSelection();
        if (selection.toString().trim()) {
            // Store the selection details
            commentSelection = {
                text: selection.toString(),
                range: selection.getRangeAt(0).cloneRange()
            };
            openModal('commentModal');
        } else {
            showNotification('Please select text to add a comment', 'warning');
        }
    }

    // Enhanced insertComment function with database persistence
    async function insertComment() {
        const commentText = document.getElementById('commentText').value.trim();

        if (!commentText) {
            showNotification('Please enter a comment', 'warning');
            return;
        }

        if (!commentSelection || !commentSelection.text) {
            showNotification('Please select text first', 'warning');
            return;
        }

        try {
            // Show loading state
            const submitBtn = document.querySelector('#commentModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="ti ti-loader-2"></i> Saving...';
            submitBtn.disabled = true;

            // Save comment to database
            const response = await fetch('/api/contracts/comments/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contract_id: parseInt(contractId),
                    comment_text: commentText,
                    selected_text: commentSelection.text
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Failed to save comment');
            }

            if (data.success) {
                // Add visual comment indicator to the editor
                addVisualCommentMarker(data.comment, commentSelection.range);

                // Close modal and reset
                closeModal('commentModal');
                document.getElementById('commentText').value = '';
                commentSelection = null;

                showNotification('Comment added successfully', 'success');

                // Auto-save the contract
                saveAsDraft();
            } else {
                throw new Error(data.message || 'Failed to save comment');
            }

        } catch (error) {
            console.error(' Error adding comment:', error);
            showNotification('Failed to add comment: ' + error.message, 'error');
        } finally {
            // Restore button state
            const submitBtn = document.querySelector('#commentModal .btn-primary');
            if (submitBtn) {
                submitBtn.innerHTML = 'Add Comment';
                submitBtn.disabled = false;
            }
        }
    }

    // =====================================================
    // IMPROVED: Add Visual Comment Marker
    // =====================================================
    function addVisualCommentMarker(comment, range) {
        try {
            const span = document.createElement('span');
            span.className = 'track-change-comment';
            span.style.cssText = `
            background: rgba(255, 193, 7, 0.2);
            border-bottom: 2px dotted #ffc107;
            cursor: pointer;
            position: relative;
            padding: 2px 0;
        `;

            const commentId = 'comment_' + comment.id;
            span.setAttribute('data-comment-id', commentId);
            span.setAttribute('data-comment-db-id', comment.id);
            span.setAttribute('title', 'Click to view/hide comment');

            // Wrap the selected text
            try {
                range.surroundContents(span);
            } catch (e) {
                console.warn('Could not wrap text, inserting marker instead');
                const marker = document.createElement('span');
                marker.className = 'comment-marker';
                marker.innerHTML = `<i class="ti ti-message-circle" style="color: #ffc107; font-size: 16px; vertical-align: middle;"></i>`;
                marker.setAttribute('data-comment-id', commentId);
                marker.setAttribute('data-comment-db-id', comment.id);
                marker.title = comment.comment_text;
                range.insertNode(marker);
                span = marker; // Use marker as span reference
            }

            // Create comment bubble
            createCommentBubble(span, comment);

        } catch (visualError) {
            console.error('Error adding visual comment:', visualError);
            showNotification('Comment saved but visual indicator failed', 'warning');
        }
    }

    // =====================================================
    // IMPROVED: Create Comment Bubble with Delete Button
    // =====================================================
    function createCommentBubble(parentElement, comment) {
        const commentId = 'comment_' + comment.id;

        // Remove old bubble if exists
        const oldBubble = document.getElementById(commentId);
        if (oldBubble) oldBubble.remove();

        const bubble = document.createElement('div');
        bubble.className = 'comment-bubble';
        bubble.id = commentId;
        bubble.style.cssText = `
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        min-width: 280px;
        max-width: 400px;
        z-index: 10000;
        display: none;
        margin-top: 8px;
    `;

        bubble.innerHTML = `
        <div style="display: flex; align-items: flex-start;">
            <i class="ti ti-user-circle" style="font-size: 24px; color: var(--primary-color); flex-shrink: 0;"></i>
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 2px;">
                    ${comment.user_name}
                </div>
                <div style="font-size: 11px; color: #999;">
                    ${new Date(comment.created_at).toLocaleString()}
                </div>
            </div>
            <button 
                onclick="deleteComment(${comment.id}, '${commentId}')" 
                class="comment-delete-btn"
                style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 6px 10px;
                    cursor: pointer;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    transition: all 0.2s;
                "
                onmouseover="this.style.background='#c82333'"
                onmouseout="this.style.background='#dc3545'"
                title="Delete comment"
            >
                <i class="ti ti-trash" style="font-size: 14px;"></i>
               
            </button>
        </div>
        <div style="font-size: 14px; color: #444; line-height: 1.6; padding: 8px 12px; background: #f8f9fa; border-radius: 8px;">
            ${comment.comment_text}
        </div>
       
    `;

        // Add bubble to parent element
        parentElement.appendChild(bubble);

        //  IMPROVED: Better click handler with proper positioning
        parentElement.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            // Close other bubbles
            closeAllCommentBubbles();

            // Toggle this bubble
            const isHidden = bubble.style.display === 'none';
            bubble.style.display = isHidden ? 'block' : 'none';

            if (isHidden) {
                // Position bubble properly
                positionCommentBubble(bubble, parentElement);
                activeCommentBubble = bubble;

                // Highlight the comment
                parentElement.classList.add('active');
            } else {
                parentElement.classList.remove('active');
                activeCommentBubble = null;
            }
        });
    }

    // =====================================================
    // IMPROVED: Position Comment Bubble Properly
    // =====================================================
    function positionCommentBubble(bubble, parentElement) {
        // Get parent position
        const rect = parentElement.getBoundingClientRect();
        const containerRect = document.getElementById('contractContent').getBoundingClientRect();

        // Reset position
        bubble.style.top = '';
        bubble.style.bottom = '';
        bubble.style.left = '';
        bubble.style.right = '';

        // Calculate available space
        const spaceBelow = window.innerHeight - rect.bottom;
        const spaceAbove = rect.top;

        // Position bubble
        if (spaceBelow > 250 || spaceBelow > spaceAbove) {
            // Show below
            bubble.style.top = '100%';
            bubble.style.bottom = 'auto';
        } else {
            // Show above
            bubble.style.bottom = '100%';
            bubble.style.top = 'auto';
            bubble.style.marginBottom = '8px';
            bubble.style.marginTop = '0';
        }

        // Horizontal positioning
        bubble.style.left = '0';

        // Ensure bubble is visible within viewport
        setTimeout(() => {
            const bubbleRect = bubble.getBoundingClientRect();

            // Adjust if going off right edge
            if (bubbleRect.right > window.innerWidth - 20) {
                bubble.style.left = 'auto';
                bubble.style.right = '0';
            }

            // Adjust if going off left edge
            if (bubbleRect.left < 20) {
                bubble.style.left = '20px';
            }
        }, 10);
    }

    // =====================================================
    // Close All Comment Bubbles
    // =====================================================
    function closeAllCommentBubbles() {
        document.querySelectorAll('.comment-bubble').forEach(bubble => {
            bubble.style.display = 'none';
        });
        document.querySelectorAll('.track-change-comment, .comment-marker').forEach(marker => {
            marker.classList.remove('active');
        });
        activeCommentBubble = null;
    }

    // =====================================================
    // DELETE COMMENT FUNCTION
    // =====================================================
    async function deleteComment(commentId, bubbleId) {
        if (!confirm('Are you sure you want to delete this comment?')) {
            return;
        }

        try {
            const response = await fetch(`/api/contracts/comments/${commentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Failed to delete comment');
            }

            if (data.success) {
                // Remove the visual indicator
                const commentElement = document.querySelector(`[data-comment-db-id="${commentId}"]`);
                if (commentElement) {
                    // If it's a span wrapper, unwrap the text
                    if (commentElement.tagName === 'SPAN' && commentElement.className === 'track-change-comment') {
                        const parent = commentElement.parentNode;
                        while (commentElement.firstChild) {
                            parent.insertBefore(commentElement.firstChild, commentElement);
                        }
                        commentElement.remove();
                    } else {
                        // If it's a marker icon, just remove it
                        commentElement.remove();
                    }
                }

                // Remove the bubble
                const bubble = document.getElementById(bubbleId);
                if (bubble) {
                    bubble.remove();
                }

                showNotification('Comment deleted successfully', 'success');

                // Auto-save the contract
                saveAsDraft();
            } else {
                throw new Error(data.message || 'Failed to delete comment');
            }

        } catch (error) {
            console.error(' Error deleting comment:', error);
            showNotification('Failed to delete comment: ' + error.message, 'error');
        }
    }

    // =====================================================
    // Global Click Handler - Close Bubbles When Clicking Outside
    // =====================================================
    document.addEventListener('click', function (e) {
        // Don't close if clicking inside a comment or bubble
        if (!e.target.closest('.track-change-comment') &&
            !e.target.closest('.comment-marker') &&
            !e.target.closest('.comment-bubble')) {
            closeAllCommentBubbles();
        }
    });

    // =====================================================
    // Load Existing Comments When Page Loads
    // =====================================================
    async function loadExistingComments() {
        try {
            console.log(' Loading comments for contract:', contractId);

            const response = await fetch(`/api/contracts/comments/${contractId}`);
            const data = await response.json();

            if (!data.success || !data.comments.length) {
                console.log('No comments to load');
                return;
            }

            console.log(` Found ${data.comments.length} comments`);

            // For each comment, find or create marker and attach bubble
            data.comments.forEach(comment => {
                let marker = document.querySelector(`[data-comment-db-id="${comment.id}"]`);

                if (!marker) {
                    // Marker doesn't exist, try to recreate
                    marker = findAndWrapText(comment.selected_text, comment.id);
                }

                if (marker) {
                    // Attach bubble to marker
                    createCommentBubble(marker, {
                        id: comment.id,
                        user_name: comment.author,
                        comment_text: comment.comment_text,
                        selected_text: comment.selected_text,
                        created_at: comment.created_at
                    });
                }
            });

            updateCommentCount(data.comments.length);

        } catch (error) {
            console.error(' Error loading comments:', error);
        }
    }



    function findAndWrapText(searchText, commentId) {
        if (!searchText) return null;

        const content = document.getElementById('contractContent');
        if (!content) return null;

        const text = searchText.trim();
        const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT);

        let node;
        while (node = walker.nextNode()) {
            const index = node.textContent.indexOf(text);

            if (index !== -1) {
                try {
                    const range = document.createRange();
                    range.setStart(node, index);
                    range.setEnd(node, index + text.length);

                    const span = document.createElement('span');
                    span.className = 'track-change-comment';
                    span.setAttribute('data-comment-db-id', commentId);
                    span.setAttribute('data-comment-id', 'comment_' + commentId);
                    span.style.cssText = `
                    background: rgba(255, 193, 7, 0.25);
                    border-bottom: 2px solid #ffc107;
                    cursor: pointer;
                    position: relative;
                    padding: 2px 0;
                `;

                    range.surroundContents(span);
                    console.log(` Recreated marker for comment ${commentId}`);
                    return span;

                } catch (e) {
                    console.warn('Could not wrap text:', e);
                }
            }
        }

        return null;
    }



    // Also try on window load (as backup)
    window.addEventListener('load', function () {
        const markers = document.querySelectorAll('[data-comment-db-id]');
        const bubbles = document.querySelectorAll('.comment-bubble');

        if (markers.length > 0 && bubbles.length === 0) {
            console.log(' Found markers but no bubbles, reloading...');
            loadExistingComments();
        }
    });
    // =====================================================
    // Display Comments List (Optional Sidebar)
    // =====================================================
    function displayCommentsList(comments) {
        // Optional: Create a comments sidebar or panel
        console.log('Comments loaded:', comments);

        // You can add a badge showing comment count
        updateCommentCount(comments.length);
    }

    // =====================================================
    // Update Comment Count Badge
    // =====================================================
    function updateCommentCount(count) {
        // Find or create comment count badge
        let badge = document.getElementById('commentCountBadge');
        if (!badge && count > 0) {
            badge = document.createElement('span');
            badge.id = 'commentCountBadge';
            badge.className = 'comment-count-badge';
            badge.style.cssText = `
            background: #fff3cd;
            color: #856404;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        `;

            // Add to toolbar (adjust selector as needed)
            const toolbar = document.querySelector('.toolbar-right, .editor-toolbar');
            if (toolbar) {
                toolbar.insertBefore(badge, toolbar.firstChild);
            }
        }

        if (badge) {
            badge.innerHTML = `<i class="ti ti-message-circle"></i> ${count} Comment${count !== 1 ? 's' : ''}`;
            badge.style.display = count > 0 ? 'inline-flex' : 'none';
        }
    }

    // =====================================================
    // Initialize When Document is Ready
    // =====================================================
   

    // Auto-save functionality
    function startAutoSave() {
        // Clear any existing interval
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }

        // Save every 30 seconds if there are changes
        let lastContent = document.getElementById('contractContent').innerHTML;

        autoSaveInterval = setInterval(async () => {
            const currentContent = document.getElementById('contractContent').innerHTML;

            if (currentContent !== lastContent) {
                await saveAsDraft();
                lastContent = currentContent;
            }
        }, 30000); // 30 seconds
    }

    function updateSaveStatus(status) {
        const statusEl = document.getElementById('saveStatus');
        if (!statusEl) return;

        switch (status) {
            case 'saving':
                statusEl.innerHTML = '<i class="ti ti-loader-2"></i> Saving...';
                statusEl.style.color = 'var(--warning-color)';
                break;
            case 'saved':
                statusEl.innerHTML = '<i class="ti ti-circle-check"></i> Saved';
                statusEl.style.color = 'var(--success-color)';
                break;
            case 'editing':
                statusEl.innerHTML = '<i class="ti ti-pencil"></i> Editing...';
                statusEl.style.color = 'var(--text-muted)';
                break;
            case 'error':
                statusEl.innerHTML = '<i class="ti ti-alert-circle"></i> Save failed';
                statusEl.style.color = 'var(--danger-color)';
                break;
        }
    }

    // Additional Helper Functions
    function insertTable() {
        const rows = prompt('Number of rows:', '3');
        const cols = prompt('Number of columns:', '3');

        if (!rows || !cols) return;

        let table = '<table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">';
        table += '<thead><tr>';
        for (let c = 0; c < parseInt(cols); c++) {
            table += '<th style="border: 1px solid var(--border-color); padding: 0.5rem; background: var(--background-light);">Header ' + (c + 1) + '</th>';
        }
        table += '</tr></thead><tbody>';

        for (let r = 0; r < parseInt(rows); r++) {
            table += '<tr>';
            for (let c = 0; c < parseInt(cols); c++) {
                table += '<td style="border: 1px solid var(--border-color); padding: 0.5rem;">Cell</td>';
            }
            table += '</tr>';
        }
        table += '</tbody></table>';

        document.execCommand('insertHTML', false, table);
        saveAsDraft();
    }

    // Signature Canvas Functions
    function initCanvas() {
        canvas = document.getElementById('signCanvas');
        if (!canvas) return;

        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = 200;

        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch support
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
    }

    function stopDrawing() {
        isDrawing = false;
    }

    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' :
            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }

    function clearCanvas() {
        if (ctx && canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    function switchSignMethod(method) {
        // Get the clicked element - use event.currentTarget or pass it as parameter
        const clickedTab = event ? event.currentTarget : null;

        // Reset all tabs first
        document.querySelectorAll('.signature-tab').forEach(tab => {
            tab.style.color = 'var(--text-muted)';
            tab.style.borderBottom = 'none';
            tab.style.fontWeight = 'normal';
            tab.classList.remove('active');
        });

        // Highlight the active tab
        if (clickedTab) {
            clickedTab.style.color = 'var(--primary-color)';
            clickedTab.style.borderBottom = '3px solid var(--primary-color)';
            clickedTab.style.fontWeight = '600';
            clickedTab.classList.add('active');
        } else {
            // If no event (called programmatically), find the tab by method
            const tabs = document.querySelectorAll('.signature-tab');
            tabs.forEach(tab => {
                const isDrawTab = tab.textContent.includes('Draw');
                const isTypeTab = tab.textContent.includes('Type');

                if ((method === 'draw' && isDrawTab) || (method === 'type' && isTypeTab)) {
                    tab.style.color = 'var(--primary-color)';
                    tab.style.borderBottom = '3px solid var(--primary-color)';
                    tab.style.fontWeight = '600';
                    tab.classList.add('active');
                }
            });
        }

        // Show/hide the appropriate signature input
        document.getElementById('drawSignature').style.display = method === 'draw' ? 'block' : 'none';
        document.getElementById('typeSignature').style.display = method === 'type' ? 'block' : 'none';
    }



    function updateSignaturePreview() {
        const preview = document.getElementById('sigPreview');
        const input = document.getElementById('typedSig');
        preview.textContent = input.value;
    }

    function toggleSignButton() {
        const checkbox = document.getElementById('agreeTerms');
        const button = document.getElementById('signBtn');
        button.disabled = !checkbox.checked;
    }

    async function checkAllSignatures() {
        const clientSigned = document.getElementById('clientSignature')?.classList.contains('signed');
        const providerSigned = document.getElementById('providerSignature')?.classList.contains('signed') ||
            document.getElementById('companySignature')?.classList.contains('signed');

        if (clientSigned && providerSigned) {
            console.log(' Both parties have signed! Checking backend status...');

            // The status should already be 'signed' from the backend
            // Let's verify and update UI accordingly

            // Update the stepper: Signature step is now COMPLETED
            const signatureStep = document.querySelector('.stepper-step:nth-child(5)');
            if (signatureStep) {
                signatureStep.classList.remove('active', 'pending');
                signatureStep.classList.add('completed');
                signatureStep.querySelector('.step-date').textContent = 'Completed';
            }

            // Executed step should now be ACTIVE (ready for execution)
            const executedStep = document.querySelector('.stepper-step:nth-child(6)');
            if (executedStep) {
                executedStep.classList.remove('pending');
                executedStep.classList.add('active');
                executedStep.querySelector('.step-date').textContent = 'Ready';
            }

            // Update progress bar to 83% (signature completed, execution pending)
            const progressBar = document.getElementById('stepperProgress');
            if (progressBar) {
                progressBar.style.width = '83%';
            }

            // Update workflow status
            const statusText = document.getElementById('workflowStatusText');
            if (statusText) {
                statusText.textContent = 'Fully Signed - Ready for Execution';
            }

            showNotification(' All parties have signed! Contract is now ready for execution.', 'success');

            // Reload page to show updated action buttons (Execute Contract button)
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    }

    // Document Upload Functions
    function triggerFileUpload() {
        document.getElementById('fileUpload').click();
    }

    function handleFileSelect(event) {
        const files = Array.from(event.target.files);
        uploadedFiles = uploadedFiles.concat(files);
        displayUploadedFiles();
        document.getElementById('uploadBtn').disabled = false;
    }

    function handleFileDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('dragover');
        const files = Array.from(event.dataTransfer.files);
        uploadedFiles = uploadedFiles.concat(files);
        displayUploadedFiles();
        document.getElementById('uploadBtn').disabled = false;
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('dragover');
    }

    function displayUploadedFiles() {
        const container = document.getElementById('uploadedFiles');
        if (!container) return;

        container.style.display = 'block';
        container.innerHTML = '';

        uploadedFiles.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            fileDiv.innerHTML = `
            <div class="file-name">
                <i class="ti ti-file" style="color: var(--primary-color);"></i>
                <span>${file.name}</span>
                <span style="color: var(--text-muted); font-size: 0.8rem;">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
            </div>
            <button class="remove-file-btn" onclick="removeUploadedFile(${index})" title="Remove file">
                <i class="ti ti-x"></i>
            </button>
        `;
            container.appendChild(fileDiv);
        });
    }

    function removeUploadedFile(index) {
        uploadedFiles.splice(index, 1);
        displayUploadedFiles();

        if (uploadedFiles.length === 0) {
            const container = document.getElementById('uploadedFiles');
            if (container) {
                container.style.display = 'none';
            }
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.disabled = true;
            }
        }
    }

    function uploadDocuments() {
        if (uploadedFiles.length > 0) {
            alert(`Uploading ${uploadedFiles.length} document(s)...`);
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.innerHTML = '<i class="ti ti-loader"></i> Uploading...';
                uploadBtn.disabled = true;
            }

            setTimeout(() => {
                alert('Documents uploaded successfully!');
                uploadedFiles = [];
                const container = document.getElementById('uploadedFiles');
                if (container) {
                    container.style.display = 'none';
                }
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="ti ti-upload"></i> Upload Documents';
                    uploadBtn.disabled = true;
                }
                closeModal('documentsModal');
            }, 2000);
        }
    }

    function viewDocument(docId) {
        alert(`Opening document viewer for: ${docId}`);
    }

    function downloadDocument(docId) {
        alert(`Downloading document: ${docId}`);
    }




    function insertSuggestion(text) {
        const input = document.getElementById('messageInput');
        if (input) {
            input.value = text;
            input.focus();
        }
    }


    // Additional Functions
    function toggleRiskItem(header) {
        const item = header.closest('.risk-item');
        const content = item.querySelector('.risk-item-content');

        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
        } else {
            content.style.display = 'none';
        }
    }

    function exportRiskReport() {
        if (!riskAnalysisData) {
            showNotification('No risk analysis data to export', 'warning');
            return;
        }

        // Create a downloadable report
        const reportContent = `
Risk Analysis Report
Contract: ${contractData?.contract?.title || 'Unknown'}
Date: ${new Date().toLocaleDateString()}

Overall Score: ${riskAnalysisData.overall_score}
High Risks: ${riskAnalysisData.high_risks}
Medium Risks: ${riskAnalysisData.medium_risks}
Low Risks: ${riskAnalysisData.low_risks}

Detailed Findings:
${(riskAnalysisData.risk_items || []).map(item => `
- ${item.issue} (${item.severity})
  ${item.description}
  Recommendation: ${item.recommendation}
`).join('\n')}
    `;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `risk_analysis_${contractId}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification('Risk report exported', 'success');
    }

    function applyRiskMitigation() {
        if (!riskAnalysisData || !riskAnalysisData.risk_items) {
            showNotification('No risk mitigation available', 'warning');
            return;
        }

        if (confirm('Apply AI-suggested risk mitigation to the contract? This will modify the contract content.')) {
            // Apply suggestions to contract
            let contentModified = false;
            const content = document.getElementById('contractContent');

            riskAnalysisData.risk_items.forEach(risk => {
                if (risk.severity === 'high' && risk.recommendation) {
                    // This is simplified - in production, apply specific changes
                    contentModified = true;
                    showNotification(`Applied mitigation for: ${risk.issue}`, 'info');
                }
            });

            if (contentModified) {
                saveAsDraft();
                showNotification('Risk mitigation applied successfully', 'success');
            }

            closeModal('riskAnalysisModal');
        }
    }

    // Workflow Functions
    function selectContractWorkflow(type) {
        console.log(' Selecting workflow type:', type);

        document.getElementById('masterWorkflowOption').classList.remove('selected');
        document.getElementById('customWorkflowOption').classList.remove('selected');

        if (type === 'master') {
            document.getElementById('masterWorkflowOption').classList.add('selected');
            document.getElementById('customWorkflowConfig').style.display = 'none';
        } else {
            document.getElementById('customWorkflowOption').classList.add('selected');
            document.getElementById('customWorkflowConfig').style.display = 'block';

            // Add default step if table is empty
            const tbody = document.getElementById('contractWorkflowSteps');
            if (tbody && tbody.children.length === 0) {
                console.log(' Adding default step');
                addContractWorkflowStep();
            }
        }

        selectedContractWorkflow = type;
        document.getElementById('saveWorkflowBtn').disabled = false;
    }

    function addContractWorkflowStep() {
        contractWorkflowStepCount++;
        const tbody = document.getElementById('contractWorkflowSteps');
        const newRow = document.createElement('tr');

        const uniqueId = `emailInput_${Date.now()}_${contractWorkflowStepCount}`;
        const suggestionsId = `suggestions_${Date.now()}_${contractWorkflowStepCount}`;

        newRow.innerHTML = `
        <td style="padding: 0.75rem;">
            <span style="width: 28px; height: 28px; background: var(--primary-color); color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600;">${contractWorkflowStepCount}</span>
        </td>
        <td style="padding: 0.75rem;">
            <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                <option value="">Select Role</option>
                <option value="reviewer">Reviewer</option>
                <option value="approver">Approver</option>
                <option value="e-sign">E-Sign</option>
                <option value="counter-party">Counter-Party</option>
            </select>
        </td>
        <td style="padding: 0.75rem; position: relative;">
            <input type="email" 
                id="${uniqueId}"
                placeholder="Type to search users..." 
                oninput="searchWorkflowUsers(this, '${suggestionsId}')"
                onfocus="searchWorkflowUsers(this, '${suggestionsId}')"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
            <div id="${suggestionsId}" class="email-suggestions" style="display: none;"></div>
        </td>
        <td style="padding: 0.75rem;">
            <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                <option value="">Select Department</option>
                <option value="Legal">Legal</option>
                <option value="Finance">Finance</option>
                <option value="Operations">Operations</option>
                <option value="Executive">Executive</option>
                <option value="Technical">Technical</option>
                <option value="Commercial">Commercial</option>
            </select>
        </td>
        <td style="padding: 0.75rem; text-align: center;">
            <button onclick="removeContractWorkflowStep(this)" 
                style="background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0.25rem 0.5rem;">
                <i class="ti ti-trash" style="font-size: 1.125rem;"></i>
            </button>
        </td>
    `;

        tbody.appendChild(newRow);
    }


    function removeContractWorkflowStep(button) {
        const tbody = document.getElementById('contractWorkflowSteps');
        const rows = tbody.querySelectorAll('tr');

        if (rows.length > 1) {
            button.closest('tr').remove();
            updateContractStepNumbers();
        } else {
            alert('At least one workflow step is required.');
        }
    }

    function updateContractStepNumbers() {
        const tbody = document.getElementById('contractWorkflowSteps');
        const rows = tbody.querySelectorAll('tr');

        rows.forEach((row, index) => {
            const stepSpan = row.querySelector('span');
            if (stepSpan) {
                stepSpan.textContent = index + 1;
            }
        });

        contractWorkflowStepCount = rows.length;
    }


    async function openWorkflowSetupModal() {
        console.log(' Opening workflow modal for contract:', contractId);

        const modal = document.getElementById('contractWorkflowModal');
        if (!modal) {
            console.error(' Modal not found: contractWorkflowModal');
            return;
        }

        // Show the modal first
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Then load the data
        await loadExistingWorkflow();
    }




    async function loadExistingWorkflow() {
        if (!contractId) {
            console.log(' No contract ID, skipping workflow load');
            return;
        }

        console.log(' Loading workflow for contract:', contractId);
        showLoader();

        //  FIX: Clear the table FIRST before loading anything
        const tbody = document.getElementById('contractWorkflowSteps');
        if (tbody) {
            tbody.innerHTML = '';  //  Clear all existing rows!
            contractWorkflowStepCount = 0;  // Reset counter
        }

        try {
            const response = await fetch(`/api/contracts/workflow/${contractId}`);
            const data = await response.json();

            console.log(' Workflow API response:', data);

            if (data.success && data.workflow) {
                const workflow = data.workflow;
                console.log(' Workflow loaded:', workflow);
                console.log(' Steps:', workflow.steps);

                // Check if it's a master workflow or custom workflow
                if (workflow.is_master) {
                    console.log(' Loading MASTER workflow');
                    selectContractWorkflow('master');

                    if (workflow.steps && workflow.steps.length > 0) {
                        updateMasterWorkflowPreview(workflow.steps);
                    }

                    showNotification(` Master Workflow: ${workflow.workflow_name}`, 'success');
                } else {
                    console.log(' Loading CUSTOM workflow');
                    selectContractWorkflow('custom');

                    if (workflow.steps && workflow.steps.length > 0) {
                        console.log(` Populating ${workflow.steps.length} custom steps`);
                        populateCustomWorkflowSteps(workflow.steps);
                    } else {
                        console.log(' No steps found, adding empty row');
                        addContractWorkflowStep();  // Only adds 1 row because table is cleared above
                    }

                    showNotification(` Custom Workflow: ${workflow.workflow_name}`, 'success');
                }

                // Update status text
                const statusEl = document.getElementById('workflowStatusText');
                if (statusEl) {
                    statusEl.textContent = workflow.status || 'Active';
                }
            } else {
                console.log(' No workflow found for this contract');
                // Reset to default
                resetWorkflowModal();
            }
        } catch (error) {
            console.error(' Error loading workflow:', error);
            showNotification('Could not load workflow', 'warning');
        } finally {
            hideLoader();
        }
    }
    // STEP 3: ADD this NEW function (resetWorkflowModal)
    function resetWorkflowModal() {
        console.log(' Resetting workflow modal to default state');

        // Clear selections
        document.getElementById('masterWorkflowOption').classList.remove('selected');
        document.getElementById('customWorkflowOption').classList.remove('selected');
        document.getElementById('customWorkflowConfig').style.display = 'none';

        // Clear the table
        const tbody = document.getElementById('contractWorkflowSteps');
        if (tbody) {
            tbody.innerHTML = '';
        }
        contractWorkflowStepCount = 0;

        // Reset selection
        selectedContractWorkflow = null;
        document.getElementById('saveWorkflowBtn').disabled = true;
    }

    // STEP 4: ADD this NEW function (updateMasterWorkflowPreview)
    function updateMasterWorkflowPreview(steps) {
        console.log(' Updating master workflow preview with', steps.length, 'steps');

        const previewContainer = document.querySelector('#masterWorkflowOption .workflow-step-preview');
        if (!previewContainer) {
            console.warn(' Preview container not found');
            return;
        }

        let previewHTML = '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; flex-wrap: wrap;">';

        steps.forEach((step, index) => {
            const stepName = step.step_name || step.assignee_role || 'Review';
            const userCount = step.users ? step.users.length : 0;

            console.log(`  Step ${index + 1}: ${stepName} (${userCount} users)`);

            previewHTML += `
            <span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">${index + 1}</span>
            <span>${stepName}${userCount > 0 ? ` (${userCount})` : ''}</span>
        `;

            if (index < steps.length - 1) {
                previewHTML += '<i class="ti ti-arrow-right" style="color: var(--text-muted);"></i>';
            }
        });

        previewHTML += '</div>';
        previewContainer.innerHTML = previewHTML;
        console.log(' Master workflow preview updated');
    }



    function populateCustomWorkflowSteps(steps) {
        const tbody = document.getElementById('contractWorkflowSteps');
        if (!tbody) {
            console.error(' contractWorkflowSteps tbody not found');
            return;
        }

        // Clear existing rows
        tbody.innerHTML = '';
        contractWorkflowStepCount = 0;

        console.log(` Populating ${steps.length} workflow steps`);

        steps.forEach((step, stepIndex) => {
            console.log(`Step ${stepIndex + 1}:`, step);

            if (step.users && step.users.length > 0) {
                // Create a row for each user in this step
                step.users.forEach((user, userIndex) => {
                    contractWorkflowStepCount++;
                    console.log(`   User ${userIndex + 1}: ${user.email}`);
                    addWorkflowStepRow(step, user, contractWorkflowStepCount);
                });
            } else {
                // No users assigned, create empty row
                contractWorkflowStepCount++;
                console.log(`   No users for step ${stepIndex + 1}`);
                addWorkflowStepRow(step, null, contractWorkflowStepCount);
            }
        });

        // Show custom workflow config
        document.getElementById('customWorkflowConfig').style.display = 'block';
        console.log(` Populated ${contractWorkflowStepCount} workflow rows`);
    }

    function addWorkflowStepRow(step, user, rowNumber) {
        const tbody = document.getElementById('contractWorkflowSteps');
        const newRow = document.createElement('tr');

        // Extract values
        const stepType = step.step_type || step.assignee_role || '';
        const userEmail = user ? user.email : '';
        const department = step.department || '';

        console.log(` Adding row ${rowNumber}:`, {
            stepType: stepType,
            userEmail: userEmail,
            department: department
        });

        const uniqueId = `emailInput_${Date.now()}_${rowNumber}`;
        const suggestionsId = `suggestions_${Date.now()}_${rowNumber}`;

        newRow.innerHTML = `
        <td style="padding: 0.75rem;">
            <span style="width: 28px; height: 28px; background: var(--primary-color); color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600;">${rowNumber}</span>
        </td>
        <td style="padding: 0.75rem;">
            <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                <option value="">Select Role</option>
                <option value="reviewer" ${stepType === 'reviewer' ? 'selected' : ''}>Reviewer</option>
                <option value="approver" ${stepType === 'approver' ? 'selected' : ''}>Approver</option>
                <option value="e-sign" ${stepType === 'e-sign' ? 'selected' : ''}>E-Sign</option>
                <option value="counter-party" ${stepType === 'counter-party' ? 'selected' : ''}>Counter-Party</option>
            </select>
        </td>
        <td style="padding: 0.75rem; position: relative;">
            <input type="email" 
                id="${uniqueId}"
                placeholder="Type to search users..." 
                value="${userEmail}"
                oninput="searchWorkflowUsers(this, '${suggestionsId}')"
                onfocus="searchWorkflowUsers(this, '${suggestionsId}')"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
            <div id="${suggestionsId}" class="email-suggestions" style="display: none;"></div>
        </td>
        <td style="padding: 0.75rem;">
            <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                <option value="">Select Department</option>
                <option value="Legal" ${department === 'Legal' ? 'selected' : ''}>Legal</option>
                <option value="Finance" ${department === 'Finance' ? 'selected' : ''}>Finance</option>
                <option value="Operations" ${department === 'Operations' ? 'selected' : ''}>Operations</option>
                <option value="Executive" ${department === 'Executive' ? 'selected' : ''}>Executive</option>
                <option value="Technical" ${department === 'Technical' ? 'selected' : ''}>Technical</option>
                <option value="Commercial" ${department === 'Commercial' ? 'selected' : ''}>Commercial</option>
            </select>
        </td>
        <td style="padding: 0.75rem; text-align: center;">
            <button onclick="removeContractWorkflowStep(this)" 
                style="background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0.25rem 0.5rem;">
                <i class="ti ti-trash" style="font-size: 1.125rem;"></i>
            </button>
        </td>
    `;

        tbody.appendChild(newRow);

        console.log(` Row ${rowNumber} added with email="${userEmail}" dept="${department}"`);
    }
    // STEP 7: ADD this NEW function (removeWorkflowStepRow)
    function removeWorkflowStepRow(button) {
        const tbody = document.getElementById('contractWorkflowSteps');
        if (tbody.children.length > 1) {
            button.closest('tr').remove();
            updateWorkflowStepNumbers();
        } else {
            alert('At least one workflow step is required.');
        }
    }

    // STEP 8: ADD this NEW function (updateWorkflowStepNumbers)
    function updateWorkflowStepNumbers() {
        const rows = document.querySelectorAll('#contractWorkflowSteps tr');
        rows.forEach((row, index) => {
            const stepSpan = row.querySelector('span');
            if (stepSpan) {
                stepSpan.textContent = index + 1;
            }
        });
        contractWorkflowStepCount = rows.length;
        console.log(' Step numbers updated, total:', contractWorkflowStepCount);
    }




    // Search users function
    async function searchWorkflowUsers(input, suggestionsId) {
        const query = input.value.trim();
        const suggestionsDiv = document.getElementById(suggestionsId);

        currentSearchInput = input;

        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        if (!query) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                suggestionsDiv.innerHTML = `
                <div style="padding: 0.75rem; text-align: center; color: var(--text-muted);">
                    <i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> Searching...
                </div>
            `;
                suggestionsDiv.style.display = 'block';

                const response = await fetch(`/api/users/company?search=${encodeURIComponent(query)}&limit=10`);

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const data = await response.json();
                const users = data.users || [];

                if (users.length === 0) {
                    suggestionsDiv.innerHTML = `
                    <div style="padding: 0.75rem; text-align: center; color: var(--text-muted);">
                        <i class="ti ti-user-x"></i> No users found
                    </div>
                `;
                } else {
                    suggestionsDiv.innerHTML = users.map(user => {
                        const fullName = `${user.first_name} ${user.last_name}`.trim();
                        const badge = user.user_type ? `<span style="font-size: 0.75rem; padding: 0.125rem 0.375rem; background: var(--primary-color); color: white; border-radius: 4px; margin-left: 0.25rem;">${user.user_type}</span>` : '';

                        return `
                        <div onclick="selectWorkflowUser('${user.email}', '${input.id}', '${suggestionsId}')" 
                            style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;"
                            onmouseover="this.style.background='var(--background-light)'"
                            onmouseout="this.style.background='white'">
                            <div style="font-weight: 600; color: var(--text-color);">
                                ${fullName} ${badge}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                ${user.email}
                            </div>
                        </div>
                    `;
                    }).join('');
                }
            } catch (error) {
                console.error('Search error:', error);
                suggestionsDiv.innerHTML = `
                <div style="padding: 0.75rem; text-align: center; color: var(--danger-color);">
                    <i class="ti ti-alert-circle"></i> Search failed
                </div>
            `;
            }
        }, 300);
    }

    // Select user from suggestions
    function selectWorkflowUser(email, inputId, suggestionsId) {
        const input = document.getElementById(inputId);
        const suggestionsDiv = document.getElementById(suggestionsId);

        if (input) {
            input.value = email;
        }

        if (suggestionsDiv) {
            suggestionsDiv.style.display = 'none';
        }
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', function (e) {
        const suggestions = document.querySelectorAll('.email-suggestions');
        suggestions.forEach(div => {
            if (!div.contains(e.target) && !e.target.classList.contains('email-search-input')) {
                div.style.display = 'none';
            }
        });
    });


    // Update master workflow preview with actual steps

    function updateMasterWorkflowPreview(steps) {
        const previewContainer = document.querySelector('#masterWorkflowOption .workflow-step-preview');
        if (!previewContainer) {
            console.warn('Preview container not found');
            return;
        }

        let previewHTML = '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; flex-wrap: wrap;">';

        steps.forEach((step, index) => {
            const stepName = step.step_name || step.assignee_role || 'Review';
            const userCount = step.users ? step.users.length : 0;

            previewHTML += `
            <span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">${index + 1}</span>
            <span>${stepName}${userCount > 0 ? ` (${userCount})` : ''}</span>
        `;

            if (index < steps.length - 1) {
                previewHTML += '<i class="ti ti-arrow-right" style="color: var(--text-muted);"></i>';
            }
        });

        previewHTML += '</div>';
        previewContainer.innerHTML = previewHTML;
        console.log(' Master workflow preview updated');
    }


    // Populate custom workflow steps table
    function populateCustomWorkflowSteps(steps) {
        const tbody = document.getElementById('contractWorkflowSteps');
        if (!tbody) {
            console.error('contractWorkflowSteps tbody not found');
            return;
        }

        // Clear existing rows
        tbody.innerHTML = '';

        // Reset counter
        contractWorkflowStepCount = 0;

        console.log(' Populating custom workflow with', steps.length, 'steps');

        // Add each step - if step has multiple users, create one row per user
        steps.forEach((step, stepIndex) => {
            console.log(`Step ${stepIndex + 1}:`, step);

            if (step.users && step.users.length > 0) {
                // Create a row for each user in this step
                step.users.forEach((user, userIndex) => {
                    contractWorkflowStepCount++;
                    addWorkflowStepRow(step, user, contractWorkflowStepCount);
                });
            } else {
                // No users assigned, create empty row
                contractWorkflowStepCount++;
                addWorkflowStepRow(step, null, contractWorkflowStepCount);
            }
        });

        // Show custom workflow config
        document.getElementById('customWorkflowConfig').style.display = 'block';
        console.log(' Custom workflow populated with', contractWorkflowStepCount, 'rows');
    }


    function addWorkflowStepRow(step, user, rowNumber) {
        const tbody = document.getElementById('contractWorkflowSteps');
        const newRow = document.createElement('tr');

        // Determine values
        const stepType = step.step_type || step.assignee_role || '';
        const userEmail = user ? user.email : '';
        const department = step.department || '';

        console.log(`  Row ${rowNumber}: role=${stepType}, email=${userEmail}, dept=${department}`);

        newRow.innerHTML = `
        <td style="padding: 0.75rem;">
            <span style="width: 28px; height: 28px; background: var(--primary-color); color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600;">${rowNumber}</span>
        </td>
        <td style="padding: 0.75rem;">
            <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                <option value="">Select Role</option>
                <option value="reviewer" ${stepType === 'reviewer' ? 'selected' : ''}>Reviewer</option>
                <option value="approver" ${stepType === 'approver' ? 'selected' : ''}>Approver</option>
                <option value="e-sign" ${stepType === 'e-sign' ? 'selected' : ''}>E-Sign</option>
                <option value="counter-party" ${stepType === 'counter-party' ? 'selected' : ''}>Counter-Party</option>
            </select>
        </td>
        <td style="padding: 0.75rem;">
            <input type="email" 
                placeholder="Enter email address" 
                value="${userEmail}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
        </td>
        <td style="padding: 0.75rem;">
            <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem;">
                <option value="">Select Department</option>
                <option value="Legal" ${department === 'Legal' ? 'selected' : ''}>Legal</option>
                <option value="Finance" ${department === 'Finance' ? 'selected' : ''}>Finance</option>
                <option value="Operations" ${department === 'Operations' ? 'selected' : ''}>Operations</option>
                <option value="Executive" ${department === 'Executive' ? 'selected' : ''}>Executive</option>
                <option value="Technical" ${department === 'Technical' ? 'selected' : ''}>Technical</option>
                <option value="Commercial" ${department === 'Commercial' ? 'selected' : ''}>Commercial</option>
            </select>
        </td>
        <td style="padding: 0.75rem; text-align: center;">
            <button onclick="this.closest('tr').remove(); updateStepNumbers();" 
                style="background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0.25rem 0.5rem;"
                title="Remove this step">
                <i class="ti ti-trash" style="font-size: 1.125rem;"></i>
            </button>
        </td>
    `;

        tbody.appendChild(newRow);
    }


    function updateStepNumbers() {
        const rows = document.querySelectorAll('#contractWorkflowSteps tr');
        rows.forEach((row, index) => {
            const stepNumber = row.querySelector('span');
            if (stepNumber) {
                stepNumber.textContent = index + 1;
            }
        });
        contractWorkflowStepCount = rows.length;
    }




    function navigateToStep(step) {
        showNotification(`Navigating to ${step} phase`, 'info');
    }

    function viewAsCounterParty() {
        window.location.href = `/contract/counter-party-edit/${contractId}`;
    }

    function execCmd(command, value) {
        document.execCommand(command, false, value || null);
        saveAsDraft();
    }

    // Utility Functions
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    }


    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';

            //  If closing workflow modal, reset it
            if (modalId === 'contractWorkflowModal') {
                // Don't reset completely, just clear table to prevent duplicates
                const tbody = document.getElementById('contractWorkflowSteps');
                if (tbody) {
                    tbody.innerHTML = '';
                }
                contractWorkflowStepCount = 0;
            }
        }
    }

    function showLoader() {
        const loader = document.getElementById('loadingOverlay');
        if (loader) {
            loader.classList.add('show');
        }
    }

    function hideLoader() {
        const loader = document.getElementById('loadingOverlay');
        if (loader) {
            loader.classList.remove('show');
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const colors = {
            success: 'var(--success-color)',
            error: 'var(--danger-color)',
            info: 'var(--primary-color)',
            warning: 'var(--warning-color)'
        };

        const icons = {
            success: 'check',
            error: 'alert-circle',
            info: 'info-circle',
            warning: 'alert-triangle'
        };

        notification.style.cssText = `
        position: fixed; top: 20px; right: 20px;
        background: ${colors[type] || colors.info};
        color: white; padding: 1rem 1.5rem; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
        notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="ti ti-${icons[type] || icons.info}"></i>
            ${message}
        </div>
    `;
        document.body.appendChild(notification);

        setTimeout(() => notification.remove(), 4000);
    }

    function showError(message) {
        document.getElementById('contractEditor').innerHTML = `
        <div style="padding: 3rem; text-align: center;">
            <i class="ti ti-alert-circle" style="font-size: 4rem; color: var(--danger-color);"></i>
            <h2 style="margin-top: 1rem; color: var(--text-color);">Error Loading Contract</h2>
            <p style="color: var(--text-muted); margin: 1rem 0;">${message}</p>
            <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 1rem;">
                <i class="ti ti-refresh"></i> Retry
            </button>
        </div>
    `;
        document.getElementById('contractEditor').classList.add('loaded');
        document.getElementById('contractEditor').style.display = 'block';
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', function (e) {
        // Check if there are unsaved changes
        const currentContent = document.getElementById('contractContent')?.innerHTML || '';
        if (currentContent && currentContent !== originalContent) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    // Cleanup intervals on page unload
    window.addEventListener('unload', function () {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });

    // =====================================================
    // SEND TO COUNTER-PARTY FUNCTIONS
    // =====================================================

    // Open Send to Counter-Party Modal
    function openSendToCounterPartyModal() {
        openModal('sendToCounterPartyModal');
    }

    // Submit Send to Counter-Party - CONNECTED TO BACKEND
    async function submitSendToCounterParty() {
        const email = document.getElementById('counterPartyEmail')?.value.trim();
        const message = document.getElementById('counterPartyMessage')?.value.trim() || '';

        if (!email) {
            showNotification('Please enter a counter-party email address', 'error');
            return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNotification('Please enter a valid email address', 'error');
            return;
        }

        showLoader();
        try {
            const response = await fetch('/api/contracts/send-to-counterparty', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: contractId,
                    counterparty_email: email,
                    counterparty_user_id: selectedCounterPartyEmail ? selectedCounterPartyEmail.userId : null,
                    counterparty_company_id: selectedCounterPartyEmail ? selectedCounterPartyEmail.companyId : null,
                    counterparty_company_name: selectedCounterPartyEmail ? selectedCounterPartyEmail.companyName : null,
                    message: message
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Contract sent to counter-party successfully!', 'success');
                closeModal('sendToCounterPartyModal');
                document.getElementById('counterPartyEmail').value = '';
                document.getElementById('counterPartyMessage').value = '';
                selectedCounterPartyEmail = null;
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.message || 'Failed to send contract to counter-party', 'error');
            }
        } catch (error) {
            console.error('Error sending to counter-party:', error);
            showNotification('Failed to send contract to counter-party', 'error');
        } finally {
            hideLoader();
        }
    }
    // =====================================================
    // COUNTER-PARTY ACTION FUNCTIONS (for negotiation stage)
    // =====================================================

    // Quick Approve - CONNECTED TO BACKEND
    async function quickApprove() {
        if (confirm('Are you sure you want to approve this contract as-is? The initiator will be notified immediately.')) {
            showLoader();
            try {
                const response = await fetch('/api/contracts/quick-approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contract_id: contractId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Contract approved successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification(data.message || 'Failed to approve contract', 'error');
                }
            } catch (error) {
                console.error('Error approving contract:', error);
                showNotification('Failed to approve contract', 'error');
            } finally {
                hideLoader();
            }
        }
    }

    // Open Negotiation Modal
    function openNegotiationModal() {
        openModal('negotiationModal');
    }

    // Open Documents Modal
    function openDocumentsModal() {
        openModal('documentsModal');
    }



    // =====================================================
    // EXECUTE CONTRACT FUNCTIONS
    // =====================================================

    // Open Execute Contract Modal - Only shown when contract is 'signed'
    function openExecuteContractModal() {
        // Verify contract is in signed status
        if (contractData?.contract?.status !== 'signed') {
            showNotification('Contract must be fully signed before execution', 'error');
            return;
        }

        // Update execution dates in modal
        const today = new Date();
        document.getElementById('executionDate').textContent = today.toLocaleDateString();
        document.getElementById('effectiveDate').textContent = today.toLocaleDateString();

        // Reset checkbox
        document.getElementById('confirmExecution').checked = false;
        document.getElementById('executeContractBtn').disabled = true;

        openModal('executeContractModal');
    }

    // Toggle Execute Button based on confirmation checkbox
    function toggleExecuteButton() {
        const checkbox = document.getElementById('confirmExecution');
        const button = document.getElementById('executeContractBtn');
        button.disabled = !checkbox.checked;
    }


    async function saveContract() {
        try {
            console.log(' Saving contract...');

            // Show loading
            document.getElementById('loadingOverlay')?.classList.add('show');

            // Get all contract data
            const contractData = {
                content: getContractContent(),
                // ... other fields
            };

            // Save contract
            const response = await fetch(`/api/contracts/save-draft/${contractId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: JSON.stringify(contractData)
            });

            const result = await response.json();

            // Hide loading
            document.getElementById('loadingOverlay')?.classList.remove('show');

            console.log(' Save result:', result);

            if (result.success) {
                //  ADD THIS: Display blockchain activities
                if (result.blockchain_activities && result.blockchain_activities.length > 0) {
                    console.log(' Displaying', result.blockchain_activities.length, 'blockchain activities');
                    displayBlockchainActivities(result.blockchain_activities);
                } else {
                    console.warn(' No blockchain activities returned');
                    console.log('Full response:', result);
                }

                showNotification(' Contract saved and secured on blockchain', 'success');
            } else {
                showNotification(' Failed to save contract', 'error');
            }

        } catch (error) {
            console.error(' Error:', error);
            document.getElementById('loadingOverlay')?.classList.remove('show');
            showNotification(' Error: ' + error.message, 'error');
        }
    }

    async function markCounterpartyReviewComplete() {
        if (!confirm('Do you want to confirm review?')) {
            return;
        }

        try {
            showLoader('Completing counterparty review...');

            const response = await fetch(
                `/api/contracts/${contractId}/complete-counterparty-review`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                }
            );

            const data = await response.json();

            if (data.success) {
                showNotification('Review completed successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showError(data.message);
            }
        } catch (error) {
            showError('Failed to complete review');
        } finally {
            hideLoader();
        }
    }

    // Execute Contract - CONNECTED TO BACKEND
    async function executeContract() {
        if (!confirm('Are you sure you want to execute this contract? This action will mark the contract as officially active and enforceable.')) {
            return;
        }

        showLoader();
        try {
            const response = await fetch('/api/contracts/execute-contract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contract_id: parseInt(contractId)
                })
            });

            const data = await response.json();

            if (data.success) {
                closeModal('executeContractModal');

                showNotification(' Contract executed successfully!', 'success');

                // Update UI immediately
                updateUIForExecutedStatus();

                // Show Certificate of Completion
                setTimeout(() => {
                    displayCertificateOfCompletion(data.certificate_data);
                }, 1000);

                // Reload page after showing certificate
                setTimeout(() => {
                    location.reload();
                }, 5000);
            } else {
                showNotification(data.detail || 'Failed to execute contract', 'error');
            }
        } catch (error) {
            console.error('Error executing contract:', error);
            showNotification('Failed to execute contract', 'error');
        } finally {
            hideLoader();
        }
    }

    // Update UI for Executed Status
    function updateUIForExecutedStatus() {
        // Update workflow stepper - mark all steps as completed
        const steps = document.querySelectorAll('.stepper-step');
        steps.forEach(step => {
            step.classList.remove('active', 'pending');
            step.classList.add('completed');
            const dateEl = step.querySelector('.step-date');
            if (dateEl) dateEl.textContent = 'Completed';
        });

        // Update progress bar to 100%
        const progressBar = document.getElementById('stepperProgress');
        if (progressBar) progressBar.style.width = '100%';

        // Update workflow status text
        const statusText = document.getElementById('workflowStatusText');
        if (statusText) statusText.textContent = 'Fully Executed';

        // Update page header if present
        const pageDescription = document.querySelector('.page-description');
        if (pageDescription) {
            pageDescription.innerHTML += ' <span style="color: var(--success-color); font-weight: 600;">- EXECUTED</span>';
        }
    }

    // Display Certificate of Completion
    function displayCertificateOfCompletion(certificateData) {
        const content = document.getElementById('certificateContent');

        const executionDate = new Date(certificateData.execution_date).toLocaleString();
        const signedDate = certificateData.signed_date ? new Date(certificateData.signed_date).toLocaleString() : 'N/A';

        content.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto; padding: 2rem; background: white; border: 2px solid var(--success-color); border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
            <!-- Certificate Header -->
            <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 3px solid var(--success-color);">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--success-color), #20c997); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2.5rem;">
                    <i class="ti ti-certificate"></i>
                </div>
                <h2 style="margin: 0; color: var(--success-color); font-size: 1.75rem;">Certificate of Completion</h2>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.95rem;">Contract Execution Verification</p>
            </div>
            
            <!-- Contract Details -->
            <div style="background: var(--background-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text-color);">Contract Information</h4>
                <div style="display: grid; gap: 0.75rem; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted); font-weight: 500;">Contract Number:</span>
                        <strong>${certificateData.contract_number || 'N/A'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted); font-weight: 500;">Contract Title:</span>
                        <strong>${certificateData.contract_title || 'N/A'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted); font-weight: 500;">Signed Date:</span>
                        <strong>${signedDate}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                        <span style="color: var(--text-muted); font-weight: 500;">Execution Date:</span>
                        <strong style="color: var(--success-color);">${executionDate}</strong>
                    </div>
                </div>
            </div>
            
            <!-- Signatories -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text-color);">Authorized Signatories</h4>
                ${certificateData.signatories.map((sig, index) => `
                    <div style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.25rem; flex-shrink: 0;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-color);">${sig.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <span style="text-transform: capitalize;">${sig.signer_type}</span>  
                                Signed: ${sig.signed_at ? new Date(sig.signed_at).toLocaleString() : 'N/A'}
                            </div>
                            ${sig.ip_address ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">IP: ${sig.ip_address}</div>` : ''}
                        </div>
                        <i class="ti ti-circle-check" style="font-size: 1.5rem; color: var(--success-color);"></i>
                    </div>
                `).join('')}
            </div>
            
            <!-- Verification Statement -->
            <div style="background: rgba(40, 167, 69, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--success-color); margin-bottom: 1.5rem;">
                <p style="margin: 0; font-size: 0.95rem; line-height: 1.6; color: var(--text-secondary);">
                    <strong>This certifies that</strong> the above-referenced contract has been executed by all authorized parties and is now legally binding and enforceable. All signatures have been verified and the contract is active as of the execution date stated above.
                </p>
            </div>
            
            <!-- Footer -->
            <div style="text-align: center; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                    Executed by: <strong>${certificateData.executed_by || 'System'}</strong>
                </p>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--text-muted);">
                    Certificate ID: CERT-${certificateData.contract_id}-${Date.now()}
                </p>
            </div>
        </div>
    `;

        openModal('certificateModal');
    }

    // Download Certificate
    async function downloadCertificate() {
        try {
            const response = await fetch(`/api/contracts/execution-certificate/${contractId}`);
            const data = await response.json();

            if (data.success) {
                // Generate PDF or download certificate
                const certificateJson = JSON.stringify(data.certificate, null, 2);
                const blob = new Blob([certificateJson], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Certificate_of_Completion_${contractId}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showNotification('Certificate downloaded successfully', 'success');
            } else {
                showNotification('Failed to download certificate', 'error');
            }
        } catch (error) {
            console.error('Error downloading certificate:', error);
            showNotification('Failed to download certificate', 'error');
        }
    }

    // View Certificate - Can be called anytime for executed contracts
    async function viewExecutionCertificate() {
        showLoader();
        try {
            const response = await fetch(`/api/contracts/execution-certificate/${contractId}`);
            const data = await response.json();

            if (data.success) {
                displayCertificateOfCompletion(data.certificate);
            } else {
                showNotification('Certificate not found', 'error');
            }
        } catch (error) {
            console.error('Error viewing certificate:', error);
            showNotification('Failed to load certificate', 'error');
        } finally {
            hideLoader();
        }
    }


</script>


<!-- Add this before </body> -->
<script src="/static/js/blockchain-verification.js"></script>

<script>
    // Get contract ID from URL or form


    // Set contract ID when page loads
    document.addEventListener('DOMContentLoaded', function () {

        if (contractId) {
            const indicator = document.getElementById('blockchain-indicator');
            if (indicator) {
                indicator.id = `blockchain-indicator-${contractId}`;
                indicator.setAttribute('data-contract-id', contractId);
            }

            // Auto-verify after 1 second
            setTimeout(() => {
                verifyContract(contractId);
            }, 1000);


             if (typeof contractId !== 'undefined' && contractId) {
            // Wait a bit for content to load
            setTimeout(() => {
                loadExistingComments();
            }, 500);
        }
        }
    });


    window.refreshComments = function() {
    console.log(' Manually refreshing comments...');
    
    // Remove old bubbles
    document.querySelectorAll('.comment-bubble').forEach(b => b.remove());
    
    // Reload
    loadExistingComments();
};

    // Wrapper function for verify button
    function verifyContractNow() {

        if (contractId) {
            verifyContract(contractId);
        } else {
            alert('Contract ID not found. Please save the contract first.');
        }
    }

    // Wrapper function for certificate button
    function showBlockchainCertificate() {
        if (contractId) {
            // Call the function from blockchain-verification.js
            showBlockchainCertificateById(contractId);
        } else {
            alert('Contract ID not found. Please save the contract first.');
        }
    }

    // Get contract content for hashing
    function getContractContent() {
        const contractNumber = document.getElementById('contract_number')?.value ||
            document.querySelector('[name="contract_number"]')?.value || '';
        const contractTitle = document.getElementById('contract_title')?.value ||
            document.querySelector('[name="contract_title"]')?.value || '';
        const contractType = document.getElementById('contract_type')?.value ||
            document.querySelector('[name="contract_type"]')?.value || '';
        const contractValue = document.getElementById('contract_value')?.value ||
            document.querySelector('[name="contract_value"]')?.value || '';
        const startDate = document.getElementById('start_date')?.value || '';
        const endDate = document.getElementById('end_date')?.value || '';

        return `${contractNumber}|${contractTitle}|${contractType}|${startDate}|${endDate}|${contractValue}`;
    }

    // Info modal function
    function showBlockchainInfo() {
        const infoText = ` Blockchain Verification

This contract is secured using Hyperledger Fabric blockchain technology.

Benefits:
 Tamper-proof - Any changes are immediately detected
 Immutable - Permanent record that cannot be altered
 Transparent - Full audit trail of all changes
 Compliant - Meets QFCRA regulatory requirements

The blockchain stores a cryptographic hash (SHA-256) of your contract, ensuring document integrity and authenticity.

How it works:
1. When you save the contract, a unique hash is generated
2. This hash is stored on the blockchain
3. Any future verification compares the current hash with the blockchain record
4. If they don't match, tampering is detected`;

        alert(infoText);
    }
</script>




<script>
    // =====================================================
    // AI RISK ANALYSIS JAVASCRIPT - Full Implementation
    // =====================================================

    // let riskAnalysisData = null;

    async function runRiskAnalysis() {
        const modal = document.getElementById('riskAnalysisModal');
        const content = document.getElementById('riskAnalysisContent');
        const badgeEl = document.getElementById('aiPoweredBadge');

        if (!contractId) {
            showNotification('No contract selected', 'error');
            return;
        }

        // Show loading state
        content.innerHTML = `
        <div class="text-center" style="padding: 3rem;">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; border-width: 0.25rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 style="margin-top: 1.5rem; color: var(--text-color);">Analyzing Contract</h4>
            <p style="color: var(--text-muted);">AI is analyzing your contract for potential risks...</p>
        </div>
    `;

        openModal('riskAnalysisModal');

        try {
            console.log(` Requesting risk analysis for contract ${contractId}`);
            const response = await fetch(`/api/contracts/risk-analysis/${contractId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log(' Risk analysis response:', data);

            if (data.success && data.analysis) {
                riskAnalysisData = data.analysis;

                // Show AI badge if AI-powered
                if (data.ai_powered && badgeEl) {
                    badgeEl.style.display = 'inline-flex';
                }

                // Display the analysis
                displayRiskAnalysis(data.analysis);

                // Update timestamp
                const timestampEl = document.getElementById('analysisTimestamp');
                if (timestampEl) {
                    timestampEl.innerHTML = `
                    <i class="ti ti-clock"></i> 
                    Analyzed: ${new Date().toLocaleString()}
                    ${data.ai_powered ? '<span class="badge badge-ai"><i class="ti ti-robot"></i> AI Powered</span>' : ''}
                `;
                }

                showNotification('Risk analysis completed', 'success');
            } else {
                throw new Error(data.message || 'Failed to analyze contract');
            }

        } catch (error) {
            console.error(' Error in risk analysis:', error);
            content.innerHTML = `
            <div class="text-center" style="padding: 3rem;">
                <div style="width: 80px; height: 80px; background: rgba(220, 53, 69, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                    <i class="ti ti-alert-triangle" style="font-size: 2.5rem; color: var(--danger-color);"></i>
                </div>
                <h4 style="color: var(--text-color); margin-bottom: 0.5rem;">Analysis Failed</h4>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">${error.message}</p>
                <button class="btn btn-primary" onclick="runRiskAnalysis()">
                    <i class="ti ti-refresh"></i> Try Again
                </button>
            </div>
        `;
            showNotification('Risk analysis failed: ' + error.message, 'error');
        }
    }

    // Display Risk Analysis - FIXED VERSION
    function displayRiskAnalysis(analysis) {
        const content = document.getElementById('riskAnalysisContent');

        // Safely get values with defaults
        const highRisks = analysis.high_risks || 0;
        const mediumRisks = analysis.medium_risks || 0;
        const lowRisks = analysis.low_risks || 0;
        const safetyScore = analysis.overall_score || 0;
        const riskItems = analysis.risk_items || [];
        const executiveSummary = analysis.executive_summary || 'No summary available.';
        const riskLevel = analysis.risk_level || 'Unknown';

        console.log(' Displaying risk analysis:', {
            highRisks,
            mediumRisks,
            lowRisks,
            safetyScore,
            itemCount: riskItems.length
        });

        content.innerHTML = `
        <!-- Risk Statistics Header -->
        <div class="risk-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
            <div class="risk-stat-card high" style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(220, 53, 69, 0.2); text-align: center;">
                <div class="risk-stat-value" style="font-size: 2.5rem; font-weight: 700; color: #dc3545; margin-bottom: 0.5rem;">${highRisks}</div>
                <div class="risk-stat-label" style="font-size: 0.875rem; color: #6c757d; text-transform: uppercase; font-weight: 600;">HIGH RISK</div>
            </div>
            
            <div class="risk-stat-card medium" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(255, 193, 7, 0.2); text-align: center;">
                <div class="risk-stat-value" style="font-size: 2.5rem; font-weight: 700; color: #ffc107; margin-bottom: 0.5rem;">${mediumRisks}</div>
                <div class="risk-stat-label" style="font-size: 0.875rem; color: #6c757d; text-transform: uppercase; font-weight: 600;">MEDIUM RISK</div>
            </div>
            
            <div class="risk-stat-card low" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(40, 167, 69, 0.2); text-align: center;">
                <div class="risk-stat-value" style="font-size: 2.5rem; font-weight: 700; color: #28a745; margin-bottom: 0.5rem;">${lowRisks}</div>
                <div class="risk-stat-label" style="font-size: 0.875rem; color: #6c757d; text-transform: uppercase; font-weight: 600;">LOW RISK</div>
            </div>
            
            <div class="risk-stat-card safety" style="background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 123, 255, 0.05) 100%); padding: 1.25rem; border-radius: 12px; border: 2px solid rgba(0, 123, 255, 0.2); text-align: center;">
                <div class="risk-stat-value" style="font-size: 2.5rem; font-weight: 700; color: #007bff; margin-bottom: 0.5rem;">${safetyScore}</div>
                <div class="risk-stat-label" style="font-size: 0.875rem; color: #6c757d; text-transform: uppercase; font-weight: 600;">SAFETY SCORE</div>
            </div>
        </div>
        
        <!-- Executive Summary -->
        ${executiveSummary ? `
        <div class="executive-summary" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #007bff; margin-bottom: 2rem;">
            <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #212529;">
                <i class="ti ti-report-analytics"></i> Executive Summary
            </h4>
            <p style="color: #495057; line-height: 1.8; margin: 0;">${executiveSummary}</p>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                <span class="badge" style="background: ${getRiskLevelColor(riskLevel)}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                    Overall Risk Level: ${riskLevel.toUpperCase()}
                </span>
            </div>
        </div>
        ` : ''}
        
        <!-- Detailed Risk Analysis -->
        <div class="risk-items-container">
            <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; color: #212529;">
                <i class="ti ti-list-details"></i>
                Detailed Risk Analysis
                <span style="background: #007bff; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                    ${riskItems.length} ${riskItems.length === 1 ? 'item' : 'items'} identified
                </span>
            </h4>
            
            ${riskItems.length > 0 ? riskItems.map((risk, index) => {
            const severity = (risk.severity || 'medium').toLowerCase();
            const severityColor = getSeverityColor(severity);
            const severityBg = getSeverityBackground(severity);

            return `
                <div class="risk-item" id="riskItem${index}" style="background: white; border: 2px solid ${severityBg}; border-radius: 12px; margin-bottom: 1rem; overflow: hidden; transition: all 0.3s ease;">
                    <div class="risk-item-header" onclick="toggleRiskItem(${index})" style="padding: 1.25rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: ${severityBg};">
                        <div class="risk-item-title" style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                            <i class="ti ti-${getRiskIcon(risk.type)}" style="font-size: 1.5rem; color: ${severityColor};"></i>
                            <div>
                                <div style="font-weight: 600; color: #212529; font-size: 1rem;">${risk.issue || 'Unknown Risk'}</div>
                                <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                                    ${formatRiskType(risk.type)}  ${risk.clause_reference || 'General'}
                                </div>
                            </div>
                        </div>
                        <div class="risk-item-badges" style="display: flex; align-items: center; gap: 0.75rem;">
                            <span class="severity-badge" style="background: ${severityColor}; color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                                ${severity}
                            </span>
                            ${risk.score ? `
                            <span style="background: white; color: ${severityColor}; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; border: 2px solid ${severityColor};">
                                Score: ${risk.score}
                            </span>
                            ` : ''}
                            <i class="ti ti-chevron-down" id="chevron${index}" style="font-size: 1.25rem; color: ${severityColor}; transition: transform 0.3s ease;"></i>
                        </div>
                    </div>
                    
                    <div class="risk-item-content" id="riskContent${index}" style="padding: 1.5rem; display: none; border-top: 1px solid ${severityBg};">
                        <p style="color: #495057; line-height: 1.8; margin-bottom: 1.5rem;">${risk.description || 'No description available.'}</p>
                        
                        ${risk.mitigation ? `
                        <div style="background: #e7f3ff; padding: 1.25rem; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="ti ti-bulb" style="color: #007bff;"></i>
                                <strong style="color: #007bff;">Recommended Mitigation:</strong>
                            </div>
                            <p style="margin: 0; color: #495057; line-height: 1.6;">${risk.mitigation}</p>
                        </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            ${risk.likelihood ? `
                            <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem;">Likelihood</div>
                                <div style="color: #212529; font-weight: 600;">${risk.likelihood}</div>
                            </div>
                            ` : ''}
                            ${risk.business_impact ? `
                            <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem;">Business Impact</div>
                                <div style="color: #212529; font-weight: 600;">${risk.business_impact}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                            // <button class="btn btn-sm btn-primary" onclick="applyMitigation(${index})" style="padding: 0.5rem 1rem; border-radius: 6px;">
                            //     <i class="ti ti-check"></i> Apply Mitigation
                            // </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewClause('${risk.clause_reference}')" style="padding: 0.5rem 1rem; border-radius: 6px;">
                                <i class="ti ti-file-text"></i> View Clause
                            </button>
                        </div>
                    </div>
                </div>
                `;
        }).join('') : `
                <div class="text-center" style="padding: 3rem; background: #f8f9fa; border-radius: 12px;">
                    <i class="ti ti-circle-check" style="font-size: 4rem; color: #28a745; margin-bottom: 1rem;"></i>
                    <h5 style="color: #212529; margin-bottom: 0.5rem;">No Significant Risks Detected</h5>
                    <p style="color: #6c757d;">This contract appears to have minimal risk factors.</p>
                </div>
            `}
        </div>
    `;
    }


    // Helper Functions
    function getSeverityColor(severity) {
        const colors = {
            'critical': '#dc3545',
            'high': '#dc3545',
            'medium': '#ffc107',
            'low': '#28a745'
        };
        return colors[severity] || '#6c757d';
    }



    function getSeverityBackground(severity) {
        const backgrounds = {
            'critical': 'rgba(220, 53, 69, 0.08)',
            'high': 'rgba(220, 53, 69, 0.08)',
            'medium': 'rgba(255, 193, 7, 0.08)',
            'low': 'rgba(40, 167, 69, 0.08)'
        };
        return backgrounds[severity] || 'rgba(108, 117, 125, 0.08)';
    }

    function getRiskLevelColor(level) {
        const colors = {
            'Critical': '#dc3545',
            'High': '#fd7e14',
            'Medium': '#ffc107',
            'Low': '#28a745'
        };
        return colors[level] || '#6c757d';
    }



    // Display Error State
    function displayRiskAnalysisError(message) {
        const content = document.getElementById('riskAnalysisContent');
        content.innerHTML = `
        <div class="text-center" style="padding: 3rem;">
            <div style="width: 80px; height: 80px; background: rgba(220, 53, 69, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i class="ti ti-alert-triangle" style="font-size: 2.5rem; color: var(--danger-color);"></i>
            </div>
            <h4 style="color: var(--text-color); margin-bottom: 0.5rem;">Analysis Failed</h4>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">${message}</p>
            <button class="btn btn-primary" onclick="runRiskAnalysis()">
                <i class="ti ti-refresh"></i> Try Again
            </button>
        </div>
    `;
    }

    // Toggle Risk Item
    function toggleRiskItem(index) {
        const content = document.getElementById(`riskContent${index}`);
        const chevron = document.getElementById(`chevron${index}`);

        if (content && chevron) {
            const isExpanded = content.style.display === 'block';
            content.style.display = isExpanded ? 'none' : 'block';
            chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    }

    // Apply Mitigation
    function applyMitigation(index) {
        if (!riskAnalysisData || !riskAnalysisData.risk_items || !riskAnalysisData.risk_items[index]) {
            showNotification('Mitigation not available', 'warning');
            return;
        }

        const risk = riskAnalysisData.risk_items[index];

        if (!risk.mitigation) {
            showNotification('No mitigation strategy available for this risk', 'warning');
            return;
        }

        if (confirm(`Apply mitigation for: ${risk.issue}?\n\nThis will add a mitigation note to the contract.`)) {
            try {
                const editor = document.getElementById('contractContent');

                if (!editor) {
                    showNotification('Contract editor not found', 'error');
                    return;
                }

                // Get current content
                let currentContent = editor.value || editor.innerHTML || '';

                // Build mitigation note
                const mitigationNote = `\n\n[RISK MITIGATION NOTE - ${new Date().toLocaleString()}]

Issue: ${risk.issue}
Severity: ${risk.severity.toUpperCase()}
Affected Clause: ${risk.clause_reference || 'General'}

 RECOMMENDED MITIGATION:
${risk.mitigation}
\n`;

                // Append mitigation to contract
                const updatedContent = currentContent + mitigationNote;

                // Update editor
                if (editor.value !== undefined) {
                    editor.value = updatedContent;
                } else {
                    editor.innerHTML = updatedContent;
                }

                // Mark as modified
                if (typeof markAsDirty === 'function') {
                    markAsDirty();
                }

                // Save as draft
                saveAsDraft();

                showNotification(` Mitigation applied for: ${risk.issue}`, 'success');

            } catch (error) {
                console.error('Error applying mitigation:', error);
                showNotification('Failed to apply mitigation: ' + error.message, 'error');
            }
        }
    }
    // View Clause
    function viewClause(clauseReference) {
        showNotification(`Navigating to clause: ${clauseReference}`, 'info');
        // Add your clause navigation logic here
    }

    // Helper Functions
    function getRiskIcon(type) {
        const icons = {
            'Legal': 'scale',
            'Financial': 'currency-dollar',
            'Operational': 'settings',
            'Compliance': 'shield-check',
            'Dispute': 'gavel',
            'General': 'alert-circle'
        };
        return icons[type] || 'alert-triangle';
    }

    function formatRiskType(type) {
        return (type || 'General').replace(/_/g, ' ');
    }

    function formatBusinessImpact(impact) {
        return impact || 'To be assessed';
    }

    // Export Risk Report
    function exportRiskReport() {
        if (!riskAnalysisData) {
            showNotification('No risk analysis data to export', 'warning');
            return;
        }

        const reportContent = `

                    AI RISK ANALYSIS REPORT                        
                         CALIM 360 CLM                             


Contract: ${contractData?.contract?.title || 'Unknown Contract'}
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}



EXECUTIVE SUMMARY

Overall Safety Score: ${riskAnalysisData.overall_score}/100
High Risks: ${riskAnalysisData.high_risks}
Medium Risks: ${riskAnalysisData.medium_risks}
Low Risks: ${riskAnalysisData.low_risks}

${riskAnalysisData.executive_summary || ''}



DETAILED FINDINGS

${(riskAnalysisData.risk_items || []).map((item, i) => `
[${i + 1}] ${item.issue}
    Severity: ${item.severity?.toUpperCase()}
    Type: ${formatRiskType(item.type)}
    Score: ${item.score}/100
    
    Description:
    ${item.description}
    
    Clause Reference: ${item.clause_reference || 'N/A'}
    Qatar Law Reference: ${item.qatar_law_reference || 'N/A'}
    Business Impact: ${item.business_impact || 'N/A'}
    
     Recommendation:
    ${item.recommendation}
`).join('\n\n')}



KEY RECOMMENDATIONS

${(riskAnalysisData.recommendations_summary || []).map((rec, i) => `${i + 1}. ${rec}`).join('\n')}



COMPLIANCE STATUS

 QFCRA Compliant: ${riskAnalysisData.compliance_status?.qfcra_compliant ? ' Yes' : ' No'}
 Qatar Civil Code Aligned: ${riskAnalysisData.compliance_status?.qatar_civil_code_aligned ? ' Yes' : ' No'}
 Data Protection Compliant: ${riskAnalysisData.compliance_status?.data_protection_compliant ? ' Yes' : ' Review Required'}

${riskAnalysisData.compliance_status?.notes ? `Note: ${riskAnalysisData.compliance_status.notes}` : ''}



Generated by CALIM 360 Smart CLM
 ${new Date().getFullYear()} All Rights Reserved
    `;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `risk_analysis_report_${contractId}_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification('Risk report exported successfully', 'success');
    }


    // Show Risk Summary (Alternative View)
    function showRiskSummary() {
        if (riskAnalysisData) {
            displayRiskSummary(riskAnalysisData);
            openModal('riskSummaryModal');
        } else {
            runRiskAnalysis();
        }
    }

    function displayRiskSummary(analysis) {
        const content = document.getElementById('riskSummaryContent');
        content.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: rgba(220, 53, 69, 0.05); padding: 1.25rem; border-radius: 8px; text-align: center; border: 1px solid var(--danger-color);">
                <div style="font-size: 2rem; font-weight: bold; color: var(--danger-color);">${analysis.high_risks || 0}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">High Risk</div>
            </div>
            <div style="background: rgba(255, 193, 7, 0.05); padding: 1.25rem; border-radius: 8px; text-align: center; border: 1px solid var(--warning-color);">
                <div style="font-size: 2rem; font-weight: bold; color: var(--warning-color);">${analysis.medium_risks || 0}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Medium Risk</div>
            </div>
            <div style="background: rgba(40, 167, 69, 0.05); padding: 1.25rem; border-radius: 8px; text-align: center; border: 1px solid var(--success-color);">
                <div style="font-size: 2rem; font-weight: bold; color: var(--success-color);">${analysis.low_risks || 0}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Low Risk</div>
            </div>
            <div style="background: rgba(39, 98, 203, 0.05); padding: 1.25rem; border-radius: 8px; text-align: center; border: 1px solid var(--primary-color);">
                <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">${analysis.overall_score || 0}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Safety Score</div>
            </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <button class="btn btn-primary btn-block" onclick="closeModal('riskSummaryModal'); openModal('riskAnalysisModal');">
                <i class="ti ti-list-details"></i> View Detailed Analysis
            </button>
        </div>
    `;
    }
</script>


<script>
    // =====================================================
    // BLOCKCHAIN EVIDENCE SHOWCASE JAVASCRIPT
    // =====================================================

    // Activity tracking
    let activityLog = [];

    // Toggle panel collapse
    function toggleEvidencePanel() {
        const panel = document.getElementById('blockchainEvidencePanel');
        panel.classList.toggle('collapsed');
    }

    // Load network status
    async function loadBlockchainNetworkStatus() {
        try {
            const response = await fetch('/api/blockchain/network-status', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            const data = await response.json();

            if (data.success) {
                updateNetworkStatus(data.network_status);
            }
        } catch (error) {
            console.error('Error loading network status:', error);
        }
    }

    // Update network status display
    function updateNetworkStatus(status) {
        document.getElementById('networkStatusValue').textContent = status.status || 'Operational';
        document.getElementById('peersCount').textContent = status.peers_count || 3;
    }

    // Add activity to stream
    function addBlockchainActivity(activity) {
        activityLog.push(activity);

        const stream = document.getElementById('activityStream');

        // Remove empty state
        const emptyState = stream.querySelector('.empty-activity-state');
        if (emptyState) {
            emptyState.remove();
        }

        // Create activity item
        const item = document.createElement('div');
        item.className = `stream-item ${activity.status}`;
        item.id = `activity-${activity.id}`;

        // Get icon based on step
        const icon = getBlockchainIcon(activity.step);

        // Build metadata HTML
        let metadataHtml = '';
        if (activity.metadata && Object.keys(activity.metadata).length > 0) {
            metadataHtml = '<div class="stream-metadata">';
            for (const [key, value] of Object.entries(activity.metadata)) {
                if (key !== 'full_hash' && key !== 'data_size') {
                    metadataHtml += `<span class="metadata-tag"><i class="ti ti-point"></i> ${key}: ${value}</span>`;
                }
            }
            metadataHtml += '</div>';
        }

        // Add hash visualization for hash generation step
        let hashHtml = '';
        if (activity.step === 'hash_generation' && activity.metadata?.full_hash) {
            hashHtml = `<div class="hash-visual">${activity.metadata.full_hash}</div>`;
        }

        item.innerHTML = `
        <div class="stream-icon">
            <i class="${icon}"></i>
        </div>
        <div class="stream-content">
            <div class="stream-title">${formatStepName(activity.step)}</div>
            <div class="stream-description">${activity.details}</div>
            <div class="stream-timestamp">${new Date(activity.timestamp).toLocaleTimeString()}</div>
            ${hashHtml}
            ${metadataHtml}
        </div>
    `;

        // Insert at top of stream
        stream.insertBefore(item, stream.firstChild);

        // Scroll to show new item
        stream.scrollTop = 0;
    }

    // Show progress indicator
    function showBlockchainProgress(message) {
        const stream = document.getElementById('activityStream');

        const progress = document.createElement('div');
        progress.className = 'progress-indicator';
        progress.id = 'blockchain-progress';
        progress.innerHTML = `
        <div class="progress-spinner"></div>
        <div class="progress-text">${message}</div>
    `;

        stream.insertBefore(progress, stream.firstChild);
    }

    // Hide progress indicator
    function hideBlockchainProgress() {
        const progress = document.getElementById('blockchain-progress');
        if (progress) {
            progress.remove();
        }
    }

    // Process blockchain storage with activity logging
    async function storeContractOnBlockchainWithEvidence(contractId) {
        showBlockchainProgress('Initiating blockchain storage...');

        try {
            const response = await fetch(`/api/blockchain/store-contract/${contractId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            hideBlockchainProgress();

            if (data.success && data.activities) {
                // Display each activity step
                data.activities.forEach((activity, index) => {
                    setTimeout(() => {
                        addBlockchainActivity(activity);
                    }, index * 300); // Stagger the display for visual effect
                });

                return data;
            } else {
                addBlockchainActivity({
                    id: Date.now(),
                    step: 'error',
                    status: 'error',
                    details: data.error || 'Failed to store contract on blockchain',
                    timestamp: new Date().toISOString(),
                    metadata: {}
                });
                return null;
            }
        } catch (error) {
            hideBlockchainProgress();
            console.error('Error storing on blockchain:', error);
            addBlockchainActivity({
                id: Date.now(),
                step: 'error',
                status: 'error',
                details: `Error: ${error.message}`,
                timestamp: new Date().toISOString(),
                metadata: {}
            });
            return null;
        }
    }

    // Get icon for activity step
    function getBlockchainIcon(step) {
        const icons = {
            'data_extraction': 'ti ti-file-search',
            'hash_generation': 'ti ti-hash',
            'transaction_preparation': 'ti ti-file-code',
            'blockchain_submission': 'ti ti-cloud-upload',
            'database_storage': 'ti ti-database',
            'audit_logging': 'ti ti-history',
            'completion': 'ti ti-circle-check',
            'error': 'ti ti-alert-triangle'
        };
        return icons[step] || 'ti ti-point';
    }

    // Format step name for display
    function formatStepName(step) {
        return step.split('_').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadBlockchainNetworkStatus();

        // Refresh network status every 30 seconds
        setInterval(loadBlockchainNetworkStatus, 30000);
    });

    // Example: Hook into contract save function
    // Replace your existing save function call with this:
    async function saveContractWithBlockchain() {
        // Your existing save logic here
        // ...

        // After successful save, store on blockchain
        const contractId = getContractIdFromURL(); // Your function to get contract ID
        if (contractId) {
            await storeContractOnBlockchainWithEvidence(contractId);
        }
    }

    // Helper function to get contract ID from URL
    function getContractIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }

</script>


<script>
    // =====================================================
    // BLOCKCHAIN ACTIVITY DISPLAY FUNCTIONS
    // =====================================================

    /**
     * Display blockchain activities in the panel
     */
    function displayBlockchainActivities(activities) {
        console.log(' Displaying blockchain activities:', activities.length, 'items');

        const stream = document.getElementById('activityStream');
        if (!stream) {
            console.error(' Activity stream element not found');
            return;
        }

        // Clear empty state
        stream.innerHTML = '';

        // Display each activity with staggered animation
        activities.forEach((activity, index) => {
            setTimeout(() => {
                addBlockchainActivity(activity);
            }, index * 300);
        });
    }

    /**
     * Add a single activity to the stream
     */
    function addBlockchainActivity(activity) {
        const stream = document.getElementById('activityStream');
        if (!stream) return;

        console.log(' Adding activity:', activity.step);

        const item = document.createElement('div');
        item.className = `stream-item ${activity.status}`;

        const icon = getBlockchainActivityIcon(activity.step);

        // Build metadata HTML
        let metadataHtml = '';
        if (activity.metadata && Object.keys(activity.metadata).length > 0) {
            metadataHtml = '<div class="stream-metadata">';
            for (const [key, value] of Object.entries(activity.metadata)) {
                if (key !== 'full_hash' && key !== 'data_size' && value) {
                    metadataHtml += `
                    <span class="metadata-tag">
                        <i class="ti ti-point"></i> 
                        <strong>${key}:</strong> ${value}
                    </span>
                `;
                }
            }
            metadataHtml += '</div>';
        }

        // Add hash display for hash generation step
        let hashHtml = '';
        if (activity.step === 'hash_generation' && activity.metadata?.full_hash) {
            hashHtml = `<div class="hash-visual">${activity.metadata.full_hash}</div>`;
        }

        item.innerHTML = `
        <div class="stream-icon">
            <i class="${icon}"></i>
        </div>
        <div class="stream-content">
            <div class="stream-title">${formatStepName(activity.step)}</div>
            <div class="stream-description">${activity.details}</div>
            <div class="stream-timestamp">${new Date(activity.timestamp).toLocaleTimeString()}</div>
            ${hashHtml}
            ${metadataHtml}
        </div>
    `;

        stream.insertBefore(item, stream.firstChild);
    }

    /**
     * Get icon for blockchain activity step
     */
    function getBlockchainActivityIcon(step) {
        const icons = {
            'data_extraction': 'ti ti-file-search',
            'hash_generation': 'ti ti-hash',
            'transaction_preparation': 'ti ti-file-code',
            'blockchain_submission': 'ti ti-cloud-upload',
            'database_storage': 'ti ti-database',
            'audit_logging': 'ti ti-history',
            'completion': 'ti ti-circle-check',
            'error': 'ti ti-alert-triangle'
        };
        return icons[step] || 'ti ti-point';
    }

    /**
     * Format step name for display
     */
    function formatStepName(step) {
        return step.split('_').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }

    // Test function - run in console: testBlockchainDisplay()
    function testBlockchainDisplay() {
        const mockActivities = [
            {
                id: "1",
                step: "data_extraction",
                status: "success",
                details: "Successfully extracted 60,533 bytes of contract data",
                timestamp: new Date().toISOString(),
                metadata: { data_size: 60533 }
            },
            {
                id: "2",
                step: "hash_generation",
                status: "success",
                details: "Generated SHA-256 hash",
                timestamp: new Date().toISOString(),
                metadata: {
                    hash_algorithm: "SHA-256",
                    full_hash: "16a01b7b750ee5f9...8d34d311fb39963e"
                }
            },
            {
                id: "3",
                step: "completion",
                status: "success",
                details: "Contract successfully secured on blockchain",
                timestamp: new Date().toISOString(),
                metadata: { total_steps: 7 }
            }
        ];

        console.log(' Testing with mock data...');
        displayBlockchainActivities(mockActivities);
    }

    // =====================================================
    // COUNTER-PARTY EMAIL SEARCH FUNCTIONS
    // =====================================================

    let searchTimeout;
    let selectedCounterPartyEmail = null;

    /**
     * Search users from database for counter-party email
     */
    async function searchCounterPartyUsers(query) {
        const suggestionsDiv = document.getElementById('counterPartyEmailSuggestions');

        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        // Hide suggestions if query is empty
        if (!query || query.trim().length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        // Debounce search - wait 300ms after user stops typing
        searchTimeout = setTimeout(async () => {
            try {
                // Show loading state
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                        <i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i>
                        Searching users...
                    </div>
                `;
                suggestionsDiv.style.display = 'block';

                // Call API to search users
                const response = await fetch(`/api/users/company?search=${encodeURIComponent(query)}&limit=10`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to search users');
                }

                const data = await response.json();
                const users = data.users || [];

                // Display results
                if (users.length === 0) {
                    suggestionsDiv.innerHTML = `
                        <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                            <i class="ti ti-user-x" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <div>No users found matching "${query}"</div>
                            <small style="display: block; margin-top: 0.25rem;">You can still enter the email manually</small>
                        </div>
                    `;
                } else {
                    suggestionsDiv.innerHTML = users.map(user => {
                        const fullName = `${user.first_name} ${user.last_name}`.trim();
                        const userType = user.user_type ? ` (${user.user_type})` : '';
                        const department = user.department ? ` - ${user.department}` : '';
                        const companyName = (user.company_name || 'Unknown Company').replace(/'/g, "\\'");


                        return `
                            <div onclick="selectCounterPartyEmail('${user.email}', '${companyName}', ${user.id}, ${user.company_id || 'null'})" 
                                style="padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;"
                                onmouseover="this.style.background='var(--background-light)'" 
                                onmouseout="this.style.background='transparent'">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                        ${user.first_name.charAt(0)}${user.last_name.charAt(0)}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.125rem;">
                                            ${fullName}${userType}
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                                            <i class="ti ti-mail" style="font-size: 0.875rem;"></i> ${user.email}${department}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                suggestionsDiv.style.display = 'block';

            } catch (error) {
                console.error('Error searching users:', error);
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--danger-color);">
                        <i class="ti ti-alert-circle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <div>Error searching users</div>
                        <small style="display: block; margin-top: 0.25rem;">You can still enter the email manually</small>
                    </div>
                `;
                suggestionsDiv.style.display = 'block';
            }
        }, 300); // 300ms debounce
    }

    /**
     * Select an email from the suggestions
     */
    function selectCounterPartyEmail(email, companyName, userId, companyId) {
        const emailInput = document.getElementById('counterPartyEmail');
        const suggestionsDiv = document.getElementById('counterPartyEmailSuggestions');

        // Set the email value
        emailInput.value = email;

        // Store all the data
        selectedCounterPartyEmail = {
            email: email,
            companyName: companyName,
            userId: userId,
            companyId: companyId
        };

        // Hide suggestions
        suggestionsDiv.style.display = 'none';

        // Show notification with company name
        showNotification(`Selected: ${companyName} (${email})`, 'success');
    }
    /**
     * Close suggestions when clicking outside
     */
    document.addEventListener('click', function (event) {
        const emailInput = document.getElementById('counterPartyEmail');
        const suggestionsDiv = document.getElementById('counterPartyEmailSuggestions');

        if (emailInput && suggestionsDiv &&
            !emailInput.contains(event.target) &&
            !suggestionsDiv.contains(event.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });
</script>

{% endblock %}

{% block extra_js %}
<script src="/app/static/js/contract-edit.js"></script>
{% endblock %}